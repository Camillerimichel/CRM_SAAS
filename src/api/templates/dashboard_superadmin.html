{% extends "base.html" %}
{% block title %}Superadministration{% endblock %}
{% block header_title %}Superadministration{% endblock %}
{% block header_subtitle %}Sociétés, utilisateurs et outils d'import{% endblock %}

{% block content %}

{% if superadmin_user %}
<div class="card" style="margin-bottom:1rem; border:1px solid #dbeafe; background:linear-gradient(135deg,#f8fbff 0%,#eef4ff 100%); box-shadow:0 10px 30px rgba(37,99,235,0.08);">
  <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
    <div style="display:flex; align-items:center; gap:10px;">
      <div style="width:44px; height:44px; border-radius:12px; background:linear-gradient(135deg,#2563eb,#0ea5e9); color:#fff; display:grid; place-items:center; font-weight:800; letter-spacing:0.04em;">
        SA
      </div>
      <div>
        <h3 style="margin:0;">Superadmin</h3>
        <p class="muted" style="margin:2px 0 0 0;">Accès global à toutes les sociétés</p>
      </div>
    </div>
    <span class="status-pill" style="font-size:11px; padding:8px 12px; background:#dcfce7; color:#166534;">
      Identifié
    </span>
  </div>
  <div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-top:14px;">
    {% set info = namespace(rows=[]) %}
    {% if superadmin_user.nom %}{% set _ = info.rows.append(('Nom', superadmin_user.nom)) %}{% endif %}
    {% if superadmin_user.prenom %}{% set _ = info.rows.append(('Prénom', superadmin_user.prenom)) %}{% endif %}
    {% if superadmin_user.mail %}{% set _ = info.rows.append(('Email', superadmin_user.mail)) %}{% endif %}
    {% if superadmin_user.telephone %}{% set _ = info.rows.append(('Téléphone', superadmin_user.telephone)) %}{% endif %}
    {% if info.rows|length == 0 %}
      {% set _ = info.rows.append(('Nom', '—')) %}
      {% set _ = info.rows.append(('Prénom', '—')) %}
      {% set _ = info.rows.append(('Email', '—')) %}
      {% set _ = info.rows.append(('Téléphone', '—')) %}
    {% endif %}
    <div style="display:flex; flex-wrap:wrap; gap:14px; grid-column:1/-1;">
      {% for label, value in info.rows %}
        <div style="display:flex; align-items:center; gap:6px; padding:6px 10px; background:#fff; border:1px solid #e5e7eb; border-radius:10px;">
          <span class="muted" style="font-weight:600;">{{ label }} :</span>
          <span class="kv">{{ value }}</span>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<div class="card" style="margin-bottom:1rem;">
  <details data-soc-details style="border:0; padding:0;">
    <summary style="list-style:none; cursor:pointer;">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
        <h3 style="margin:0;">Gestion des droits d'accès des sociétés et de leurs clients</h3>
        <span class="btn btn-secondary" data-soc-toggle-label style="background:#f3f4f6; color:#111827; pointer-events:none;">Afficher</span>
      </div>
    </summary>
    <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <form method="get" action="/dashboard/superadmin#utilisateurs" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        {% if selected_user %}<input type="hidden" name="user_id" value="{{ selected_user.id }}">{% endif %}
        <input class="form-control" type="text" name="q" value="{{ search_term or '' }}" placeholder="Rechercher une société..." style="min-width:220px;">
        <button type="submit" class="btn btn-secondary">Filtrer</button>
      </form>
    </div>
    {% if societes_gestion %}
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
          <thead>
            <tr style="text-align:left; border-bottom:1px solid var(--border);">
              <th style="padding:6px 4px;">Nom</th>
              <th style="padding:6px 4px;">Contact</th>
              <th style="padding:6px 4px;">Téléphone</th>
              <th style="padding:6px 4px;">Courriel</th>
              <th style="padding:6px 4px; text-align:center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in societes_gestion %}
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:6px 4px;">{{ s.nom }}</td>
              <td style="padding:6px 4px;">{{ s.contact or '—' }}</td>
              <td style="padding:6px 4px;">{{ s.telephone or '—' }}</td>
              <td style="padding:6px 4px;">{{ s.email or '—' }}</td>
              <td style="padding:6px 4px; text-align:center;">
                <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ s.id }}{% if search_term %}&q={{ search_term }}{% endif %}{% if page %}&page={{ page }}{% endif %}#utilisateurs" title="Modifier / gérer">
                  <i class="fa-regular fa-pen-to-square"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; flex-wrap:wrap; gap:8px;">
        <div class="muted" style="font-size:0.9rem;">{{ total_societes }} sociétés — page {{ page }} / {{ page_count }}</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          {% set qparam = '&q=' ~ search_term if search_term else '' %}
          {% if page > 1 %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?page={{ page - 1 }}{{ qparam }}#utilisateurs">Précédent</a>
          {% endif %}
          {% if page < page_count %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?page={{ page + 1 }}{{ qparam }}#utilisateurs">Suivant</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p class="muted" style="margin:0;">Aucune société de gestion/courtage définie.</p>
    {% endif %}
  </details>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const details = document.querySelector('[data-soc-details]');
    const label = document.querySelector('[data-soc-toggle-label]');
    const related = () => document.querySelectorAll('[data-soc-related]');
    if (!details || !label) return;
    // Forcer fermé par défaut (sauf ancre explicite)
    details.open = false;
    const setState = () => {
      const open = details.open;
      label.textContent = open ? 'Masquer' : 'Afficher';
      related().forEach(el => { el.style.display = open ? '' : 'none'; });
    };
    if (window.location.hash === '#utilisateurs') details.open = true;
    details.addEventListener('toggle', setState);
    setState();
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const details = document.querySelector('[data-base-details]');
    const label = document.querySelector('[data-base-toggle-label]');
    if (!details || !label) return;
    details.open = false;
    const setLabel = () => { label.textContent = details.open ? 'Masquer' : 'Afficher'; };
    details.addEventListener('toggle', setLabel);
    setLabel();
  });
</script>

{% if selected_societe %}
<div data-soc-related>
  <div class="card" id="utilisateurs" style="margin-bottom:1rem;">
    <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start;">
      <div>
        <h3 style="margin:0;">{{ selected_societe.nom }}</h3>
        <p class="muted" style="margin:4px 0 0 0;">{{ selected_societe.nature|capitalize if selected_societe.nature else '—' }}</p>
      </div>
      <a class="btn btn-secondary" href="/dashboard/superadmin">Fermer</a>
    </div>
    <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:14px;">
      {% set soc_info = [
        ('Contact', selected_societe.contact or '—'),
        ('Téléphone', selected_societe.telephone or '—'),
        ('Courriel', selected_societe.email or '—'),
        ('Adresse', selected_societe.adresse or '—'),
        ('Clients actifs', selected_societe.clients_actifs if selected_societe.clients_actifs is not none else 0),
        ('Affaires actives', selected_societe.affaires_actives if selected_societe.affaires_actives is not none else 0)
      ] %}
      {% for label, value in soc_info %}
        <div style="display:flex; align-items:center; gap:6px; padding:8px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:10px;">
          <span class="muted" style="font-weight:600;">{{ label }} :</span>
          <span class="kv">{{ value }}</span>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="card" style="margin-bottom:1rem;">
    <h2 style="margin:0 0 6px 0; font-size:1.2rem;">Utilisateurs de la société</h2>
    <div class="muted" style="margin-bottom:8px; font-size:0.9rem;">Gestion des comptes (création, rôles, activation) à venir. Bouton ci-dessous pour préparer la gestion des droits.</div>
    <form method="get" action="/dashboard/superadmin" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <input type="hidden" name="societe_id" value="{{ selected_societe.id }}">
      {% if search_term %}<input type="hidden" name="q" value="{{ search_term }}">{% endif %}
      {% if page %}<input type="hidden" name="page" value="{{ page }}">{% endif %}
      <input class="form-control" type="text" name="uq" value="{{ user_search_term or '' }}" placeholder="Rechercher un utilisateur (nom, email)" style="min-width:240px;">
      <button type="submit" class="btn btn-secondary">Filtrer</button>
    </form>
    {% if not utilisateurs_societes %}
      <div class="muted" style="font-size:0.95rem;">Aucun utilisateur renseigné.</div>
    {% else %}
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
          <thead>
            <tr style="text-align:left; border-bottom:1px solid var(--border);">
            <th style="padding:6px 4px; width:32%;">Nom</th>
            <th style="padding:6px 4px;">Prénom</th>
            <th style="padding:6px 4px;">Email</th>
            <th style="padding:6px 4px;">Téléphone</th>
            <th style="padding:6px 4px;">Rôle</th>
            <th style="padding:6px 4px; text-align:center; width:1%; white-space:nowrap;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in utilisateurs_societes %}
          <tr style="border-bottom:1px solid var(--border);">
            <td style="padding:6px 4px;">{{ u.nom or '—' }}</td>
            <td style="padding:6px 4px;">{{ u.prenom or '—' }}</td>
            <td style="padding:6px 4px;">{{ u.mail or '—' }}</td>
            <td style="padding:6px 4px;">{{ u.telephone or '—' }}</td>
            <td style="padding:6px 4px;">{{ u.role_label or '—' }}</td>
            <td style="padding:6px 4px; text-align:center;">
              <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}&user_id={{ u.id }}{% if search_term %}&q={{ search_term }}{% endif %}{% if page %}&page={{ page }}{% endif %}{% if user_search_term %}&uq={{ user_search_term }}{% endif %}{% if user_page %}&upage={{ user_page }}{% endif %}#droits" title="Gérer les droits et comptes">
                <i class="fa-regular fa-pen-to-square"></i>
              </a>
            </td>
          </tr>
        {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; flex-wrap:wrap; gap:8px;">
        <div class="muted" style="font-size:0.9rem;">{{ total_users }} utilisateurs — page {{ user_page }} / {{ user_page_count }}</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          {% set q_soc = '&q=' ~ search_term if search_term else '' %}
          {% set q_users = '&uq=' ~ user_search_term if user_search_term else '' %}
          {% if user_page > 1 %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}{{ q_soc }}&upage={{ user_page - 1 }}{{ q_users }}{% if page %}&page={{ page }}{% endif %}">Précédent</a>
          {% endif %}
          {% if user_page < user_page_count %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}{{ q_soc }}&upage={{ user_page + 1 }}{{ q_users }}{% if page %}&page={{ page }}{% endif %}">Suivant</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
  <div class="card" style="margin-bottom:1rem; border:1px solid #e5e7eb;">
    <h2 style="margin:0 0 6px 0; font-size:1.2rem;">Comptes clients (portail)</h2>
    <p class="muted" style="margin-bottom:10px; font-size:0.9rem;">Vue simplifiée : Nom, Prénom, Email/Login, dernière connexion issue des logs.</p>
    <form method="get" action="/dashboard/superadmin" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
      <input type="hidden" name="societe_id" value="{{ selected_societe.id }}">
      {% if search_term %}<input type="hidden" name="q" value="{{ search_term }}">{% endif %}
      {% if page %}<input type="hidden" name="page" value="{{ page }}">{% endif %}
      <input class="form-control" type="text" name="cq" value="{{ client_search_term or '' }}" placeholder="Filtrer par nom/email" style="min-width:240px;">
      <button type="submit" class="btn btn-secondary">Filtrer</button>
    </form>
    {% if not client_accounts %}
      <div class="muted" style="font-size:0.95rem;">Aucun compte client pour cette société de courtage.</div>
    {% else %}
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:0.95rem;">
          <thead>
            <tr style="text-align:left; border-bottom:1px solid var(--border);">
              <th style="padding:6px 4px;">Nom</th>
              <th style="padding:6px 4px;">Prénom</th>
              <th style="padding:6px 4px;">Email / Login</th>
              <th style="padding:6px 4px;">Compte</th>
              <th style="padding:6px 4px;">Dernière connexion</th>
              <th style="padding:6px 4px; text-align:center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for c in client_accounts %}
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:6px 4px;">{{ c.nom or '—' }}</td>
              <td style="padding:6px 4px;">{{ c.prenom or '—' }}</td>
              <td style="padding:6px 4px;">{{ c.email or c.login or '—' }}</td>
              <td style="padding:6px 4px;">{{ 'Existant' if c.has_account else 'À créer' }}</td>
              <td style="padding:6px 4px;">{{ c.last_seen or c.last_login or '—' }}</td>
              <td style="padding:6px 4px; text-align:center;">
                {% if c.client_id %}
                  {% if c.has_account %}
                    <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}&client_id={{ c.client_id }}&client_account_id={{ c.id }}{% if client_search_term %}&cq={{ client_search_term }}{% endif %}{% if search_term %}&q={{ search_term }}{% endif %}{% if page %}&page={{ page }}{% endif %}#client-auth" title="Modifier le compte portail">
                      <i class="fa-regular fa-pen-to-square"></i>
                    </a>
                  {% else %}
                    <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}&client_id={{ c.client_id }}{% if client_search_term %}&cq={{ client_search_term }}{% endif %}{% if search_term %}&q={{ search_term }}{% endif %}{% if page %}&page={{ page }}{% endif %}#client-auth" title="Créer le compte portail">
                      <i class="fa-solid fa-plus"></i>
                    </a>
                  {% endif %}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; flex-wrap:wrap; gap:8px;">
        <div class="muted" style="font-size:0.9rem;">{{ total_client_accounts }} comptes — page {{ client_page }} / {{ client_page_count }}</div>
        <div style="display:flex; gap:6px; flex-wrap:wrap;">
          {% set q_soc = '&q=' ~ search_term if search_term else '' %}
          {% set q_clients = '&cq=' ~ client_search_term if client_search_term else '' %}
          {% if client_page > 1 %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}{{ q_soc }}&cpage={{ client_page - 1 }}{{ q_clients }}{% if page %}&page={{ page }}{% endif %}">Précédent</a>
          {% endif %}
          {% if client_page < client_page_count %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}{{ q_soc }}&cpage={{ client_page + 1 }}{{ q_clients }}{% if page %}&page={{ page }}{% endif %}">Suivant</a>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>
  {% if selected_client_form %}
    <div class="card" id="client-auth" style="margin-bottom:1rem; border:1px solid #e5e7eb;">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
        <div>
          <h3 style="margin:0;">{{ 'Modifier le compte' if selected_client_form.has_account else 'Créer un compte portail' }}</h3>
          <p class="muted" style="margin:4px 0 0 0;">{{ selected_client_form.prenom or '' }} {{ selected_client_form.nom or '' }}</p>
        </div>
        <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}{% if client_search_term %}&cq={{ client_search_term }}{% endif %}{% if search_term %}&q={{ search_term }}{% endif %}{% if page %}&page={{ page }}{% endif %}">Fermer</a>
      </div>
      <form method="post" action="/dashboard/superadmin/client-auth" style="margin-top:12px; display:grid; gap:12px; grid-template-columns: minmax(260px, 1fr) minmax(360px, 1.2fr) minmax(220px, 0.8fr);">
        <input type="hidden" name="societe_id" value="{{ selected_societe.id }}">
        {% if selected_client_form.id %}<input type="hidden" name="client_account_id" value="{{ selected_client_form.id }}">{% endif %}
        <input type="hidden" name="client_id" value="{{ selected_client_form.client_id }}">
        <label style="display:flex; flex-direction:column; gap:6px;">
          <span>Login / Email</span>
          <input class="form-control" type="email" name="login" value="{{ selected_client_form.email or selected_client_form.login or '' }}" required style="height:44px;">
        </label>
        <label style="display:flex; flex-direction:column; gap:6px;">
          <span>Mot de passe (laisser vide pour conserver)</span>
          <input class="form-control" type="text" name="password" placeholder="Auto-généré si vide lors de la création" style="height:44px; width:100%;">
        </label>
        <label style="display:flex; flex-direction:column; gap:6px;">
          <span>Statut</span>
          <select class="form-control" name="status" style="height:44px;">
            {% set current_status = 'active' %}
            {% if selected_client_form.has_account and selected_client_form.status %}{% set current_status = selected_client_form.status %}{% endif %}
            <option value="active" {% if current_status == 'active' %}selected{% endif %}>Actif</option>
            <option value="disabled" {% if current_status == 'disabled' %}selected{% endif %}>Désactivé</option>
            <option value="pending_reset" {% if current_status == 'pending_reset' %}selected{% endif %}>En attente de reset</option>
          </select>
        </label>
        <div style="grid-column:1/-1; display:flex; gap:10px; flex-wrap:wrap;">
          <button type="submit" class="btn btn-primary">{{ 'Mettre à jour' if selected_client_form.has_account else 'Créer le compte' }}</button>
          <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}{% if client_search_term %}&cq={{ client_search_term }}{% endif %}{% if search_term %}&q={{ search_term }}{% endif %}{% if page %}&page={{ page }}{% endif %}">Annuler</a>
        </div>
        <div class="muted" style="grid-column:1/-1; font-size:0.9rem;">Un rôle "client" sera associé automatiquement sur ce courtier.</div>
      </form>
    </div>
  {% endif %}
  {% if selected_user %}
    <div class="card" id="droits" style="margin-bottom:1rem; border:1px solid #e5e7eb;">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start;">
        <div>
          <h3 style="margin:0;">Gestion des droits — {{ selected_user.prenom or '' }} {{ selected_user.nom or '' }}</h3>
          <p class="muted" style="margin:4px 0 0 0;">Société : {{ selected_societe.nom }}</p>
        </div>
        <a class="btn btn-secondary" href="/dashboard/superadmin?societe_id={{ selected_societe.id }}">Fermer</a>
      </div>
      <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:14px;">
        {% set user_info = [] %}
        {% if selected_user.mail %}{% set _ = user_info.append(('Email', selected_user.mail)) %}{% endif %}
        {% if selected_user.telephone %}{% set _ = user_info.append(('Téléphone', selected_user.telephone)) %}{% endif %}
        {% set auth_label = None %}
        {% if selected_user.auth_user_id %}
          {% set auth_label = (selected_user.auth_login or '—') ~ (' (Actif)' if selected_user.auth_actif else ' (Inactif)') %}
        {% endif %}
        {% if auth_label %}{% set _ = user_info.append(("Compte d'authentification", auth_label)) %}{% endif %}
        {% if user_info|length == 0 %}
          {% set _ = user_info.append(('Email', '—')) %}
          {% set _ = user_info.append(('Téléphone', '—')) %}
          {% set _ = user_info.append(("Compte d'authentification", 'Aucun compte lié (à créer)')) %}
        {% endif %}
        {% for label, value in user_info %}
          <div style="display:flex; align-items:center; gap:6px; padding:8px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:10px;">
            <span class="muted" style="font-weight:600;">{{ label }} :</span>
            <span class="kv">{{ value }}</span>
          </div>
        {% endfor %}
      </div>
      <div style="margin-top:12px; padding:12px; border:1px dashed var(--border); border-radius:8px; background:#f9fafb;">
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
          <div>
            <div style="font-weight:600;">Compte d'authentification</div>
            <p class="muted" style="margin:4px 0 0 0; font-size:0.95rem;">Créer le compte et récupérer le mot de passe initial.</p>
          </div>
        </div>
        {% if selected_user.auth_user_id %}
          <div class="muted" style="margin-top:8px;">Compte existant ({{ selected_user.auth_login }}). Utilisez un reset si besoin.</div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
            <form method="post" action="/dashboard/superadmin/reset-auth" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
              <input type="hidden" name="user_id" value="{{ selected_user.id }}">
              <input type="hidden" name="societe_id" value="{{ selected_societe.id }}">
              <label style="display:flex; flex-direction:column; gap:4px; font-size:0.95rem;">
                <span>Nouveau mot de passe (laisser vide pour générer)</span>
                <input class="form-control" type="text" name="password" placeholder="Auto-généré si vide">
              </label>
              <button type="submit" class="btn btn-primary">Réinitialiser</button>
            </form>
            <form method="post" action="/dashboard/superadmin/auth-toggle">
              <input type="hidden" name="user_id" value="{{ selected_user.id }}">
              <input type="hidden" name="societe_id" value="{{ selected_societe.id }}">
              <input type="hidden" name="actif" value="{% if selected_user.auth_actif %}0{% else %}1{% endif %}">
              {% if selected_user.auth_actif %}
                <button type="submit" class="btn btn-secondary" style="background:#f3f4f6; color:#111827;">Désactiver le compte</button>
              {% else %}
                <button type="submit" class="btn btn-secondary" style="background:#dcfce7; color:#166534;">Activer le compte</button>
              {% endif %}
            </form>
          </div>
        {% else %}
          <form method="post" action="/dashboard/superadmin/create-auth" style="margin-top:12px; display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); align-items:end;">
            <input type="hidden" name="user_id" value="{{ selected_user.id }}">
            <input type="hidden" name="societe_id" value="{{ selected_societe.id }}">
            <label style="display:flex; flex-direction:column; gap:4px; font-size:0.95rem;">
              <span>Login (email)</span>
              <input class="form-control" type="email" name="login" value="{{ selected_user.mail or '' }}" placeholder="email@domaine.fr" required>
            </label>
            <label style="display:flex; flex-direction:column; gap:4px; font-size:0.95rem;">
              <span>Mot de passe initial (laisser vide pour générer)</span>
              <input class="form-control" type="text" name="password" placeholder="Auto-généré si vide">
            </label>
            <button type="submit" class="btn btn-primary" style="height: fit-content;">Créer le compte</button>
          </form>
        {% endif %}
        {% if tmp_pwd %}
          <div style="margin-top:10px; padding:10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
            <div style="font-weight:600;">Mot de passe {% if request.query_params.get('tmp_action') == 'reset' %}réinitialisé{% else %}initial{% endif %} (copier et transmettre)</div>
            <div style="font-family:monospace; margin-top:4px;">{{ tmp_pwd }}</div>
          </div>
        {% endif %}
      </div>
      <div style="margin-top:12px; padding:12px; border:1px dashed var(--border); border-radius:8px; background:#f9fafb;">
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
          <div>
            <div style="font-weight:600;">Rôles attribués</div>
            <p class="muted" style="margin:4px 0 0 0; font-size:0.95rem;">Sélectionnez un rôle, choisissez le périmètre (global ou société) puis validez ou supprimez.</p>
          </div>
        </div>
        {% if selected_user.auth_user_id %}
          <form method="post" action="/dashboard/superadmin/roles" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
            <input type="hidden" name="user_id" value="{{ selected_user.id }}">
            <input type="hidden" name="societe_id" value="{{ selected_societe.id }}">
            <label style="display:flex; flex-direction:column; font-size:0.95rem; gap:4px;">
              <span>Périmètre</span>
              <select name="scope" class="form-control">
                <option value="societe" {% if default_scope == 'societe' %}selected{% endif %}>Cette société</option>
                <option value="global" {% if default_scope == 'global' %}selected{% endif %}>Global</option>
              </select>
            </label>
            <label style="display:flex; flex-direction:column; font-size:0.95rem; gap:4px;">
              <span>Rôle</span>
              <select name="role_id" class="form-control">
                {% set selected_role_from_scope = current_role_societe if default_scope == 'societe' else current_role_global %}
                {% for r in roles_disponibles %}
                  <option value="{{ r.id }}" {% if selected_role_from_scope and selected_role_from_scope == r.id %}selected{% endif %}>
                    {{ r.label or r.code }}
                  </option>
                {% endfor %}
              </select>
            </label>
            <button type="submit" class="btn btn-primary">Valider</button>
            <button type="submit" formaction="/dashboard/superadmin/roles/delete" class="btn btn-secondary" style="background:#f3f4f6; color:#111827;">Supprimer le rôle</button>
          </form>
        {% else %}
          <div class="muted" style="margin-top:8px;">Aucun compte d'authentification associé — créer le compte avant d'assigner un rôle.</div>
        {% endif %}
        {% if selected_user_roles %}
          <div style="margin-top:10px; display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            {% for r in selected_user_roles %}
              <div style="padding:10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff;">
                <div style="font-weight:600;">{{ r.label or r.code }}</div>
                <div class="muted" style="font-size:0.9rem; margin-top:4px;">{% if r.societe_nom %}Périmètre : {{ r.societe_nom }}{% else %}Périmètre : Global{% endif %}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="muted" style="margin-top:8px;">Aucun rôle assigné pour l'instant.</div>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
{% endif %}

<div class="card" id="outils-import">
  <details data-base-details style="border:0; padding:0;">
    <summary style="list-style:none; cursor:pointer;">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
        <h2 style="margin:0 0 6px 0; font-size:1.2rem;">Outils de gestion de la base</h2>
        <span class="btn btn-secondary" data-base-toggle-label style="background:#f3f4f6; color:#111827; pointer-events:none;">Afficher</span>
      </div>
    </summary>
    <div style="margin-top:6px;">
      <p class="muted" style="margin:0 0 10px 0;">Mise à jour des historiques et recalcul des indicateurs.</p>
      {% set srri_status = request.query_params.get('srri_status') %}
      {% set srri_dur = request.query_params.get('srri_dur') %}
      {% set srri_affaires_status = request.query_params.get('srri_affaires_status') %}
      {% set srri_affaires_dur = request.query_params.get('srri_affaires_dur') %}
      {% if srri_status == 'ok' %}
        <div style="margin-bottom:8px; padding:10px 12px; border-radius:8px; background:#dcfce7; color:#166534;">
          Recalcul SRRI/volatilité lancé et synchronisé depuis <code>tempo_hist_personne_w</code>{% if srri_dur %} en {{ srri_dur }}s{% endif %}.
        </div>
      {% elif srri_status == 'error' %}
        <div style="margin-bottom:8px; padding:10px 12px; border-radius:8px; background:#fee2e2; color:#b91c1c;">
          Le recalcul SRRI/volatilité a échoué. Consulte les logs pour le détail.
        </div>
      {% endif %}
      {% if srri_affaires_status == 'ok' %}
        <div style="margin-bottom:8px; padding:10px 12px; border-radius:8px; background:#dcfce7; color:#166534;">
          Recalcul SRRI/volatilité des contrats lancé et synchronisé depuis <code>tempo_hist_affaire_w</code>{% if srri_affaires_dur %} en {{ srri_affaires_dur }}s{% endif %}.
        </div>
      {% elif srri_affaires_status == 'error' %}
        <div style="margin-bottom:8px; padding:10px 12px; border-radius:8px; background:#fee2e2; color:#b91c1c;">
          Le recalcul SRRI/volatilité des contrats a échoué. Consulte les logs pour le détail.
        </div>
      {% endif %}
      <form method="post" action="/dashboard/superadmin/recompute-srri" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button type="submit" class="btn btn-primary">Calcul des niveaux de risques de tous les clients</button>
      </form>
      <form method="post" action="/dashboard/superadmin/recompute-srri-affaires" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px;">
        <button type="submit" class="btn btn-primary">Calcul des niveaux de risques pour tous les contrats</button>
      </form>
    </div>
  </details>
</div>

<div class="card" id="suivi-logs" style="margin-top:1rem;">
  <details data-log-details style="border:0; padding:0;">
    <summary style="list-style:none; cursor:pointer;">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center; padding:0 0 6px 0;">
        <div>
          <h2 style="margin:0 0 6px 0; font-size:1.2rem;">Suivi des traitements</h2>
          <p class="muted" style="margin:0;">Logs en base : typologie, déclencheur, horodatage et message de fin.</p>
        </div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <div class="muted" style="font-size:0.9rem;">{{ total_logs or 0 }} entrées</div>
          <span class="btn btn-secondary" data-log-toggle-label style="background:#f3f4f6; color:#111827; pointer-events:none;">Afficher</span>
        </div>
      </div>
    </summary>
    <div style="margin-top:12px;">
    <form method="get" action="/dashboard/superadmin#suivi-logs" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:0;">
      {% if selected_societe %}<input type="hidden" name="societe_id" value="{{ selected_societe.id }}">{% endif %}
      {% if search_term %}<input type="hidden" name="q" value="{{ search_term }}">{% endif %}
      {% if page %}<input type="hidden" name="page" value="{{ page }}">{% endif %}
      {% if user_search_term %}<input type="hidden" name="uq" value="{{ user_search_term }}">{% endif %}
      {% if user_page %}<input type="hidden" name="upage" value="{{ user_page }}">{% endif %}
      {% if client_search_term %}<input type="hidden" name="cq" value="{{ client_search_term }}">{% endif %}
      {% if client_page %}<input type="hidden" name="cpage" value="{{ client_page }}">{% endif %}
      <label style="display:flex; flex-direction:column; gap:4px; font-size:0.95rem;">
        <span>Typologie</span>
        <select class="form-control" name="ltype" style="min-width:220px;">
          <option value="">Toutes</option>
          {% for lt in log_types or [] %}
            <option value="{{ lt.id }}" {% if log_type_filter and log_type_filter == lt.id %}selected{% endif %}>
              {{ lt.label or lt.code }}
            </option>
          {% endfor %}
        </select>
      </label>
      <label style="display:flex; flex-direction:column; gap:4px; font-size:0.95rem;">
        <span>Statut</span>
        {% set lstatus = log_status_filter or '' %}
        <select class="form-control" name="lstatus" style="min-width:160px;">
          <option value="" {% if lstatus == '' %}selected{% endif %}>Tous</option>
          <option value="ok" {% if lstatus == 'ok' %}selected{% endif %}>Succès</option>
          <option value="error" {% if lstatus == 'error' %}selected{% endif %}>Erreur</option>
          <option value="running" {% if lstatus == 'running' %}selected{% endif %}>En cours</option>
        </select>
      </label>
      <label style="display:flex; flex-direction:column; gap:4px; font-size:0.95rem;">
        <span>Filtre message</span>
        <input class="form-control" type="text" name="lq" value="{{ log_search_term or '' }}" placeholder="Texte à rechercher" style="min-width:220px;">
      </label>
      <button type="submit" class="btn btn-secondary" style="height: fit-content;">Filtrer</button>
      <button type="button" class="btn btn-secondary" style="height: fit-content; background:#f3f4f6; color:#111827;" onclick="window.location.reload()">Rafraîchir</button>
      <a class="btn btn-secondary" href="/dashboard/superadmin#suivi-logs" style="background:#f3f4f6; color:#111827; height: fit-content;">Réinitialiser</a>
    </form>

    {% if logs_suivi %}
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:12px;">
        {% for lg in logs_suivi %}
          {% if loop.index0 > 0 and loop.index0 % 20 == 0 %}
            <div style="padding:6px 0; border-top:2px dashed var(--border); color:var(--muted); font-size:0.9rem;">Rupture {{ loop.index0 }}</div>
          {% endif %}
          <div style="padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <span style="font-weight:600;">{{ lg.type_label or lg.type_code or 'Sans type' }}</span>
              {% set st = lg.status or '' %}
              {% if st == 'ok' %}
                <span class="status-pill" style="background:#dcfce7; color:#166534;">Succès</span>
              {% elif st == 'error' %}
                <span class="status-pill" style="background:#fee2e2; color:#b91c1c;">Erreur</span>
              {% else %}
                <span class="status-pill" style="background:#e0f2fe; color:#075985;">En cours</span>
              {% endif %}
            </div>
            <div>
              <div style="font-weight:600;">Horodatage</div>
              <div class="muted" style="margin-top:4px;">
                Début : {{ lg.started_at.strftime('%d/%m/%Y %H:%M:%S') if lg.started_at else '—' }}<br>
                Fin : {{ lg.ended_at.strftime('%d/%m/%Y %H:%M:%S') if lg.ended_at else '—' }}
              </div>
              <div class="muted" style="margin-top:4px;">Durée : {{ '%.2fs'|format(lg.duration_seconds) if lg.duration_seconds is not none else '—' }}</div>
            </div>
            <div>
              <div style="font-weight:600;">Déclenché par</div>
              <div class="muted" style="margin-top:4px;">
                {% if lg.user_prenom or lg.user_nom %}
                  {{ lg.user_prenom or '' }} {{ lg.user_nom or '' }}
                {% elif lg.user_login %}
                  {{ lg.user_login }}
                {% elif lg.user_id %}
                  Utilisateur #{{ lg.user_id }}
                {% else %}
                  Non renseigné
                {% endif %}
                {% if lg.ip_address %}<br>IP : {{ lg.ip_address }}{% endif %}
              </div>
            </div>
            <div style="grid-column:1/-1;">
              <div style="font-weight:600;">Message</div>
              <div style="margin-top:4px; padding:8px 10px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; white-space:pre-wrap;">{{ lg.message or '—' }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:10px; flex-wrap:wrap;">
        <div class="muted" style="font-size:0.9rem;">{{ total_logs }} logs — page {{ log_page }} / {{ log_page_count }}</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          {% set log_qs = '' %}
          {% if log_type_filter %}{% set log_qs = log_qs ~ '&ltype=' ~ log_type_filter %}{% endif %}
          {% if log_status_filter %}{% set log_qs = log_qs ~ '&lstatus=' ~ log_status_filter %}{% endif %}
          {% if log_search_term %}{% set log_qs = log_qs ~ '&lq=' ~ log_search_term %}{% endif %}
          {% if log_page > 1 %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?lpage={{ log_page - 1 }}{{ log_qs }}#suivi-logs">Précédent</a>
          {% endif %}
          {% if log_page < log_page_count %}
            <a class="btn btn-secondary" href="/dashboard/superadmin?lpage={{ log_page + 1 }}{{ log_qs }}#suivi-logs">Suivant</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p class="muted" style="margin-top:10px;">Aucun log enregistré pour l'instant.</p>
    {% endif %}
    </div>
  </details>
</div>
<script>
  (function() {
    const details = document.querySelector('[data-log-details]');
    const label = document.querySelector('[data-log-toggle-label]');
    if (!details || !label) return;
    details.open = false;
    const setLabel = () => { label.textContent = details.open ? 'Masquer' : 'Afficher'; };
    // Ouverture explicite uniquement via ancre #suivi-logs
    if (window.location.hash === '#suivi-logs') details.open = true;
    details.addEventListener('toggle', setLabel);
    setLabel();
  })();
</script>
{% endblock %}
