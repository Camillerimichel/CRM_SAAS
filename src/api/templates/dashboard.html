{% extends "base.html" %}

{% block title %}Tableau de bord{% endblock %}
{% block header_title %}
<span class="header-title-text"><i class="fa-solid fa-house" style="margin-right:8px;"></i>Tableau de bord</span>
{% endblock %}

{% block content %}


{% set tb_markers_param = tb_markers_param or '' %}
{% set tb_markers_suffix = ('&' + tb_markers_param) if tb_markers_param else '' %}
<div class="tb-page{% if tb_markers_visible %} tb-markers-enabled{% endif %}" data-tb-marker="TB_01">
<!-- KPIs -->
<style>
  .header-title-text { display: inline-flex; align-items: center; gap: 8px; }
  /* Rapprocher la zone de travail du bandeau d'onglets */
  .container { margin-top: 0; padding-top: 0; }
</style>
<style>
  .accordion-toggle {
    transition: background .2s ease, color .2s ease, border .2s ease;
    border: 1px solid var(--border);
    background: #fff;
    color: inherit;
  }
  .accordion-toggle .chevron {
    transition: transform .2s ease, color .2s ease;
    color: #1f4eb8;
  }
  .accordion-toggle.collapsed .chevron {
    transform: rotate(-90deg);
  }
  .accordion-toggle:not(.collapsed) {
    background: #1f4eb8;
    color: #fff;
    border-color: #1f4eb8;
  }
  .accordion-toggle:not(.collapsed) .chevron {
    color: #fff;
  }
  .accordion-toggle:not(.collapsed) h3,
  .accordion-toggle:not(.collapsed) span,
  .accordion-toggle:not(.collapsed) i {
    color: #fff;
  }
  .risk-stat-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 4px 0;
    font-size: 0.9rem;
  }
  .risk-stat-row a {
    color: inherit;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .risk-dot {
    display: inline-block;
    width: 11px;
    height: 11px;
    border-radius: 50%;
  }
  .risk-dot.red { background: #ef4444; }
  .risk-dot.green { background: #16a34a; }
  .risk-dot.blue { background: #3b82f6; }
  .tasks-kpis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 10px;
    margin: 12px 0;
  }
  .tasks-kpi-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
  }
  .tasks-kpi-label { color: var(--muted); font-weight: 700; font-size: 13px; }
  .tasks-kpi-value { font-size: 20px; font-weight: 800; margin-top: 4px; }
  /* Tabs principaux (Dashboard) */
  .dash-tabs {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    overflow-x: visible;
    justify-content: center;
    align-items: center;
    padding: 6px 12px;
    border-bottom: 1px solid var(--border);
    background: #f8fafe;
    margin: 0 auto 10px;
    max-width: 1200px;
    width: 100%;
    scrollbar-width: thin;
  }
  .dash-tab {
    border: 1px solid transparent;
    background: transparent;
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    box-shadow: none;
    transition: all .15s ease;
    flex: 0 1 120px;
    min-width: 110px;
    min-height: 40px;
    text-align: center;
  }
  .dash-tab i { color: var(--primary-600); }
  .dash-tab:hover { transform: translateY(-1px); border-color: transparent; }
  .dash-tab.active {
    background: transparent;
    color: var(--primary-600);
    border-color: transparent;
    box-shadow: none;
  }
  .dash-tab.active i { color: var(--primary-600); }
  /* RBAC UI hides */
  body[data-user-role="client"] .client-hide { display: none !important; }
  body[data-user-role="client"] .client-readonly { pointer-events: none !important; opacity: 0.5; }
  body[data-user-role="back_office"] .backoffice-hide { display: none !important; }
</style>
<!-- Tabs principaux -->
<div class="dash-tabs" id="dashTabs">
  <button class="dash-tab" data-key="risks" data-target="risksSection"><i class="fa-solid fa-shield-halved"></i> Risques</button>
  <button class="dash-tab" data-key="esg" data-target="esgSection"><i class="fa-solid fa-leaf"></i> ESG</button>
  <button class="dash-tab client-hide backoffice-hide" data-key="groups" data-target="groupsSection"><i class="fa-solid fa-layer-group"></i> Groupes</button>
  <button class="dash-tab" data-key="commissions" data-target="remSection"><i class="fa-solid fa-coins"></i> Commissions</button>
</div>

  <style>
    /* Barre horizontale pour Risques */
    .risk-toggle-row {
      display:flex;
      gap:8px;
      align-items:stretch;
      flex-wrap:nowrap;
    overflow-x:auto;
    padding:8px 0 10px;
    margin:8px auto 12px auto;
    max-width:1100px;
    box-sizing:border-box;
  }
  .risk-toggle-row .risk-toggle {
    flex:1 1 0;
    min-width:160px;
    margin:0;
    text-align:center;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:10px;
    border:1px solid transparent;
    border-radius:10px;
    background: transparent;
    cursor:pointer;
    font-size:0.95rem;
    font-weight:600;
    box-shadow:none;
    color: var(--text);
  }
  .risk-toggle-row .risk-toggle.active {
    background: transparent;
    color: var(--primary-600);
    border-color: transparent;
    box-shadow: none;
  }
  </style>

  <!-- Accord√©on Risques -->
  <div id="risksToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_21" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">Conformit√© et suivi du risque</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="risksSection" data-tb-marker="TB_22" >
    <div class="risk-toggle-row">
      <div class="risk-toggle" data-target="complianceSection">Conformit√© r√©glementaire</div>
      <div class="risk-toggle" data-target="rcpSection">Requis r√©glementaires</div>
      <div class="risk-toggle" data-target="srriSection">Suivi du risque</div>
      <div class="risk-toggle" data-target="clienteleSection">R√©partition par client√®le</div>
      <div class="risk-toggle" data-target="contractsSection">R√©partition par contrats</div>
    </div>
    <div style="height:1px; background:var(--border); margin:10px 0;"></div>
  <!-- Sous-accord√©on: Conformit√© r√©glementaire -->
  <div id="complianceToggle" ></div>
  <div id="complianceSection" data-tb-marker="TB_24" >
    <div class="card" data-tb-marker="TB_25" style="max-width:900px; margin: 0 auto 1rem auto; text-align:center;">
      <div style="display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <button id="conformiteLoadBtn" class="btn" style="height:34px; display:inline-flex; align-items:center; gap:6px;">
          <i class="fa-solid fa-rotate"></i> Charger la conformit√©
        </button>
        <span id="conformiteStatus" class="muted" style="align-self:center; font-size:0.9rem;">(non charg√©)</span>
      </div>
      <div style="display:none; justify-content:center; gap:12px; flex-wrap:wrap; margin-bottom:12px;" aria-hidden="true">
        <div class="card" style="width:360px; padding:18px; border:1px solid var(--primary); border-radius:10px; box-shadow:0 4px 12px rgba(15,23,42,0.08); text-align:center;">
          <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
            <i class="fa-solid fa-users" style="color:var(--primary);"></i>
            <h3 class="risk-card-title" style="margin:0;">D√©passement de risque clients</h3>
          </div>
          <div style="margin-top:8px;">
            <div class="risk-stat-row">
              <span class="risk-dot red"></span>
              <span><strong>{{ cli_risk_counts.above }}</strong> ‚Äî Au‚Äëdessus du risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot green"></span>
              <span><strong>{{ cli_risk_counts.equal }}</strong> ‚Äî Dans le risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot blue"></span>
              <span><strong>{{ cli_risk_counts.below }}</strong> ‚Äî En dessous du risque</span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:6px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-coins" style="color:var(--primary);"></i>
                <strong>{{ cli_risk_amounts_fmt.above }}</strong> ‚Ç¨ ‚Äî Montant sous risque
              </span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:4px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-percent" style="color:var(--primary);"></i>
                <strong>{{ cli_risk_under_pct }}</strong> % ‚Äî Part sous risque
              </span>
            </div>
          </div>
        </div>
        <div class="card" style="width:360px; padding:18px; border:1px solid #f87171; border-radius:10px; box-shadow:0 4px 12px rgba(220,38,38,0.15); text-align:center;">
          <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
            <i class="fa-solid fa-briefcase" style="color:#dc2626;"></i>
            <h3 class="risk-card-title" style="margin:0;">D√©passement de risque contrats</h3>
          </div>
          <div style="margin-top:8px;">
            <div class="risk-stat-row">
              <span class="risk-dot blue"></span>
              <span><strong>{{ aff_risk_counts.below }}</strong> ‚Äî En dessous du risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot green"></span>
              <span><strong>{{ aff_risk_counts.equal }}</strong> ‚Äî Dans le risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot red"></span>
              <span><strong>{{ aff_risk_counts.above }}</strong> ‚Äî Au dessus du risque</span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:6px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-coins" style="color:#dc2626;"></i>
                <strong>{{ aff_risk_amounts_fmt.above }}</strong> ‚Ç¨ ‚Äî Montant sous risque
              </span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:4px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-percent" style="color:#dc2626;"></i>
                <strong>{{ aff_risk_under_pct }}</strong> % ‚Äî Part sous risque
              </span>
            </div>
          </div>
        </div>
      </div>
      <div data-tb-marker="TB_26" style="margin-top:12px; display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap:12px;">
        <div data-tb-marker="TB_27" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">DER</div>
          <div class="muted" style="font-size:0.85rem;">Total : <span id="derTotal">‚Äî</span> / <span id="derTotalPct">‚Äî</span> %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : <span id="derObs">‚Äî</span> / <span id="derObsPct">‚Äî</span> %</div>
          <div class="compliance-progress" role="img" aria-label="DER">
            <div id="derValidBar" class="compliance-progress-valid" style="width:0%;"></div>
            <div id="derObsBar" class="compliance-progress-obsolete" style="width:0%;"></div>
          </div>
        </div>
        <div data-tb-marker="TB_28" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Connaissance client</div>
          <div class="muted" style="font-size:0.85rem;">Total : <span id="ccTotal">‚Äî</span> / <span id="ccTotalPct">‚Äî</span> %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : <span id="ccObs">‚Äî</span> / <span id="ccObsPct">‚Äî</span> %</div>
          <div class="compliance-progress" role="img" aria-label="Connaissance client">
            <div id="ccValidBar" class="compliance-progress-valid" style="width:0%;"></div>
            <div id="ccObsBar" class="compliance-progress-obsolete" style="width:0%;"></div>
          </div>
        </div>
        <div data-tb-marker="TB_29" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">ESG</div>
          <div class="muted" style="font-size:0.85rem;">Total : <span id="esgTotal">‚Äî</span> / <span id="esgTotalPct">‚Äî</span> %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : <span id="esgObs">‚Äî</span> / <span id="esgObsPct">‚Äî</span> %</div>
          <div class="compliance-progress" role="img" aria-label="ESG">
            <div id="esgValidBar" class="compliance-progress-valid" style="width:0%;"></div>
            <div id="esgObsBar" class="compliance-progress-obsolete" style="width:0%;"></div>
          </div>
        </div>
        <div data-tb-marker="TB_30" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Lettres de mission</div>
          <div class="muted" style="font-size:0.85rem;">Total : <span id="lmTotal">‚Äî</span> / <span id="lmTotalPct">‚Äî</span> %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : <span id="lmObs">‚Äî</span> / <span id="lmObsPct">‚Äî</span> %</div>
          <div class="compliance-progress" role="img" aria-label="Lettres de mission">
            <div id="lmValidBar" class="compliance-progress-valid" style="width:0%;"></div>
            <div id="lmObsBar" class="compliance-progress-obsolete" style="width:0%;"></div>
          </div>
        </div>
        <div data-tb-marker="TB_31" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Lettres d'ad√©quation</div>
          <div class="muted" style="font-size:0.85rem;">Total : <span id="laTotal">‚Äî</span> / <span id="laTotalPct">‚Äî</span> %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : <span id="laObs">‚Äî</span> / <span id="laObsPct">‚Äî</span> %</div>
          <div class="compliance-progress" role="img" aria-label="Lettres d'ad√©quation">
            <div id="laValidBar" class="compliance-progress-valid" style="width:0%;"></div>
            <div id="laObsBar" class="compliance-progress-obsolete" style="width:0%;"></div>
          </div>
        </div>
        <div data-tb-marker="TB_32" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
            <div style="font-weight:600; background:#f1f5f9; border-radius:8px; padding:6px; flex:1; text-align:center;">R√©clamations</div>
            <button type="button" onclick="openInfoModal('reclamPivot')" aria-label="Voir le d√©tail des r√©clamations" style="display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:50%; border:1px solid var(--primary); background:#fff; color:var(--primary); font-weight:600; cursor:pointer;">i</button>
          </div>
          <div class="muted" style="font-size:0.85rem;">Total : <span id="reclamTotal">‚Äî</span></div>
          <div id="reclamStatusList" class="muted" style="font-size:0.85rem;">(non charg√©)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="info-modal-backdrop" id="infoModal-reclamPivot" aria-hidden="true">
    <div class="info-modal-dialog" style="max-height: 90vh; overflow-y:auto;">
      <button type="button" class="info-modal-close" onclick="closeInfoModal('reclamPivot')">√ó</button>
      <div class="info-modal-body" style="max-height: 75vh; overflow-y: auto;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <h3 style="margin:0;">R√©clamations par type et statut</h3>
          <a href="/dashboard/reclamations/export"
             style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:6px; border:1px solid var(--primary); background:var(--primary); color:#fff; font-size:0.85rem; text-decoration:none;"
             download>
            Export Excel
          </a>
        </div>
        {% if reclam_pivot.types and reclam_pivot.statuses %}
          <style>
            .reclam-pivot-table {
              width: 100%;
              border-collapse: separate;
              border-spacing: 0;
              font-size: 0.78rem;
              margin-top: 0.5rem;
            }
            .reclam-pivot-table thead {
              position: sticky;
              top: 0;
              z-index: 3;
            }
            .reclam-pivot-table th {
              border: 1px solid #e2e8f0;
              padding: 4px 6px;
              text-align: center;
              white-space: normal;
              line-height: 1.2;
            }
            .reclam-pivot-table td {
              border: 1px solid #e2e8f0;
              padding: 4px 6px;
              text-align: center;
              white-space: nowrap;
            }
            .reclam-pivot-table tbody td:first-child {
              text-align: left;
              background: #e2e8f0;
              font-weight: 600;
              position: sticky;
              left: 0;
              z-index: 1;
            }
            .reclam-pivot-table thead th {
              position: sticky;
              top: 0;
              background: var(--primary);
              color: #fff;
              z-index: 2;
              font-size: 0.78rem;
            }
            .reclam-pivot-table thead th:first-child {
              left: 0;
            }
          </style>
          <div style="overflow:auto; max-height:60vh; position: relative;">
            <table class="reclam-pivot-table">
              <thead>
                <tr>
                  <th>Type d'√©v√©nement</th>
                  {% for status in reclam_pivot.statuses %}
                    {% set status_lower = (status or '')|lower %}
                    {% if status_lower.startswith('annul') or status_lower.startswith('clotur') or status_lower.startswith('cl√¥tur') %}
                      {% set status_display = (status or '').replace(' ', '<br>') %}
                    {% else %}
                      {% set status_display = status %}
                    {% endif %}
                    <th>{{ status_display|safe }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for type in reclam_pivot.types %}
                  <tr>
                    <td>{{ type.label or 'Type non renseign√©' }}</td>
                    {% for status in reclam_pivot.statuses %}
                      {% set cell_value = type.counts.get(status, 0) %}
                      <td>
                        {% if cell_value %}
                          {{ cell_value }}
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted" style="margin:0;">Aucune donn√©e disponible.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Sous-accord√©on: R√©partition par client√®le -->
  <div id="rcpToggle" ></div>
  <div id="rcpSection" data-tb-marker="TB_34" style="display:none; max-width:900px; margin: 0 auto 1rem auto;">
    <div class="card" style="max-width:900px; margin: 0 auto 1rem auto; text-align:center;">
      
      <style>
        .info-modal-backdrop {
          position: fixed;
          inset: 0;
          background: rgba(15,23,42,0.55);
          display: none;
          align-items: center;
          justify-content: center;
          padding: 1.25rem;
          z-index: 1200;
        }
        .info-modal-backdrop.active {
          display: flex;
        }
        .info-modal-dialog {
          background: #fff;
          border-radius: 10px;
          padding: 1rem 1.4rem;
          width: min(95vw, 1200px);
          max-width: 1200px;
          overflow-x: auto;
          box-shadow: 0 15px 30px rgba(15,23,42,0.2);
          position: relative;
          
        }
        .info-modal-close {
          position: absolute;
          top: 0.5rem;
          right: 0.5rem;
          border: none;
          background: none;
          font-size: 1.1rem;
          color: var(--muted, #64748b);
          cursor: pointer;
        }
        .info-modal-close:hover {
          color: var(--primary, #1f2b6c);
        }
        .info-modal-body {
          font-size: 0.95rem;
          color: #0f172a;
        }
        .orias-detail-row {
          margin-bottom: 0.45rem;
          font-size: 0.9rem;
          color: #0f172a;
          white-space: nowrap;
        }
        .orias-detail-row strong {
          display: inline-block;
          min-width: 180px;
          color: var(--primary-700, #1d4ed8);
        }
        .info-btn {
          border: none;
          background: none;
          color: var(--primary, #1f2b6c);
          cursor: pointer;
          font-size: 1rem;
        }
        .info-btn:hover {
          color: var(--primary-600, #2f47ad);
        }
        .compliance-progress {
          display: flex;
          align-items: stretch;
          height: 18px;
          border-radius: 999px;
          overflow: hidden;
          background: #e2e8f0;
          margin-top: 0.45rem;
        }
        .compliance-progress-valid,
        .compliance-progress-obsolete {
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.78rem;
          font-weight: 600;
          color: #0f172a;
          white-space: nowrap;
          transition: width 0.3s ease;
        }
        .compliance-progress-valid {
          background: linear-gradient(90deg, #34d399, #22c55e);
          color: #064e3b;
        }
        .compliance-progress-obsolete {
          background: linear-gradient(90deg, #fb7185, #f43f5e);
          color: #7f1d1d;
        }
        .doc-expired-flag {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: #dc2626;
          color: #fff;
          border-radius: 999px;
          padding: 0 0.4rem;
          font-size: 0.72rem;
          font-weight: 700;
          text-transform: uppercase;
          margin-right: 0.45rem;
        }
      </style>

      <div style="margin-top:12px; display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap:12px;">
        {% set info_ids = {
          'Inscription ORIAS': 'orias',
          'Adh√©sion association professionnelle': 'association',
          'Souscription RC Pro': 'rcpro',
          'Distribution des contrats': 'distribution',
          "Conditions d'exercice": 'conditions',
          'R√¥le du distributeur': 'role',
          'Blanchiment': 'blanchiment',
          'Gouvernance produit': 'gouvernance',
          'Conclusion des contrats': 'conclusion'
        } %}
        {% set info_records = {
          'orias': 1,
          'association': 2,
          'rcpro': 3,
          'distribution': 4,
          'conditions': 5,
          'role': 6,
          'blanchiment': 7,
          'gouvernance': 8,
          'conclusion': 9
        } %}
        {% for title in [
          'Inscription ORIAS',
          'Adh√©sion association professionnelle',
          'Souscription RC Pro',
          'Distribution des contrats',
          "Conditions d'exercice",
          'R√¥le du distributeur',
          'Blanchiment',
          'Gouvernance produit',
          'Conclusion des contrats'
        ] %}
      {% set tile_style = "background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);" %}
      {% if title == 'Souscription RC Pro' and rcpro_doc_count > 0 and not rcpro_doc_valid %}
        {% set tile_style = tile_style + " background:#fee2e2; border-color:#b91c1c;" %}
      {% endif %}
      <div style="{{ tile_style }}">
        <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px; display:flex; align-items:center; justify-content:center; gap:8px;">{{ title }}{% set info_id = info_ids.get(title) %}{% if info_id %} <button type='button' class='info-btn' onclick="openInfoModal('{{ info_id }}')" title='Informations'>‚ÑπÔ∏è</button>{% endif %}</div>
          {% if title == 'Inscription ORIAS' %}
            {% if orias_doc_valid %}
              <p style="margin:0; font-weight:600; color:#166534;">üü¢ Valide jusqu'au {{ orias_doc_expiry_display }}</p>
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Risque RC Pro</p>
            {% endif %}
            {% if orias_detail %}
              <div class="muted" style="margin-top:0.75rem; text-align:left; font-size:0.85rem; line-height:1.4;">
                {% if orias_detail.code_reglement %}
                  <div><strong>Code r√©glementaire :</strong> <span>{{ orias_detail.code_reglement }}</span></div>
                {% endif %}
                {% if orias_detail.articles %}
                  <div><strong>Articles :</strong> <span>{{ orias_detail.articles }}</span></div>
                {% endif %}
                {% if orias_detail.references_complementaires %}
                  <div><strong>R√©f√©rences compl√©mentaires :</strong> <span>{{ orias_detail.references_complementaires }}</span></div>
                {% endif %}
                {% for link_key in ['lien_1','lien_2','lien_3','lien_4','lien_5'] %}
                  {% set link_value = orias_detail.get(link_key) %}
                  {% if link_value %}
                    <div><strong>{{ link_key|replace('_', ' ')|title }} :</strong> <a href="{{ link_value }}" target="_blank" rel="noopener">{{ link_value }}</a></div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% elif title == 'Adh√©sion association professionnelle' %}
            {% if assoc_doc_valid %}
              <p style="margin:0; font-weight:600; color:#166534;">üü¢ Valide jusqu'au {{ assoc_doc_expiry_display }}</p>
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Risque association professionnelle</p>
            {% endif %}
          {% elif title == 'Souscription RC Pro' %}
            {% if rcpro_doc_count > 0 %}
              {% if rcpro_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ rcpro_doc_valid_count }} document{% if rcpro_doc_valid_count > 1 %}s{% endif %} valide{% if rcpro_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ rcpro_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ rcpro_doc_count }} document{% if rcpro_doc_count > 1 %}s{% endif %} ‚Äî Risque RC Pro</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque RC Pro</p>
            {% endif %}
            {% if rcpro_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ rcpro_doc_expired_count }} document{% if rcpro_doc_expired_count > 1 %}s{% endif %} expir√©{% if rcpro_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Conditions d\'exercice' %}
            {% if conditions_doc_count > 0 %}
              {% if conditions_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ conditions_doc_valid_count }} document{% if conditions_doc_valid_count > 1 %}s{% endif %} valide{% if conditions_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ conditions_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ conditions_doc_count }} document{% if conditions_doc_count > 1 %}s{% endif %} ‚Äî Risque conditions d'exercice</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque conditions d'exercice</p>
            {% endif %}
            {% if conditions_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ conditions_doc_expired_count }} document{% if conditions_doc_expired_count > 1 %}s{% endif %} expir√©{% if conditions_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'R√¥le du distributeur' %}
            {% if role_doc_count > 0 %}
              {% if role_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ role_doc_valid_count }} document{% if role_doc_valid_count > 1 %}s{% endif %} valide{% if role_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ role_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ role_doc_count }} document{% if role_doc_count > 1 %}s{% endif %} ‚Äî Risque r√¥le du distributeur</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque r√¥le du distributeur</p>
            {% endif %}
            {% if role_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ role_doc_expired_count }} document{% if role_doc_expired_count > 1 %}s{% endif %} expir√©{% if role_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Gouvernance produit' %}
            {% if gouvernance_doc_count > 0 %}
              {% if gouvernance_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ gouvernance_doc_valid_count }} document{% if gouvernance_doc_valid_count > 1 %}s{% endif %} valide{% if gouvernance_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ gouvernance_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ gouvernance_doc_count }} document{% if gouvernance_doc_count > 1 %}s{% endif %} ‚Äî Risque gouvernance produit</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque gouvernance produit</p>
            {% endif %}
            {% if gouvernance_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ gouvernance_doc_expired_count }} document{% if gouvernance_doc_expired_count > 1 %}s{% endif %} expir√©{% if gouvernance_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Conclusion des contrats' %}
            {% if conclusion_doc_count > 0 %}
              {% if conclusion_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ conclusion_doc_valid_count }} document{% if conclusion_doc_valid_count > 1 %}s{% endif %} valide{% if conclusion_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ conclusion_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ conclusion_doc_count }} document{% if conclusion_doc_count > 1 %}s{% endif %} ‚Äî Risque conclusion des contrats</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque conclusion des contrats</p>
            {% endif %}
            {% if conclusion_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ conclusion_doc_expired_count }} document{% if conclusion_doc_expired_count > 1 %}s{% endif %} expir√©{% if conclusion_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Blanchiment' %}
            {% if blanchiment_doc_count > 0 %}
              {% if blanchiment_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ blanchiment_doc_valid_count }} document{% if blanchiment_doc_valid_count > 1 %}s{% endif %} valide{% if blanchiment_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ blanchiment_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ blanchiment_doc_count }} document{% if blanchiment_doc_count > 1 %}s{% endif %} ‚Äî Risque blanchiment</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque blanchiment</p>
            {% endif %}
            {% if blanchiment_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ blanchiment_doc_expired_count }} document{% if blanchiment_doc_expired_count > 1 %}s{% endif %} expir√©{% if blanchiment_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Distribution des contrats' %}
            <div class="muted" style="font-size:0.85rem;">Obsolescence moyenne : {{ '%.1f'|format(distribution_avg_obsolete_pct or 0.0) }} %</div>
            <div class="muted" style="font-size:0.85rem;">Validit√© moyenne : {{ '%.1f'|format(distribution_avg_valid_pct or 0.0) }} %</div>
            <div class="compliance-progress" role="img" aria-label="Distribution des contrats : {{ distribution_avg_valid_pct|round(1) }} % valides, {{ distribution_avg_obsolete_pct|round(1) }} % obsol√®tes">
              <div class="compliance-progress-valid" style="width: {{ distribution_avg_valid_pct }}%;"></div>
              <div class="compliance-progress-obsolete" style="width: {{ distribution_avg_obsolete_pct }}%;"></div>
            </div>
          {% else %}
            <p class="muted" style="margin:0;">En d√©veloppement.</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% for title, slug in info_ids.items() %}
    <div class="info-modal-backdrop" id="infoModal-{{ slug }}" aria-hidden="true">
      <div class="info-modal-dialog">
        <button type="button" class="info-modal-close" onclick="closeInfoModal('{{ slug }}')">√ó</button>
        <div class="info-modal-body" data-info-slug="{{ slug }}">
          {% set record_id = info_records.get(slug) %}
          {% if record_id %}
            <div class="compliance-detail-content" data-loaded="0" data-record-id="{{ record_id }}">
              <p class="muted" style="margin:0;">Chargement‚Ä¶</p>
            </div>
          {% else %}
            <p>En cours de d√©veloppement.</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
  <script>
    function renderComplianceDetail(container, data){
      if(!container) return;
      container.innerHTML = '';
      var labelMap = {
        activite: 'Activit√©',
        code_reglement: 'Code r√©glementaire',
        articles: 'Articles',
        references_complementaires: 'R√©f√©rences compl√©mentaires'
      };
      var orderedKeys = ['activite', 'code_reglement', 'articles', 'references_complementaires'];
      var linkKeys = ['lien_1','lien_2','lien_3','lien_4','lien_5'];
      function appendRow(label, value, isLink){
        var row = document.createElement('div');
        row.className = 'orias-detail-row';
        var strong = document.createElement('strong');
        strong.textContent = label + ' :';
        row.appendChild(strong);
        if(isLink){
          var anchor = document.createElement('a');
          anchor.href = value;
          anchor.target = '_blank';
          anchor.rel = 'noopener';
          anchor.textContent = value;
          row.appendChild(document.createTextNode(' '));
          row.appendChild(anchor);
        } else {
          var span = document.createElement('span');
          span.textContent = value;
          row.appendChild(document.createTextNode(' '));
          row.appendChild(span);
        }
        container.appendChild(row);
      }
      if(!data || Object.keys(data).length === 0){
        var empty = document.createElement('p');
        empty.className = 'muted';
        empty.textContent = 'Aucune donn√©e disponible.';
        container.appendChild(empty);
        return;
      }
      var seen = {};
      orderedKeys.forEach(function(key){
        if(!Object.prototype.hasOwnProperty.call(data, key)) return;
        var value = data[key];
        if(value === null || value === undefined || value === '') return;
        appendRow(labelMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, function(c){ return c.toUpperCase(); }), value, linkKeys.indexOf(key) !== -1);
        seen[key] = true;
      });
      Object.keys(data).forEach(function(key){
        if(seen[key]) return;
        var value = data[key];
        if(value === null || value === undefined || value === '') return;
        var isLink = linkKeys.indexOf(key) !== -1;
        appendRow(labelMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, function(c){ return c.toUpperCase(); }), value, isLink);
      });
    }
    function fetchComplianceDetail(container){
      if(!container || container.getAttribute('data-loaded') === '1' || container.getAttribute('data-loading') === '1'){
        return;
      }
      var recordId = container.getAttribute('data-record-id');
      if(!recordId){
        container.innerHTML = '<p class="muted" style="margin:0;">Aucune donn√©e disponible.</p>';
        return;
      }
      container.setAttribute('data-loading', '1');
      container.innerHTML = '<p class="muted" style="margin:0;">Chargement‚Ä¶</p>';
      fetch('/dashboard/compliance_rc_pro/' + recordId)
        .then(function(resp){
          if(!resp.ok){
            throw new Error('fetch-failed');
          }
          return resp.json();
        })
        .then(function(payload){
          renderComplianceDetail(container, payload);
          container.setAttribute('data-loaded', '1');
        })
        .catch(function(){
          container.innerHTML = '<p class="muted" style="margin:0;">Erreur lors du chargement des donn√©es.</p>';
        })
        .finally(function(){
          container.removeAttribute('data-loading');
        });
    }
    function openInfoModal(id){
      var modal = document.getElementById('infoModal-' + id);
      if(!modal) return;
      var content = modal.querySelector('.compliance-detail-content');
      fetchComplianceDetail(content);
      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeInfoModal(id){
      var modal = document.getElementById('infoModal-' + id);
      if(!modal) return;
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape'){
        document.querySelectorAll('.info-modal-backdrop.active').forEach(function(modal){
          closeInfoModal(modal.id.replace('infoModal-',''));
        });
      }
    });
    document.addEventListener('click', function(ev){
      var target = ev.target;
      if(target.classList && target.classList.contains('info-modal-backdrop')){
        closeInfoModal(target.id.replace('infoModal-',''));
      }
    });
  </script>




<div id="clienteleToggle" ></div>
  <div id="clienteleSection" data-tb-marker="TB_36" >
    <div class="card" data-tb-marker="TB_35" style="max-width: 900px; margin: 0 auto 1rem auto; height: calc(18vh + 50px); display:flex; flex-direction:column;">
      <h3>D√©coupage clients par d√©tention</h3>
      <canvas id="chartClientsBuckets" style="flex:1 1 auto; min-height:0;"></canvas>
  </div>
</div>

<div id="contractsToggle" ></div>
  <div id="contractsSection" data-tb-marker="TB_37" style="display:none;">
    <div class="card" style="max-width: 900px; margin: 0 auto 1rem auto; height: calc(18vh + 50px); display:flex; flex-direction:column;">
      <h3>D√©coupage contrat par d√©tention</h3>
      <canvas id="chartContractsBuckets" style="flex:1 1 auto; min-height:0;"></canvas>
    </div>
  </div>

<!-- Sous-accord√©on: R√©partitions SRRI -->
  <div id="srriToggle" ></div>
  <div id="srriSection" data-tb-marker="TB_38" >
    <div class="charts" data-tb-marker="TB_44" style="display:grid; grid-template-columns: minmax(260px, 320px) repeat(2, minmax(260px, 1fr)); gap:12px; max-width:1200px; margin:0 auto 12px auto; align-items:stretch;">
      <div class="card" data-tb-marker="TB_38" style="display:flex; flex-direction:column; align-items:flex-start; text-align:left;">
        <div data-tb-marker="TB_39" style="display:flex; align-items:center; justify-content:flex-start; gap:8px; width:100%;">
          <h3 class="risk-card-title" style="margin:0;">Clients</h3>
        </div>
        <div data-tb-marker="TB_40" style="margin-top:8px; width:100%;">
          <div class="risk-stat-row" data-tb-marker="TB_41" style="justify-content:flex-start;">
            <span class="risk-dot red"></span>
            <a href="/dashboard/clients?risk=above" target="_blank" rel="noopener noreferrer">
              <strong>{{ cli_risk_counts.above }}</strong> ‚Äî Au‚Äëdessus du risque
            </a>
          </div>
          <div class="risk-stat-row" data-tb-marker="TB_42" style="justify-content:flex-start;">
            <span class="risk-dot green"></span>
            <a href="/dashboard/clients?risk=equal" target="_blank" rel="noopener noreferrer">
              <strong>{{ cli_risk_counts.equal }}</strong> ‚Äî Dans le risque
            </a>
          </div>
          <div class="risk-stat-row" data-tb-marker="TB_43" style="justify-content:flex-start;">
            <span class="risk-dot blue"></span>
            <a href="/dashboard/clients?risk=below" target="_blank" rel="noopener noreferrer">
              <strong>{{ cli_risk_counts.below }}</strong> ‚Äî Sous le risque
            </a>
          </div>
          <div class="risk-stat-row" style="justify-content:flex-start; margin-top:6px;">
            <span style="display:inline-flex; align-items:center; gap:6px;">
              <i class="fa-solid fa-coins" style="color:var(--primary);"></i>
              <strong>{{ cli_risk_amounts_fmt.above }}</strong> ‚Ç¨ ‚Äî Montant sous risque
            </span>
          </div>
          <div class="risk-stat-row" style="justify-content:flex-start; margin-top:4px;">
            <span style="display:inline-flex; align-items:center; gap:6px;">
              <i class="fa-solid fa-percent" style="color:var(--primary);"></i>
              <strong>{{ cli_risk_under_pct }}</strong> % ‚Äî Part sous risque
            </span>
          </div>
        </div>
      </div>
      <div class="card" data-tb-marker="TB_45" style="display:flex; flex-direction:column; gap:6px; min-height:240px;">
        <h3 style="margin-bottom:0;">Clients par SRRI</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartClientsCount" style="height:220px; max-height:220px;"></canvas>
        </div>
      </div>
      <div class="card" data-tb-marker="TB_46" style="display:flex; flex-direction:column; gap:6px; min-height:240px;">
        <h3 style="margin-bottom:0;">Montant par SRRI (Clients)</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartClientsAmount" style="height:220px; max-height:220px;"></canvas>
        </div>
      </div>
    </div>
    <div class="charts" data-tb-marker="TB_53" style="display:grid; grid-template-columns: minmax(260px, 320px) repeat(2, minmax(260px, 1fr)); gap:12px; max-width:1200px; margin:0 auto; align-items:stretch;">
      <div class="card" data-tb-marker="TB_47" style="display:flex; flex-direction:column; align-items:flex-start; text-align:left;">
        <div data-tb-marker="TB_48" style="display:flex; align-items:center; justify-content:flex-start; gap:8px; width:100%;">
          <h3 class="risk-card-title" style="margin:0;">Affaires</h3>
        </div>
        <div data-tb-marker="TB_49" style="margin-top:8px; width:100%;">
          <div class="risk-stat-row" data-tb-marker="TB_50" style="justify-content:flex-start;">
            <span class="risk-dot blue"></span>
            <a href="/dashboard/affaires?risk=below" target="_blank" rel="noopener noreferrer">
              <strong>{{ aff_risk_counts.below }}</strong> ‚Äî En dessous du risque
            </a>
          </div>
          <div class="risk-stat-row" data-tb-marker="TB_51" style="justify-content:flex-start;">
            <span class="risk-dot green"></span>
            <a href="/dashboard/affaires?risk=equal" target="_blank" rel="noopener noreferrer">
              <strong>{{ aff_risk_counts.equal }}</strong> ‚Äî Dans le risque
            </a>
          </div>
          <div class="risk-stat-row" data-tb-marker="TB_52" style="justify-content:flex-start;">
            <span class="risk-dot red"></span>
            <a href="/dashboard/affaires?risk=above" target="_blank" rel="noopener noreferrer">
              <strong>{{ aff_risk_counts.above }}</strong> ‚Äî Au dessus du risque
            </a>
          </div>
          <div class="risk-stat-row" style="justify-content:flex-start; margin-top:6px;">
            <span style="display:inline-flex; align-items:center; gap:6px;">
              <i class="fa-solid fa-coins" style="color:#dc2626;"></i>
              <strong>{{ aff_risk_amounts_fmt.above }}</strong> ‚Ç¨ ‚Äî Montant sous risque
            </span>
          </div>
          <div class="risk-stat-row" style="justify-content:flex-start; margin-top:4px;">
            <span style="display:inline-flex; align-items:center; gap:6px;">
              <i class="fa-solid fa-percent" style="color:#dc2626;"></i>
              <strong>{{ aff_risk_under_pct }}</strong> % ‚Äî Part sous risque
            </span>
          </div>
        </div>
      </div>
      <div class="card" data-tb-marker="TB_54" style="display:flex; flex-direction:column; gap:6px; min-height:240px;">
        <h3 style="margin-bottom:0;">Affaires par SRRI</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartAffairesCount" style="height:220px; max-height:220px;"></canvas>
        </div>
      </div>
      <div class="card" data-tb-marker="TB_55" style="display:flex; flex-direction:column; gap:6px; min-height:240px;">
        <h3 style="margin-bottom:0;">Montant par SRRI (Affaires)</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartAffairesAmount" style="height:220px; max-height:220px;"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>


<!-- Accord√©on ESG (global) -->
<div id="esgToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_62" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">ESG</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="esgSection" data-tb-marker="TB_63" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" data-tb-marker="TB_64" style="text-align:left;">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap;">
      <div>
        <h3 style="margin-top:0;">ESG</h3>
        <p class="muted" style="margin:4px 0 0 0;">Charg√© √† la demande pour ne pas ralentir le tableau de bord.</p>
      </div>
      <div style="display:flex; align-items:center; gap:8px;">
        <button id="esgLoadBtn" class="btn" style="height:34px; display:inline-flex; align-items:center; gap:6px;">
          <i class="fa-solid fa-leaf"></i> Charger l'ESG
        </button>
        <span id="esgStatus" class="muted" style="font-size:0.9rem;">(non charg√©)</span>
      </div>
    </div>
    <div id="esgContent" class="muted" style="margin-top:10px;">Clique sur "Charger l'ESG" pour afficher les indicateurs.</div>
  </div>
</div>

<!-- Accord√©on Groupes -->
<div id="groupsToggle" class="card collapsed accordion-toggle" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Groupes</h3>
  <span class="chevron">‚ñæ</span>
</div>
  <div id="groupsSection" class="client-hide backoffice-hide" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <style>
    #groupsSection .group-grid { display:flex; flex-wrap:wrap; gap:12px; }
    #groupsSection .group-card { flex:1 1 260px; border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; box-shadow:0 1px 2px rgba(15,23,42,0.08); display:flex; flex-direction:column; gap:8px; }
    #groupsSection .group-card h4 { margin:0; font-size:1rem; }
    #groupsSection .group-title { display:inline-block; padding:0; border-radius:8px; }
    #groupsSection .group-card.active .group-title { background: var(--primary); color: #fff; padding:6px 10px; }
    #groupsSection .group-meta { font-size:0.85rem; color:#475569; display:grid; grid-template-columns: 120px 1fr; row-gap:4px; column-gap:6px; }
    #groupsSection .group-meta span { font-weight:600; color:#1e293b; }
    #groupsSection .group-card .btn { align-self:flex-start; margin-top:auto; padding:6px 10px; font-size:0.9rem; min-height:32px; }
  </style>
  <div class="card" style="margin-bottom:12px;">
    <h3 style="margin:0 0 8px 0;">Groupes de personnes</h3>
    {% if dashboard_groups_personnes %}
    <div class="group-grid">
      {% for grp in dashboard_groups_personnes %}
      <div class="group-card">
        <h4 class="group-title">{{ grp.nom }}</h4>
        <div class="group-meta">
          <span>Membres</span><div>{{ grp.nb_membres }}</div>
          <span>Responsable</span><div>{{ grp.responsable }}</div>
          <span>Cr√©ation</span><div>{{ grp.date_creation }}</div>
          <span>Fin</span><div>{{ grp.date_fin }}</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:auto;">
          <a class="btn btn-primary" href="{{ grp.link }}">Voir</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="muted">Aucun groupe de personnes d√©fini.</div>
    {% endif %}
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Groupes d'affaires</h3>
    {% if dashboard_groups_affaires %}
    <div class="group-grid">
      {% for grp in dashboard_groups_affaires %}
      <div class="group-card">
        <h4 class="group-title">{{ grp.nom }}</h4>
        <div class="group-meta">
          <span>Membres</span><div>{{ grp.nb_membres }}</div>
          <span>Responsable</span><div>{{ grp.responsable }}</div>
          <span>Cr√©ation</span><div>{{ grp.date_creation }}</div>
          <span>Fin</span><div>{{ grp.date_fin }}</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:auto;">
          <a class="btn btn-primary" href="{{ grp.link }}">Voir</a>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="muted">Aucun groupe d'affaires d√©fini.</div>
    {% endif %}
  </div>
</div>

<!-- T√¢ches (d√©plac√© plus haut) -->

<!-- Accord√©on R√©mun√©rations -->
<div id="remToggle" class="card" data-tb-marker="TB_75" >
  <h3 style="margin:0; font-size:1.05rem;">R√©mun√©rations</h3>
</div>
<div id="remSection" data-tb-marker="TB_76" style="max-width:1100px; margin: 0 auto 1rem auto; display:block;">
  <!-- Sous-accord√©on: Frais de gestion -->
  <div id="remFraisToggle" class="card" data-tb-marker="TB_77" >
    <h3 style="margin:0; font-size:1.0rem;">Frais de gestion</h3>
  </div>
  <div id="remFraisSection" data-tb-marker="TB_78" style="display:block;">
    <div class="card" data-tb-marker="TB_79" style="text-align:left;">
      <h3 style="margin-top:0;">Commissions sur frais de gestion</h3>
      {% if not rem_contracts %}
        <p style="margin:0; color:#555;">Aucun contrat g√©n√©rique actif disponible. Veuillez en cr√©er un dans les param√®tres.</p>
      {% else %}
        <form id="remForm" method="get" action="/dashboard#remFraisToggle" data-tb-marker="TB_80" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
          {% if tb_markers_param %}
            <input type="hidden" name="markers" value="1" />
          {% endif %}
          <div style="display:flex; flex-direction:column;">
            <label for="rem_contract" style="font-size:0.85rem; color:#555;">Contrat g√©n√©rique</label>
            <select id="rem_contract" name="rem_contract" style="min-width:220px; padding:8px 12px; height:38px;">
              {% for contrat in rem_contracts %}
                <option value="{{ contrat.id }}" {% if contrat.id == rem_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_start" style="font-size:0.85rem; color:#555;">Date de d√©but</label>
            <input id="rem_start" name="rem_start" type="date" value="{{ rem_start_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
            <input id="rem_end" name="rem_end" type="date" value="{{ rem_end_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_limit" style="font-size:0.85rem; color:#555;">Nombre de lignes</label>
            <select id="rem_limit" name="rem_limit" style="padding:8px 12px; height:38px;">
              {% for opt in rem_limit_options %}
                <option value="{{ opt }}" {% if opt == rem_limit %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <input type="hidden" name="rem_page" value="1" />
          <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
        </form>

        {% if rem_error %}
          <div style="margin-top:12px; padding:10px 12px; background:#fdecea; color:#a94442; border-radius:6px;">{{ rem_error }}</div>
        {% else %}
          <div data-tb-marker="TB_81" style="margin-top:12px; font-size:0.9rem; color:#555;">
            <div>P√©riode effective (vendredi) :
              {% if rem_start_effective and rem_end_effective %}
                du {{ rem_start_effective.strftime('%d/%m/%Y') }} au {{ rem_end_effective.strftime('%d/%m/%Y') }}
              {% else %}
                non d√©finie
              {% endif %}
            </div>
            <div>Total commissions dues : <strong>{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} ‚Ç¨</strong></div>
          </div>

          <div data-tb-marker="TB_82" style="overflow-x:auto; margin-top:12px;">
            <table data-tb-marker="TB_83" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Contrats</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation totale</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Commission frais de gestion</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rem_rows %}
                  <tr>
                    <td style="padding:8px;">{{ row.date.strftime('%d/%m/%Y') if row.date else row.date or 'N/A' }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.contracts_count }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.total_valorisation or 0).replace(',', ' ') }} ‚Ç¨</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.commission or 0).replace(',', ' ') }} ‚Ç¨</td>
                </tr>
              {% endfor %}
              {% if not rem_rows %}
                <tr>
                  <td colspan="4" style="padding:8px; color:#666;">Aucune donn√©e disponible pour cette p√©riode.</td>
                </tr>
              {% endif %}
            </tbody>
            <tfoot>
              <tr>
                <th style="padding:8px; text-align:left;">Total p√©riode</th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} ‚Ç¨</th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div data-tb-marker="TB_84" style="margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; font-size:0.9rem; color:#555;">
          {% if rem_has_prev %}
            {% set rem_prev_link = rem_prev_url %}
            {% if tb_markers_param %}
              {% set rem_prev_link = rem_prev_url + ('&' if '?' in rem_prev_url else '?') + tb_markers_param %}
            {% endif %}
            <a href="{{ rem_prev_link }}#remToggle" class="btn btn-choice" title="Page pr√©c√©dente"><i class="fa-solid fa-arrow-left"></i></a>
          {% endif %}
          <span>Page {{ rem_page }} / {{ rem_total_pages }}</span>
          {% if rem_has_next %}
            {% set rem_next_link = rem_next_url %}
            {% if tb_markers_param %}
              {% set rem_next_link = rem_next_url + ('&' if '?' in rem_next_url else '?') + tb_markers_param %}
            {% endif %}
            <a href="{{ rem_next_link }}#remToggle" class="btn btn-choice" title="Page suivante"><i class="fa-solid fa-arrow-right"></i></a>
          {% endif %}
        </div>
        <div data-tb-marker="TB_95" style="margin-top:6px; font-size:0.85rem; color:#777;">
Semaines {{ rem_page_start }} √† {{ rem_page_end }} sur {{ rem_rows_count }}.
        </div>
      {% endif %}
    {% endif %}
  </div>

</div>

<!-- Bloc R√©trocession des supports (sans accord√©on) -->
<div id="retroToggle" class="card" data-tb-marker="TB_85" >
  <h3 style="margin:0; font-size:1.05rem;">R√©trocession des supports</h3>
</div>
<div id="retroSection" data-tb-marker="TB_86" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" data-tb-marker="TB_87" style="text-align:left;">
    <h3 style="margin-top:0;">R√©trocession des supports</h3>
    {% if retro_error %}
      <div style="margin:0; color:#a94442; background:#fdecea; padding:10px 12px; border-radius:6px;">{{ retro_error }}</div>
    {% elif not retro_contracts %}
      <p style="margin:0; color:#555;">Aucun contrat g√©n√©rique actif disponible. Veuillez en cr√©er un dans les param√®tres.</p>
    {% else %}
      <form id="retroForm" method="get" action="/dashboard#retroToggle" data-tb-marker="TB_88" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
        {% if tb_markers_param %}
          <input type="hidden" name="markers" value="1" />
        {% endif %}
        <input id="retroHiddenRemContract" type="hidden" name="rem_contract" value="{{ rem_selected_contract }}" />
        <input id="retroHiddenRemStart" type="hidden" name="rem_start" value="{{ rem_start_input }}" />
        <input id="retroHiddenRemEnd" type="hidden" name="rem_end" value="{{ rem_end_input }}" />
        <input type="hidden" name="rem_limit" value="{{ rem_limit }}" />
        <input type="hidden" name="rem_page" value="{{ rem_page }}" />
        <div style="display:flex; flex-direction:column;">
          <label for="ret_contract" style="font-size:0.85rem; color:#555;">Contrat g√©n√©rique</label>
          <select id="ret_contract" name="ret_contract" style="min-width:220px; padding:8px 12px; height:38px;">
            {% for contrat in retro_contracts %}
              <option value="{{ contrat.id }}" {% if contrat.id == retro_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_start" style="font-size:0.85rem; color:#555;">Date de d√©but</label>
          <input id="ret_start" name="ret_start" type="date" value="{{ retro_start_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
          <input id="ret_end" name="ret_end" type="date" value="{{ retro_end_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_sort" style="font-size:0.85rem; color:#555;">Tri</label>
          <select id="ret_sort" name="ret_sort" style="padding:8px 12px; height:38px;">
            <option value="date_desc" {% if retro_sort == 'date_desc' %}selected{% endif %}>Date d√©croissante</option>
            <option value="date_asc" {% if retro_sort == 'date_asc' %}selected{% endif %}>Date croissante</option>
            <option value="retrocession_desc" {% if retro_sort == 'retrocession_desc' %}selected{% endif %}>R√©trocession d√©croissante</option>
            <option value="retrocession_asc" {% if retro_sort == 'retrocession_asc' %}selected{% endif %}>R√©trocession croissante</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_week_limit" style="font-size:0.85rem; color:#555;">Lignes (semaines)</label>
          <select id="ret_week_limit" name="ret_week_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_week_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_week_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_support_limit" style="font-size:0.85rem; color:#555;">Lignes (supports)</label>
          <select id="ret_support_limit" name="ret_support_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_support_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_support_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_promoteur" style="font-size:0.85rem; color:#555;">Promoteur contient</label>
          <input id="ret_promoteur" name="ret_promoteur" type="text" value="{{ retro_promoteur }}" placeholder="(optionnel)" style="padding:6px 8px;" />
        </div>
        <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
      </form>

      <div data-tb-marker="TB_89" style="margin-top:12px; font-size:0.9rem; color:#555;">
        <div>P√©riode effective (vendredi) :
          {% if retro_start_effective and retro_end_effective %}
            du {{ retro_start_effective.strftime('%d/%m/%Y') }} au {{ retro_end_effective.strftime('%d/%m/%Y') }}
          {% else %}
            non d√©finie
          {% endif %}
        </div>
        <div>Total r√©trocessions (semaines s√©lectionn√©es) : <strong>{{ '{:,.2f}'.format(retro_total_week).replace(',', ' ') }}</strong></div>
      </div>

      <div data-tb-marker="TB_90" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:14px; margin-top:12px;">
        <div data-tb-marker="TB_91" style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">R√©trocession par semaines</h4>
          <table data-tb-marker="TB_92" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Nb contrats</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">R√©trocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_weeks %}
                <tr>
                  <td style="padding:8px;">{{ row.date_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.nb_contrats }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.valo_total_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_weeks %}
                <tr><td colspan="4" style="padding:8px; color:#666;">Aucune donn√©e pour cette p√©riode.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div data-tb-marker="TB_93" style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">R√©trocession par support financier</h4>
          <table data-tb-marker="TB_94" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">ISIN</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Support</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Promoteur</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">R√©trocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_supports %}
                <tr>
                  <td style="padding:8px;">{{ row.code_isin }}</td>
                  <td style="padding:8px;">{{ row.support_nom }}</td>
                  <td style="padding:8px;">{{ row.promoteur }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_supports %}
                <tr><td colspan="4" style="padding:8px; color:#666;">Aucun support trouv√© pour cette p√©riode.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <div style="margin-top:6px; font-size:0.85rem; color:#777;">Total r√©trocessions (supports list√©s) : {{ '{:,.2f}'.format(retro_total_support).replace(',', ' ') }}</div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
  // Chart.js texte/axes en bleu corporate
  try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
  function toChartData(items, labelKey, valueKey) {
    const labels = items.map(i => 'SRRI ' + (i[labelKey] ?? 'N/A'));
    const data = items.map(i => Number(i[valueKey] || 0));
    return { labels, data };
  }

  const cc = toChartData({{ srri_clients_count | tojson }}, 'srri', 'nb');
  const ac = toChartData({{ srri_affaires_count | tojson }}, 'srri', 'nb');
  const ca = toChartData({{ srri_clients_amount | tojson }}, 'srri', 'total');
  const aa = toChartData({{ srri_affaires_amount | tojson }}, 'srri', 'total');
  const cb_labels = [{% for b in clients_buckets %}'{{ b.label }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const cb_data = [{% for b in clients_buckets %}{{ b.nb }}{% if not loop.last %}, {% endif %}{% endfor %}];
  if (cb_labels && cb_labels.length){ cb_labels[cb_labels.length-1] = 'Sup. 5M'; }
  const ab_labels = [{% for b in affaires_buckets %}'{{ b.label }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const ab_data = [{% for b in affaires_buckets %}{{ b.nb }}{% if not loop.last %}, {% endif %}{% endfor %}];
  if (ab_labels && ab_labels.length){ ab_labels[ab_labels.length-1] = 'Sup. 5M'; }

  function makeBar(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' ‚Ç¨' : v; } } }
        }
      }
    });
  }

  // Variante plein conteneur (hauteur contr√¥l√©e par CSS, ex: 25vh)
  function makeBarFill(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' ‚Ç¨' : v; } } } }
      }
    });
  }

  // Build charts (non cliquables)
  makeBar('chartClientsCount', cc.labels, cc.data, false);
  makeBar('chartAffairesCount', ac.labels, ac.data, false);
  makeBar('chartClientsAmount', ca.labels, ca.data, true);
  makeBar('chartAffairesAmount', aa.labels, aa.data, true);
  // Buckets chart (first): height reduced above
  makeBarFill('chartClientsBuckets', cb_labels, cb_data, false);
  makeBarFill('chartContractsBuckets', ab_labels, ab_data, false);

  // ------- Conformit√©: lazy load -------
  (function(){
    let confLoaded = false;
    const btn = document.getElementById('conformiteLoadBtn');
    const statusEl = document.getElementById('conformiteStatus');
    const setStatus = (txt)=> { if (statusEl) statusEl.textContent = txt; };
    const setText = (id, val)=> { const el=document.getElementById(id); if (el) el.textContent = (val ?? '‚Äî'); };
    const setPctBars = (validId, obsId, obsPct)=>{
      const validBar = document.getElementById(validId);
      const obsBar = document.getElementById(obsId);
      const v = Math.max(0, Math.min(100, 100 - (Number(obsPct)||0)));
      const o = Math.max(0, Math.min(100, Number(obsPct)||0));
      if (validBar) validBar.style.width = v + '%';
      if (obsBar) obsBar.style.width = o + '%';
    };

    function renderReclam(data){
      const container = document.getElementById('reclamStatusList');
      if (!container) return;
      const stats = data.reclam_stats || {};
      const list = stats.by_status || [];
      if (!list.length){
        container.textContent = 'Aucun statut renseign√©';
        return;
      }
      container.innerHTML = list.map(item=>{
        const label = item.label || 'statut non renseign√©';
        return `<div>${label} : ${item.count}</div>`;
      }).join('');
    }

    async function loadConformite(){
      if (confLoaded) return;
      setStatus('Chargement‚Ä¶');
      try{
        const res = await fetch('/dashboard/conformite/summary', { credentials:'same-origin' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        setText('derTotal', data.docs_der_total);
        setText('derTotalPct', (data.docs_der_total_pct||0).toFixed(1));
        setText('derObs', data.docs_der_obsolete);
        setText('derObsPct', (data.docs_der_obsolete_pct||0).toFixed(1));
        setPctBars('derValidBar', 'derObsBar', data.docs_der_obsolete_pct);

        setText('ccTotal', data.docs_cc_total);
        setText('ccTotalPct', (data.docs_cc_total_pct||0).toFixed(1));
        setText('ccObs', data.docs_cc_obsolete);
        setText('ccObsPct', (data.docs_cc_obsolete_pct||0).toFixed(1));
        setPctBars('ccValidBar', 'ccObsBar', data.docs_cc_obsolete_pct);

        setText('esgTotal', data.docs_esg_total);
        setText('esgTotalPct', (data.docs_esg_total_pct||0).toFixed(1));
        setText('esgObs', data.docs_esg_obsolete);
        setText('esgObsPct', (data.docs_esg_obsolete_pct||0).toFixed(1));
        setPctBars('esgValidBar', 'esgObsBar', data.docs_esg_obsolete_pct);

        setText('lmTotal', data.docs_lm_total);
        setText('lmTotalPct', (data.docs_lm_total_pct||0).toFixed(1));
        setText('lmObs', data.docs_lm_obsolete);
        setText('lmObsPct', (data.docs_lm_obsolete_pct||0).toFixed(1));
        setPctBars('lmValidBar', 'lmObsBar', data.docs_lm_obsolete_pct);

        setText('laTotal', data.docs_la_total);
        setText('laTotalPct', (data.docs_la_total_pct||0).toFixed(1));
        setText('laObs', data.docs_la_obsolete);
        setText('laObsPct', (data.docs_la_obsolete_pct||0).toFixed(1));
        setPctBars('laValidBar', 'laObsBar', data.docs_la_obsolete_pct);

        setText('reclamTotal', (data.reclam_stats && data.reclam_stats.total) || 0);
        renderReclam(data);
        setStatus('Charg√©');
        confLoaded = true;
      } catch(err){
        console.error('Conformit√© load error', err);
        setStatus('Erreur de chargement');
      }
    }
    if (btn) btn.addEventListener('click', loadConformite);
    window.__loadConformiteSection = function(){ if (!confLoaded) loadConformite(); };
  })();

  // ------- ESG: lazy load -------
  (function(){
    let esgLoaded = false;
    const btn = document.getElementById('esgLoadBtn');
    const statusEl = document.getElementById('esgStatus');
    const contentEl = document.getElementById('esgContent');
    const setStatus = (txt)=> { if (statusEl) statusEl.textContent = txt; };

    function renderESG(data){
      if (!contentEl) return;
      const allocs = data.alloc_names || [];
      const fields = data.esg_fields || [];
      const dates = data.dates || [];
      const fieldsHtml = fields.map(it => {
        const col = it.col || it;
        const label = it.label || col;
        return `<button type="button" class="btn btn-choice esg-field-global" data-field="${col}" title="${label}">${label}</button>`;
      }).join('') || '<div class="muted">Aucun champ ESG d√©tect√©.</div>';
      const allocOptions = ['<option value="">‚Äî choisir ‚Äî</option>'].concat(allocs.map(nm => `<option value="${nm}">${nm}</option>`)).join('');
      const dateOptions = dates.length ? dates.map(d => `<option value="${d}">${d}</option>`).join('') : '';
      contentEl.innerHTML = `
        <div data-tb-marker="TB_65" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px 0;">
          <div data-tb-marker="TB_66">
            <label class="muted" style="font-size:0.85rem;">Allocation de r√©f√©rence</label><br>
            <select id="esgAllocSelectGlobal" style="min-width:220px; max-width:280px; width:auto;">${allocOptions}</select>
          </div>
          ${dateOptions ? `
          <div data-tb-marker="TB_67" >
            <label class="muted" style="font-size:0.85rem;">Date</label><br>
            <select id="esgAllocDateGlobal" style="width: 14ch; min-width: 14ch;">${dateOptions}</select>
          </div>` : ''}
          <div data-tb-marker="TB_68" style="flex:1 1 auto; min-width:260px;">
            <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
            <div id="esgFieldsGlobal" data-tb-marker="TB_69" style="display:flex; gap:6px; flex-wrap:wrap;">${fieldsHtml}</div>
          </div>
        </div>
        <div id="esgChartGlobal" data-tb-marker="TB_70" style="height:320px; width:100%;"></div>
        <div class="muted" style="margin-top:6px; font-size:12px;">Indice normalis√© √† 100. Portefeuille = valeur relative (Portefeuille / Indice √ó 100).</div>
        <details id="esgSqlGlobalDetails" data-tb-marker="TB_71" style="margin-top:8px;">
          <summary class="muted" style="cursor:pointer;">Voir les donn√©es brutes</summary>
          <div id="esgDebugPanelGlobal" class="muted" style="font-size:12px; display:none;"></div>
        </details>
      `;
      esgLoaded = true;
      setStatus('Charg√©');
      // Initialiser les contr√¥les ESG (clics, fetch et trac√©)
      initEsgControls();
    }

    async function loadESG(){
      if (esgLoaded) return;
      setStatus('Chargement‚Ä¶');
      if (contentEl) contentEl.textContent = 'Chargement ESG‚Ä¶';
      try{
        const res = await fetch('/dashboard/esg/fields', { credentials:'same-origin' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        renderESG(data);
      } catch(err){
        console.error('ESG load error', err);
        setStatus('Erreur');
        if (contentEl) contentEl.textContent = 'Impossible de charger les donn√©es ESG.';
      }
    }
    if (btn) btn.addEventListener('click', loadESG);
    window.__loadEsgSection = function(){ if (!esgLoaded) loadESG(); };

    // Inspir√© de l'ancien bloc ESG global, mais initialis√© apr√®s rendu lazy
    function initEsgControls(){
      const allocSel = document.getElementById('esgAllocSelectGlobal');
      const allocDateSel = document.getElementById('esgAllocDateGlobal');
      const fieldsWrap = document.getElementById('esgFieldsGlobal');
      if (!allocSel || !fieldsWrap) return;

      const keyFields = 'global_esg_fields';
      const keyAlloc = 'global_esg_alloc';
      const keyAllocDate = 'global_esg_alloc_date';
      function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field-global.btn-choice-active')).map(b=> b.getAttribute('data-field')); }
      fieldsWrap.addEventListener('click', function(e){
        const b=e.target.closest('.esg-field-global'); if(!b) return;
        const sel = selectedFields();
        if (b.classList.contains('btn-choice-active')){ b.classList.remove('btn-choice-active'); }
        else { if (sel.length >= 4) return; b.classList.add('btn-choice-active'); }
        try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
        drawESG();
      });

      // Restaurer s√©lection champs si existante
      try{
        const stored = JSON.parse(localStorage.getItem(keyFields) || '[]');
        if (stored && stored.length){
          fieldsWrap.querySelectorAll('.esg-field-global').forEach(btn=>{
            const f = btn.getAttribute('data-field');
            if (stored.includes(f)) btn.classList.add('btn-choice-active');
          });
        } else {
          const first = fieldsWrap.querySelector('.esg-field-global');
          const second = fieldsWrap.querySelectorAll('.esg-field-global')[1];
          if (first) first.classList.add('btn-choice-active');
          if (second) second.classList.add('btn-choice-active');
          try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_ee){}
        }
      }catch(_e){}

      // Restaurer allocation/date
      try{
        const savedAlloc = localStorage.getItem(keyAlloc) || '';
        if (savedAlloc && allocSel.querySelector(`option[value="${savedAlloc}"]`)) allocSel.value = savedAlloc;
      }catch(_e){}
      if (allocDateSel){
        try{
          const savedDate = localStorage.getItem(keyAllocDate) || '';
          if (savedDate && allocDateSel.querySelector(`option[value="${savedDate}"]`)) allocDateSel.value = savedDate;
        }catch(_e){}
      }
      if (!allocSel.value && allocSel.options.length > 1){
        allocSel.selectedIndex = 1;
      }

      function ensurePlotly(cb){ if (window.Plotly) { cb(); return; } var s=document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ cb(); }; document.head.appendChild(s); }
      function drawESG(){
        const fields = selectedFields();
        const alloc = allocSel.value || '';
        const allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
        if (!fields.length || !alloc) return;
        ensurePlotly(function(){
          const url = `/dashboard/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}&debug=1` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'');
          fetch(url).then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
            let rows = (data && data.results) || [];
            rows = rows.filter(r => r && (r.affaire != null || r.index != null || r.global != null || r.index_raw != null));
            const cats = rows.map(r=> r.field);
            const idx = rows.map(function(r){
              if (r.index != null) return Number(r.index);
              if (r.index_raw != null) return 100;
              return null;
            });
            const g = rows.map(function(r){
              if (r.affaire != null) return Number(r.affaire);
              if (r.global != null) return Number(r.global);
              const pr = (r.global_raw==null? null : Number(r.global_raw));
              const ir = (r.index_raw==null? null : Number(r.index_raw));
              if (pr==null || ir==null || ir===0) return null;
              return (pr/ir)*100.0;
            });
            const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6';
            const traces = [
              { x: idx, y: cats, type:'bar', orientation:'h', name:(alloc||'Indice'), marker:{ color:'#9ca3af' } },
              { x: g, y: cats, type:'bar', orientation:'h', name:'Portefeuille', marker:{ color: primary } }
            ];
            const layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
            const cfg = { displayModeBar: false, responsive: true };
            Plotly.react('esgChartGlobal', traces, layout, cfg);
            const dbgWrap = document.getElementById('esgDebugPanelGlobal');
            if (dbgWrap){
              const d = data && data.debug ? data.debug : null;
              if (d){
                const fieldsList = fields;
                const prow = d.portfolio_raw || {};
                const irow = d.index_raw || {};
                let html = '<div style=\"margin-top:6px;\"><strong>Valeurs brutes (par champ)</strong>';
                html += '<table style=\"border-collapse:collapse; margin-top:4px; font-family:monospace; font-size:12px;\">';
                html += '<tr><th style=\"text-align:left; padding-right:12px;\">Champ</th><th style=\"text-align:right; padding-right:12px;\">' + (alloc||'Indice') + '</th><th style=\"text-align:right;\">Portefeuille</th></tr>';
                fieldsList.forEach(function(f){
                  const iv = Object.prototype.hasOwnProperty.call(irow, f) ? irow[f] : null;
                  const pv = Object.prototype.hasOwnProperty.call(prow, f) ? prow[f] : null;
                  html += `<tr><td style=\"padding-right:12px;\">${f}</td><td style=\"text-align:right; padding-right:12px;\">${iv==null?'':iv}</td><td style=\"text-align:right;\">${pv==null?'':pv}</td></tr>`;
                });
                html += '</table></div>';
                dbgWrap.innerHTML = html;
                dbgWrap.style.display = 'block';
              } else {
                dbgWrap.innerHTML = '';
                dbgWrap.style.display = 'none';
              }
            }
          }).catch(function(err){ console.error('ESG fetch error', err); });
        });
      }
      if (allocSel){
        allocSel.addEventListener('change', function(){
          try{ localStorage.setItem(keyAlloc, allocSel.value || ''); }catch(_e){}
          drawESG();
        });
      }
      if (allocDateSel){
        allocDateSel.addEventListener('change', function(){
          try{ localStorage.setItem(keyAllocDate, allocDateSel.value || ''); }catch(_e){}
          drawESG();
        });
      }
      // Lancer un premier dessin si des champs sont pr√©-s√©lectionn√©s
      drawESG();
    }
  })();

  (function syncRemRetroForms(){
    const remContract = document.getElementById('rem_contract');
    const remStart = document.getElementById('rem_start');
    const remEnd = document.getElementById('rem_end');
    const retContract = document.getElementById('ret_contract');
    const retStart = document.getElementById('ret_start');
    const retEnd = document.getElementById('ret_end');
    const retroHiddenRemContract = document.getElementById('retroHiddenRemContract');
    const retroHiddenRemStart = document.getElementById('retroHiddenRemStart');
    const retroHiddenRemEnd = document.getElementById('retroHiddenRemEnd');
    if (!remContract || !retContract || !remStart || !remEnd || !retStart || !retEnd) {
      return;
    }
    let syncingFromRem = false;
    let syncingFromRetro = false;

    function copyRemToRetro(){
      if (syncingFromRetro) return;
      syncingFromRem = true;
      if (retContract) retContract.value = remContract.value;
      if (retStart) retStart.value = remStart.value;
      if (retEnd) retEnd.value = remEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = remContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = remStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = remEnd.value;
      syncingFromRem = false;
    }

    function copyRetroToRem(){
      if (syncingFromRem) return;
      syncingFromRetro = true;
      if (remContract) remContract.value = retContract.value;
      if (remStart) remStart.value = retStart.value;
      if (remEnd) remEnd.value = retEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = retContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = retStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = retEnd.value;
      syncingFromRetro = false;
    }

    copyRemToRetro();

    remContract.addEventListener('change', copyRemToRetro);
    remStart.addEventListener('change', copyRemToRetro);
    remEnd.addEventListener('change', copyRemToRetro);
    retContract.addEventListener('change', copyRetroToRem);
    retStart.addEventListener('change', copyRetroToRem);
    retEnd.addEventListener('change', copyRetroToRem);
  })();

  // Tabs principaux (remplacent les accord√©ons racine)
  (function(){
    let veilleLoaded = false;
    // Veille d√©plac√©e sur /dashboard/veille


    const groups = [
      { key:'veille', toggle:null, section:'' },
      { key:'risks', toggle:'risksToggle', section:'risksSection' },
      { key:'esg', toggle:'esgToggle', section:'esgSection' },
      { key:'groups', toggle:'groupsToggle', section:'groupsSection' },
      { key:'commissions', toggle:'remToggle', section:'remSection' },
    ];
    const $ = (id)=> document.getElementById(id);
    const tabs = Array.from(document.querySelectorAll('#dashTabs .dash-tab'));
    const getGroupByKey = (key)=> groups.find(g => g.key === key);
    const getGroupByTarget = (target)=> groups.find(g => g.section === target || g.toggle === target);

    // Masquer les toggles racine (les tabs prennent le relais)
    groups.forEach(g => {
      const t = $(g.toggle);
      if (t){ t.style.display = 'none'; }
    });

    function show(key, doScroll){
      const g = getGroupByKey(key);
      if (!g) return;
      const remFraisToggle = document.getElementById('remFraisToggle');
      const remFraisSection = document.getElementById('remFraisSection');
      const retroToggle = document.getElementById('retroToggle');
      const retroSection = document.getElementById('retroSection');
      groups.forEach(item => {
        const s = $(item.section);
        const t = $(item.toggle);
        if (s){ s.style.display = item.key === key ? '' : 'none'; }
        if (t){ t.classList.toggle('collapsed', item.key !== key); }
        if (item.extraSection){
          const extra = $(item.extraSection);
          if (extra){ extra.style.display = item.key === key ? '' : 'none'; }
        }
        if (item.extraToggle){
          const extraT = $(item.extraToggle);
          if (extraT){
            if (item.key === key){
              extraT.style.display = '';
              extraT.classList.remove('collapsed');
            } else {
              extraT.style.display = 'none';
            }
          }
        }
        // Cas sp√©cifique Commissions : ne jamais masquer le bloc "Commissions sur frais de gestion" quand l'onglet est actif
        if (item.key === 'commissions'){
          // Pas d'accord√©on : toujours visibles, jamais masqu√©s
          if (remFraisToggle) { remFraisToggle.style.display = 'none'; remFraisToggle.onclick = null; }
          if (retroToggle)    { retroToggle.style.display    = 'none'; retroToggle.onclick = null; }
          if (remFraisSection) remFraisSection.style.display = '';
          if (retroSection)    retroSection.style.display    = '';
        }

      });
      if (key === 'risks' && window.__loadConformiteSection) { window.__loadConformiteSection(); }
      if (key === 'esg' && window.__loadEsgSection) { window.__loadEsgSection(); }
      tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.key === key));
      // Colorer les boutons de groupes lorsque l'onglet Groupes est actif
      const groupButtons = document.querySelectorAll('#groupsSection .group-card .btn');
      const groupCards = document.querySelectorAll('#groupsSection .group-card');
      groupButtons.forEach(btn => {
        if (key === 'groups') { btn.classList.add('btn-primary'); }
        else { btn.classList.remove('btn-primary'); }
      });
      groupCards.forEach(card => {
        if (key === 'groups') { card.classList.add('active'); }
        else { card.classList.remove('active'); }
      });
      if (doScroll){
        // Reste en haut : on √©vite tout scroll automatique pour ne pas d√©caler la vue
        window.scrollTo({ top: 0, behavior: 'instant' });
      }
    }

    function detectInitialKey(){
      const hash = (window.location.hash || '').replace('#','');
      if (hash){
        const match = getGroupByTarget(hash) || getGroupByKey(hash);
        if (match) return match.key;
        if (hash === 'remFraisToggle' || hash === 'remFraisSection' || hash === 'retroToggle' || hash === 'retroSection') return 'commissions';
      }
      const params = new URLSearchParams(window.location.search || '');
      const retroParamKeys = ['ret_contract','ret_start','ret_end','ret_sort','ret_week_limit','ret_support_limit','ret_promoteur'];
      if (retroParamKeys.some(key => params.has(key))) return 'commissions';
      if (params.has('finance_date') || params.has('finance_rh') || params.has('finance_valo')){
        return 'tasks';
      }
      const remParamKeys = ['rem_contract','rem_start','rem_end','rem_limit','rem_page'];
      if (remParamKeys.some(key => params.has(key))){
        return 'commissions';
      }
      return 'veille';
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', (ev) => {
        ev.preventDefault();
        show(tab.dataset.key, true);
      });
    });

    // Initialisation
    const initialKey = detectInitialKey();
    show(initialKey, false);
  })();

  // Bloc R√©trocession (accord√©on ind√©pendant - d√©sactiv√© car g√©r√© par l'onglet Commissions)
  (function(){
    if (document.getElementById('dashTabs')) return; // g√©r√© par tabs
    const toggle = document.getElementById('retroToggle');
    const section = document.getElementById('retroSection');
    const remFraisToggle = document.getElementById('remFraisToggle');
    const remFraisSection = document.getElementById('remFraisSection');
    const retroHash = (window.location.hash || '').replace('#','');
    const retroParams = new URLSearchParams(window.location.search || '');
    const retroParamKeys = ['ret_contract','ret_start','ret_end','ret_sort','ret_week_limit','ret_support_limit','ret_promoteur'];
    const shouldOpenByParams = retroParamKeys.some(key => retroParams.has(key));
    const shouldOpenByHash = retroHash === 'retroToggle' || retroHash === 'retroSection';
    const shouldOpenInitially = shouldOpenByParams || shouldOpenByHash;
    if (!toggle || !section) return;
    function closeRemFrais(){
      if (!remFraisToggle || !remFraisSection) return;
      remFraisSection.style.display = 'none';
      remFraisToggle.classList.add('collapsed');
    }
    function apply(isOpen){
      section.style.display = isOpen ? '' : 'none';
      toggle.classList.toggle('collapsed', !isOpen);
      if (isOpen) closeRemFrais();
    }
    apply(shouldOpenInitially);
    if (shouldOpenInitially){
      try { toggle.scrollIntoView({ behavior:'auto', block:'start' }); } catch(e) {}
    }
    toggle.addEventListener('click', function(){
      const isOpen = section.style.display !== 'none';
      const next = !isOpen;
      apply(next);
      if (next){
        try { toggle.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
      }
    });
  })();

  // Sous-accord√©ons Risques / Analyse portefeuille (ind√©pendants, ouverts via data-open)
  (function(){
    const pairs = [
      ['complianceToggle','complianceSection'],
      ['rcpToggle','rcpSection'],
      ['clienteleToggle','clienteleSection'],
      ['srriToggle','srriSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => {
      const t = document.getElementById(tid);
      const s = document.getElementById(sid);
      return t && s ? { t, s } : null;
    }).filter(Boolean);

    function closeNode(o){
      o.s.style.display = 'none';
      o.t.classList.add('collapsed');
    }
    function closeAll(){
      nodes.forEach(closeNode);
    }
    function openNode(target){
      closeAll();
      target.s.style.display = '';
      target.t.classList.remove('collapsed');
    }

    closeAll();
    nodes.forEach(o => {
      o.t.addEventListener('click', function(ev){
        ev.stopPropagation();
        const isOpen = o.s.style.display !== 'none';
        if (isOpen){
          closeNode(o);
        } else {
          openNode(o);
          try { o.t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
        }
      });
    });
  })();

  // Sous-accord√©ons R√©mun√©rations (ind√©pendants)
  (function(){
    const pairs = [
      ['remFraisToggle','remFraisSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => ({
      t: document.getElementById(tid),
      s: document.getElementById(sid)
    })).filter(o => o.t && o.s);
    const retroToggle = document.getElementById('retroToggle');
    const retroSection = document.getElementById('retroSection');
    const remHash = (window.location.hash || '').replace('#','');
    const remParams = new URLSearchParams(window.location.search || '');
    const remParamKeys = ['rem_contract','rem_start','rem_end','rem_limit','rem_page'];
    const retroParamKeys = ['ret_contract','ret_start','ret_end','ret_sort','ret_week_limit','ret_support_limit','ret_promoteur'];
    const hasRetroParams = retroParamKeys.some(key => remParams.has(key));
    const shouldOpenByParams = !hasRetroParams && remParamKeys.some(key => remParams.has(key));
    function closeRetro(){
      if (!retroToggle || !retroSection) return;
      retroSection.style.display = 'none';
      retroToggle.classList.add('collapsed');
    }

    nodes.forEach(o => {
      function open(){
        o.s.style.display = '';
        o.t.classList.remove('collapsed');
        closeRetro();
      }
      function close(){
        o.s.style.display = 'none';
        o.t.classList.add('collapsed');
      }
      const targetToggleId = o.t ? o.t.id : '';
      const targetSectionId = o.s ? o.s.id : '';
      const shouldOpen = shouldOpenByParams || remHash === targetToggleId || remHash === targetSectionId;
      if (shouldOpen){ open(); }
      else { close(); }
      o.t.addEventListener('click', function(ev){
        ev.stopPropagation();
        const isOpen = o.s.style.display !== 'none';
        if (isOpen) { close(); }
        else {
          open();
          try{ o.t.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(e){}
        }
      });
    });
  })();

  

  // ESG Global logic (similar to Affaire/Client)
  (function(){
    var allocSel = document.getElementById('esgAllocSelectGlobal');
    var allocDateSel = document.getElementById('esgAllocDateGlobal');
    var fieldsWrap = document.getElementById('esgFieldsGlobal');
    var refreshBtn = document.getElementById('esgRefreshBtnGlobal');
    if (!allocSel || !fieldsWrap) return;

    var keyAlloc = 'global_esg_alloc';
    var keyFields = 'global_esg_fields';
    var keyAllocDate = 'global_esg_alloc_date';

    function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field-global.btn-choice-active')).map(b=> b.getAttribute('data-field')); }
    fieldsWrap.addEventListener('click', function(e){
      var b=e.target.closest('.esg-field-global'); if(!b) return;
      var sel = selectedFields();
      if (b.classList.contains('btn-choice-active')){ b.classList.remove('btn-choice-active'); }
      else { if (sel.length >= 4) return; b.classList.add('btn-choice-active'); }
      try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
      drawESG();
    });

    function ensurePlotly(cb){ if (window.Plotly) { cb(); return; } var s=document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ cb(); }; document.head.appendChild(s); }
    function drawESG(){
      var fields = selectedFields();
      var alloc = allocSel.value || '';
      var allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
      if (!fields.length || !alloc) return;
      ensurePlotly(function(){
        var url = `/dashboard/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}&debug=1` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'');
        fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          var rows = (data && data.results) || [];
          // Keep only rows with at least one value
          rows = rows.filter(r => r && (r.global != null || r.index != null));
          var cats = rows.map(r=> r.field);
          // Normalize: index baseline 100; portfolio = (global_raw / index_raw) * 100
          var idx = rows.map(function(r){
            if (r.index != null) return Number(r.index);
            if (r.index_raw != null) return 100;
            return null;
          });
          var g = rows.map(function(r){
            if (r.global != null) return Number(r.global);
            var pr = (r.global_raw==null? null : Number(r.global_raw));
            var ir = (r.index_raw==null? null : Number(r.index_raw));
            if (pr==null || ir==null || ir===0) return null;
            return (pr/ir)*100.0;
          });
          // If portfolio values are all null, nothing to plot
          if (!g.length || g.every(v => v == null)) { g = cats.map(() => null); }
          var traces = [
            { x: idx, y: cats, type:'bar', orientation:'h', name:(alloc||'Indice'), marker:{ color:'#9ca3af' } },
            { x: g, y: cats, type:'bar', orientation:'h', name:'Portefeuille', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
          ];
          var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
          var cfg = { displayModeBar: false, responsive: true };
          Plotly.react('esgChartGlobal', traces, layout, cfg);
          // Debug panel (only raw values table)
          try {
            var dbgWrap = document.getElementById('esgDebugPanelGlobal');
            if (dbgWrap){
              var d = data && data.debug ? data.debug : null;
              if (d){
                function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                var html = '';
                try {
                  var prow = d.portfolio_raw || {};
                  var irow = d.index_raw || {};
                  if (fields && fields.length){
                    html += '<div style="margin-top:6px;"><strong>Valeurs brutes (par champ)</strong>';
                    html += '<table style="border-collapse:collapse; margin-top:4px; font-family:monospace; font-size:12px;">';
                    html += '<tr><th style="text-align:left; padding-right:12px;">Champ</th><th style="text-align:right; padding-right:12px;">' + esc(alloc||'Indice') + '</th><th style="text-align:right;">Portefeuille</th></tr>';
                    fields.forEach(function(f){
                      var iv = irow && Object.prototype.hasOwnProperty.call(irow, f) ? irow[f] : null;
                      var pv = prow && Object.prototype.hasOwnProperty.call(prow, f) ? prow[f] : null;
                      function fmt(v){ if(v==null||v===undefined||Number.isNaN(Number(v))) return '-'; try{ var n=Number(v); return (Math.abs(n)>=1000? n.toFixed(2): n.toFixed(4)); }catch(_e){ return esc(String(v)); } }
                      html += '<tr><td style="padding-right:12px;">' + esc(f) + '</td>'+
                              '<td style="text-align:right; padding-right:12px;">' + fmt(iv) + '</td>'+
                              '<td style="text-align:right;">' + fmt(pv) + '</td></tr>';
                    });
                    html += '</table></div>';
                  }
                } catch(_er) {}
                dbgWrap.innerHTML = html;
                dbgWrap.style.display='';
                try { document.getElementById('esgSqlGlobalDetails').open = true; } catch(_e) {}
              }
            }
          } catch(_e) {}
        }).catch(function(err){ try{ console.error('Global ESG fetch error', err); }catch(_){} });
      });
    }

    function loadAllocDates(preferred){
      if (!allocSel || !allocSel.value) { if (allocDateSel) allocDateSel.innerHTML=''; return; }
      fetch(`/dashboard/allocations/dates?name=${encodeURIComponent(allocSel.value)}`)
        .then(r=>r.json()).then(function(data){
          if (!allocDateSel) return;
          allocDateSel.innerHTML = '';
          var ds = (data && data.dates) || [];
          ds.forEach(function(d){ var o=document.createElement('option'); o.value=d; o.textContent=d; allocDateSel.appendChild(o); });
          var selected = false;
          if (preferred){ for (var i=0;i<allocDateSel.options.length;i++){ if (allocDateSel.options[i].value===preferred){ allocDateSel.selectedIndex=i; selected=true; break; } } }
          if (!selected && allocDateSel.options.length>0) allocDateSel.selectedIndex = 0;
          drawESG();
        }).catch(function(e){ try{ console.warn('alloc dates (global)', e);}catch(_){} });
    }

    allocSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAlloc, allocSel.value||''); }catch(_e){}; try{ localStorage.removeItem(keyAllocDate); }catch(_e){}; loadAllocDates(); });
    if (allocDateSel) allocDateSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAllocDate, allocDateSel.value||''); }catch(_e){}; drawESG(); });
    if (refreshBtn) refreshBtn.addEventListener('click', drawESG);

    // Init
    (function init(){
      try{
        var savedAlloc = localStorage.getItem(keyAlloc) || '';
        if (savedAlloc){ var found=false; for (var i=0;i<allocSel.options.length;i++){ if (allocSel.options[i].value===savedAlloc){ allocSel.selectedIndex=i; found=true; break; } } if(!found) savedAlloc=''; }
        if (!savedAlloc){ for (var j=0;j<allocSel.options.length;j++){ if (allocSel.options[j].value){ allocSel.selectedIndex=j; savedAlloc=allocSel.options[j].value; break; } } if (savedAlloc){ try{ localStorage.setItem(keyAlloc, savedAlloc);}catch(_e){} } }
      }catch(_e){}
      try{
        var raw = localStorage.getItem(keyFields); var saved=[]; if (raw){ try{ saved=JSON.parse(raw)||[]; }catch(_ee){ saved=[]; } }
        var buttons = Array.from(fieldsWrap.querySelectorAll('.esg-field-global'));
        buttons.forEach(b=> b.classList.remove('btn-choice-active'));
        if (saved.length){ buttons.forEach(b=> { var v=b.getAttribute('data-field'); if (saved.indexOf(v)>=0) b.classList.add('btn-choice-active'); }); }
        else { buttons.slice(0,3).forEach(b=> b.classList.add('btn-choice-active')); try{ localStorage.setItem(keyFields, JSON.stringify(buttons.slice(0,3).map(b=> b.getAttribute('data-field')))); }catch(_e){} }
      }catch(_e){}
      var preferDate = ''; try{ preferDate = localStorage.getItem(keyAllocDate) || ''; }catch(_e){}
      if (allocSel && allocSel.value){ loadAllocDates(preferDate); } else { drawESG(); }
    })();
  })();
</script>

<script>
  // Toggles horizontaux Risques
  (function(){
    var buttons = document.querySelectorAll('.risk-toggle-row .risk-toggle');
    var sections = ['complianceSection','rcpSection','srriSection','clienteleSection','contractsSection'];
    function openSection(id){
      sections.forEach(function(sec){
        var el = document.getElementById(sec);
        if (el) el.style.display = (sec === id) ? '' : 'none';
      });
      buttons.forEach(function(btn){
        var target = btn.getAttribute('data-target');
        if (target === id) { btn.classList.add('active'); }
        else { btn.classList.remove('active'); }
      });
    }
    openSection('complianceSection');
    buttons.forEach(function(btn){
      btn.addEventListener('click', function(){ openSection(btn.getAttribute('data-target')); });
    });
  })();

  // Forcer l'affichage des deux blocs commissions au submit
  const remForm = document.getElementById('remForm');
  const retroForm = document.getElementById('retroForm');
  function showCommBlocks(){
    const remFraisSection = document.getElementById('remFraisSection');
    const retroSection = document.getElementById('retroSection');
    if (remFraisSection) remFraisSection.style.display = '';
    if (retroSection) retroSection.style.display = '';
  }
  if (remForm){ remForm.addEventListener('submit', showCommBlocks); }
  if (retroForm){ retroForm.addEventListener('submit', showCommBlocks); }
</script>
{% endblock %}
