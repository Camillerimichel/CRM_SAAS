{% extends "base.html" %}

{% block title %}Tableau de bord{% endblock %}
{% block header_title %}<i class="fa-solid fa-house" style="margin-right:8px;"></i>Tableau de bord{% endblock %}

{% block content %}


{% set tb_markers_param = tb_markers_param or '' %}
{% set tb_markers_suffix = ('&' + tb_markers_param) if tb_markers_param else '' %}
<div class="tb-page{% if tb_markers_visible %} tb-markers-enabled{% endif %}" data-tb-marker="TB_01">
<!-- KPIs -->
<style>
  .dashboard-kpi-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.6rem;
    flex-wrap: wrap;
  }
  .dashboard-kpi-pill {
    background: #1f4eb8;
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 0.65rem 1.4rem;
    font-size: 0.95rem;
    font-weight: 600;
    box-shadow: 0 6px 14px rgba(31, 78, 184, 0.25);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .dashboard-kpi-pill span.value {
    font-size: 1.05rem;
    font-weight: 700;
  }
  .dashboard-kpi-pill:disabled {
    opacity: 1;
    cursor: default;
  }
  .dashboard-kpi-pill span {
    display: block;
    line-height: 1.2;
  }
</style>
<style>
  .accordion-toggle {
    transition: background .2s ease, color .2s ease, border .2s ease;
    border: 1px solid var(--border);
    background: #fff;
    color: inherit;
  }
  .accordion-toggle .chevron {
    transition: transform .2s ease, color .2s ease;
    color: #1f4eb8;
  }
  .accordion-toggle.collapsed .chevron {
    transform: rotate(-90deg);
  }
  .accordion-toggle:not(.collapsed) {
    background: #1f4eb8;
    color: #fff;
    border-color: #1f4eb8;
  }
  .accordion-toggle:not(.collapsed) .chevron {
    color: #fff;
  }
  .accordion-toggle:not(.collapsed) h3,
  .accordion-toggle:not(.collapsed) span,
  .accordion-toggle:not(.collapsed) i {
    color: #fff;
  }
  .risk-stat-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 4px 0;
    font-size: 0.9rem;
  }
  .risk-stat-row a {
    color: inherit;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .risk-dot {
    display: inline-block;
    width: 11px;
    height: 11px;
    border-radius: 50%;
  }
  .risk-dot.red { background: #ef4444; }
  .risk-dot.green { background: #16a34a; }
  .risk-dot.blue { background: #3b82f6; }
</style>
<div class="dashboard-kpi-bar" data-tb-marker="TB_05">
  <button class="dashboard-kpi-pill" type="button" disabled data-tb-marker="TB_06">
    <span class="label">Nombre de placements financiers</span>
    <span class="value">{{ total_affaires }}</span>
  </button>
  <button class="dashboard-kpi-pill" type="button" disabled data-tb-marker="TB_07">
    <span class="label">Valorisation totale</span>
    <span class="value">{{ '{:,.0f}'.format(total_valo or 0).replace(',', ' ') }} ‚Ç¨</span>
  </button>
  <button class="dashboard-kpi-pill" type="button" disabled data-tb-marker="TB_08">
    <span class="label">Nombre de clients</span>
    <span class="value">{{ total_clients }}</span>
  </button>
</div>

  <!-- Accord√©on T√¢ches en cours (remont√© avant Risques) -->
  <div id="tasksToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_09" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">T√¢ches en cours</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="tasksSection" data-tb-marker="TB_10" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div data-tb-marker="TB_11" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
    <div class="muted">P√©riode:</div>
    {% set r = tasks_range or 14 %}
    {% for n in [7,14,30] %}
      {% if n == r %}
        <a class="btn btn-choice btn-choice-active" href="?tasks_range={{ n }}{{ tb_markers_suffix }}#tasksToggle">{{ n }} j</a>
      {% else %}
        <a class="btn btn-choice" href="?tasks_range={{ n }}{{ tb_markers_suffix }}#tasksToggle">{{ n }} j</a>
      {% endif %}
    {% endfor %}
  </div>
  <div class="kpis" data-tb-marker="TB_12" style="grid-template-columns: repeat(4, 1fr);">
    <div class="kpi-card" data-tb-marker="TB_13">
      <div>T√¢ches totales</div>
      <div class="kpi-value">{{ tasks_total }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_14">
      <div>Ouvertes</div>
      <div class="kpi-value">{{ tasks_open }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_15">
      <div>Cl√¥tur√©es</div>
      <div class="kpi-value">{{ (tasks_total - tasks_open) if tasks_total is not none else 0 }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_16">
      <div>Aujourd'hui</div>
      <div class="kpi-value">{% set today = tasks_days|last %}{{ today.nb if today else 0 }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_17" style="grid-column: 1 / -1; min-height:140px; display:flex; align-items:center; justify-content:center;">
      {% set total_tasks_days = tasks_days | map(attribute='nb') | sum %}
      {% if total_tasks_days and total_tasks_days > 0 %}
        <canvas id="chartTasksDays" height="120"></canvas>
      {% else %}
        <div class="muted">Aucune t√¢che sur la p√©riode s√©lectionn√©e</div>
      {% endif %}
    </div>
  </div>
  <div class="card" data-tb-marker="TB_18" style="margin-top:8px;">
    <div data-tb-marker="TB_19" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
      <div class="muted">Filtre par responsable commercial:</div>
      <select id="tasksRhSelect" style="width:160px;">
        <option value="">Tous</option>
      </select>
    </div>
    <div data-tb-marker="TB_20" style="min-height:180px; display:flex; align-items:center; justify-content:center;">
      <canvas id="chartTasksType" height="120"></canvas>
    </div>
  </div>
  </div>

  <!-- Accord√©on Risques -->
  <div id="risksToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_21" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">Conformit√© et suivi du risque</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="risksSection" data-tb-marker="TB_22" style="display:none;">
  <!-- Sous-accord√©on: Conformit√© r√©glementaire -->
  <div id="complianceToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_23" style="max-width:900px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Conformit√© r√©glementaire</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="complianceSection" data-tb-marker="TB_24" style="display:none;">
    <div class="card" data-tb-marker="TB_25" style="max-width:900px; margin: 0 auto 1rem auto; text-align:center;">
      <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
        <div class="card" style="width:360px; padding:18px; border:1px solid var(--primary); border-radius:10px; box-shadow:0 4px 12px rgba(15,23,42,0.08); text-align:center;">
          <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
            <i class="fa-solid fa-users" style="color:var(--primary);"></i>
            <h3 class="risk-card-title" style="margin:0;">D√©passement de risque clients</h3>
          </div>
          <div style="margin-top:8px;">
            <div class="risk-stat-row">
              <span class="risk-dot red"></span>
              <span><strong>{{ cli_risk_counts.above }}</strong> ‚Äî Au‚Äëdessus du risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot green"></span>
              <span><strong>{{ cli_risk_counts.equal }}</strong> ‚Äî Dans le risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot blue"></span>
              <span><strong>{{ cli_risk_counts.below }}</strong> ‚Äî En dessous du risque</span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:6px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-coins" style="color:var(--primary);"></i>
                <strong>{{ cli_risk_amounts_fmt.above }}</strong> ‚Ç¨ ‚Äî Montant sous risque
              </span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:4px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-percent" style="color:var(--primary);"></i>
                <strong>{{ cli_risk_under_pct }}</strong> % ‚Äî Part sous risque
              </span>
            </div>
          </div>
        </div>
        <div class="card" style="width:360px; padding:18px; border:1px solid #f87171; border-radius:10px; box-shadow:0 4px 12px rgba(220,38,38,0.15); text-align:center;">
          <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:8px;">
            <i class="fa-solid fa-briefcase" style="color:#dc2626;"></i>
            <h3 class="risk-card-title" style="margin:0;">D√©passement de risque contrats</h3>
          </div>
          <div style="margin-top:8px;">
            <div class="risk-stat-row">
              <span class="risk-dot blue"></span>
              <span><strong>{{ aff_risk_counts.below }}</strong> ‚Äî En dessous du risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot green"></span>
              <span><strong>{{ aff_risk_counts.equal }}</strong> ‚Äî Dans le risque</span>
            </div>
            <div class="risk-stat-row">
              <span class="risk-dot red"></span>
              <span><strong>{{ aff_risk_counts.above }}</strong> ‚Äî Au dessus du risque</span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:6px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-coins" style="color:#dc2626;"></i>
                <strong>{{ aff_risk_amounts_fmt.above }}</strong> ‚Ç¨ ‚Äî Montant sous risque
              </span>
            </div>
            <div class="risk-stat-row" style="justify-content:center; margin-top:4px;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-percent" style="color:#dc2626;"></i>
                <strong>{{ aff_risk_under_pct }}</strong> % ‚Äî Part sous risque
              </span>
            </div>
          </div>
        </div>
      </div>
      <div data-tb-marker="TB_26" style="margin-top:12px; display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap:12px;">
        {% set der_obsolete_pct = (docs_der_obsolete_pct or 0)|float %}
        {% if der_obsolete_pct < 0 %}{% set der_obsolete_pct = 0.0 %}{% elif der_obsolete_pct > 100 %}{% set der_obsolete_pct = 100.0 %}{% endif %}
        {% set der_valid_pct = 100.0 - der_obsolete_pct %}
        <div data-tb-marker="TB_27" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">DER</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_der_total or 0 }} / {{ '%.1f'|format(docs_der_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_der_obsolete or 0 }} / {{ '%.1f'|format(docs_der_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="DER : {{ der_valid_pct|round(1) }} % valides, {{ der_obsolete_pct|round(1) }} % obsol√®tes">
            <div class="compliance-progress-valid" style="width: {{ der_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ der_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set cc_obsolete_pct = (docs_cc_obsolete_pct or 0)|float %}
        {% if cc_obsolete_pct < 0 %}{% set cc_obsolete_pct = 0.0 %}{% elif cc_obsolete_pct > 100 %}{% set cc_obsolete_pct = 100.0 %}{% endif %}
        {% set cc_valid_pct = 100.0 - cc_obsolete_pct %}
        <div data-tb-marker="TB_28" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Connaissance client</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_cc_total or 0 }} / {{ '%.1f'|format(docs_cc_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_cc_obsolete or 0 }} / {{ '%.1f'|format(docs_cc_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="Connaissance client : {{ cc_valid_pct|round(1) }} % valides, {{ cc_obsolete_pct|round(1) }} % obsol√®tes">
            <div class="compliance-progress-valid" style="width: {{ cc_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ cc_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set esg_obsolete_pct = (docs_esg_obsolete_pct or 0)|float %}
        {% if esg_obsolete_pct < 0 %}{% set esg_obsolete_pct = 0.0 %}{% elif esg_obsolete_pct > 100 %}{% set esg_obsolete_pct = 100.0 %}{% endif %}
        {% set esg_valid_pct = 100.0 - esg_obsolete_pct %}
        <div data-tb-marker="TB_29" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">ESG</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_esg_total or 0 }} / {{ '%.1f'|format(docs_esg_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_esg_obsolete or 0 }} / {{ '%.1f'|format(docs_esg_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="ESG : {{ esg_valid_pct|round(1) }} % valides, {{ esg_obsolete_pct|round(1) }} % obsol√®tes">
            <div class="compliance-progress-valid" style="width: {{ esg_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ esg_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set lm_obsolete_pct = (docs_lm_obsolete_pct or 0)|float %}
        {% if lm_obsolete_pct < 0 %}{% set lm_obsolete_pct = 0.0 %}{% elif lm_obsolete_pct > 100 %}{% set lm_obsolete_pct = 100.0 %}{% endif %}
        {% set lm_valid_pct = 100.0 - lm_obsolete_pct %}
        <div data-tb-marker="TB_30" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Lettres de mission</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_lm_total or 0 }} / {{ '%.1f'|format(docs_lm_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_lm_obsolete or 0 }} / {{ '%.1f'|format(docs_lm_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="Lettres de mission : {{ lm_valid_pct|round(1) }} % valides, {{ lm_obsolete_pct|round(1) }} % obsol√®tes">
            <div class="compliance-progress-valid" style="width: {{ lm_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ lm_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set la_obsolete_pct = (docs_la_obsolete_pct or 0)|float %}
        {% if la_obsolete_pct < 0 %}{% set la_obsolete_pct = 0.0 %}{% elif la_obsolete_pct > 100 %}{% set la_obsolete_pct = 100.0 %}{% endif %}
        {% set la_valid_pct = 100.0 - la_obsolete_pct %}
        <div data-tb-marker="TB_31" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Lettres d'ad√©quation</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_la_total or 0 }} / {{ '%.1f'|format(docs_la_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_la_obsolete or 0 }} / {{ '%.1f'|format(docs_la_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="Lettres d'ad√©quation : {{ la_valid_pct|round(1) }} % valides, {{ la_obsolete_pct|round(1) }} % obsol√®tes">
            <div class="compliance-progress-valid" style="width: {{ la_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ la_obsolete_pct }}%;"></div>
          </div>
        </div>
        <div data-tb-marker="TB_32" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
            <div style="font-weight:600; background:#f1f5f9; border-radius:8px; padding:6px; flex:1; text-align:center;">R√©clamations</div>
            <button type="button" onclick="openInfoModal('reclamPivot')" aria-label="Voir le d√©tail des r√©clamations" style="display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:50%; border:1px solid var(--primary); background:#fff; color:var(--primary); font-weight:600; cursor:pointer;">i</button>
          </div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ reclam_stats.total or 0 }}</div>
          {% if reclam_stats.by_status %}
            {% for item in reclam_stats.by_status %}
              <div class="muted" style="font-size:0.85rem;">
                {{ item.label or 'statut non renseign√©' }} : {{ item.count }}
              </div>
            {% endfor %}
          {% else %}
            <div class="muted" style="font-size:0.85rem;">Aucun statut renseign√©</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="info-modal-backdrop" id="infoModal-reclamPivot" aria-hidden="true">
    <div class="info-modal-dialog" style="max-height: 90vh; overflow-y:auto;">
      <button type="button" class="info-modal-close" onclick="closeInfoModal('reclamPivot')">√ó</button>
      <div class="info-modal-body" style="max-height: 75vh; overflow-y: auto;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <h3 style="margin:0;">R√©clamations par type et statut</h3>
          <a href="/dashboard/reclamations/export"
             style="display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:6px; border:1px solid var(--primary); background:var(--primary); color:#fff; font-size:0.85rem; text-decoration:none;"
             download>
            Export Excel
          </a>
        </div>
        {% if reclam_pivot.types and reclam_pivot.statuses %}
          <style>
            .reclam-pivot-table {
              width: 100%;
              border-collapse: separate;
              border-spacing: 0;
              font-size: 0.78rem;
              margin-top: 0.5rem;
            }
            .reclam-pivot-table thead {
              position: sticky;
              top: 0;
              z-index: 3;
            }
            .reclam-pivot-table th {
              border: 1px solid #e2e8f0;
              padding: 4px 6px;
              text-align: center;
              white-space: normal;
              line-height: 1.2;
            }
            .reclam-pivot-table td {
              border: 1px solid #e2e8f0;
              padding: 4px 6px;
              text-align: center;
              white-space: nowrap;
            }
            .reclam-pivot-table tbody td:first-child {
              text-align: left;
              background: #e2e8f0;
              font-weight: 600;
              position: sticky;
              left: 0;
              z-index: 1;
            }
            .reclam-pivot-table thead th {
              position: sticky;
              top: 0;
              background: var(--primary);
              color: #fff;
              z-index: 2;
              font-size: 0.78rem;
            }
            .reclam-pivot-table thead th:first-child {
              left: 0;
            }
          </style>
          <div style="overflow:auto; max-height:60vh; position: relative;">
            <table class="reclam-pivot-table">
              <thead>
                <tr>
                  <th>Type d'√©v√©nement</th>
                  {% for status in reclam_pivot.statuses %}
                    {% set status_lower = (status or '')|lower %}
                    {% if status_lower.startswith('annul') or status_lower.startswith('clotur') or status_lower.startswith('cl√¥tur') %}
                      {% set status_display = (status or '').replace(' ', '<br>') %}
                    {% else %}
                      {% set status_display = status %}
                    {% endif %}
                    <th>{{ status_display|safe }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for type in reclam_pivot.types %}
                  <tr>
                    <td>{{ type.label or 'Type non renseign√©' }}</td>
                    {% for status in reclam_pivot.statuses %}
                      {% set cell_value = type.counts.get(status, 0) %}
                      <td>
                        {% if cell_value %}
                          {{ cell_value }}
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted" style="margin:0;">Aucune donn√©e disponible.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Sous-accord√©on: R√©partition par client√®le -->
  <div id="rcpToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_33" style="max-width:900px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Requis r√©glementaires</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="rcpSection" data-tb-marker="TB_34" style="display:none; max-width:900px; margin: 0 auto 1rem auto;">
    <div class="card" style="max-width:900px; margin: 0 auto 1rem auto; text-align:center;">
      
      <style>
        .info-modal-backdrop {
          position: fixed;
          inset: 0;
          background: rgba(15,23,42,0.55);
          display: none;
          align-items: center;
          justify-content: center;
          padding: 1.25rem;
          z-index: 1200;
        }
        .info-modal-backdrop.active {
          display: flex;
        }
        .info-modal-dialog {
          background: #fff;
          border-radius: 10px;
          padding: 1rem 1.4rem;
          width: min(95vw, 1200px);
          max-width: 1200px;
          overflow-x: auto;
          box-shadow: 0 15px 30px rgba(15,23,42,0.2);
          position: relative;
          
        }
        .info-modal-close {
          position: absolute;
          top: 0.5rem;
          right: 0.5rem;
          border: none;
          background: none;
          font-size: 1.1rem;
          color: var(--muted, #64748b);
          cursor: pointer;
        }
        .info-modal-close:hover {
          color: var(--primary, #1f2b6c);
        }
        .info-modal-body {
          font-size: 0.95rem;
          color: #0f172a;
        }
        .orias-detail-row {
          margin-bottom: 0.45rem;
          font-size: 0.9rem;
          color: #0f172a;
          white-space: nowrap;
        }
        .orias-detail-row strong {
          display: inline-block;
          min-width: 180px;
          color: var(--primary-700, #1d4ed8);
        }
        .info-btn {
          border: none;
          background: none;
          color: var(--primary, #1f2b6c);
          cursor: pointer;
          font-size: 1rem;
        }
        .info-btn:hover {
          color: var(--primary-600, #2f47ad);
        }
        .compliance-progress {
          display: flex;
          align-items: stretch;
          height: 18px;
          border-radius: 999px;
          overflow: hidden;
          background: #e2e8f0;
          margin-top: 0.45rem;
        }
        .compliance-progress-valid,
        .compliance-progress-obsolete {
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.78rem;
          font-weight: 600;
          color: #0f172a;
          white-space: nowrap;
          transition: width 0.3s ease;
        }
        .compliance-progress-valid {
          background: linear-gradient(90deg, #34d399, #22c55e);
          color: #064e3b;
        }
        .compliance-progress-obsolete {
          background: linear-gradient(90deg, #fb7185, #f43f5e);
          color: #7f1d1d;
        }
        .doc-expired-flag {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: #dc2626;
          color: #fff;
          border-radius: 999px;
          padding: 0 0.4rem;
          font-size: 0.72rem;
          font-weight: 700;
          text-transform: uppercase;
          margin-right: 0.45rem;
        }
      </style>

      <div style="margin-top:12px; display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap:12px;">
        {% set info_ids = {
          'Inscription ORIAS': 'orias',
          'Adh√©sion association professionnelle': 'association',
          'Souscription RC Pro': 'rcpro',
          'Distribution des contrats': 'distribution',
          "Conditions d'exercice": 'conditions',
          'R√¥le du distributeur': 'role',
          'Blanchiment': 'blanchiment',
          'Gouvernance produit': 'gouvernance',
          'Conclusion des contrats': 'conclusion'
        } %}
        {% set info_records = {
          'orias': 1,
          'association': 2,
          'rcpro': 3,
          'distribution': 4,
          'conditions': 5,
          'role': 6,
          'blanchiment': 7,
          'gouvernance': 8,
          'conclusion': 9
        } %}
        {% for title in [
          'Inscription ORIAS',
          'Adh√©sion association professionnelle',
          'Souscription RC Pro',
          'Distribution des contrats',
          "Conditions d'exercice",
          'R√¥le du distributeur',
          'Blanchiment',
          'Gouvernance produit',
          'Conclusion des contrats'
        ] %}
      {% set tile_style = "background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);" %}
      {% if title == 'Souscription RC Pro' and rcpro_doc_count > 0 and not rcpro_doc_valid %}
        {% set tile_style = tile_style + " background:#fee2e2; border-color:#b91c1c;" %}
      {% endif %}
      <div style="{{ tile_style }}">
        <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px; display:flex; align-items:center; justify-content:center; gap:8px;">{{ title }}{% set info_id = info_ids.get(title) %}{% if info_id %} <button type='button' class='info-btn' onclick="openInfoModal('{{ info_id }}')" title='Informations'>‚ÑπÔ∏è</button>{% endif %}</div>
          {% if title == 'Inscription ORIAS' %}
            {% if orias_doc_valid %}
              <p style="margin:0; font-weight:600; color:#166534;">üü¢ Valide jusqu'au {{ orias_doc_expiry_display }}</p>
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Risque RC Pro</p>
            {% endif %}
            {% if orias_detail %}
              <div class="muted" style="margin-top:0.75rem; text-align:left; font-size:0.85rem; line-height:1.4;">
                {% if orias_detail.code_reglement %}
                  <div><strong>Code r√©glementaire :</strong> <span>{{ orias_detail.code_reglement }}</span></div>
                {% endif %}
                {% if orias_detail.articles %}
                  <div><strong>Articles :</strong> <span>{{ orias_detail.articles }}</span></div>
                {% endif %}
                {% if orias_detail.references_complementaires %}
                  <div><strong>R√©f√©rences compl√©mentaires :</strong> <span>{{ orias_detail.references_complementaires }}</span></div>
                {% endif %}
                {% for link_key in ['lien_1','lien_2','lien_3','lien_4','lien_5'] %}
                  {% set link_value = orias_detail.get(link_key) %}
                  {% if link_value %}
                    <div><strong>{{ link_key|replace('_', ' ')|title }} :</strong> <a href="{{ link_value }}" target="_blank" rel="noopener">{{ link_value }}</a></div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% elif title == 'Adh√©sion association professionnelle' %}
            {% if assoc_doc_valid %}
              <p style="margin:0; font-weight:600; color:#166534;">üü¢ Valide jusqu'au {{ assoc_doc_expiry_display }}</p>
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Risque association professionnelle</p>
            {% endif %}
          {% elif title == 'Souscription RC Pro' %}
            {% if rcpro_doc_count > 0 %}
              {% if rcpro_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ rcpro_doc_valid_count }} document{% if rcpro_doc_valid_count > 1 %}s{% endif %} valide{% if rcpro_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ rcpro_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ rcpro_doc_count }} document{% if rcpro_doc_count > 1 %}s{% endif %} ‚Äî Risque RC Pro</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque RC Pro</p>
            {% endif %}
            {% if rcpro_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ rcpro_doc_expired_count }} document{% if rcpro_doc_expired_count > 1 %}s{% endif %} expir√©{% if rcpro_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Conditions d\'exercice' %}
            {% if conditions_doc_count > 0 %}
              {% if conditions_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ conditions_doc_valid_count }} document{% if conditions_doc_valid_count > 1 %}s{% endif %} valide{% if conditions_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ conditions_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ conditions_doc_count }} document{% if conditions_doc_count > 1 %}s{% endif %} ‚Äî Risque conditions d'exercice</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque conditions d'exercice</p>
            {% endif %}
            {% if conditions_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ conditions_doc_expired_count }} document{% if conditions_doc_expired_count > 1 %}s{% endif %} expir√©{% if conditions_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'R√¥le du distributeur' %}
            {% if role_doc_count > 0 %}
              {% if role_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ role_doc_valid_count }} document{% if role_doc_valid_count > 1 %}s{% endif %} valide{% if role_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ role_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ role_doc_count }} document{% if role_doc_count > 1 %}s{% endif %} ‚Äî Risque r√¥le du distributeur</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque r√¥le du distributeur</p>
            {% endif %}
            {% if role_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ role_doc_expired_count }} document{% if role_doc_expired_count > 1 %}s{% endif %} expir√©{% if role_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Gouvernance produit' %}
            {% if gouvernance_doc_count > 0 %}
              {% if gouvernance_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ gouvernance_doc_valid_count }} document{% if gouvernance_doc_valid_count > 1 %}s{% endif %} valide{% if gouvernance_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ gouvernance_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ gouvernance_doc_count }} document{% if gouvernance_doc_count > 1 %}s{% endif %} ‚Äî Risque gouvernance produit</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque gouvernance produit</p>
            {% endif %}
            {% if gouvernance_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ gouvernance_doc_expired_count }} document{% if gouvernance_doc_expired_count > 1 %}s{% endif %} expir√©{% if gouvernance_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Conclusion des contrats' %}
            {% if conclusion_doc_count > 0 %}
              {% if conclusion_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ conclusion_doc_valid_count }} document{% if conclusion_doc_valid_count > 1 %}s{% endif %} valide{% if conclusion_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ conclusion_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ conclusion_doc_count }} document{% if conclusion_doc_count > 1 %}s{% endif %} ‚Äî Risque conclusion des contrats</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque conclusion des contrats</p>
            {% endif %}
            {% if conclusion_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ conclusion_doc_expired_count }} document{% if conclusion_doc_expired_count > 1 %}s{% endif %} expir√©{% if conclusion_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Blanchiment' %}
            {% if blanchiment_doc_count > 0 %}
              {% if blanchiment_doc_valid %}
                <p style="margin:0; font-weight:600; color:#166534;">üü¢ {{ blanchiment_doc_valid_count }} document{% if blanchiment_doc_valid_count > 1 %}s{% endif %} valide{% if blanchiment_doc_valid_count > 1 %}s{% endif %} (derni√®re √©ch√©ance {{ blanchiment_doc_expiry_display }})</p>
              {% else %}
                <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ {{ blanchiment_doc_count }} document{% if blanchiment_doc_count > 1 %}s{% endif %} ‚Äî Risque blanchiment</p>
              {% endif %}
            {% else %}
              <p style="margin:0; font-weight:600; color:#b91c1c;">üî¥ Aucun document ‚Äî Risque blanchiment</p>
            {% endif %}
            {% if blanchiment_doc_expired_count > 0 %}
              <div style="margin-top:6px;">
                <span class="btn btn-list btn-list-danger" style="cursor:default; font-weight:600;">
                  <span class="doc-expired-flag">Expir√©</span>
                  {{ blanchiment_doc_expired_count }} document{% if blanchiment_doc_expired_count > 1 %}s{% endif %} expir√©{% if blanchiment_doc_expired_count > 1 %}s{% endif %}
                </span>
              </div>
            {% endif %}
          {% elif title == 'Distribution des contrats' %}
            <div class="muted" style="font-size:0.85rem;">Obsolescence moyenne : {{ '%.1f'|format(distribution_avg_obsolete_pct or 0.0) }} %</div>
            <div class="muted" style="font-size:0.85rem;">Validit√© moyenne : {{ '%.1f'|format(distribution_avg_valid_pct or 0.0) }} %</div>
            <div class="compliance-progress" role="img" aria-label="Distribution des contrats : {{ distribution_avg_valid_pct|round(1) }} % valides, {{ distribution_avg_obsolete_pct|round(1) }} % obsol√®tes">
              <div class="compliance-progress-valid" style="width: {{ distribution_avg_valid_pct }}%;"></div>
              <div class="compliance-progress-obsolete" style="width: {{ distribution_avg_obsolete_pct }}%;"></div>
            </div>
          {% else %}
            <p class="muted" style="margin:0;">En d√©veloppement.</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  {% for title, slug in info_ids.items() %}
    <div class="info-modal-backdrop" id="infoModal-{{ slug }}" aria-hidden="true">
      <div class="info-modal-dialog">
        <button type="button" class="info-modal-close" onclick="closeInfoModal('{{ slug }}')">√ó</button>
        <div class="info-modal-body" data-info-slug="{{ slug }}">
          {% set record_id = info_records.get(slug) %}
          {% if record_id %}
            <div class="compliance-detail-content" data-loaded="0" data-record-id="{{ record_id }}">
              <p class="muted" style="margin:0;">Chargement‚Ä¶</p>
            </div>
          {% else %}
            <p>En cours de d√©veloppement.</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
  <script>
    function renderComplianceDetail(container, data){
      if(!container) return;
      container.innerHTML = '';
      var labelMap = {
        activite: 'Activit√©',
        code_reglement: 'Code r√©glementaire',
        articles: 'Articles',
        references_complementaires: 'R√©f√©rences compl√©mentaires'
      };
      var orderedKeys = ['activite', 'code_reglement', 'articles', 'references_complementaires'];
      var linkKeys = ['lien_1','lien_2','lien_3','lien_4','lien_5'];
      function appendRow(label, value, isLink){
        var row = document.createElement('div');
        row.className = 'orias-detail-row';
        var strong = document.createElement('strong');
        strong.textContent = label + ' :';
        row.appendChild(strong);
        if(isLink){
          var anchor = document.createElement('a');
          anchor.href = value;
          anchor.target = '_blank';
          anchor.rel = 'noopener';
          anchor.textContent = value;
          row.appendChild(document.createTextNode(' '));
          row.appendChild(anchor);
        } else {
          var span = document.createElement('span');
          span.textContent = value;
          row.appendChild(document.createTextNode(' '));
          row.appendChild(span);
        }
        container.appendChild(row);
      }
      if(!data || Object.keys(data).length === 0){
        var empty = document.createElement('p');
        empty.className = 'muted';
        empty.textContent = 'Aucune donn√©e disponible.';
        container.appendChild(empty);
        return;
      }
      var seen = {};
      orderedKeys.forEach(function(key){
        if(!Object.prototype.hasOwnProperty.call(data, key)) return;
        var value = data[key];
        if(value === null || value === undefined || value === '') return;
        appendRow(labelMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, function(c){ return c.toUpperCase(); }), value, linkKeys.indexOf(key) !== -1);
        seen[key] = true;
      });
      Object.keys(data).forEach(function(key){
        if(seen[key]) return;
        var value = data[key];
        if(value === null || value === undefined || value === '') return;
        var isLink = linkKeys.indexOf(key) !== -1;
        appendRow(labelMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, function(c){ return c.toUpperCase(); }), value, isLink);
      });
    }
    function fetchComplianceDetail(container){
      if(!container || container.getAttribute('data-loaded') === '1' || container.getAttribute('data-loading') === '1'){
        return;
      }
      var recordId = container.getAttribute('data-record-id');
      if(!recordId){
        container.innerHTML = '<p class="muted" style="margin:0;">Aucune donn√©e disponible.</p>';
        return;
      }
      container.setAttribute('data-loading', '1');
      container.innerHTML = '<p class="muted" style="margin:0;">Chargement‚Ä¶</p>';
      fetch('/dashboard/compliance_rc_pro/' + recordId)
        .then(function(resp){
          if(!resp.ok){
            throw new Error('fetch-failed');
          }
          return resp.json();
        })
        .then(function(payload){
          renderComplianceDetail(container, payload);
          container.setAttribute('data-loaded', '1');
        })
        .catch(function(){
          container.innerHTML = '<p class="muted" style="margin:0;">Erreur lors du chargement des donn√©es.</p>';
        })
        .finally(function(){
          container.removeAttribute('data-loading');
        });
    }
    function openInfoModal(id){
      var modal = document.getElementById('infoModal-' + id);
      if(!modal) return;
      var content = modal.querySelector('.compliance-detail-content');
      fetchComplianceDetail(content);
      modal.classList.add('active');
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeInfoModal(id){
      var modal = document.getElementById('infoModal-' + id);
      if(!modal) return;
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape'){
        document.querySelectorAll('.info-modal-backdrop.active').forEach(function(modal){
          closeInfoModal(modal.id.replace('infoModal-',''));
        });
      }
    });
    document.addEventListener('click', function(ev){
      var target = ev.target;
      if(target.classList && target.classList.contains('info-modal-backdrop')){
        closeInfoModal(target.id.replace('infoModal-',''));
      }
    });
  </script>




<div id="clienteleToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_35" style="max-width:900px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">R√©partition par client√®le</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="clienteleSection" data-tb-marker="TB_36" style="display:none;">
    <div class="card" data-tb-marker="TB_35" style="max-width: 900px; margin: 0 auto 1rem auto; height: calc(18vh + 50px); display:flex; flex-direction:column;">
      <h3>D√©coupage clients par d√©tention</h3>
      <canvas id="chartClientsBuckets" style="flex:1 1 auto; min-height:0;"></canvas>
  </div>
</div>

<!-- Sous-accord√©on: R√©partitions SRRI -->
  <div id="srriToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_37" style="max-width:900px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Suivi du risque</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="srriSection" data-tb-marker="TB_38" style="display:none;">
    <div class="card" data-tb-marker="TB_38" style="max-width:360px; margin: 0 auto 1rem auto; text-align:center;">
      <div data-tb-marker="TB_39" style="display:flex; align-items:center; justify-content:center; gap:8px;">
        <h3 class="risk-card-title">Clients</h3>
      </div>
      <div data-tb-marker="TB_40" style="margin-top:8px; text-align:center;">
        <div class="risk-stat-row" data-tb-marker="TB_41">
          <span class="risk-dot red"></span>
          <a href="/dashboard/clients?risk=above" target="_blank" rel="noopener noreferrer">
            <strong>{{ cli_risk_counts.above }}</strong> ‚Äî Au‚Äëdessus du risque
          </a>
        </div>
        <div class="risk-stat-row" data-tb-marker="TB_42">
          <span class="risk-dot green"></span>
          <a href="/dashboard/clients?risk=equal" target="_blank" rel="noopener noreferrer">
            <strong>{{ cli_risk_counts.equal }}</strong> ‚Äî Dans le risque
          </a>
        </div>
        <div class="risk-stat-row" data-tb-marker="TB_43">
          <span class="risk-dot blue"></span>
          <a href="/dashboard/clients?risk=below" target="_blank" rel="noopener noreferrer">
            <strong>{{ cli_risk_counts.below }}</strong> ‚Äî Sous le risque
          </a>
        </div>
      </div>
    </div>
    <div class="charts" data-tb-marker="TB_44" style="display:flex; flex-wrap:wrap; gap:12px; max-width:1100px; margin:0 auto;">
      <div class="card" data-tb-marker="TB_45" style="flex:1 1 300px; max-width:480px; display:flex; flex-direction:column; gap:6px;">
        <h3 style="margin-bottom:0;">Clients par SRRI</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartClientsCount" style="height:200px; max-height:200px;"></canvas>
        </div>
      </div>
      <div class="card" data-tb-marker="TB_46" style="flex:1 1 300px; max-width:480px; display:flex; flex-direction:column; gap:6px;">
        <h3 style="margin-bottom:0;">Montant par SRRI (Clients)</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartClientsAmount" style="height:200px; max-height:200px;"></canvas>
        </div>
      </div>
    </div>
    <div class="card" data-tb-marker="TB_47" style="max-width:360px; margin: 0 auto 1rem auto; text-align:center;">
      <div data-tb-marker="TB_48" style="display:flex; align-items:center; justify-content:center; gap:8px;">
        <h3 class="risk-card-title">Affaires</h3>
      </div>
      <div data-tb-marker="TB_49" style="margin-top:8px; text-align:center;">
        <div class="risk-stat-row" data-tb-marker="TB_50">
          <span class="risk-dot blue"></span>
          <a href="/dashboard/affaires?risk=below" target="_blank" rel="noopener noreferrer">
            <strong>{{ aff_risk_counts.below }}</strong> ‚Äî En dessous du risque
          </a>
        </div>
        <div class="risk-stat-row" data-tb-marker="TB_51">
          <span class="risk-dot green"></span>
          <a href="/dashboard/affaires?risk=equal" target="_blank" rel="noopener noreferrer">
            <strong>{{ aff_risk_counts.equal }}</strong> ‚Äî Dans le risque
          </a>
        </div>
        <div class="risk-stat-row" data-tb-marker="TB_52">
          <span class="risk-dot red"></span>
          <a href="/dashboard/affaires?risk=above" target="_blank" rel="noopener noreferrer">
            <strong>{{ aff_risk_counts.above }}</strong> ‚Äî Au dessus du risque
          </a>
        </div>
      </div>
    </div>
    <div class="charts" data-tb-marker="TB_53" style="display:flex; flex-wrap:wrap; gap:12px; max-width:1100px; margin:0 auto;">
      <div class="card" data-tb-marker="TB_54" style="flex:1 1 300px; max-width:480px; display:flex; flex-direction:column; gap:6px;">
        <h3 style="margin-bottom:0;">Affaires par SRRI</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartAffairesCount" style="height:200px; max-height:200px;"></canvas>
        </div>
      </div>
      <div class="card" data-tb-marker="TB_55" style="flex:1 1 300px; max-width:480px; display:flex; flex-direction:column; gap:6px;">
        <h3 style="margin-bottom:0;">Montant par SRRI (Affaires)</h3>
        <div style="flex:1 1 auto; min-height:0;">
          <canvas id="chartAffairesAmount" style="height:200px; max-height:200px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  </div>

<!-- Accord√©on Analyse portefeuille -->
<div id="analysisToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_56" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Analyse portefeuille</h3>
  <span class="chevron">‚ñæ</span>
 </div>
<div id="analysisSection" data-tb-marker="TB_57" style="display:none;">
  <div class="card" data-tb-marker="TB_58" style="max-width:1100px; margin: 0 auto 1rem auto; text-align:left;">
    <h3 style="margin-top:0;">Analyse financi√®re ‚Äî R√©partition des supports</h3>
    <form method="get" action="/dashboard#analysisToggle" data-tb-marker="TB_59" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
      {% if tb_markers_param %}
        <input type="hidden" name="markers" value="1" />
      {% endif %}
      <div>
        <label class="muted" style="font-size:0.85rem;">Date d'analyse</label><br>
        <input type="date" name="finance_date" value="{{ finance_date_input }}" style="height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;" />
      </div>
      <div>
        <label class="muted" style="font-size:0.85rem;">Responsable commercial</label><br>
        <select name="finance_rh" style="min-width:220px; height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;">
          <option value="">Tous</option>
          {% for rh in finance_rh_options %}
            <option value="{{ rh.id }}" {% if finance_rh_selected is not none and rh.id == finance_rh_selected %}selected{% endif %}>{{ rh.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="muted" style="font-size:0.85rem;">Valorisation</label><br>
        <input type="text" name="finance_valo" value="{{ finance_valo_input or '' }}" placeholder=">100k, 100k-500k" style="min-width:200px; height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;" />
      </div>
      <div>
        <button type="submit" class="btn-primary" style="height:36px;">Filtrer</button>
      </div>
      <div>
        <button type="button" class="btn" id="finance_export_btn" style="height:36px;">Exporter CSV</button>
      </div>
    </form>
    <div class="muted" style="margin-top:8px; font-size:0.85rem;">Date retenue : {{ finance_effective_date_display }}</div>
    <div style="margin-top:4px; font-weight:600;">Total valorisation : {{ finance_total_valo_str }} ‚Ç¨</div>
    {% if finance_supports %}
    <div data-tb-marker="TB_60" style="margin-top:12px; overflow-x:auto;">
      <table data-tb-marker="TB_61" style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <thead>
          <tr style="background:#f1f5f9; text-align:left;">
            <th style="padding:6px 10px;">Code ISIN</th>
            <th style="padding:6px 10px;">Support</th>
            <th style="padding:6px 10px;">Cat√©gorie principale</th>
            <th style="padding:6px 10px;">Cat√©gorie g√©o</th>
            <th style="padding:6px 10px;">SRRI</th>
            <th style="padding:6px 10px; text-align:right;">Valorisation</th>
          </tr>
        </thead>
        <tbody>
          {% for sup in finance_supports %}
          <tr{% if loop.index is even %} style="background:#f8fafc;"{% endif %}>
            <td style="padding:6px 10px;">
              {% if sup.code_isin %}
                <a href="#" class="finance-support-link" data-support-code="{{ sup.code_isin }}" data-support-name="{{ sup.nom or '' }}" data-clients='{{ sup.clients | tojson | safe }}'>{{ sup.code_isin }}</a>
              {% else %}
                {{ sup.code_isin or '‚Äî' }}
              {% endif %}
            </td>
            <td style="padding:6px 10px;">{{ sup.nom or '‚Äî' }}</td>
            <td style="padding:6px 10px;">{{ sup.cat_principale or '‚Äî' }}</td>
            <td style="padding:6px 10px;">{{ sup.cat_geo or '‚Äî' }}</td>
            <td style="padding:6px 10px;">{{ sup.srri if sup.srri is not none else '‚Äî' }}</td>
            <td style="padding:6px 10px; text-align:right;">{{ sup.total_valo_str }} ‚Ç¨</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="financeSupportModal" onclick="if(event.target===this) closeFinanceSupportModal()">
      <div class="modal-card">
        <div class="modal-header">
          <h3><i class="fa-solid fa-users-line" style="margin-right:8px;"></i><span id="financeSupportModalLabel">Clients par support</span></h3>
          <button class="modal-close" onclick="closeFinanceSupportModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="financeSupportGroupActions" style="display:none; margin-bottom:12px;">
            <div style="font-weight:600; margin-bottom:6px;">Ajouter ces clients √† un groupe</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
              <div>
                <label class="muted" style="font-size:0.85rem; display:block; margin-bottom:4px;">Groupe existant</label>
                <select id="financeSupportGroupSelect" style="min-width:240px; height:34px;"></select>
              </div>
              <div>
                <button type="button" class="btn btn-primary" id="financeSupportGroupAddBtn" style="height:34px;">
                  <i class="fa-solid fa-user-group" style="margin-right:6px; color:#fff;"></i>Ajouter la liste
                </button>
              </div>
            </div>
            <div id="financeSupportGroupStatus" class="muted" style="margin-top:4px;"></div>
          </div>
          <table id="financeSupportModalTable">
            <thead>
              <tr>
                <th>Client</th>
                <th>Contrat</th>
                <th style="text-align:right;">Valorisation</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    {% else %}
    <div class="muted" style="margin-top:12px;">Aucune donn√©e pour les crit√®res s√©lectionn√©s.</div>
    {% endif %}
  </div>
</div>

<!-- Accord√©on ESG (global) -->
<div id="esgToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_62" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">ESG</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="esgSection" data-tb-marker="TB_63" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" data-tb-marker="TB_64" style="text-align:left;">
    <h3 style="margin-top:0;">Comparaison ESG Portefeuille vs Indice - global</h3>
    <div data-tb-marker="TB_65" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px 0;">
      <div data-tb-marker="TB_66">
        <label class="muted" style="font-size:0.85rem;">Allocation de r√©f√©rence</label><br>
        <select id="esgAllocSelectGlobal" style="min-width:220px; max-width:280px; width:auto;">
          <option value="">‚Äî choisir ‚Äî</option>
          {% for nm in alloc_names %}<option value="{{ nm }}">{{ nm }}</option>{% endfor %}
        </select>
      </div>
      <div data-tb-marker="TB_67" style="display:none;">
        <label class="muted" style="font-size:0.85rem;">Date</label><br>
        <select id="esgAllocDateGlobal" style="width: 14ch; min-width: 14ch;"></select>
      </div>
      <div data-tb-marker="TB_68" style="flex:1 1 auto; min-width:260px;">
        <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
        <div id="esgFieldsGlobal" data-tb-marker="TB_69" style="display:flex; gap:6px; flex-wrap:wrap;">
          {% for it in esg_fields %}
            {% set col = it.col if it is mapping else it %}
            {% set label = it.label if it is mapping else it %}
            <button type="button" class="btn btn-choice esg-field-global" data-field="{{ col }}" title="{{ label }}">{{ label }}</button>
          {% endfor %}
        </div>
      </div>
    </div>
    <div id="esgChartGlobal" data-tb-marker="TB_70" style="height:320px; width:100%;"></div>
    <div class="muted" style="margin-top:6px; font-size:12px;">Indice normalis√© √† 100. Portefeuille = valeur relative (Portefeuille / Indice √ó 100).</div>
    <details id="esgSqlGlobalDetails" data-tb-marker="TB_71" style="margin-top:8px;">
      <summary class="muted" style="cursor:pointer;">Voir les donn√©es brutes</summary>
      <div id="esgDebugPanelGlobal" class="muted" style="font-size:12px; display:none;"></div>
    </details>
  </div>
</div>

<!-- Accord√©on Groupes -->
<div id="groupsToggle" class="card collapsed accordion-toggle" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Groupes</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="groupsSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <style>
    #groupsSection .group-grid { display:flex; flex-wrap:wrap; gap:12px; }
    #groupsSection .group-card { flex:1 1 260px; border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; box-shadow:0 1px 2px rgba(15,23,42,0.08); display:flex; flex-direction:column; gap:8px; }
    #groupsSection .group-card h4 { margin:0; font-size:1rem; }
    #groupsSection .group-meta { font-size:0.85rem; color:#475569; display:grid; grid-template-columns: 120px 1fr; row-gap:4px; column-gap:6px; }
    #groupsSection .group-meta span { font-weight:600; color:#1e293b; }
    #groupsSection .group-card .btn { align-self:flex-start; margin-top:auto; }
  </style>
  <div class="card" style="margin-bottom:12px;">
    <h3 style="margin:0 0 8px 0;">Groupes de personnes</h3>
    {% if dashboard_groups_personnes %}
    <div class="group-grid">
      {% for grp in dashboard_groups_personnes %}
      <div class="group-card">
        <h4>{{ grp.nom }}</h4>
        <div class="group-meta">
          <span>Membres</span><div>{{ grp.nb_membres }}</div>
          <span>Responsable</span><div>{{ grp.responsable }}</div>
          <span>Cr√©ation</span><div>{{ grp.date_creation }}</div>
          <span>Fin</span><div>{{ grp.date_fin }}</div>
        </div>
        <a class="btn btn-primary" href="{{ grp.link }}">{{ grp.link_label }}</a>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="muted">Aucun groupe de personnes d√©fini.</div>
    {% endif %}
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Groupes d'affaires</h3>
    {% if dashboard_groups_affaires %}
    <div class="group-grid">
      {% for grp in dashboard_groups_affaires %}
      <div class="group-card">
        <h4>{{ grp.nom }}</h4>
        <div class="group-meta">
          <span>Membres</span><div>{{ grp.nb_membres }}</div>
          <span>Responsable</span><div>{{ grp.responsable }}</div>
          <span>Cr√©ation</span><div>{{ grp.date_creation }}</div>
          <span>Fin</span><div>{{ grp.date_fin }}</div>
        </div>
        <a class="btn btn-primary" href="{{ grp.link }}">{{ grp.link_label }}</a>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="muted">Aucun groupe d'affaires d√©fini.</div>
    {% endif %}
  </div>
</div>

<!-- T√¢ches (d√©plac√© plus haut) -->

<!-- Accord√©on R√©mun√©rations -->
<div id="remToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_75" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">R√©mun√©rations</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="remSection" data-tb-marker="TB_76" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <!-- Sous-accord√©on: Frais de gestion -->
  <div id="remFraisToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_77" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Frais de gestion</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="remFraisSection" data-tb-marker="TB_78" style="display:none;">
    <div class="card" data-tb-marker="TB_79" style="text-align:left;">
      <h3 style="margin-top:0;">Commissions sur frais de gestion</h3>
      {% if not rem_contracts %}
        <p style="margin:0; color:#555;">Aucun contrat g√©n√©rique actif disponible. Veuillez en cr√©er un dans les param√®tres.</p>
      {% else %}
        <form id="remForm" method="get" action="/dashboard#remFraisToggle" data-tb-marker="TB_80" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
          {% if tb_markers_param %}
            <input type="hidden" name="markers" value="1" />
          {% endif %}
          <div style="display:flex; flex-direction:column;">
            <label for="rem_contract" style="font-size:0.85rem; color:#555;">Contrat g√©n√©rique</label>
            <select id="rem_contract" name="rem_contract" style="min-width:220px; padding:8px 12px; height:38px;">
              {% for contrat in rem_contracts %}
                <option value="{{ contrat.id }}" {% if contrat.id == rem_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_start" style="font-size:0.85rem; color:#555;">Date de d√©but</label>
            <input id="rem_start" name="rem_start" type="date" value="{{ rem_start_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
            <input id="rem_end" name="rem_end" type="date" value="{{ rem_end_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_limit" style="font-size:0.85rem; color:#555;">Nombre de lignes</label>
            <select id="rem_limit" name="rem_limit" style="padding:8px 12px; height:38px;">
              {% for opt in rem_limit_options %}
                <option value="{{ opt }}" {% if opt == rem_limit %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <input type="hidden" name="rem_page" value="1" />
          <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
        </form>

        {% if rem_error %}
          <div style="margin-top:12px; padding:10px 12px; background:#fdecea; color:#a94442; border-radius:6px;">{{ rem_error }}</div>
        {% else %}
          <div data-tb-marker="TB_81" style="margin-top:12px; font-size:0.9rem; color:#555;">
            <div>P√©riode effective (vendredi) :
              {% if rem_start_effective and rem_end_effective %}
                du {{ rem_start_effective.strftime('%d/%m/%Y') }} au {{ rem_end_effective.strftime('%d/%m/%Y') }}
              {% else %}
                non d√©finie
              {% endif %}
            </div>
            <div>Total commissions dues : <strong>{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} ‚Ç¨</strong></div>
          </div>

          <div data-tb-marker="TB_82" style="overflow-x:auto; margin-top:12px;">
            <table data-tb-marker="TB_83" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Contrats</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation totale</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Commission frais de gestion</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rem_rows %}
                  <tr>
                    <td style="padding:8px;">{{ row.date.strftime('%d/%m/%Y') if row.date else row.date or 'N/A' }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.contracts_count }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.total_valorisation or 0).replace(',', ' ') }} ‚Ç¨</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.commission or 0).replace(',', ' ') }} ‚Ç¨</td>
                </tr>
              {% endfor %}
              {% if not rem_rows %}
                <tr>
                  <td colspan="4" style="padding:8px; color:#666;">Aucune donn√©e disponible pour cette p√©riode.</td>
                </tr>
              {% endif %}
            </tbody>
            <tfoot>
              <tr>
                <th style="padding:8px; text-align:left;">Total p√©riode</th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} ‚Ç¨</th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div data-tb-marker="TB_84" style="margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; font-size:0.9rem; color:#555;">
          {% if rem_has_prev %}
            {% set rem_prev_link = rem_prev_url %}
            {% if tb_markers_param %}
              {% set rem_prev_link = rem_prev_url + ('&' if '?' in rem_prev_url else '?') + tb_markers_param %}
            {% endif %}
            <a href="{{ rem_prev_link }}#remToggle" class="btn btn-choice" title="Page pr√©c√©dente"><i class="fa-solid fa-arrow-left"></i></a>
          {% endif %}
          <span>Page {{ rem_page }} / {{ rem_total_pages }}</span>
          {% if rem_has_next %}
            {% set rem_next_link = rem_next_url %}
            {% if tb_markers_param %}
              {% set rem_next_link = rem_next_url + ('&' if '?' in rem_next_url else '?') + tb_markers_param %}
            {% endif %}
            <a href="{{ rem_next_link }}#remToggle" class="btn btn-choice" title="Page suivante"><i class="fa-solid fa-arrow-right"></i></a>
          {% endif %}
        </div>
        <div data-tb-marker="TB_95" style="margin-top:6px; font-size:0.85rem; color:#777;">
Semaines {{ rem_page_start }} √† {{ rem_page_end }} sur {{ rem_rows_count }}.
        </div>
      {% endif %}
    {% endif %}
  </div>

</div>

<!-- Accord√©on R√©trocession des supports -->
<div id="retroToggle" class="card collapsed accordion-toggle" data-tb-marker="TB_85" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">R√©trocession des supports</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="retroSection" data-tb-marker="TB_86" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" data-tb-marker="TB_87" style="text-align:left;">
    <h3 style="margin-top:0;">R√©trocession des supports</h3>
    {% if retro_error %}
      <div style="margin:0; color:#a94442; background:#fdecea; padding:10px 12px; border-radius:6px;">{{ retro_error }}</div>
    {% elif not retro_contracts %}
      <p style="margin:0; color:#555;">Aucun contrat g√©n√©rique actif disponible. Veuillez en cr√©er un dans les param√®tres.</p>
    {% else %}
      <form id="retroForm" method="get" action="/dashboard#retroToggle" data-tb-marker="TB_88" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
        {% if tb_markers_param %}
          <input type="hidden" name="markers" value="1" />
        {% endif %}
        <input id="retroHiddenRemContract" type="hidden" name="rem_contract" value="{{ rem_selected_contract }}" />
        <input id="retroHiddenRemStart" type="hidden" name="rem_start" value="{{ rem_start_input }}" />
        <input id="retroHiddenRemEnd" type="hidden" name="rem_end" value="{{ rem_end_input }}" />
        <input type="hidden" name="rem_limit" value="{{ rem_limit }}" />
        <input type="hidden" name="rem_page" value="{{ rem_page }}" />
        <div style="display:flex; flex-direction:column;">
          <label for="ret_contract" style="font-size:0.85rem; color:#555;">Contrat g√©n√©rique</label>
          <select id="ret_contract" name="ret_contract" style="min-width:220px; padding:8px 12px; height:38px;">
            {% for contrat in retro_contracts %}
              <option value="{{ contrat.id }}" {% if contrat.id == retro_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_start" style="font-size:0.85rem; color:#555;">Date de d√©but</label>
          <input id="ret_start" name="ret_start" type="date" value="{{ retro_start_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
          <input id="ret_end" name="ret_end" type="date" value="{{ retro_end_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_sort" style="font-size:0.85rem; color:#555;">Tri</label>
          <select id="ret_sort" name="ret_sort" style="padding:8px 12px; height:38px;">
            <option value="date_desc" {% if retro_sort == 'date_desc' %}selected{% endif %}>Date d√©croissante</option>
            <option value="date_asc" {% if retro_sort == 'date_asc' %}selected{% endif %}>Date croissante</option>
            <option value="retrocession_desc" {% if retro_sort == 'retrocession_desc' %}selected{% endif %}>R√©trocession d√©croissante</option>
            <option value="retrocession_asc" {% if retro_sort == 'retrocession_asc' %}selected{% endif %}>R√©trocession croissante</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_week_limit" style="font-size:0.85rem; color:#555;">Lignes (semaines)</label>
          <select id="ret_week_limit" name="ret_week_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_week_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_week_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_support_limit" style="font-size:0.85rem; color:#555;">Lignes (supports)</label>
          <select id="ret_support_limit" name="ret_support_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_support_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_support_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_promoteur" style="font-size:0.85rem; color:#555;">Promoteur contient</label>
          <input id="ret_promoteur" name="ret_promoteur" type="text" value="{{ retro_promoteur }}" placeholder="(optionnel)" style="padding:6px 8px;" />
        </div>
        <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
      </form>

      <div data-tb-marker="TB_89" style="margin-top:12px; font-size:0.9rem; color:#555;">
        <div>P√©riode effective (vendredi) :
          {% if retro_start_effective and retro_end_effective %}
            du {{ retro_start_effective.strftime('%d/%m/%Y') }} au {{ retro_end_effective.strftime('%d/%m/%Y') }}
          {% else %}
            non d√©finie
          {% endif %}
        </div>
        <div>Total r√©trocessions (semaines s√©lectionn√©es) : <strong>{{ '{:,.2f}'.format(retro_total_week).replace(',', ' ') }}</strong></div>
      </div>

      <div data-tb-marker="TB_90" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:14px; margin-top:12px;">
        <div data-tb-marker="TB_91" style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">R√©trocession par semaines</h4>
          <table data-tb-marker="TB_92" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Nb contrats</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">R√©trocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_weeks %}
                <tr>
                  <td style="padding:8px;">{{ row.date_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.nb_contrats }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.valo_total_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_weeks %}
                <tr><td colspan="4" style="padding:8px; color:#666;">Aucune donn√©e pour cette p√©riode.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div data-tb-marker="TB_93" style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">R√©trocession par support financier</h4>
          <table data-tb-marker="TB_94" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">ISIN</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Support</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Promoteur</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">R√©trocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_supports %}
                <tr>
                  <td style="padding:8px;">{{ row.code_isin }}</td>
                  <td style="padding:8px;">{{ row.support_nom }}</td>
                  <td style="padding:8px;">{{ row.promoteur }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_supports %}
                <tr><td colspan="4" style="padding:8px; color:#666;">Aucun support trouv√© pour cette p√©riode.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <div style="margin-top:6px; font-size:0.85rem; color:#777;">Total r√©trocessions (supports list√©s) : {{ '{:,.2f}'.format(retro_total_support).replace(',', ' ') }}</div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
  function closeFinanceSupportModal(){
    const modal = document.getElementById('financeSupportModal');
    if (modal) modal.style.display = 'none';
  }
  let financeSupportCurrentClients = [];
  let financeSupportGroupDetails = [];
  let financeSupportGroupsLoaded = false;
  let financeSupportGroupLoading = false;
  function setFinanceSupportGroupStatus(message, isError){
    const el = document.getElementById('financeSupportGroupStatus');
    if (!el) return;
    el.textContent = message || '';
    el.style.color = isError ? '#b91c1c' : '#475569';
  }
  function renderFinanceSupportGroupSelect(){
    const sel = document.getElementById('financeSupportGroupSelect');
    if (!sel) return;
    sel.innerHTML = '';
    if (!financeSupportGroupsLoaded){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Chargement des groupes‚Ä¶';
      sel.appendChild(opt);
      return;
    }
    if (!Array.isArray(financeSupportGroupDetails) || financeSupportGroupDetails.length === 0){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Aucun groupe Personnes';
      sel.appendChild(opt);
      setFinanceSupportGroupStatus('Aucun groupe Personnes trouv√©. Cr√©ez-en dans Param√®tres > Groupes.', true);
      return;
    }
    financeSupportGroupDetails.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = g.nom + (g.actif === 0 ? ' (inactif)' : '');
      sel.appendChild(opt);
    });
    setFinanceSupportGroupStatus('', false);
  }
  async function loadFinanceSupportGroups(){
    if (financeSupportGroupLoading) return;
    financeSupportGroupLoading = true;
    setFinanceSupportGroupStatus('Chargement des groupes‚Ä¶', false);
    try{
      let details = [];
      const res = await fetch('/api/groupes/details?type=client&actifs_only=true');
      if (res.ok){
        details = await res.json();
      }
      if (!Array.isArray(details) || details.length === 0){
        const res2 = await fetch('/api/groupes/details?type=client&actifs_only=false');
        if (res2.ok){
          details = await res2.json();
        }
      }
      financeSupportGroupDetails = Array.isArray(details) ? details : [];
      financeSupportGroupsLoaded = true;
      renderFinanceSupportGroupSelect();
      if (financeSupportGroupDetails.length === 0){
        setFinanceSupportGroupStatus('Aucun groupe Personnes trouv√©. Cr√©ez-en dans Param√®tres > Groupes.', true);
      } else {
        setFinanceSupportGroupStatus('S√©lectionnez un groupe pour y ajouter la liste.', false);
      }
    } catch(err){
      console.warn('finance support group load error', err);
      setFinanceSupportGroupStatus('Erreur de chargement des groupes.', true);
    } finally {
      financeSupportGroupLoading = false;
    }
  }
  function toggleFinanceSupportGroupActions(shouldShow){
    const container = document.getElementById('financeSupportGroupActions');
    if (!container) return;
    if (!shouldShow){
      container.style.display = 'none';
      setFinanceSupportGroupStatus('', false);
      return;
    }
    container.style.display = '';
    renderFinanceSupportGroupSelect();
    if (!financeSupportGroupsLoaded && !financeSupportGroupLoading){
      loadFinanceSupportGroups();
    } else if (financeSupportGroupDetails.length){
      setFinanceSupportGroupStatus('S√©lectionnez un groupe pour y ajouter la liste.', false);
    }
  }
  async function addFinanceSupportClientsToGroup(){
    const btn = document.getElementById('financeSupportGroupAddBtn');
    const sel = document.getElementById('financeSupportGroupSelect');
    if (!btn || !sel) return;
    const gid = parseInt(sel.value, 10);
    if (!gid){
      setFinanceSupportGroupStatus('S√©lectionnez un groupe valide.', true);
      return;
    }
    const clients = Array.isArray(financeSupportCurrentClients) ? financeSupportCurrentClients.filter(c => c && c.client_id) : [];
    if (!clients.length){
      setFinanceSupportGroupStatus('Aucun client identifiable √† ajouter.', true);
      return;
    }
    btn.disabled = true;
    setFinanceSupportGroupStatus('Ajout en cours‚Ä¶', false);
    let success = 0;
    let attempted = 0;
    for (const client of clients){
      attempted++;
      try{
        const resp = await fetch('/api/groupes/memberships', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupe_id: gid, client_id: client.client_id })
        });
        if (resp.ok){
          success++;
        } else {
          console.warn('finance support group add error', resp.status);
        }
      } catch(err){
        console.warn('finance support group add error', err);
      }
    }
    btn.disabled = false;
    if (!attempted){
      setFinanceSupportGroupStatus('Aucun client valide pour l‚Äôajout.', true);
    } else if (success === attempted){
      const plural = success > 1 ? 'clients' : 'client';
      setFinanceSupportGroupStatus(`Liste ajout√©e (${success} ${plural}).`, false);
    } else {
      setFinanceSupportGroupStatus(`Ajout partiel : ${success}/${attempted} clients.`, true);
    }
  }
  function openFinanceSupportModal(code, name, clients){
    const modal = document.getElementById('financeSupportModal');
    if (!modal) return;
    const tbody = modal.querySelector('#financeSupportModalTable tbody');
    const labelEl = document.getElementById('financeSupportModalLabel');
    if (labelEl){
      const parts = ['Clients par support'];
      const detail = [name, code].filter(Boolean).join(' ‚Ä¢ ');
      if (detail) parts.push(detail);
      labelEl.textContent = parts.join(' ‚Äî ');
    }
    if (tbody){
      tbody.innerHTML = '';
      const rows = Array.isArray(clients) ? clients : [];
      financeSupportCurrentClients = rows.filter(function(item){ return item && item.client_id; });
      toggleFinanceSupportGroupActions(rows.length > 0);
      rows.forEach(function(item){
        const tr = document.createElement('tr');
        const clientTd = document.createElement('td');
        const fullname = item.client_fullname || item.client_nom || 'Client';
        if (item.client_id){
          const link = document.createElement('a');
          link.href = `/dashboard/clients/${encodeURIComponent(item.client_id)}`;
          link.textContent = fullname;
          link.target = '_blank';
          link.rel = 'noopener';
          clientTd.appendChild(link);
        } else {
          clientTd.textContent = fullname;
        }
        tr.appendChild(clientTd);
        const contratTd = document.createElement('td');
        if (item.affaire_id){
          const link = document.createElement('a');
          link.href = `/dashboard/affaires/${encodeURIComponent(item.affaire_id)}`;
          link.textContent = item.affaire_ref || `Affaire ${item.affaire_id}`;
          link.target = '_blank';
          link.rel = 'noopener';
          contratTd.appendChild(link);
        } else {
          contratTd.textContent = item.affaire_ref || '-';
        }
        tr.appendChild(contratTd);
        const valoTd = document.createElement('td');
        valoTd.className = 'numeric';
        valoTd.textContent = item.valorisation_str ? item.valorisation_str + ' ‚Ç¨' : '-';
        tr.appendChild(valoTd);
        tbody.appendChild(tr);
      });
      if (!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'muted';
        td.textContent = 'Aucun client trouv√© pour ce support.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }
    modal.style.display = 'flex';
  }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.finance-support-link').forEach(function(link){
      link.addEventListener('click', function(ev){
        ev.preventDefault();
        let clients = [];
        try{
          clients = this.dataset.clients ? JSON.parse(this.dataset.clients) : [];
        }catch(err){
          console.warn('finance support clients parse error', err);
        }
        openFinanceSupportModal(this.dataset.supportCode || '', this.dataset.supportName || '', clients);
      });
    });
    const addBtn = document.getElementById('financeSupportGroupAddBtn');
    if (addBtn){
      addBtn.addEventListener('click', function(ev){
        ev.preventDefault();
        addFinanceSupportClientsToGroup();
      });
    }
  });

  // Chart.js texte/axes en bleu corporate
  try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
  function toChartData(items, labelKey, valueKey) {
    const labels = items.map(i => 'SRRI ' + (i[labelKey] ?? 'N/A'));
    const data = items.map(i => Number(i[valueKey] || 0));
    return { labels, data };
  }

  const cc = toChartData({{ srri_clients_count | tojson }}, 'srri', 'nb');
  const ac = toChartData({{ srri_affaires_count | tojson }}, 'srri', 'nb');
  const ca = toChartData({{ srri_clients_amount | tojson }}, 'srri', 'total');
  const aa = toChartData({{ srri_affaires_amount | tojson }}, 'srri', 'total');
  const cb_labels = [{% for b in clients_buckets %}'{{ b.label }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const cb_data = [{% for b in clients_buckets %}{{ b.nb }}{% if not loop.last %}, {% endif %}{% endfor %}];
  if (cb_labels && cb_labels.length){ cb_labels[cb_labels.length-1] = 'Sup. 5M'; }

  function makeBar(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' ‚Ç¨' : v; } } }
        }
      }
    });
  }

  // Variante plein conteneur (hauteur contr√¥l√©e par CSS, ex: 25vh)
  function makeBarFill(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' ‚Ç¨' : v; } } } }
      }
    });
  }

  // Build charts (non cliquables)
  makeBar('chartClientsCount', cc.labels, cc.data, false);
  makeBar('chartAffairesCount', ac.labels, ac.data, false);
  makeBar('chartClientsAmount', ca.labels, ca.data, true);
  makeBar('chartAffairesAmount', aa.labels, aa.data, true);
  // Buckets chart (first): height reduced above
  makeBarFill('chartClientsBuckets', cb_labels, cb_data, false);

  // ------- T√¢ches: datasets -------
  const tasksStatut = {{ tasks_statut | tojson }};
  const tasksCategorie = {{ tasks_categorie | tojson }};
  const tasksDays = {{ tasks_days | tojson }};
  const ts_labels = tasksStatut.map(x => (x.statut || 'n/a'));
  const ts_data = tasksStatut.map(x => x.nb || 0);
  const tc_labels = tasksCategorie.map(x => (x.categorie || 'n/a'));
  const tc_data = tasksCategorie.map(x => x.nb || 0);
  const td_labels = tasksDays.map(x => x.day);
  const td_data = tasksDays.map(x => x.nb || 0);
  // Draw
  if (document.getElementById('chartTasksStatut')) makeBar('chartTasksStatut', ts_labels, ts_data, false);
  if (document.getElementById('chartTasksCategorie')) makeBar('chartTasksCategorie', tc_labels, tc_data, false);
  if (document.getElementById('chartTasksDays')) makeBarFill('chartTasksDays', td_labels, td_data, false);
  const tdist = {{ tasks_close_dist | tojson }};
  const tdist_labels = tdist.map(x => x.bucket);
  const tdist_data = tdist.map(x => x.nb || 0);
  if (document.getElementById('chartTasksCloseDist')) makeBarFill('chartTasksCloseDist', tdist_labels, tdist_data, false);

  // -------- Graphique: Nb de t√¢ches par type (avec filtre RH) --------
  (function(){
    const byRh = {{ tasks_type_by_rh | tojson }} || [];
    const totals = {{ tasks_type_total | tojson }} || [];
    const sel = document.getElementById('tasksRhSelect');
    const canvas = document.getElementById('chartTasksType');
    if (!sel || !canvas) return;
    // Options RH (uniques, non vides)
    const rhPairs = [];
    const seen = new Set();
    byRh.forEach(r => { if (r.rh_id != null && r.rh_nom){ const key = r.rh_id+""; if(!seen.has(key)){ seen.add(key); rhPairs.push({id:r.rh_id, nom:r.rh_nom}); } } });
    rhPairs.sort((a,b)=> String(a.nom).localeCompare(String(b.nom),'fr',{sensitivity:'base'}));
    rhPairs.forEach(p=>{ const o=document.createElement('option'); o.value=String(p.id); o.textContent=p.nom; sel.appendChild(o); });
    let chartInst = null;
    function draw(rhId){
      // Build map type->nb
      const map = new Map();
      if (rhId){
        byRh.filter(r => String(r.rh_id) === String(rhId)).forEach(r => { map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
      } else {
        (totals||[]).forEach(r => { map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
      }
      const entries = Array.from(map.entries()).sort((a,b)=> b[1]-a[1]);
      const labels = entries.map(e=> e[0]);
      const data = entries.map(e=> e[1]);
      if (chartInst) { chartInst.destroy(); chartInst = null; }
      const ctx = canvas.getContext('2d');
      chartInst = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }]}, options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } } });
    }
    sel.addEventListener('change', function(){ const v = this.value || ''; draw(v||null); });
    draw(null);
  })();

  (function syncRemRetroForms(){
    const remContract = document.getElementById('rem_contract');
    const remStart = document.getElementById('rem_start');
    const remEnd = document.getElementById('rem_end');
    const retContract = document.getElementById('ret_contract');
    const retStart = document.getElementById('ret_start');
    const retEnd = document.getElementById('ret_end');
    const retroHiddenRemContract = document.getElementById('retroHiddenRemContract');
    const retroHiddenRemStart = document.getElementById('retroHiddenRemStart');
    const retroHiddenRemEnd = document.getElementById('retroHiddenRemEnd');
    if (!remContract || !retContract || !remStart || !remEnd || !retStart || !retEnd) {
      return;
    }
    let syncingFromRem = false;
    let syncingFromRetro = false;

    function copyRemToRetro(){
      if (syncingFromRetro) return;
      syncingFromRem = true;
      if (retContract) retContract.value = remContract.value;
      if (retStart) retStart.value = remStart.value;
      if (retEnd) retEnd.value = remEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = remContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = remStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = remEnd.value;
      syncingFromRem = false;
    }

    function copyRetroToRem(){
      if (syncingFromRem) return;
      syncingFromRetro = true;
      if (remContract) remContract.value = retContract.value;
      if (remStart) remStart.value = retStart.value;
      if (remEnd) remEnd.value = retEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = retContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = retStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = retEnd.value;
      syncingFromRetro = false;
    }

    copyRemToRetro();

    remContract.addEventListener('change', copyRemToRetro);
    remStart.addEventListener('change', copyRemToRetro);
    remEnd.addEventListener('change', copyRemToRetro);
    retContract.addEventListener('change', copyRetroToRem);
    retStart.addEventListener('change', copyRetroToRem);
    retEnd.addEventListener('change', copyRetroToRem);
  })();

  // Accord√©ons (un seul ouvert √† la fois, possibilit√© de tout fermer)
  (function(){
    const groups = [
      { key:'risks', toggle:'risksToggle', section:'risksSection' },
      { key:'analysis', toggle:'analysisToggle', section:'analysisSection' },
      { key:'esg', toggle:'esgToggle', section:'esgSection' },
      { key:'groups', toggle:'groupsToggle', section:'groupsSection' },
      { key:'tasks', toggle:'tasksToggle', section:'tasksSection' },
      { key:'rem', toggle:'remToggle', section:'remSection' },
    ];
    const $ = (id)=> document.getElementById(id);
    const getGroup = (key)=> groups.find(g => g.key === key);
    function setOpen(key){
      groups.forEach(g => {
        const t = $(g.toggle), s = $(g.section);
        if (!t || !s) return;
        if (g.key === key){ s.style.display = ''; t.classList.remove('collapsed'); }
        else { s.style.display = 'none'; t.classList.add('collapsed'); }
      });
    }
    function detectInitialKey(){
      const hash = (window.location.hash || '').replace('#','');
      const isRetroHash = hash === 'retroToggle' || hash === 'retroSection';
      if (hash){
        const match = groups.find(g => g.toggle === hash || g.section === hash || g.key === hash);
        if (match) return match.key;
        if (isRetroHash) return 'rem';
        if (hash === 'groupsToggle' || hash === 'groupsSection') return 'groups';
        if (hash === 'remFraisToggle' || hash === 'remFraisSection') return 'rem';
      }
      const search = window.location.search || '';
      const params = new URLSearchParams(search);
      const retroParamKeys = ['ret_contract','ret_start','ret_end','ret_sort','ret_week_limit','ret_support_limit','ret_promoteur'];
      const hasRetroParams = retroParamKeys.some(key => params.has(key));
      if (hasRetroParams) return 'rem';
      if (params.has('finance_date') || params.has('finance_rh') || params.has('finance_valo')){
        return 'analysis';
      }
      const remParamKeys = ['rem_contract','rem_start','rem_end','rem_limit','rem_page'];
      const hasRemParams = remParamKeys.some(key => params.has(key));
      if (hasRemParams){
        return 'rem';
      }
      return '';
    }
    const initialKey = detectInitialKey();
    // Ensure all closed by default, unless we detect one that should stay open
    setOpen(initialKey);
    if (initialKey){
      const group = getGroup(initialKey);
      if (group){
        setTimeout(() => {
          const toggle = $(group.toggle);
          if (!toggle) return;
          try { toggle.scrollIntoView({ behavior:'auto', block:'start' }); }
          catch(e) {}
        }, 0);
      }
    }
    // Wire clicks
    groups.forEach(g => {
      const t = $(g.toggle), s = $(g.section);
      if (!t || !s) return;
      t.addEventListener('click', function(){
        const isOpen = s.style.display !== 'none';
        if (isOpen){
          // Close all (allow collapsing)
          setOpen('');
        } else {
          setOpen(g.key);
          try { t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
        }
      });
    });
  })();

  // Bloc R√©trocession (accord√©on ind√©pendant)
  (function(){
    const toggle = document.getElementById('retroToggle');
    const section = document.getElementById('retroSection');
    const remFraisToggle = document.getElementById('remFraisToggle');
    const remFraisSection = document.getElementById('remFraisSection');
    const retroHash = (window.location.hash || '').replace('#','');
    const retroParams = new URLSearchParams(window.location.search || '');
    const retroParamKeys = ['ret_contract','ret_start','ret_end','ret_sort','ret_week_limit','ret_support_limit','ret_promoteur'];
    const shouldOpenByParams = retroParamKeys.some(key => retroParams.has(key));
    const shouldOpenByHash = retroHash === 'retroToggle' || retroHash === 'retroSection';
    const shouldOpenInitially = shouldOpenByParams || shouldOpenByHash;
    if (!toggle || !section) return;
    function closeRemFrais(){
      if (!remFraisToggle || !remFraisSection) return;
      remFraisSection.style.display = 'none';
      remFraisToggle.classList.add('collapsed');
    }
    function apply(isOpen){
      section.style.display = isOpen ? '' : 'none';
      toggle.classList.toggle('collapsed', !isOpen);
      if (isOpen) closeRemFrais();
    }
    apply(shouldOpenInitially);
    if (shouldOpenInitially){
      try { toggle.scrollIntoView({ behavior:'auto', block:'start' }); } catch(e) {}
    }
    toggle.addEventListener('click', function(){
      const isOpen = section.style.display !== 'none';
      const next = !isOpen;
      apply(next);
      if (next){
        try { toggle.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
      }
    });
  })();

  (function(){
    var exportBtn = document.getElementById('finance_export_btn');
    if (!exportBtn) return;
    exportBtn.addEventListener('click', function(){
      var params = new URLSearchParams();
      var dateInput = document.querySelector('input[name="finance_date"]');
      if (dateInput && dateInput.value) params.set('finance_date', dateInput.value);
      var rhSelect = document.querySelector('select[name="finance_rh"]');
      if (rhSelect && rhSelect.value) params.set('finance_rh', rhSelect.value);
      var valoInput = document.querySelector('input[name="finance_valo"]');
      if (valoInput && valoInput.value) params.set('finance_valo', valoInput.value);
      var url = '/dashboard/finance/export';
      var qs = params.toString();
      if (qs) url += '?' + qs;
      window.location.href = url;
    });
  })();

  // Sous-accord√©ons Risques / Analyse portefeuille (ind√©pendants, ouverts via data-open)
  (function(){
    const pairs = [
      ['complianceToggle','complianceSection'],
      ['rcpToggle','rcpSection'],
      ['clienteleToggle','clienteleSection'],
      ['srriToggle','srriSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => {
      const t = document.getElementById(tid);
      const s = document.getElementById(sid);
      return t && s ? { t, s } : null;
    }).filter(Boolean);

    function closeNode(o){
      o.s.style.display = 'none';
      o.t.classList.add('collapsed');
    }
    function closeAll(){
      nodes.forEach(closeNode);
    }
    function openNode(target){
      closeAll();
      target.s.style.display = '';
      target.t.classList.remove('collapsed');
    }

    closeAll();
    nodes.forEach(o => {
      o.t.addEventListener('click', function(ev){
        ev.stopPropagation();
        const isOpen = o.s.style.display !== 'none';
        if (isOpen){
          closeNode(o);
        } else {
          openNode(o);
          try { o.t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
        }
      });
    });
  })();

  // Sous-accord√©ons R√©mun√©rations (ind√©pendants)
  (function(){
    const pairs = [
      ['remFraisToggle','remFraisSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => ({
      t: document.getElementById(tid),
      s: document.getElementById(sid)
    })).filter(o => o.t && o.s);
    const retroToggle = document.getElementById('retroToggle');
    const retroSection = document.getElementById('retroSection');
    const remHash = (window.location.hash || '').replace('#','');
    const remParams = new URLSearchParams(window.location.search || '');
    const remParamKeys = ['rem_contract','rem_start','rem_end','rem_limit','rem_page'];
    const retroParamKeys = ['ret_contract','ret_start','ret_end','ret_sort','ret_week_limit','ret_support_limit','ret_promoteur'];
    const hasRetroParams = retroParamKeys.some(key => remParams.has(key));
    const shouldOpenByParams = !hasRetroParams && remParamKeys.some(key => remParams.has(key));
    function closeRetro(){
      if (!retroToggle || !retroSection) return;
      retroSection.style.display = 'none';
      retroToggle.classList.add('collapsed');
    }

    nodes.forEach(o => {
      function open(){
        o.s.style.display = '';
        o.t.classList.remove('collapsed');
        closeRetro();
      }
      function close(){
        o.s.style.display = 'none';
        o.t.classList.add('collapsed');
      }
      const targetToggleId = o.t ? o.t.id : '';
      const targetSectionId = o.s ? o.s.id : '';
      const shouldOpen = shouldOpenByParams || remHash === targetToggleId || remHash === targetSectionId;
      if (shouldOpen){ open(); }
      else { close(); }
      o.t.addEventListener('click', function(ev){
        ev.stopPropagation();
        const isOpen = o.s.style.display !== 'none';
        if (isOpen) { close(); }
        else {
          open();
          try{ o.t.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(e){}
        }
      });
    });
  })();

  

  // ESG Global logic (similar to Affaire/Client)
  (function(){
    var allocSel = document.getElementById('esgAllocSelectGlobal');
    var allocDateSel = document.getElementById('esgAllocDateGlobal');
    var fieldsWrap = document.getElementById('esgFieldsGlobal');
    var refreshBtn = document.getElementById('esgRefreshBtnGlobal');
    if (!allocSel || !fieldsWrap) return;

    var keyAlloc = 'global_esg_alloc';
    var keyFields = 'global_esg_fields';
    var keyAllocDate = 'global_esg_alloc_date';

    function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field-global.btn-choice-active')).map(b=> b.getAttribute('data-field')); }
    fieldsWrap.addEventListener('click', function(e){
      var b=e.target.closest('.esg-field-global'); if(!b) return;
      var sel = selectedFields();
      if (b.classList.contains('btn-choice-active')){ b.classList.remove('btn-choice-active'); }
      else { if (sel.length >= 4) return; b.classList.add('btn-choice-active'); }
      try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
      drawESG();
    });

    function ensurePlotly(cb){ if (window.Plotly) { cb(); return; } var s=document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ cb(); }; document.head.appendChild(s); }
    function drawESG(){
      var fields = selectedFields();
      var alloc = allocSel.value || '';
      var allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
      if (!fields.length || !alloc) return;
      ensurePlotly(function(){
        var url = `/dashboard/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}&debug=1` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'');
        fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          var rows = (data && data.results) || [];
          // Keep only rows with at least one value
          rows = rows.filter(r => r && (r.global != null || r.index != null));
          var cats = rows.map(r=> r.field);
          // Normalize: index baseline 100; portfolio = (global_raw / index_raw) * 100
          var idx = rows.map(function(r){
            if (r.index != null) return Number(r.index);
            if (r.index_raw != null) return 100;
            return null;
          });
          var g = rows.map(function(r){
            if (r.global != null) return Number(r.global);
            var pr = (r.global_raw==null? null : Number(r.global_raw));
            var ir = (r.index_raw==null? null : Number(r.index_raw));
            if (pr==null || ir==null || ir===0) return null;
            return (pr/ir)*100.0;
          });
          // If portfolio values are all null, nothing to plot
          if (!g.length || g.every(v => v == null)) { g = cats.map(() => null); }
          var traces = [
            { x: idx, y: cats, type:'bar', orientation:'h', name:(alloc||'Indice'), marker:{ color:'#9ca3af' } },
            { x: g, y: cats, type:'bar', orientation:'h', name:'Portefeuille', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
          ];
          var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
          var cfg = { displayModeBar: false, responsive: true };
          Plotly.react('esgChartGlobal', traces, layout, cfg);
          // Debug panel (only raw values table)
          try {
            var dbgWrap = document.getElementById('esgDebugPanelGlobal');
            if (dbgWrap){
              var d = data && data.debug ? data.debug : null;
              if (d){
                function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                var html = '';
                try {
                  var prow = d.portfolio_raw || {};
                  var irow = d.index_raw || {};
                  if (fields && fields.length){
                    html += '<div style="margin-top:6px;"><strong>Valeurs brutes (par champ)</strong>';
                    html += '<table style="border-collapse:collapse; margin-top:4px; font-family:monospace; font-size:12px;">';
                    html += '<tr><th style="text-align:left; padding-right:12px;">Champ</th><th style="text-align:right; padding-right:12px;">' + esc(alloc||'Indice') + '</th><th style="text-align:right;">Portefeuille</th></tr>';
                    fields.forEach(function(f){
                      var iv = irow && Object.prototype.hasOwnProperty.call(irow, f) ? irow[f] : null;
                      var pv = prow && Object.prototype.hasOwnProperty.call(prow, f) ? prow[f] : null;
                      function fmt(v){ if(v==null||v===undefined||Number.isNaN(Number(v))) return '-'; try{ var n=Number(v); return (Math.abs(n)>=1000? n.toFixed(2): n.toFixed(4)); }catch(_e){ return esc(String(v)); } }
                      html += '<tr><td style="padding-right:12px;">' + esc(f) + '</td>'+
                              '<td style="text-align:right; padding-right:12px;">' + fmt(iv) + '</td>'+
                              '<td style="text-align:right;">' + fmt(pv) + '</td></tr>';
                    });
                    html += '</table></div>';
                  }
                } catch(_er) {}
                dbgWrap.innerHTML = html;
                dbgWrap.style.display='';
                try { document.getElementById('esgSqlGlobalDetails').open = true; } catch(_e) {}
              }
            }
          } catch(_e) {}
        }).catch(function(err){ try{ console.error('Global ESG fetch error', err); }catch(_){} });
      });
    }

    function loadAllocDates(preferred){
      if (!allocSel || !allocSel.value) { if (allocDateSel) allocDateSel.innerHTML=''; return; }
      fetch(`/dashboard/allocations/dates?name=${encodeURIComponent(allocSel.value)}`)
        .then(r=>r.json()).then(function(data){
          if (!allocDateSel) return;
          allocDateSel.innerHTML = '';
          var ds = (data && data.dates) || [];
          ds.forEach(function(d){ var o=document.createElement('option'); o.value=d; o.textContent=d; allocDateSel.appendChild(o); });
          var selected = false;
          if (preferred){ for (var i=0;i<allocDateSel.options.length;i++){ if (allocDateSel.options[i].value===preferred){ allocDateSel.selectedIndex=i; selected=true; break; } } }
          if (!selected && allocDateSel.options.length>0) allocDateSel.selectedIndex = 0;
          drawESG();
        }).catch(function(e){ try{ console.warn('alloc dates (global)', e);}catch(_){} });
    }

    allocSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAlloc, allocSel.value||''); }catch(_e){}; try{ localStorage.removeItem(keyAllocDate); }catch(_e){}; loadAllocDates(); });
    if (allocDateSel) allocDateSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAllocDate, allocDateSel.value||''); }catch(_e){}; drawESG(); });
    if (refreshBtn) refreshBtn.addEventListener('click', drawESG);

    // Init
    (function init(){
      try{
        var savedAlloc = localStorage.getItem(keyAlloc) || '';
        if (savedAlloc){ var found=false; for (var i=0;i<allocSel.options.length;i++){ if (allocSel.options[i].value===savedAlloc){ allocSel.selectedIndex=i; found=true; break; } } if(!found) savedAlloc=''; }
        if (!savedAlloc){ for (var j=0;j<allocSel.options.length;j++){ if (allocSel.options[j].value){ allocSel.selectedIndex=j; savedAlloc=allocSel.options[j].value; break; } } if (savedAlloc){ try{ localStorage.setItem(keyAlloc, savedAlloc);}catch(_e){} } }
      }catch(_e){}
      try{
        var raw = localStorage.getItem(keyFields); var saved=[]; if (raw){ try{ saved=JSON.parse(raw)||[]; }catch(_ee){ saved=[]; } }
        var buttons = Array.from(fieldsWrap.querySelectorAll('.esg-field-global'));
        buttons.forEach(b=> b.classList.remove('btn-choice-active'));
        if (saved.length){ buttons.forEach(b=> { var v=b.getAttribute('data-field'); if (saved.indexOf(v)>=0) b.classList.add('btn-choice-active'); }); }
        else { buttons.slice(0,3).forEach(b=> b.classList.add('btn-choice-active')); try{ localStorage.setItem(keyFields, JSON.stringify(buttons.slice(0,3).map(b=> b.getAttribute('data-field')))); }catch(_e){} }
      }catch(_e){}
      var preferDate = ''; try{ preferDate = localStorage.getItem(keyAllocDate) || ''; }catch(_e){}
      if (allocSel && allocSel.value){ loadAllocDates(preferDate); } else { drawESG(); }
    })();
  })();
</script>

</div>
{% endblock %}
