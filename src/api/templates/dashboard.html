{% extends "base.html" %}

{% block title %}Tableau de bord{% endblock %}
{% block header_title %}<i class="fa-solid fa-house" style="margin-right:8px;"></i>Tableau de bord{% endblock %}

{% block content %}
<style>
  .home-title { text-align: center; margin: 0 0 1rem 0; }
  .home-sub { text-align: center; margin: 0 0 2rem 0; color: #666; }
  .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; max-width: 1100px; margin: 0 auto 2rem auto; }
  .kpi-card { background:#fff; border-radius:12px; padding:18px; text-align:center; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
  .kpi-value { font-size:1.6rem; font-weight:700; margin-top:6px; }
  .charts { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; max-width: 1200px; margin: 0 auto; }
  /* Liens discrets dans la carte Documents */
  .doc-filter-link { text-decoration:none; color:inherit; }
  .doc-filter-link:hover { text-decoration: underline; }
  /* Chevrons accordéon: rotation sur fermeture */
  #risksToggle .chevron, #analysisToggle .chevron, #esgToggle .chevron, #tasksToggle .chevron, #remToggle .chevron, #groupsToggle .chevron,
  #srriToggle .chevron, #clienteleToggle .chevron, #financeToggle .chevron {
    transition: transform .2s ease; color: var(--primary);
  }
  #risksToggle.collapsed .chevron, #analysisToggle.collapsed .chevron, #esgToggle.collapsed .chevron, #tasksToggle.collapsed .chevron,
  #remToggle.collapsed .chevron, #groupsToggle.collapsed .chevron,
  #srriToggle.collapsed .chevron, #clienteleToggle.collapsed .chevron, #financeToggle.collapsed .chevron {
    transform: rotate(-90deg);
  }
  /* Style bleu pour sous-accordéons de l'analyse */
  #clienteleToggle, #srriToggle, #financeToggle,
  #remFraisToggle, #remRetroToggle {
    background: var(--primary);
    color: #fff;
    border: 1px solid var(--primary);
  }
  #clienteleToggle h3, #srriToggle h3, #financeToggle h3,
  #remFraisToggle h3, #remRetroToggle h3 { color:#fff; }
  #clienteleToggle .chevron, #srriToggle .chevron, #financeToggle .chevron,
  #remFraisToggle .chevron, #remRetroToggle .chevron { color:#fff; }
  /* Risk dots */
  .dot { display:inline-block; width: 0.9em; height: 0.9em; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
  .dot-red { background:#ef4444; }
  .dot-green { background:#16a34a; }
  .dot-blue { background:#3b82f6; }
  /* ESG global: boutons compacts */
  #esgSection .esg-field-global {
    font-size: 10px;
    padding: 2px 6px;
    height: auto;
    line-height: 1.2;
    border-radius: 6px;
    margin: 2px;
  }
  /* Dropdown RH width control */
  #tasksRhSelect { width: 160px; max-width: 160px; }
  @media (max-width: 480px) { #tasksRhSelect { width: 140px; max-width: 140px; } }
</style>

<h2 class="home-title">Tableau de bord</h2>
<p class="home-sub">Accès rapide et indicateurs clés</p>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi-card">
    <div>Nombre d'affaires</div>
    <div class="kpi-value">{{ total_affaires }}</div>
  </div>
  <div class="kpi-card">
    <div>Valorisation totale</div>
    <div class="kpi-value">{{ '{:,.0f}'.format(total_valo or 0).replace(',', ' ') }} €</div>
  </div>
  <div class="kpi-card">
    <div>Nombre de clients</div>
    <div class="kpi-value">{{ total_clients }}</div>
  </div>
  </div>

  <!-- Accordéon Tâches en cours (remonté avant Risques) -->
  </div>
  <div id="tasksToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">Tâches en cours</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="tasksSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
    <div class="muted">Période:</div>
    {% set r = tasks_range or 14 %}
    {% for n in [7,14,30] %}
      {% if n == r %}
        <a class="btn btn-choice btn-choice-active" href="?tasks_range={{ n }}#tasksToggle">{{ n }} j</a>
      {% else %}
        <a class="btn btn-choice" href="?tasks_range={{ n }}#tasksToggle">{{ n }} j</a>
      {% endif %}
    {% endfor %}
  </div>
  <div class="kpis" style="grid-template-columns: repeat(4, 1fr);">
    <div class="kpi-card">
      <div>Tâches totales</div>
      <div class="kpi-value">{{ tasks_total }}</div>
    </div>
    <div class="kpi-card">
      <div>Ouvertes</div>
      <div class="kpi-value">{{ tasks_open }}</div>
    </div>
    <div class="kpi-card">
      <div>Clôturées</div>
      <div class="kpi-value">{{ (tasks_total - tasks_open) if tasks_total is not none else 0 }}</div>
    </div>
    <div class="kpi-card">
      <div>Aujourd'hui</div>
      <div class="kpi-value">{% set today = tasks_days|last %}{{ today.nb if today else 0 }}</div>
    </div>
    <div class="kpi-card" style="grid-column: 1 / -1; min-height:140px; display:flex; align-items:center; justify-content:center;">
      {% set total_tasks_days = tasks_days | map(attribute='nb') | sum %}
      {% if total_tasks_days and total_tasks_days > 0 %}
        <canvas id="chartTasksDays" height="120"></canvas>
      {% else %}
        <div class="muted">Aucune tâche sur la période sélectionnée</div>
      {% endif %}
    </div>
  </div>
  <div class="card" style="margin-top:8px;">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
      <div class="muted">Filtre par responsable commercial:</div>
      <select id="tasksRhSelect" style="width:160px;">
        <option value="">Tous</option>
      </select>
    </div>
    <div style="min-height:180px; display:flex; align-items:center; justify-content:center;">
      <canvas id="chartTasksType" height="120"></canvas>
    </div>
  </div>
  </div>

  <!-- Accordéon Risques -->
  <div id="risksToggle" class="card" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">Risques</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="risksSection" class="kpis" style="display:none;">
  <div class="kpi-card" style="text-align:left;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3 style="margin:0; font-size:1.05rem;">Documents</h3>
    </div>
    <div style="margin-top:8px; font-size:0.9rem;">
      <div><strong>Total documents:</strong> <a class="doc-filter-link" href="/dashboard/documents" target="_blank" rel="noopener noreferrer">{{ docs_total }}</a></div>
      <div style="margin-top:6px;">
        <div style="color:#666; font-size:0.85rem;">Obsolescences par niveau</div>
        <div>
          {% for x in docs_obs_by_niveau %}
            <span>
              <strong>
                <a href="/dashboard/documents?niveau={{ x.niveau }}" class="doc-filter-link" target="_blank" rel="noopener noreferrer">
                  {{ x.niveau or 'N/A' }}
                </a>
              </strong>: {{ x.nb }}{% if not loop.last %} | {% endif %}
            </span>
          {% endfor %}
          {% if not docs_obs_by_niveau %}<span class="muted">Aucune donnée</span>{% endif %}
        </div>
      </div>
      <div style="margin-top:6px;">
        <div style="color:#666; font-size:0.85rem;">Obsolescences par risque</div>
        <div>
          {% for x in docs_obs_by_risque %}
            <span>
              <strong>
                <a href="/dashboard/documents?risque={{ x.risque }}" class="doc-filter-link" target="_blank" rel="noopener noreferrer">
                  {{ x.risque or 'N/A' }}
                </a>
              </strong>: {{ x.nb }}{% if not loop.last %} | {% endif %}
            </span>
          {% endfor %}
          {% if not docs_obs_by_risque %}<span class="muted">Aucune donnée</span>{% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="kpi-card" style="text-align:left;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3 style="margin:0; font-size:1.05rem;">Clients</h3>
    </div>
    <div style="margin-top:8px; font-size:0.95rem; line-height:1.6;">
      <div>
        <a href="/dashboard/clients?risk=above" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
          <span class="dot dot-red"></span><strong>{{ cli_risk_counts.above }}</strong> — Au‑dessus du risque
        </a>
      </div>
      <div>
        <a href="/dashboard/clients?risk=equal" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
          <span class="dot dot-green"></span><strong>{{ cli_risk_counts.equal }}</strong> — Dans le risque
        </a>
      </div>
      <div>
        <a href="/dashboard/clients?risk=below" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
          <span class="dot dot-blue"></span><strong>{{ cli_risk_counts.below }}</strong> — Sous le risque
        </a>
      </div>
    </div>
  </div>
  <div class="kpi-card" style="text-align:left;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3 style="margin:0; font-size:1.05rem;">Affaires</h3>
    </div>
    <div style="margin-top:8px; font-size:0.95rem; line-height:1.6;">
      <div>
        <a href="/dashboard/affaires?risk=above" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
          <span class="dot dot-red"></span><strong>{{ aff_risk_counts.above }}</strong> — Au‑dessus du risque
        </a>
      </div>
      <div>
        <a href="/dashboard/affaires?risk=equal" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
          <span class="dot dot-green"></span><strong>{{ aff_risk_counts.equal }}</strong> — Dans le risque
        </a>
      </div>
      <div>
        <a href="/dashboard/affaires?risk=below" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
          <span class="dot dot-blue"></span><strong>{{ aff_risk_counts.below }}</strong> — Sous le risque
        </a>
      </div>
    </div>
  </div>
  </div>

<!-- Accordéon Analyse portefeuille -->
<div id="analysisToggle" class="card" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Analyse portefeuille</h3>
  <span class="chevron">▾</span>
 </div>
<div id="analysisSection" style="display:none;">
  <!-- Sous-accordéon: Répartition par clientèle -->
  <div id="clienteleToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Répartition par clientèle</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="clienteleSection" style="display:none;">
    <div class="card" style="max-width: 1100px; margin: 0 auto 1rem auto; height: calc(18vh + 50px); display:flex; flex-direction:column;">
      <h3>Découpage clients par détention</h3>
      <canvas id="chartClientsBuckets" style="flex:1 1 auto; min-height:0;"></canvas>
    </div>
  </div>

  <!-- Sous-accordéon: Répartitions SRRI -->
  <div id="srriToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Répartitions SRRI</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="srriSection" style="display:none;">
    <div class="charts" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); max-width:1100px; margin:0 auto;">
      <div class="card">
        <h3>Clients par SRRI</h3>
        <canvas id="chartClientsCount"></canvas>
      </div>
      <div class="card">
        <h3>Montant par SRRI (Clients)</h3>
        <canvas id="chartClientsAmount"></canvas>
      </div>
    </div>
    <div class="charts" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); max-width:1100px; margin:0 auto;">
      <div class="card">
        <h3>Affaires par SRRI</h3>
        <canvas id="chartAffairesCount"></canvas>
      </div>
      <div class="card">
        <h3>Montant par SRRI (Affaires)</h3>
        <canvas id="chartAffairesAmount"></canvas>
      </div>
    </div>
  </div>

  <!-- Sous-accordéon: Analyse financière -->
  <div id="financeToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Analyse financière</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="financeSection" style="display:none;">
    <div class="card" style="max-width:1100px; margin: 0 auto 1rem auto;">
      <div class="muted">À venir</div>
    </div>
  </div>
</div>

<!-- Accordéon ESG (global) -->
<div id="esgToggle" class="card" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">ESG</h3>
  <span class="chevron">▾</span>
</div>
<div id="esgSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" style="text-align:left;">
    <h3 style="margin-top:0;">Comparaison ESG Portefeuille vs Indice - global</h3>
    <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px 0;">
      <div>
        <label class="muted" style="font-size:0.85rem;">Allocation de référence</label><br>
        <select id="esgAllocSelectGlobal" style="min-width:220px; max-width:280px; width:auto;">
          <option value="">— choisir —</option>
          {% for nm in alloc_names %}<option value="{{ nm }}">{{ nm }}</option>{% endfor %}
        </select>
      </div>
      <div style="display:none;">
        <label class="muted" style="font-size:0.85rem;">Date</label><br>
        <select id="esgAllocDateGlobal" style="width: 14ch; min-width: 14ch;"></select>
      </div>
      <div style="flex:1 1 auto; min-width:260px;">
        <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
        <div id="esgFieldsGlobal" style="display:flex; gap:6px; flex-wrap:wrap;">
          {% for it in esg_fields %}
            {% set col = it.col if it is mapping else it %}
            {% set label = it.label if it is mapping else it %}
            <button type="button" class="btn btn-choice esg-field-global" data-field="{{ col }}" title="{{ label }}">{{ label }}</button>
          {% endfor %}
        </div>
      </div>
    </div>
    <div id="esgChartGlobal" style="height:320px; width:100%;"></div>
    <div class="muted" style="margin-top:6px; font-size:12px;">Indice normalisé à 100. Portefeuille = valeur relative (Portefeuille / Indice × 100).</div>
    <details id="esgSqlGlobalDetails" style="margin-top:8px;">
      <summary class="muted" style="cursor:pointer;">Voir les données brutes</summary>
      <div id="esgDebugPanelGlobal" class="muted" style="font-size:12px; display:none;"></div>
    </details>
  </div>
</div>

<!-- Tâches (déplacé plus haut) -->

<!-- Accordéon Rémunérations -->
<div id="remToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Rémunérations</h3>
  <span class="chevron">▾</span>
</div>
<div id="remSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <!-- Sous-accordéon: Frais de gestion -->
  <div id="remFraisToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Frais de gestion</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="remFraisSection" style="display:none;">
    <div class="card" style="text-align:left;">
      <h3 style="margin-top:0;">Commissions sur frais de gestion</h3>
      {% if not rem_contracts %}
        <p style="margin:0; color:#555;">Aucun contrat générique actif disponible. Veuillez en créer un dans les paramètres.</p>
      {% else %}
        <form id="remForm" method="get" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
          <div style="display:flex; flex-direction:column;">
            <label for="rem_contract" style="font-size:0.85rem; color:#555;">Contrat générique</label>
            <select id="rem_contract" name="rem_contract" style="min-width:220px; padding:8px 12px; height:38px;">
              {% for contrat in rem_contracts %}
                <option value="{{ contrat.id }}" {% if contrat.id == rem_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_start" style="font-size:0.85rem; color:#555;">Date de début</label>
            <input id="rem_start" name="rem_start" type="date" value="{{ rem_start_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
            <input id="rem_end" name="rem_end" type="date" value="{{ rem_end_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_limit" style="font-size:0.85rem; color:#555;">Nombre de lignes</label>
            <select id="rem_limit" name="rem_limit" style="padding:8px 12px; height:38px;">
              {% for opt in rem_limit_options %}
                <option value="{{ opt }}" {% if opt == rem_limit %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <input type="hidden" name="rem_page" value="1" />
          <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
        </form>

        {% if rem_error %}
          <div style="margin-top:12px; padding:10px 12px; background:#fdecea; color:#a94442; border-radius:6px;">{{ rem_error }}</div>
        {% else %}
          <div style="margin-top:12px; font-size:0.9rem; color:#555;">
            <div>Période effective (vendredi) :
              {% if rem_start_effective and rem_end_effective %}
                du {{ rem_start_effective.strftime('%d/%m/%Y') }} au {{ rem_end_effective.strftime('%d/%m/%Y') }}
              {% else %}
                non définie
              {% endif %}
            </div>
            <div>Total commissions dues : <strong>{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} €</strong></div>
          </div>

          <div style="overflow-x:auto; margin-top:12px;">
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Contrats</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation totale</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Commission frais de gestion</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rem_rows %}
                  <tr>
                    <td style="padding:8px;">{{ row.date.strftime('%d/%m/%Y') if row.date else row.date or 'N/A' }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.contracts_count }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.total_valorisation or 0).replace(',', ' ') }} €</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.commission or 0).replace(',', ' ') }} €</td>
                </tr>
              {% endfor %}
              {% if not rem_rows %}
                <tr>
                  <td colspan="4" style="padding:8px; color:#666;">Aucune donnée disponible pour cette période.</td>
                </tr>
              {% endif %}
            </tbody>
            <tfoot>
              <tr>
                <th style="padding:8px; text-align:left;">Total période</th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} €</th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div style="margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; font-size:0.9rem; color:#555;">
          {% if rem_has_prev %}
            <a href="{{ rem_prev_url }}#remToggle" class="btn btn-choice" title="Page précédente"><i class="fa-solid fa-arrow-left"></i></a>
          {% endif %}
          <span>Page {{ rem_page }} / {{ rem_total_pages }}</span>
          {% if rem_has_next %}
            <a href="{{ rem_next_url }}#remToggle" class="btn btn-choice" title="Page suivante"><i class="fa-solid fa-arrow-right"></i></a>
          {% endif %}
        </div>
        <div style="margin-top:6px; font-size:0.85rem; color:#777;">
          Semaines {{ rem_page_start }} à {{ rem_page_end }} sur {{ rem_rows_count }}.
        </div>
      {% endif %}
    {% endif %}
    <div class="card" style="text-align:left; margin-top:12px;">
      <h3 style="margin-top:0;">Rétrocession des supports</h3>
      {% if retro_error %}
        <div style="margin:0; color:#a94442; background:#fdecea; padding:10px 12px; border-radius:6px;">{{ retro_error }}</div>
      {% elif not retro_contracts %}
        <p style="margin:0; color:#555;">Aucun contrat générique actif disponible. Veuillez en créer un dans les paramètres.</p>
      {% else %}
        <form id="retroForm" method="get" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
          <input id="retroHiddenRemContract" type="hidden" name="rem_contract" value="{{ rem_selected_contract }}" />
          <input id="retroHiddenRemStart" type="hidden" name="rem_start" value="{{ rem_start_input }}" />
          <input id="retroHiddenRemEnd" type="hidden" name="rem_end" value="{{ rem_end_input }}" />
          <input type="hidden" name="rem_limit" value="{{ rem_limit }}" />
          <input type="hidden" name="rem_page" value="{{ rem_page }}" />
          <div style="display:flex; flex-direction:column;">
            <label for="ret_contract" style="font-size:0.85rem; color:#555;">Contrat générique</label>
            <select id="ret_contract" name="ret_contract" style="min-width:220px; padding:8px 12px; height:38px;">
              {% for contrat in retro_contracts %}
                <option value="{{ contrat.id }}" {% if contrat.id == retro_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="ret_start" style="font-size:0.85rem; color:#555;">Date de début</label>
            <input id="ret_start" name="ret_start" type="date" value="{{ retro_start_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="ret_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
            <input id="ret_end" name="ret_end" type="date" value="{{ retro_end_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="ret_sort" style="font-size:0.85rem; color:#555;">Tri</label>
            <select id="ret_sort" name="ret_sort" style="padding:8px 12px; height:38px;">
              <option value="date_desc" {% if retro_sort == 'date_desc' %}selected{% endif %}>Date décroissante</option>
              <option value="date_asc" {% if retro_sort == 'date_asc' %}selected{% endif %}>Date croissante</option>
              <option value="retrocession_desc" {% if retro_sort == 'retrocession_desc' %}selected{% endif %}>Rétrocession décroissante</option>
              <option value="retrocession_asc" {% if retro_sort == 'retrocession_asc' %}selected{% endif %}>Rétrocession croissante</option>
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="ret_week_limit" style="font-size:0.85rem; color:#555;">Lignes (semaines)</label>
            <select id="ret_week_limit" name="ret_week_limit" style="padding:8px 12px; height:38px;">
              {% for opt in retro_week_limit_options %}
                <option value="{{ opt }}" {% if opt == retro_week_limit %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="ret_support_limit" style="font-size:0.85rem; color:#555;">Lignes (supports)</label>
            <select id="ret_support_limit" name="ret_support_limit" style="padding:8px 12px; height:38px;">
              {% for opt in retro_support_limit_options %}
                <option value="{{ opt }}" {% if opt == retro_support_limit %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="ret_promoteur" style="font-size:0.85rem; color:#555;">Promoteur contient</label>
            <input id="ret_promoteur" name="ret_promoteur" type="text" value="{{ retro_promoteur }}" placeholder="(optionnel)" style="padding:6px 8px;" />
          </div>
          <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
        </form>

        <div style="margin-top:12px; font-size:0.9rem; color:#555;">
          <div>Période effective (vendredi) :
            {% if retro_start_effective and retro_end_effective %}
              du {{ retro_start_effective.strftime('%d/%m/%Y') }} au {{ retro_end_effective.strftime('%d/%m/%Y') }}
            {% else %}
              non définie
            {% endif %}
          </div>
          <div>Total rétrocessions (semaines sélectionnées) : <strong>{{ '{:,.2f}'.format(retro_total_week).replace(',', ' ') }}</strong></div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:14px; margin-top:12px;">
          <div style="overflow-x:auto;">
            <h4 style="margin:0 0 6px;">Rétrocession par semaines</h4>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Nb contrats</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Rétrocession</th>
                </tr>
              </thead>
              <tbody>
                {% for row in retro_weeks %}
                  <tr>
                    <td style="padding:8px;">{{ row.date_str }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.nb_contrats }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.valo_total_str }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                  </tr>
                {% endfor %}
                {% if not retro_weeks %}
                  <tr><td colspan="4" style="padding:8px; color:#666;">Aucune donnée pour cette période.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div style="overflow-x:auto;">
            <h4 style="margin:0 0 6px;">Rétrocession par support financier</h4>
            <table style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">ISIN</th>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Support</th>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Promoteur</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Rétrocession</th>
                </tr>
              </thead>
              <tbody>
                {% for row in retro_supports %}
                  <tr>
                    <td style="padding:8px;">{{ row.code_isin }}</td>
                    <td style="padding:8px;">{{ row.support_nom }}</td>
                    <td style="padding:8px;">{{ row.promoteur }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                  </tr>
                {% endfor %}
                {% if not retro_supports %}
                  <tr><td colspan="4" style="padding:8px; color:#666;">Aucun support trouvé pour cette période.</td></tr>
                {% endif %}
              </tbody>
            </table>
            <div style="margin-top:6px; font-size:0.85rem; color:#777;">Total rétrocessions (supports listés) : {{ '{:,.2f}'.format(retro_total_support).replace(',', ' ') }}</div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
  <div id="remRetroToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer; background: var(--primary); color:#fff; border:1px solid var(--primary); display:none;">
    <h3 style="margin:0; font-size:1.0rem; color:#fff;">Rétrocession support</h3>
    <span class="chevron" style="color:#fff;">▾</span>
  </div>
  <div id="remRetroSection" style="display:none;">
    <!-- Rétrocession déplacée dans le bloc Frais de gestion -->
  </div>
</div>

<!-- Accordéon Gestion des groupes -->
<div id="groupsToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Gestion des groupes</h3>
  <span class="chevron">▾</span>
</div>
<div id="groupsSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" style="text-align:left;">
    <p style="margin:0; color:#555;">En cours de développement.</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
  // Chart.js texte/axes en bleu corporate
  try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
  function toChartData(items, labelKey, valueKey) {
    const labels = items.map(i => 'SRRI ' + (i[labelKey] ?? 'N/A'));
    const data = items.map(i => Number(i[valueKey] || 0));
    return { labels, data };
  }

  const cc = toChartData({{ srri_clients_count | tojson }}, 'srri', 'nb');
  const ac = toChartData({{ srri_affaires_count | tojson }}, 'srri', 'nb');
  const ca = toChartData({{ srri_clients_amount | tojson }}, 'srri', 'total');
  const aa = toChartData({{ srri_affaires_amount | tojson }}, 'srri', 'total');
  const cb_labels = [{% for b in clients_buckets %}'{{ b.label }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const cb_data = [{% for b in clients_buckets %}{{ b.nb }}{% if not loop.last %}, {% endif %}{% endfor %}];
  if (cb_labels && cb_labels.length){ cb_labels[cb_labels.length-1] = 'Sup. 5M'; }

  function makeBar(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' €' : v; } } }
        }
      }
    });
  }

  // Variante plein conteneur (hauteur contrôlée par CSS, ex: 25vh)
  function makeBarFill(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' €' : v; } } } }
      }
    });
  }

  // Build charts (non cliquables)
  makeBar('chartClientsCount', cc.labels, cc.data, false);
  makeBar('chartAffairesCount', ac.labels, ac.data, false);
  makeBar('chartClientsAmount', ca.labels, ca.data, true);
  makeBar('chartAffairesAmount', aa.labels, aa.data, true);
  // Buckets chart (first): height reduced above
  makeBarFill('chartClientsBuckets', cb_labels, cb_data, false);

  // ------- Tâches: datasets -------
  const tasksStatut = {{ tasks_statut | tojson }};
  const tasksCategorie = {{ tasks_categorie | tojson }};
  const tasksDays = {{ tasks_days | tojson }};
  const ts_labels = tasksStatut.map(x => (x.statut || 'n/a'));
  const ts_data = tasksStatut.map(x => x.nb || 0);
  const tc_labels = tasksCategorie.map(x => (x.categorie || 'n/a'));
  const tc_data = tasksCategorie.map(x => x.nb || 0);
  const td_labels = tasksDays.map(x => x.day);
  const td_data = tasksDays.map(x => x.nb || 0);
  // Draw
  if (document.getElementById('chartTasksStatut')) makeBar('chartTasksStatut', ts_labels, ts_data, false);
  if (document.getElementById('chartTasksCategorie')) makeBar('chartTasksCategorie', tc_labels, tc_data, false);
  if (document.getElementById('chartTasksDays')) makeBarFill('chartTasksDays', td_labels, td_data, false);
  const tdist = {{ tasks_close_dist | tojson }};
  const tdist_labels = tdist.map(x => x.bucket);
  const tdist_data = tdist.map(x => x.nb || 0);
  if (document.getElementById('chartTasksCloseDist')) makeBarFill('chartTasksCloseDist', tdist_labels, tdist_data, false);

  // -------- Graphique: Nb de tâches par type (avec filtre RH) --------
  (function(){
    const byRh = {{ tasks_type_by_rh | tojson }} || [];
    const totals = {{ tasks_type_total | tojson }} || [];
    const sel = document.getElementById('tasksRhSelect');
    const canvas = document.getElementById('chartTasksType');
    if (!sel || !canvas) return;
    // Options RH (uniques, non vides)
    const rhPairs = [];
    const seen = new Set();
    byRh.forEach(r => { if (r.rh_id != null && r.rh_nom){ const key = r.rh_id+""; if(!seen.has(key)){ seen.add(key); rhPairs.push({id:r.rh_id, nom:r.rh_nom}); } } });
    rhPairs.sort((a,b)=> String(a.nom).localeCompare(String(b.nom),'fr',{sensitivity:'base'}));
    rhPairs.forEach(p=>{ const o=document.createElement('option'); o.value=String(p.id); o.textContent=p.nom; sel.appendChild(o); });
    let chartInst = null;
    function draw(rhId){
      // Build map type->nb
      const map = new Map();
      if (rhId){
        byRh.filter(r => String(r.rh_id) === String(rhId)).forEach(r => { map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
      } else {
        (totals||[]).forEach(r => { map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
      }
      const entries = Array.from(map.entries()).sort((a,b)=> b[1]-a[1]);
      const labels = entries.map(e=> e[0]);
      const data = entries.map(e=> e[1]);
      if (chartInst) { chartInst.destroy(); chartInst = null; }
      const ctx = canvas.getContext('2d');
      chartInst = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }]}, options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } } });
    }
    sel.addEventListener('change', function(){ const v = this.value || ''; draw(v||null); });
    draw(null);
  })();

  (function syncRemRetroForms(){
    const remContract = document.getElementById('rem_contract');
    const remStart = document.getElementById('rem_start');
    const remEnd = document.getElementById('rem_end');
    const retContract = document.getElementById('ret_contract');
    const retStart = document.getElementById('ret_start');
    const retEnd = document.getElementById('ret_end');
    const retroHiddenRemContract = document.getElementById('retroHiddenRemContract');
    const retroHiddenRemStart = document.getElementById('retroHiddenRemStart');
    const retroHiddenRemEnd = document.getElementById('retroHiddenRemEnd');
    if (!remContract || !retContract || !remStart || !remEnd || !retStart || !retEnd) {
      return;
    }
    let syncingFromRem = false;
    let syncingFromRetro = false;

    function copyRemToRetro(){
      if (syncingFromRetro) return;
      syncingFromRem = true;
      if (retContract) retContract.value = remContract.value;
      if (retStart) retStart.value = remStart.value;
      if (retEnd) retEnd.value = remEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = remContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = remStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = remEnd.value;
      syncingFromRem = false;
    }

    function copyRetroToRem(){
      if (syncingFromRem) return;
      syncingFromRetro = true;
      if (remContract) remContract.value = retContract.value;
      if (remStart) remStart.value = retStart.value;
      if (remEnd) remEnd.value = retEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = retContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = retStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = retEnd.value;
      syncingFromRetro = false;
    }

    copyRemToRetro();

    remContract.addEventListener('change', copyRemToRetro);
    remStart.addEventListener('change', copyRemToRetro);
    remEnd.addEventListener('change', copyRemToRetro);
    retContract.addEventListener('change', copyRetroToRem);
    retStart.addEventListener('change', copyRetroToRem);
    retEnd.addEventListener('change', copyRetroToRem);
  })();

  // Accordéons (un seul ouvert à la fois, possibilité de tout fermer)
  (function(){
    const groups = [
      { key:'risks', toggle:'risksToggle', section:'risksSection' },
      { key:'analysis', toggle:'analysisToggle', section:'analysisSection' },
      { key:'esg', toggle:'esgToggle', section:'esgSection' },
      { key:'tasks', toggle:'tasksToggle', section:'tasksSection' },
      { key:'rem', toggle:'remToggle', section:'remSection' },
      { key:'groups', toggle:'groupsToggle', section:'groupsSection' },
    ];
    const $ = (id)=> document.getElementById(id);
    function setOpen(key){
      groups.forEach(g => {
        const t = $(g.toggle), s = $(g.section);
        if (!t || !s) return;
        if (g.key === key){ s.style.display = ''; t.classList.remove('collapsed'); }
        else { s.style.display = 'none'; t.classList.add('collapsed'); }
      });
      try { localStorage.setItem('dashboard_open', key || ''); } catch(e) {}
    }
    // Restore saved open section
    let saved = '';
    try { saved = localStorage.getItem('dashboard_open') || ''; } catch(e) {}
    if (saved) setOpen(saved);
    // Wire clicks
    groups.forEach(g => {
      const t = $(g.toggle), s = $(g.section);
      if (!t || !s) return;
      t.addEventListener('click', function(){
        const isOpen = s.style.display !== 'none';
        if (isOpen){
          // Close all (allow collapsing)
          setOpen('');
        } else {
          setOpen(g.key);
          try { t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
        }
      });
    });
  })();

  // Sous-accordéons de l'analyse portefeuille (exclusifs, tous fermés par défaut)
  (function(){
    const pairs = [
      ['clienteleToggle','clienteleSection'],
      ['srriToggle','srriSection'],
      ['financeToggle','financeSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => ({
      t: document.getElementById(tid),
      s: document.getElementById(sid)
    })).filter(o => o.t && o.s);
    function closeAll(){ nodes.forEach(o => { o.s.style.display='none'; o.t.classList.add('collapsed'); }); }
    nodes.forEach(o => {
      o.t.addEventListener('click', function(){
        const isOpen = o.s.style.display !== 'none';
        if (isOpen){ closeAll(); }
        else { closeAll(); o.s.style.display=''; o.t.classList.remove('collapsed'); try{ o.t.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(e){} }
      });
      o.t.classList.add('collapsed');
      o.s.style.display = 'none';
    });
  })();

  // Sous-accordéons Rémunérations (exclusifs, tous fermés par défaut)
  (function(){
    const pairs = [
      ['remFraisToggle','remFraisSection'],
      ['remRetroToggle','remRetroSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => ({
      t: document.getElementById(tid),
      s: document.getElementById(sid)
    })).filter(o => o.t && o.s);
    function closeAll(){ nodes.forEach(o => { o.s.style.display='none'; o.t.classList.add('collapsed'); }); }
    nodes.forEach(o => {
      o.t.addEventListener('click', function(){
        const isOpen = o.s.style.display !== 'none';
        if (isOpen){ closeAll(); }
        else { closeAll(); o.s.style.display=''; o.t.classList.remove('collapsed'); try{ o.t.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(e){} }
      });
      o.t.classList.add('collapsed');
      o.s.style.display = 'none';
    });
  })();

  

  // ESG Global logic (similar to Affaire/Client)
  (function(){
    var allocSel = document.getElementById('esgAllocSelectGlobal');
    var allocDateSel = document.getElementById('esgAllocDateGlobal');
    var fieldsWrap = document.getElementById('esgFieldsGlobal');
    var refreshBtn = document.getElementById('esgRefreshBtnGlobal');
    if (!allocSel || !fieldsWrap) return;

    var keyAlloc = 'global_esg_alloc';
    var keyFields = 'global_esg_fields';
    var keyAllocDate = 'global_esg_alloc_date';

    function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field-global.btn-choice-active')).map(b=> b.getAttribute('data-field')); }
    fieldsWrap.addEventListener('click', function(e){
      var b=e.target.closest('.esg-field-global'); if(!b) return;
      var sel = selectedFields();
      if (b.classList.contains('btn-choice-active')){ b.classList.remove('btn-choice-active'); }
      else { if (sel.length >= 4) return; b.classList.add('btn-choice-active'); }
      try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
      drawESG();
    });

    function ensurePlotly(cb){ if (window.Plotly) { cb(); return; } var s=document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ cb(); }; document.head.appendChild(s); }
    function drawESG(){
      var fields = selectedFields();
      var alloc = allocSel.value || '';
      var allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
      if (!fields.length || !alloc) return;
      ensurePlotly(function(){
        var url = `/dashboard/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}&debug=1` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'');
        fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          var rows = (data && data.results) || [];
          // Keep only rows with at least one value
          rows = rows.filter(r => r && (r.global != null || r.index != null));
          var cats = rows.map(r=> r.field);
          // Normalize: index baseline 100; portfolio = (global_raw / index_raw) * 100
          var idx = rows.map(function(r){
            if (r.index != null) return Number(r.index);
            if (r.index_raw != null) return 100;
            return null;
          });
          var g = rows.map(function(r){
            if (r.global != null) return Number(r.global);
            var pr = (r.global_raw==null? null : Number(r.global_raw));
            var ir = (r.index_raw==null? null : Number(r.index_raw));
            if (pr==null || ir==null || ir===0) return null;
            return (pr/ir)*100.0;
          });
          // If portfolio values are all null, nothing to plot
          if (!g.length || g.every(v => v == null)) { g = cats.map(() => null); }
          var traces = [
            { x: idx, y: cats, type:'bar', orientation:'h', name:(alloc||'Indice'), marker:{ color:'#9ca3af' } },
            { x: g, y: cats, type:'bar', orientation:'h', name:'Portefeuille', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
          ];
          var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
          var cfg = { displayModeBar: false, responsive: true };
          Plotly.react('esgChartGlobal', traces, layout, cfg);
          // Debug panel (only raw values table)
          try {
            var dbgWrap = document.getElementById('esgDebugPanelGlobal');
            if (dbgWrap){
              var d = data && data.debug ? data.debug : null;
              if (d){
                function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                var html = '';
                try {
                  var prow = d.portfolio_raw || {};
                  var irow = d.index_raw || {};
                  if (fields && fields.length){
                    html += '<div style="margin-top:6px;"><strong>Valeurs brutes (par champ)</strong>';
                    html += '<table style="border-collapse:collapse; margin-top:4px; font-family:monospace; font-size:12px;">';
                    html += '<tr><th style="text-align:left; padding-right:12px;">Champ</th><th style="text-align:right; padding-right:12px;">' + esc(alloc||'Indice') + '</th><th style="text-align:right;">Portefeuille</th></tr>';
                    fields.forEach(function(f){
                      var iv = irow && Object.prototype.hasOwnProperty.call(irow, f) ? irow[f] : null;
                      var pv = prow && Object.prototype.hasOwnProperty.call(prow, f) ? prow[f] : null;
                      function fmt(v){ if(v==null||v===undefined||Number.isNaN(Number(v))) return '-'; try{ var n=Number(v); return (Math.abs(n)>=1000? n.toFixed(2): n.toFixed(4)); }catch(_e){ return esc(String(v)); } }
                      html += '<tr><td style="padding-right:12px;">' + esc(f) + '</td>'+
                              '<td style="text-align:right; padding-right:12px;">' + fmt(iv) + '</td>'+
                              '<td style="text-align:right;">' + fmt(pv) + '</td></tr>';
                    });
                    html += '</table></div>';
                  }
                } catch(_er) {}
                dbgWrap.innerHTML = html;
                dbgWrap.style.display='';
                try { document.getElementById('esgSqlGlobalDetails').open = true; } catch(_e) {}
              }
            }
          } catch(_e) {}
        }).catch(function(err){ try{ console.error('Global ESG fetch error', err); }catch(_){} });
      });
    }

    function loadAllocDates(preferred){
      if (!allocSel || !allocSel.value) { if (allocDateSel) allocDateSel.innerHTML=''; return; }
      fetch(`/dashboard/allocations/dates?name=${encodeURIComponent(allocSel.value)}`)
        .then(r=>r.json()).then(function(data){
          if (!allocDateSel) return;
          allocDateSel.innerHTML = '';
          var ds = (data && data.dates) || [];
          ds.forEach(function(d){ var o=document.createElement('option'); o.value=d; o.textContent=d; allocDateSel.appendChild(o); });
          var selected = false;
          if (preferred){ for (var i=0;i<allocDateSel.options.length;i++){ if (allocDateSel.options[i].value===preferred){ allocDateSel.selectedIndex=i; selected=true; break; } } }
          if (!selected && allocDateSel.options.length>0) allocDateSel.selectedIndex = 0;
          drawESG();
        }).catch(function(e){ try{ console.warn('alloc dates (global)', e);}catch(_){} });
    }

    allocSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAlloc, allocSel.value||''); }catch(_e){}; try{ localStorage.removeItem(keyAllocDate); }catch(_e){}; loadAllocDates(); });
    if (allocDateSel) allocDateSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAllocDate, allocDateSel.value||''); }catch(_e){}; drawESG(); });
    if (refreshBtn) refreshBtn.addEventListener('click', drawESG);

    // Init
    (function init(){
      try{
        var savedAlloc = localStorage.getItem(keyAlloc) || '';
        if (savedAlloc){ var found=false; for (var i=0;i<allocSel.options.length;i++){ if (allocSel.options[i].value===savedAlloc){ allocSel.selectedIndex=i; found=true; break; } } if(!found) savedAlloc=''; }
        if (!savedAlloc){ for (var j=0;j<allocSel.options.length;j++){ if (allocSel.options[j].value){ allocSel.selectedIndex=j; savedAlloc=allocSel.options[j].value; break; } } if (savedAlloc){ try{ localStorage.setItem(keyAlloc, savedAlloc);}catch(_e){} } }
      }catch(_e){}
      try{
        var raw = localStorage.getItem(keyFields); var saved=[]; if (raw){ try{ saved=JSON.parse(raw)||[]; }catch(_ee){ saved=[]; } }
        var buttons = Array.from(fieldsWrap.querySelectorAll('.esg-field-global'));
        buttons.forEach(b=> b.classList.remove('btn-choice-active'));
        if (saved.length){ buttons.forEach(b=> { var v=b.getAttribute('data-field'); if (saved.indexOf(v)>=0) b.classList.add('btn-choice-active'); }); }
        else { buttons.slice(0,3).forEach(b=> b.classList.add('btn-choice-active')); try{ localStorage.setItem(keyFields, JSON.stringify(buttons.slice(0,3).map(b=> b.getAttribute('data-field')))); }catch(_e){} }
      }catch(_e){}
      var preferDate = ''; try{ preferDate = localStorage.getItem(keyAllocDate) || ''; }catch(_e){}
      if (allocSel && allocSel.value){ loadAllocDates(preferDate); } else { drawESG(); }
    })();
  })();
</script>

{% endblock %}
