{% extends "base.html" %}

{% block title %}Tableau de bord{% endblock %}
{% block header_title %}<i class="fa-solid fa-house" style="margin-right:8px;"></i>Tableau de bord{% endblock %}

{% block content %}
<style>
  .home-title { text-align: center; margin: 0 0 1rem 0; }
  .home-sub { text-align: center; margin: 0 0 2rem 0; color: #666; }
  .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; max-width: 1100px; margin: 0 auto 2rem auto; }
  .kpi-card { background:#fff; border-radius:12px; padding:18px; text-align:center; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
  .kpi-card--primary {
    background: var(--primary);
    color: #fff;
  }
  .kpi-card--primary .kpi-value {
    color: #fff;
  }
  .kpi-value { font-size:1.6rem; font-weight:700; margin-top:6px; }
  .charts { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; max-width: 1200px; margin: 0 auto; }
  /* Liens discrets dans la carte Documents */
  .doc-filter-link { text-decoration:none; color:inherit; }
  .doc-filter-link:hover { text-decoration: underline; }
  /* Chevrons accordéon: rotation sur fermeture */
  div[id$='Toggle'] {
    transition: background .2s ease, color .2s ease, border .2s ease;
    border: 1px solid var(--border);
    background: #fff;
    color: inherit;
  }
  div[id$='Toggle']:not(.collapsed) {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  div[id$='Toggle']:not(.collapsed) h3,
  div[id$='Toggle']:not(.collapsed) .chevron {
    color: #fff;
  }
  div[id$='Toggle'] .chevron {
    transition: transform .2s ease;
    color: var(--primary);
  }
  div[id$='Toggle'].collapsed .chevron {
    transform: rotate(-90deg);
  }
  /* Risk dots */
  .dot { display:inline-block; width: 0.9em; height: 0.9em; border-radius: 50%; vertical-align: middle; margin-right: 6px; }
  .dot-red { background:#ef4444; }
  .dot-green { background:#16a34a; }
  .dot-blue { background:#3b82f6; }
  .risk-card-title {
    margin:0;
    font-size:1.05rem;
    background:var(--primary);
    color:#fff;
    padding:6px 12px;
    border-radius:8px;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  /* ESG global: boutons compacts */
  #esgSection .esg-field-global {
    font-size: 10px;
    padding: 2px 6px;
    height: auto;
    line-height: 1.2;
    border-radius: 6px;
    margin: 2px;
  }
  /* Dropdown RH width control */
  #tasksRhSelect { width: 160px; max-width: 160px; }
  @media (max-width: 480px) { #tasksRhSelect { width: 140px; max-width: 140px; } }
  .finance-support-link { color:#111827; text-decoration:underline; }
  .finance-support-link:hover { text-decoration:none; }
  #financeSupportModal { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:10000; }
  #financeSupportModal .modal-card { background:#fff; border-radius:12px; width:900px; max-width:95vw; max-height:90vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
  #financeSupportModal .modal-header { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border); }
  #financeSupportModal .modal-header h3 { margin:0; font-size:1.05rem; }
  #financeSupportModal .modal-close { border:none; background:transparent; cursor:pointer; font-size:18px; }
  #financeSupportModal .modal-body { padding:12px 14px; }
  #financeSupportModalTable { width:100%; border-collapse:collapse; font-size:0.9rem; }
  #financeSupportModalTable th, #financeSupportModalTable td { padding:10px 12px; border-bottom:1px solid #e2e8f0; }
  #financeSupportModalTable th { background:#1d4ed8; color:#fff; text-transform:none; font-size:0.87rem; text-align:left; }
  #financeSupportModalTable td.numeric { text-align:right; }
  .compliance-progress { margin-top:8px; width:100%; height:1em; display:flex; border-radius:6px; overflow:hidden; background:#e2e8f0; }
  .compliance-progress div { height:100%; }
  .compliance-progress-valid { background:#16a34a; }
  .compliance-progress-obsolete { background:#ef4444; }
  .tb-markers-enabled [data-tb-marker] {
    position: relative;
    outline: 2px dashed rgba(37,99,235,0.35);
  }
  .tb-markers-enabled [data-tb-marker]::before {
    content: attr(data-tb-marker);
    position: absolute;
    top: -12px;
    left: 0;
    background: rgba(37,99,235,0.9);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 20;
    pointer-events: none;
    box-shadow: 0 2px 6px rgba(15,23,42,0.2);
  }
</style>

{% set tb_markers_param = tb_markers_param or '' %}
{% set tb_markers_suffix = ('&' + tb_markers_param) if tb_markers_param else '' %}
<div class="tb-page{% if tb_markers_visible %} tb-markers-enabled{% endif %}" data-tb-marker="TB_01">
  <div data-tb-marker="TB_02" style="text-align:center;">
    <h2 class="home-title" data-tb-marker="TB_03">Tableau de bord</h2>
    <p class="home-sub" data-tb-marker="TB_04">Accès rapide et indicateurs clés</p>
  </div>

<!-- KPIs -->
<div class="kpis" data-tb-marker="TB_05">
  <div class="kpi-card kpi-card--primary" data-tb-marker="TB_06">
    <div>Nombre de placements financiers</div>
    <div class="kpi-value">{{ total_affaires }}</div>
  </div>
  <div class="kpi-card kpi-card--primary" data-tb-marker="TB_07">
    <div>Valorisation totale</div>
    <div class="kpi-value">{{ '{:,.0f}'.format(total_valo or 0).replace(',', ' ') }} €</div>
  </div>
  <div class="kpi-card kpi-card--primary" data-tb-marker="TB_08">
    <div>Nombre de clients</div>
    <div class="kpi-value">{{ total_clients }}</div>
  </div>
</div>

  <!-- Accordéon Tâches en cours (remonté avant Risques) -->
  <div id="tasksToggle" class="card collapsed" data-tb-marker="TB_09" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">Tâches en cours</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="tasksSection" data-tb-marker="TB_10" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div data-tb-marker="TB_11" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
    <div class="muted">Période:</div>
    {% set r = tasks_range or 14 %}
    {% for n in [7,14,30] %}
      {% if n == r %}
        <a class="btn btn-choice btn-choice-active" href="?tasks_range={{ n }}{{ tb_markers_suffix }}#tasksToggle">{{ n }} j</a>
      {% else %}
        <a class="btn btn-choice" href="?tasks_range={{ n }}{{ tb_markers_suffix }}#tasksToggle">{{ n }} j</a>
      {% endif %}
    {% endfor %}
  </div>
  <div class="kpis" data-tb-marker="TB_12" style="grid-template-columns: repeat(4, 1fr);">
    <div class="kpi-card" data-tb-marker="TB_13">
      <div>Tâches totales</div>
      <div class="kpi-value">{{ tasks_total }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_14">
      <div>Ouvertes</div>
      <div class="kpi-value">{{ tasks_open }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_15">
      <div>Clôturées</div>
      <div class="kpi-value">{{ (tasks_total - tasks_open) if tasks_total is not none else 0 }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_16">
      <div>Aujourd'hui</div>
      <div class="kpi-value">{% set today = tasks_days|last %}{{ today.nb if today else 0 }}</div>
    </div>
    <div class="kpi-card" data-tb-marker="TB_17" style="grid-column: 1 / -1; min-height:140px; display:flex; align-items:center; justify-content:center;">
      {% set total_tasks_days = tasks_days | map(attribute='nb') | sum %}
      {% if total_tasks_days and total_tasks_days > 0 %}
        <canvas id="chartTasksDays" height="120"></canvas>
      {% else %}
        <div class="muted">Aucune tâche sur la période sélectionnée</div>
      {% endif %}
    </div>
  </div>
  <div class="card" data-tb-marker="TB_18" style="margin-top:8px;">
    <div data-tb-marker="TB_19" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
      <div class="muted">Filtre par responsable commercial:</div>
      <select id="tasksRhSelect" style="width:160px;">
        <option value="">Tous</option>
      </select>
    </div>
    <div data-tb-marker="TB_20" style="min-height:180px; display:flex; align-items:center; justify-content:center;">
      <canvas id="chartTasksType" height="120"></canvas>
    </div>
  </div>
  </div>

  <!-- Accordéon Risques -->
  <div id="risksToggle" class="card collapsed" data-tb-marker="TB_21" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">Conformité et suivi du risque</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="risksSection" data-tb-marker="TB_22" style="display:none;">
  <!-- Sous-accordéon: Conformité réglementaire -->
  <div id="complianceToggle" class="card collapsed" data-tb-marker="TB_23" style="max-width:900px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Conformité réglementaire</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="complianceSection" data-tb-marker="TB_24" style="display:none;">
    <div class="card" data-tb-marker="TB_25" style="max-width:900px; margin: 0 auto 1rem auto; text-align:center;">
      <div data-tb-marker="TB_26" style="margin-top:12px; display:grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap:12px;">
        {% set der_obsolete_pct = (docs_der_obsolete_pct or 0)|float %}
        {% if der_obsolete_pct < 0 %}{% set der_obsolete_pct = 0.0 %}{% elif der_obsolete_pct > 100 %}{% set der_obsolete_pct = 100.0 %}{% endif %}
        {% set der_valid_pct = 100.0 - der_obsolete_pct %}
        <div data-tb-marker="TB_27" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">DER</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_der_total or 0 }} / {{ '%.1f'|format(docs_der_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_der_obsolete or 0 }} / {{ '%.1f'|format(docs_der_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="DER : {{ der_valid_pct|round(1) }} % valides, {{ der_obsolete_pct|round(1) }} % obsolètes">
            <div class="compliance-progress-valid" style="width: {{ der_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ der_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set cc_obsolete_pct = (docs_cc_obsolete_pct or 0)|float %}
        {% if cc_obsolete_pct < 0 %}{% set cc_obsolete_pct = 0.0 %}{% elif cc_obsolete_pct > 100 %}{% set cc_obsolete_pct = 100.0 %}{% endif %}
        {% set cc_valid_pct = 100.0 - cc_obsolete_pct %}
        <div data-tb-marker="TB_28" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Connaissance client</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_cc_total or 0 }} / {{ '%.1f'|format(docs_cc_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_cc_obsolete or 0 }} / {{ '%.1f'|format(docs_cc_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="Connaissance client : {{ cc_valid_pct|round(1) }} % valides, {{ cc_obsolete_pct|round(1) }} % obsolètes">
            <div class="compliance-progress-valid" style="width: {{ cc_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ cc_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set esg_obsolete_pct = (docs_esg_obsolete_pct or 0)|float %}
        {% if esg_obsolete_pct < 0 %}{% set esg_obsolete_pct = 0.0 %}{% elif esg_obsolete_pct > 100 %}{% set esg_obsolete_pct = 100.0 %}{% endif %}
        {% set esg_valid_pct = 100.0 - esg_obsolete_pct %}
        <div data-tb-marker="TB_29" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">ESG</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_esg_total or 0 }} / {{ '%.1f'|format(docs_esg_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_esg_obsolete or 0 }} / {{ '%.1f'|format(docs_esg_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="ESG : {{ esg_valid_pct|round(1) }} % valides, {{ esg_obsolete_pct|round(1) }} % obsolètes">
            <div class="compliance-progress-valid" style="width: {{ esg_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ esg_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set lm_obsolete_pct = (docs_lm_obsolete_pct or 0)|float %}
        {% if lm_obsolete_pct < 0 %}{% set lm_obsolete_pct = 0.0 %}{% elif lm_obsolete_pct > 100 %}{% set lm_obsolete_pct = 100.0 %}{% endif %}
        {% set lm_valid_pct = 100.0 - lm_obsolete_pct %}
        <div data-tb-marker="TB_30" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Lettres de mission</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_lm_total or 0 }} / {{ '%.1f'|format(docs_lm_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_lm_obsolete or 0 }} / {{ '%.1f'|format(docs_lm_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="Lettres de mission : {{ lm_valid_pct|round(1) }} % valides, {{ lm_obsolete_pct|round(1) }} % obsolètes">
            <div class="compliance-progress-valid" style="width: {{ lm_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ lm_obsolete_pct }}%;"></div>
          </div>
        </div>
        {% set la_obsolete_pct = (docs_la_obsolete_pct or 0)|float %}
        {% if la_obsolete_pct < 0 %}{% set la_obsolete_pct = 0.0 %}{% elif la_obsolete_pct > 100 %}{% set la_obsolete_pct = 100.0 %}{% endif %}
        {% set la_valid_pct = 100.0 - la_obsolete_pct %}
        <div data-tb-marker="TB_31" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Lettres d'adéquation</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ docs_la_total or 0 }} / {{ '%.1f'|format(docs_la_total_pct or 0) }} %</div>
          <div class="muted" style="font-size:0.85rem;">Obsolescence : {{ docs_la_obsolete or 0 }} / {{ '%.1f'|format(docs_la_obsolete_pct or 0) }} %</div>
          <div class="compliance-progress" role="img" aria-label="Lettres d'adéquation : {{ la_valid_pct|round(1) }} % valides, {{ la_obsolete_pct|round(1) }} % obsolètes">
            <div class="compliance-progress-valid" style="width: {{ la_valid_pct }}%;"></div>
            <div class="compliance-progress-obsolete" style="width: {{ la_obsolete_pct }}%;"></div>
          </div>
        </div>
        <div data-tb-marker="TB_32" style="background:#fff; border:1px solid var(--primary); border-radius:10px; padding:12px; text-align:center; box-shadow:0 2px 8px rgba(15,23,42,0.08);">
          <div style="font-weight:600; margin-bottom:6px; background:#f1f5f9; border-radius:8px; padding:6px;">Réclamations</div>
          <div class="muted" style="font-size:0.85rem;">Total : {{ reclam_stats.total or 0 }}</div>
          <div class="muted" style="font-size:0.85rem;">À faire : {{ reclam_stats.a_faire or 0 }}</div>
          <div class="muted" style="font-size:0.85rem;">En cours : {{ reclam_stats.en_cours or 0 }}</div>
          <div class="muted" style="font-size:0.85rem;">En attente : {{ reclam_stats.en_attente or 0 }}</div>
          <div class="muted" style="font-size:0.85rem;">Terminées : {{ reclam_stats.terminees or 0 }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sous-accordéon: Répartition par clientèle -->
  <div id="clienteleToggle" class="card collapsed" data-tb-marker="TB_33" style="max-width:900px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Répartition par clientèle</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="clienteleSection" data-tb-marker="TB_34" style="display:none;">
    <div class="card" data-tb-marker="TB_35" style="max-width: 900px; margin: 0 auto 1rem auto; height: calc(18vh + 50px); display:flex; flex-direction:column;">
      <h3>Découpage clients par détention</h3>
      <canvas id="chartClientsBuckets" style="flex:1 1 auto; min-height:0;"></canvas>
    </div>
  </div>

  <!-- Sous-accordéon: Répartitions SRRI -->
  <div id="srriToggle" class="card collapsed" data-tb-marker="TB_36" style="max-width:900px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Suivi du risque</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="srriSection" data-tb-marker="TB_37" style="display:none;">
    <div class="card" data-tb-marker="TB_38" style="max-width:360px; margin: 0 auto 1rem auto; text-align:center;">
      <div data-tb-marker="TB_39" style="display:flex; align-items:center; justify-content:center; gap:8px;">
        <h3 class="risk-card-title">Clients</h3>
      </div>
      <div data-tb-marker="TB_40" style="margin-top:8px; font-size:0.9rem; line-height:1.6; text-align:center;">
        <div data-tb-marker="TB_41">
          <a href="/dashboard/clients?risk=above" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
            <span class="dot dot-red"></span><strong>{{ cli_risk_counts.above }}</strong> — Au‑dessus du risque
          </a>
        </div>
        <div data-tb-marker="TB_42">
          <a href="/dashboard/clients?risk=equal" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
            <span class="dot dot-green"></span><strong>{{ cli_risk_counts.equal }}</strong> — Dans le risque
          </a>
        </div>
        <div data-tb-marker="TB_43">
          <a href="/dashboard/clients?risk=below" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
            <span class="dot dot-blue"></span><strong>{{ cli_risk_counts.below }}</strong> — Sous le risque
          </a>
        </div>
      </div>
    </div>
    <div class="charts" data-tb-marker="TB_44" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); max-width:1100px; margin:0 auto;">
      <div class="card" data-tb-marker="TB_45">
        <h3>Clients par SRRI</h3>
        <canvas id="chartClientsCount"></canvas>
      </div>
      <div class="card" data-tb-marker="TB_46">
        <h3>Montant par SRRI (Clients)</h3>
        <canvas id="chartClientsAmount"></canvas>
      </div>
    </div>
    <div class="card" data-tb-marker="TB_47" style="max-width:360px; margin: 0 auto 1rem auto; text-align:center;">
      <div data-tb-marker="TB_48" style="display:flex; align-items:center; justify-content:center; gap:8px;">
        <h3 class="risk-card-title">Affaires</h3>
      </div>
      <div data-tb-marker="TB_49" style="margin-top:8px; font-size:0.9rem; line-height:1.6; text-align:center;">
        <div data-tb-marker="TB_50">
          <a href="/dashboard/affaires?risk=above" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
            <span class="dot dot-red"></span><strong>{{ aff_risk_counts.above }}</strong> — Au‑dessus du risque
          </a>
        </div>
        <div data-tb-marker="TB_51">
          <a href="/dashboard/affaires?risk=equal" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
            <span class="dot dot-green"></span><strong>{{ aff_risk_counts.equal }}</strong> — Dans le risque
          </a>
        </div>
        <div data-tb-marker="TB_52">
          <a href="/dashboard/affaires?risk=below" style="text-decoration:none; color:inherit;" target="_blank" rel="noopener noreferrer">
            <span class="dot dot-blue"></span><strong>{{ aff_risk_counts.below }}</strong> — Sous le risque
          </a>
        </div>
      </div>
    </div>
    <div class="charts" data-tb-marker="TB_53" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); max-width:1100px; margin:0 auto;">
      <div class="card" data-tb-marker="TB_54">
        <h3>Affaires par SRRI</h3>
        <canvas id="chartAffairesCount"></canvas>
      </div>
      <div class="card" data-tb-marker="TB_55">
        <h3>Montant par SRRI (Affaires)</h3>
        <canvas id="chartAffairesAmount"></canvas>
      </div>
    </div>
  </div>

  </div>

<!-- Accordéon Analyse portefeuille -->
<div id="analysisToggle" class="card collapsed" data-tb-marker="TB_56" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Analyse portefeuille</h3>
  <span class="chevron">▾</span>
 </div>
<div id="analysisSection" data-tb-marker="TB_57" style="display:none;">
  <div class="card" data-tb-marker="TB_58" style="max-width:1100px; margin: 0 auto 1rem auto; text-align:left;">
    <h3 style="margin-top:0;">Analyse financière — Répartition des supports</h3>
    <form method="get" action="/dashboard#analysisToggle" data-tb-marker="TB_59" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
      {% if tb_markers_param %}
        <input type="hidden" name="markers" value="1" />
      {% endif %}
      <div>
        <label class="muted" style="font-size:0.85rem;">Date d'analyse</label><br>
        <input type="date" name="finance_date" value="{{ finance_date_input }}" style="height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;" />
      </div>
      <div>
        <label class="muted" style="font-size:0.85rem;">Responsable commercial</label><br>
        <select name="finance_rh" style="min-width:220px; height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;">
          <option value="">Tous</option>
          {% for rh in finance_rh_options %}
            <option value="{{ rh.id }}" {% if finance_rh_selected is not none and rh.id == finance_rh_selected %}selected{% endif %}>{{ rh.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="muted" style="font-size:0.85rem;">Valorisation</label><br>
        <input type="text" name="finance_valo" value="{{ finance_valo_input or '' }}" placeholder=">100k, 100k-500k" style="min-width:200px; height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;" />
      </div>
      <div>
        <button type="submit" class="btn-primary" style="height:36px;">Filtrer</button>
      </div>
      <div>
        <button type="button" class="btn" id="finance_export_btn" style="height:36px;">Exporter CSV</button>
      </div>
    </form>
    <div class="muted" style="margin-top:8px; font-size:0.85rem;">Date retenue : {{ finance_effective_date_display }}</div>
    <div style="margin-top:4px; font-weight:600;">Total valorisation : {{ finance_total_valo_str }} €</div>
    {% if finance_supports %}
    <div data-tb-marker="TB_60" style="margin-top:12px; overflow-x:auto;">
      <table data-tb-marker="TB_61" style="width:100%; border-collapse:collapse; font-size:0.9rem;">
        <thead>
          <tr style="background:#f1f5f9; text-align:left;">
            <th style="padding:6px 10px;">Code ISIN</th>
            <th style="padding:6px 10px;">Support</th>
            <th style="padding:6px 10px;">Catégorie principale</th>
            <th style="padding:6px 10px;">Catégorie géo</th>
            <th style="padding:6px 10px;">SRRI</th>
            <th style="padding:6px 10px; text-align:right;">Valorisation</th>
          </tr>
        </thead>
        <tbody>
          {% for sup in finance_supports %}
          <tr{% if loop.index is even %} style="background:#f8fafc;"{% endif %}>
            <td style="padding:6px 10px;">
              {% if sup.code_isin %}
                <a href="#" class="finance-support-link" data-support-code="{{ sup.code_isin }}" data-support-name="{{ sup.nom or '' }}" data-clients='{{ sup.clients | tojson | safe }}'>{{ sup.code_isin }}</a>
              {% else %}
                {{ sup.code_isin or '—' }}
              {% endif %}
            </td>
            <td style="padding:6px 10px;">{{ sup.nom or '—' }}</td>
            <td style="padding:6px 10px;">{{ sup.cat_principale or '—' }}</td>
            <td style="padding:6px 10px;">{{ sup.cat_geo or '—' }}</td>
            <td style="padding:6px 10px;">{{ sup.srri if sup.srri is not none else '—' }}</td>
            <td style="padding:6px 10px; text-align:right;">{{ sup.total_valo_str }} €</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="financeSupportModal" onclick="if(event.target===this) closeFinanceSupportModal()">
      <div class="modal-card">
        <div class="modal-header">
          <h3><i class="fa-solid fa-users-line" style="margin-right:8px;"></i><span id="financeSupportModalLabel">Clients par support</span></h3>
          <button class="modal-close" onclick="closeFinanceSupportModal()">✕</button>
        </div>
        <div class="modal-body">
          <table id="financeSupportModalTable">
            <thead>
              <tr>
                <th>Client</th>
                <th>Contrat</th>
                <th style="text-align:right;">Valorisation</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    {% else %}
    <div class="muted" style="margin-top:12px;">Aucune donnée pour les critères sélectionnés.</div>
    {% endif %}
  </div>
</div>

<!-- Accordéon ESG (global) -->
<div id="esgToggle" class="card collapsed" data-tb-marker="TB_62" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">ESG</h3>
  <span class="chevron">▾</span>
</div>
<div id="esgSection" data-tb-marker="TB_63" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" data-tb-marker="TB_64" style="text-align:left;">
    <h3 style="margin-top:0;">Comparaison ESG Portefeuille vs Indice - global</h3>
    <div data-tb-marker="TB_65" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px 0;">
      <div data-tb-marker="TB_66">
        <label class="muted" style="font-size:0.85rem;">Allocation de référence</label><br>
        <select id="esgAllocSelectGlobal" style="min-width:220px; max-width:280px; width:auto;">
          <option value="">— choisir —</option>
          {% for nm in alloc_names %}<option value="{{ nm }}">{{ nm }}</option>{% endfor %}
        </select>
      </div>
      <div data-tb-marker="TB_67" style="display:none;">
        <label class="muted" style="font-size:0.85rem;">Date</label><br>
        <select id="esgAllocDateGlobal" style="width: 14ch; min-width: 14ch;"></select>
      </div>
      <div data-tb-marker="TB_68" style="flex:1 1 auto; min-width:260px;">
        <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
        <div id="esgFieldsGlobal" data-tb-marker="TB_69" style="display:flex; gap:6px; flex-wrap:wrap;">
          {% for it in esg_fields %}
            {% set col = it.col if it is mapping else it %}
            {% set label = it.label if it is mapping else it %}
            <button type="button" class="btn btn-choice esg-field-global" data-field="{{ col }}" title="{{ label }}">{{ label }}</button>
          {% endfor %}
        </div>
      </div>
    </div>
    <div id="esgChartGlobal" data-tb-marker="TB_70" style="height:320px; width:100%;"></div>
    <div class="muted" style="margin-top:6px; font-size:12px;">Indice normalisé à 100. Portefeuille = valeur relative (Portefeuille / Indice × 100).</div>
    <details id="esgSqlGlobalDetails" data-tb-marker="TB_71" style="margin-top:8px;">
      <summary class="muted" style="cursor:pointer;">Voir les données brutes</summary>
      <div id="esgDebugPanelGlobal" class="muted" style="font-size:12px; display:none;"></div>
    </details>
  </div>
</div>

<!-- Tâches (déplacé plus haut) -->

<!-- Accordéon Rémunérations -->
<div id="remToggle" class="card collapsed" data-tb-marker="TB_75" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Rémunérations</h3>
  <span class="chevron">▾</span>
</div>
<div id="remSection" data-tb-marker="TB_76" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <!-- Sous-accordéon: Frais de gestion -->
  <div id="remFraisToggle" class="card collapsed" data-tb-marker="TB_77" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.0rem;">Frais de gestion</h3>
    <span class="chevron">▾</span>
  </div>
  <div id="remFraisSection" data-tb-marker="TB_78" style="display:none;">
    <div class="card" data-tb-marker="TB_79" style="text-align:left;">
      <h3 style="margin-top:0;">Commissions sur frais de gestion</h3>
      {% if not rem_contracts %}
        <p style="margin:0; color:#555;">Aucun contrat générique actif disponible. Veuillez en créer un dans les paramètres.</p>
      {% else %}
        <form id="remForm" method="get" data-tb-marker="TB_80" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
          {% if tb_markers_param %}
            <input type="hidden" name="markers" value="1" />
          {% endif %}
          <div style="display:flex; flex-direction:column;">
            <label for="rem_contract" style="font-size:0.85rem; color:#555;">Contrat générique</label>
            <select id="rem_contract" name="rem_contract" style="min-width:220px; padding:8px 12px; height:38px;">
              {% for contrat in rem_contracts %}
                <option value="{{ contrat.id }}" {% if contrat.id == rem_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_start" style="font-size:0.85rem; color:#555;">Date de début</label>
            <input id="rem_start" name="rem_start" type="date" value="{{ rem_start_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
            <input id="rem_end" name="rem_end" type="date" value="{{ rem_end_input }}" style="padding:6px 8px;" />
          </div>
          <div style="display:flex; flex-direction:column;">
            <label for="rem_limit" style="font-size:0.85rem; color:#555;">Nombre de lignes</label>
            <select id="rem_limit" name="rem_limit" style="padding:8px 12px; height:38px;">
              {% for opt in rem_limit_options %}
                <option value="{{ opt }}" {% if opt == rem_limit %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <input type="hidden" name="rem_page" value="1" />
          <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
        </form>

        {% if rem_error %}
          <div style="margin-top:12px; padding:10px 12px; background:#fdecea; color:#a94442; border-radius:6px;">{{ rem_error }}</div>
        {% else %}
          <div data-tb-marker="TB_81" style="margin-top:12px; font-size:0.9rem; color:#555;">
            <div>Période effective (vendredi) :
              {% if rem_start_effective and rem_end_effective %}
                du {{ rem_start_effective.strftime('%d/%m/%Y') }} au {{ rem_end_effective.strftime('%d/%m/%Y') }}
              {% else %}
                non définie
              {% endif %}
            </div>
            <div>Total commissions dues : <strong>{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} €</strong></div>
          </div>

          <div data-tb-marker="TB_82" style="overflow-x:auto; margin-top:12px;">
            <table data-tb-marker="TB_83" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Contrats</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation totale</th>
                  <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Commission frais de gestion</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rem_rows %}
                  <tr>
                    <td style="padding:8px;">{{ row.date.strftime('%d/%m/%Y') if row.date else row.date or 'N/A' }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.contracts_count }}</td>
                    <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.total_valorisation or 0).replace(',', ' ') }} €</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.commission or 0).replace(',', ' ') }} €</td>
                </tr>
              {% endfor %}
              {% if not rem_rows %}
                <tr>
                  <td colspan="4" style="padding:8px; color:#666;">Aucune donnée disponible pour cette période.</td>
                </tr>
              {% endif %}
            </tbody>
            <tfoot>
              <tr>
                <th style="padding:8px; text-align:left;">Total période</th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} €</th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div data-tb-marker="TB_84" style="margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; font-size:0.9rem; color:#555;">
          {% if rem_has_prev %}
            {% set rem_prev_link = rem_prev_url %}
            {% if tb_markers_param %}
              {% set rem_prev_link = rem_prev_url + ('&' if '?' in rem_prev_url else '?') + tb_markers_param %}
            {% endif %}
            <a href="{{ rem_prev_link }}#remToggle" class="btn btn-choice" title="Page précédente"><i class="fa-solid fa-arrow-left"></i></a>
          {% endif %}
          <span>Page {{ rem_page }} / {{ rem_total_pages }}</span>
          {% if rem_has_next %}
            {% set rem_next_link = rem_next_url %}
            {% if tb_markers_param %}
              {% set rem_next_link = rem_next_url + ('&' if '?' in rem_next_url else '?') + tb_markers_param %}
            {% endif %}
            <a href="{{ rem_next_link }}#remToggle" class="btn btn-choice" title="Page suivante"><i class="fa-solid fa-arrow-right"></i></a>
          {% endif %}
        </div>
        <div data-tb-marker="TB_95" style="margin-top:6px; font-size:0.85rem; color:#777;">
Semaines {{ rem_page_start }} à {{ rem_page_end }} sur {{ rem_rows_count }}.
        </div>
      {% endif %}
    {% endif %}
  </div>

</div>

<!-- Accordéon Rétrocession des supports -->
<div id="retroToggle" class="card collapsed" data-tb-marker="TB_85" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Rétrocession des supports</h3>
  <span class="chevron">▾</span>
</div>
<div id="retroSection" data-tb-marker="TB_86" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" data-tb-marker="TB_87" style="text-align:left;">
    <h3 style="margin-top:0;">Rétrocession des supports</h3>
    {% if retro_error %}
      <div style="margin:0; color:#a94442; background:#fdecea; padding:10px 12px; border-radius:6px;">{{ retro_error }}</div>
    {% elif not retro_contracts %}
      <p style="margin:0; color:#555;">Aucun contrat générique actif disponible. Veuillez en créer un dans les paramètres.</p>
    {% else %}
      <form id="retroForm" method="get" data-tb-marker="TB_88" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
        {% if tb_markers_param %}
          <input type="hidden" name="markers" value="1" />
        {% endif %}
        <input id="retroHiddenRemContract" type="hidden" name="rem_contract" value="{{ rem_selected_contract }}" />
        <input id="retroHiddenRemStart" type="hidden" name="rem_start" value="{{ rem_start_input }}" />
        <input id="retroHiddenRemEnd" type="hidden" name="rem_end" value="{{ rem_end_input }}" />
        <input type="hidden" name="rem_limit" value="{{ rem_limit }}" />
        <input type="hidden" name="rem_page" value="{{ rem_page }}" />
        <div style="display:flex; flex-direction:column;">
          <label for="ret_contract" style="font-size:0.85rem; color:#555;">Contrat générique</label>
          <select id="ret_contract" name="ret_contract" style="min-width:220px; padding:8px 12px; height:38px;">
            {% for contrat in retro_contracts %}
              <option value="{{ contrat.id }}" {% if contrat.id == retro_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_start" style="font-size:0.85rem; color:#555;">Date de début</label>
          <input id="ret_start" name="ret_start" type="date" value="{{ retro_start_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
          <input id="ret_end" name="ret_end" type="date" value="{{ retro_end_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_sort" style="font-size:0.85rem; color:#555;">Tri</label>
          <select id="ret_sort" name="ret_sort" style="padding:8px 12px; height:38px;">
            <option value="date_desc" {% if retro_sort == 'date_desc' %}selected{% endif %}>Date décroissante</option>
            <option value="date_asc" {% if retro_sort == 'date_asc' %}selected{% endif %}>Date croissante</option>
            <option value="retrocession_desc" {% if retro_sort == 'retrocession_desc' %}selected{% endif %}>Rétrocession décroissante</option>
            <option value="retrocession_asc" {% if retro_sort == 'retrocession_asc' %}selected{% endif %}>Rétrocession croissante</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_week_limit" style="font-size:0.85rem; color:#555;">Lignes (semaines)</label>
          <select id="ret_week_limit" name="ret_week_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_week_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_week_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_support_limit" style="font-size:0.85rem; color:#555;">Lignes (supports)</label>
          <select id="ret_support_limit" name="ret_support_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_support_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_support_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_promoteur" style="font-size:0.85rem; color:#555;">Promoteur contient</label>
          <input id="ret_promoteur" name="ret_promoteur" type="text" value="{{ retro_promoteur }}" placeholder="(optionnel)" style="padding:6px 8px;" />
        </div>
        <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
      </form>

      <div data-tb-marker="TB_89" style="margin-top:12px; font-size:0.9rem; color:#555;">
        <div>Période effective (vendredi) :
          {% if retro_start_effective and retro_end_effective %}
            du {{ retro_start_effective.strftime('%d/%m/%Y') }} au {{ retro_end_effective.strftime('%d/%m/%Y') }}
          {% else %}
            non définie
          {% endif %}
        </div>
        <div>Total rétrocessions (semaines sélectionnées) : <strong>{{ '{:,.2f}'.format(retro_total_week).replace(',', ' ') }}</strong></div>
      </div>

      <div data-tb-marker="TB_90" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:14px; margin-top:12px;">
        <div data-tb-marker="TB_91" style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">Rétrocession par semaines</h4>
          <table data-tb-marker="TB_92" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Nb contrats</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Rétrocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_weeks %}
                <tr>
                  <td style="padding:8px;">{{ row.date_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.nb_contrats }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.valo_total_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_weeks %}
                <tr><td colspan="4" style="padding:8px; color:#666;">Aucune donnée pour cette période.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div data-tb-marker="TB_93" style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">Rétrocession par support financier</h4>
          <table data-tb-marker="TB_94" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">ISIN</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Support</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Promoteur</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Rétrocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_supports %}
                <tr>
                  <td style="padding:8px;">{{ row.code_isin }}</td>
                  <td style="padding:8px;">{{ row.support_nom }}</td>
                  <td style="padding:8px;">{{ row.promoteur }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_supports %}
                <tr><td colspan="4" style="padding:8px; color:#666;">Aucun support trouvé pour cette période.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <div style="margin-top:6px; font-size:0.85rem; color:#777;">Total rétrocessions (supports listés) : {{ '{:,.2f}'.format(retro_total_support).replace(',', ' ') }}</div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
  function closeFinanceSupportModal(){
    const modal = document.getElementById('financeSupportModal');
    if (modal) modal.style.display = 'none';
  }
  function openFinanceSupportModal(code, name, clients){
    const modal = document.getElementById('financeSupportModal');
    if (!modal) return;
    const tbody = modal.querySelector('#financeSupportModalTable tbody');
    const labelEl = document.getElementById('financeSupportModalLabel');
    if (labelEl){
      const parts = ['Clients par support'];
      const detail = [name, code].filter(Boolean).join(' • ');
      if (detail) parts.push(detail);
      labelEl.textContent = parts.join(' — ');
    }
    if (tbody){
      tbody.innerHTML = '';
      const rows = Array.isArray(clients) ? clients : [];
      rows.forEach(function(item){
        const tr = document.createElement('tr');
        const clientTd = document.createElement('td');
        const fullname = item.client_fullname || item.client_nom || 'Client';
        if (item.client_id){
          const link = document.createElement('a');
          link.href = `/dashboard/clients/${encodeURIComponent(item.client_id)}`;
          link.textContent = fullname;
          link.target = '_blank';
          link.rel = 'noopener';
          clientTd.appendChild(link);
        } else {
          clientTd.textContent = fullname;
        }
        tr.appendChild(clientTd);
        const contratTd = document.createElement('td');
        if (item.affaire_id){
          const link = document.createElement('a');
          link.href = `/dashboard/affaires/${encodeURIComponent(item.affaire_id)}`;
          link.textContent = item.affaire_ref || `Affaire ${item.affaire_id}`;
          link.target = '_blank';
          link.rel = 'noopener';
          contratTd.appendChild(link);
        } else {
          contratTd.textContent = item.affaire_ref || '-';
        }
        tr.appendChild(contratTd);
        const valoTd = document.createElement('td');
        valoTd.className = 'numeric';
        valoTd.textContent = item.valorisation_str ? item.valorisation_str + ' €' : '-';
        tr.appendChild(valoTd);
        tbody.appendChild(tr);
      });
      if (!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'muted';
        td.textContent = 'Aucun client trouvé pour ce support.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }
    modal.style.display = 'flex';
  }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.finance-support-link').forEach(function(link){
      link.addEventListener('click', function(ev){
        ev.preventDefault();
        let clients = [];
        try{
          clients = this.dataset.clients ? JSON.parse(this.dataset.clients) : [];
        }catch(err){
          console.warn('finance support clients parse error', err);
        }
        openFinanceSupportModal(this.dataset.supportCode || '', this.dataset.supportName || '', clients);
      });
    });
  });

  // Chart.js texte/axes en bleu corporate
  try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
  function toChartData(items, labelKey, valueKey) {
    const labels = items.map(i => 'SRRI ' + (i[labelKey] ?? 'N/A'));
    const data = items.map(i => Number(i[valueKey] || 0));
    return { labels, data };
  }

  const cc = toChartData({{ srri_clients_count | tojson }}, 'srri', 'nb');
  const ac = toChartData({{ srri_affaires_count | tojson }}, 'srri', 'nb');
  const ca = toChartData({{ srri_clients_amount | tojson }}, 'srri', 'total');
  const aa = toChartData({{ srri_affaires_amount | tojson }}, 'srri', 'total');
  const cb_labels = [{% for b in clients_buckets %}'{{ b.label }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const cb_data = [{% for b in clients_buckets %}{{ b.nb }}{% if not loop.last %}, {% endif %}{% endfor %}];
  if (cb_labels && cb_labels.length){ cb_labels[cb_labels.length-1] = 'Sup. 5M'; }

  function makeBar(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' €' : v; } } }
        }
      }
    });
  }

  // Variante plein conteneur (hauteur contrôlée par CSS, ex: 25vh)
  function makeBarFill(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' €' : v; } } } }
      }
    });
  }

  // Build charts (non cliquables)
  makeBar('chartClientsCount', cc.labels, cc.data, false);
  makeBar('chartAffairesCount', ac.labels, ac.data, false);
  makeBar('chartClientsAmount', ca.labels, ca.data, true);
  makeBar('chartAffairesAmount', aa.labels, aa.data, true);
  // Buckets chart (first): height reduced above
  makeBarFill('chartClientsBuckets', cb_labels, cb_data, false);

  // ------- Tâches: datasets -------
  const tasksStatut = {{ tasks_statut | tojson }};
  const tasksCategorie = {{ tasks_categorie | tojson }};
  const tasksDays = {{ tasks_days | tojson }};
  const ts_labels = tasksStatut.map(x => (x.statut || 'n/a'));
  const ts_data = tasksStatut.map(x => x.nb || 0);
  const tc_labels = tasksCategorie.map(x => (x.categorie || 'n/a'));
  const tc_data = tasksCategorie.map(x => x.nb || 0);
  const td_labels = tasksDays.map(x => x.day);
  const td_data = tasksDays.map(x => x.nb || 0);
  // Draw
  if (document.getElementById('chartTasksStatut')) makeBar('chartTasksStatut', ts_labels, ts_data, false);
  if (document.getElementById('chartTasksCategorie')) makeBar('chartTasksCategorie', tc_labels, tc_data, false);
  if (document.getElementById('chartTasksDays')) makeBarFill('chartTasksDays', td_labels, td_data, false);
  const tdist = {{ tasks_close_dist | tojson }};
  const tdist_labels = tdist.map(x => x.bucket);
  const tdist_data = tdist.map(x => x.nb || 0);
  if (document.getElementById('chartTasksCloseDist')) makeBarFill('chartTasksCloseDist', tdist_labels, tdist_data, false);

  // -------- Graphique: Nb de tâches par type (avec filtre RH) --------
  (function(){
    const byRh = {{ tasks_type_by_rh | tojson }} || [];
    const totals = {{ tasks_type_total | tojson }} || [];
    const sel = document.getElementById('tasksRhSelect');
    const canvas = document.getElementById('chartTasksType');
    if (!sel || !canvas) return;
    // Options RH (uniques, non vides)
    const rhPairs = [];
    const seen = new Set();
    byRh.forEach(r => { if (r.rh_id != null && r.rh_nom){ const key = r.rh_id+""; if(!seen.has(key)){ seen.add(key); rhPairs.push({id:r.rh_id, nom:r.rh_nom}); } } });
    rhPairs.sort((a,b)=> String(a.nom).localeCompare(String(b.nom),'fr',{sensitivity:'base'}));
    rhPairs.forEach(p=>{ const o=document.createElement('option'); o.value=String(p.id); o.textContent=p.nom; sel.appendChild(o); });
    let chartInst = null;
    function draw(rhId){
      // Build map type->nb
      const map = new Map();
      if (rhId){
        byRh.filter(r => String(r.rh_id) === String(rhId)).forEach(r => { map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
      } else {
        (totals||[]).forEach(r => { map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
      }
      const entries = Array.from(map.entries()).sort((a,b)=> b[1]-a[1]);
      const labels = entries.map(e=> e[0]);
      const data = entries.map(e=> e[1]);
      if (chartInst) { chartInst.destroy(); chartInst = null; }
      const ctx = canvas.getContext('2d');
      chartInst = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }]}, options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } } });
    }
    sel.addEventListener('change', function(){ const v = this.value || ''; draw(v||null); });
    draw(null);
  })();

  (function syncRemRetroForms(){
    const remContract = document.getElementById('rem_contract');
    const remStart = document.getElementById('rem_start');
    const remEnd = document.getElementById('rem_end');
    const retContract = document.getElementById('ret_contract');
    const retStart = document.getElementById('ret_start');
    const retEnd = document.getElementById('ret_end');
    const retroHiddenRemContract = document.getElementById('retroHiddenRemContract');
    const retroHiddenRemStart = document.getElementById('retroHiddenRemStart');
    const retroHiddenRemEnd = document.getElementById('retroHiddenRemEnd');
    if (!remContract || !retContract || !remStart || !remEnd || !retStart || !retEnd) {
      return;
    }
    let syncingFromRem = false;
    let syncingFromRetro = false;

    function copyRemToRetro(){
      if (syncingFromRetro) return;
      syncingFromRem = true;
      if (retContract) retContract.value = remContract.value;
      if (retStart) retStart.value = remStart.value;
      if (retEnd) retEnd.value = remEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = remContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = remStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = remEnd.value;
      syncingFromRem = false;
    }

    function copyRetroToRem(){
      if (syncingFromRem) return;
      syncingFromRetro = true;
      if (remContract) remContract.value = retContract.value;
      if (remStart) remStart.value = retStart.value;
      if (remEnd) remEnd.value = retEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = retContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = retStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = retEnd.value;
      syncingFromRetro = false;
    }

    copyRemToRetro();

    remContract.addEventListener('change', copyRemToRetro);
    remStart.addEventListener('change', copyRemToRetro);
    remEnd.addEventListener('change', copyRemToRetro);
    retContract.addEventListener('change', copyRetroToRem);
    retStart.addEventListener('change', copyRetroToRem);
    retEnd.addEventListener('change', copyRetroToRem);
  })();

  // Accordéons (un seul ouvert à la fois, possibilité de tout fermer)
  (function(){
    const storageKey = 'dashboard_open_v2';
    const groups = [
      { key:'risks', toggle:'risksToggle', section:'risksSection' },
      { key:'analysis', toggle:'analysisToggle', section:'analysisSection' },
      { key:'esg', toggle:'esgToggle', section:'esgSection' },
      { key:'tasks', toggle:'tasksToggle', section:'tasksSection' },
      { key:'rem', toggle:'remToggle', section:'remSection' },
    ];
    const $ = (id)=> document.getElementById(id);
    function setOpen(key){
      groups.forEach(g => {
        const t = $(g.toggle), s = $(g.section);
        if (!t || !s) return;
        if (g.key === key){ s.style.display = ''; t.classList.remove('collapsed'); }
        else { s.style.display = 'none'; t.classList.add('collapsed'); }
      });
      try { localStorage.setItem(storageKey, key || ''); } catch(e) {}
    }
    // Restore saved open section
    let saved = '';
    try { saved = localStorage.getItem(storageKey) || ''; } catch(e) {}
    if (saved) setOpen(saved);
    else {
      const defaultGroup = groups.find(g => {
        const t = $(g.toggle);
        return t && t.dataset.open === '1';
      });
      if (defaultGroup) setOpen(defaultGroup.key);
    }
    // Wire clicks
    groups.forEach(g => {
      const t = $(g.toggle), s = $(g.section);
      if (!t || !s) return;
      t.addEventListener('click', function(){
        const isOpen = s.style.display !== 'none';
        if (isOpen){
          // Close all (allow collapsing)
          setOpen('');
        } else {
          setOpen(g.key);
          try { t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
        }
      });
    });
  })();

  // Bloc Rétrocession (accordéon indépendant)
  (function(){
    const toggle = document.getElementById('retroToggle');
    const section = document.getElementById('retroSection');
    const remFraisToggle = document.getElementById('remFraisToggle');
    const remFraisSection = document.getElementById('remFraisSection');
    if (!toggle || !section) return;
    function closeRemFrais(){
      if (!remFraisToggle || !remFraisSection) return;
      remFraisSection.style.display = 'none';
      remFraisToggle.classList.add('collapsed');
    }
    function apply(isOpen){
      section.style.display = isOpen ? '' : 'none';
      toggle.classList.toggle('collapsed', !isOpen);
      if (isOpen) closeRemFrais();
    }
    apply(false);
    toggle.addEventListener('click', function(){
      const isOpen = section.style.display !== 'none';
      const next = !isOpen;
      apply(next);
      if (next){
        try { toggle.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
      }
    });
  })();

  (function(){
    var exportBtn = document.getElementById('finance_export_btn');
    if (!exportBtn) return;
    exportBtn.addEventListener('click', function(){
      var params = new URLSearchParams();
      var dateInput = document.querySelector('input[name="finance_date"]');
      if (dateInput && dateInput.value) params.set('finance_date', dateInput.value);
      var rhSelect = document.querySelector('select[name="finance_rh"]');
      if (rhSelect && rhSelect.value) params.set('finance_rh', rhSelect.value);
      var valoInput = document.querySelector('input[name="finance_valo"]');
      if (valoInput && valoInput.value) params.set('finance_valo', valoInput.value);
      var url = '/dashboard/finance/export';
      var qs = params.toString();
      if (qs) url += '?' + qs;
      window.location.href = url;
    });
  })();

  // Sous-accordéons Risques / Analyse portefeuille (indépendants, ouverts via data-open)
  (function(){
    const pairs = [
      ['complianceToggle','complianceSection'],
      ['clienteleToggle','clienteleSection'],
      ['srriToggle','srriSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => {
      const t = document.getElementById(tid);
      const s = document.getElementById(sid);
      return t && s ? { t, s } : null;
    }).filter(Boolean);

    function closeNode(o){
      o.s.style.display = 'none';
      o.t.classList.add('collapsed');
    }
    function closeAll(){
      nodes.forEach(closeNode);
    }
    function openNode(target){
      closeAll();
      target.s.style.display = '';
      target.t.classList.remove('collapsed');
    }

    closeAll();
    nodes.forEach(o => {
      o.t.addEventListener('click', function(ev){
        ev.stopPropagation();
        const isOpen = o.s.style.display !== 'none';
        if (isOpen){
          closeNode(o);
        } else {
          openNode(o);
          try { o.t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
        }
      });
    });
  })();

  // Sous-accordéons Rémunérations (indépendants)
  (function(){
    const pairs = [
      ['remFraisToggle','remFraisSection'],
    ];
    const nodes = pairs.map(([tid,sid]) => ({
      t: document.getElementById(tid),
      s: document.getElementById(sid)
    })).filter(o => o.t && o.s);
    const retroToggle = document.getElementById('retroToggle');
    const retroSection = document.getElementById('retroSection');
    function closeRetro(){
      if (!retroToggle || !retroSection) return;
      retroSection.style.display = 'none';
      retroToggle.classList.add('collapsed');
    }

    nodes.forEach(o => {
      function open(){
        o.s.style.display = '';
        o.t.classList.remove('collapsed');
        closeRetro();
      }
      function close(){
        o.s.style.display = 'none';
        o.t.classList.add('collapsed');
      }
      close();
      o.t.addEventListener('click', function(ev){
        ev.stopPropagation();
        const isOpen = o.s.style.display !== 'none';
        if (isOpen) { close(); }
        else {
          open();
          try{ o.t.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(e){}
        }
      });
    });
  })();

  

  // ESG Global logic (similar to Affaire/Client)
  (function(){
    var allocSel = document.getElementById('esgAllocSelectGlobal');
    var allocDateSel = document.getElementById('esgAllocDateGlobal');
    var fieldsWrap = document.getElementById('esgFieldsGlobal');
    var refreshBtn = document.getElementById('esgRefreshBtnGlobal');
    if (!allocSel || !fieldsWrap) return;

    var keyAlloc = 'global_esg_alloc';
    var keyFields = 'global_esg_fields';
    var keyAllocDate = 'global_esg_alloc_date';

    function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field-global.btn-choice-active')).map(b=> b.getAttribute('data-field')); }
    fieldsWrap.addEventListener('click', function(e){
      var b=e.target.closest('.esg-field-global'); if(!b) return;
      var sel = selectedFields();
      if (b.classList.contains('btn-choice-active')){ b.classList.remove('btn-choice-active'); }
      else { if (sel.length >= 4) return; b.classList.add('btn-choice-active'); }
      try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
      drawESG();
    });

    function ensurePlotly(cb){ if (window.Plotly) { cb(); return; } var s=document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ cb(); }; document.head.appendChild(s); }
    function drawESG(){
      var fields = selectedFields();
      var alloc = allocSel.value || '';
      var allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
      if (!fields.length || !alloc) return;
      ensurePlotly(function(){
        var url = `/dashboard/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}&debug=1` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'');
        fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          var rows = (data && data.results) || [];
          // Keep only rows with at least one value
          rows = rows.filter(r => r && (r.global != null || r.index != null));
          var cats = rows.map(r=> r.field);
          // Normalize: index baseline 100; portfolio = (global_raw / index_raw) * 100
          var idx = rows.map(function(r){
            if (r.index != null) return Number(r.index);
            if (r.index_raw != null) return 100;
            return null;
          });
          var g = rows.map(function(r){
            if (r.global != null) return Number(r.global);
            var pr = (r.global_raw==null? null : Number(r.global_raw));
            var ir = (r.index_raw==null? null : Number(r.index_raw));
            if (pr==null || ir==null || ir===0) return null;
            return (pr/ir)*100.0;
          });
          // If portfolio values are all null, nothing to plot
          if (!g.length || g.every(v => v == null)) { g = cats.map(() => null); }
          var traces = [
            { x: idx, y: cats, type:'bar', orientation:'h', name:(alloc||'Indice'), marker:{ color:'#9ca3af' } },
            { x: g, y: cats, type:'bar', orientation:'h', name:'Portefeuille', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
          ];
          var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
          var cfg = { displayModeBar: false, responsive: true };
          Plotly.react('esgChartGlobal', traces, layout, cfg);
          // Debug panel (only raw values table)
          try {
            var dbgWrap = document.getElementById('esgDebugPanelGlobal');
            if (dbgWrap){
              var d = data && data.debug ? data.debug : null;
              if (d){
                function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                var html = '';
                try {
                  var prow = d.portfolio_raw || {};
                  var irow = d.index_raw || {};
                  if (fields && fields.length){
                    html += '<div style="margin-top:6px;"><strong>Valeurs brutes (par champ)</strong>';
                    html += '<table style="border-collapse:collapse; margin-top:4px; font-family:monospace; font-size:12px;">';
                    html += '<tr><th style="text-align:left; padding-right:12px;">Champ</th><th style="text-align:right; padding-right:12px;">' + esc(alloc||'Indice') + '</th><th style="text-align:right;">Portefeuille</th></tr>';
                    fields.forEach(function(f){
                      var iv = irow && Object.prototype.hasOwnProperty.call(irow, f) ? irow[f] : null;
                      var pv = prow && Object.prototype.hasOwnProperty.call(prow, f) ? prow[f] : null;
                      function fmt(v){ if(v==null||v===undefined||Number.isNaN(Number(v))) return '-'; try{ var n=Number(v); return (Math.abs(n)>=1000? n.toFixed(2): n.toFixed(4)); }catch(_e){ return esc(String(v)); } }
                      html += '<tr><td style="padding-right:12px;">' + esc(f) + '</td>'+
                              '<td style="text-align:right; padding-right:12px;">' + fmt(iv) + '</td>'+
                              '<td style="text-align:right;">' + fmt(pv) + '</td></tr>';
                    });
                    html += '</table></div>';
                  }
                } catch(_er) {}
                dbgWrap.innerHTML = html;
                dbgWrap.style.display='';
                try { document.getElementById('esgSqlGlobalDetails').open = true; } catch(_e) {}
              }
            }
          } catch(_e) {}
        }).catch(function(err){ try{ console.error('Global ESG fetch error', err); }catch(_){} });
      });
    }

    function loadAllocDates(preferred){
      if (!allocSel || !allocSel.value) { if (allocDateSel) allocDateSel.innerHTML=''; return; }
      fetch(`/dashboard/allocations/dates?name=${encodeURIComponent(allocSel.value)}`)
        .then(r=>r.json()).then(function(data){
          if (!allocDateSel) return;
          allocDateSel.innerHTML = '';
          var ds = (data && data.dates) || [];
          ds.forEach(function(d){ var o=document.createElement('option'); o.value=d; o.textContent=d; allocDateSel.appendChild(o); });
          var selected = false;
          if (preferred){ for (var i=0;i<allocDateSel.options.length;i++){ if (allocDateSel.options[i].value===preferred){ allocDateSel.selectedIndex=i; selected=true; break; } } }
          if (!selected && allocDateSel.options.length>0) allocDateSel.selectedIndex = 0;
          drawESG();
        }).catch(function(e){ try{ console.warn('alloc dates (global)', e);}catch(_){} });
    }

    allocSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAlloc, allocSel.value||''); }catch(_e){}; try{ localStorage.removeItem(keyAllocDate); }catch(_e){}; loadAllocDates(); });
    if (allocDateSel) allocDateSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAllocDate, allocDateSel.value||''); }catch(_e){}; drawESG(); });
    if (refreshBtn) refreshBtn.addEventListener('click', drawESG);

    // Init
    (function init(){
      try{
        var savedAlloc = localStorage.getItem(keyAlloc) || '';
        if (savedAlloc){ var found=false; for (var i=0;i<allocSel.options.length;i++){ if (allocSel.options[i].value===savedAlloc){ allocSel.selectedIndex=i; found=true; break; } } if(!found) savedAlloc=''; }
        if (!savedAlloc){ for (var j=0;j<allocSel.options.length;j++){ if (allocSel.options[j].value){ allocSel.selectedIndex=j; savedAlloc=allocSel.options[j].value; break; } } if (savedAlloc){ try{ localStorage.setItem(keyAlloc, savedAlloc);}catch(_e){} } }
      }catch(_e){}
      try{
        var raw = localStorage.getItem(keyFields); var saved=[]; if (raw){ try{ saved=JSON.parse(raw)||[]; }catch(_ee){ saved=[]; } }
        var buttons = Array.from(fieldsWrap.querySelectorAll('.esg-field-global'));
        buttons.forEach(b=> b.classList.remove('btn-choice-active'));
        if (saved.length){ buttons.forEach(b=> { var v=b.getAttribute('data-field'); if (saved.indexOf(v)>=0) b.classList.add('btn-choice-active'); }); }
        else { buttons.slice(0,3).forEach(b=> b.classList.add('btn-choice-active')); try{ localStorage.setItem(keyFields, JSON.stringify(buttons.slice(0,3).map(b=> b.getAttribute('data-field')))); }catch(_e){} }
      }catch(_e){}
      var preferDate = ''; try{ preferDate = localStorage.getItem(keyAllocDate) || ''; }catch(_e){}
      if (allocSel && allocSel.value){ loadAllocDates(preferDate); } else { drawESG(); }
    })();
  })();
</script>

</div>
{% endblock %}
