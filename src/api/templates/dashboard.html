{% extends "base.html" %}

{% block title %}Tableau de bord{% endblock %}
{% block header_title %}<i class="fa-solid fa-house" style="margin-right:8px;"></i>Tableau de bord{% endblock %}

{% block content %}
<style>
  .home-title { text-align: center; margin: 0 0 1rem 0; }
  .home-sub { text-align: center; margin: 0 0 2rem 0; color: #666; }
  .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; max-width: 1100px; margin: 0 auto 2rem auto; }
  .kpi-card { background:#fff; border-radius:12px; padding:18px; text-align:center; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
  .kpi-value { font-size:1.6rem; font-weight:700; margin-top:6px; }
  .charts { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; max-width: 1200px; margin: 0 auto; }
  /* Liens discrets dans la carte Documents */
  .doc-filter-link { text-decoration:none; color:inherit; }
  .doc-filter-link:hover { text-decoration: underline; }
  /* Chevrons accord√©on: rotation sur fermeture */
  #risksToggle .chevron, #analysisToggle .chevron, #tasksToggle .chevron, #remToggle .chevron, #groupsToggle .chevron {
    transition: transform .2s ease; color: var(--primary);
  }
  #risksToggle.collapsed .chevron, #analysisToggle.collapsed .chevron, #tasksToggle.collapsed .chevron,
  #remToggle.collapsed .chevron, #groupsToggle.collapsed .chevron {
    transform: rotate(-90deg);
  }
</style>

<h2 class="home-title">Tableau de bord</h2>
<p class="home-sub">Acc√®s rapide et indicateurs cl√©s</p>

<!-- KPIs -->
<div class="kpis">
  <div class="kpi-card">
    <div>Nombre d'affaires</div>
    <div class="kpi-value">{{ total_affaires }}</div>
  </div>
  <div class="kpi-card">
    <div>Valorisation totale</div>
    <div class="kpi-value">{{ '{:,.0f}'.format(total_valo or 0).replace(',', ' ') }} ‚Ç¨</div>
  </div>
  <div class="kpi-card">
    <div>Nombre de clients</div>
    <div class="kpi-value">{{ total_clients }}</div>
  </div>
  </div>

  <!-- Accord√©on Risques -->
  </div>
  <div id="risksToggle" class="card" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
    <h3 style="margin:0; font-size:1.05rem;">Risques</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div id="risksSection" class="kpis" style="display:none;">
  <div class="kpi-card" style="text-align:left;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3 style="margin:0; font-size:1.05rem;">Documents</h3>
    </div>
    <div style="margin-top:8px; font-size:0.9rem;">
      <div><strong>Total documents:</strong> <a class="doc-filter-link" href="/dashboard/documents">{{ docs_total }}</a></div>
      <div style="margin-top:6px;">
        <div style="color:#666; font-size:0.85rem;">Obsolescences par niveau</div>
        <div>
          {% for x in docs_obs_by_niveau %}
            <span>
              <strong>
                <a href="/dashboard/documents?niveau={{ x.niveau }}" class="doc-filter-link">
                  {{ x.niveau or 'N/A' }}
                </a>
              </strong>: {{ x.nb }}{% if not loop.last %} | {% endif %}
            </span>
          {% endfor %}
          {% if not docs_obs_by_niveau %}<span class="muted">Aucune donn√©e</span>{% endif %}
        </div>
      </div>
      <div style="margin-top:6px;">
        <div style="color:#666; font-size:0.85rem;">Obsolescences par risque</div>
        <div>
          {% for x in docs_obs_by_risque %}
            <span>
              <strong>
                <a href="/dashboard/documents?risque={{ x.risque }}" class="doc-filter-link">
                  {{ x.risque or 'N/A' }}
                </a>
              </strong>: {{ x.nb }}{% if not loop.last %} | {% endif %}
            </span>
          {% endfor %}
          {% if not docs_obs_by_risque %}<span class="muted">Aucune donn√©e</span>{% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="kpi-card" style="text-align:left;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3 style="margin:0; font-size:1.05rem;">Clients</h3>
    </div>
    <div style="margin-top:8px; font-size:0.95rem; line-height:1.6;">
      <div>
        <a href="/dashboard/clients?risk=above" style="text-decoration:none; color:inherit;">
          üî• <strong>{{ cli_risk_counts.above }}</strong> ‚Äî Au‚Äëdessus du risque
        </a>
      </div>
      <div>
        <a href="/dashboard/clients?risk=equal" style="text-decoration:none; color:inherit;">
          üôè <strong>{{ cli_risk_counts.equal }}</strong> ‚Äî Dans le risque
        </a>
      </div>
      <div>
        <a href="/dashboard/clients?risk=below" style="text-decoration:none; color:inherit;">
          ‚ùÑÔ∏è <strong>{{ cli_risk_counts.below }}</strong> ‚Äî Sous le risque
        </a>
      </div>
    </div>
  </div>
  <div class="kpi-card" style="text-align:left;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3 style="margin:0; font-size:1.05rem;">Affaires</h3>
    </div>
    <div style="margin-top:8px; font-size:0.95rem; line-height:1.6;">
      <div>
        <a href="/dashboard/affaires?risk=above" style="text-decoration:none; color:inherit;">
          üî• <strong>{{ aff_risk_counts.above }}</strong> ‚Äî Au‚Äëdessus du risque
        </a>
      </div>
      <div>
        <a href="/dashboard/affaires?risk=equal" style="text-decoration:none; color:inherit;">
          üôè <strong>{{ aff_risk_counts.equal }}</strong> ‚Äî Dans le risque
        </a>
      </div>
      <div>
        <a href="/dashboard/affaires?risk=below" style="text-decoration:none; color:inherit;">
          ‚ùÑÔ∏è <strong>{{ aff_risk_counts.below }}</strong> ‚Äî Sous le risque
        </a>
      </div>
    </div>
  </div>
  </div>

<!-- Accord√©on Analyse portefeuille -->
<div id="analysisToggle" class="card" style="max-width:1100px; margin: 0 auto 1rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Analyse portefeuille</h3>
  <span class="chevron">‚ñæ</span>
 </div>
<div id="analysisSection" style="display:none;">
  <!-- D√©coupage clients par d√©tention (bar chart pleine largeur) -->
  <div class="card" style="max-width: 1100px; margin: 0 auto 1rem auto; height: calc(18vh + 50px); display:flex; flex-direction:column;">
    <h3>D√©coupage clients par d√©tention</h3>
    <canvas id="chartClientsBuckets" style="flex:1 1 auto; min-height:0;"></canvas>
  </div>

  <!-- Graphiques (r√©ordonn√©s: 2-4 puis 3-5) -->
  <div class="charts" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); max-width:1100px; margin:0 auto;">
    <div class="card">
      <h3>Clients par SRRI</h3>
      <canvas id="chartClientsCount"></canvas>
    </div>
    <div class="card">
      <h3>Montant par SRRI (Clients)</h3>
      <canvas id="chartClientsAmount"></canvas>
    </div>
  </div>
  <div class="charts" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); max-width:1100px; margin:0 auto;">
    <div class="card">
      <h3>Affaires par SRRI</h3>
      <canvas id="chartAffairesCount"></canvas>
    </div>
    <div class="card">
      <h3>Montant par SRRI (Affaires)</h3>
      <canvas id="chartAffairesAmount"></canvas>
    </div>
  </div>
</div>

<!-- Accord√©on T√¢ches en cours -->
<div id="tasksToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">T√¢ches en cours</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="tasksSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
    <div class="muted">P√©riode:</div>
    {% set r = tasks_range or 14 %}
    {% for n in [7,14,30] %}
      {% if n == r %}
        <a class="btn btn-choice btn-choice-active" href="?tasks_range={{ n }}#tasksToggle">{{ n }} j</a>
      {% else %}
        <a class="btn btn-choice" href="?tasks_range={{ n }}#tasksToggle">{{ n }} j</a>
      {% endif %}
    {% endfor %}
  </div>
  <div class="kpis" style="grid-template-columns: repeat(4, 1fr);">
    <div class="kpi-card">
      <div>T√¢ches totales</div>
      <div class="kpi-value">{{ tasks_total }}</div>
    </div>
    <div class="kpi-card">
      <div>Ouvertes</div>
      <div class="kpi-value">{{ tasks_open }}</div>
    </div>
    <div class="kpi-card">
      <div>Cl√¥tur√©es</div>
      <div class="kpi-value">{{ (tasks_total - tasks_open) if tasks_total is not none else 0 }}</div>
    </div>
    <div class="kpi-card">
      <div>Aujourd'hui</div>
      <div class="kpi-value">{% set today = tasks_days|last %}{{ today.nb if today else 0 }}</div>
    </div>
    <div class="kpi-card" style="grid-column: 1 / -1;">
      <div>D√©lai moyen de cl√¥ture</div>
      <div class="kpi-value">{{ '%.1f'|format(tasks_avg_close_days or 0) }} j</div>
    </div>
  </div>

  <div class="charts" style="grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); margin-top:1rem;">
    <div class="card">
      <h3>Par statut</h3>
      <canvas id="chartTasksStatut"></canvas>
    </div>
    <div class="card">
      <h3>Par cat√©gorie</h3>
      <canvas id="chartTasksCategorie"></canvas>
    </div>
    <div class="card" style="min-height:220px;">
      <h3>Cr√©ations ({{ tasks_range }} jours)</h3>
      <div style="height:220px;"><canvas id="chartTasksDays"></canvas></div>
    </div>
    <div class="card" style="min-height:220px;">
      <h3>Dur√©es jusqu'√† cl√¥ture ({{ tasks_range }} jours)</h3>
      <div style="height:220px;"><canvas id="chartTasksCloseDist"></canvas></div>
    </div>
  </div>

  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
    <a class="btn btn-choice" href="/dashboard/taches?today=1">Mes t√¢ches du jour</a>
    <a class="btn btn-choice" href="/dashboard/taches?late=1">En retard</a>
    <a class="btn btn-choice" href="/dashboard/taches?categorie=reclamation&exclude_statut=termin√©">R√©clamations en cours</a>
    <a class="btn btn-choice" href="/dashboard/taches?statut=en%20attente">En attente</a>
  </div>

  <div class="card" style="margin-top:12px; overflow-x:auto;">
    <h3>Temps moyen pass√© par statut</h3>
    <table style="width:100%; border-collapse:collapse; margin-top:6px;">
      <thead>
        <tr>
          <th style="text-align:left; padding:6px 8px; background:#f8f9fa;">Statut</th>
          <th style="text-align:right; padding:6px 8px; background:#f8f9fa;">Dur√©e moyenne (jours)</th>
        </tr>
      </thead>
      <tbody>
        {% for r in tasks_avg_by_statut %}
        <tr>
          <td style="padding:6px 8px;">{{ r.statut }}</td>
          <td style="padding:6px 8px; text-align:right;">{{ '%.1f'|format(r.avg_days or 0) }}</td>
        </tr>
        {% endfor %}
        {% if not tasks_avg_by_statut %}
        <tr><td colspan="2" style="padding:6px 8px; color:#666;">Aucune donn√©e</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Accord√©on R√©mun√©rations -->
<div id="remToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">R√©mun√©rations</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="remSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" style="text-align:left;">
    <h3 style="margin-top:0;">Commissions sur frais de gestion</h3>
    {% if not rem_contracts %}
      <p style="margin:0; color:#555;">Aucun contrat g√©n√©rique actif disponible. Veuillez en cr√©er un dans les param√®tres.</p>
    {% else %}
      <form id="remForm" method="get" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
        <div style="display:flex; flex-direction:column;">
          <label for="rem_contract" style="font-size:0.85rem; color:#555;">Contrat g√©n√©rique</label>
          <select id="rem_contract" name="rem_contract" style="min-width:220px; padding:8px 12px; height:38px;">
            {% for contrat in rem_contracts %}
              <option value="{{ contrat.id }}" {% if contrat.id == rem_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="rem_start" style="font-size:0.85rem; color:#555;">Date de d√©but</label>
          <input id="rem_start" name="rem_start" type="date" value="{{ rem_start_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="rem_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
          <input id="rem_end" name="rem_end" type="date" value="{{ rem_end_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="rem_limit" style="font-size:0.85rem; color:#555;">Nombre de lignes</label>
          <select id="rem_limit" name="rem_limit" style="padding:8px 12px; height:38px;">
            {% for opt in rem_limit_options %}
              <option value="{{ opt }}" {% if opt == rem_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <input type="hidden" name="rem_page" value="1" />
        <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
      </form>

      {% if rem_error %}
        <div style="margin-top:12px; padding:10px 12px; background:#fdecea; color:#a94442; border-radius:6px;">{{ rem_error }}</div>
      {% else %}
        <div style="margin-top:12px; font-size:0.9rem; color:#555;">
          <div>P√©riode effective (vendredi) :
            {% if rem_start_effective and rem_end_effective %}
              du {{ rem_start_effective.strftime('%d/%m/%Y') }} au {{ rem_end_effective.strftime('%d/%m/%Y') }}
            {% else %}
              non d√©finie
            {% endif %}
          </div>
          <div>Total commissions dues : <strong>{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} ‚Ç¨</strong></div>
        </div>

        <div style="overflow-x:auto; margin-top:12px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Contrats</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation totale</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Commission frais de gestion</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rem_rows %}
                <tr>
                  <td style="padding:8px;">{{ row.date.strftime('%d/%m/%Y') if row.date else row.date or 'N/A' }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.contracts_count }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.total_valorisation or 0).replace(',', ' ') }} ‚Ç¨</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(row.commission or 0).replace(',', ' ') }} ‚Ç¨</td>
                </tr>
              {% endfor %}
              {% if not rem_rows %}
                <tr>
                  <td colspan="4" style="padding:8px; color:#666;">Aucune donn√©e disponible pour cette p√©riode.</td>
                </tr>
              {% endif %}
            </tbody>
            <tfoot>
              <tr>
                <th style="padding:8px; text-align:left;">Total p√©riode</th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);"></th>
                <th style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ '{:,.2f}'.format(rem_total_commission or 0).replace(',', ' ') }} ‚Ç¨</th>
              </tr>
            </tfoot>
          </table>
        </div>
        <div style="margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; font-size:0.9rem; color:#555;">
          {% if rem_has_prev %}
            <a href="{{ rem_prev_url }}#remToggle" class="btn btn-choice" title="Page pr√©c√©dente"><i class="fa-solid fa-arrow-left"></i></a>
          {% endif %}
          <span>Page {{ rem_page }} / {{ rem_total_pages }}</span>
          {% if rem_has_next %}
            <a href="{{ rem_next_url }}#remToggle" class="btn btn-choice" title="Page suivante"><i class="fa-solid fa-arrow-right"></i></a>
          {% endif %}
        </div>
        <div style="margin-top:6px; font-size:0.85rem; color:#777;">
          Semaines {{ rem_page_start }} √† {{ rem_page_end }} sur {{ rem_rows_count }}.
        </div>
      {% endif %}
    {% endif %}
  </div>
  <div class="card" style="text-align:left; margin-top:12px;">
    <h3 style="margin-top:0;">R√©trocession des supports</h3>
    {% if retro_error %}
      <div style="margin:0; color:#a94442; background:#fdecea; padding:10px 12px; border-radius:6px;">{{ retro_error }}</div>
    {% elif not retro_contracts %}
      <p style="margin:0; color:#555;">Aucun contrat g√©n√©rique actif disponible. Veuillez en cr√©er un dans les param√®tres.</p>
    {% else %}
      <form id="retroForm" method="get" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:8px;">
        <input id="retroHiddenRemContract" type="hidden" name="rem_contract" value="{{ rem_selected_contract }}" />
        <input id="retroHiddenRemStart" type="hidden" name="rem_start" value="{{ rem_start_input }}" />
        <input id="retroHiddenRemEnd" type="hidden" name="rem_end" value="{{ rem_end_input }}" />
        <input type="hidden" name="rem_limit" value="{{ rem_limit }}" />
        <input type="hidden" name="rem_page" value="{{ rem_page }}" />
        <div style="display:flex; flex-direction:column;">
          <label for="ret_contract" style="font-size:0.85rem; color:#555;">Contrat g√©n√©rique</label>
          <select id="ret_contract" name="ret_contract" style="min-width:220px; padding:8px 12px; height:38px;">
            {% for contrat in retro_contracts %}
              <option value="{{ contrat.id }}" {% if contrat.id == retro_selected_contract %}selected{% endif %}>{{ contrat.nom_contrat }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_start" style="font-size:0.85rem; color:#555;">Date de d√©but</label>
          <input id="ret_start" name="ret_start" type="date" value="{{ retro_start_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_end" style="font-size:0.85rem; color:#555;">Date de fin</label>
          <input id="ret_end" name="ret_end" type="date" value="{{ retro_end_input }}" style="padding:6px 8px;" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_sort" style="font-size:0.85rem; color:#555;">Tri</label>
          <select id="ret_sort" name="ret_sort" style="padding:8px 12px; height:38px;">
            <option value="date_desc" {% if retro_sort == 'date_desc' %}selected{% endif %}>Date d√©croissante</option>
            <option value="date_asc" {% if retro_sort == 'date_asc' %}selected{% endif %}>Date croissante</option>
            <option value="retrocession_desc" {% if retro_sort == 'retrocession_desc' %}selected{% endif %}>R√©trocession d√©croissante</option>
            <option value="retrocession_asc" {% if retro_sort == 'retrocession_asc' %}selected{% endif %}>R√©trocession croissante</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_week_limit" style="font-size:0.85rem; color:#555;">Lignes (semaines)</label>
          <select id="ret_week_limit" name="ret_week_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_week_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_week_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_support_limit" style="font-size:0.85rem; color:#555;">Lignes (supports)</label>
          <select id="ret_support_limit" name="ret_support_limit" style="padding:8px 12px; height:38px;">
            {% for opt in retro_support_limit_options %}
              <option value="{{ opt }}" {% if opt == retro_support_limit %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="ret_promoteur" style="font-size:0.85rem; color:#555;">Promoteur contient</label>
          <input id="ret_promoteur" name="ret_promoteur" type="text" value="{{ retro_promoteur }}" placeholder="(optionnel)" style="padding:6px 8px;" />
        </div>
        <button type="submit" class="btn" style="padding:7px 16px;">Actualiser</button>
      </form>

      <div style="margin-top:12px; font-size:0.9rem; color:#555;">
        <div>P√©riode effective (vendredi) :
          {% if retro_start_effective and retro_end_effective %}
            du {{ retro_start_effective.strftime('%d/%m/%Y') }} au {{ retro_end_effective.strftime('%d/%m/%Y') }}
          {% else %}
            non d√©finie
          {% endif %}
        </div>
        <div>Total r√©trocessions (semaines s√©lectionn√©es) : <strong>{{ '{:,.2f}'.format(retro_total_week).replace(',', ' ') }}</strong></div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:14px; margin-top:12px;">
        <div style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">R√©trocession par semaines</h4>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Date</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Nb contrats</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">R√©trocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_weeks %}
                <tr>
                  <td style="padding:8px;">{{ row.date_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.nb_contrats }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.valo_total_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_weeks %}
                <tr><td colspan="4" style="padding:8px; color:#666;">Aucune donn√©e pour cette p√©riode.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div style="overflow-x:auto;">
          <h4 style="margin:0 0 6px;">R√©trocession par support financier</h4>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Promoteur</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">Support</th>
                <th style="text-align:left; padding:8px; background:var(--primary); color:#fff;">ISIN</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">Valorisation</th>
                <th style="text-align:right; padding:8px; background:var(--primary); color:#fff;">R√©trocession</th>
              </tr>
            </thead>
            <tbody>
              {% for row in retro_supports %}
                <tr>
                  <td style="padding:8px;">{{ row.promoteur }}</td>
                  <td style="padding:8px;">{{ row.support_nom }}</td>
                  <td style="padding:8px;">{{ row.code_isin }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.valo_total_str }}</td>
                  <td style="padding:8px; text-align:right; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace);">{{ row.retrocession_str }}</td>
                </tr>
              {% endfor %}
              {% if not retro_supports %}
                <tr><td colspan="5" style="padding:8px; color:#666;">Aucun support trouv√© pour cette p√©riode.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <div style="margin-top:6px; font-size:0.85rem; color:#777;">Total r√©trocessions (supports list√©s) : {{ '{:,.2f}'.format(retro_total_support).replace(',', ' ') }}</div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Accord√©on Gestion des groupes -->
<div id="groupsToggle" class="card" style="max-width:1100px; margin: 0 auto 0.5rem auto; display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; cursor:pointer;">
  <h3 style="margin:0; font-size:1.05rem;">Gestion des groupes</h3>
  <span class="chevron">‚ñæ</span>
</div>
<div id="groupsSection" style="max-width:1100px; margin: 0 auto 1rem auto; display:none;">
  <div class="card" style="text-align:left;">
    <p style="margin:0; color:#555;">En cours de d√©veloppement.</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Chart.js texte/axes en bleu corporate
  try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
  function toChartData(items, labelKey, valueKey) {
    const labels = items.map(i => 'SRRI ' + (i[labelKey] ?? 'N/A'));
    const data = items.map(i => Number(i[valueKey] || 0));
    return { labels, data };
  }

  const cc = toChartData({{ srri_clients_count | tojson }}, 'srri', 'nb');
  const ac = toChartData({{ srri_affaires_count | tojson }}, 'srri', 'nb');
  const ca = toChartData({{ srri_clients_amount | tojson }}, 'srri', 'total');
  const aa = toChartData({{ srri_affaires_amount | tojson }}, 'srri', 'total');
  const cb_labels = [{% for b in clients_buckets %}'{{ b.label }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const cb_data = [{% for b in clients_buckets %}{{ b.nb }}{% if not loop.last %}, {% endif %}{% endfor %}];
  if (cb_labels && cb_labels.length){ cb_labels[cb_labels.length-1] = 'Sup. 5M'; }

  function makeBar(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' ‚Ç¨' : v; } } }
        }
      }
    });
  }

  // Variante plein conteneur (hauteur contr√¥l√©e par CSS, ex: 25vh)
  function makeBarFill(id, labels, data, fmtEuro=false) {
    const ctx = document.getElementById(id).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: '', data, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { callback: function(v){ return fmtEuro ? v.toLocaleString('fr-FR') + ' ‚Ç¨' : v; } } } }
      }
    });
  }

  // Build charts (non cliquables)
  makeBar('chartClientsCount', cc.labels, cc.data, false);
  makeBar('chartAffairesCount', ac.labels, ac.data, false);
  makeBar('chartClientsAmount', ca.labels, ca.data, true);
  makeBar('chartAffairesAmount', aa.labels, aa.data, true);
  // Buckets chart (first): height reduced above
  makeBarFill('chartClientsBuckets', cb_labels, cb_data, false);

  // ------- T√¢ches: datasets -------
  const tasksStatut = {{ tasks_statut | tojson }};
  const tasksCategorie = {{ tasks_categorie | tojson }};
  const tasksDays = {{ tasks_days | tojson }};
  const ts_labels = tasksStatut.map(x => (x.statut || 'n/a'));
  const ts_data = tasksStatut.map(x => x.nb || 0);
  const tc_labels = tasksCategorie.map(x => (x.categorie || 'n/a'));
  const tc_data = tasksCategorie.map(x => x.nb || 0);
  const td_labels = tasksDays.map(x => x.day);
  const td_data = tasksDays.map(x => x.nb || 0);
  // Draw
  if (document.getElementById('chartTasksStatut')) makeBar('chartTasksStatut', ts_labels, ts_data, false);
  if (document.getElementById('chartTasksCategorie')) makeBar('chartTasksCategorie', tc_labels, tc_data, false);
  if (document.getElementById('chartTasksDays')) makeBarFill('chartTasksDays', td_labels, td_data, false);
  const tdist = {{ tasks_close_dist | tojson }};
  const tdist_labels = tdist.map(x => x.bucket);
  const tdist_data = tdist.map(x => x.nb || 0);
  if (document.getElementById('chartTasksCloseDist')) makeBarFill('chartTasksCloseDist', tdist_labels, tdist_data, false);

  (function syncRemRetroForms(){
    const remContract = document.getElementById('rem_contract');
    const remStart = document.getElementById('rem_start');
    const remEnd = document.getElementById('rem_end');
    const retContract = document.getElementById('ret_contract');
    const retStart = document.getElementById('ret_start');
    const retEnd = document.getElementById('ret_end');
    const retroHiddenRemContract = document.getElementById('retroHiddenRemContract');
    const retroHiddenRemStart = document.getElementById('retroHiddenRemStart');
    const retroHiddenRemEnd = document.getElementById('retroHiddenRemEnd');
    if (!remContract || !retContract || !remStart || !remEnd || !retStart || !retEnd) {
      return;
    }
    let syncingFromRem = false;
    let syncingFromRetro = false;

    function copyRemToRetro(){
      if (syncingFromRetro) return;
      syncingFromRem = true;
      if (retContract) retContract.value = remContract.value;
      if (retStart) retStart.value = remStart.value;
      if (retEnd) retEnd.value = remEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = remContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = remStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = remEnd.value;
      syncingFromRem = false;
    }

    function copyRetroToRem(){
      if (syncingFromRem) return;
      syncingFromRetro = true;
      if (remContract) remContract.value = retContract.value;
      if (remStart) remStart.value = retStart.value;
      if (remEnd) remEnd.value = retEnd.value;
      if (retroHiddenRemContract) retroHiddenRemContract.value = retContract.value;
      if (retroHiddenRemStart) retroHiddenRemStart.value = retStart.value;
      if (retroHiddenRemEnd) retroHiddenRemEnd.value = retEnd.value;
      syncingFromRetro = false;
    }

    copyRemToRetro();

    remContract.addEventListener('change', copyRemToRetro);
    remStart.addEventListener('change', copyRemToRetro);
    remEnd.addEventListener('change', copyRemToRetro);
    retContract.addEventListener('change', copyRetroToRem);
    retStart.addEventListener('change', copyRetroToRem);
    retEnd.addEventListener('change', copyRetroToRem);
  })();

  // Accord√©ons (un seul ouvert √† la fois, possibilit√© de tout fermer)
  (function(){
    const groups = [
      { key:'risks', toggle:'risksToggle', section:'risksSection' },
      { key:'analysis', toggle:'analysisToggle', section:'analysisSection' },
      { key:'tasks', toggle:'tasksToggle', section:'tasksSection' },
      { key:'rem', toggle:'remToggle', section:'remSection' },
      { key:'groups', toggle:'groupsToggle', section:'groupsSection' },
    ];
    const $ = (id)=> document.getElementById(id);
    function setOpen(key){
      groups.forEach(g => {
        const t = $(g.toggle), s = $(g.section);
        if (!t || !s) return;
        if (g.key === key){ s.style.display = ''; t.classList.remove('collapsed'); }
        else { s.style.display = 'none'; t.classList.add('collapsed'); }
      });
      try { localStorage.setItem('dashboard_open', key || ''); } catch(e) {}
    }
    // Restore saved open section
    let saved = '';
    try { saved = localStorage.getItem('dashboard_open') || ''; } catch(e) {}
    if (saved) setOpen(saved);
    // Wire clicks
    groups.forEach(g => {
      const t = $(g.toggle), s = $(g.section);
      if (!t || !s) return;
      t.addEventListener('click', function(){
        const isOpen = s.style.display !== 'none';
        if (isOpen){
          // Close all (allow collapsing)
          setOpen('');
        } else {
          setOpen(g.key);
          try { t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {}
        }
      });
    });
  })();
</script>

{% endblock %}
