<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Dashboard{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --bg: #eef2f7;
            --surface: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --primary-600: #1d4ed8;
            --primary-100: #e8f0ff;
            --accent: #0ea5e9;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --border: #e5e7eb;
            --radius: 14px;
            --shadow: 0 16px 40px rgba(15, 23, 42, 0.12);
            --shadow-sm: 0 8px 20px rgba(15, 23, 42, 0.08);
        }
        html, body { height: 100%; }
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at 20% 20%, #f4f7ff 0, #eef2f7 45%, #eef2f7 100%);
            color: var(--text);
            font-family: "Inter", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            font-size: 16px;
            line-height: 1.45;
        }
        h1, h2, h3 { margin: 0; font-weight: 700; color: var(--text); }
        h1 { font-size: 1.9rem; }
        h2 { font-size: 1.35rem; letter-spacing: .01em; }
        h3 { font-size: 1.12rem; font-weight: 650; }
        .muted { color: var(--muted); }

        /* En-tête / Brand */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 30;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        }
        .topbar-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 14px 18px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand-mark {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: linear-gradient(135deg, #2563eb, #0ea5e9);
            color: #fff;
            font-weight: 800;
            letter-spacing: 0.03em;
        }
        .brand-text h1 { font-size: 18px; }
        .brand-text p {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.3;
        }
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: var(--primary-100);
            color: var(--primary-600);
            font-weight: 700;
            font-size: 12px;
        }

        /* Navigation */
        nav {
            padding: 0 18px 16px;
        }
        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        nav a {
            text-decoration: none;
            color: var(--text);
            font-weight: 700;
            padding: 10px 14px;
            border-radius: 12px;
            background: #fff;
            border: 1px solid var(--border);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all .15s ease;
        }
        nav a i { color: var(--primary-600); }
        nav a:hover { transform: translateY(-1px); border-color: rgba(37,99,235,0.35); }
        nav a.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 14px 32px rgba(37, 99, 235, 0.25);
        }
        nav a.active i { color: #fff; }

        /* Mise en page */
        .container { max-width: 1200px; margin: 1.2rem auto 2rem; padding: 0 1rem; }

        /* Cartes */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 1.25rem;
        }
        .card:hover { box-shadow: var(--shadow); }
        .card i { font-size: 1.6rem; color: var(--primary); }

        /* ===== Boutons (utilitaires) ===== */
        .btn { display: inline-flex; align-items: center; gap: .4rem; padding: .5rem .9rem; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text); text-decoration: none; font-weight: 600; cursor: pointer; transition: all .2s ease; }
        .btn:hover { background: #f8fafc; border-color: var(--primary-100); }
        .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-600); }
        .btn-secondary { background: #edf2fd; color: var(--primary-600); border-color: rgba(36,86,166,0.3); }
        .btn-secondary:hover { background: #dbe5fc; }
        .btn-danger { background: #ef4444; color:#fff; border-color:#ef4444; }
        .btn-danger:hover { background:#dc2626; }
        .btn-choice { height: 44px; padding: .6rem .9rem; font-size: 1rem; border-radius: 10px; text-transform: capitalize; background:#fff; color:var(--text); border:1px solid var(--border); transition:background .2s ease, color .2s ease, border .2s ease, box-shadow .2s ease; }
        .btn-choice-active { background: var(--primary); color:#fff; border-color: var(--primary); box-shadow:0 6px 14px rgba(36,86,166,0.25); }
        /* Harmonisation blocs définition de tâches (typo proche KPI) */
        .task-block label { font-size: .95rem; font-weight: 600; color: var(--text); }
        .task-block .btn-choice { height: 44px; font-size: .95rem; }
        .task-block .select-choice { height: 44px; font-size: .95rem; }
        .task-block .input-large { font-size: 1.05rem; }

        /* ===== Formulaires ===== */
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: .5rem .6rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text);
            font-size: .95rem;
            box-sizing: border-box;
        }
        .input-large { font-size: 1.05rem; }
        textarea {
            width: 100%;
            padding: .6rem .7rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text);
            font-size: 1.05rem; /* texte commentaire plus lisible */
            line-height: 1.45;
            box-sizing: border-box;
        }
        /* Menus déroulants harmonisés comme les filtres Documents */
        select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            color: var(--text);
            font-size: 13px;
            box-sizing: border-box;
        }
        /* Sélecteurs mis en avant (semblables à des boutons) */
        .select-choice {
            padding: .6rem .8rem;
            height: 44px;
            border: 1.5px solid var(--primary);
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            text-transform: capitalize; /* majuscule en début de mot */
        }
        .select-choice option { text-transform: capitalize; }
        input::placeholder { color: #9aa3af; }

        /* ===== Grille responsive pour formulaires ===== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: .6rem;
            align-items: end;
        }
        .field label { display:block; margin-bottom: .25rem; }
        .field input, .field select, .field textarea { width:100%; box-sizing: border-box; }

        /* ===== Tableaux ===== */
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: var(--shadow-sm); margin-top: 1rem; }
        thead th { background: var(--primary); color: #fff; font-weight: 600; text-transform: uppercase; font-size: .8rem; letter-spacing: .02em; padding: .65rem .6rem; border-right: 1px solid rgba(255,255,255,.2); }
        thead th:last-child { border-right: none; }
        tbody td { border-top: 1px solid var(--border); padding: .6rem .6rem; font-size: .9rem; }
        /* Champs de filtre en en-tête de tableau (uniformisés) */
        table thead input, table thead select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            color: var(--text);
        }
        tbody tr:nth-child(odd) td { background: #fcfdff; }
        tbody tr:hover td { background: #f8fbff; }
        th, td { text-align: left; }

        /* ===== Utilitaires ===== */
        .right { text-align: right; }
        .center { text-align: center; }
        .badge { display:inline-block; padding:.15rem .5rem; font-size:.75rem; border-radius:999px; border:1px solid var(--border); background:#f9fafb; color: var(--text); }
        /* Utilitaire: masque un bloc */
        .step-hidden { display: none !important; }

        /* ===== Accordéons génériques ===== */
        .accordion-toggle { background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-sm); padding: .8rem 1rem; font-size: 1rem; font-weight: 600; position: relative; transition: background .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease; }
        .accordion-toggle:hover { box-shadow: var(--shadow); }
        .accordion-toggle:not(.collapsed) { background: var(--primary); color:#fff; border-color: var(--primary); box-shadow: 0 12px 24px rgba(36,86,166,0.25); }
        .accordion-toggle:not(.collapsed) .chevron,
        .accordion-toggle:not(.collapsed) i,
        .accordion-toggle:not(.collapsed) span { color:#fff; }
        .accordion-toggle:not(.collapsed) * { color:#fff; }
        .accordion-toggle:not(.collapsed) .badge { background: rgba(255,255,255,0.2) !important; color:#fff !important; border-color: rgba(255,255,255,0.4) !important; }

        /* Centrage pour boutons Créer */
        .create-btn-container {
            display: flex;
            width: 100%;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-top: .6rem;
        }
        .create-btn-container .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding-left: 2.2rem; /* space for leading icon */
        }
        .create-btn-container .btn i {
            position: absolute;
            left: 12px;
            margin-right: 0 !important;
        }
        #globalLoader {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s ease;
        }
        #globalLoader.active {
            opacity: 1;
            pointer-events: all;
        }
        #globalLoader .loader-box {
            background: #fff;
            border-radius: 14px;
            padding: 1rem 1.4rem;
            box-shadow: 0 18px 36px rgba(15,23,42,0.18);
            display: flex;
            align-items: center;
            gap: 0.9rem;
            min-width: 240px;
        }
        #globalLoader .spinner {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid rgba(36, 86, 166, 0.25);
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }
        #globalLoader .loader-text {
            color: var(--text);
            font-weight: 600;
            font-size: 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header global -->
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="brand-mark">CRM</div>
          <div class="brand-text">
            <p class="muted" style="font-weight:700; text-transform:uppercase; letter-spacing:.06em;">Pilotage portefeuille</p>
            <h1>{% block header_title %}CRM SAAS{% endblock %}</h1>
            {% block header_subtitle %}{% endblock %}
          </div>
        </div>
        <span class="status-pill"><i class="fa-solid fa-signal"></i> En ligne</span>
      </div>
      <!-- Navigation unifiée -->
      <nav>
        <div class="nav-inner">
            {% set path = request.url.path if request and request.url else '' %}
            <a href="/dashboard/" class="{% if path == '/dashboard/' or path == '/dashboard' %}active{% endif %}"><i class="fa-solid fa-house"></i>Accueil</a>
            <a href="/dashboard/clients" class="{% if path.startswith('/dashboard/clients') %}active{% endif %}"><i class="fa-solid fa-users"></i>Clients</a>
            <a href="/dashboard/affaires" class="{% if path.startswith('/dashboard/affaires') %}active{% endif %}"><i class="fa-solid fa-briefcase"></i>Affaires</a>
            <a href="/dashboard/supports" class="{% if path.startswith('/dashboard/supports') %}active{% endif %}"><i class="fa-solid fa-chart-pie"></i>Supports</a>
            <a href="/dashboard/allocations" class="{% if path.startswith('/dashboard/allocations') %}active{% endif %}"><i class="fa-solid fa-coins"></i>Offres financières</a>
            <a href="/dashboard/documents" class="{% if path.startswith('/dashboard/documents') %}active{% endif %}"><i class="fa-solid fa-file"></i>Documents</a>
            <a href="/dashboard/taches" class="{% if path.startswith('/dashboard/taches') %}active{% endif %}"><i class="fa-solid fa-list-check"></i>Tâches</a>
            <a href="/dashboard/parametres" class="{% if path.startswith('/dashboard/parametres') %}active{% endif %}"><i class="fa-solid fa-gear"></i>Paramètres</a>
        </div>
      </nav>
    </div>

    <!-- Contenu spécifique -->
    <div class="container">
        {% block content %}{% endblock %}
    </div>

    <div id="globalLoader" aria-hidden="true" role="status">
        <div class="loader-box">
            <div class="spinner"></div>
            <div class="loader-text">Veuillez patienter…</div>
        </div>
    </div>

    <script>
      (function(){
        var loader = document.getElementById('globalLoader');
        var timer = null;
        function show(label){
          if(!loader) return;
          var textEl = loader.querySelector('.loader-text');
          if(label && textEl){ textEl.textContent = label; }
          loader.classList.add('active');
        }
        function hide(delay){
          if(!loader) return;
          var fn = function(){ loader.classList.remove('active'); };
          if(timer){ clearTimeout(timer); timer = null; }
          if(delay){
            timer = setTimeout(fn, delay);
          } else {
            fn();
          }
        }
        window.showGlobalLoader = show;
        window.hideGlobalLoader = hide;
      })();

      // Convert ISO datetimes to Europe/Paris (UTC+2 or +1 with DST) on the client
      (function () {
        function applyLocalDates() {
          var nodes = document.querySelectorAll('.js-local-dt');
          nodes.forEach(function (el) {
            var iso = el.getAttribute('data-iso') || (el.textContent || '').trim();
            if (!iso) return;
            // Ensure a format parsable by Date
            // If missing timezone, treat as UTC to avoid local double-offsets
            var s = iso;
            if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}(?::\d{2})?)?$/.test(s)) {
              s = s.replace(' ', 'T') + 'Z';
            }
            var d = new Date(s);
            if (isNaN(d)) return;
            // Render using fixed Europe/Paris timezone (UTC+1/+2 with DST)
            try {
              el.textContent = d.toLocaleString('fr-FR', { timeZone: 'Europe/Paris' });
            } catch (e) {
              // Fallback to default locale if TZ not supported
              el.textContent = d.toLocaleString();
            }
          });
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', applyLocalDates);
        } else {
          applyLocalDates();
        }
      })();
      // Generic toggle handlers for btn-groups (Oui/Non) and multi-groups
      (function(){
        function initGroups(){
          // Pre-activate single-choice groups from hidden inputs
          document.querySelectorAll('.btn-group[data-name]').forEach(function(group){
            var name = group.getAttribute('data-name');
            var form = group.closest('form') || document;
            var input = form.querySelector('input[name="'+name+'"]');
            var current = input && input.value != null ? String(input.value) : '';
            if (current){
              group.querySelectorAll('button[data-value]').forEach(function(b){
                var v = String(b.getAttribute('data-value')||'');
                b.classList.toggle('btn-choice-active', v === current);
              });
            }
          });
          // Pre-activate multi-choice groups from existing hidden inputs
          document.querySelectorAll('.btn-multi-group[data-name]').forEach(function(group){
            var name = group.getAttribute('data-name');
            var form = group.closest('form') || document;
            var selected = new Set();
            form.querySelectorAll('input[name="'+name+'"]').forEach(function(i){ selected.add(String(i.value)); });
            group.querySelectorAll('button.btn-choice[data-id]').forEach(function(b){
              var id = String(b.getAttribute('data-id')||'');
              if (selected.has(id)) b.classList.add('btn-choice-active');
            });
          });
        }
        function ensureHiddenContainer(group){
          var name = group.getAttribute('data-name');
          var form = group.closest('form') || document.body;
          var container = form.querySelector('.multi-hidden[data-name="'+name+'"]');
          if (!container){
            container = document.createElement('div');
            container.className = 'multi-hidden';
            container.setAttribute('data-name', name);
            form.appendChild(container);
          }
          return container;
        }
        document.addEventListener('click', function(ev){
          var btn = ev.target.closest('button');
          if (!btn) return;
          var group = btn.closest('.btn-group, .btn-multi-group');
          if (!group) return;
          // Single-choice
          if (group.classList.contains('btn-group') && btn.hasAttribute('data-value')){
            ev.preventDefault(); ev.stopPropagation();
            var name = group.getAttribute('data-name');
            var form = group.closest('form') || document;
            var input = form.querySelector('input[name="'+name+'"]');
            if (!input){ input = document.createElement('input'); input.type='hidden'; input.name=name; form.appendChild(input); }
            var val = String(btn.getAttribute('data-value')||'');
            input.value = val;
            group.querySelectorAll('button[data-value]').forEach(function(b){ b.classList.remove('btn-choice-active'); b.setAttribute('aria-pressed', 'false'); });
            btn.classList.add('btn-choice-active');
            btn.setAttribute('aria-pressed', 'true');
            return;
          }
          // Multi-choice
          if (group.classList.contains('btn-multi-group') && btn.hasAttribute('data-id')){
            ev.preventDefault(); ev.stopPropagation();
            var name = group.getAttribute('data-name');
            var container = ensureHiddenContainer(group);
            var id = String(btn.getAttribute('data-id')||'');
            var active = btn.classList.toggle('btn-choice-active');
            if (active){
              var i = document.createElement('input'); i.type='hidden'; i.name=name; i.value=id; container.appendChild(i);
            } else {
              var toRemove = container.querySelector('input[name="'+name+'"][value="'+id+'"]');
              if (toRemove) toRemove.remove();
            }
            return;
          }
        });
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', initGroups);
        } else { initGroups(); }
      })();
    </script>
</body>
</html>
