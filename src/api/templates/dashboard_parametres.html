{% extends "base.html" %}
{% block title %}Administration{% endblock %}
{% block header_title %}<i class="fa-solid fa-gear" style="margin-right:8px;"></i>Administration{% endblock %}

{% block content %}
<style>
  #paramContainer #assureursPanel,
  #paramContainer #contratsPanel,
  #paramContainer #administrationPanel {
    padding: 0.75rem 0 1.25rem;
    background: var(--surface);
  }
  /* Onglets principaux (remplace les accordéons racine) */
  .param-tabs {
    display: flex;
    gap: 10px;
    flex-wrap: nowrap;
    overflow-x: auto;
    justify-content: center;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border);
    background: #f8fafe;
  }
  .param-tab {
    border: 1px solid transparent;
    background: transparent;
    color: var(--text);
    padding: 12px 14px;
    border-radius: 12px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    box-shadow: none;
    transition: all .15s ease;
    flex: 0 0 auto;
    min-width: 150px;
    min-height: 46px;
    text-align: center;
  }
  .param-tab i { color: var(--primary-600); }
  .param-tab:hover { transform: translateY(-1px); border-color: transparent; }
  .param-tab.active {
    background: transparent;
    color: var(--primary-600);
    border-color: transparent;
    box-shadow: none;
  }
  .param-tab.active i { color: var(--primary-600); }
  #paramContainer #assureursPanel > .accordion-subtoggle,
  #paramContainer #contratsPanel > .accordion-subtoggle,
  #paramContainer #courtierPanel > .accordion-subtoggle,
  #paramContainer #administrationPanel > .accordion-subtoggle {
    margin: 0 1.25rem 0.75rem;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border-radius: 10px;
  }
  #paramContainer .accordion-toggle,
  #paramContainer .accordion-subtoggle {
    background: #fff;
    color: var(--primary-800, #1f2b6c);
    border: 1px solid var(--border);
    box-shadow: none;
    transition: background .2s ease, color .2s ease, border .2s ease;
  }
  #paramContainer .accordion-toggle.collapsed,
  #paramContainer .accordion-subtoggle.collapsed {
    background: #fff;
    color: var(--primary-800, #1f2b6c);
    border-color: var(--border);
  }
  #paramContainer .accordion-toggle:not(.collapsed),
  #paramContainer .accordion-subtoggle:not(.collapsed) {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  #paramContainer .accordion-toggle:hover,
  #paramContainer .accordion-subtoggle:hover {
    background: #f5f8ff;
  }
  #paramContainer .accordion-toggle.collapsed:hover,
  #paramContainer .accordion-subtoggle.collapsed:hover {
    color: var(--primary-800, #1f2b6c);
  }
  #paramContainer .accordion-toggle .chevron,
  #paramContainer .accordion-subtoggle .chevron {
    color: var(--primary-600);
    transition: transform .2s ease, color .2s ease;
  }
  #paramContainer .accordion-toggle:not(.collapsed) .chevron,
  #paramContainer .accordion-subtoggle:not(.collapsed) .chevron {
    color: #fff;
  }
  #paramContainer .btn-list {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 4px 9px;
    font-size: 0.8rem;
    border-radius: 999px;
    box-shadow: none;
  }
  #paramContainer .btn-list i {
    margin-right: 0 !important;
    font-size: 0.85rem;
  }
  #paramContainer table .btn-list {
    margin: 0 2px;
  }
  #paramContainer .btn-list-primary {
    border: 1px solid var(--primary);
    color: var(--primary);
    background: var(--surface);
  }
  #paramContainer .btn-list-primary:hover {
    background: var(--primary);
    color: #fff;
  }
  #paramContainer .btn-list-danger {
    border: 1px solid #ef4444;
    color: #ef4444;
    background: var(--surface);
  }
  #paramContainer .btn-list-danger:hover {
    background: #ef4444;
    color: #fff;
  }
  #paramContainer .btn-add {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid var(--primary);
    color: var(--primary);
    background: var(--surface);
    border-radius: 999px;
    padding: 4px 14px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  #paramContainer .btn-add:hover,
  #paramContainer .btn-add.active {
    background: var(--primary);
    color: #fff;
  }
  #paramContainer .create-block {
    margin-top: 1rem;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0.85rem 1rem;
    background: #f9fbff;
  }
  #paramContainer .create-header {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    margin-bottom: 0.75rem;
  }
  #paramContainer .create-body {
    display: none;
  }
  #paramContainer .create-body.active {
    display: block;
  }
  #paramContainer .support-toolbar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  #paramContainer .support-toolbar .support-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.65rem;
    align-items: flex-end;
  }
  #paramContainer .support-toolbar label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--muted);
    display: block;
    margin-bottom: 0.25rem;
  }
  #paramContainer .support-toolbar input[type="text"],
  #paramContainer .support-toolbar select {
    width: 180px;
  }
  #supportFilterContrat {
    min-width: 240px;
  }
  #paramContainer .support-toolbar .support-actions {
    display: flex;
    gap: 0.65rem;
    align-items: flex-end;
  }
  #paramContainer .support-pagination {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
    color: var(--muted);
  }
  #paramContainer .support-pagination button {
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--surface);
    padding: 4px 10px;
    cursor: pointer;
  }
  #paramContainer .support-pagination button:disabled {
    opacity: 0.4;
    cursor: default;
  }
  #paramContainer .support-rate-input {
    display: inline-flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
  }
  #paramContainer .support-rate-input input {
    width: 80px;
    text-align: right;
  }
  #paramContainer .support-sort {
    cursor: pointer;
    user-select: none;
  }
  #paramContainer .support-sort::after {
    content: ' \25B4\25BE';
    font-size: 0.7rem;
    color: var(--muted);
  }
  #paramContainer .support-sort[data-order="asc"]::after {
    content: ' \25B4';
  }
  #paramContainer .support-sort[data-order="desc"]::after {
    content: ' \25BE';
  }
  /* Portefeuille KPI */
  #paramContainer .portfolio-kpis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    align-items: stretch;
  }
  #paramContainer .portfolio-kpi {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 12px;
    min-width: 0;
    box-shadow: var(--shadow-sm);
    text-align: center;
  }
  #paramContainer .portfolio-kpi .label {
    color: var(--muted);
    font-weight: 700;
    font-size: 0.9rem;
    text-align: center;
  }
  #paramContainer .portfolio-kpi .value {
    font-size: 1.3rem;
    font-weight: 800;
    text-align: center;
  }
  /* Harmoniser la hauteur des champs dans Courtier */
  #courtierPanel select,
  #courtierPanel input[type="email"],
  #courtierPanel input[type="text"] {
    height: 36px;
  }
  #courtierPanel input[type="email"] {
    font-family: inherit;
    font-size: inherit;
  }
  #courtierPanel select {
    padding: 6px 10px;
  }
  /* Courtier > Détails: harmoniser la hauteur des listes déroulantes dans les tableaux */
  #courtierDetailsPanel select {
    height: 36px;
    padding: 6px 10px;
    line-height: 24px;
  }
  /* Harmoniser la hauteur de tous les champs dans les tableaux */
  #paramContainer table td input[type="text"],
  #paramContainer table td input[type="email"],
  #paramContainer table td input[type="tel"],
  #paramContainer table td input[type="number"],
  #paramContainer table td input[type="date"],
  #paramContainer table td input[type="time"],
  #paramContainer table td select {
    height: 36px;
    padding: 6px 10px;
    line-height: 24px;
    font-size: .95rem;
  }
  /* Harmoniser la hauteur dans les blocs de création (sous les tableaux) */
  #paramContainer .create-body input[type="text"],
  #paramContainer .create-body input[type="email"],
  #paramContainer .create-body input[type="tel"],
  #paramContainer .create-body input[type="number"],
  #paramContainer .create-body input[type="date"],
  #paramContainer .create-body input[type="time"],
  #paramContainer .create-body select,
  #paramContainer .create-body textarea {
    height: 36px;
    padding: 6px 10px;
    line-height: 24px;
    box-sizing: border-box;
    font-size: .95rem;
  }
  /* Administration > Intervenants: hauteur et largeur des champs tel/email */
  #adminIntervenantsPanel input[type="tel"],
  #adminIntervenantsPanel input[type="email"] {
    height: 36px !important;
    padding: 6px 10px !important;
    line-height: 24px !important;
  }
  #adminIntervenantsPanel td input[type="email"] {
    width: 100%;
    max-width: 420px;
    box-sizing: border-box;
  }
  #adminIntervenantsPanel td input[type="tel"] {
    width: 100%;
    max-width: 200px;
    box-sizing: border-box;
  }
  /* Administration > RH: hauteur/tailles inputs */
  #adminRhPanel input[type="text"],
  #adminRhPanel input[type="email"],
  #adminRhPanel input[type="tel"],
  #adminRhPanel select {
    height: 36px !important;
    padding: 6px 10px !important;
    line-height: 24px !important;
    font-size: .95rem;
  }
  #adminRhPanel td input[type="email"] {
    width: 100%;
    max-width: 360px;
    box-sizing: border-box;
  }
  #adminRhPanel td input[type="tel"] {
    width: 100%;
    max-width: 200px;
    box-sizing: border-box;
  }
  #adminRhPanel td input[name="commentaire"] {
    width: 100%;
    box-sizing: border-box;
  }
  /* Actions icons on one line */
  #paramContainer td.actions-cell { white-space: nowrap; }
  /* Détails: grille 2 colonnes pour aligner les largeurs par colonne */
  #courtierDetailsPanel .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-auto-rows: auto;
    gap: .75rem;
    align-items: start;
  }
  /* Détails: s'assurer que les tableaux ne débordent pas des cartes */
  #courtierDetailsPanel .card {
    overflow-x: auto;
  }
  #courtierDetailsPanel table {
    width: 100%;
    table-layout: auto;
  }
  #courtierDetailsPanel th,
  #courtierDetailsPanel td {
    white-space: normal;
  }
  /* Assurances & garanties: conserver la même police d'en-tête que les autres tableaux */
  /* (aucun override de font-size sur th) */
</style>
<div class="container" id="paramContainer">
  <div id="toastSaved" style="display:none; position: fixed; right: 16px; bottom: 16px; background: #16a34a; color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 14px rgba(0,0,0,.15); z-index: 9999;">
    <i class="fa-solid fa-circle-check" style="margin-right:6px;"></i> Enregistré
  </div>
  <div id="toastError" style="display:none; position: fixed; right: 16px; bottom: 16px; background: #dc2626; color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 14px rgba(0,0,0,.15); z-index: 9999;">
    <i class="fa-solid fa-circle-exclamation" style="margin-right:6px;"></i> Erreur lors de l'enregistrement
    <span id="toastErrorMsg" style="margin-left:6px; opacity:.9;"></span>
  </div>
  <div class="card" style="margin-bottom:1rem;">
    <div class="portfolio-kpis">
      <div class="portfolio-kpi">
        <div class="label">Nombre de placements financiers</div>
        <div class="value">{{ portfolio_total_affaires }}</div>
      </div>
      <div class="portfolio-kpi">
        <div class="label">Valorisation totale</div>
        <div class="value">{{ portfolio_total_valo_str }} €</div>
      </div>
      <div class="portfolio-kpi">
        <div class="label">Nombre de clients</div>
        <div class="value">{{ portfolio_total_clients }}</div>
      </div>
    </div>
  </div>

  <div class="card" style="padding:0; overflow:hidden;">
    <div class="param-tabs" id="paramTabs">
      <button class="param-tab active" data-target="courtierPanel"><i class="fa-solid fa-user-tie"></i> Courtier</button>
      <button class="param-tab" data-target="contratsPanel"><i class="fa-solid fa-file-contract"></i> Contrats génériques</button>
      <button class="param-tab" data-target="assureursPanel"><i class="fa-solid fa-building"></i> Assureurs / Sociétés</button>
      <button class="param-tab" data-target="supportPanel"><i class="fa-solid fa-chart-line"></i> Supports</button>
      <button class="param-tab" data-target="groupesPanel"><i class="fa-solid fa-layer-group"></i> Groupes</button>
      <button class="param-tab" data-target="administrationPanel"><i class="fa-solid fa-sitemap"></i> Administration</button>
    </div>
    <div class="accordion" id="accordionWrapper">
      <div class="accordion-toggle" data-target="courtierPanel" data-level="root">
        <span><i class="fa-solid fa-user-tie" style="margin-right:6px;"></i> Courtier</span>
        <span class="chevron">▾</span>
      </div>
      <div class="accordion-panel" id="courtierPanel" style="display:none; border-top:1px solid var(--border);">
        <div class="accordion-toggle accordion-subtoggle" data-target="courtierIdentitePanel" data-group="courtierSub">
          <span><i class="fa-solid fa-id-card" style="margin-right:6px;"></i> Identité</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="courtierIdentitePanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Identité du courtier</h3>
          {% if form_errors %}
            <div class="alert alert-danger" role="alert" style="margin:0 0 12px 0;">
              <strong>Veuillez corriger les erreurs suivantes:</strong>
              <ul style="margin:6px 0 0 1rem;">
                {% for k, msg in form_errors.items() %}
                  <li>{{ msg }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          <form method="post" action="/dashboard/parametres/der_courtier?open=courtier" class="card" style="margin:0;">
            <div class="form-row">
              <div class="field" style="min-width:260px;">
                <label>Nom de la société</label>
                <input type="text" name="nom_cabinet" value="{{ (form_courtier.nom_cabinet if form_courtier else (courtier.nom_cabinet if courtier else '')) }}" />
                {% if form_errors and form_errors.get('nom_cabinet') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('nom_cabinet') }}</div>
                {% endif %}
              </div>
              <div class="field">
                <label>Responsable</label>
                <input type="text" name="nom_responsable" value="{{ (form_courtier.nom_responsable if form_courtier else (courtier.nom_responsable if courtier else '')) }}" />
              </div>
              <div class="field">
                <label>Statuts</label>
                <select name="statut_social" required>
                  <option value="">Choisir…</option>
                  {% for s in statut_sociaux %}
                    {% set selected_val = (form_courtier.statut_social if form_courtier else (courtier.statut_social if courtier else None)) %}
                    <option value="{{ s.id }}" {% if (selected_val|int) == (s.id|int) %}selected{% endif %}>{{ s.libelle }}</option>
                  {% endfor %}
                </select>
                {% if form_errors and form_errors.get('statut_social') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('statut_social') }}</div>
                {% endif %}
              </div>
            </div>

            <div class="form-row">
              <div class="field" style="width: 18ch;">
                <label>Capital social</label>
                <input type="text" name="capital_social" id="capital_social" value="{{ (form_courtier.capital_social if form_courtier and form_courtier.capital_social is not none else (courtier.capital_social|int if courtier and courtier.capital_social is not none else '')) }}" inputmode="numeric" required />
                {% if form_errors and form_errors.get('capital_social') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('capital_social') }}</div>
                {% endif %}
              </div>
              <div class="field" style="width: 16ch;">
                <label>SIREN</label>
                {% set siren_val = (form_courtier.siren if form_courtier else (courtier.siren if courtier else '')) %}
                <input type="text" name="siren" id="siren" value="{{ siren_val }}" inputmode="numeric" required />
                {% if form_errors and form_errors.get('siren') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('siren') }}</div>
                {% endif %}
              </div>
              <div class="field" style="flex: 1 1 auto; min-width: 24ch;">
                <label>RCS</label>
                <input type="text" name="rcs" value="{{ (form_courtier.rcs if form_courtier else (courtier.rcs if courtier else '')) }}" required />
                {% if form_errors and form_errors.get('rcs') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('rcs') }}</div>
                {% endif %}
              </div>
              <div class="field" style="width: 14ch;">
                <label>Numéro ORIAS</label>
                <input type="text" name="numero_orias" id="numero_orias" value="{{ (form_courtier.numero_orias if form_courtier else (courtier.numero_orias if courtier else '')) }}" inputmode="numeric" style="width: 12ch;" required />
                {% if form_errors and form_errors.get('numero_orias') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('numero_orias') }}</div>
                {% endif %}
              </div>
            </div>

            <div class="form-row">
              <div class="field" style="flex:1 1 auto; min-width:260px;">
                <label>Adresse</label>
                <input type="text" name="adresse_rue" placeholder="Rue, voie" value="{{ (form_courtier.adresse_rue if form_courtier else (courtier.adresse_rue if courtier else '')) }}" />
              </div>
              <div class="field" style="width:120px;">
                <label>Code postal</label>
                <input type="text" name="adresse_cp" id="adresse_cp" value="{{ (form_courtier.adresse_cp if form_courtier else (courtier.adresse_cp if courtier else '')) }}" maxlength="5" inputmode="numeric" />
                {% if form_errors and form_errors.get('adresse_cp') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('adresse_cp') }}</div>
                {% endif %}
              </div>
              <div class="field">
                <label>Ville</label>
                <input type="text" name="adresse_ville" value="{{ (form_courtier.adresse_ville if form_courtier else (courtier.adresse_ville if courtier else '')) }}" />
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label>Courriel</label>
                <input type="email" name="courriel" value="{{ (form_courtier.courriel if form_courtier else (courtier.courriel if courtier else '')) }}" pattern="^\S+@\S+\.\S+$" title="Adresse courriel valide requise (ex: nom@domaine.tld)" />
                {% if form_errors and form_errors.get('courriel') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('courriel') }}</div>
                {% endif %}
              </div>
              <div class="field">
                <label>Association professionnelle</label>
                <select name="association_prof">
                  <option value="">Choisir…</option>
                  {% for s in associations_prof %}
                    {% set selected_val = (form_courtier.association_prof if form_courtier else (courtier.association_prof if courtier else None)) %}
                    <option value="{{ s.id }}" {% if (selected_val|int) == (s.id|int) %}selected{% endif %}>{{ s.libelle }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="field">
                <label>Numéro d’adhérent</label>
                <input type="text" name="num_adh_assoc" value="{{ (form_courtier.num_adh_assoc if form_courtier else (courtier.num_adh_assoc if courtier else '')) }}" />
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label>Catégorie de courtage</label>
                <select name="categorie_courtage" style="width:auto; min-width:unset;">
                  <option value="">Choisir…</option>
                  {% for opt in ['A','B','C'] %}
                    {% set selected_val = (form_courtier.categorie_courtage if form_courtier else (courtier.categorie_courtage if courtier else None)) %}
                    <option value="{{ opt }}" {% if selected_val == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="field" style="min-width:260px;">
                <label>Responsable des données numériques</label>
                <input type="text" name="responsable_dpo" value="{{ (form_courtier.responsable_dpo if form_courtier else (courtier.responsable_dpo if courtier else '')) }}" />
              </div>
            </div>

            <div class="form-row">
              <div class="field" style="width: 220px;">
                <label>Médiateur</label>
                <select name="centre_mediation" style="width: 100%;">
                  <option value="">Choisir…</option>
                  {% for s in autorites_mediation %}
                    {% set selected_val = (form_courtier.centre_mediation if form_courtier else (courtier.centre_mediation if courtier else None)) %}
                    <option value="{{ s.id }}" {% if (selected_val|int) == (s.id|int) %}selected{% endif %}>{{ s.libelle }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="field" style="flex: 1 1 auto; min-width: 260px;">
                <label>Nom des médiateurs</label>
                <input type="text" name="mediators" value="{{ (form_courtier.mediators if form_courtier else (courtier.mediators if courtier else '')) }}" />
              </div>
              <div class="field">
                <label>Courriels des médiateurs</label>
                <input type="text" name="mail_mediators" id="mail_mediators" value="{{ (form_courtier.mail_mediators if form_courtier else (courtier.mail_mediators if courtier else '')) }}" placeholder="email1@exemple.com, email2@exemple.com" />
                {% if form_errors and form_errors.get('mail_mediators') %}
                  <div class="muted" style="color:#b91c1c;">{{ form_errors.get('mail_mediators') }}</div>
                {% endif %}
              </div>
            </div>

            <div class="create-btn-container">
              <button class="btn btn-primary" type="submit">
                {% if courtier %}<i class="fa-solid fa-floppy-disk" style="color:#fff;"></i>&nbsp;Modifier{% else %}<i class="fa-solid fa-plus" style="color:#fff;"></i>&nbsp;Créer{% endif %}
              </button>
            </div>

            <div class="muted" style="font-style:italic; margin-top:.5rem;">
              {% if courtier and courtier.date_creation %}Date de création: {{ courtier.date_creation }}{% endif %}
              {% if courtier and courtier.date_obsolescence %}<br>Date de modification: {{ courtier.date_obsolescence }}{% endif %}
            </div>
          </form>
        </div>

        <div class="accordion-toggle accordion-subtoggle" data-target="courtierDocumentsPanel" data-group="courtierSub">
          <span><i class="fa-solid fa-file-shield" style="margin-right:6px;"></i> Documents réglementaires</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="courtierDocumentsPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3 style="margin-top:0;">Documents réglementaires du courtier</h3>
          <p class="muted" style="margin-bottom:1rem;">Importez les documents réglementaires (PDF) et suivez leurs dates de validité.</p>

          {% if courtier_documents %}
            {% set sorted_docs = courtier_documents|sort(attribute='activite_libelle') %}
            {% set type_ns = namespace(options=[]) %}
            {% for doc in sorted_docs %}
              {% set doc_type = doc.activite_libelle or '—' %}
              {% if doc_type not in type_ns.options %}
                {% set _ = type_ns.options.append(doc_type) %}
              {% endif %}
            {% endfor %}
            <div class="card" style="padding:0; overflow-x:auto; margin-bottom:1rem;">
              <table id="courtierDocumentsTable" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr style="text-align:left; border-bottom:1px solid var(--border);">
                    <th style="padding:0.75rem;">Type</th>
                    <th style="padding:0.75rem;">Date de validité</th>
                    <th style="padding:0.75rem;">Document</th>
                    <th style="padding:0.75rem; width:160px; text-align:center;">Actions</th>
                  </tr>
                  <tr style="text-align:left; border-bottom:1px solid var(--border); background:rgba(31,43,108,0.04);">
                    <th style="padding:0.5rem;">
                      <select id="cd_filter_type" style="width:100%; border:1px solid var(--border); border-radius:6px; padding:0.35rem 0.45rem; font-size:0.85rem; height:36px;">
                        <option value="">Tous les types</option>
                        {% for opt in type_ns.options %}
                          <option value="{{ opt }}">{{ opt }}</option>
                        {% endfor %}
                      </select>
                    </th>
                    <th style="padding:0.5rem;">
                      <input id="cd_filter_date" type="text" placeholder="JJ/MM/AAAA" style="width:100%; border:1px solid var(--border); border-radius:6px; padding:0.35rem 0.45rem; font-size:0.85rem;" />
                    </th>
                    <th style="padding:0.5rem;">
                      <input id="cd_filter_doc" type="text" placeholder="Nom du fichier" style="width:100%; border:1px solid var(--border); border-radius:6px; padding:0.35rem 0.45rem; font-size:0.85rem;" />
                    </th>
                    <th style="padding:0.5rem;">
                      <button id="cd_filter_reset" type="button" class="btn btn-list btn-list-primary" style="width:100%; justify-content:center;">Réinitialiser</button>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {% for doc in sorted_docs %}
                    {% set doc_type = doc.activite_libelle or '—' %}
                    <tr data-type="{{ doc_type }}" data-date="{{ doc.date_validite_display or '' }}" data-name="{{ doc.original_filename or doc.stored_filename }}">
                      <td style="padding:0.65rem 0.75rem;">{{ doc_type }}</td>
                      <td style="padding:0.65rem 0.75rem;">
                        {% if doc.date_validite_display %}
                          <span {% if doc.is_expired %}style="color:#b91c1c; font-weight:600;"{% endif %}>{{ doc.date_validite_display }}</span>
                        {% else %}—{% endif %}
                      </td>
                      <td style="padding:0.65rem 0.75rem;">{{ doc.original_filename or doc.stored_filename }}</td>
                      <td style="padding:0.65rem 0.75rem; white-space:nowrap;">
                        <a class="btn btn-list btn-list-primary" href="{{ doc.view_url }}" target="_blank" rel="noopener" title="Prévisualiser">
                          <i class="fa-solid fa-eye"></i>
                        </a>
                        <a class="btn btn-list btn-list-primary" href="{{ doc.download_url }}" title="Télécharger">
                          <i class="fa-solid fa-download"></i>
                        </a>
                        <a class="btn btn-list btn-list-primary" href="{{ doc.edit_url }}" title="Modifier">
                          <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                        <form method="post" action="{{ doc.delete_url }}?open=courtierDocuments" style="display:inline;" onsubmit="return confirm('Supprimer ce document ?');">
                          <button type="submit" class="btn btn-list btn-list-danger" title="Supprimer">
                            <i class="fa-solid fa-trash"></i>
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <script>
              (function () {
                const table = document.getElementById('courtierDocumentsTable');
                if (!table) { return; }
                const filterType = document.getElementById('cd_filter_type');
                const filterDate = document.getElementById('cd_filter_date');
                const filterDoc = document.getElementById('cd_filter_doc');
                const resetBtn = document.getElementById('cd_filter_reset');
                const rows = Array.from(table.querySelectorAll('tbody tr'));

                const normalize = (value) => value ? value.toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim() : '';

                function applyFilters() {
                  const qType = normalize(filterType.value);
                  const qDate = normalize(filterDate.value);
                  const qDoc = normalize(filterDoc.value);

                  rows.forEach((row) => {
                    const type = normalize(row.getAttribute('data-type'));
                    const date = normalize(row.getAttribute('data-date'));
                    const name = normalize(row.getAttribute('data-name'));
                    const matchType = !qType || type === qType;
                    const matchDate = !qDate || date.includes(qDate);
                    const matchDoc = !qDoc || name.includes(qDoc);
                    row.style.display = (matchType && matchDate && matchDoc) ? '' : 'none';
                  });
                }

                if (filterType) {
                  filterType.addEventListener('change', applyFilters);
                }
                [filterDate, filterDoc].forEach((input) => {
                  if (input) {
                    input.addEventListener('input', applyFilters);
                  }
                });

                if (resetBtn) {
                  resetBtn.addEventListener('click', () => {
                    [filterType, filterDate, filterDoc].forEach((input) => { if (input) { input.value = ''; } });
                    applyFilters();
                  });
                }

                applyFilters();
              })();
            </script>
          {% else %}
            <div class="card muted" style="padding:0.85rem 1rem; margin-bottom:1rem;">Aucun document enregistré pour le moment.</div>
          {% endif %}

          {% if not compliance_activites %}
            <div class="card muted" style="padding:0.85rem 1rem; margin-bottom:1rem;">Aucun type d'activité n'est disponible dans la table Compliance_rc_pro.</div>
          {% endif %}

          {% if courtier_document_edit %}
            <div class="card" style="padding:0.65rem 1rem; margin-bottom:0.75rem; background:#fff7ed; border:1px solid #fb923c;">
              <strong>Modification</strong> du document <span style="font-style:italic;">{{ courtier_document_edit.original_filename }}</span>.
              <a href="/dashboard/parametres?open=courtierDocuments" class="btn-add" style="margin-left:1rem;">Annuler</a>
            </div>
          {% endif %}
          <form method="post" action="/dashboard/parametres/courtier/documents?open=courtierDocuments" enctype="multipart/form-data" class="card" style="margin:0;">
            {% if courtier_document_edit %}
              <input type="hidden" name="doc_id" value="{{ courtier_document_edit.id }}" />
            {% endif %}
            <div class="form-row">
              <div class="field" style="min-width:260px;">
                <label>Type de document</label>
                <select name="activite_id" required {% if not compliance_activites %}disabled{% endif %}>
                  <option value="">Choisir…</option>
                  {% for item in compliance_activites %}
                    {% set opt_id = item.id %}
                    <option value="{{ opt_id }}" {% if courtier_document_edit and (opt_id|string) == (courtier_document_edit.activite_id|string) %}selected{% endif %}>{{ item.activite or item.libelle }}</option>
                  {% endfor %}
                  {% if not compliance_activites %}
                    <option value="">Aucune activité disponible</option>
                  {% endif %}
                </select>
              </div>
              <div class="field" style="width:200px;">
                <label>Date limite de validité</label>
                <input type="date" name="date_validite" value="{{ courtier_document_edit.date_validite_value if courtier_document_edit else '' }}" />
              </div>
              <div class="field" style="flex:1 1 240px;">
                <label>Document PDF</label>
                <input type="file" name="document_file" accept="application/pdf" {% if not courtier_document_edit %}required{% endif %} />
                {% if courtier_document_edit %}
                  <div class="muted" style="font-size:0.8rem; margin-top:0.25rem;">Laissez vide pour conserver le fichier existant.</div>
                {% endif %}
              </div>
            </div>
            <div class="create-btn-container" style="margin-top:0.75rem;">
              <button class="btn btn-primary" type="submit" {% if not compliance_activites %}disabled{% endif %}>
                {% if courtier_document_edit %}
                  <i class="fa-solid fa-floppy-disk" style="color:#fff;"></i>&nbsp;Mettre à jour
                {% else %}
                  <i class="fa-solid fa-upload" style="color:#fff;"></i>&nbsp;Déposer
                {% endif %}
              </button>
            </div>
          </form>
        </div>

        <div class="accordion-toggle accordion-subtoggle" data-target="courtierDetailsPanel" data-group="courtierSub">
          <span><i class="fa-solid fa-circle-info" style="margin-right:6px;"></i> Détails</span>
          <span class="chevron">▾</span>
        </div>
      </div>

      <!-- Ancien toggle Détails masqué: remplacé par sous-bouton dans Courtier -->
      <div class="accordion-toggle" data-target="courtierDetailsPanel" data-level="root" style="display:none;">
        <span>Détails</span>
        <span class="chevron">▾</span>
      </div>
      <div class="accordion-panel" id="courtierDetailsPanel" style="display:none; border-top:1px solid var(--border); padding:1rem 1.25rem;">
        <div class="detail-grid">
        <div class="card" style="margin:0;">
          <h3 style="margin:0 0 .5rem 0;">Activité</h3>
          <div class="muted" style="margin-bottom:.5rem;">Paramétrage des activités du courtier.</div>
          <table>
            <thead>
              <tr>
                <th style="min-width:280px;">Activité</th>
                <th style="min-width:100px; width:120px;">Statut</th>
                <th class="center" style="width:84px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for it in activite_items %}
              <tr>
                <td>
                  <select form="act-{{ it.id }}" name="ref_id" required>
                    <option value="">Choisir…</option>
                    {% for ref in activite_refs %}
                      <option value="{{ ref.id }}" {% if (it.ref_id|int) == (ref.id|int) %}selected{% endif %}>{{ ref.libelle }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <select form="act-{{ it.id }}" name="statut" required>
                    {% set s = (it.statut or 'exercee') %}
                    <option value="exercee" {% if s == 'exercee' %}selected{% endif %}>Exercée</option>
                    <option value="non_exercee" {% if s == 'non_exercee' %}selected{% endif %}>Non exercée</option>
                  </select>
                </td>
                <td class="center">
                  <form id="act-{{ it.id }}" method="post" action="/dashboard/parametres/courtier/activite/{{ it.id }}?open=courtierDetails" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="act-{{ it.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                  <form method="post" action="/dashboard/parametres/courtier/activite/{{ it.id }}/delete?open=courtierDetails" style="display:inline;" onsubmit="return confirm('Supprimer cette activité ?');">
                    <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="muted center">Aucune activité renseignée.</td></tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="courtierActiviteCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="courtierActiviteCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/courtier/activite?open=courtierDetails" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field" style="min-width:280px;">
                    <label>Activité</label>
                    <select name="ref_id" required>
                      <option value="">Choisir…</option>
                      {% for ref in activite_refs %}
                        <option value="{{ ref.id }}">{{ ref.libelle }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="field" style="min-width:180px;">
                    <label>Statut</label>
                    <select name="statut" required>
                      <option value="exercee" selected>Exercée</option>
                      <option value="non_exercee">Non exercée</option>
                    </select>
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus" style="color:#fff;"></i>&nbsp;Ajouter</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="card" style="margin:0;">
          <h3 style="margin:0 0 .5rem 0;">Relation commerciale</h3>
          <div class="muted" style="margin-bottom:.5rem;">Sélectionnez les compgnies avec lesquelles vous travaillez</div>
          <table>
            <thead>
              <tr>
                <th style="min-width:260px; width:260px;">Compagnie</th>
                <th class="center" style="width:84px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for it in relation_items %}
              <tr>
                <td>
                  <select form="rel-{{ it.id }}" name="societe_id" required style="width:260px;">
                    <option value="">Choisir…</option>
                    {% for s in societes %}
                      <option value="{{ s.id }}" {% if (it.societe_id|int) == (s.id|int) %}selected{% endif %}>{{ s.nom }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td class="center actions-cell">
                  <form id="rel-{{ it.id }}" method="post" action="/dashboard/parametres/courtier/relation/{{ it.id }}?open=courtierDetails" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="rel-{{ it.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                  <form method="post" action="/dashboard/parametres/courtier/relation/{{ it.id }}/delete?open=courtierDetails" style="display:inline;" onsubmit="return confirm('Supprimer cette relation ?');">
                    <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="muted center">Aucune relation commerciale renseignée.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="courtierRelCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="courtierRelCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/courtier/relation?open=courtierDetails" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field" style="min-width:260px;">
                    <label>Compagnie</label>
                    <select name="societe_id" required style="width:260px;">
                      <option value="">Choisir…</option>
                      {% for s in societes %}
                        <option value="{{ s.id }}">{{ s.nom }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus" style="color:#fff;"></i>&nbsp;Ajouter</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="card" style="margin:0;">
          <h3 style="margin:0 0 .5rem 0;">Rémunération</h3>
          <div class="muted" style="margin-bottom:.5rem;">Paramétrez les modes de facturation utilisés.</div>
          <table>
            <thead>
              <tr>
                <th style="min-width:160px; width:160px;">Mode</th>
                {% for col in remun_extra_cols %}
                  {% set cname = (col.name or '') %}
                  {% set nl = cname|lower %}
                  {% if nl in ['montant','valeur'] %}
                    <th style="min-width:90px; width:90px; text-align:right;">{{ cname }}</th>
                  {% elif nl in ['pourcentage','taux'] %}
                    <th style="min-width:70px; width:70px; text-align:right;">%</th>
                  {% else %}
                    <th style="min-width:120px; width:120px;">{{ cname }}</th>
                  {% endif %}
                {% endfor %}
                <th class="center" style="width:84px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for it in remun_items %}
              <tr>
                <td>
                  <select form="rem-{{ it.id }}" name="ref_id" required style="width:160px;">
                    <option value="">Choisir…</option>
                    {% for ref in remun_refs %}
                      <option value="{{ ref.id }}" {% if (it.ref_id|int) == (ref.id|int) %}selected{% endif %}>{{ ref.libelle }}</option>
                    {% endfor %}
                  </select>
                </td>
                {% for col in remun_extra_cols %}
                {% set cname = (col.name or '') %}
                {% set nl = cname|lower %}
                {% set val = it.extra[col.name] if it.extra else '' %}
                {% set t = (col.type or '').upper() %}
                <td {% if nl in ['montant','valeur','pourcentage','taux'] %} style="text-align:right;"{% endif %}>
                  {% if nl in ['montant','valeur'] %}
                    <input class="money-space-int" form="rem-{{ it.id }}" type="text" name="{{ col.name }}" value="{{ ('%d' % val) if val is not none else '' }}" style="width:90px; text-align:right;" inputmode="numeric" />
                  {% elif nl in ['pourcentage','taux'] %}
                    <input class="percent-2" form="rem-{{ it.id }}" type="text" name="{{ col.name }}" value="{{ val if val is not none else '' }}" style="width:70px; text-align:right;" inputmode="decimal" />
                  {% else %}
                    <input form="rem-{{ it.id }}" type="text" name="{{ col.name }}" value="{{ val if val is not none else '' }}" style="width:120px;" {% if 'INT' in t or 'REAL' in t or 'FLOA' in t or 'DOUB' in t or 'DEC' in t or 'NUM' in t %} inputmode="decimal" {% endif %} />
                  {% endif %}
                </td>
                {% endfor %}
                <td class="center actions-cell">
                  <form id="rem-{{ it.id }}" method="post" action="/dashboard/parametres/courtier/remuneration/{{ it.id }}?open=courtierDetails" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="rem-{{ it.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                  <form method="post" action="/dashboard/parametres/courtier/remuneration/{{ it.id }}/delete?open=courtierDetails" style="display:inline;" onsubmit="return confirm('Supprimer ce mode ?');">
                    <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="muted center">Aucun mode enregistré.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="courtierRemunCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="courtierRemunCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/courtier/remuneration?open=courtierDetails" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field" style="min-width:160px;">
                    <label>Mode</label>
                    <select name="ref_id" required style="width:160px;">
                      <option value="">Choisir…</option>
                      {% for ref in remun_refs %}
                        <option value="{{ ref.id }}">{{ ref.libelle }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  {% for col in remun_extra_cols %}
                  {% set cname = (col.name or '') %}
                  {% set nl = cname|lower %}
                  <div class="field">
                    <label>{% if nl in ['pourcentage','taux'] %}%{% else %}{{ cname }}{% endif %}</label>
                    {% if nl in ['montant','valeur'] %}
                      <input class="money-space-int" type="text" name="{{ col.name }}" style="width:90px; text-align:right;" inputmode="numeric" />
                    {% elif nl in ['pourcentage','taux'] %}
                      <input class="percent-2" type="text" name="{{ col.name }}" style="width:70px; text-align:right;" inputmode="decimal" />
                    {% else %}
                      <input type="text" name="{{ col.name }}" style="width:120px;" />
                    {% endif %}
                  </div>
                  {% endfor %}
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus" style="color:#fff;"></i>&nbsp;Ajouter</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="card" style="margin:0;">
          <h3 style="margin:0 0 .5rem 0;">Assurances & garanties</h3>
          <div class="muted" style="margin-bottom:.5rem;">Modifiez uniquement les montants normatifs.</div>
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th style="width: 180px; text-align:right;">IAS</th>
                <th style="width: 160px; text-align:right;">IOBSP</th>
                <th style="width: 160px; text-align:right;">IMMO</th>
                <th class="center" style="width:56px;"></th>
              </tr>
            </thead>
            <tbody>
              {% for g in garanties_normes %}
              <tr>
                <td>{{ g.type_garantie }}</td>
                <td style="text-align:right;">
                  <input class="money-space" form="gar-{{ g.id }}" type="text" name="{{ g._c_ias or 'IAS' }}" value="{{ ('%d' % g.IAS) if g.IAS is not none else '' }}" inputmode="numeric" style="text-align:right;" />
                </td>
                <td style="text-align:right;">
                  <input class="money-space" form="gar-{{ g.id }}" type="text" name="{{ g._c_iobsp or 'IOBSP' }}" value="{{ ('%d' % g.IOBSP) if g.IOBSP is not none else '' }}" inputmode="numeric" style="text-align:right;" />
                </td>
                <td style="text-align:right;">
                  <input class="money-space" form="gar-{{ g.id }}" type="text" name="{{ g._c_immo or 'IMMO' }}" value="{{ ('%d' % g.IMMO) if g.IMMO is not none else '' }}" inputmode="numeric" style="text-align:right;" />
                </td>
                <td class="center actions-cell">
                  <form id="gar-{{ g.id }}" method="post" action="/dashboard/parametres/courtier/garanties/{{ g.id }}?open=courtierDetails" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="gar-{{ g.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="muted center">Aucune norme enregistrée.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        </div>
      </div>
      <!-- Fin Courtier -->
      </div>
      <div class="accordion-toggle" data-target="contratsPanel" data-level="root">
        <span><i class="fa-solid fa-file-contract" style="margin-right:6px;"></i> Contrats d'assurance vie</span>
        <span class="chevron">▾</span>
      </div>
      <div class="accordion-panel" id="contratsPanel" style="display:none; border-top:1px solid var(--border);">
        <div class="accordion-toggle accordion-subtoggle" data-target="contratGeneriquesPanel" data-group="contratsSub">
          <span><i class="fa-solid fa-file-contract" style="margin-right:6px;"></i> Contrats génériques</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="contratGeneriquesPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Contrats génériques</h3>
          <table>
            <thead>
              <tr>
                <th style="min-width: 220px; width: 28%;">Nom</th>
                <th style="min-width: 240px; width: 32%;">Assureur</th>
                <th style="min-width: 220px; width: 26%;">Catégorie</th>
                <th class="right" style="width: 9%; white-space: nowrap;">FG<br>Ass.</th>
                <th class="right" style="width: 11%; white-space: nowrap;">FG<br>Courtier</th>
                <th class="center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for c in contrats_generiques %}
              <tr>
                <td><input form="contrat-{{ c.id }}" type="text" name="nom_contrat" value="{{ c.nom_contrat or '' }}" /></td>
                <td style="min-width: 240px;">
                  <select form="contrat-{{ c.id }}" name="id_societe" required>
                    {% for s in societes %}
                      <option value="{{ s.id }}" {% if s.id == c.id_societe %}selected{% endif %}>{{ s.nom }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td style="min-width: 220px;">
                  <select form="contrat-{{ c.id }}" name="id_ctg" required>
                    {% for ctg in contrat_categories %}
                      <option value="{{ ctg.id }}" {% if ctg.id == c.id_ctg %}selected{% endif %}>{{ ctg.libelle }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td class="right"><input form="contrat-{{ c.id }}" type="text" name="frais_gestion_assureur" value="{{ c.frais_gestion_assureur or '' }}" style="max-width: 7ch;" /></td>
                <td class="right"><input form="contrat-{{ c.id }}" type="text" name="frais_gestion_courtier" value="{{ c.frais_gestion_courtier or '' }}" style="max-width: 7ch;" /></td>
                <td class="center">
                  <form id="contrat-{{ c.id }}" method="post" action="/dashboard/parametres/contrats_generiques/{{ c.id }}?open=contrats" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="contrat-{{ c.id }}"><i class="fa-solid fa-floppy-disk"></i>Enregistrer</button>
                  <form method="post" action="/dashboard/parametres/contrats_generiques/{{ c.id }}/delete?open=contrats" style="display:inline;" onsubmit="return confirm('Supprimer ce contrat ?');">
                    <button class="btn btn-list btn-list-danger" type="submit"><i class="fa-solid fa-trash"></i>Supprimer</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="7" class="muted center">Aucun contrat générique enregistré.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="contratGeneriqueCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="contratGeneriqueCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/contrats_generiques?open=contrats" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field">
                    <label>Nom du contrat</label>
                    <input type="text" name="nom_contrat" required placeholder="Himalia" />
                  </div>
                  <div class="field">
                    <label>Assureur</label>
                    <select name="id_societe" required>
                      <option value="" disabled selected>Choisir…</option>
                      {% for s in societes %}
                        <option value="{{ s.id }}">{{ s.nom }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="field">
                    <label>Catégorie</label>
                    <select name="id_ctg" required>
                      <option value="" disabled selected>Choisir…</option>
                      {% for ctg in contrat_categories %}
                        <option value="{{ ctg.id }}">{{ ctg.libelle }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="field">
                    <label>Frais gestion assureur (%)</label>
                    <input type="text" name="frais_gestion_assureur" placeholder="0.60" />
                  </div>
                  <div class="field">
                    <label>Frais gestion courtier (%)</label>
                    <input type="text" name="frais_gestion_courtier" placeholder="0.40" />
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus"></i>&nbsp;Ajouter le contrat</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="accordion-toggle accordion-subtoggle" data-target="contratCatsPanel" data-group="contratsSub">
          <span><i class="fa-solid fa-list" style="margin-right:6px;"></i> Typologie</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="contratCatsPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Typologie</h3>
          <table>
            <thead>
              <tr>
                <th>Libellé</th>
                <th>Description</th>
                <th class="center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for ctg in contrat_categories %}
              <tr>
                <td><input form="contrat-ctg-{{ ctg.id }}" type="text" name="libelle" value="{{ ctg.libelle or '' }}" /></td>
                <td><input form="contrat-ctg-{{ ctg.id }}" type="text" name="description" value="{{ ctg.description or '' }}" /></td>
                <td class="center">
                  <form id="contrat-ctg-{{ ctg.id }}" method="post" action="/dashboard/parametres/contrats_generiques_ctg/{{ ctg.id }}?open=contrats" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="contrat-ctg-{{ ctg.id }}"><i class="fa-solid fa-floppy-disk"></i>Enregistrer</button>
                  <form method="post" action="/dashboard/parametres/contrats_generiques_ctg/{{ ctg.id }}/delete?open=contrats" style="display:inline;" onsubmit="return confirm('Supprimer cette catégorie ?');">
                    <button class="btn btn-list btn-list-danger" type="submit"><i class="fa-solid fa-trash"></i>Supprimer</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="muted center">Aucune catégorie enregistrée.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="contratCatCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="contratCatCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/contrats_generiques_ctg?open=contrats" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field">
                    <label>Libellé</label>
                    <input type="text" name="libelle" required placeholder="Assurance-vie" />
                  </div>
                  <div class="field">
                    <label>Description</label>
                    <input type="text" name="description" placeholder="Optionnel" />
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus"></i>&nbsp;Ajouter la catégorie</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-toggle" data-target="assureursPanel" data-level="root">
        <span><i class="fa-solid fa-building" style="margin-right:6px;"></i> Compagnies d'assurance</span>
        <span class="chevron">▾</span>
      </div>
      <div class="accordion-panel" id="assureursPanel" style="display:none; border-top:1px solid var(--border);">
        <div class="accordion-toggle accordion-subtoggle" data-target="societesPanel" data-group="assureursSub">
          <span><i class="fa-solid fa-building-columns" style="margin-right:6px;"></i> Compagnies</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="societesPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Compagnies</h3>
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th>Catégorie</th>
                <th>Contact</th>
                <th>Téléphone</th>
                <th>Email</th>
                <th>Commentaire</th>
                <th class="center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for s in societes %}
              <tr>
                <td><input form="societe-{{ s.id }}" type="text" name="nom" value="{{ s.nom or '' }}" /></td>
                <td>
                  <select form="societe-{{ s.id }}" name="id_ctg" required>
                    {% for cat in societe_categories %}
                      <option value="{{ cat.id }}" {% if cat.id == s.id_ctg %}selected{% endif %}>{{ cat.libelle }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td><input form="societe-{{ s.id }}" type="text" name="contact" value="{{ s.contact or '' }}" /></td>
                <td><input form="societe-{{ s.id }}" type="text" name="telephone" value="{{ s.telephone or '' }}" /></td>
                <td><input form="societe-{{ s.id }}" type="email" name="email" value="{{ s.email or '' }}" /></td>
                <td><input form="societe-{{ s.id }}" type="text" name="commentaire" value="{{ s.commentaire or '' }}" /></td>
                <td class="center">
                  <form id="societe-{{ s.id }}" method="post" action="/dashboard/parametres/societes/{{ s.id }}?open=societes" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="societe-{{ s.id }}"><i class="fa-solid fa-floppy-disk"></i>Enregistrer</button>
                  <form method="post" action="/dashboard/parametres/societes/{{ s.id }}/delete?open=societes" style="display:inline;" onsubmit="return confirm('Supprimer cette société ?');">
                    <button class="btn btn-list btn-list-danger" type="submit"><i class="fa-solid fa-trash"></i>Supprimer</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="7" class="muted center">Aucune société enregistrée.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="societeCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="societeCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/societes?open=societes" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field">
                    <label>Nom de la société</label>
                    <input type="text" name="nom" required placeholder="Generali" />
                  </div>
                  <div class="field">
                    <label>Catégorie</label>
                    <select name="id_ctg" required>
                      <option value="" disabled selected>Choisir…</option>
                      {% for cat in societe_categories %}
                        <option value="{{ cat.id }}">{{ cat.libelle }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="field">
                    <label>Contact / Référence</label>
                    <input type="text" name="contact" placeholder="Nom du contact" />
                  </div>
                  <div class="field">
                    <label>Téléphone</label>
                    <input type="text" name="telephone" placeholder="01 23 45 67 89" />
                  </div>
                  <div class="field">
                    <label>Email</label>
                    <input type="email" name="email" placeholder="contact@compagnie.fr" />
                  </div>
                </div>
                <div class="field">
                  <label>Commentaire</label>
                  <textarea name="commentaire" rows="2" placeholder="Informations complémentaires"></textarea>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>Ajouter la société</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="accordion-toggle accordion-subtoggle" data-target="societeCatsPanel" data-group="assureursSub">
          <span><i class="fa-solid fa-list" style="margin-right:6px;"></i> Typologie</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="societeCatsPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Typologie</h3>
          <table>
            <thead>
              <tr>
                <th>Libellé</th>
                <th>Description</th>
                <th class="center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for cat in societe_categories %}
              <tr>
                <td><input form="soc-cat-{{ cat.id }}" type="text" name="libelle" value="{{ cat.libelle or '' }}" /></td>
                <td><input form="soc-cat-{{ cat.id }}" type="text" name="description" value="{{ cat.description or '' }}" /></td>
                <td class="center">
                  <form id="soc-cat-{{ cat.id }}" method="post" action="/dashboard/parametres/societe_ctg/{{ cat.id }}?open=societes" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="soc-cat-{{ cat.id }}"><i class="fa-solid fa-floppy-disk"></i>Enregistrer</button>
                  <form method="post" action="/dashboard/parametres/societe_ctg/{{ cat.id }}/delete?open=societes" style="display:inline;" onsubmit="return confirm('Supprimer cette catégorie ?');">
                    <button class="btn btn-list btn-list-danger" type="submit"><i class="fa-solid fa-trash"></i>Supprimer</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="muted center">Aucune catégorie enregistrée.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="societeCatCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="societeCatCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/societe_ctg?open=societes" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field">
                    <label>Libellé</label>
                    <input type="text" name="libelle" required placeholder="Assureur" />
                  </div>
                  <div class="field">
                    <label>Description</label>
                    <input type="text" name="description" placeholder="Optionnel" />
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>Ajouter la catégorie</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-toggle" data-target="supportPanel" data-level="root">
        <span><i class="fa-solid fa-layer-group" style="margin-right:6px;"></i> Supports financiers & rétrocessions</span>
        <span class="chevron">▾</span>
      </div>
      <div class="accordion-panel" id="supportPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
        <div class="support-toolbar">
          <div class="support-filters">
            <div>
              <label for="supportFilterContrat">Contrat</label>
              <select id="supportFilterContrat">
                <option value="">Tous les contrats</option>
                {% for c in contrats_generiques %}
                  <option value="{{ c.id }}">{{ c.nom_contrat }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="supportFilterSupport">Support</label>
              <input type="text" id="supportFilterSupport" placeholder="Rechercher un support" />
            </div>
          </div>
          <div class="support-actions">
            <div>
              <label for="supportPageSize">Lignes</label>
              <select id="supportPageSize">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="all">Toutes</option>
              </select>
            </div>
            <button type="button" class="btn btn-add" id="supportCsvExport"><i class="fa-solid fa-download"></i><span>Exporter CSV</span></button>
          </div>
        </div>
        <div class="support-pagination">
          <button type="button" id="supportPrev">‹</button>
          <span id="supportPageInfo">0-0 sur 0</span>
          <button type="button" id="supportNext">›</button>
        </div>
        <table>
          <thead>
            <tr>
              <th class="support-sort" data-sort="support" title="Trier par support">Support</th>
              <th class="support-sort" data-sort="categorie" title="Trier par catégorie">Catégorie</th>
              <th class="support-sort" data-sort="zone" title="Trier par zone géo">Zone géo</th>
              <th class="support-sort" data-sort="promoteur" title="Trier par promoteur">Promoteur</th>
              <th class="support-sort" data-sort="taux" title="Trier par taux" style="width: 8%;">Taux (%)</th>
              <th class="center">Actions</th>
            </tr>
          </thead>
          <tbody id="supportTableBody">
            {% for cs in contrat_supports %}
            <tr>
              <td>{{ cs.support_nom or '—' }}</td>
              <td>{{ cs.cat_gene or '—' }}</td>
              <td>{{ cs.cat_geo or '—' }}</td>
              <td>{{ cs.promoteur or '—' }}</td>
              <td class="right">
                <div class="support-rate-input">
                  <input form="support-{{ cs.id }}" type="text" name="taux_retro" value="{{ ('%.2f' % ((cs.taux_retro or 0.0) * 100)) }}" inputmode="decimal" />
                  <span class="muted">%</span>
                </div>
              </td>
              <td class="center">
                <form id="support-{{ cs.id }}" method="post" action="/dashboard/parametres/contrat_supports/{{ cs.id }}?open=supports" style="display:inline;"></form>
                <button class="btn btn-list btn-list-primary" type="submit" form="support-{{ cs.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                <form method="post" action="/dashboard/parametres/contrat_supports/{{ cs.id }}/delete?open=supports" style="display:inline;" onsubmit="return confirm('Supprimer ce support du contrat ?');">
                  <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="muted center">Sélectionnez un contrat pour afficher les supports.</td></tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="create-block">
          <div class="create-header">
            <button type="button" class="btn btn-add" data-toggle-form="supportCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
          </div>
          <div id="supportCreate" class="create-body">
            <form method="post" action="/dashboard/parametres/contrat_supports?open=supports" class="card" style="margin:0;">
              <div class="form-row">
                <div class="field">
                  <label>Contrat</label>
                  <select name="id_affaire_generique" required>
                    <option value="" disabled selected>Choisir…</option>
                    {% for c in contrats_generiques %}
                      <option value="{{ c.id }}">{{ c.nom_contrat }} ({{ c.societe_nom }})</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="field">
                  <label>Support financier</label>
                  <select name="id_support" required>
                    <option value="" disabled selected>Choisir…</option>
                    {% for s in supports %}
                      <option value="{{ s.id }}">{{ s.nom }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="field">
                  <label>Taux de rétrocession (%)</label>
                  <input type="text" name="taux_retro" placeholder="2.00" required />
                </div>
              </div>
              <div class="create-btn-container">
                <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus"></i>&nbsp;Ajouter le support au contrat</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="accordion-toggle" data-target="groupesPanel" data-level="root">
        <span><i class="fa-solid fa-people-group" style="margin-right:6px;"></i> Groupes</span>
        <span class="chevron">▾</span>
      </div>
      <div class="accordion-panel" id="groupesPanel" style="display:none; border-top:1px solid var(--border); padding: 1rem 1.25rem;">
        <style>
          /* Réduction des polices sur tout le panneau Groupes */
          #groupesPanel, #groupesPanel table, #groupesPanel input, #groupesPanel select, #groupesPanel .btn, #groupesPanel .badge {
            font-size: 0.9rem;
          }
          #groupesPanel thead th { font-size: 0.8rem; }
          #groupesPanel table td input, #groupesPanel table td select { height: 32px; }
        </style>
        <h3 style="margin:0 0 .5rem 0;">Gestion des groupes</h3>
        <p class="muted" style="margin:0 0 .75rem 0;">Créer, modifier et supprimer des groupes (Personnes / Affaires). Le responsable est choisi parmi les intervenants RH.</p>
        <style>
          #groupViewModal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 9999; }
          #groupViewModal .modal-card { background:#fff; border-radius:12px; width: 880px; max-width: 96vw; max-height: 92vh; overflow:auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
          #groupViewModal .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom:1px solid var(--border); }
          #groupViewModal .modal-body { padding: 12px 14px; }
          #groupViewModal .kv { display:grid; grid-template-columns: 160px 1fr; gap: 6px 10px; margin-bottom: 10px; }
          #groupViewModal .kv div { padding: 2px 0; }
          #groupViewModal .kv .label { color: var(--muted); }
          /* Table membres: libellé ellipsé + Actif centré */
          #groupViewMembers { table-layout: fixed; }
          #groupViewMembers th:nth-child(2), #groupViewMembers td:nth-child(2) {
            max-width: 520px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
          }
          #groupViewMembers th:nth-child(3), #groupViewMembers td:nth-child(3) { text-align: center; }
        </style>
        <div id="groupViewModal" onclick="if(event.target===this) this.style.display='none'">
          <div class="modal-card">
            <div class="modal-header">
              <h3 id="groupViewTitle" style="margin:0;"><i class="fa-solid fa-eye" style="margin-right:8px;"></i>Détails du groupe</h3>
              <button type="button" class="btn" onclick="document.getElementById('groupViewModal').style.display='none'">Fermer</button>
            </div>
            <div class="modal-body">
              <div class="card" style="margin:0 0 10px 0;">
                <div class="kv">
                  <div class="label">Nom</div><div id="gv_nom"></div>
                  <div class="label">Type</div><div id="gv_type"></div>
                  <div class="label">Responsable</div><div id="gv_resp"></div>
                  <div class="label">Création</div><div id="gv_crea" class="js-local-dt"></div>
                  <div class="label">Fin</div><div id="gv_fin" class="js-local-dt"></div>
                  <div class="label">Actif</div><div id="gv_actif"></div>
                  <div class="label">Motif</div><div id="gv_motif"></div>
                </div>
              </div>

              <div class="card" style="margin:0 0 10px 0;">
                <h4 style="margin:0 0 6px 0;">Créer des tâches pour les membres</h4>
                <div class="form-row" style="margin-bottom:.6rem;">
                  <div class="field">
                    <label>Catégorie</label>
                    <select id="gt_cat">
                      <option value="">-- choisir --</option>
                      {% for c in evt_categories %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
                    </select>
                  </div>
                  <div class="field">
                    <label>Type</label>
                    <select id="gt_type"><option value="">-- choisir une catégorie --</option></select>
                  </div>
                  <div class="field">
                    <label>Statut initial</label>
                    <select id="gt_statut">
                      <option value="">(par défaut)</option>
                      {% for s in evt_statuts %}<option value="{{ s.id }}">{{ s.libelle }}</option>{% endfor %}
                    </select>
                  </div>
                  <div class="field">
                    <label>Affecter à (RH)</label>
                    <select id="gt_rh" style="height:36px;">
                      <option value="">(par défaut: responsable)</option>
                      {% for rh in admin_rh %}
                        <option value="{{ rh.id }}">{{ rh.prenom }} {{ rh.nom }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="form-row" style="margin-bottom:.6rem;">
                  <div class="field" style="grid-column:1/-1;">
                    <label>Commentaire</label>
                    <input type="text" id="gt_comment" placeholder="Commentaire commun (facultatif)" />
                  </div>
                </div>
                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                  <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="gt_active_only" checked /> Membres actifs uniquement</label>
                  <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="gt_simulate" /> Simulation</label>
                  <button class="btn btn-primary" id="gt_run_btn"><i class="fa-solid fa-play" style="margin-right:6px;"></i>Lancer</button>
                  <span id="gt_result" class="muted"></span>
                </div>
              </div>

              <h4 style="margin: 10px 0 6px 0;">Journal</h4>
              <div id="groupTaskLogs" class="card" style="max-height:220px; overflow:auto; font-size:.9rem;"></div>

              <h4 style="margin: 0 0 6px 0;">Membres</h4>
              <table id="groupViewMembers">
                <thead>
                  <tr>
                    <th style="width: 120px;">Type</th>
                    <th style="min-width: 320px;">Libellé</th>
                    <th class="center" style="width: 90px;">Actif</th>
                    <th style="width: 80px;">Ajout</th>
                    <th style="width: 80px;">Retrait</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <script>
          async function openGroupView(key, by){
            const modal = document.getElementById('groupViewModal');
            if (!key){ return; }
            try {
              const url = '/api/groupes/overview/' + encodeURIComponent(key) + (by ? ('?by=' + encodeURIComponent(by)) : '');
              const data = await fetch(url).then(r => r.json());
              const d = data.detail || {};
              document.getElementById('groupViewTitle').innerHTML = '<i class="fa-solid fa-eye" style="margin-right:8px;"></i>Détails du groupe – ' + (d.nom || '');
              document.getElementById('gv_nom').textContent = d.nom || '';
              document.getElementById('gv_type').textContent = d.type_display || d.type_groupe || '';
              document.getElementById('gv_resp').textContent = d.responsable_nom || (d.responsable_id ? ('#' + d.responsable_id) : '');
              const crea = document.getElementById('gv_crea'); crea.setAttribute('data-iso', d.date_creation || ''); crea.textContent = d.date_creation || '';
              const fin = document.getElementById('gv_fin'); fin.setAttribute('data-iso', d.date_fin || ''); fin.textContent = d.date_fin || '';
              document.getElementById('gv_actif').textContent = (String(d.actif) === '1' || String(d.actif).toLowerCase()==='true') ? 'Oui' : 'Non';
              document.getElementById('gv_motif').textContent = d.motif || '';
              // Préselection type list en fonction de la catégorie
              try {
                const catSel = document.getElementById('gt_cat');
                const typeSel = document.getElementById('gt_type');
                const TYPES = [
                  {% for t in evt_types %}
                    { libelle: {{ t.libelle|tojson }}, categorie: {{ t.categorie|tojson }} },
                  {% endfor %}
                ];
                function syncTypes(){
                  typeSel.innerHTML = '';
                  if (!catSel.value){ const o=document.createElement('option'); o.value=''; o.textContent='-- choisir une catégorie --'; typeSel.appendChild(o); return; }
                  const opts = TYPES.filter(t=>t.categorie===catSel.value).map(t=>t.libelle);
                  opts.forEach(l=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; typeSel.appendChild(o); });
                }
                catSel.removeEventListener('change', catSel.__syncTypes || (()=>{}));
                catSel.__syncTypes = syncTypes; catSel.addEventListener('change', syncTypes);
                if (catSel.value) syncTypes();
              } catch(e){}

              // Charger le journal + état actif
              loadGroupTaskLogs(key, by);
              const body = document.querySelector('#groupViewMembers tbody');
              body.innerHTML = '';
              (data.members || []).forEach(m => {
                const tr = document.createElement('tr');
                const t1 = document.createElement('td'); t1.textContent = (m.type==='client'?'Personne':(m.type==='affaire'?'Affaire':'—')); tr.appendChild(t1);
                const t3 = document.createElement('td');
                const lbl = m.label || '';
                const id = m.entity_id;
                if ((m.type==='client' || m.type==='affaire') && id){
                  const a = document.createElement('a');
                  a.href = m.type==='client' ? ('/dashboard/clients/' + encodeURIComponent(id)) : ('/dashboard/affaires/' + encodeURIComponent(id));
                  a.textContent = lbl;
                  a.title = lbl;
                  a.target = '_blank';
                  a.rel = 'noopener noreferrer';
                  a.style.textDecoration = 'underline';
                  t3.appendChild(a);
                } else {
                  t3.textContent = lbl; t3.title = lbl;
                }
                tr.appendChild(t3);
                const t4 = document.createElement('td'); t4.textContent = (m.actif===1 || String(m.actif).toLowerCase()==='true')?'Oui':'Non'; t4.style.textAlign = 'center'; tr.appendChild(t4);
                const t5 = document.createElement('td'); t5.className='js-local-dt'; t5.setAttribute('data-iso', m.date_ajout || ''); tr.appendChild(t5);
                const t6 = document.createElement('td'); t6.className='js-local-dt'; t6.setAttribute('data-iso', m.date_retrait || ''); tr.appendChild(t6);
                body.appendChild(tr);
              });
              // trigger client-side date localization for this modal
              try { (function(){
                var nodes = document.querySelectorAll('#groupViewModal .js-local-dt');
                nodes.forEach(function (el) {
                  var iso = el.getAttribute('data-iso') || (el.textContent || '').trim();
                  if (!iso) { el.textContent=''; return; }
                  var s = iso;
                  if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}(?::\d{2})?)?$/.test(s)) { s = s.replace(' ', 'T') + 'Z'; }
                  var d = new Date(s);
                  if (isNaN(d)) { el.textContent = iso; return; }
                  try { el.textContent = d.toLocaleString('fr-FR', { timeZone: 'Europe/Paris' }); }
                  catch(e){ el.textContent = d.toLocaleString(); }
                });
              })(); } catch(e){}
              modal.style.display = 'flex';
            } catch (e) {
              console.error(e);
              alert('Erreur lors du chargement des données du groupe');
            }
          }

          async function loadGroupTaskLogs(key, by){
            try{
              const url = '/dashboard/parametres/administration/groupes/'+encodeURIComponent(key)+'/tasks/logs'+(by?('?by='+encodeURIComponent(by)):'');
              const res = await fetch(url);
              if (!res.ok) throw new Error('HTTP '+res.status);
              const data = await res.json();
              const logs = data.logs || [];
              const box = document.getElementById('groupTaskLogs');
              box.innerHTML = logs.length ? '' : '<div class="muted">Aucun journal.</div>';
              logs.forEach(l=>{
                const div = document.createElement('div');
                div.style.padding='6px 8px'; div.style.borderBottom='1px solid var(--border)';
                div.textContent = `[${l.created_at||''}] ${l.status||''} • ${l.summary||''}`;
                box.appendChild(div);
              });
              const btn = document.getElementById('gt_run_btn');
              const resSpan = document.getElementById('gt_result');
              if (data.active){ btn.disabled = true; if(resSpan) resSpan.textContent = 'Une campagne est déjà en cours.'; }
              else { btn.disabled = false; if(resSpan) resSpan.textContent = ''; }
              // Binder le bouton run (simulation ou exécution)
              btn.onclick = async function(){
                const cat = document.getElementById('gt_cat').value || '';
                const typ = document.getElementById('gt_type').value || '';
                const sid = document.getElementById('gt_statut').value || '';
                const comm = document.getElementById('gt_comment').value || '';
                const activeOnly = document.getElementById('gt_active_only').checked ? 1 : 0;
                const sim = document.getElementById('gt_simulate').checked ? 1 : 0;
                const rh = document.getElementById('gt_rh').value || '';
                const payload = { categorie: cat||null, type_libelle: typ||null, statut_id: sid? Number(sid): null, commentaire: comm||null, actifs_only: !!activeOnly, rh_id: rh? Number(rh): null };
                const ep = sim ? '/simulate' : '/run';
                btn.disabled = true; resSpan.textContent = sim? 'Simulation…' : 'Création…';
                try{
                  const r = await fetch('/dashboard/parametres/administration/groupes/'+encodeURIComponent(key)+'/tasks'+ep+(by?('?by='+encodeURIComponent(by)):'') , { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                  const out = await r.json();
                  if (!r.ok) throw new Error(out.detail || ('HTTP '+r.status));
                  resSpan.textContent = (sim? 'Simulé: ' : 'Créé: ') + (out.created||0) + ' / ' + (out.total||0) + (out.ignored? (' (ignorés: '+out.ignored+')') : '');
                  loadGroupTaskLogs(key, by);
                } catch(e){ resSpan.textContent = 'Erreur: ' + (e.message||e); }
                finally { btn.disabled = false; }
              };
            }catch(e){ console.warn('loadGroupTaskLogs error', e); }
          }
        </script>
        <table id="groupesTable">
          <thead>
            <tr>
              <th style="width: 120px;">Type</th>
              <th style="min-width: 360px;">Nom</th>
              <th style="width: 240px;">Responsable</th>
              <th class="center" style="width: 80px;">Nbre</th>
              <th style="width: 80px;">Actif</th>
              <th class="center" style="width: 110px;">Actions</th>
            </tr>
            <tr>
              <th><input id="gf_type" type="text" placeholder="Filtrer type" /></th>
              <th><input id="gf_nom" type="text" placeholder="Filtrer nom" /></th>
              <th><input id="gf_resp" type="text" placeholder="Filtrer responsable" /></th>
              <th></th>
              <th>
                <select id="gf_actif">
                  <option value="">Tous</option>
                  <option value="oui">Oui</option>
                  <option value="non">Non</option>
                </select>
              </th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for g in groupes_details %}
            {% set tg = (g.type_groupe or '')|lower %}
            {% if tg in ['client','clients','personne','personnes'] %}{% set typedisp = 'Personnes' %}
            {% elif tg in ['affaire','affaires','contrat','contrats'] %}{% set typedisp = 'Affaires' %}
            {% else %}{% set typedisp = g.type_groupe or '' %}{% endif %}
            {% set rowkey = g.id %}
            {% if rowkey is none %}
            <tr>
              <td colspan="6" style="color:#b30000; font-weight:bold;">Groupe sans identifiant : mettre à jour la colonne id de administration_groupe_detail.</td>
            </tr>
            {% else %}
            <tr>
              <td>
                <form id="grp-{{ rowkey }}" method="post" action="/dashboard/parametres/administration/groupes/{{ rowkey }}?open=administration_groupes" style="display:inline;"></form>
                <span class="badge">{{ typedisp }}</span>
                <input form="grp-{{ rowkey }}" type="hidden" name="type_groupe" value="{{ g.type_groupe or '' }}" />
              </td>
              <td><input form="grp-{{ rowkey }}" type="text" name="nom" value="{{ g.nom or '' }}" required style="min-width:340px; width:100%;" /></td>
              <td>
                <select form="grp-{{ rowkey }}" name="responsable_id" required>
                  <option value="">Choisir…</option>
                  {% for rh in admin_rh %}
                    <option value="{{ rh.id }}" {% if (rh.id|int) == (g.responsable_id|int) %}selected{% endif %}>{{ rh.prenom }} {{ rh.nom }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="center">{{ g.nb_membres or 0 }}</td>
              <td>
                <select form="grp-{{ rowkey }}" name="actif">
                  <option value="1" {% if (g.actif|int) == 1 %}selected{% endif %}>Oui</option>
                  <option value="0" {% if (g.actif|int) != 1 %}selected{% endif %}>Non</option>
                </select>
              </td>
              <td class="center actions-cell">
                <button class="btn btn-list btn-list-primary" type="button" title="Voir" onclick="openGroupView({{ rowkey }})"><i class="fa-solid fa-eye"></i></button>
                <button class="btn btn-list btn-list-primary" type="submit" form="grp-{{ rowkey }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                <form method="post" action="/dashboard/parametres/administration/groupes/{{ rowkey }}/delete?open=administration_groupes" style="display:inline;" onsubmit="return confirm('Supprimer ce groupe ?\nLes liens d’adhésion seront aussi supprimés.');">
                  <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                </form>
              </td>
            </tr>
            {% endif %}
            {% else %}
            <tr><td colspan="8" class="muted center">Aucun groupe défini.</td></tr>
            {% endfor %}
          </tbody>
        </table>
        <script>
          (function(){
            function norm(s){ return (String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()); }
            function match(hay, needle){ hay = norm(hay); needle = norm(needle); return hay.indexOf(needle) !== -1; }
            function applyFilters(){
              var ftype = document.getElementById('gf_type').value || '';
              var fnom = document.getElementById('gf_nom').value || '';
              var fresp = document.getElementById('gf_resp').value || '';
              var fact = document.getElementById('gf_actif').value || '';
              var rows = document.querySelectorAll('#groupesTable tbody tr');
              rows.forEach(function(tr){
                var tds = tr.querySelectorAll('td');
                var vtype = (tds[0] && tds[0].innerText) || '';
                var vnom = (tds[1] && tds[1].querySelector('input') ? tds[1].querySelector('input').value : tds[1].innerText) || '';
                var vresp = (tds[2] && tds[2].innerText) || '';
                // tds[3] = Nbre (non filtré)
                var vact = (tds[4] && tds[4].innerText) || '';
                var ok = true;
                if (ftype && !match(vtype, ftype)) ok = false;
                if (fnom && !match(vnom, fnom)) ok = false;
                if (fresp && !match(vresp, fresp)) ok = false;
                if (fact) {
                  var av = norm(vact).includes('oui') ? 'oui' : (norm(vact).includes('non') ? 'non' : '');
                  if (av !== fact) ok = false;
                }
                tr.style.display = ok ? '' : 'none';
              });
            }
            ['gf_type','gf_nom','gf_resp','gf_actif'].forEach(function(id){
              var el = document.getElementById(id); if (!el) return;
              el.addEventListener('input', applyFilters);
              el.addEventListener('change', applyFilters);
            });
          })();
        </script>
        <div class="create-block">
          <div class="create-header">
            <button type="button" class="btn btn-add" data-toggle-form="groupCreate"><i class="fa-solid fa-plus"></i><span>Créer un groupe</span></button>
          </div>
          <div id="groupCreate" class="create-body">
            <form method="post" action="/dashboard/parametres/administration/groupes?open=administration_groupes" class="card" style="margin:0;">
              <div class="form-row">
                <div class="field" style="min-width: 140px;">
                  <label>Type</label>
                  <select name="type_groupe" required>
                    <option value="client">Personnes</option>
                    <option value="affaire">Affaires</option>
                  </select>
                </div>
                <div class="field" style="min-width: 220px;">
                  <label>Nom</label>
                  <input type="text" name="nom" required />
                </div>
                <div class="field" style="min-width: 160px;">
                  <label>Création</label>
                  <input type="date" name="date_creation" />
                </div>
                <div class="field" style="min-width: 160px;">
                  <label>Fin</label>
                  <input type="date" name="date_fin" />
                </div>
                <div class="field" style="min-width: 220px;">
                  <label>Responsable</label>
                  <select name="responsable_id" required>
                    <option value="">Choisir…</option>
                    {% for rh in admin_rh %}<option value="{{ rh.id }}">{{ rh.prenom }} {{ rh.nom }}</option>{% endfor %}
                  </select>
                </div>
                <div class="field" style="min-width: 200px;">
                  <label>Actif</label>
                  <select name="actif">
                    <option value="1" selected>Oui</option>
                    <option value="0">Non</option>
                  </select>
                </div>
              </div>
              <div class="form-row" style="margin-top:.5rem;">
                <div class="field" style="grid-column: 1 / -1;">
                  <label>Motif</label>
                  <input type="text" name="motif" />
                </div>
              </div>
              <div class="create-btn-container">
                <button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk" style="color:#fff;"></i>&nbsp;Créer le groupe</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="accordion-toggle" data-target="administrationPanel" data-level="root">
        <span><i class="fa-solid fa-sitemap" style="margin-right:6px;"></i> Administration</span>
        <span class="chevron">▾</span>
      </div>
      <div class="accordion-panel" id="administrationPanel" style="display:none; border-top:1px solid var(--border);">
        <div class="accordion-toggle accordion-subtoggle" data-target="adminPortfolioPanel" data-group="adminSub">
          <span><i class="fa-solid fa-briefcase" style="margin-right:6px;"></i> Portefeuille</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="adminPortfolioPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <div class="card" style="margin:0; text-align:left;">
            <h3 style="margin:0;">Portefeuille -13</h3>
            <div class="muted" style="margin:6px 0 10px 0; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace); font-size:0.9rem; white-space:pre; overflow:auto;">
SELECT MAX(date(h.date)) AS max_date
FROM mariadb_historique_support_w h;
-- max_date = {{ finance_max_date_iso or '—' }}
            </div>
            <form id="financeForm" method="get" action="/dashboard/parametres#adminPortfolioPanel" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:10px;">
              <input type="hidden" name="open" value="administration_portefeuille" />
              <div>
                <label class="muted" style="font-size:0.85rem;">Date d'analyse</label><br>
                <input type="date" name="finance_date" value="{{ finance_effective_date_iso or finance_date_input or 'YYYY-MM-DD' }}" style="height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;" />
              </div>
              <div>
                <label class="muted" style="font-size:0.85rem;">Responsable commercial</label><br>
                <select name="finance_rh" style="min-width:220px; height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;">
                  <option value="">Tous</option>
                  {% for rh in finance_rh_options %}
                    <option value="{{ rh.id }}" {% if finance_rh_selected is not none and rh.id == finance_rh_selected %}selected{% endif %}>{{ rh.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="muted" style="font-size:0.85rem;">Valorisation</label><br>
                <input type="text" name="finance_valo" value="{{ finance_valo_input or '' }}" placeholder=">100k, 100k-500k" style="min-width:200px; height:36px; padding:6px 10px; border:1px solid var(--border); border-radius:8px;" />
              </div>
              <div>
                <button type="submit" class="btn-primary" style="height:36px;">Filtrer</button>
              </div>
              <div>
                <button type="button" class="btn" id="finance_export_btn" style="height:36px;">Exporter CSV</button>
              </div>
            </form>
            <div class="muted" style="margin-top:8px; font-size:0.85rem;">Date retenue (vendredi max mariadb_historique_support_w) : {{ finance_effective_date_display or finance_effective_date_iso or finance_max_date_display or finance_max_date_iso or 'YYYY-MM-DD' }}</div>
            <div style="margin-top:4px; font-weight:600;">Total valorisation : {{ finance_total_valo_str }} €</div>
            <div style="margin-top:10px; padding:10px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; font-family:var(--font-mono, 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace); font-size:0.9rem; white-space:pre; overflow:auto;">
SELECT
    s.code_isin AS code_isin,
    s.nom AS nom,
    s.cat_principale AS cat_principale,
    s.cat_geo AS cat_geo,
    s.SRRI AS srri,
    SUM(h.valo) AS total_valo
FROM mariadb_historique_support_w h
JOIN mariadb_support s ON s.id = h.id_support
JOIN mariadb_affaires a ON a.id = h.id_source
LEFT JOIN mariadb_clients c ON c.id = a.id_personne
WHERE h.date = '{{ finance_effective_date_iso or finance_max_date_iso or 'YYYY-MM-DD' }}'
GROUP BY s.code_isin, s.nom, s.cat_principale, s.cat_geo, s.SRRI
HAVING SUM(h.valo) > 0
ORDER BY total_valo DESC;
            </div>
            {% if finance_supports %}
            <div style="margin-top:12px; overflow-x:auto;">
          <table id="financeSupportsTable" style="width:100%; border-collapse:collapse; font-size:0.9rem;">
            <thead>
              <tr style="background:#f1f5f9; text-align:left; font-size:0.85rem;">
                <th style="padding:4px 8px;">Code ISIN</th>
                <th style="padding:4px 8px;">Support</th>
                <th style="padding:4px 8px;">Catégorie principale</th>
                <th style="padding:4px 8px;">Catégorie géo</th>
                <th style="padding:4px 8px;">SRRI</th>
                <th style="padding:4px 8px; text-align:right;">Valorisation</th>
              </tr>
            </thead>
                <tbody>
                  {% for sup in finance_supports %}
                  <tr data-row-index="{{ loop.index0 }}"{% if loop.index is even %} style="background:#f8fafc;"{% endif %}>
                    <td style="padding:6px 10px;">
                      {% if sup.code_isin %}
                        <a href="/dashboard/supports/details?code_isin={{ sup.code_isin }}" target="_blank" rel="noopener" class="finance-support-link" data-support-code="{{ sup.code_isin }}" data-support-name="{{ sup.nom or '' }}" data-clients='{{ sup.clients | tojson | safe }}'>{{ sup.code_isin }}</a>
                      {% else %}
                        {{ sup.code_isin or '—' }}
                      {% endif %}
                    </td>
                    <td style="padding:6px 10px;">
                      {% if sup.code_isin %}
                        <a href="/dashboard/supports/details?code_isin={{ sup.code_isin }}" target="_blank" rel="noopener">{{ sup.nom or '—' }}</a>
                      {% else %}
                        {{ sup.nom or '—' }}
                      {% endif %}
                    </td>
                    <td style="padding:6px 10px;">{{ sup.cat_principale or '—' }}</td>
                    <td style="padding:6px 10px;">{{ sup.cat_geo or '—' }}</td>
                    <td style="padding:6px 10px;">{{ sup.srri if sup.srri is not none else '—' }}</td>
                    <td style="padding:6px 10px; text-align:right;">{{ sup.total_valo_str }} €</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div style="display:flex; align-items:center; gap:12px; margin-top:10px; flex-wrap:wrap;">
              <div style="font-weight:600;">Page <span id="financePageLabel">1</span></div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button type="button" class="btn" id="financePrevBtn" onclick="financeGoPage(-1)">Précédent</button>
                <button type="button" class="btn" id="financeNextBtn" onclick="financeGoPage(1)">Suivant</button>
              </div>
            </div>

    <div id="financeSupportModal" onclick="if(event.target===this) closeFinanceSupportModal()">
              <div class="modal-card">
                <div class="modal-header">
                  <h3><i class="fa-solid fa-users-line" style="margin-right:8px;"></i><span id="financeSupportModalLabel">Clients par support</span></h3>
                  <button class="modal-close" onclick="closeFinanceSupportModal()">✕</button>
                </div>
                <div class="modal-body">
                  <div id="financeSupportGroupActions" style="display:none; margin-bottom:12px;">
                    <div style="font-weight:600; margin-bottom:6px;">Ajouter ces clients à un groupe</div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
                      <div>
                        <label class="muted" style="font-size:0.85rem; display:block; margin-bottom:4px;">Groupe existant</label>
                        <select id="financeSupportGroupSelect" style="min-width:240px; height:34px;"></select>
                      </div>
                      <div>
                        <button type="button" class="btn btn-primary" id="financeSupportGroupAddBtn" style="height:34px;">
                          <i class="fa-solid fa-user-group" style="margin-right:6px; color:#fff;"></i>Ajouter la liste
                        </button>
                      </div>
                    </div>
                    <div id="financeSupportGroupStatus" class="muted" style="margin-top:4px;"></div>
                  </div>
                  <table id="financeSupportModalTable">
                    <thead>
                      <tr>
                        <th>Client</th>
                        <th>Contrat</th>
                        <th style="text-align:right;">Valorisation</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
            {% else %}
            <div class="muted" style="margin-top:12px;">Aucune donnée pour les critères sélectionnés.</div>
            {% endif %}
          </div>
        </div>
        <div class="accordion-toggle accordion-subtoggle" data-target="adminRelationsIntro" data-group="adminSub">
          <span><i class="fa-solid fa-circle-nodes" style="margin-right:6px;"></i> Gestion des relations</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="adminRelationsIntro" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <div class="card" style="margin:0 0 1rem 0;">
            <h3 style="margin:0 0 .5rem 0;">Modèle relationnel</h3>
            <ul class="muted" style="margin:0 0 .5rem 1rem;">
              <li>Intervenants: interne, courtier, autre; personnes physiques ou morales.</li>
              <li>Types de relations bidirectionnels avec inverse automatique.</li>
              <li>Déduplication garantie par contrainte UNIQUE.</li>
            </ul>
          </div>
          <h3>Types de relations</h3>
          <table>
            <thead>
              <tr>
                <th style="width: 45%;">Relation</th>
                <th style="width: 45%;">Inverse</th>
                <th class="center" style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for t in admin_types %}
              <tr>
                <td><input form="admin-typerel-{{ t.id }}" type="text" name="nom" value="{{ t.nom }}" /></td>
                <td>
                  <input form="admin-typerel-{{ t.id }}" type="text" name="inverse_nom" value="{{ t.inverse_nom or '' }}" placeholder="Nom de la relation inverse (optionnel)" />
                </td>
                <td class="center actions-cell">
                  <form id="admin-typerel-{{ t.id }}" method="post" action="/dashboard/parametres/administration/type_relation/{{ t.id }}?open=administration_types" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="admin-typerel-{{ t.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                  <form method="post" action="/dashboard/parametres/administration/type_relation/{{ t.id }}/delete?open=administration_types" style="display:inline;" onsubmit="return confirm('Supprimer ce type de relation ?');">
                    <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="3" class="muted center">Aucun type défini.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="adminTypeRelCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="adminTypeRelCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/administration/type_relation?open=administration_types" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field" style="min-width:280px;">
                    <label>Relation</label>
                    <input type="text" name="nom" required placeholder="Relation (ex. est en relation avec)" />
                  </div>
                  <div class="field" style="min-width:280px;">
                    <label>Inverse (optionnel)</label>
                    <input type="text" name="inverse_nom" placeholder="Nom de l'inverse (ex. dirige)" />
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus"></i>&nbsp;Ajouter le type</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="accordion-toggle accordion-subtoggle" data-target="adminIntervenantsPanel" data-group="adminSub">
          <span><i class="fa-solid fa-users" style="margin-right:6px;"></i> Intervenants externes</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="adminIntervenantsPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Intervenants externes</h3>
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th style="width: 140px;">Niveau</th>
                <th style="width: 140px;">Personne</th>
                <th style="width: 140px;">Téléphone</th>
                <th style="width: 380px;">E-mail</th>
                <th class="center" style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for it in admin_intervenants %}
              <tr>
                <td><input form="admin-int-{{ it.id }}" type="text" name="nom" value="{{ it.nom }}" /></td>
                <td>
                  <select form="admin-int-{{ it.id }}" name="type_niveau" required>
                    {% for nv in ['interne','courtier','autre'] %}
                      <option value="{{ nv }}" {% if it.type_niveau == nv %}selected{% endif %}>{{ nv }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <select form="admin-int-{{ it.id }}" name="type_personne" required>
                    {% for tp in ['physique','morale'] %}
                      <option value="{{ tp }}" {% if it.type_personne == tp %}selected{% endif %}>{{ tp }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input form="admin-int-{{ it.id }}" type="tel" name="telephone" value="{{ it.telephone or '' }}" placeholder="Ex: +33 6 12 34 56 78" inputmode="tel" pattern="^[+0-9()\.\s-]{6,}$" />
                </td>
                <td>
                  <input form="admin-int-{{ it.id }}" type="email" name="mail" value="{{ it.mail or '' }}" placeholder="nom.prenom@domaine.fr" inputmode="email" />
                </td>
                <td class="center actions-cell">
                  <form id="admin-int-{{ it.id }}" method="post" action="/dashboard/parametres/administration/intervenant/{{ it.id }}?open=administration_intervenants" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="admin-int-{{ it.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                  <form method="post" action="/dashboard/parametres/administration/intervenant/{{ it.id }}/delete?open=administration_intervenants" style="display:inline;" onsubmit="return confirm('Supprimer cet intervenant et ses relations ?');">
                    <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="6" class="muted center">Aucun intervenant enregistré.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="adminIntervenantCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="adminIntervenantCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/administration/intervenant?open=administration_intervenants" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field" style="min-width:280px;">
                    <label>Nom</label>
                    <input type="text" name="nom" required placeholder="Nom de l'intervenant" />
                  </div>
                  <div class="field">
                    <label>Niveau</label>
                    <select name="type_niveau" required>
                      <option value="interne">interne</option>
                      <option value="courtier">courtier</option>
                      <option value="autre">autre</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Type de personne</label>
                    <select name="type_personne" required>
                      <option value="physique">physique</option>
                      <option value="morale">morale</option>
                    </select>
                  </div>
                  <div class="field">
                    <label>Téléphone</label>
                    <input type="tel" name="telephone" placeholder="Ex: +33 6 12 34 56 78" inputmode="tel" pattern="^[+0-9()\.\s-]{6,}$" />
                  </div>
                  <div class="field" style="min-width:280px;">
                    <label>E-mail</label>
                    <input type="email" name="mail" placeholder="nom.prenom@domaine.fr" inputmode="email" />
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus"></i>&nbsp;Ajouter l'intervenant</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="accordion-toggle accordion-subtoggle" data-target="adminRelationsPanel" data-group="adminSub">
          <span><i class="fa-solid fa-link" style="margin-right:6px;"></i> Mise en place des relations</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="adminRelationsPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Relations</h3>
          <div class="create-block">
            <div id="adminRelationCreate" class="create-body active">
              <form method="post" action="/dashboard/parametres/administration/relation?open=administration_relations" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field">
                    <label>Source</label>
                    <select name="id_source" required>
                      <option value="" disabled selected>Choisir…</option>
                      {% for it in admin_intervenants %}
                        <option value="{{ it.id }}">{{ it.nom }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="field">
                    <label>Type</label>
                    <select name="id_type" required>
                      <option value="" disabled selected>Choisir…</option>
                      {% for t in admin_types %}
                        <option value="{{ t.id }}">{{ t.nom }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="field">
                    <label>Cible</label>
                    <select name="id_cible" required>
                      <option value="" disabled selected>Choisir…</option>
                      {% for it in admin_intervenants %}
                        <option value="{{ it.id }}">{{ it.nom }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus"></i>&nbsp;Créer la relation</button>
                </div>
              </form>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Source</th>
                <th>Type</th>
                <th>Cible</th>
                <th style="width: 140px;">Créée le</th>
                <th class="center" style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in admin_relations %}
              <tr>
                <td>{{ r.source_nom }}</td>
                <td>
                  <select form="admin-rel-{{ r.id }}" name="id_type">
                    {% for t in admin_types %}
                      <option value="{{ t.id }}" {% if r.id_type == t.id %}selected{% endif %}>{{ t.nom }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td>{{ r.cible_nom }}</td>
                <td>{{ r.date_creation }}</td>
                <td class="center actions-cell">
                  <form id="admin-rel-{{ r.id }}" method="post" action="/dashboard/parametres/administration/relation/{{ r.id }}?open=administration_relations" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="admin-rel-{{ r.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                  <form method="post" action="/dashboard/parametres/administration/relation/{{ r.id }}/delete?open=administration_relations" style="display:inline;" onsubmit="return confirm('Supprimer cette relation (et son miroir) ?');">
                    <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="muted center">Aucune relation enregistrée.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="accordion-toggle accordion-subtoggle" data-target="adminRhPanel" data-group="adminSub">
          <span><i class="fa-solid fa-id-badge" style="margin-right:6px;"></i> Ressources humaines</span>
          <span class="chevron">▾</span>
        </div>
        <div class="accordion-panel" id="adminRhPanel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
          <h3>Ressources humaines</h3>
          <table>
            <thead>
              <tr>
                <th style="width: 16%;">Nom</th>
                <th style="width: 16%;">Prénom</th>
                <th style="width: 12%;">Téléphone</th>
                <th style="width: 22%;">E-mail</th>
                <th style="width: 14%;">Niveau de poste</th>
                <th style="width: 20%;">Commentaire</th>
                <th class="center" style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in admin_rh %}
              <tr>
                <td><input form="admin-rh-{{ p.id }}" type="text" name="nom" value="{{ p.nom }}" required /></td>
                <td><input form="admin-rh-{{ p.id }}" type="text" name="prenom" value="{{ p.prenom }}" required /></td>
                <td><input form="admin-rh-{{ p.id }}" type="tel" name="telephone" value="{{ p.telephone or '' }}" placeholder="Ex: +33 6 12 34 56 78" inputmode="tel" pattern="^[+0-9()\.\s-]{6,}$" /></td>
                <td><input form="admin-rh-{{ p.id }}" type="email" name="mail" value="{{ p.mail or '' }}" placeholder="exemple@domaine.fr" inputmode="email" /></td>
                <td>
                  <select form="admin-rh-{{ p.id }}" name="niveau_poste" required>
                    {% set _np = (p.niveau_poste or '') %}
                    {% set _opts = [
                      ('', '—'),
                      ('dirigeant','Dirigeant'),
                      ('directeur_commercial','Directeur commercial'),
                      ('responsable_service','Responsable service'),
                      ('commercial','Commercial'),
                      ('back_office','Back office')
                    ] %}
                    {% for val, label in _opts %}
                      <option value="{{ val }}" {% if _np == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td><input form="admin-rh-{{ p.id }}" type="text" name="commentaire" value="{{ p.commentaire or '' }}" placeholder="Remarques" /></td>
                <td class="center actions-cell">
                  <form id="admin-rh-{{ p.id }}" method="post" action="/dashboard/parametres/administration/rh/{{ p.id }}?open=administration_rh" style="display:inline;"></form>
                  <button class="btn btn-list btn-list-primary" type="submit" form="admin-rh-{{ p.id }}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
                  <form method="post" action="/dashboard/parametres/administration/rh/{{ p.id }}/delete?open=administration_rh" style="display:inline;" onsubmit="return confirm('Supprimer ce profil RH ?');">
                    <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="7" class="muted center">Aucun profil RH enregistré.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="create-block">
            <div class="create-header">
              <button type="button" class="btn btn-add" data-toggle-form="adminRhCreate"><i class="fa-solid fa-plus"></i><span>Ajouter</span></button>
            </div>
            <div id="adminRhCreate" class="create-body">
              <form method="post" action="/dashboard/parametres/administration/rh?open=administration_rh" class="card" style="margin:0;">
                <div class="form-row">
                  <div class="field" style="min-width:200px;">
                    <label>Nom</label>
                    <input type="text" name="nom" required />
                  </div>
                  <div class="field" style="min-width:200px;">
                    <label>Prénom</label>
                    <input type="text" name="prenom" required />
                  </div>
                  <div class="field">
                    <label>Téléphone</label>
                    <input type="tel" name="telephone" placeholder="Ex: +33 6 12 34 56 78" inputmode="tel" pattern="^[+0-9()\.\s-]{6,}$" />
                  </div>
                  <div class="field" style="min-width:280px;">
                    <label>E-mail</label>
                    <input type="email" name="mail" placeholder="nom.prenom@domaine.fr" inputmode="email" />
                  </div>
                  <div class="field">
                    <label>Niveau de poste</label>
                    <select name="niveau_poste" required>
                      <option value="">—</option>
                      <option value="dirigeant">Dirigeant</option>
                      <option value="directeur_commercial">Directeur commercial</option>
                      <option value="responsable_service">Responsable service</option>
                      <option value="commercial">Commercial</option>
                      <option value="back_office">Back office</option>
                    </select>
                  </div>
                  <div class="field" style="min-width:260px;">
                    <label>Commentaire</label>
                    <input type="text" name="commentaire" placeholder="Remarques" />
                  </div>
                </div>
                <div class="create-btn-container">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-plus"></i>&nbsp;Ajouter</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // Portefeuille: pagination simple
  function financeGoPage(delta){
    var rows = Array.from(document.querySelectorAll('#financeSupportsTable tbody tr'));
    if (!rows.length) return;
    var pageSize = 20;
    var total = Math.ceil(rows.length / pageSize);
    var label = document.getElementById('financePageLabel');
    var prev = document.getElementById('financePrevBtn');
    var next = document.getElementById('financeNextBtn');
    var current = parseInt(label ? label.textContent : '1', 10);
    if (!isFinite(current) || current < 1) current = 1;
    var target = Math.min(Math.max(current + delta, 1), total);
    rows.forEach(function(r){ r.style.display = 'none'; });
    var start = (target - 1) * pageSize;
    var end = start + pageSize;
    rows.slice(start, end).forEach(function(r){ r.style.display = ''; });
    if (label) label.textContent = String(target);
    if (prev) prev.disabled = target <= 1;
    if (next) next.disabled = target >= total;
  }
  window.financeGoPage = financeGoPage;
  document.addEventListener('DOMContentLoaded', function(){ financeGoPage(0); });

  // Portefeuille: export CSV
  (function(){
    var exportBtn = document.getElementById('finance_export_btn');
    if (!exportBtn) return;
    exportBtn.addEventListener('click', function(){
      var params = new URLSearchParams();
      var dateInput = document.querySelector('input[name="finance_date"]');
      if (dateInput && dateInput.value) params.set('finance_date', dateInput.value);
      var rhSelect = document.querySelector('select[name="finance_rh"]');
      if (rhSelect && rhSelect.value) params.set('finance_rh', rhSelect.value);
      var valoInput = document.querySelector('input[name="finance_valo"]');
      if (valoInput && valoInput.value) params.set('finance_valo', valoInput.value);
      params.set('open', 'administration_portefeuille');
      var url = '/dashboard/finance/export';
      var qs = params.toString();
      if (qs) url += '?' + qs;
      window.location.href = url;
    });
  })();

  // Portefeuille: modal clients par support
  function closeFinanceSupportModal(){
    const modal = document.getElementById('financeSupportModal');
    if (modal) modal.style.display = 'none';
  }
  let financeSupportCurrentClients = [];
  let financeSupportGroupDetails = [];
  let financeSupportGroupsLoaded = false;
  let financeSupportGroupLoading = false;
  function setFinanceSupportGroupStatus(message, isError){
    const el = document.getElementById('financeSupportGroupStatus');
    if (!el) return;
    el.textContent = message || '';
    el.style.color = isError ? '#b91c1c' : '#475569';
  }
  function renderFinanceSupportGroupSelect(){
    const sel = document.getElementById('financeSupportGroupSelect');
    if (!sel) return;
    sel.innerHTML = '';
    if (!financeSupportGroupsLoaded){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Chargement des groupes…';
      sel.appendChild(opt);
      return;
    }
    if (!Array.isArray(financeSupportGroupDetails) || financeSupportGroupDetails.length === 0){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Aucun groupe Personnes';
      sel.appendChild(opt);
      setFinanceSupportGroupStatus('Aucun groupe Personnes trouvé. Créez-en dans Administration > Groupes.', true);
      return;
    }
    financeSupportGroupDetails.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.id;
      opt.textContent = g.nom + (g.actif === 0 ? ' (inactif)' : '');
      sel.appendChild(opt);
    });
    setFinanceSupportGroupStatus('', false);
  }
  async function loadFinanceSupportGroups(){
    if (financeSupportGroupLoading) return;
    financeSupportGroupLoading = true;
    setFinanceSupportGroupStatus('Chargement des groupes…', false);
    try{
      let details = [];
      const res = await fetch('/api/groupes/details?type=client&actifs_only=true');
      if (res.ok){
        details = await res.json();
      }
      if (!Array.isArray(details) || details.length === 0){
        const res2 = await fetch('/api/groupes/details?type=client&actifs_only=false');
        if (res2.ok){
          details = await res2.json();
        }
      }
      financeSupportGroupDetails = Array.isArray(details) ? details : [];
      financeSupportGroupsLoaded = true;
      renderFinanceSupportGroupSelect();
      if (financeSupportGroupDetails.length === 0){
        setFinanceSupportGroupStatus('Aucun groupe Personnes trouvé. Créez-en dans Administration > Groupes.', true);
      } else {
        setFinanceSupportGroupStatus('Sélectionnez un groupe pour y ajouter la liste.', false);
      }
    } catch(err){
      console.warn('finance support group load error', err);
      setFinanceSupportGroupStatus('Erreur de chargement des groupes.', true);
    } finally {
      financeSupportGroupLoading = false;
    }
  }
  function toggleFinanceSupportGroupActions(shouldShow){
    const container = document.getElementById('financeSupportGroupActions');
    if (!container) return;
    if (!shouldShow){
      container.style.display = 'none';
      setFinanceSupportGroupStatus('', false);
      return;
    }
    container.style.display = '';
    renderFinanceSupportGroupSelect();
    if (!financeSupportGroupsLoaded && !financeSupportGroupLoading){
      loadFinanceSupportGroups();
    } else if (financeSupportGroupDetails.length){
      setFinanceSupportGroupStatus('Sélectionnez un groupe pour y ajouter la liste.', false);
    }
  }
  async function addFinanceSupportClientsToGroup(){
    const btn = document.getElementById('financeSupportGroupAddBtn');
    const sel = document.getElementById('financeSupportGroupSelect');
    if (!btn || !sel) return;
    const gid = parseInt(sel.value, 10);
    if (!gid){
      setFinanceSupportGroupStatus('Sélectionnez un groupe valide.', true);
      return;
    }
    const clients = Array.isArray(financeSupportCurrentClients) ? financeSupportCurrentClients.filter(c => c && c.client_id) : [];
    if (!clients.length){
      setFinanceSupportGroupStatus('Aucun client identifiable à ajouter.', true);
      return;
    }
    btn.disabled = true;
    setFinanceSupportGroupStatus('Ajout en cours…', false);
    let success = 0;
    let attempted = 0;
    for (const client of clients){
      attempted++;
      try{
        const resp = await fetch('/api/groupes/memberships', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupe_id: gid, client_id: client.client_id })
        });
        if (resp.ok){
          success++;
        } else {
          console.warn('finance support group add error', resp.status);
        }
      } catch(err){
        console.warn('finance support group add error', err);
      }
    }
    btn.disabled = false;
    if (!attempted){
      setFinanceSupportGroupStatus('Aucun client valide pour l’ajout.', true);
    } else if (success === attempted){
      const plural = success > 1 ? 'clients' : 'client';
      setFinanceSupportGroupStatus(`Liste ajoutée (${success} ${plural}).`, false);
    } else {
      setFinanceSupportGroupStatus(`Ajout partiel : ${success}/${attempted} clients.`, true);
    }
  }
  function openFinanceSupportModal(code, name, clients){
    const modal = document.getElementById('financeSupportModal');
    if (!modal) return;
    const tbody = modal.querySelector('#financeSupportModalTable tbody');
    const labelEl = document.getElementById('financeSupportModalLabel');
    if (labelEl){
      const parts = ['Clients par support'];
      const detail = [name, code].filter(Boolean).join(' • ');
      if (detail) parts.push(detail);
      labelEl.textContent = parts.join(' — ');
    }
    if (tbody){
      tbody.innerHTML = '';
      const rows = Array.isArray(clients) ? clients : [];
      financeSupportCurrentClients = rows.filter(function(item){ return item && item.client_id; });
      toggleFinanceSupportGroupActions(rows.length > 0);
      rows.forEach(function(item){
        const tr = document.createElement('tr');
        const clientTd = document.createElement('td');
        const fullname = item.client_fullname || item.client_nom || 'Client';
        if (item.client_id){
          const link = document.createElement('a');
          link.href = `/dashboard/clients/${encodeURIComponent(item.client_id)}`;
          link.textContent = fullname;
          link.target = '_blank';
          link.rel = 'noopener';
          clientTd.appendChild(link);
        } else {
          clientTd.textContent = fullname;
        }
        tr.appendChild(clientTd);
        const contratTd = document.createElement('td');
        if (item.affaire_id){
          const link = document.createElement('a');
          link.href = `/dashboard/affaires/${encodeURIComponent(item.affaire_id)}`;
          link.textContent = item.affaire_ref || `Affaire ${item.affaire_id}`;
          link.target = '_blank';
          link.rel = 'noopener';
          contratTd.appendChild(link);
        } else {
          contratTd.textContent = item.affaire_ref || '-';
        }
        tr.appendChild(contratTd);
        const valoTd = document.createElement('td');
        valoTd.className = 'numeric';
        valoTd.textContent = item.valorisation_str ? item.valorisation_str + ' €' : '-';
        tr.appendChild(valoTd);
        tbody.appendChild(tr);
      });
      if (!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'muted';
        td.textContent = 'Aucun client trouvé pour ce support.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }
    modal.style.display = 'flex';
  }
  document.querySelectorAll('.finance-support-link').forEach(function(link){
    link.addEventListener('click', function(ev){
      ev.preventDefault();
      let clients = [];
      try{
        clients = this.dataset.clients ? JSON.parse(this.dataset.clients) : [];
      }catch(err){
        console.warn('finance support clients parse error', err);
      }
      openFinanceSupportModal(this.dataset.supportCode || '', this.dataset.supportName || '', clients);
    });
  });
  const addBtn = document.getElementById('financeSupportGroupAddBtn');
  if (addBtn){
    addBtn.addEventListener('click', function(ev){
      ev.preventDefault();
      addFinanceSupportClientsToGroup();
    });
  }

  // Reorder: place Ressources humaines first under Administration
  try {
    const adminPanel = document.getElementById('administrationPanel');
    if (adminPanel){
      const rhToggle = adminPanel.querySelector('.accordion-toggle.accordion-subtoggle[data-target="adminRhPanel"]');
      const rhPanel = document.getElementById('adminRhPanel');
      // Find first sub-toggle inside admin panel that is not the RH toggle
      const firstSubToggle = Array.from(adminPanel.querySelectorAll('.accordion-toggle.accordion-subtoggle[data-group="adminSub"]'))
        .find(el => el !== rhToggle);
      if (rhToggle && rhPanel && firstSubToggle){
        // Move toggle before the first sub-toggle
        adminPanel.insertBefore(rhToggle, firstSubToggle);
        // Move RH panel right after its toggle
        if (rhToggle.nextSibling !== rhPanel){
          adminPanel.insertBefore(rhPanel, rhToggle.nextSibling);
        }
      }
    }
  } catch(e) { /* noop */ }

  // Tabs principaux pour remplacer les accordéons racine
  const rootPanels = ["courtierPanel","contratsPanel","assureursPanel","supportPanel","groupesPanel","administrationPanel"];
  const tabs = Array.from(document.querySelectorAll('#paramTabs .param-tab'));
  const rootToggles = rootPanels
    .map(id => document.querySelector(`.accordion-toggle[data-target="${id}"][data-level="root"]`))
    .filter(Boolean);

  function showPanel(id){
    rootPanels.forEach(pid => {
      const panel = document.getElementById(pid);
      if (panel){ panel.style.display = pid === id ? '' : 'none'; }
    });
    tabs.forEach(t => t.classList.toggle('active', t.getAttribute('data-target') === id));
  }

  // Les toggles racine deviennent invisibles (les tabs prennent le relais)
  rootToggles.forEach(t => { t.style.display = 'none'; });
  tabs.forEach(tab => {
    tab.addEventListener('click', (ev) => {
      ev.preventDefault();
      showPanel(tab.getAttribute('data-target'));
    });
  });
  // Valeur par défaut
  showPanel("courtierPanel");

  function setPanelState(panel, btn, expanded){
    panel.style.display = expanded ? '' : 'none';
    const chevron = btn.querySelector('.chevron');
    if (chevron){
      chevron.textContent = expanded ? '▴' : '▾';
    }
    btn.classList.toggle('collapsed', !expanded);
  }

  const toggles = Array.from(document.querySelectorAll('.accordion-toggle[data-target]'));

  toggles.forEach(btn => {
    btn.classList.add('collapsed');
    const panel = document.getElementById(btn.dataset.target);
    if (!panel){
      return;
    }
    btn.addEventListener('click', () => {
      const willOpen = panel.style.display === 'none';
      if (!willOpen){
        setPanelState(panel, btn, false);
        return;
      }
      if (btn.dataset.level === 'root'){
        toggles.forEach(other => {
          if (other === btn || other.dataset.level !== 'root'){
            return;
          }
          const otherPanel = document.getElementById(other.dataset.target);
          if (otherPanel && otherPanel.style.display !== 'none'){
            setPanelState(otherPanel, other, false);
          }
        });
      }
      if (btn.dataset.group){
        toggles.forEach(other => {
          if (other === btn || other.dataset.group !== btn.dataset.group){
            return;
          }
          const otherPanel = document.getElementById(other.dataset.target);
          if (otherPanel && otherPanel.style.display !== 'none'){
            setPanelState(otherPanel, other, false);
          }
        });
      }
      setPanelState(panel, btn, true);
    });
  });

  const open = '{{ open_section or '' }}';
  if (open){
    const mapping = {
      'courtier': ['courtierPanel'],
      'courtier_identite': ['courtierPanel','courtierIdentitePanel'],
      'courtierDocuments': ['courtierPanel','courtierDocumentsPanel'],
      'courtierDetails': ['courtierPanel','courtierDetailsPanel'],
      'societes': ['assureursPanel','societeCatsPanel','societesPanel'],
      'societes_categories': ['assureursPanel','societeCatsPanel'],
      'societes_compagnies': ['assureursPanel','societesPanel'],
      'contrats': ['contratsPanel','contratCatsPanel','contratGeneriquesPanel'],
      'contrats_categories': ['contratsPanel','contratCatsPanel'],
      'contrats_generiques': ['contratsPanel','contratGeneriquesPanel'],
      'supports': ['supportPanel'],
      'administration': ['administrationPanel'],
      'administration_portefeuille': ['administrationPanel','adminPortfolioPanel'],
      'administration_types': ['administrationPanel','adminRelationsIntro'],
      'administration_intervenants': ['administrationPanel','adminIntervenantsPanel'],
      'administration_relations': ['administrationPanel','adminRelationsPanel'],
      'administration_rh': ['administrationPanel','adminRhPanel'],
      'groupes': ['groupesPanel'],
      'administration_groupes': ['groupesPanel']
    };
    const panels = mapping[open];
    if (panels){
      showPanel(panels[0]);
      panels.forEach(id => {
        const btn = document.querySelector(`.accordion-toggle[data-target="${id}"]`);
        const panel = document.getElementById(id);
        if (btn && panel){
          setPanelState(panel, btn, true);
        }
      });
    }
  }

  document.querySelectorAll('[data-toggle-form]').forEach(btn => {
    const targetId = btn.getAttribute('data-toggle-form');
    const body = document.getElementById(targetId);
    if (!body){
      return;
    }
    btn.dataset.closedLabel = btn.innerHTML;
    btn.dataset.openLabel = '<i class="fa-solid fa-xmark"></i><span>Fermer</span>';
    btn.setAttribute('aria-expanded', 'false');
    btn.addEventListener('click', () => {
      const willShow = !body.classList.contains('active');
      body.classList.toggle('active', willShow);
      btn.classList.toggle('active', willShow);
      btn.setAttribute('aria-expanded', String(willShow));
      btn.innerHTML = willShow ? btn.dataset.openLabel : btn.dataset.closedLabel;
      if (willShow){
        const focusable = body.querySelector('input, select, textarea, button');
        if (focusable){
          focusable.focus({ preventScroll: false });
        }
      }
    });
  });

  const supportTable = document.getElementById('supportTableBody');
  const supportDataRaw = supportTable ? {{ contrat_supports|tojson|safe }} : [];
  if (supportTable && Array.isArray(supportDataRaw)){
    const selectContrat = document.getElementById('supportFilterContrat');
    const filterSupport = document.getElementById('supportFilterSupport');
    const pageSizeSelect = document.getElementById('supportPageSize');
    const csvBtn = document.getElementById('supportCsvExport');
    const pageInfo = document.getElementById('supportPageInfo');
    const prevBtn = document.getElementById('supportPrev');
    const nextBtn = document.getElementById('supportNext');

    let filteredSupports = [];
    let currentPage = 1;
    let sortField = 'support';
    let sortDirection = 'asc';

    const htmlEscape = (value) => {
      if (value === null || value === undefined){
        return '';
      }
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const formatPercent = (value) => {
      const num = Number(value);
      if (!Number.isFinite(num)){
        return '';
      }
      return (num * 100).toLocaleString('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    };

    const getPageSize = () => {
      const raw = pageSizeSelect.value;
      return raw === 'all' ? -1 : parseInt(raw, 10) || 10;
    };

    const applyFilters = () => {
      const contratId = selectContrat.value;
      const supportTerm = filterSupport.value.trim().toLowerCase();
      if (!contratId){
        filteredSupports = [];
        currentPage = 1;
        renderSupports();
        return;
      }
      filteredSupports = supportDataRaw.filter(item => {
        if (String(item.id_affaire_generique) !== contratId){
          return false;
        }
        if (!supportTerm){
          return true;
        }
        return [item.support_nom]
          .some(val => val && val.toLowerCase().includes(supportTerm));
      });
      currentPage = 1;
      renderSupports();
    };

    const compareStrings = (a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' });
    const getSorter = () => {
      switch (sortField){
        case 'support':
          return (a, b) => compareStrings(a.support_nom || '', b.support_nom || '');
        case 'categorie':
          return (a, b) => compareStrings(a.cat_gene || '', b.cat_gene || '');
        case 'zone':
          return (a, b) => compareStrings(a.cat_geo || '', b.cat_geo || '');
        case 'promoteur':
          return (a, b) => compareStrings(a.promoteur || '', b.promoteur || '');
        case 'taux':
          return (a, b) => (a.taux_retro || 0) - (b.taux_retro || 0);
        default:
          return null;
      }
    };

    const updateSortIndicators = () => {
      document.querySelectorAll('.support-sort').forEach(th => {
        if (th.dataset.sort === sortField){
          th.setAttribute('data-order', sortDirection);
        } else {
          th.removeAttribute('data-order');
        }
      });
    };

    const renderSupports = () => {
      updateSortIndicators();
      const pageSize = getPageSize();
      const sorter = getSorter();
      const working = sorter ? [...filteredSupports].sort((a, b) => {
        const result = sorter(a, b);
        return sortDirection === 'desc' ? -result : result;
      }) : [...filteredSupports];

      const total = working.length;
      let pageCount = 1;
      let pageItems = working;

      if (pageSize > 0){
        pageCount = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > pageCount){
          currentPage = pageCount;
        }
        const start = (currentPage - 1) * pageSize;
        pageItems = working.slice(start, start + pageSize);
      } else {
        currentPage = 1;
        pageCount = 1;
      }

      const rowsHtml = pageItems.map(item => {
        const support = htmlEscape(item.support_nom || '—');
        const isin = '';
        const categorie = htmlEscape(item.cat_gene || '—');
        const zoneGeo = htmlEscape(item.cat_geo || '—');
        const promoteur = htmlEscape(item.promoteur || '—');
        const taux = htmlEscape(formatPercent(item.taux_retro));
        return `
          <tr>
            <td>${support}</td>
            <td>${categorie}</td>
            <td>${zoneGeo}</td>
            <td>${promoteur}</td>
            <td class="right">
              <div class="support-rate-input">
                <input form="support-${item.id}" type="text" name="taux_retro" value="${taux}" inputmode="decimal" />
                <span class="muted">%</span>
              </div>
            </td>
          <td class="center">
            <form id="support-${item.id}" method="post" action="/dashboard/parametres/contrat_supports/${item.id}?open=supports" style="display:inline;"></form>
            <button class="btn btn-list btn-list-primary" type="submit" form="support-${item.id}" title="Enregistrer"><i class="fa-solid fa-floppy-disk"></i></button>
            <form method="post" action="/dashboard/parametres/contrat_supports/${item.id}/delete?open=supports" style="display:inline;" onsubmit="return confirm('Supprimer ce support du contrat ?');">
              <button class="btn btn-list btn-list-danger" type="submit" title="Supprimer"><i class="fa-solid fa-trash"></i></button>
            </form>
          </td>
        </tr>`;
      }).join('');

      const emptyMessage = selectContrat.value
        ? 'Aucun support trouvé pour ce contrat.'
        : 'Sélectionnez un contrat pour afficher les supports.';
      supportTable.innerHTML = rowsHtml || `<tr><td colspan="6" class="muted center">${emptyMessage}</td></tr>`;

      const startIdx = total === 0 ? 0 : (pageSize > 0 ? (currentPage - 1) * pageSize + 1 : 1);
      const endIdx = pageSize > 0 ? Math.min(currentPage * pageSize, total) : total;
      pageInfo.textContent = `${startIdx}-${endIdx} sur ${total}`;

      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = pageSize <= 0 || currentPage >= pageCount;
    };

    const exportCsv = () => {
      if (!filteredSupports.length){
        return;
      }
      const header = ['Contrat', 'Société', 'Support', 'Catégorie', 'Zone géo', 'Promoteur', 'Taux (%)'];
      const rows = filteredSupports.map(item => [
        item.contrat_nom || '',
        item.societe_nom || '',
        item.support_nom || '',
        item.cat_gene || '',
        item.cat_geo || '',
        item.promoteur || '',
        `${formatPercent(item.taux_retro)}%`
      ]);
      const csvContent = [header, ...rows]
        .map(row => row.map(value => {
          const str = String(value ?? '');
          return `"${str.replace(/"/g, '""')}"`;
        }).join(';'))
        .join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `supports_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    selectContrat.addEventListener('change', applyFilters);
    filterSupport.addEventListener('input', applyFilters);
    pageSizeSelect.addEventListener('change', () => {
      currentPage = 1;
      renderSupports();
    });
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1){
        currentPage -= 1;
        renderSupports();
      }
    });
    nextBtn.addEventListener('click', () => {
      currentPage += 1;
      renderSupports();
    });
    csvBtn.addEventListener('click', exportCsv);

    document.querySelectorAll('.support-sort').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.sort;
        if (sortField === field){
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortField = field;
          sortDirection = 'asc';
        }
        updateSortIndicators();
        renderSupports();
      });
    });

    updateSortIndicators();
    renderSupports();
  }

  // Courtier: formatage d'affichage pour capital_social et SIREN
  const capInput = document.getElementById('capital_social');
  if (capInput){
    const fmtThousands = (val) => {
      const digits = String(val || '').replace(/\D+/g, '');
      if (!digits) return '';
      return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    };
    const onCapBlur = () => {
      capInput.value = fmtThousands(capInput.value);
    };
    capInput.addEventListener('blur', onCapBlur);
    // Initial format if needed
    onCapBlur();
  }
  const sirenInput = document.getElementById('siren');
  if (sirenInput){
    const fmtSiren = (val) => {
      const d = String(val || '').replace(/\D+/g, '').slice(0, 9);
      const parts = [];
      if (d.length > 0) parts.push(d.slice(0, 3));
      if (d.length > 3) parts.push(d.slice(3, 6));
      if (d.length > 6) parts.push(d.slice(6, 9));
      return parts.join(' ');
    };
    const onSirenInput = () => {
      sirenInput.value = fmtSiren(sirenInput.value);
    };
    sirenInput.addEventListener('input', onSirenInput);
    sirenInput.addEventListener('blur', onSirenInput);
    // Initial format
    onSirenInput();
  }
  const oriasInput = document.getElementById('numero_orias');
  if (oriasInput){
    const onOriasInput = () => {
      const d = String(oriasInput.value || '').replace(/\D+/g, '').slice(0, 9);
      oriasInput.value = d;
    };
    oriasInput.addEventListener('input', onOriasInput);
    oriasInput.addEventListener('blur', onOriasInput);
    onOriasInput();
  }
  const cpInput = document.getElementById('adresse_cp');
  if (cpInput){
    const onCpInput = () => {
      const d = String(cpInput.value || '').replace(/\D+/g, '').slice(0, 5);
      cpInput.value = d;
    };
    cpInput.addEventListener('input', onCpInput);
    cpInput.addEventListener('blur', onCpInput);
    onCpInput();
  }

  // Validation client des courriels des médiateurs (liste)
  const form = document.querySelector('#courtierPanel form');
  if (form){
    form.addEventListener('submit', (e) => {
      const mm = document.getElementById('mail_mediators');
      if (mm && mm.value){
        const parts = mm.value.split(/[;,\s]+/).map(s => s.trim()).filter(Boolean);
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const bad = parts.filter(v => !re.test(v));
        if (bad.length){
          e.preventDefault();
          alert('Courriels des médiateurs invalides: ' + bad.join(', '));
          mm.focus();
        }
      }
    });
  }

  // Toast "Enregistré"
  var saved = {{ saved_success|tojson }};
  if (saved) {
    const t = document.getElementById('toastSaved');
    if (t){
      t.style.display = 'inline-flex';
      setTimeout(() => { t.style.display = 'none'; }, 2200);
    }
  }

  // Error toast
  var hasErr = {{ (saved_error|default(false))|tojson }};
  var errMsg = {{ (saved_error_msg|default(''))|tojson }};
  if (hasErr) {
    const t = document.getElementById('toastError');
    const m = document.getElementById('toastErrorMsg');
    if (t){
      if (m) m.textContent = errMsg || '';
      t.style.display = 'inline-flex';
      setTimeout(() => { t.style.display = 'none'; }, 3800);
    }
  }

  // Format inputs with thousand separators (space), no decimals
  (function(){
    const fmt = (val) => {
      const d = String(val || '').replace(/\D+/g, '');
      if (!d) return '';
      return d.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    };
    const apply = (inp) => { inp.value = fmt(inp.value); };
    const inputs = document.querySelectorAll('#courtierDetailsPanel .money-space');
    inputs.forEach(inp => {
      // initial format
      apply(inp);
      inp.addEventListener('blur', () => apply(inp));
    });
  })();

  // Format remuneration inputs: montant (thousands, no decimals) and percent (2 decimals)
  (function(){
    const fmtThousandsNoDec = (val) => {
      // Parse numeric value first to avoid "4500.0" -> "45 000"
      let s = String(val ?? '').replace(/\s+/g, '').replace('€','').replace(',', '.');
      const num = parseFloat(s);
      if (!isFinite(num)) return '';
      const n = Math.round(num);
      const d = String(Math.abs(n));
      const grouped = d.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      return n < 0 ? '-' + grouped : grouped;
    };
    const fmtPercent2 = (val) => {
      let s = String(val || '').replace('%','').replace(',', '.');
      const f = parseFloat(s);
      if (isNaN(f)) return '';
      return f.toFixed(2);
    };
    const moneyInputs = document.querySelectorAll('#courtierDetailsPanel .money-space-int');
    moneyInputs.forEach(inp => {
      const apply = () => { inp.value = fmtThousandsNoDec(inp.value); };
      apply();
      inp.addEventListener('blur', apply);
    });
    const pctInputs = document.querySelectorAll('#courtierDetailsPanel .percent-2');
    pctInputs.forEach(inp => {
      const apply = () => { inp.value = fmtPercent2(inp.value); };
      inp.addEventListener('blur', apply);
    });
  })();

  // Masque/formatage téléphone (Intervenants + RH)
  (function(){
    function normalizePhone(val){
      if (!val) return '';
      let s = String(val).replace(/[^+0-9]/g, '');
      // Conserver un seul "+" en tête
      if (s.includes('+')){
        s = '+' + s.replace(/\+/g, '').replace(/[^0-9]/g, '');
      }
      return s;
    }
    function formatFRLike(val){
      if (!val) return '';
      let s = String(val).trim();
      if (s.startsWith('+')){
        // +CC puis regrouper par 2 après le préfixe pays
        const m = s.match(/^(\+\d{1,3})(\d*)$/);
        if (!m) return s;
        const cc = m[1], rest = m[2];
        return cc + ' ' + rest.replace(/(\d{2})(?=\d)/g, '$1 ').trim();
      }
      // Sans + : regrouper par 2, conserver 0 de tête si présent
      const d = s.replace(/\D+/g, '');
      if (!d) return '';
      return d.replace(/(\d{2})(?=\d)/g, '$1 ').trim();
    }
    function attachMask(container){
      if (!container) return;
      const inputs = container.querySelectorAll('input[type="tel"]');
      inputs.forEach(inp => {
        const apply = () => { inp.value = formatFRLike(normalizePhone(inp.value)); };
        inp.addEventListener('blur', apply);
        // Optionnel: formater aussi en input sans gêner la saisie
        inp.addEventListener('input', () => {
          const pos = inp.selectionStart;
          const before = inp.value;
          const after = formatFRLike(normalizePhone(before));
          if (before !== after){ inp.value = after; }
          try { inp.setSelectionRange(pos, pos); } catch(e){}
        });
        // Format initial
        apply();
      });
    }
    attachMask(document.getElementById('adminIntervenantsPanel'));
    attachMask(document.getElementById('adminRhPanel'));
  })();
});
</script>
{% endblock %}
