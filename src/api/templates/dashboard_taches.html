{% extends "base.html" %}
{% block title %}T√¢ches / √âv√©nements{% endblock %}
{% block header_title %}üóÇÔ∏è T√¢ches / √âv√©nements{% endblock %}
{% block header_subtitle %}Suivi des actions, communications et r√©clamations{% endblock %}

{% block content %}
  <style>
    /* Styles synth√®se t√¢ches (repris du dashboard) */
    .tasks-toolbar {
      display: flex;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
      padding: 10px 0;
      align-items: stretch;
    }
    .tasks-label { color: var(--muted); font-weight: 700; letter-spacing: .02em; }
    .tasks-range {
      display: inline-flex;
      gap: 10px;
      align-items: center;
    }
    .tasks-inline-kpis {
      display: grid;
      grid-auto-flow: column;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }
    .tasks-inline-kpi {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 8px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
      height: 28px;
    }
    .tasks-inline-kpi .label {
      color: var(--muted);
      font-weight: 700;
      font-size: 11px;
    }
    .tasks-inline-kpi .value {
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
    }
    .tasks-range button.btn-choice {
      min-width: 40px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: 0 5px 12px rgba(15, 23, 42, 0.06);
    }
    .tasks-range button.btn-choice-active {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.22);
    }
    .tasks-nav {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 0 0 12px 0;
    }
    .tasks-nav .nav-btn {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 6px 14px rgba(15,23,42,0.08);
      transition: all .15s ease;
    }
    .tasks-nav .nav-btn:hover {
      background: var(--primary-100);
      color: var(--primary-600);
      border-color: #c7d2fe;
      transform: translateY(-1px);
    }
    .task-section { display:none; }
    .task-section.active { display:block; }
    .task-card.active { border:1px solid var(--primary-100); box-shadow: 0 10px 24px rgba(37,99,235,0.12); }
  </style>

  <div class="tasks-nav">
    <button type="button" class="nav-btn" onclick="focusTaskSection('tasksSummaryCard','toggleTasksSummary')"><i class="fa-solid fa-list-check"></i>Synth√®se</button>
    <button type="button" class="nav-btn" onclick="focusTaskSection('tacheFormCard','toggleTacheAccordion')"><i class="fa-solid fa-pen-to-square"></i>D√©finir une t√¢che</button>
    <button type="button" class="nav-btn" onclick="focusTaskSection('tasksListCard','toggleTasksList')"><i class="fa-solid fa-list"></i>Liste des t√¢ches</button>
    <button type="button" class="nav-btn" onclick="focusTaskSection('calendarCard','toggleCalendarAccordion')"><i class="fa-solid fa-calendar"></i>Calendrier</button>
    <button type="button" class="nav-btn" onclick="focusTaskSection('reclamCard','toggleReclamPivot')"><i class="fa-solid fa-table-list"></i>Livre des r√©clamations</button>
  </div>

  <div style="display:flex; flex-direction:column; gap:10px; margin-bottom: 1rem;">
    <div class="card task-card" id="tasksSummaryCard" style="flex:1 1 100%; width:100%; margin:0;">
      <div style="padding:10px 12px; display:flex; align-items:center; gap:8px; font-weight:600; font-size:1.05rem;">
        <i class="fa-solid fa-list-check"></i> Synth√®se
      </div>
      <div id="tasksSummaryBody" class="task-section" style="padding-top:.6rem;">
        <div class="tasks-toolbar">
          <div class="tasks-label">P√©riode</div>
          <div class="tasks-range">
            {% set r = 14 %}
            {% for n in [7,14,30] %}
              <button type="button" class="btn btn-choice{% if n == r %} btn-choice-active{% endif %} tasks-range-btn" data-range="{{ n }}">{{ n }} J</button>
            {% endfor %}
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="tasksLoadBtn" class="btn" style="height:34px; display:inline-flex; align-items:center; gap:6px;">
              <i class="fa-solid fa-rotate"></i> Charger les t√¢ches
            </button>
            <span id="tasksStatus" class="muted" style="font-size:0.9rem;">(non charg√©)</span>
          </div>
          <div class="tasks-inline-kpis">
            <div class="tasks-inline-kpi"><span class="label">T√¢ches totales</span><span class="value" id="tasksTotal">‚Äî</span></div>
            <div class="tasks-inline-kpi"><span class="label">Ouvertes</span><span class="value" id="tasksOpen">‚Äî</span></div>
            <div class="tasks-inline-kpi"><span class="label">Cl√¥tur√©es</span><span class="value" id="tasksClosed">‚Äî</span></div>
            <div class="tasks-inline-kpi"><span class="label">Aujourd'hui</span><span class="value" id="tasksToday">‚Äî</span></div>
          </div>
        </div>
        <div class="tasks-kpis" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:10px; align-items:stretch;">
          <div class="tasks-kpi-card" style="min-height:220px; display:flex; align-items:center; justify-content:center;">
            <canvas id="chartTasksDays" height="180" style="width:100%;"></canvas>
          </div>
          <div class="tasks-kpi-card" style="min-height:220px; display:flex; flex-direction:column;">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
              <div class="muted">Filtre par responsable commercial:</div>
              <select id="tasksRhSelect" style="width:160px;">
                <option value="">Tous</option>
              </select>
            </div>
            <div style="flex:1 1 auto; min-height:0; display:flex; align-items:center; justify-content:center;">
              <canvas id="chartTasksType" height="160" style="width:100%;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card task-card" id="tacheFormCard" style="flex:1 1 100%; width:100%; margin:0;">
      <div style="padding:10px 12px; display:flex; align-items:center; gap:8px; font-weight:600; font-size:1.05rem;">
        <i class="fa-solid fa-pen-to-square"></i> D√©finir une t√¢che
      </div>

      <div id="tache_accordion_body" class="task-block task-section" style="margin-top:.8rem;">
    <form id="form-create-tache" method="post" action="/dashboard/taches">
      <!-- Ligne 1: Client / Affaire / RH -->
      <div class="form-row" style="margin-bottom:.6rem;">
        <div class="field">
          <label>Client (Nom Pr√©nom)</label>
          <input type="text" name="client_fullname" list="clients_list" placeholder="Dupont Alice" />
        </div>
        <div class="field">
          <label>Affaire (R√©f√©rence)</label>
          <input type="text" name="affaire_ref" list="affaires_list" placeholder="REF-0001" />
        </div>
        <div class="field">
          <label>Affecter √† (RH)</label>
          <select name="rh_id">
            <option value="">-- aucun --</option>
            {% for rh in rh_options %}
              {% set rid = rh.id if rh.id is not none else rh.get('id') %}
              {% set label = rh.label if rh.label is defined else rh.get('label') %}
              <option value="{{ rid }}">{{ label if label else rid }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Ligne 2: Cat√©gorie -> Type + option communication -->
      <div class="form-row" style="margin-bottom:.6rem;">
        <div class="field">
          <label>Cat√©gorie</label>
          <select class="select-choice" name="categorie" id="categorie_select">
            <option value="">-- choisir --</option>
            {% for cat in categories %}
              <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="field">
          <label>Type</label>
          <select class="select-choice" name="type_libelle" id="type_select">
            <option value="">-- choisir une cat√©gorie --</option>
          </select>
        </div>
        <div class="field" style="align-self:center;">
          <label>&nbsp;</label>
          <button type="button" id="comm_btn" class="btn btn-choice" onclick="toggleCommBtn()">Pr√©parer une communication</button>
          <input type="hidden" id="comm_toggle" name="comm_toggle" value="0" />
        </div>
      </div>

      <div class="form-row" id="reclam_status_row" style="margin-bottom:.6rem; display:none;">
        <div class="field">
          <label>Statut r√©clamation</label>
          <select class="select-choice" name="statut_reclamation_id" id="reclam_status_select">
            <option value="">-- choisir --</option>
            {% for st in reclam_statuses %}
              <option value="{{ st.id }}">{{ st.libelle }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Bloc communication (cach√© par d√©faut) -->
      <div id="comm_block" style="display:none; border:1px dashed var(--border); padding:.8rem; border-radius:10px; margin-bottom:.6rem;">
        <div class="form-row" style="margin-bottom:.6rem;">
          <div class="field">
            <label>Canal</label>
            <select class="select-choice" name="comm_canal">
              <option value="email">email</option>
              <option value="courrier">courrier</option>
              <option value="sms">sms</option>
            </select>
          </div>
          <div class="field">
            <label>Destinataire</label>
            <input class="input-large" type="text" name="comm_destinataire" placeholder="email ou adresse" />
          </div>
          <div class="field">
            <label>Objet</label>
            <input class="input-large" type="text" name="comm_objet" placeholder="Objet du message" />
          </div>
        </div>
        <div>
          <label>Contenu</label>
          <textarea class="input-large" name="comm_contenu" rows="3" placeholder="Contenu du message..." style="width:100%;"></textarea>
        </div>
      </div>

      <!-- Commentaire (3 lignes) -->
      <div style="margin-bottom:.6rem;">
        <label>Commentaire</label>
        <textarea name="commentaire" rows="3" placeholder="D√©tails / notes‚Ä¶" style="width:100%;"></textarea>
      </div>

      <!-- Statut + Cr√©er -->
      <div style="display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
        <div style="flex:1 1 100%;">
          <label>Statut initial</label>
          <div id="initial_status_group" style="display:flex; gap:.4rem; flex-wrap:wrap; align-items:center;">
            {% for s in status_ui %}
              <button type="button" class="btn btn-choice" data-sid="{{ s.id }}" data-key="{{ s.key }}" onclick="selectInitialStatus(this)">{{ s.label }}</button>
            {% endfor %}
            {% if en_cours_id %}
              <button type="button" id="btn_initial_en_cours" class="btn btn-choice" style="display:none; background:#16a34a; color:#fff; border-color:#16a34a; text-transform:none;" data-sid="{{ en_cours_id }}" onclick="selectInitialStatus(this)">en cours</button>
            {% endif %}
            <input type="hidden" name="statut_id" id="initial_statut_id" value="" />
          </div>
        </div>
      </div>
      <div class="create-btn-container">
        <button class="btn btn-primary btn-choice" style="min-width:160px;" type="submit"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>Cr√©er</button>
      </div>

      <datalist id="clients_list">
        {% for c in clients_suggest %}
          <option value="{{ ((c.nom or '') ~ ' ' ~ (c.prenom or '')) | trim }}"></option>
        {% endfor %}
      </datalist>
      <datalist id="affaires_list">
        {% for a in affaires_suggest %}
          <option value="{{ a.ref }}">{{ a.ref }} ‚Äî {{ a.client }}</option>
        {% endfor %}
      </datalist>
    </form>

    <script>
      const TYPES = [
        {% for t in types %}
          { id: {{ t.id }}, libelle: {{ t.libelle|tojson }}, categorie: {{ t.categorie|tojson }} },
        {% endfor %}
      ];
      const AFFAIRES = [
        {% for a in affaires_suggest %}
          { ref: {{ a.ref|tojson }}, client: {{ a.client|tojson }} },
        {% endfor %}
      ];
      const TASKS_RH_OPTIONS = {{ rh_options|tojson }};
      let tasksCalendarInstance = null;
      let tasksCalendarLoaded = false;
      const RECLAM_STATUS_ROW = document.getElementById('reclam_status_row');
      const RECLAM_STATUS_SELECT = document.getElementById('reclam_status_select');
      function populateTypes(cat) {
        const sel = document.getElementById('type_select');
        sel.innerHTML = '';
        if (!cat) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '-- choisir une cat√©gorie --';
          sel.appendChild(opt);
          return;
        }
        const opts = TYPES.filter(t => t.categorie === cat).map(t => t.libelle);
        for (const lib of opts) {
          const o = document.createElement('option');
          o.value = lib; o.textContent = lib; sel.appendChild(o);
        }
        // Auto-select first available type if present
        if (opts.length > 0) sel.value = opts[0];
      }
      const catSel = document.getElementById('categorie_select');
      function updateReclamStatusVisibility(){
        if (!RECLAM_STATUS_ROW || !catSel) return;
        const cat = (catSel.value || '').toLowerCase();
        if (cat === 'reclamation') {
          RECLAM_STATUS_ROW.style.display = 'flex';
        } else {
          RECLAM_STATUS_ROW.style.display = 'none';
          if (RECLAM_STATUS_SELECT) RECLAM_STATUS_SELECT.value = '';
        }
      }
      if (catSel){
        catSel.addEventListener('change', (e) => {
          populateTypes(e.target.value);
          updateReclamStatusVisibility();
        });
      }
      // Initialize on load if category already chosen
      if (catSel && catSel.value) { populateTypes(catSel.value); }
      updateReclamStatusVisibility();
      function toggleCommBtn() {
        const hidden = document.getElementById('comm_toggle');
        const btn = document.getElementById('comm_btn');
        const on = hidden.value === '1' ? false : true;
        hidden.value = on ? '1' : '0';
        document.getElementById('comm_block').style.display = on ? 'block' : 'none';
        btn.classList.toggle('btn-choice-active', on);
      }
      function toggleTacheAccordion(){
        const body = document.getElementById('tache_accordion_body');
        const icn = document.getElementById('tache_acc_icon');
        const btn = icn ? icn.closest('.accordion-toggle') : null;
        const otherBody = document.getElementById('tasksListBody');
        const otherIcn = document.getElementById('tasksListIcon');
        const otherBtn = otherIcn ? otherIcn.closest('.accordion-toggle') : null;
        const calendarBody = document.getElementById('calendarAccordionBody');
        const calendarIcn = document.getElementById('calendarAccordionIcon');
        const calendarBtn = calendarIcn ? calendarIcn.closest('.accordion-toggle') : null;
        const summaryBody = document.getElementById('tasksSummaryBody');
        const summaryIcn = document.getElementById('tasksSummaryIcon');
        const summaryBtn = summaryIcn ? summaryIcn.closest('.accordion-toggle') : null;
        const isOpen = body.style.display === 'block';
        const willOpen = !isOpen;
        body.style.display = willOpen ? 'block' : 'none';
        if (icn) icn.className = willOpen ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down';
        if (btn) {
          btn.classList.toggle('active', willOpen);
          btn.classList.toggle('collapsed', !willOpen);
        }
        // close the other accordion
        if (willOpen && otherBody) {
          otherBody.style.display = 'none';
          if (otherIcn) otherIcn.className = 'fa-solid fa-chevron-down';
          if (otherBtn) {
            otherBtn.classList.remove('active');
            otherBtn.classList.add('collapsed');
          }
        }
        if (willOpen && calendarBody) {
          calendarBody.style.display = 'none';
          if (calendarIcn) calendarIcn.className = 'fa-solid fa-chevron-down';
          if (calendarBtn) {
            calendarBtn.classList.remove('active');
            calendarBtn.classList.add('collapsed');
          }
        }
        if (willOpen && summaryBody) {
          summaryBody.style.display = 'none';
          if (summaryIcn) summaryIcn.className = 'fa-solid fa-chevron-down';
          if (summaryBtn) {
            summaryBtn.classList.remove('active');
            summaryBtn.classList.add('collapsed');
          }
        }
      }
      function normalizeName(s){
        if(!s) return '';
        return String(s).trim().replace(/\s+/g,' ').toLowerCase();
      }
      function updateAffairesDatalist(){
        const clientInput = document.querySelector('input[name="client_fullname"]');
        const clientVal = normalizeName(clientInput ? clientInput.value : '');
        const dl = document.getElementById('affaires_list');
        if(!dl) return;
        dl.innerHTML = '';
        const rows = (clientVal ? AFFAIRES.filter(a => normalizeName(a.client) === clientVal) : AFFAIRES);
        for(const a of rows){
          const opt = document.createElement('option');
          opt.value = a.ref;
          opt.textContent = `${a.ref} ‚Äî ${a.client}`;
          dl.appendChild(opt);
        }
      }
      (function initLinking(){
        const clientInput = document.querySelector('input[name="client_fullname"]');
        if(clientInput){
          clientInput.addEventListener('input', updateAffairesDatalist);
          clientInput.addEventListener('change', updateAffairesDatalist);
        }
        updateAffairesDatalist();
      })();
      function selectInitialStatus(btn){
        const sid = btn.getAttribute('data-sid');
        const key = btn.getAttribute('data-key');
        document.getElementById('initial_statut_id').value = sid;
        // Visual state
        const group = document.getElementById('initial_status_group');
        const peers = group.querySelectorAll('button');
        peers.forEach(b => { b.classList.remove('btn-primary'); b.classList.remove('btn-choice-active');});
        btn.classList.add('btn-primary'); btn.classList.add('btn-choice-active');
        // Toggle 'en cours' button visibility: show only when selected key in ['a faire','en attente']
        const ec = document.getElementById('btn_initial_en_cours');
        if (ec) {
          if (key === 'a faire' || key === 'en attente') {
            ec.style.display = 'inline-block';
          } else {
            ec.style.display = 'none';
          }
        }
      }
    </script>
    </div>
  </div>

    <div class="card task-card" id="tasksListCard" style="flex:1 1 100%; width:100%; margin:0;">
      <div style="padding:10px 12px; display:flex; align-items:center; gap:8px; font-weight:600; font-size:1.05rem;">
        <i class="fa-solid fa-list-check"></i> Liste des t√¢ches
      </div>
      <div id="tasksListBody" class="task-section">
    <div class="tasks-quickfilters" style="display:flex; gap:.5rem; flex-wrap:wrap; margin:.25rem 0 1rem;">
      <a class="btn btn-choice" href="/dashboard/taches"><i class="fa-solid fa-list"></i>Toutes les t√¢ches <span class="badge">{{ counts.total if counts and counts.total is not none else (items|length) }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?today=1"><i class="fa-solid fa-sun"></i>Mes t√¢ches du jour <span class="badge">{{ counts.today }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?late=1"><i class="fa-solid fa-triangle-exclamation"></i>En retard <span class="badge">{{ counts.late }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?categorie=reclamation&exclude_statut=termin√©"><i class="fa-solid fa-bell"></i>R√©clamations en cours <span class="badge">{{ counts.reclamations }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?categorie=reclamation&statut=termin%C3%A9"><i class="fa-solid fa-circle-check"></i>R√©clamations termin√©es <span class="badge">{{ counts.reclamations_terminees }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?statut=%C3%A0%20faire"><i class="fa-regular fa-square"></i>√Ä faire <span class="badge">{{ counts.a_faire }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?statut=en%20attente"><i class="fa-regular fa-clock"></i>En attente <span class="badge">{{ counts.en_attente }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?statut=en%20cours"><i class="fa-solid fa-play"></i>En cours <span class="badge">{{ counts.en_cours }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?statut=termin%C3%A9"><i class="fa-solid fa-check"></i>Termin√©es <span class="badge">{{ counts.termine }}</span></a>
      <a class="btn btn-choice" href="/dashboard/taches?statut=annul%C3%A9"><i class="fa-solid fa-xmark"></i>Annul√©es <span class="badge">{{ counts.annule }}</span></a>
    </div>
    <form method="get" action="/dashboard/taches">
      <style>
        table.tasks-table-condensed th,
        table.tasks-table-condensed td { font-size: .9rem; }
        table.tasks-table-condensed thead th:nth-child(2),
        table.tasks-table-condensed tbody td:nth-child(2) {
          width: 82px;
          white-space: normal;
          line-height: 1.25;
        }
        table.tasks-table-condensed thead th:nth-child(5),
        table.tasks-table-condensed tbody td:nth-child(5) {
          width: 110px;
          white-space: normal;
          line-height: 1.25;
        }
        table.tasks-table-condensed thead th:nth-child(6),
        table.tasks-table-condensed tbody td:nth-child(6) { width: 120px; }
        table.tasks-table-condensed .wrap-2 { white-space: normal; word-break: break-word; }
        table.tasks-table-condensed td.status-cell {
          white-space: normal;
          display: flex;
          align-items: flex-start;
          gap: 6px;
          flex-wrap: wrap;
        }
        table.tasks-table-condensed .status-chip.btn,
        table.tasks-table-condensed .status-chip.btn-choice {
          height: auto;
          min-height: 0;
          padding: 2px 6px;
          font-size: 11px;
          border-radius: 6px;
          line-height: 1.2;
          text-transform: none;
        }
        table.tasks-table-condensed .status-note {
          font-size: .78rem;
          color: var(--muted);
          line-height: 1.25;
        }
        .tasks-quickfilters .btn-choice {
          height: 34px;
          padding: 6px 10px;
          font-size: .95rem;
          gap: 6px;
          white-space: normal;
          line-height: 1.2;
        }
      </style>
      <table id="tasksTable" class="display tasks-table-condensed" style="width:100%">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Client</th>
            <th>Affaire</th>
            <th>RH</th>
            <th>Statut</th>
          </tr>
          <tr>
            <th></th>
            <th>
              <select id="tasks_type_filter" style="width:100%">
                <option value="">Tous</option>
              </select>
            </th>
            <th></th>
            <th></th>
            <th>
              <select id="tasks_rh_filter" style="width:100%">
                <option value="">Tous</option>
                {% for rh in rh_options %}
                  <option value="{{ rh.label }}">{{ rh.label }}</option>
                {% endfor %}
              </select>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for r in items %}
            <tr>
              <td class="js-dmy" data-iso="{{ r.date_evenement }}">{{ r.date_evenement }}</td>
              <td>{{ r.type_evenement }}</td>
              <td>
                {% set nom_cli = r.nom_client or r.client_nom or r.client_name or r.client or r.client_fullname %}
                {% if r.client_id and nom_cli %}
                  <a href="/dashboard/clients/{{ r.client_id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ nom_cli }}</a>
                {% elif r.client_id %}
                  <a href="/dashboard/clients/{{ r.client_id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ r.client_id }}</a>
                {% else %}-{% endif %}
              </td>
              <td>
                {% set ref_aff = r.affaire_ref or r.ref_affaire or r.affaire or r.affaire_name %}
                {% if r.affaire_id and ref_aff %}
                  <a href="/dashboard/affaires/{{ r.affaire_id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ ref_aff }}</a>
                {% elif r.affaire_id %}
                  <a href="/dashboard/affaires/{{ r.affaire_id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ r.affaire_id }}</a>
                {% else %}-{% endif %}
              </td>
              <td class="wrap-2" style="min-width:0;">{{ r.rh_label if r.rh_label else '-' }}</td>
              <td class="status-cell">
                {% set statut_label = (r.statut or '√† faire')|lower %}
                {% set btn_class = 'btn-choice' %}
                {% if statut_label == 'en cours' %}
                  {% set btn_style = 'background:#16a34a; color:#fff; border-color:#16a34a;' %}
                {% elif statut_label == 'en attente' %}
                  {% set btn_style = 'background:#f59e0b; color:#fff; border-color:#f59e0b;' %}
                {% elif statut_label in ['termin√©','termine'] %}
                  {% set btn_style = 'background:#4b5563; color:#fff; border-color:#4b5563;' %}
                {% elif statut_label in ['annul√©','annule'] %}
                  {% set btn_style = 'background:#b91c1c; color:#fff; border-color:#b91c1c;' %}
                {% else %}
                  {% set btn_style = '' %}
                {% endif %}
                <a class="btn {{ btn_class }} status-chip" href="/dashboard/taches/{{ r.evenement_id }}" style="{{ btn_style }}">{{ r.statut or '√† faire' }}</a>
                {% if r.statut_reclamation_label %}
                  <span class="status-note">R√©clamation : {{ r.statut_reclamation_label }}</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
      <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
      <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
      <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
      <script>
        $(function(){
          try { if (window.tasksDT) { window.tasksDT.destroy(); } } catch(e) {}
          try {
            window.tasksDT = $('#tasksTable').DataTable({
              destroy: true,
              paging: true,
              pageLength: 25,
              fixedHeader: false,
              autoWidth: false,
              dom: 'Bfrtip',
              buttons: [ { extend: 'csvHtml5', text: 'Exporter CSV', title: 'taches', bom: true, charset: 'utf-8', fieldSeparator: ';' } ],
              order: [[0,'desc']],
              language: { emptyTable: 'Aucune t√¢che' },
              columnDefs: [
                { targets: [0,3], className: 'nowrap' },
                { targets: 1, className: 'wrap-2', width: '90px' },
                { targets: 4, className: 'wrap-2', width: '110px' },
                { targets: 5, className: 'wrap-2', width: '120px' },
                { targets: 0, render: function(data, type){
                    if (!data) return '';
                    var s = String(data).trim();
                    var d = /^\d{4}-\d{2}-\d{2}/.test(s) ? new Date(s.replace(' ', 'T')) : new Date(s);
                    if (isNaN(d)) return data;
                    var dd = String(d.getDate()).padStart(2,'0');
                    var mm = String(d.getMonth()+1).padStart(2,'0');
                    var yy = d.getFullYear();
                    return (type==='display'||type==='filter') ? (dd+'/'+mm+'/'+yy) : d.toISOString();
                  }},
              ]
            });
            function buildTypeOptions(useApplied){
              try {
                var sel = document.getElementById('tasks_type_filter');
                if (!sel || !window.tasksDT) return;
                var data = window.tasksDT.column(1, { search: (useApplied? 'applied' : 'none') }).data();
                var seen = new Set();
                for (var i=0;i<data.length;i++){
                  var txt = String(data[i]||'').trim();
                  if (txt) seen.add(txt);
                }
                var opts = Array.from(seen).sort(function(a,b){ return a.localeCompare(b, 'fr', {sensitivity:'base'}); });
                var current = sel.value || '';
                sel.length = 1;
                opts.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
                if (current && opts.indexOf(current) >= 0) sel.value = current; else sel.value = '';
              } catch(e) {}
            }
            buildTypeOptions(false);
            $('#tasksTable').on('draw.dt', function(){ buildTypeOptions(true); });
            $('#tasks_type_filter').on('change', function(){
              var v = this.value || '';
              if (!v) { window.tasksDT.column(1).search('').draw(); return; }
              var esc = $.fn.dataTable.util.escapeRegex(v);
              window.tasksDT.column(1).search('^'+esc+'$', true, false).draw();
            });
            $('#tasks_rh_filter').on('change', function(){
              var v = this.value || '';
              if (!v) { window.tasksDT.column(4).search('').draw(); return; }
              var esc = $.fn.dataTable.util.escapeRegex(v);
              window.tasksDT.column(4).search('^'+esc+'$', true, false).draw();
            });
          } catch(e) {}
        });
      </script>

      <!-- Navigation vers une page d'√©dition d√©di√©e via le lien Statut -->
    </form>
      </div> <!-- /#tasksListBody -->
    </div>
    <div class="card task-card" id="calendarCard" style="flex:1 1 100%; width:100%; margin:0;">
      <div style="padding:10px 12px; display:flex; align-items:center; gap:8px; font-weight:600; font-size:1.05rem;">
        <i class="fa-solid fa-calendar"></i> Calendrier
      </div>
      <div id="calendarAccordionBody" class="task-section active">
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-bottom:12px;">
          <div>
            <label class="muted" style="font-size:0.85rem;">Responsable</label><br>
            <select id="tasksCalFilterResp" style="min-width:180px; height:32px; padding:4px 8px; border:1px solid var(--border); border-radius:8px;">
              <option value="">Tous</option>
              {% for rh in rh_options %}
                <option value="{{ rh.id }}">{{ rh.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="muted" style="font-size:0.85rem;">Statut</label><br>
            <select id="tasksCalFilterStatut" style="min-width:160px; height:32px; padding:4px 8px; border:1px solid var(--border); border-radius:8px;">
              <option value="">Tous</option>
              <option value="√† faire">√Ä faire</option>
              <option value="en cours">En cours</option>
              <option value="en attente">En attente</option>
              <option value="termin√©">Termin√©</option>
              <option value="annul√©">Annul√©</option>
            </select>
          </div>
          <div>
            <button id="tasksCalRefresh" class="btn btn-primary" style="height:32px;">Actualiser</button>
          </div>
          <div>
            <label class="muted" style="font-size:0.85rem;">P√©riode export (jours autour d'aujourd'hui)</label><br>
            <select id="tasksCalRangeSelect" style="min-width:140px; height:32px; padding:4px 8px; border:1px solid var(--border); border-radius:8px;">
              <option value="30">30 jours</option>
              <option value="90" selected>90 jours</option>
              <option value="180">180 jours</option>
              <option value="365">365 jours</option>
            </select>
          </div>
          <div>
            <button id="tasksCalExport" class="btn" style="height:32px; border:1px solid var(--border);">Exporter ICS</button>
          </div>
        </div>
        <div id="tasksCalendar" style="margin-top:8px; min-height:480px;"></div>
      </div>
    </div>
    <div class="card task-card" id="reclamCard" style="flex:1 1 100%; width:100%; margin:0;">
      <div style="padding:10px 12px; display:flex; align-items:center; gap:8px; font-weight:600; font-size:1.05rem;">
        <i class="fa-solid fa-table-list"></i> Livre des r√©clamations
      </div>
      <div id="reclamPivotBody" class="task-section">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom: .6rem;">
          <div>
            <p class="eyebrow" style="margin-bottom:4px;">R√©clamations par type et statut</p>
            <h3 style="margin:0;">Synth√®se</h3>
            <div class="muted" style="font-size:0.9rem; margin-top:2px;">Total : {{ reclam_stats.total if reclam_stats else 0 }}</div>
            {% if reclam_stats and reclam_stats.by_status %}
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:0.9rem;">
                {% for st in reclam_stats.by_status %}
                  <span class="badge">{{ st.label or 'Statut non renseign√©' }} : {{ st.count }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          <a href="/dashboard/reclamations/export"
             class="btn btn-primary"
             style="min-width:120px; padding:5px 8px; display:inline-flex; align-items:center; justify-content:center; gap:6px; text-decoration:none; color:#fff; font-size:0.9rem; border-radius:8px;">
            <i class="fa-solid fa-file-export" style="color:#fff; font-size:0.9rem;"></i>Export
          </a>
        </div>
        {% if reclam_pivot.types and reclam_pivot.statuses %}
          <style>
            .reclam-pivot-table {
              width: 100%;
              border-collapse: separate;
              border-spacing: 0;
              font-size: 0.85rem;
              margin-top: 0.7rem;
            }
            .reclam-pivot-table th {
              border: 1px solid #e2e8f0;
              padding: 6px 8px;
              text-align: center;
              white-space: normal;
              line-height: 1.2;
              background: var(--primary);
              color: #fff;
            }
            .reclam-pivot-table td {
              border: 1px solid #e2e8f0;
              padding: 6px 8px;
              text-align: center;
              white-space: nowrap;
            }
            .reclam-pivot-table td.has-data { background:#f4f6f9; }
            .reclam-pivot-table td.pivot-cell { cursor: pointer; }
            .reclam-pivot-table tbody td:first-child {
              text-align: left;
              background: #e2e8f0;
              font-weight: 600;
              position: sticky;
              left: 0;
              z-index: 1;
            }
          </style>
          <div style="overflow:auto;">
            <table class="reclam-pivot-table">
              <thead>
                <tr>
                  <th>Type</th>
                  {% for status in reclam_pivot.statuses %}
                    <th>{{ status }}</th>
                  {% endfor %}
                </tr>
                <tr class="reclam-filter-row">
                  <th>
                    <select id="pivotTypeFilter" onchange="filterReclamPivot()" style="width:100%; font-size:0.85rem; padding:4px 6px; border-radius:8px; border:1px solid var(--border);">
                      <option value="">Tous les types</option>
                      {% for t in reclam_pivot.types %}
                        <option value="{{ t.label }}">{{ t.label }}</option>
                      {% endfor %}
                    </select>
                  </th>
                  {% for status in reclam_pivot.statuses %}
                    <th>
                      <select class="pivot-status-filter" data-status="{{ status|lower }}" onchange="filterReclamPivot()" style="width:100%; font-size:0.85rem; padding:4px 6px; border-radius:8px; border:1px solid var(--border);">
                        <option value="">Tous</option>
                        <option value="has">> 0</option>
                        <option value="zero">= 0</option>
                      </select>
                    </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for t in reclam_pivot.types %}
                    {% set counts = t.counts if t.counts is defined else (t['counts'] if 'counts' in t else {}) %}
                  <tr data-type="{{ (t.label or '')|lower }}">
                    <td class="has-data">{{ t.label or 'Type' }}</td>
                    {% for status in reclam_pivot.statuses %}
                      {% set val = counts.get(status, 0) if counts else 0 %}
                      {% set display_val = val if val else '' %}
                      {% set data_class = 'has-data pivot-cell' if display_val else '' %}
                      <td class="{{ data_class }}" data-status="{{ status|lower }}" data-status-label="{{ status }}" data-val="{{ val }}">{{ display_val }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div id="reclamPivotEmpty" class="muted" style="margin-top:0.6rem; display:none;">Aucune r√©clamation pour ces filtres.</div>
        {% else %}
          <div class="muted" style="margin-top:0.6rem;">Aucune r√©clamation trouv√©e.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    // Synth√®se t√¢ches (charts)
    (function(){
      var summaryLoaded = false;
      var summaryRange = 14;
      var charts = { days:null, type:null, statut:null, categorie:null, dist:null };
      var statusEl = document.getElementById('tasksStatus');
      var btnLoad = document.getElementById('tasksLoadBtn');
      var btnsRange = Array.from(document.querySelectorAll('.tasks-range-btn'));
      var selRh = document.getElementById('tasksRhSelect');

      function setStatus(txt){ if (statusEl) statusEl.textContent = txt; }
      function fmt(x){ return (x === null || x === undefined) ? '‚Äî' : x; }
      function setText(id, value){ var el=document.getElementById(id); if(el) el.textContent = value; }
      function destroyChart(ch){ if(ch && ch.destroy) ch.destroy(); }
      function primaryColor(){ return getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; }

      function renderCharts(data){
        var stat = data.tasks_statut || [];
        var cat = data.tasks_categorie || [];
        var days = data.tasks_days || [];
        var dist = data.tasks_close_dist || [];
        var byRh = data.tasks_type_by_rh || [];
        var totals = data.tasks_type_total || [];
        var color = primaryColor();

        destroyChart(charts.statut);
        if (document.getElementById('chartTasksStatut') && stat.length){
          charts.statut = new Chart(document.getElementById('chartTasksStatut').getContext('2d'), {
            type:'bar', data:{ labels: stat.map(function(x){return x.statut||'n/a';}), datasets:[{ data: stat.map(function(x){return x.nb||0;}), backgroundColor: color }]},
            options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
          });
        }

        destroyChart(charts.categorie);
        if (document.getElementById('chartTasksCategorie') && cat.length){
          charts.categorie = new Chart(document.getElementById('chartTasksCategorie').getContext('2d'), {
            type:'bar', data:{ labels: cat.map(function(x){return x.categorie||'n/a';}), datasets:[{ data: cat.map(function(x){return x.nb||0;}), backgroundColor: color }]},
            options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
          });
        }

        destroyChart(charts.days);
        if (document.getElementById('chartTasksDays') && days.length){
          charts.days = new Chart(document.getElementById('chartTasksDays').getContext('2d'), {
            type:'bar', data:{ labels: days.map(function(x){return x.day;}), datasets:[{ data: days.map(function(x){return x.nb||0;}), backgroundColor: color }]},
            options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
          });
        }

        destroyChart(charts.dist);
        if (document.getElementById('chartTasksCloseDist') && dist.length){
          charts.dist = new Chart(document.getElementById('chartTasksCloseDist').getContext('2d'), {
            type:'bar', data:{ labels: dist.map(function(x){return x.bucket;}), datasets:[{ data: dist.map(function(x){return x.nb||0;}), backgroundColor: color }]},
            options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
          });
        }

        if (selRh){
          selRh.innerHTML = '';
          var optAll = document.createElement('option'); optAll.value=''; optAll.textContent='Tous'; selRh.appendChild(optAll);
          var rhPairs = [];
          var seen = new Set();
          byRh.forEach(function(r){
            if (r.rh_id == null || !r.rh_nom) return;
            var key = String(r.rh_id);
            if (seen.has(key)) return;
            seen.add(key);
            rhPairs.push({ id:r.rh_id, nom:r.rh_nom });
          });
          rhPairs.sort(function(a,b){ return String(a.nom).localeCompare(String(b.nom),'fr',{sensitivity:'base'}); });
          rhPairs.forEach(function(p){
            var o=document.createElement('option'); o.value=String(p.id); o.textContent=p.nom; selRh.appendChild(o);
          });
          destroyChart(charts.type);
          function drawType(rhId){
            var map = new Map();
            if (rhId){
              byRh.filter(function(r){ return String(r.rh_id) === String(rhId); }).forEach(function(r){ map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
            } else {
              (totals||[]).forEach(function(r){ map.set(r.type, (map.get(r.type)||0) + Number(r.nb||0)); });
            }
            var entries = Array.from(map.entries()).sort(function(a,b){ return b[1]-a[1]; });
            var labels = entries.map(function(e){ return e[0]; });
            var data = entries.map(function(e){ return e[1]; });
            destroyChart(charts.type);
            if (document.getElementById('chartTasksType') && labels.length){
              charts.type = new Chart(document.getElementById('chartTasksType').getContext('2d'), {
                type:'bar', data:{ labels: labels, datasets:[{ data: data, backgroundColor: color }]},
                options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
              });
            }
          }
          selRh.onchange = function(){ drawType(this.value || null); };
          drawType(null);
        }
      }

      async function loadSummary(range){
        var targetRange = range || summaryRange || 14;
        setStatus('Chargement‚Ä¶');
        try{
          var res = await fetch('/dashboard/tasks/summary?range=' + targetRange, { credentials:'same-origin' });
          if (!res.ok) throw new Error('HTTP '+res.status);
          var data = await res.json();
          summaryRange = targetRange;
          setText('tasksTotal', fmt(data.tasks_total));
          setText('tasksOpen', fmt(data.tasks_open));
          var closed = (Number(data.tasks_total||0) - Number(data.tasks_open||0));
          setText('tasksClosed', fmt(closed));
          var today = (data.tasks_days || []).slice(-1)[0];
          setText('tasksToday', fmt(today ? today.nb : '‚Äî'));
          renderCharts(data);
          btnsRange.forEach(function(btn){
            var r = Number(btn.dataset.range || 0);
            if (r === targetRange){ btn.classList.add('btn-choice-active'); }
            else { btn.classList.remove('btn-choice-active'); }
          });
          setStatus('Charg√©');
          summaryLoaded = true;
        } catch(err){
          console.error('Tasks summary load error', err);
          setStatus('Erreur de chargement');
        }
      }

      if (btnLoad) btnLoad.addEventListener('click', function(){ loadSummary(); });
      btnsRange.forEach(function(btn){
        btn.addEventListener('click', function(){ loadSummary(Number(btn.dataset.range||14)); });
      });

      window.__toggleTasksSummary = function(willOpen){
        if (willOpen && !summaryLoaded) { loadSummary(summaryRange); }
      };
    })();

    function toggleComment(id){
      var s = document.getElementById('cmt-short-'+id);
      var f = document.getElementById('cmt-full-'+id);
      if(!s || !f) return false;
      var isShortVisible = s.style.display !== 'none';
      s.style.display = isShortVisible ? 'none' : '';
      f.style.display = isShortVisible ? '' : 'none';
      var link = event.target;
      if(link && link.tagName.toLowerCase() === 'a'){
        link.textContent = isShortVisible ? 'Voir moins' : 'Voir plus';
      }
      return false;
    }
    function toggleTasksSummary(){
      var body = document.getElementById('tasksSummaryBody');
      var icn = document.getElementById('tasksSummaryIcon');
      if (!body || !icn) return;
      var createBody = document.getElementById('tache_accordion_body');
      var createIcn = document.getElementById('tache_acc_icon');
      var createBtn = createIcn ? createIcn.closest('.accordion-toggle') : null;
      var listBody = document.getElementById('tasksListBody');
      var listIcn = document.getElementById('tasksListIcon');
      var listBtn = listIcn ? listIcn.closest('.accordion-toggle') : null;
      var calendarBody = document.getElementById('calendarAccordionBody');
      var calendarIcn = document.getElementById('calendarAccordionIcon');
      var calendarBtn = calendarIcn ? calendarIcn.closest('.accordion-toggle') : null;
      var reclBody = document.getElementById('reclamPivotBody');
      var reclIcn = document.getElementById('reclamPivotIcon');
      var reclBtn = reclIcn ? reclIcn.closest('.accordion-toggle') : null;
      var isOpen = body.style.display !== 'none';
      var willOpen = !isOpen;
      body.style.display = willOpen ? 'block' : 'none';
      icn.className = willOpen ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down';
      var btn = icn.closest('.accordion-toggle');
      if (btn){
        btn.classList.toggle('active', willOpen);
        btn.classList.toggle('collapsed', !willOpen);
      }
      if (willOpen && createBody){
        createBody.style.display = 'none';
        if (createIcn) createIcn.className = 'fa-solid fa-chevron-down';
        if (createBtn){
          createBtn.classList.remove('active');
          createBtn.classList.add('collapsed');
        }
      }
      if (willOpen && listBody){
        listBody.style.display = 'none';
        if (listIcn) listIcn.className = 'fa-solid fa-chevron-down';
        if (listBtn){
          listBtn.classList.remove('active');
          listBtn.classList.add('collapsed');
        }
      }
      if (willOpen && calendarBody){
        calendarBody.style.display = 'none';
        if (calendarIcn) calendarIcn.className = 'fa-solid fa-chevron-down';
        if (calendarBtn){
          calendarBtn.classList.remove('active');
          calendarBtn.classList.add('collapsed');
        }
      }
      if (willOpen && reclBody){
        reclBody.style.display = 'none';
        if (reclIcn) reclIcn.className = 'fa-solid fa-chevron-down';
        if (reclBtn){
          reclBtn.classList.remove('active');
          reclBtn.classList.add('collapsed');
        }
      }
      if (willOpen && window.__toggleTasksSummary){ window.__toggleTasksSummary(true); }
    }
    function toggleTasksList(){
      var body = document.getElementById('tasksListBody');
      var icn = document.getElementById('tasksListIcon');
      if (!body || !icn) return;
      var otherBody = document.getElementById('tache_accordion_body');
      var otherIcn = document.getElementById('tache_acc_icon');
      var otherBtn = otherIcn ? otherIcn.closest('.accordion-toggle') : null;
      var calendarBody = document.getElementById('calendarAccordionBody');
      var calendarIcn = document.getElementById('calendarAccordionIcon');
      var calendarBtn = calendarIcn ? calendarIcn.closest('.accordion-toggle') : null;
      var summaryBody = document.getElementById('tasksSummaryBody');
      var summaryIcn = document.getElementById('tasksSummaryIcon');
      var summaryBtn = summaryIcn ? summaryIcn.closest('.accordion-toggle') : null;
      var isOpen = body.style.display !== 'none';
      var willOpen = !isOpen;
        body.style.display = willOpen ? 'block' : 'none';
        icn.className = willOpen ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down';
        var btn = icn.closest('.accordion-toggle');
        if (btn) { 
          btn.classList.toggle('active', willOpen);
          btn.classList.toggle('collapsed', !willOpen);
        }
        if (willOpen && otherBody) {
          otherBody.style.display = 'none';
          if (otherIcn) otherIcn.className = 'fa-solid fa-chevron-down';
          if (otherBtn) {
            otherBtn.classList.remove('active');
            otherBtn.classList.add('collapsed');
          }
        }
        if (willOpen && calendarBody) {
          calendarBody.style.display = 'none';
          if (calendarIcn) calendarIcn.className = 'fa-solid fa-chevron-down';
          if (calendarBtn) {
            calendarBtn.classList.remove('active');
            calendarBtn.classList.add('collapsed');
          }
        }
        if (willOpen && summaryBody) {
          summaryBody.style.display = 'none';
          if (summaryIcn) summaryIcn.className = 'fa-solid fa-chevron-down';
          if (summaryBtn) {
            summaryBtn.classList.remove('active');
            summaryBtn.classList.add('collapsed');
          }
        }
      }
    async function initTasksCalendar(){
      if (tasksCalendarLoaded && tasksCalendarInstance) { return tasksCalendarInstance; }
      var calEl = document.getElementById('tasksCalendar');
      if (!calEl) return null;
      function ensureStyleOnce(href){
        if (document.querySelector('link[href=\"'+href+'\"]')) return;
        var l=document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l);
      }
      function ensureScriptOnce(src){
        return new Promise(function(resolve, reject){
          var existing = document.querySelector('script[src=\"'+src+'\"]');
          if (existing){
            if (existing.dataset.loaded === '1') { return resolve(); }
            existing.addEventListener('load', function(){ resolve(); });
            existing.addEventListener('error', reject);
            return;
          }
          var s=document.createElement('script');
          s.src=src;
          s.dataset.loaded='0';
          s.onload=function(){ s.dataset.loaded='1'; resolve(); };
          s.onerror=reject;
          document.head.appendChild(s);
        });
      }
      ensureStyleOnce('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css');
      await ensureScriptOnce('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js');

      var statutSelect = document.getElementById('tasksCalFilterStatut');
      var respSelect = document.getElementById('tasksCalFilterResp');
      var refreshBtn = document.getElementById('tasksCalRefresh');
      var exportBtn = document.getElementById('tasksCalExport');
      var rangeSelect = document.getElementById('tasksCalRangeSelect');

      try {
        if (respSelect && Array.isArray(TASKS_RH_OPTIONS)) {
          while (respSelect.options.length > 1) { respSelect.remove(1); }
          var seen = new Set();
          TASKS_RH_OPTIONS.forEach(function(rh){
            var id = rh.id;
            if (seen.has(id)) return;
            seen.add(id);
            var opt = document.createElement('option');
            opt.value = id;
            opt.textContent = rh.label || rh.nom || ('RH #' + id);
            respSelect.appendChild(opt);
          });
        }
      } catch(e){ console.warn('RH options calendar', e); }

      var apiUrl = '/dashboard/api/taches';
      function loadTasks(){
        var statut = (statutSelect || {}).value || '';
        var resp = (respSelect || {}).value || '';
        var params = new URLSearchParams();
        if (statut) params.set('statut', statut);
        if (resp) params.set('rh_id', resp);
        var qs = params.toString();
        return fetch(qs ? (apiUrl + '?' + qs) : apiUrl).then(function(r){ return r.json(); });
      }
      function statusColors(statut){
        var s = (statut || '').toString().trim().toLowerCase();
        if (s === 'en cours') return { bg: '#16a34a', fg: '#fff' };
        if (s === 'en attente') return { bg: '#f59e0b', fg: '#fff' };
        if (s === 'termin√©' || s === 'termine') return { bg: '#4b5563', fg: '#fff' };
        if (s === 'annul√©' || s === 'annule') return { bg: '#b91c1c', fg: '#fff' };
        return { bg: '#2563eb', fg: '#fff' };
      }

      tasksCalendarInstance = new FullCalendar.Calendar(calEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,timeGridDay' },
        height: 520,
        events: async function(info, success){
          try {
            var data = await loadTasks();
            var items = (data && data.items) || [];
            success(items.map(function(ev){
              var colors = statusColors(ev.statut);
              return {
                id: ev.id,
                title: ev.title,
                start: ev.start,
                end: ev.end,
                backgroundColor: colors.bg,
                borderColor: colors.bg,
                textColor: colors.fg,
                extendedProps: ev
              };
            }));
          } catch(_e){ success([]); }
        },
        eventClick: function(info){
          var ev = info.event.extendedProps || {};
          var taskId = ev.id || info.event.id;
          if (taskId) {
            var url = '/dashboard/taches/' + taskId;
            try { window.open(url, '_blank', 'noopener'); }
            catch(_err) { window.location.href = url; }
          }
        }
      });
      tasksCalendarInstance.render();
      tasksCalendarLoaded = true;

      if (refreshBtn) refreshBtn.addEventListener('click', function(){ if (tasksCalendarInstance) tasksCalendarInstance.refetchEvents(); });
      if (statutSelect) statutSelect.addEventListener('change', function(){ if (tasksCalendarInstance) tasksCalendarInstance.refetchEvents(); });
      if (respSelect) respSelect.addEventListener('change', function(){ if (tasksCalendarInstance) tasksCalendarInstance.refetchEvents(); });
      if (exportBtn){
        exportBtn.addEventListener('click', function(){
          var statut = (statutSelect || {}).value || '';
          var resp = (respSelect || {}).value || '';
          var range = (rangeSelect || {}).value || '';
          var params = new URLSearchParams();
          if (statut) params.set('statut', statut);
          if (resp) params.set('rh_id', resp);
          if (range) params.set('range_days', range);
          var url = apiUrl + '.ics' + (params.toString() ? ('?' + params.toString()) : '');
          try { window.open(url, '_blank', 'noopener'); }
          catch(_err){ window.location.href = url; }
        });
      }
      return tasksCalendarInstance;
    }
    function toggleCalendarAccordion(){
      var body = document.getElementById('calendarAccordionBody');
      var icn = document.getElementById('calendarAccordionIcon');
      if (!body || !icn) return;
      var tasksBody = document.getElementById('tasksListBody');
      var tasksIcn = document.getElementById('tasksListIcon');
      var tasksBtn = tasksIcn ? tasksIcn.closest('.accordion-toggle') : null;
      var createBody = document.getElementById('tache_accordion_body');
      var createIcn = document.getElementById('tache_acc_icon');
      var createBtn = createIcn ? createIcn.closest('.accordion-toggle') : null;
      var summaryBody = document.getElementById('tasksSummaryBody');
      var summaryIcn = document.getElementById('tasksSummaryIcon');
      var summaryBtn = summaryIcn ? summaryIcn.closest('.accordion-toggle') : null;
      var isOpen = body.style.display !== 'none';
      var willOpen = !isOpen;
      body.style.display = willOpen ? 'block' : 'none';
      icn.className = willOpen ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down';
      var btn = icn.closest('.accordion-toggle');
      if (btn){
        btn.classList.toggle('active', willOpen);
        btn.classList.toggle('collapsed', !willOpen);
      }
      if (willOpen && tasksBody){
        tasksBody.style.display = 'none';
        if (tasksIcn) tasksIcn.className = 'fa-solid fa-chevron-down';
        if (tasksBtn){
          tasksBtn.classList.remove('active');
          tasksBtn.classList.add('collapsed');
        }
      }
      if (willOpen && createBody){
        createBody.style.display = 'none';
        if (createIcn) createIcn.className = 'fa-solid fa-chevron-down';
        if (createBtn){
          createBtn.classList.remove('active');
          createBtn.classList.add('collapsed');
        }
      }
      if (willOpen && summaryBody){
        summaryBody.style.display = 'none';
        if (summaryIcn) summaryIcn.className = 'fa-solid fa-chevron-down';
        if (summaryBtn){
          summaryBtn.classList.remove('active');
          summaryBtn.classList.add('collapsed');
        }
      }
      if (willOpen){
        initTasksCalendar().then(function(cal){
          if (cal){
            cal.updateSize();
            cal.render();
          }
        }).catch(function(err){ console.warn('Calendrier t√¢ches', err); });
      }
    }
    // Initial state: keep accordions closed (fond blanc / texte noir)
    (function syncAccordions(){
      var tacheBody = document.getElementById('tache_accordion_body');
      var tacheBtn = document.querySelector('button.accordion-toggle[onclick^=\"toggleTacheAccordion\"]');
      if (tacheBody && tacheBtn) {
        tacheBody.style.display = 'none';
        tacheBtn.classList.remove('active');
        var ic = document.getElementById('tache_acc_icon');
        if (ic) ic.className = 'fa-solid fa-chevron-down';
      }
      var tasksBody = document.getElementById('tasksListBody');
      var tasksBtn = document.querySelector('button.accordion-toggle[onclick^=\"toggleTasksList\"]');
      if (tasksBody && tasksBtn) {
        tasksBody.style.display = 'none';
        tasksBtn.classList.remove('active');
        var ic2 = document.getElementById('tasksListIcon');
        if (ic2) ic2.className = 'fa-solid fa-chevron-down';
      }
      var calendarBody = document.getElementById('calendarAccordionBody');
      var calendarBtn = document.querySelector('button.accordion-toggle[onclick^=\"toggleCalendarAccordion\"]');
      if (calendarBody && calendarBtn) {
        calendarBody.style.display = 'none';
        calendarBtn.classList.remove('active');
        var icCal = document.getElementById('calendarAccordionIcon');
        if (icCal) icCal.className = 'fa-solid fa-chevron-down';
      }
      var summaryBody = document.getElementById('tasksSummaryBody');
      var summaryBtn = document.querySelector('button.accordion-toggle[onclick^=\"toggleTasksSummary\"]');
      if (summaryBody && summaryBtn) {
        summaryBody.style.display = 'none';
        summaryBtn.classList.remove('active');
        var icSum = document.getElementById('tasksSummaryIcon');
        if (icSum) icSum.className = 'fa-solid fa-chevron-down';
      }
      var reclBody = document.getElementById('reclamPivotBody');
      var reclBtn = document.querySelector('button.accordion-toggle[onclick^=\"toggleReclamPivot\"]');
      if (reclBody && reclBtn) {
        reclBody.style.display = 'none';
        reclBtn.classList.remove('active');
        var ic3 = document.getElementById('reclamPivotIcon');
        if (ic3) ic3.className = 'fa-solid fa-chevron-down';
      }
    })();
    function toggleReclamPivot(){
      var body = document.getElementById('reclamPivotBody');
      var icn = document.getElementById('reclamPivotIcon');
      if (!body || !icn) return;
      var otherBodies = [
        { el: document.getElementById('tasksListBody'), ic: document.getElementById('tasksListIcon') },
        { el: document.getElementById('tache_accordion_body'), ic: document.getElementById('tache_acc_icon') },
        { el: document.getElementById('calendarAccordionBody'), ic: document.getElementById('calendarAccordionIcon') },
        { el: document.getElementById('tasksSummaryBody'), ic: document.getElementById('tasksSummaryIcon') }
      ];
      var isOpen = body.style.display !== 'none';
      var willOpen = !isOpen;
      body.style.display = willOpen ? 'block' : 'none';
      icn.className = willOpen ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down';
      var btn = icn.closest('.accordion-toggle');
      if (btn) {
        btn.classList.toggle('active', willOpen);
        btn.classList.toggle('collapsed', !willOpen);
      }
      if (willOpen){
        otherBodies.forEach(function(entry){
          if(entry.el){
            entry.el.style.display = 'none';
          }
          if(entry.ic){
            entry.ic.className = 'fa-solid fa-chevron-down';
            var b = entry.ic.closest('.accordion-toggle');
            if (b) { b.classList.remove('active'); b.classList.add('collapsed'); }
          }
        });
      }
    }
    function filterReclamPivot(){
      var typeSel = document.getElementById('pivotTypeFilter');
      var typeVal = typeSel ? (typeSel.value || '').toLowerCase() : '';
      var statusFilters = document.querySelectorAll('.pivot-status-filter');
      var rows = document.querySelectorAll('#reclamPivotBody .reclam-pivot-table tbody tr');
      var shown = 0;
      rows.forEach(function(row){
        var type = (row.getAttribute('data-type') || '').toLowerCase();
        var okType = !typeVal || type === typeVal;
        var visible = okType;
        if (visible && statusFilters && statusFilters.length){
          statusFilters.forEach(function(sel){
            if (!visible) return;
            var statusKey = (sel.getAttribute('data-status') || '').toLowerCase();
            var mode = sel.value || '';
            if (!statusKey || !mode) return;
            var cell = row.querySelector('td[data-status="'+statusKey+'"]');
            var val = cell ? parseFloat(cell.getAttribute('data-val') || '0') : 0;
            if (mode === 'has' && !(val > 0)) { visible = false; }
            if (mode === 'zero' && val !== 0) { visible = false; }
          });
        }
        row.style.display = visible ? '' : 'none';
        if (visible) shown++;
      });
      var empty = document.getElementById('reclamPivotEmpty');
      if (empty) empty.style.display = shown ? 'none' : '';
    }
    // Init filters once DOM is ready
    document.addEventListener('DOMContentLoaded', filterReclamPivot);
    function filterTasksFromPivot(typeLabel, statusLabel, attempt){
      attempt = attempt || 0;
      // Open tasks accordion
      var tasksBody = document.getElementById('tasksListBody');
      if (tasksBody && tasksBody.style.display === 'none') {
        toggleTasksList();
      }
      if (!window.tasksDT) {
        if (attempt < 5) {
          setTimeout(function(){ filterTasksFromPivot(typeLabel, statusLabel, attempt+1); }, 150);
        }
        return;
      }
      // Type
      var typeSel = document.getElementById('tasks_type_filter');
      if (typeSel) typeSel.value = typeLabel || '';
      window.tasksDT.column(1).search(typeLabel || '', false, false, true);
      // Statut (col 5)
      window.tasksDT.column(5).search(statusLabel || '', false, false, true);
      // Clear RH filter to avoid hiding matches
      window.tasksDT.column(4).search('');
      var rhSel = document.getElementById('tasks_rh_filter');
      if (rhSel) rhSel.value = '';
      window.tasksDT.draw();
      // Scroll to tasks list
      if (tasksBody) { tasksBody.scrollIntoView({behavior:'smooth', block:'start'}); }
    }
    // Click binding on pivot cells
    document.addEventListener('click', function(ev){
      var cell = ev.target.closest('.pivot-cell');
      if (!cell) return;
      var row = cell.closest('tr');
      var typeLabel = row ? (row.querySelector('td.has-data')?.textContent || '').trim() : '';
      var statusLabel = (cell.getAttribute('data-status-label') || cell.getAttribute('data-status') || '').trim();
      if (!statusLabel) return;
      filterTasksFromPivot(typeLabel, statusLabel);
    });

    // Navigation horizontale : affichage exclusif + scroll (sans accord√©ons)
    var TASK_SECTIONS = [
      { card: 'tasksSummaryCard', body: 'tasksSummaryBody' },
      { card: 'tacheFormCard', body: 'tache_accordion_body' },
      { card: 'tasksListCard', body: 'tasksListBody' },
      { card: 'calendarCard', body: 'calendarAccordionBody' },
      { card: 'reclamCard', body: 'reclamPivotBody' },
    ];
    function setSectionOpen(targetCard){
      TASK_SECTIONS.forEach(function(sec){
        var open = targetCard && sec.card === targetCard;
        var body = document.getElementById(sec.body);
        var card = document.getElementById(sec.card);
        if (body){
          body.style.display = open ? 'block' : 'none';
          body.classList.toggle('active', open);
        }
        if (card){
          card.style.display = open ? 'block' : 'none';
          card.classList.toggle('active', open);
        }
      });
      if (targetCard === 'calendarCard'){
        initTasksCalendar().then(function(cal){
          if (cal){ cal.updateSize(); cal.render(); }
        }).catch(function(err){ console.warn('Calendrier t√¢ches', err); });
      }
      if (targetCard === 'tasksSummaryCard' && typeof window.__toggleTasksSummary === 'function'){
        window.__toggleTasksSummary(true);
      }
    }
    // Harmonise les anciennes fonctions d'accord√©on pour s'appuyer sur l'affichage exclusif
    window.focusTaskSection = function(targetCard){ setSectionOpen(targetCard); };
    window.toggleTasksSummary = function(){ setSectionOpen('tasksSummaryCard'); };
    window.toggleTacheAccordion = function(){ setSectionOpen('tacheFormCard'); };
    window.toggleTasksList = function(){ setSectionOpen('tasksListCard'); };
    window.toggleCalendarAccordion = function(){ setSectionOpen('calendarCard'); };
    window.toggleReclamPivot = function(){ setSectionOpen('reclamCard'); };
    // Section par d√©faut au chargement
    document.addEventListener('DOMContentLoaded', function(){ setSectionOpen('tasksSummaryCard'); });
  </script>
{% endblock %}
