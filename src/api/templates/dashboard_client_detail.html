{% extends "base.html" %}

{% block title %}{% if client %}Suivi client – {{ client.prenom }} {{ client.nom }}{% else %}Suivi client{% endif %}{% endblock %}
{% block header_title %}
  {% if client %}
    <span style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <span><i class="fa-solid fa-users" style="margin-right:8px;"></i>Suivi client – {{ client.prenom }} {{ client.nom }}</span>
      <button id="contactExportBtn" type="button" class="dim-btn" style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px;">
        <i class="fa-solid fa-file-export"></i><span>Contact</span>
      </button>
    </span>
  {% else %}
    <i class="fa-solid fa-users" style="margin-right:8px;"></i>Suivi client
  {% endif %}
{% endblock %}

{% block content %}
<style>
  /* Modal export contact */
  #contactExportModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  #contactExportModal .modal-card {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    width: min(420px, 92vw);
    box-shadow: 0 14px 38px rgba(0,0,0,0.18);
  }
  #contactExportModal h3 {
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #contactExportModal .contact-line {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 6px 0;
    color: #111827;
  }
  #contactExportModal .contact-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  #contactMailModal .field {
    display:flex;
    flex-direction:column;
    gap:4px;
    margin-bottom:12px;
  }
  .card { background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 14px; }
  .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .card-header {
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    background: var(--primary);
    color:#fff;
    border-radius:8px;
    font-size:0.9rem;
    font-weight:600;
  }
  table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
  th, td { padding: 6px 8px; border-bottom: 1px solid #eee; }
  th { background: #f8f9fa; text-align: left; font-size: 0.8rem; }
  .kpi { font-size: 0.95rem; font-weight: 700; }
  .kpi-small { font-size: 0.85rem; color:#333; }
  .srri-icon { font-size: 0.7rem; vertical-align: middle; margin-left: 6px; }
  /* Override base .card i selector that makes icons large */
  .card .srri-icon { font-size: 0.7rem !important; margin-bottom: 0 !important; }
  .valo-positive { color: #28a745; }
  .valo-negative { color: #c0392b; }
  table i.fa-solid { font-size: 0.9rem !important; }
  .center { text-align: center; }
  /* SRRI colored dots */
  .srri-dot { display:inline-block; width: 1em; height: 1em; border-radius: 50%; vertical-align: middle; }
  .srri-red { background:#ef4444; }
  .srri-green { background:#16a34a; }
  .srri-blue { background:#3b82f6; }
  .valo-dot { display:inline-block; width:0.6rem; height:0.6rem; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .valo-up { background:#16a34a; }
  .valo-down { background:#dc2626; }
  .valo-neutral { background:#cbd5f5; }
  .nav-dot { display:inline-block; width:0.55rem; height:0.55rem; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .nav-green { background:#16a34a; }
  .nav-red { background:#dc2626; }
  .nav-neutral { background:#cbd5f5; }
  /* Bouton Voir compact */
  /* Réduire la marge haute du bloc contrats */
  #invSection { padding-top: 8px; }
  #invSection h3 { margin: 4px 0 8px; }
  #invSection table { margin-top: 0; }
  /* Réduire la largeur du sélecteur de date à la taille d'une date */
  #asOfSelect { width: 12ch; min-width: 12ch; }
  .kpi-mini { font-size: 0.85rem; color: #333; line-height: 1.2; }
  .kpi-line { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:4px; }
  .kpi-line:first-of-type { margin-top:6px; }
  .kpi-line .kv {
    font-weight:600;
    text-align:right;
    margin-left:auto;
    display:inline-flex;
    align-items:center;
    gap:6px;
    justify-content:flex-end;
  }
  /* Neutralize big button style from base for table links */
  .card table a, #contractsTable a { 
    display: inline !important; 
    background: transparent !important; 
    padding: 0 !important; 
    margin: 0 !important; 
    color: var(--primary) !important; 
    font-weight: normal !important; 
    border-radius: 0 !important; 
    text-decoration: none;
  }
  .card table a:hover, #contractsTable a:hover { text-decoration: underline; }
  /* Supports consolidés table */
  #supportsClient { table-layout: fixed; margin-top: 10px; }
  #supportsClient th:nth-child(1), #supportsClient td:nth-child(1) { width: 14%; }
  #supportsClient th:nth-child(2), #supportsClient td:nth-child(2) { width: 22%; overflow: hidden; text-overflow: ellipsis; }
  #supportsClient th:nth-child(3), #supportsClient td:nth-child(3) { width: 6%; text-align:center; }
  #supportsClient th:nth-child(4), #supportsClient td:nth-child(4) { width: 10%; text-align:right; }
  #supportsClient th:nth-child(5), #supportsClient td:nth-child(5) { width: 9%; text-align:right; }
  #supportsClient th:nth-child(6), #supportsClient td:nth-child(6) { width: 11%; text-align:right; }
  #supportsClient th:nth-child(7), #supportsClient td:nth-child(7) { width: 12%; text-align:right; }
  #supportsClient th:nth-child(8), #supportsClient td:nth-child(8) { width: 4%; text-align:center; }
  #supportsClient th:nth-child(9), #supportsClient td:nth-child(9) { width: 4%; text-align:center; }
  #supportsClient th:nth-child(10), #supportsClient td:nth-child(10) { width: 4%; text-align:center; }
  #supportContractsTable th, #supportContractsTable td { padding:10px 12px; border-bottom:1px solid #e2e8f0; }
  #supportContractsTable th { background:#1d4ed8; color:#fff; text-transform:none; font-size:0.87rem; }
  #supportContractsTable tr:nth-child(even) td { background:#f8fafc; }
  #supportMovementsTable th, #supportMovementsTable td { padding:10px 12px; border-bottom:1px solid #e2e8f0; }
  #supportMovementsTable th { background:#1d4ed8; color:#fff; text-transform:none; font-size:0.87rem; }
  #supportMovementsTable tr:nth-child(even) td { background:#f8fafc; }
  /* Charts block (embedded inside a card → keep it light) */
  .pie-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; align-items: stretch; }
  .pie-card { background: transparent; border-radius: 0; padding: 0; box-shadow: none; display:flex; flex-direction:column; }
  .pie-card canvas { flex:1 1 auto; height: 220px !important; }
  .pie-card .chart-title { margin: 0 0 6px 0; font-size: 0.95rem; }
  .dim-btn { padding:4px 8px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa; cursor:pointer; font-size:12px; }
  .dim-btn.active { background: var(--primary); color:#fff; border-color: var(--primary); }
  .support-contract-link { color:#000 !important; text-decoration:underline; }
  .support-contract-link:hover { text-decoration:none; }
  .support-movement-link { color:#111827; text-decoration:underline; }
  .support-movement-link:hover { text-decoration:none; }
  /* Boutons de période */
  .rangeBtn { padding:4px 8px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa; cursor:pointer; font-size:12px; margin-right:4px; }
  .rangeBtn:hover { background:#eef1ff; border-color:#bbb; }
  /* Contrats / Supports – ligne & typo harmonisées */
  #contractsTable,
  #supportsClient {
    font-family: var(--font-sans, "Inter", "Segoe UI", sans-serif);
    font-size: 0.92rem;
  }
  #contractsTable th, #contractsTable td,
  #supportsClient th, #supportsClient td {
    padding: 6px 10px;
    line-height: 1.35;
    vertical-align: middle;
    margin: 0;
  }
  /* Contrats table */
  #contractsTable { border-collapse: collapse; }
  #contractsTable .badge-closed { padding: 1px 6px; font-size: 10px; }
  /* Tableau allocations (Simulation financière) – lignes compactes */
  #simuAllocTable { font-size: 12px; }
  #simuAllocTable th, #simuAllocTable td { padding: 3px 6px; }
  /* ESG matrix */
  .esg-matrix-card { border:1px solid #e5e7eb; background:#f8fafc; }
  .esg-matrix-header { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .esg-pill-row { display:flex; gap:8px; flex-wrap:wrap; }
  .esg-pill { padding:6px 10px; border:1px solid #cbd5f5; border-radius:999px; background:#fff; cursor:pointer; font-size:0.88rem; transition:background .15s ease, border-color .15s ease; }
  .esg-pill.active { background:var(--primary); color:#fff; border-color:var(--primary); }
  .esg-matrix-table { width:100%; border-collapse:collapse; margin-top:8px; }
  .esg-matrix-table th, .esg-matrix-table td { padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:left; font-size:0.92rem; }
  .esg-matrix-table th { background:#eef2ff; font-weight:600; color:#0f172a; }
  .esg-val { text-align:right; font-variant-numeric:tabular-nums; }
  .esg-delta-pos { color:#15803d; font-weight:600; }
  .esg-delta-neg { color:#b91c1c; font-weight:600; }
  .esg-delta-neutral { color:#4b5563; }
  #esgMatrixExclusions h5,
  #esgMatrixIndicateurs h5 {
    background: #fff;
    color: #0f172a;
    padding: 6px 10px;
    border-radius: 8px;
    display: inline-block;
    border: 1px solid #e5e7eb;
  }
  .esg-matrix-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .esg-matrix-item {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #fff;
    padding: 10px 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    flex: 1 1 calc(33.333% - 10px);
    max-width: calc(33.333% - 10px);
    min-width: 240px;
    box-sizing: border-box;
  }
  /* ESG blocs (sensibilité / exclusions / indicateurs) */
  .esg-blocks { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; margin-top:12px; }
  .esg-block { border:1px solid #e5e7eb; border-radius:10px; background:#fff; padding:10px 12px; box-shadow:0 6px 16px rgba(0,0,0,0.04); }
  .esg-block h4 { margin:0 0 8px 0; display:flex; align-items:center; gap:6px; font-size:1rem; }
  .esg-block .tag-list { display:flex; gap:6px; flex-wrap:wrap; margin:4px 0 8px; }
  .esg-block .tag { padding:4px 8px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; font-size:0.85rem; }
  .esg-block .empty { color:#6b7280; font-size:0.9rem; font-style:italic; }
  /* RBAC UI hides */
  body[data-user-role="client"] .client-hide { display: none !important; }
  body[data-user-role="client"] .client-readonly { pointer-events: none !important; opacity: 0.5; }
  body[data-user-role="back_office"] .backoffice-hide { display: none !important; }
  /* Alignements d'en-têtes */
  #contractsTable thead th:nth-child(2),
  #contractsTable thead th:nth-child(3) { text-align: center; }
  #contractsTable thead th:nth-child(4),
  #contractsTable thead th:nth-child(5),
  #contractsTable thead th:nth-child(6) { text-align: right; }
  /* Priorisation des largeurs: Contrat, Date, Montant */
  #contractsTable thead th:nth-child(1) { width: 28%; }
  #contractsTable thead th:nth-child(2) { width: 8%; }
  #contractsTable thead th:nth-child(3) { width: 15%; }
  #contractsTable thead th:nth-child(4) { width: 14%; }
  #contractsTable thead th:nth-child(5) { width: 14%; }
  #contractsTable thead th:nth-child(6) { width: 14%; }
  /* Accordions */
  .accordion-toggle { display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; border-left:4px solid var(--primary); cursor:pointer; background:#f5f7ff; color:#1f2b6c; border:1px solid rgba(36,86,166,0.18); border-radius:10px; padding:10px 14px; transition:background .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease; }
  .accordion-toggle .chevron { display:inline-block; margin-left:8px; transition: transform .2s ease, color .2s ease; font-size: 1rem; }
  .accordion-toggle.collapsed .chevron { transform: rotate(-90deg); }
  .accordion-toggle:not(.collapsed) { background: var(--primary); color:#fff; border-color: var(--primary); box-shadow:0 10px 22px rgba(36,86,166,0.28); }
  .accordion-toggle:not(.collapsed) .chevron,
  .accordion-toggle:not(.collapsed) i,
  .accordion-toggle:not(.collapsed) span { color:#fff; }
  /* Barre sous-menu indépendante (fond/bordure transparents) */
  .section-toggle-row {
    display:flex;
    justify-content:flex-start;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    overflow-x:auto;
    padding:8px 0 10px;
    margin:8px 0 10px;
    width:100%;
    box-sizing:border-box;
  }
  .section-toggle-row .accordion-toggle {
    flex:0 0 auto;
    min-width:0;
    white-space:normal;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    background: transparent !important;
    border: 1px solid transparent !important;
    box-shadow: none !important;
    color: var(--text) !important;
    padding: 6px 8px;
    border-radius: 10px;
  }
  .section-toggle-row .accordion-toggle h3 {
    font-size:0.95rem;
    line-height:1.2;
    margin:0;
    color: inherit;
  }
  .section-toggle-row .chevron { display:none; }
  .section-toggle-row .accordion-toggle i,
  .section-toggle-row .accordion-toggle span { color: inherit !important; }
  .section-toggle-row .accordion-toggle.active {
    color: var(--primary-600) !important;
    background: var(--primary-100) !important;
    border-color: transparent !important;
  }
  .section-toggle-row .accordion-toggle.active i,
  .section-toggle-row .accordion-toggle.active span,
  .section-toggle-row .accordion-toggle.active h3 { color: var(--primary-600) !important; }
  #confToggleDetail:not(.collapsed) .chevron,
  #clientTasksToggle:not(.collapsed) .chevron,
  #confToggleDetail:not(.collapsed) i,
  #clientTasksToggle:not(.collapsed) i,
  #confToggleDetail:not(.collapsed) span,
  #clientTasksToggle:not(.collapsed) span {
    color:inherit !important;
  }
  #confToggleDetail:not(.collapsed) *,
  #clientTasksToggle:not(.collapsed) * {
    color:inherit !important;
  }
  .badge-closed { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:600; color:#b00020; background:#ffd6d6; border:1px solid #ffb3b3; vertical-align:middle; white-space:nowrap; }
  .highlight-cle { background: #ffe5e5 !important; }
  /* Boutons pilule type KYC */
  .kyc-main-btn { padding:10px 18px; border-radius:999px; border:1px solid var(--primary); background:var(--primary); color:#fff; font-weight:600; font-size:.95rem; display:inline-flex; align-items:center; justify-content:center; gap:8px; min-width:auto; text-align:center; white-space:nowrap; }
  .kyc-main-btn i { font-size:1rem; color:#fff; }
  /* Bouton Conformité identique aux autres (pilule primaire) */
  /* Menu principal : icônes + libellés pour lisibilité */
  .section-toggle-row button {
    min-width:auto;
    padding:10px 12px;
    gap:8px;
  }
  .section-toggle-row button span {
    display:inline;
    font-weight:600;
  }
  /* aucun style spécifique: utiliser l'apparence standard des autres accordéons */
  .tb-markers-enabled [data-tb-marker] {
    position: relative;
    outline: 2px dashed rgba(5,121,180,0.35);
  }
  .tb-markers-enabled [data-tb-marker]::before {
    content: attr(data-tb-marker);
    position: absolute;
    top: -12px;
    left: 0;
    background: rgba(5,121,180,0.9);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 30;
    pointer-events: none;
    box-shadow: 0 2px 6px rgba(15,23,42,0.2);
  }
</style>

<div id="contactExportModal" aria-hidden="true">
  <div class="modal-card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
      <h3><i class="fa-solid fa-address-card"></i> Export contact</h3>
      <button type="button" id="contactExportClose" class="dim-btn" aria-label="Fermer">✕</button>
    </div>
    <div id="contactExportBody" style="margin-top:8px;">
      <div class="contact-line"><strong>Nom :</strong> <span id="contactName"></span></div>
      <div class="contact-line"><strong>Prénom :</strong> <span id="contactFirstname"></span></div>
      <div class="contact-line"><strong>Téléphone :</strong> <span id="contactPhone"></span></div>
      <div class="contact-line"><strong>Email :</strong> <button type="button" id="contactEmailBtn" class="dim-btn" style="padding:4px 8px;"></button></div>
      <div class="contact-line" style="flex-direction:column; align-items:flex-start;"><strong>Adresses :</strong> <div id="contactAddresses" style="margin-top:4px;"></div></div>
    </div>
    <div class="contact-actions">
      <button type="button" id="contactExportVcf" class="dim-btn"><i class="fa-solid fa-file-arrow-down"></i><span>vCard (Outlook/Mac)</span></button>
      <button type="button" id="contactExportCopy" class="dim-btn"><i class="fa-solid fa-copy"></i><span>Copier</span></button>
    </div>
    <div class="muted" style="font-size:12px; margin-top:8px;">Le fichier vCard est compatible Outlook, Google Contacts et Contacts Mac.</div>
  </div>
</div>
<div id="contactMailModal" aria-hidden="true" style="position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:9999; padding:16px;">
  <div class="modal-card" style="max-width:540px; width:100%; box-shadow:0 18px 42px rgba(0,0,0,0.22); padding:18px 18px 14px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;">
      <h3 style="margin:0; font-size:1.05rem; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-envelope"></i> Envoyer un mail</h3>
      <button type="button" id="contactMailClose" class="dim-btn" aria-label="Fermer">✕</button>
    </div>
    <div class="field">
      <label class="muted" style="font-size:0.85rem;">À</label>
      <input type="email" id="contactMailTo" readonly style="width:100%; padding:8px 10px; border:1px solid #dfe7fb; border-radius:10px; background:#f8fafc;" />
    </div>
    <div class="field">
      <label class="muted" style="font-size:0.85rem;">Objet</label>
      <input type="text" id="contactMailSubject" style="width:100%; padding:8px 10px; border:1px solid #dfe7fb; border-radius:10px;" />
    </div>
    <div class="field">
      <label class="muted" style="font-size:0.85rem;">Message</label>
      <textarea id="contactMailBody" rows="5" style="width:100%; padding:10px; border:1px solid #dfe7fb; border-radius:10px; min-height:140px;"></textarea>
    </div>
    <div class="field" style="padding-top:6px; border-top:1px solid #e5e7eb;">
      <label class="muted" style="font-size:0.85rem;">Pièces jointes (à ajouter dans votre client mail)</label>
      <input type="file" id="contactMailFiles" multiple />
      <div id="contactMailFilesList" class="muted" style="font-size:12px;"></div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
      <button type="button" id="contactMailSend" class="dim-btn" style="background:var(--primary); color:#fff; border-color:var(--primary);"><i class="fa-solid fa-paper-plane"></i><span>Ouvrir dans le client mail</span></button>
    </div>
    <div class="muted" style="font-size:12px; margin-top:8px;">Les pièces jointes doivent être ajoutées manuellement dans votre client mail.</div>
    <div class="muted" style="font-size:12px; margin-top:4px;">Les mails envoyés depuis ici ne sont pas stockés dans vos tâches.</div>
  </div>
</div>

{% set cl_markers_param = tb_markers_param if tb_markers_param is defined else '' %}
{% set cl_markers_suffix = ('&' + cl_markers_param) if cl_markers_param else '' %}
{% set cl_markers_prefix = ('?' + cl_markers_param) if cl_markers_param else '' %}
<div class="tb-page{% if tb_markers_visible %} tb-markers-enabled{% endif %}" data-tb-marker="CL_01">


{% if client %}
  <!-- Actions rapides -->
  {% set _is_client = (_role_hint == 'client') %}
  <div class="section-toggle-row" style="margin-top:6px;">
    {% if not _is_client %}
      <button id="confToggleDetail" class="accordion-toggle client-hide" data-tb-marker="CL_13" type="button" title="Relation client et conformité" aria-label="Relation client et conformité" onclick="setSectionToggleActive('confToggleDetail'); openConfMain();">
        <i class="fa-solid fa-scale-balanced" aria-hidden="true"></i><span>Relation client et conformité</span>
      </button>
    {% endif %}
    {# Création de tâche désactivée (maintenance) #}
    <button id="invToggle" class="accordion-toggle" data-tb-marker="CL_14" type="button" title="Investissements" aria-label="Investissements" onclick="setSectionToggleActive('invToggle');">
      <i class="fa-solid fa-chart-line" aria-hidden="true"></i><span>Investissements</span>
    </button>
    <button id="esgToggleClient" class="accordion-toggle" type="button" title="ESG" aria-label="ESG" onclick="setSectionToggleActive('esgToggleClient');">
      <i class="fa-solid fa-leaf" aria-hidden="true"></i><span>ESG</span>
    </button>
    <button id="graphsToggle" class="accordion-toggle" type="button" title="Graphiques" aria-label="Graphiques" onclick="setSectionToggleActive('graphsToggle');">
      <i class="fa-solid fa-chart-pie" aria-hidden="true"></i><span>Graphiques</span>
    </button>
    <button id="reportToggle" class="accordion-toggle" type="button" title="Reportings annuels" aria-label="Reportings annuels" onclick="setSectionToggleActive('reportToggle');">
      <i class="fa-solid fa-file-lines" aria-hidden="true"></i><span>Reportings annuels</span>
    </button>
    {% if not _is_client %}
      <button id="docsToggle" class="accordion-toggle client-hide" data-tb-marker="CL_16" type="button" title="Documents" aria-label="Documents" onclick="setSectionToggleActive('docsToggle');">
        <i class="fa-solid fa-folder-open" aria-hidden="true"></i><span>Documents</span>
      </button>
    {% endif %}
  </div>
  <div id="synthCard" class="card" style="margin-bottom:0.5rem; padding:0;">
    <div id="synthToggle" class="accordion-toggle" data-target="synthPanel" style="margin:0; cursor:pointer; justify-content:center; text-align:center;">
      <h3 style="margin:0;">Synthèse</h3>
    </div>
    <div id="synthPanel" class="accordion-panel" style="display:block; padding:1rem 1.25rem; border-top:1px solid var(--border);">
    <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;">
      {% if msgs_nonreg_count and msgs_nonreg_count > 0 %}
        <button type="button" class="btn client-hide" style="background:transparent; color:#16a34a; border:1px solid transparent; padding:.25rem .5rem; font-size:.85rem; display:inline-flex; align-items:center; gap:6px;" onclick="openClientMsgs('nonreg')" title="Messages en cours">
          <i class="fa-solid fa-triangle-exclamation"></i><span>{{ msgs_nonreg_count }}</span>
        </button>
      {% endif %}
      {% if msgs_reg_count and msgs_reg_count > 0 %}
        <button type="button" class="btn client-hide" style="background:#fff; color:#c62828; border:1px solid transparent; padding:.25rem .5rem; font-size:.85rem; display:inline-flex; align-items:center; gap:6px;" onclick="openClientMsgs('reg')" title="Messages réglementaires">
          <i class="fa-solid fa-triangle-exclamation"></i><span>{{ msgs_reg_count }}</span>
        </button>
      {% endif %}
      {% if client %}
        <button type="button" class="btn client-hide" style="background:#fff; color:var(--text); border:1px solid transparent; padding:.25rem .6rem; font-size:.85rem; display:inline-flex; align-items:center; gap:6px;" onclick="openClientTaskPage()" title="Créer une tâche pour ce client">
          <i class="fa-solid fa-plus"></i><span>Créer une tâche</span>
        </button>
      {% endif %}
      <button type="button" class="btn client-hide" style="background:#fff; color:var(--text); border:1px solid transparent; padding:.25rem .6rem; font-size:.85rem; display:inline-flex; align-items:center; gap:6px;" onclick="openClientAdminGroups()" title="Groupes">
        <i class="fa-solid fa-gear"></i>
      </button>
      <button type="button" class="btn" style="background:#fff; color:var(--text); border:1px solid transparent; padding:.25rem .6rem; font-size:.85rem; display:inline-flex; align-items:center; gap:6px;" onclick="generateClientSynthese()" title="Edition de synthèse">
        <i class="fa-solid fa-file-pdf"></i>
      </button>
    </div>
    <div class="grid" data-tb-marker="CL_02">
      <div class="card" data-tb-marker="CL_03">
        <div class="card-header">Synthèse</div>
        <div class="kpi-small">Contrats ouverts: {{ nb_contrats_ouverts }}</div>
        <div class="kpi-small">Contrats fermés: {{ nb_contrats_fermes }}</div>
        <div class="kpi-small">Durée historique: {{ duree_historique_str }}</div>
        {% set selected_rh_id = client.commercial_id if client and client.commercial_id is not none else None %}
        <div class="kpi-mini kpi-line">
          <span>Responsable</span>
          <span class="kv">
            <form method="post" action="/dashboard/clients/{{ client.id }}/commercial" id="commercialForm" style="display:inline;">
              {% if cl_markers_param %}<input type="hidden" name="markers" value="1" />{% endif %}
              <span style="display:inline-flex; align-items:center; gap:8px;">
                <select id="commercialSelect" name="commercial_id" onchange="this.form.submit()" style="min-width:220px;">
                  <option value="">— Aucun —</option>
                  {% for rh in rh_list %}
                    <option value="{{ rh.id }}" {% if client and client.commercial_id is not none and (client.commercial_id|int) == (rh.id|int) %}selected{% endif %}>{{ rh.prenom }} {{ rh.nom }}</option>
                  {% endfor %}
                </select>
              </span>
            </form>
          </span>
        </div>
        <div class="kpi-mini kpi-line">
          <span>Société (gestion/courtage)</span>
          <span class="kv">
            {% if societe_gestion_nom %}
              {{ societe_gestion_nom }}{% if societe_gestion_role %} — {{ societe_gestion_role }}{% endif %}
            {% else %}
              —
            {% endif %}
          </span>
        </div>
      </div>
      <div class="card" data-tb-marker="CL_04">
        <div class="card-header">Investissements</div>
        <div class="kpi-mini kpi-line"><span>Valorisation</span><span class="kv valo {{ 'valo-positive' if valo_gt_solde else 'valo-negative' }}">{{ last_valo_str }}</span></div>
        <div class="kpi-mini kpi-line"><span>Solde net</span><span class="kv">{{ solde_str }}</span></div>
        <div class="kpi-mini kpi-line"><span>Contrats actifs</span><span class="kv">{{ nb_contrats_ouverts }}</span></div>
        <div class="kpi-mini kpi-line"><span>Supports référencés</span><span class="kv">{{ nb_supports_actifs }}</span></div>
      </div>
      <div class="card" data-tb-marker="CL_05">
        <div class="card-header">Indicateurs</div>
        <div class="kpi-mini kpi-line"><span>Perf 52 semaines</span><span class="kv">{% if last_perf_pct is not none %}{{ '%.2f'|format(last_perf_pct) }} %{% else %}-{% endif %}</span></div>
        <div class="kpi-mini kpi-line"><span>Volatilité</span><span class="kv">{% if last_vol_pct is not none %}{{ '%.2f'|format(last_vol_pct) }} %{% else %}-{% endif %}</span></div>
        {% set srri_icon_class = None %}
        {% if client_srri is not none and current_srri is not none %}
          {% if client_srri > current_srri %}
            {% set srri_icon_class = 'srri-blue' %}
          {% elif client_srri == current_srri %}
            {% set srri_icon_class = 'srri-green' %}
          {% else %}
            {% set srri_icon_class = 'srri-red' %}
          {% endif %}
        {% endif %}
        <div class="kpi-mini kpi-line">
          <span>SRRI client / actuel</span>
          <span class="kv">
            {% if srri_icon_class %}
              <span class="srri-dot {{ srri_icon_class }}" aria-hidden="true"></span>
            {% endif %}
            {{ client_srri if client_srri is not none else '-' }} / {{ current_srri if current_srri is not none else '-' }}
          </span>
        </div>
        <div class="kpi-mini kpi-line" style="align-items:flex-start;">
          <span>SRI (détails)</span>
          <span class="kv">
            <button type="button" class="btn btn-secondary" style="padding:6px 10px;" onclick="openSriModal()">Voir SRI</button>
            <div class="muted" style="font-size:12px; margin-top:4px;">SRI courant : {{ client_sri if client_sri is not none else '—' }}</div>
          </span>
        </div>
        <div class="kpi-mini kpi-line"><span>Perf annualisée (depuis début)</span><span class="kv">{% if overall_ann_perf_pct is not none %}{{ '%.2f'|format(overall_ann_perf_pct) }} %{% else %}-{% endif %}</span></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      function setActive(id){
        document.querySelectorAll('.section-toggle-row .accordion-toggle').forEach(function(btn){
          btn.classList.toggle('active', btn.id === id);
        });
      }
      window.setSectionToggleActive = setActive;
      var defaultBtn = document.querySelector('.section-toggle-row .accordion-toggle');
      if (defaultBtn && defaultBtn.id) {
        setActive(defaultBtn.id);
      }
      document.querySelectorAll('.section-toggle-row .accordion-toggle').forEach(function(btn){
        btn.addEventListener('click', function(){ setActive(btn.id); });
      });
    })();
  </script>
  <style>
    .sri-tip { position:relative; cursor:help; }
    .sri-tip:hover::before {
      content:"";
      position:absolute;
      top:-6px; right:8px;
      border:6px solid transparent;
      border-bottom-color:#1f2937;
      opacity:0.85;
      z-index:40;
    }
    .sri-tip:hover::after {
      content: attr(data-tip);
      position:absolute;
      top:-6px; right:0;
      transform: translateY(-100%);
      background:#1f2937;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      font-size:0.85rem;
      line-height:1.25;
      max-width:280px;
      white-space:normal;
      box-shadow:0 6px 18px rgba(0,0,0,0.18);
      opacity:0.95;
      z-index:39;
    }
    .sri-card {
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      cursor: pointer;
    }
    .sri-card.active {
      transform: scale(1.03);
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      border-color: var(--primary, #4f46e5);
    }
  </style>

  <!-- Modal SRI -->
  <div id="sriModal" class="modal-overlay" onclick="if(event.target===this) closeSriModal()">
    <div class="modal-card" style="width:720px; max-width:95vw;">
      <div class="modal-header">
        <h3 style="display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-shield-halved"></i>Indicateur SRI</h3>
        <button class="modal-close" onclick="closeSriModal()">✕</button>
      </div>
      <div class="modal-body">
        {% set sm = sri_metrics_latest %}
        {% if sm %}
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:0.9rem;">Date de calcul</div>
              <div style="font-weight:700;">{{ sm.as_of_date or '—' }}</div>
              <div class="muted" style="font-size:0.85rem;">Heure serveur : {{ sm.calc_at or '—' }}</div>
            </div>
            <div style="min-width:140px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#f8fafc; text-align:center;">
              <div class="muted" style="font-size:0.9rem;">SRI</div>
              <div style="font-size:1.8rem; font-weight:800; color:#1f2937;">{{ sm.sri if sm.sri is not none else '—' }}</div>
            </div>
          </div>
          <div style="margin-top:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px;">
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="M0 = nombre d'observations sur la période.">M0 (observations)</div><div class="kv">{{ sm.m0 if sm.m0 is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="M1 = moyenne de tous les rendements observés dans l'échantillon.">M1 (moyenne)</div><div class="kv">{{ '%.6f'|format(sm.m1) if sm.m1 is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="M2 = ∑(ri - M1)² / M0 (variance).">M2</div><div class="kv">{{ '%.6f'|format(sm.m2) if sm.m2 is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="M3 = ∑(ri - M1)³ / M0.">M3</div><div class="kv">{{ '%.6f'|format(sm.m3) if sm.m3 is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="M4 = ∑(ri - M1)⁴ / M0.">M4</div><div class="kv">{{ '%.6f'|format(sm.m4) if sm.m4 is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="σ = √(M2) (volatilité).">Sigma</div><div class="kv">{{ '%.6f'|format(sm.sigma) if sm.sigma is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="µ1 = M3 / σ³ (coefficient d'asymétrie).">µ1 (skew)</div><div class="kv">{{ '%.6f'|format(sm.mu1) if sm.mu1 is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="µ2 = (M4 / σ⁴) - 3 (excès de kurtosis).">µ2 (kurtosis)</div><div class="kv">{{ '%.6f'|format(sm.mu2) if sm.mu2 is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="VaR Cornish-Fisher : σ√N(-1,96 + 0,474 µ1/√N - 0,0687 µ2/N + 0,146 µ1²/N) - 0,5 σ² N.">Var CF</div><div class="kv">{{ '%.6f'|format(sm.var_cf) if sm.var_cf is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="VeV = {√(3,842 - 2*VaR) - 1,96} / √(T), T en années (RHP).">VeV</div><div class="kv">{{ '%.6f'|format(sm.vev) if sm.vev is not none else '—' }}</div>
            </div>
            <div class="kpi-mini sri-card" style="padding:10px; border:1px solid var(--border); border-radius:10px;">
              <div class="muted sri-tip" data-tip="Nombre de périodes de négociation durant la RHP (dans l'avenir).">Périodes (n)</div><div class="kv">{{ sm.n_periods if sm.n_periods is not none else '—' }}</div>
            </div>
          </div>
    {% else %}
      <p class="muted">Aucune métrique SRI disponible pour ce client.</p>
      {% if sri_debug %}
        <div class="muted" style="font-size:0.85rem; margin-top:6px;">
          {% for line in sri_debug %}
            <div>• {{ line }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endif %}
      </div>
    </div>
  </div>
  <script>
    function openSriModal(){ var m=document.getElementById('sriModal'); if(m) m.style.display='flex'; }
    function closeSriModal(){ var m=document.getElementById('sriModal'); if(m) m.style.display='none'; }
    (function(){
      var cards = document.querySelectorAll('#sriModal .sri-card');
      cards.forEach(function(card){
        card.addEventListener('click', function(){
          card.classList.toggle('active');
        });
      });
    })();
  </script>


  

<!-- Modale Administration Groupes (Client) -->
<style>
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items: center; justify-content: center; z-index: 9999; }
  .modal-card { background: #fff; border-radius: 12px; width: 780px; max-width: 95vw; max-height: 92vh; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .modal-header h3 { margin: 0; font-size: 1.05rem; }
  .modal-body { padding: 12px 14px; }
  .modal-close { border:none; background: transparent; cursor: pointer; font-size: 18px; }
</style>
<div id="clientAdminGroupsModal" class="modal-overlay" onclick="if(event.target===this) document.getElementById('clientAdminGroupsModal').style.display='none'">
  <div class="modal-card">
    <div class="modal-header">
      <h3><i class="fa-solid fa-user-gear" style="margin-right:8px;"></i>Groupes du client</h3>
      <button class="modal-close" onclick="document.getElementById('clientAdminGroupsModal').style.display='none'">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="field">
          <label>Ajouter le client à un groupe</label>
          <select id="clientGroupsSelect"></select>
          <div id="clientGroupsNotice" class="muted" style="margin-top:6px; display:none;"></div>
        </div>
        <div class="field" style="align-self:end;">
          <button class="btn btn-primary" onclick="addClientGroup()"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>Ajouter</button>
        </div>
      </div>
      <table id="clientGroupsTable">
        <thead>
          <tr>
            <th>Groupe</th>
            <th>Actif</th>
            <th>Ajout</th>
            <th>Retrait</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
const CLIENT_ID = {{ client.id if client else 'null' }};

  // Export contact (vCard / copie)
  (function(){
    const openBtn = document.getElementById('contactExportBtn');
    const modal = document.getElementById('contactExportModal');
    const closeBtn = document.getElementById('contactExportClose');
    const vcfBtn = document.getElementById('contactExportVcf');
    const copyBtn = document.getElementById('contactExportCopy');
    const mailBtn = document.getElementById('contactEmailBtn');
    const mailModal = document.getElementById('contactMailModal');
    const mailClose = document.getElementById('contactMailClose');
    const mailTo = document.getElementById('contactMailTo');
    const mailSubject = document.getElementById('contactMailSubject');
    const mailBody = document.getElementById('contactMailBody');
    const mailFiles = document.getElementById('contactMailFiles');
    const mailFilesList = document.getElementById('contactMailFilesList');
    const mailSend = document.getElementById('contactMailSend');
    if (!openBtn || !modal) return;
    const data = {
      first: `{{ client.prenom or '' }}`.trim(),
      last: `{{ client.nom or '' }}`.trim(),
      phone: `{{ client.telephone or '' }}`.trim(),
      email: `{{ client.email or '' }}`.trim(),
      addr: ``,
      addrs: []
    };
    async function hydrateAddresses(rawInput){
      const raw = rawInput != null ? rawInput : {{ kyc_adresses|default([], true)|tojson }};
      const norm = (raw || []).map(function(a){
        if (!a) return null;
        const parts = [a.rue, a.complement, a.code_postal, a.ville, a.pays].map(function(x){ return (x||'').trim(); }).filter(Boolean);
        if (!parts.length) return null;
        return {
          label: (a.type_libelle || '').trim(),
          street: (a.rue || '').trim(),
          complement: (a.complement || '').trim(),
          postal: (a.code_postal || '').trim(),
          city: (a.ville || '').trim(),
          country: (a.pays || '').trim(),
          display: parts.join(' '),
          is_primary: !!a.is_primary
        };
      }).filter(Boolean);
      data.addrs = norm;
      const primary = norm.find(a=>a.is_primary) || norm[0];
      data.addr = primary ? primary.display : '';
    }
    hydrateAddresses();
    async function fetchAddressesIfEmpty(){
      if (data.addrs && data.addrs.length) return;
      try {
        const res = await fetch(`/dashboard/clients/${CLIENT_ID}/addresses`);
        if (!res.ok) return;
        const payload = await res.json();
        await hydrateAddresses(payload && payload.addresses ? payload.addresses : []);
      } catch(_err){
        /* ignore fetch errors */
      }
    }
    function setText(id, val){
      const el = document.getElementById(id);
      if (el) el.textContent = val || '—';
    }
    function vcard(){
      const lines = [
        'BEGIN:VCARD',
        'VERSION:3.0',
        `N:${data.last};${data.first};;;`,
        `FN:${[data.first, data.last].filter(Boolean).join(' ')}`,
      ];
      if (data.phone) lines.push(`TEL;TYPE=CELL,VOICE:${data.phone}`);
      if (data.email) lines.push(`EMAIL;TYPE=INTERNET:${data.email}`);
      if (data.addrs && data.addrs.length){
        data.addrs.forEach(function(a){
          const street = [a.street, a.complement].filter(Boolean).join(' ').trim();
          const type = (a.label || 'HOME').toUpperCase();
          lines.push(`ADR;TYPE=${type}:;;${street};${a.city};;${a.postal};${a.country}`);
        });
      } else if (data.addr){
        lines.push(`ADR;TYPE=HOME:;;${data.addr};;;;`);
      }
      lines.push('END:VCARD');
      return lines.join('\r\n') + '\r\n';
    }
    async function openModal(){
      await fetchAddressesIfEmpty();
      setText('contactName', data.last || '—');
      setText('contactFirstname', data.first || '—');
      setText('contactPhone', data.phone || '—');
      if (mailBtn){
        mailBtn.textContent = data.email || '—';
        mailBtn.disabled = !data.email;
      }
      const addrEl = document.getElementById('contactAddresses');
      if (addrEl){
        if (data.addrs && data.addrs.length){
          addrEl.innerHTML = data.addrs.map(function(a){
            const lbl = a.label ? ('<strong>'+a.label+':</strong> ') : '';
            return '<div>'+lbl+ (a.display || '—') +'</div>';
          }).join('');
        } else {
          addrEl.textContent = data.addr || '—';
        }
      }
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
    }
    function closeModal(){
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }
    openBtn.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e){ if (e.target === modal) closeModal(); });
    function downloadVcf(filename){
      const blob = new Blob([vcard()], { type:'text/vcard;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){ URL.revokeObjectURL(url); document.body.removeChild(a); }, 200);
    }
    if (vcfBtn) vcfBtn.addEventListener('click', function(){
      const base = [data.first, data.last].filter(Boolean).join('_') || 'contact';
      downloadVcf(`${base}.vcf`);
    });
    if (copyBtn) copyBtn.addEventListener('click', function(){
      const addrLines = (data.addrs && data.addrs.length) ? data.addrs.map(a=> (a.label ? (a.label+': ') : '') + (a.display||'')).filter(Boolean) : (data.addr ? [data.addr] : []);
      const txt = [
        [data.first, data.last].filter(Boolean).join(' ').trim(),
        data.phone,
        data.email
      ].concat(addrLines).filter(Boolean).join('\\n');
      if (navigator.clipboard && txt){
        navigator.clipboard.writeText(txt).catch(function(){});
      }
    });
    function openMailModal(){
      if (!mailModal) return;
      if (mailTo) mailTo.value = data.email || '';
      if (mailSubject) mailSubject.value = `Contact ${[data.first, data.last].filter(Boolean).join(' ')}`.trim();
      if (mailBody) mailBody.value = '';
      if (mailFiles) mailFiles.value = '';
      if (mailFilesList) mailFilesList.textContent = '';
      mailModal.style.display = 'flex';
      mailModal.setAttribute('aria-hidden', 'false');
    }
    function closeMailModal(){
      if (!mailModal) return;
      mailModal.style.display = 'none';
      mailModal.setAttribute('aria-hidden', 'true');
    }
    if (mailBtn) mailBtn.addEventListener('click', function(e){ e.preventDefault(); openMailModal(); });
    if (mailClose) mailClose.addEventListener('click', closeMailModal);
    if (mailModal) mailModal.addEventListener('click', function(e){ if (e.target === mailModal) closeMailModal(); });
    if (mailFiles && mailFilesList){
      mailFiles.addEventListener('change', function(){
        const names = Array.from(mailFiles.files || []).map(f=> f.name);
        mailFilesList.textContent = names.length ? 'Pièces à joindre dans votre mail : ' + names.join(', ') : '';
      });
    }
    function mailtoUrl(){
      const to = data.email || '';
      const subj = encodeURIComponent((mailSubject && mailSubject.value) || '');
      const body = encodeURIComponent((mailBody && mailBody.value) || '');
      return `mailto:${encodeURIComponent(to)}?subject=${subj}&body=${body}`;
    }
    if (mailSend){
      mailSend.addEventListener('click', function(){
        if (!data.email) return;
        const url = mailtoUrl();
        window.location.href = url;
        closeMailModal();
      });
    }
  })();
const CL_MARKERS_PARAM = "{{ cl_markers_param }}";
const CL_MARKERS_SUFFIX = "{{ cl_markers_suffix }}";
function appendMarkers(url){
  if (!CL_MARKERS_PARAM) return url;
  if (url.indexOf('markers=') !== -1) return url;
  return url + (url.indexOf('?') >= 0 ? '&' : '?') + CL_MARKERS_PARAM;
}
function applyMarkersToParams(params){
  if (!params) return;
  if (CL_MARKERS_PARAM) {
    params.set('markers', '1');
  } else {
    params.delete('markers');
  }
}
let clientGroupDetails = [];
let clientGroupLinks = [];
function openClientAdminGroups(){
  const el = document.getElementById('clientAdminGroupsModal');
  el.style.display = 'flex';
  console.log('[Admin][Client] open modal for client_id=', CLIENT_ID);
  loadClientGroups();
}
function openClientTaskPage(){
  if (!CLIENT_ID){
    alert('Client introuvable.');
    return;
  }
  var params = new URLSearchParams();
  var fullname = '{{ (client.nom or "") ~ " " ~ (client.prenom or "") if client else "" }}'.trim();
  if (fullname) params.set('client_fullname', fullname);
  var rhId = '{{ client.commercial_id if client and client.commercial_id is not none else "" }}';
  if (rhId) params.set('rh_id', rhId);
  if (CL_MARKERS_PARAM){ params.set('markers', '1'); }
  var url = '/dashboard/taches' + (params.toString() ? ('?' + params.toString()) : '');
  window.open(url, '_blank', 'noopener');
}

function generateClientSynthese(){
  if (!CLIENT_ID){
    alert('Client introuvable.');
    return;
  }
  if (typeof window.showGlobalLoader === 'function'){
    window.showGlobalLoader('Génération du PDF…');
  }
  const url = '/dashboard/api/synthese?id_client=' + encodeURIComponent(CLIENT_ID);
  window.open(url, '_blank', 'noopener');
  const clearLoader = function(){
    if (typeof window.hideGlobalLoader === 'function'){
      window.hideGlobalLoader();
    }
    window.removeEventListener('focus', clearLoader);
  };
  window.addEventListener('focus', clearLoader);
  setTimeout(clearLoader, 4000);
}
    async function loadClientGroups(){
      const notice = document.getElementById('clientGroupsNotice');
      if (notice) { notice.style.display = 'none'; notice.textContent = ''; }
      try {
        let detailsRes = await fetch('/api/groupes/details?type=client&actifs_only=true');
        console.log('[Admin][Client] fetch details (active) → status', detailsRes.status);
        clientGroupDetails = detailsRes.ok ? await detailsRes.json() : [];
        console.log('[Admin][Client] details (active) payload:', clientGroupDetails);
        if (!Array.isArray(clientGroupDetails) || clientGroupDetails.length === 0){
          console.warn('[Admin][Client] no active groups, retry including inactive');
          const r2 = await fetch('/api/groupes/details?type=client&actifs_only=false');
          console.log('[Admin][Client] fetch details (all) → status', r2.status);
          if (r2.ok) clientGroupDetails = await r2.json();
          console.log('[Admin][Client] details (all) payload:', clientGroupDetails);
        }
        const linksRes = await fetch('/api/groupes/memberships?client_id=' + encodeURIComponent(CLIENT_ID));
        console.log('[Admin][Client] fetch memberships → status', linksRes.status);
        clientGroupLinks = linksRes.ok ? await linksRes.json() : [];
        console.log('[Admin][Client] memberships payload:', clientGroupLinks);
        renderClientGroupSelect();
        renderClientGroupsTable();
      } catch (e) {
        console.error('[Admin][Client] loadClientGroups error:', e);
        if (notice) { notice.style.display = 'block'; notice.textContent = 'Erreur de chargement des groupes.'; }
      }
    }
    function renderClientGroupSelect(){
      const sel = document.getElementById('clientGroupsSelect');
      sel.innerHTML = '';
      const notice = document.getElementById('clientGroupsNotice');
      if (!Array.isArray(clientGroupDetails) || clientGroupDetails.length === 0){
        const opt = document.createElement('option'); opt.value=''; opt.textContent='Aucun groupe Personnes'; sel.appendChild(opt);
        if (notice) { notice.style.display = 'block'; notice.textContent = 'Aucun groupe Personnes trouvé. Allez dans Administration > Groupes pour en créer.'; }
        return;
      }
      if (notice) { notice.style.display = 'none'; notice.textContent = ''; }
      clientGroupDetails.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id; opt.textContent = g.nom + (g.actif===0?' (inactif)':'');
        sel.appendChild(opt);
      });
    }
    function renderClientGroupsTable(){
      const body = document.querySelector('#clientGroupsTable tbody');
      body.innerHTML = '';
      const nameById = Object.fromEntries(clientGroupDetails.map(g => [g.id, g.nom]));
      (clientGroupLinks||[]).forEach(link => {
        const tr = document.createElement('tr');
        const tdNom = document.createElement('td'); tdNom.textContent = nameById[link.groupe_id] || ('#'+link.groupe_id);
        const tdActif = document.createElement('td'); tdActif.textContent = (link.actif===1 || link.actif===null)?'Oui':'Non';
        const tdAj = document.createElement('td'); tdAj.className='js-local-dt'; tdAj.setAttribute('data-iso', link.date_ajout || '');
        const tdRt = document.createElement('td'); tdRt.className='js-local-dt'; tdRt.setAttribute('data-iso', link.date_retrait || '');
        const tdAct = document.createElement('td');
        const btn = document.createElement('button'); btn.className = 'btn btn-danger'; btn.textContent = 'Retirer'; btn.onclick = () => removeClientGroup(link.id);
        tdAct.appendChild(btn);
        tr.appendChild(tdNom); tr.appendChild(tdActif); tr.appendChild(tdAj); tr.appendChild(tdRt); tr.appendChild(tdAct);
        body.appendChild(tr);
      });
      // trigger client-side date localization
      try { (function(){
        var nodes = document.querySelectorAll('#clientGroupsTable .js-local-dt');
        nodes.forEach(function (el) {
          var iso = el.getAttribute('data-iso') || (el.textContent || '').trim();
          if (!iso) { el.textContent=''; return; }
          var s = iso;
          if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}(?::\d{2})?)?$/.test(s)) {
            s = s.replace(' ', 'T') + 'Z';
          }
          var d = new Date(s);
          if (isNaN(d)) { el.textContent = iso; return; }
          try { el.textContent = d.toLocaleString('fr-FR', { timeZone: 'Europe/Paris' }); }
          catch(e){ el.textContent = d.toLocaleString(); }
        });
      })(); } catch(e){}
    }
    async function addClientGroup(){
      const sel = document.getElementById('clientGroupsSelect');
      const gid = parseInt(sel.value, 10);
      if (!gid || !CLIENT_ID) return;
      try {
        await fetch('/api/groupes/memberships', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupe_id: gid, client_id: CLIENT_ID })
        });
        await loadClientGroups();
      } catch (e) { console.error(e); }
    }
    async function removeClientGroup(linkId){
      if (!linkId) return;
      try {
        await fetch('/api/groupes/memberships/' + linkId, { method: 'DELETE' });
        await loadClientGroups();
      } catch (e) { console.error(e); }
    }
  </script>
</div>


<!-- Modale dédiée: Lettre de Mission -->
<div class="modal-overlay" id="confMissionDetailModal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" style="width:760px; max-width:96vw;">
      <div class="modal-header">
        <h3><i class="fa-solid fa-file-contract" style="margin-right:8px;"></i>Lettre de Mission</h3>
        <button type="button" class="btn btn-compact" style="margin-right:8px;" onclick="generateMissionPdf()">
          <i class="fa-solid fa-file-pdf" style="margin-right:6px;"></i>Génération PDF
        </button>
        <button class="modal-close" onclick="document.getElementById('confMissionDetailModal').style.display='none'">✕</button>
      </div>
      <div class="modal-body">
        <style>
          .lm h2 { font-size: 1.2rem; margin: 0 0 8px; }
          .lm h3 { font-size: 1.05rem; margin: 14px 0 6px; }
          .lm p { margin: 6px 0; }
          .lm ul { margin: 6px 0 6px 18px; }
          .lm hr { border: 0; border-top: 1px solid var(--border); margin: 10px 0; }
          .lm .muted { color: var(--muted); }
          .lm-objectifs-table { width: 100%; border-collapse: collapse; margin: 8px 0; }
          .lm-objectifs-table th, .lm-objectifs-table td { border: 1px solid var(--border); padding: 6px 8px; font-size: 0.9rem; }
          .lm-objectifs-table th { background: var(--primary); color: #fff; text-align: left; }
          .lm-objectifs-table td.number { text-align: right; white-space: nowrap; }
          .lm-objectifs-table td.comment { max-width: 280px; }
        </style>
        <div class="lm">
          <h2><strong>LETTRE DE MISSION</strong></h2>
          <hr />

          <h3><strong>Préambule</strong></h3>
          <p>Vous avez bien voulu nous consulter en qualité de <strong>courtier en assurance-vie</strong>, et nous vous remercions de votre confiance.</p>
          <p>Lors d’un précédent entretien, nous vous avons remis le <strong>Document d’Entrée en Relation (DER)</strong> conformément à l’article <strong>L.521-2 du Code des assurances</strong>.<br/>
          La présente lettre de mission a pour objet de <strong>définir et de formaliser les conditions et modalités</strong> de notre intervention dans le cadre de votre accompagnement patrimonial.</p>

          <hr />
          <h3><strong>A. Objectifs de la mission</strong></h3>
          <p>Lors de notre entretien du <strong>{{ lm_entretien_date or 'À préciser' }}</strong>, vous avez exprimé les axes de réflexion prioritaires au regard de vos objectifs patrimoniaux.</p>
          <p>Les objectifs patrimoniaux et financiers exprimés lors du <strong>recueil d’informations client</strong> constituent la base de notre mission de conseil.</p>
          <p>Vous avez manifesté le souhait d’investir <strong>{{ lm_total_invest_str }}</strong> euros, avec pour objectif(s) :</p>
          {% if lm_objectifs %}
          <table class="lm-objectifs-table">
            <thead>
              <tr>
                <th>Objectif</th>
                <th>Montant</th>
                <th>Horizon</th>
                <th>Commentaire</th>
              </tr>
            </thead>
            <tbody>
              {% for obj in lm_objectifs %}
              <tr>
                <td>{{ obj.libelle or '—' }}</td>
                <td class="number">{{ obj.montant_str }} €</td>
                <td>{{ obj.horizon or '—' }}</td>
                <td class="comment">{{ obj.commentaire or '—' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <p><em>Aucun objectif déclaré à ce jour.</em></p>
          {% endif %}
          <p>Toute modification ultérieure devra nous être communiquée afin d’ajuster nos recommandations.</p>

          <hr />
          <h3><strong>B. Missions confiées</strong></h3>
          <h4>1. Mise en relation avec les compagnies d’assurance</h4>
          <p class="muted">Intermédiation au sens de l’article <strong>L.511-1 du Code des assurances</strong>.</p>
          <h4>2. Présentation et explication des produits d’assurance-vie</h4>
          <p class="muted">Informations claires et exactes sur les produits, avant toute recommandation personnalisée.</p>
          <h4>3. Collecte d’informations</h4>
          <p class="muted">Recueil des données nécessaires à l’analyse de votre situation conformément à la <strong>Directive DDA (UE) 2016/97</strong> et au <strong>devoir de connaissance du client</strong> (articles L.541-8-1 et suivants du Code monétaire et financier).</p>
          <h4>4. Transmission de la documentation contractuelle</h4>
          <p class="muted">Conditions générales, DIC (PRIIPs), fiches IPID et tout document précontractuel requis.</p>
          <h4>5. Suivi administratif et contractuel</h4>
          <p class="muted">Gestion des opérations de souscription, rachats, arbitrages, avenants et conservation des documents.</p>
          <h4>6. Obligations de vigilance et conformité</h4>
          <p class="muted">Application des dispositifs <strong>LCB-FT</strong>, <strong>RGPD</strong> et <strong>DDA</strong>, incluant la vérification d’identité et la collecte de justificatifs.</p>

          <hr />
          <h3><strong>C. Références légales</strong></h3>
          <ul>
            <li><strong>Code des assurances</strong> : Articles <strong>L.511-1 à L.511-3</strong></li>
            <li><strong>Code monétaire et financier</strong> : Article <strong>L.541-1</strong></li>
            <li><strong>Directive (UE) 2016/97</strong> dite <strong>DDA</strong></li>
            <li><strong>Directive (UE) 2014/65</strong> dite <strong>MIF 2</strong></li>
          </ul>
          <p>Un questionnaire de détermination du profil investisseur a été complété.</p>
          {% if risque_latest and risque_latest.confirmation_client is not none %}
            {% set _conf = (risque_latest.confirmation_client|string).lower() %}
            {% if _conf == 'oui' %}
              <p>Vous avez validé le profil de risque déterminé par le questionnaire.</p>
            {% else %}
              <p>le risque choisi est différent de celui déterminé par le questionnaire, le client reconnaît avoir été informé de cet écart et assume pleinement la responsabilité de ce choix.</p>
            {% endif %}
          {% endif %}

          <hr />
          <h3><strong>D. Déroulement de la mission</strong></h3>
          <ol>
            <li>Remise du <strong>Document d’Entrée en Relation</strong>, signé le {{ lm_today }}.</li>
            <li>Signature du <strong>recueil d’informations patrimoniales</strong>, le {{ lm_today }}.</li>
            <li>Signature électronique de la <strong>présente lettre de mission</strong>.</li>
            <li>Élaboration et remise du <strong>rapport d’adéquation</strong> documentant la cohérence des solutions proposées avec vos objectifs.</li>
          </ol>
          <p>La mission débute dès réception des éléments nécessaires à l’analyse complète de votre situation.</p>

          <hr />
          <h3><strong>E. Suivi et révision</strong></h3>
          <p>Un suivi régulier est prévu, comprenant :</p>
          <ul>
            <li>Des <strong>rendez-vous périodiques</strong> selon vos besoins,</li>
            <li>Un <strong>bilan patrimonial</strong> actualisé tous les deux ans,</li>
            <li>Et, le cas échéant, un point intermédiaire sur demande.</li>
          </ul>
          <p>Toute évolution importante de votre situation (revenus, patrimoine, projets, profil de risque) doit être portée à notre connaissance pour mise à jour de votre dossier.</p>

          <hr />
          <h3><strong>F. Durée et dénonciation</strong></h3>
          <p>La mission est conclue pour une durée <strong>d’un an</strong>, renouvelable par tacite reconduction.<br/>
          Elle peut être résiliée à tout moment par simple notification écrite, sous réserve d’un <strong>préavis d’un mois</strong>.</p>

          <hr />
          <h3><strong>G. Communication et supports d’information</strong></h3>
          <p>Le Client accepte la communication d’informations sur <strong>support durable autre que le papier</strong>, via :</p>
          <ul>
            <li>Courriel sécurisé,</li>
            <li>Espace client en ligne,</li>
            <li>Ou courrier postal.</li>
          </ul>
          <p>Les documents resteront consultables et téléchargeables pendant la durée légale requise.</p>

          <hr />
          <h3><strong>H. Coûts et rémunérations</strong></h3>
          {% if lm_remunerations and (lm_remunerations|length > 0) %}
            <ul>
              {% for r in lm_remunerations %}
                {% set mode_label = r.mode or r.type or 'Mode' %}
                {% if mode_label == 'FRAIS_ENTREE' %}
                  {% set mode_label = "Frais d'entrée" %}
                {% elif mode_label == 'FRAIS_GESTION' %}
                  {% set mode_label = "Frais de gestion" %}
                {% endif %}
                <li>
                  <strong>{{ mode_label }} :</strong>
                  {% set has_val = false %}
                  {% if r.montant is not none %}
                    {% set has_val = true %} {{ r.montant }} €
                  {% endif %}
                  {% if r.pourcentage is not none %}
                    {% if has_val %} — {% endif %}{{ r.pourcentage }} %
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">Rémunérations: non renseigné pour ce courtier.</p>
          {% endif %}
          <p>Ces rémunérations couvrent les prestations de conseil, de suivi et d’intermédiation.<br/>
          Un détail complet peut être fourni sur simple demande.</p>

          <hr />
          <h3><strong>I. Droits et obligations réciproques</strong></h3>
          <p>Le Courtier est tenu à une <strong>obligation de moyens</strong> et non de résultat.<br/>
          Le Client s’engage à fournir des informations exactes et à informer le cabinet de toute modification significative de sa situation.</p>
          <p>Le Client autorise le Courtier à obtenir auprès des compagnies d’assurance ou établissements financiers les données nécessaires au suivi de ses contrats.<br/>
          Le Courtier est tenu au <strong>secret professionnel</strong> (article L.519-6 du Code monétaire et financier).</p>

          <hr />
          <h3><strong>J. Protection des données personnelles (RGPD)</strong></h3>
          <p>Les données personnelles sont traitées conformément au <strong>Règlement (UE) 2016/679 (RGPD)</strong> et à la <strong>loi Informatique et Libertés</strong>.<br/>
          Elles sont utilisées pour l’analyse, la souscription et le suivi des contrats d’assurance-vie, et conservées pendant la durée de la relation contractuelle, puis <strong>5 ans</strong> après sa fin.</p>
          <p>Vous disposez des droits d’accès, de rectification, d’effacement, de limitation, de portabilité et d’opposition.<br/>
          Pour les exercer :<br/>
          <strong>{{ DER_courtier.responsable_dpo }} – {{ DER_courtier.courriel }}</strong><br/>
          Vous pouvez également saisir la <strong>CNIL</strong> (www.cnil.fr).</p>

          <hr />
          <h3><strong>K. Droit applicable et litiges</strong></h3>
          <p>La présente lettre de mission est régie par le <strong>droit français</strong>.<br/>
          En cas de désaccord, les parties privilégieront une solution amiable avant toute procédure judiciaire.<br/>
          À défaut, compétence exclusive est donnée aux <strong>juridictions françaises</strong>.</p>

          <hr />
          <h3><strong>L. Réclamations et médiation</strong></h3>
          <p>Toute réclamation peut être adressée à :<br/>
          <strong>Courtage du Centre – Service Réclamations</strong><br/>
          23 rue du quai, 56150 Chatillon sur Saône<br/>
          Email : jc@cc.fr</p>
          <p>En cas d’absence de solution amiable, le Client peut saisir :<br/>
          <strong>{{ centre_mediation_lib or DER_courtier.centre_mediation }}</strong><br/>
          Contact : banqueroute@acpr.fr</p>

          <hr />
          <h3><strong>M. Délai de rétractation (en cas de démarchage)</strong></h3>
          <p>Conformément à l’article <strong>L.341-16 du Code monétaire et financier</strong>,<br/>
          si cette mission résulte d’un <strong>acte de démarchage</strong>, vous disposez d’un <strong>délai de 14 jours calendaires révolus</strong> pour exercer votre droit de rétractation, sans avoir à justifier de motif ni supporter de pénalité.<br/>
          Le délai court à compter de la signature électronique de la présente lettre.</p>

          <hr />
          <h3><strong>Validation et consentement électronique</strong></h3>
          <p>En validant électroniquement cette lettre de mission sur la plateforme sécurisée,<br/>
          <strong>{{ client.prenom }} {{ client.nom }}</strong> reconnaît avoir :</p>
          <ul>
            <li>pris connaissance de l’intégralité du document,</li>
            <li>compris la portée des engagements réciproques,</li>
            <li>et accepté la mission dans les conditions exposées.</li>
          </ul>
          <p>La signature électronique apposée ci-dessous vaut <strong>consentement exprès</strong>, conformément à l’article <strong>1367 du Code civil</strong> et au <strong>Règlement eIDAS (UE) n°910/2014</strong> sur l’identification électronique et les services de confiance.</p>

          <hr />
          <p><strong>Date de signature électronique :</strong> {{ date_signature }}<br/>
          <strong>Identifiant de transaction :</strong> {{ signature_id }}</p>
          <p><strong>Signature électronique du client :</strong> ✍️<br/>
          <strong>Signature électronique du courtier :</strong> ✍️</p>

          <hr />
          <p><strong>{{ DER_courtier.nom_cabinet }}</strong> – Courtier en assurance-vie et produits financiers<br/>
          Immatriculé à l’ORIAS n° {{ DER_courtier.numero_orias }} – Adhérent {{ DER_courtier.association_prof }}</p>
</div>

      </div>
    </div>
  </div>
  <!-- Modale Conformité: 3 boutons pilule -->
  <div class="modal-overlay" id="confMainModal" data-tb-marker="CL_11" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" data-tb-marker="CL_12" style="width:720px; max-width:95vw;">
    <div class="modal-header"><h3>Relation client et conformité</h3><button class="modal-close" onclick="document.getElementById('confMainModal').style.display='none'">✕</button></div>
      <div class="modal-body" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; align-items:start;">
        <div>
          <h4 style="margin:0 0 8px 0; text-align:center;">Gestion</h4>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button type="button" class="kyc-main-btn" style="width:100%;" onclick="closeConfMain(); openConfConnaissanceDetail()"><i class="fa-solid fa-user-check"></i>Connaissance client</button>
          </div>
        </div>
        <div>
          <h4 style="margin:0 0 8px 0; text-align:center;">Éditions</h4>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button type="button" class="kyc-main-btn" style="width:100%;" onclick="closeConfMain(); generateDerPdf();"><i class="fa-solid fa-file-signature"></i>DER</button>
            <button type="button" class="kyc-main-btn" style="width:100%;" onclick="closeConfMain(); generateMissionPdf();"><i class="fa-solid fa-file-contract"></i>Lettre de Mission</button>
            <button type="button" class="kyc-main-btn" style="width:100%;" onclick="closeConfMain(); generateAdequationPdf();"><i class="fa-solid fa-file-circle-check"></i>Lettre d’adéquation</button>
            <button type="button" class="kyc-main-btn" style="width:100%;" onclick="generateClientSynthese()"><i class="fa-solid fa-file-pdf"></i>Edition de synthèse</button>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
  <!-- Modal: Messages/Tâches client (filtré par type réglementaire / non réglementaire) -->
  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-card { background: #fff; border-radius: 12px; width: 780px; max-width: 95vw; max-height: 92vh; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
    .modal-header h3 { margin: 0; font-size: 1.05rem; }
    .modal-body { padding: 12px 14px; }
    .modal-close { border:none; background: transparent; cursor: pointer; font-size: 18px; }
    /* Harmonisation colonnes pop-up Messages */
    #clientMsgsTable { table-layout: fixed; width: 100%; }
    #clientMsgsTable th:nth-child(1), #clientMsgsTable td:nth-child(1) { width: 13%; }
    #clientMsgsTable th:nth-child(2), #clientMsgsTable td:nth-child(2) { width: 15%; }
    #clientMsgsTable th:nth-child(3), #clientMsgsTable td:nth-child(3) { width: 12%; }
    #clientMsgsTable th:nth-child(4), #clientMsgsTable td:nth-child(4) { width: 10%; }
    #clientMsgsTable th:nth-child(5), #clientMsgsTable td:nth-child(5) { width: 12%; }
    #clientMsgsTable th:nth-child(6), #clientMsgsTable td:nth-child(6) { width: 24%; }
    #clientMsgsTable th:nth-child(7), #clientMsgsTable td:nth-child(7) { width: 10%; text-align:center; }
    #clientMsgsTable th:nth-child(8), #clientMsgsTable td:nth-child(8) { width: 10%; text-align:center; }
    #clientMsgsTable th:nth-child(9), #clientMsgsTable td:nth-child(9) { width: 10%; text-align:center; }
    #clientMsgsTable td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #clientMsgsTable td:nth-child(6) { white-space: normal; word-break: break-word; }
  </style>
  <div id="clientMsgsModal" class="modal-overlay" data-tb-marker="CL_09" onclick="if(event.target===this) closeClientMsgs()">
    <div class="modal-card" data-tb-marker="CL_10">
      <div class="modal-header">
        <h3 id="clientMsgsTitle"><i class="fa-solid fa-envelope" style="margin-right:8px;"></i>Messages</h3>
        <button class="modal-close" onclick="closeClientMsgs()">✕</button>
      </div>
      <div class="modal-body">
        <table id="clientMsgsTable">
          <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Catégorie</th>
            <th>Statut</th>
            <th>Contrat</th>
            <th>Commentaire</th>
            <th>ID (row.id)</th>
            <th>ID (evenement_id)</th>
            <th>Action</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>


  <div id="supportContractsModal" class="modal-overlay" onclick="if(event.target===this) closeSupportContractsModal()">
    <div class="modal-card" style="width:980px; max-width:98vw;">
      <div class="modal-header">
        <h3 id="supportContractsTitle"><i class="fa-solid fa-layer-group" style="margin-right:8px;"></i><span id="supportContractsLabel">Supports par contrat</span></h3>
        <button class="modal-close" onclick="closeSupportContractsModal()">✕</button>
      </div>
      <div class="modal-body">
        <table id="supportContractsTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;">Contrat</th>
              <th style="text-align:right;">Nb parts</th>
              <th style="text-align:right;">Prix de revient</th>
              <th style="text-align:right;">Valorisation</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    (function(){
      function normalize(val){
        if (val === null || val === undefined) return '';
        return String(val);
      }
      function closeSupportContractsModal(){
        var modal = document.getElementById('supportContractsModal');
        if (modal) modal.style.display = 'none';
      }
      function openSupportContractsModal(data, label){
        var modal = document.getElementById('supportContractsModal');
        var labelEl = document.getElementById('supportContractsLabel');
        var tbody = document.querySelector('#supportContractsTable tbody');
        if (!modal || !tbody) return;
        tbody.innerHTML = '';
        if (labelEl) labelEl.textContent = label || 'Supports par contrat';
        var rows = Array.isArray(data) ? data : [];
        if (labelEl){
          if (rows.length === 1){
            labelEl.textContent = (label || '').trim() + " se trouve dans le contrat";
          } else if (rows.length > 1){
            labelEl.textContent = (label || '').trim() + " se trouve dans les contrats";
          }
        }
        var totalParts = 0.0;
        var totalValo = 0.0;
        var totalPrmpNum = 0.0;
        var totalPrmpDen = 0.0;
        // regrouper par contrat et sommer
        var grouped = {};
        rows.forEach(function(r, idx){
          var contratLabel = normalize(r.affaire_ref || r.contrat || r.contract || r.contrat_ref || r.reference || r.contract_ref || r.affaire_id || r.id);
          var contrat_id = (r.affaire_id !== undefined && r.affaire_id !== null) ? r.affaire_id : (r.contract_id || r.id || idx);
          var key = String(contrat_id);
          var nb_raw = parseFloat(r.nb_parts || r.nbuc || r.parts || r.quantite || 0) || 0;
          var valo_raw = parseFloat(r.valorisation || r.valo || r.valeur || 0) || 0;
          var prmp_raw = parseFloat(r.prix_revient || r.prmp || 0);
          if (!grouped[key]){
            grouped[key] = { contrat_id: contrat_id, contratLabel: contratLabel, nb: 0, valo: 0, prmp_num: 0, prmp_den: 0 };
          }
          grouped[key].nb += nb_raw;
          grouped[key].valo += valo_raw;
          if (!isNaN(prmp_raw)) {
            grouped[key].prmp_num += prmp_raw * nb_raw;
            grouped[key].prmp_den += nb_raw;
          }
        });
        if (rows.length === 0){
          var tr = document.createElement('tr');
          var td = document.createElement('td');
          td.colSpan = 7;
          td.textContent = 'Aucun contrat lié';
          td.className = 'muted';
          tr.appendChild(td);
          tbody.appendChild(tr);
        } else {
          Object.keys(grouped).forEach(function(k){
            var r = grouped[k];
            var tr = document.createElement('tr');
            var contrat = normalize(r.contratLabel);
            var contrat_id = r.contrat_id;
            var nb_raw = r.nb || 0;
            var valo_raw = r.valo || 0;
            var prmp_raw = (r.prmp_den > 0) ? (r.prmp_num / r.prmp_den) : null;
            totalParts += nb_raw;
            totalValo += valo_raw;
            if (prmp_raw !== null) {
              totalPrmpNum += prmp_raw * nb_raw;
              totalPrmpDen += nb_raw;
            }
            var nb = nb_raw ? nb_raw.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-';
            var prmp = (prmp_raw !== null && !isNaN(prmp_raw)) ? prmp_raw.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-';
            var valo = valo_raw ? valo_raw.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-';
            [contrat, nb, prmp, valo].forEach(function(val, idx){
              var td = document.createElement('td');
              if (idx === 0 && contrat_id){
                var a = document.createElement('a');
                a.href = '/dashboard/affaires/' + encodeURIComponent(contrat_id);
                a.textContent = val || ('#' + contrat_id);
                a.target = '_blank';
                td.appendChild(a);
              } else {
                td.textContent = val || '-';
              }
              if (idx >= 1) td.style.textAlign = 'right';
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          // ligne total
          var trTot = document.createElement('tr');
          trTot.className = 'muted';
          var td1 = document.createElement('td');
          td1.textContent = 'Total';
          var tdParts = document.createElement('td');
          tdParts.style.textAlign = 'right';
          tdParts.textContent = totalParts ? totalParts.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-';
          var tdPrmp = document.createElement('td'); tdPrmp.style.textAlign = 'right'; tdPrmp.textContent = (totalPrmpDen > 0) ? (totalPrmpNum / totalPrmpDen).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-';
          var tdValo = document.createElement('td'); tdValo.style.textAlign = 'right'; tdValo.textContent = totalValo ? totalValo.toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-';
          [td1, tdParts, tdPrmp, tdValo].forEach(function(td){ trTot.appendChild(td); });
          tbody.appendChild(trTot);
        }
        modal.style.display = 'flex';
      }
      window.closeSupportContractsModal = closeSupportContractsModal;
      // Bind hyperlinks on ISIN
      document.addEventListener('click', function(e){
        var el = e.target.closest('.support-contract-link');
        if (!el) return;
        e.preventDefault();
        try {
          var contracts = JSON.parse(el.getAttribute('data-contracts') || '[]');
          var label = (el.getAttribute('data-support-code') || '') + ' ' + (el.getAttribute('data-support-name') || '');
          openSupportContractsModal(contracts, label.trim());
        } catch (err){
          console.error('Support contracts modal error:', err);
        }
      }, false);
    })();
  </script>

  <div id="supportMovementsModal" class="modal-overlay" onclick="if(event.target===this) closeSupportMovementsModal()">
    <div class="modal-card" style="width:820px; max-width:97vw;">
      <div class="modal-header">
        <h3><i class="fa-solid fa-right-left" style="margin-right:8px;"></i><span id="supportMovementsLabel">Mouvements du support</span></h3>
        <button class="modal-close" onclick="closeSupportMovementsModal()">✕</button>
      </div>
      <div class="modal-body">
        <table id="supportMovementsTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;">Date</th>
              <th style="text-align:left;">Règle</th>
              <th style="text-align:right;">Montant</th>
              <th style="text-align:right;">VL</th>
              <th style="text-align:right;">Nb parts</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  {# Bloc de création de tâche supprimé (maintenance) #}

  <style>
    /* Sélection visuelle des lignes dans la pop-up Messages */
    #clientMsgsTable tbody tr:hover { background: #f3f6ff; }
    #clientMsgsTable tbody tr.row-selected { background: #e9f0ff; border-left: 3px solid var(--primary); }
  </style>
  <div id="invSection" class="card" data-tb-marker="CL_15" style="display:none;">
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <h3 style="margin:4px 8px 8px 0;">Contrats du client</h3>
      {% if available_dates %}
        <label for="asOfSelect" class="muted" style="font-size:0.85rem;">Date effective:</label>
        <select id="asOfSelect" style="padding:4px 8px; font-size:0.9rem; width:12ch; min-width:12ch;">
          {% for d in available_dates %}
            <option value="{{ d }}" {% if d == as_of_effective %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      {% endif %}
    </div>
    <table id="contractsTable" data-tb-marker="CL_16">
      <thead>
        <tr>
          <th>Contrat</th>
          <th>SRRI</th>
          <th>Date début</th>
          <th>Montant</th>
          <th>Perf. 52s</th>
          <th>Volat. 52s</th>
        </tr>
      </thead>
      <tbody>
        {% for a in client_affaires %}
        <tr class="{% if a.date_cle %}highlight-cle{% endif %}">
          <td>
            <a href="/dashboard/affaires/{{ a.id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ a.ref }}</a>
            {% if a.date_cle %}<span class="badge-closed">Le contrat est clôturé ({{ (a.date_cle|string)[:10] }})</span>{% endif %}
          </td>
          <td style="text-align:center;">
            {{ a.SRRI }}
            {% if a.srri_icon %}
              {% if a.srri_icon == 'fire' %}
                <span class="srri-dot srri-blue" title="Au‑dessus" aria-hidden="true"></span>
              {% elif a.srri_icon == 'hands-praying' %}
                <span class="srri-dot srri-green" title="Identique" aria-hidden="true"></span>
              {% elif a.srri_icon == 'snowflake' %}
                <span class="srri-dot srri-red" title="En‑dessous" aria-hidden="true"></span>
              {% else %}{% endif %}
              <span class="srri-calc" style="margin-left:6px; font-size:11px; color:#666;">{{ a.srri_calc }}</span>
            {% endif %}
          </td>
          <td class="center">{{ (a.date_debut|string)[:10] if a.date_debut else '' }}</td>
          {% set dot_class = 'valo-neutral' %}
          {% set dot_title = 'Valorisation stable' %}
          {% set ecart = a.ecart_valo_mvt if a.ecart_valo_mvt is defined else None %}
          {% set last_valo_raw = a.last_valo_numeric if a.last_valo_numeric is defined else 0 %}
          {% if last_valo_raw > 0 and ecart is not none %}
            {% if ecart >= 0 %}
              {% set dot_class = 'valo-up' %}
              {% set dot_title = 'Contrat en plus-value' %}
            {% else %}
              {% set dot_class = 'valo-down' %}
              {% set dot_title = 'Contrat en moins-value' %}
            {% endif %}
          {% elif ecart is none %}
            {% set dot_title = 'Historique mouvements indisponible' %}
          {% else %}
            {% set dot_title = 'Valorisation nulle ou négative' %}
          {% endif %}
          <td style="text-align:right;">
            <span class="valo-dot {{ dot_class }}" aria-hidden="true" title="{{ dot_title }}"></span>{{ a.last_valo_str }}
          </td>
          <td style="text-align:right;">{% if a.last_perf_pct is not none %}{{ '%.2f'|format(a.last_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if a.last_vol_pct is not none %}{{ '%.2f'|format(a.last_vol_pct) }} %{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 style="margin-top:14px;">Supports consolidés (tous contrats)</h3>
    <table id="supportsClient">
      <thead>
        <tr>
          <th>ISIN</th>
          <th>Support</th>
          <th>SRRI</th>
          <th>Nb Parts</th>
          <th>Prix de revient</th>
          <th>VL</th>
          <th>Valorisation</th>
          <th>E</th>
          <th>S</th>
          <th>G</th>
        </tr>
      </thead>
      <tbody>
        {% for s in client_supports %}
        <tr>
          <td>
            {% if s.code_isin %}
              <a href="#" class="support-contract-link" data-support-code="{{ s.code_isin }}" data-support-name="{{ s.nom or '' }}" data-contracts='{{ s.contracts | tojson | safe }}'>{{ s.code_isin }}</a>
            {% else %}
              {{ s.code_isin or '' }}
            {% endif %}
          </td>
          <td>{{ s.nom or '' }}</td>
          <td class="center">{{ s.srri_support or '' }}</td>
          <td style="text-align:right;">{{ s.nbuc_str }}</td>
          <td style="text-align:right;">{{ s.prmp_str }}</td>
          {% set nav_class = 'nav-dot nav-neutral' %}
          {% set nav_title = 'VL indisponible' %}
          {% if s.prmp is not none and s.vl is not none %}
            {% if s.prmp > s.vl %}
              {% set nav_class = 'nav-dot nav-red' %}
              {% set nav_title = 'Prix de revient supérieur à la VL' %}
            {% else %}
              {% set nav_class = 'nav-dot nav-green' %}
              {% set nav_title = 'Prix de revient inférieur ou égal à la VL' %}
            {% endif %}
          {% elif s.vl is not none %}
            {% set nav_class = 'nav-dot nav-green' %}
            {% set nav_title = 'VL disponible' %}
          {% endif %}
          <td style="text-align:right;">
            {% if s.vl is not none %}
              <span class="{{ nav_class }}" aria-hidden="true" title="{{ nav_title }}"></span>{{ s.vl_str }}
            {% else %}
              <span class="muted">-</span>
            {% endif %}
          </td>
          <td style="text-align:right;">{{ s.valo_str }}</td>
          <td class="center">{{ s.noteE or '' }}</td>
          <td class="center">{{ s.noteS or '' }}</td>
          <td class="center">{{ s.noteG or '' }}</td>
        </tr>
        {% endfor %}
        {% if not client_supports %}
        <tr><td colspan="9" class="muted">Aucun support consolidé trouvé.</td></tr>
        {% endif %}
      </tbody>
    </table>

  </div>

  <div id="esgSectionClient" style="display:none;">
    <div class="card" style="margin-top:8px; width:100%; box-sizing:border-box;">
      <h3 class="chart-title">Comparaison ESG Client vs Indice</h3>
      <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px 0;">
        {% set graph_default_alloc = (client_allocation_name or allocation_reference_name or (risque_latest.allocation_nom if risque_latest and risque_latest.allocation_nom else (risque_snapshot.allocation_nom if (risque_snapshot is defined and risque_snapshot and risque_snapshot.allocation_nom) else '')) or (client_allocation_id and (allocations_lookup.get(client_allocation_id) if allocations_lookup is defined else None))) %}
        <div>
          <label class="muted" style="font-size:0.85rem;">Allocation de référence</label><br>
          <select id="esgAllocSelectClient" style="min-width:220px; max-width:280px; width:auto;">
            <option value="" {% if not esg_comparison_alloc %}selected{% endif %}>— choisir —</option>
            {% for nm in alloc_names %}
              <option value="{{ nm }}"{% if esg_comparison_alloc and nm == esg_comparison_alloc %} selected{% endif %}>{{ nm }}</option>
            {% endfor %}
            {% if esg_comparison_alloc and esg_comparison_alloc not in alloc_names %}
              <option value="{{ esg_comparison_alloc }}" selected>{{ esg_comparison_alloc }}</option>
            {% endif %}
            {% if graph_default_alloc and graph_default_alloc not in alloc_names and graph_default_alloc != esg_comparison_alloc %}
              <option value="{{ graph_default_alloc }}" selected>{{ graph_default_alloc }}</option>
            {% endif %}
          </select>
        </div>
        <div style="display:none;">
          <label class="muted" style="font-size:0.85rem;">Date</label><br>
          <select id="esgAllocDateClient" style="width: 14ch; min-width: 14ch;"></select>
        </div>
        <div style="flex:1 1 auto; min-width:260px;">
          <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
          <div id="esgFieldsClient" style="display:flex; gap:6px; flex-wrap:wrap;">
            {% if esg_field_labels %}
              {% for col, label in esg_field_labels.items() %}
                <button type="button" class="dim-btn esg-field-client" data-field="{{ col }}" title="{{ label or col }}">{{ label or col }}</button>
              {% endfor %}
            {% elif esg_fields %}
              {% for it in esg_fields %}
                {% set col = it.col if it is mapping else it %}
                {% set label = (it.label if it is mapping else it) %}
                <button type="button" class="dim-btn esg-field-client" data-field="{{ col }}" title="{{ label or col }}">{{ label or col }}</button>
              {% endfor %}
            {% else %}
              <span class="muted">Aucun champ ESG détecté</span>
            {% endif %}
          </div>
        </div>
        <div>
          <button id="esgRefreshBtnClient" class="rangeBtn" type="button" title="Actualiser">Actualiser</button>
        </div>
      </div>
      <div id="esgChartClient" style="height:320px; width:100%;"></div>
      <div id="esgUnmatchedNotice" class="muted" style="margin-top:6px; font-size:12px;{% if not esg_unmatched_fields %} display:none;{% endif %}">{% if esg_unmatched_fields %}Indicateurs introuvables : {{ esg_unmatched_fields|join(', ') }}.{% endif %}</div>
      <div class="muted" style="margin-top:4px; font-size:12px;">Indice normalisé à 100. Client = valeur relative (Client / Indice × 100).</div>
      <div class="card esg-matrix-card" style="margin-top:12px;">
        <div class="esg-matrix-header">
          <h4 style="margin:0;">Correspondance exclusions / indicateurs → métriques ESG</h4>
          <div class="esg-pill-row">
            <button type="button" class="esg-pill active" data-esg-group="exclusions">Exclusions / Risques</button>
            <button type="button" class="esg-pill" data-esg-group="indicateurs">Indicateurs / Opportunités</button>
          </div>
        </div>
        <div id="esgMatrixExclusions"></div>
        <div id="esgMatrixIndicateurs" style="display:none;"></div>
      </div>
      <div class="esg-blocks">
        <div class="esg-block" id="esgBlockSens">
          <h4><i class="fa-solid fa-heart" aria-hidden="true"></i>Sensibilité ESG</h4>
          <div class="tag-list" id="esgSensTags"></div>
          <div id="esgSensTable"></div>
        </div>
        <div class="esg-block" id="esgBlockExcl">
          <h4><i class="fa-solid fa-ban" aria-hidden="true"></i>Exclusions</h4>
          <div class="tag-list" id="esgExclTags"></div>
          <div id="esgExclTable"></div>
        </div>
        <div class="esg-block" id="esgBlockIndic">
          <h4><i class="fa-solid fa-bullseye" aria-hidden="true"></i>Indicateurs à suivre</h4>
          <div class="tag-list" id="esgIndicTags"></div>
          <div id="esgIndicTable"></div>
        </div>
      </div>
    </div>
  </div>

<div id="graphsSection" style="display:none;">
  <div class="card" style="margin-bottom:10px;">
    <div class="accordion-toggle" data-target="graphValoPanel" style="margin:0; justify-content:flex-start;">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-chart-line"></i> Evolution des investissements et de la valorisation des placements</h3>
      <span class="chevron">▾</span>
    </div>
    <div id="graphValoPanel" class="accordion-panel" style="display:none; padding:10px 0 0 0;">
      <canvas id="valoChart" height="120"></canvas>
    </div>
  </div>
  <div class="card" style="margin-bottom:10px;">
    <div class="accordion-toggle" data-target="graphSrriPanel" style="margin:0; justify-content:flex-start;">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-chart-line"></i> Performances et risques</h3>
      <span class="chevron">▾</span>
    </div>
    <div id="graphSrriPanel" class="accordion-panel" style="display:none; padding:10px 0 0 0;">
      <canvas id="clientSrriChart" height="120"></canvas>
    </div>
  </div>
  <div class="card" style="margin-bottom:10px;">
    <div class="accordion-toggle" data-target="graphAllocPanel" style="margin:0; justify-content:flex-start;">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-chart-column"></i> Comparaison placements clients / Offre financière</h3>
      <span class="chevron">▾</span>
    </div>
      <div id="graphAllocPanel" class="accordion-panel" style="display:none; padding:10px 0 0 0;">
        <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; margin:6px 0 8px 0;">
          <div>
            <label class="muted" style="font-size:0.85rem;">Sélection d'allocations</label><br>
            <select id="allocSelectClient"></select>
            <div style="margin-top:6px;">
              <button id="allocResetBtnClient" type="button" class="dim-btn" title="Revenir à l'allocation par défaut">Réinitialiser</button>
            </div>
          </div>
          <div>
            <label class="muted" style="font-size:0.85rem;">Période</label><br>
            <button class="rangeBtn" data-range="all">Tout</button>
            <button class="rangeBtn" data-range="365">1 an</button>
          <button class="rangeBtn" data-range="180">6 mois</button>
          <button class="rangeBtn" data-range="90">3 mois</button>
          <button class="rangeBtn" data-range="30">1 mois</button>
        </div>
      </div>
    <canvas id="clientAllocChart" height="120"></canvas>
  </div>
</div>

  <div class="card" style="margin-bottom:10px;">
    <div class="accordion-toggle" data-target="simuAllocPanel" style="margin:0; justify-content:flex-start;">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-flask"></i> Simulation financière</h3>
      <span class="chevron">▾</span>
    </div>
  <div id="simuAllocPanel" class="accordion-panel" style="display:none; padding:10px 0 10px 0;">
    <div class="table-responsive">
      <table id="simuAllocTable" class="table table-sm" style="width:100%; font-size:13px;">
        <thead>
          <tr>
            <th>Allocation</th>
            <th style="text-align:right;">Perf 52s</th>
            <th style="text-align:right;">Volat.</th>
            <th style="text-align:center;">SRRI</th>
            <th style="text-align:right; white-space:nowrap; width:1%;">Répartitions</th>
          </tr>
        </thead>
        <tbody>
          {% for row in allocation_simulation_rows or [] %}
          <tr data-alloc="{{ row.nom }}">
            <td>{{ row.nom }}</td>
            <td style="text-align:right;">{% if row.perf_52 is not none %}{{ '%.2f'|format(row.perf_52 if row.perf_52|abs > 1 else row.perf_52*100) }} %{% else %}—{% endif %}</td>
            <td style="text-align:right;">{% if row.volat is not none %}{{ '%.2f'|format(row.volat if row.volat|abs > 1 else row.volat*100) }} %{% else %}—{% endif %}</td>
            <td style="text-align:center;"> 
              {% set _srri = None %}
              {% if row.volat is not none %}
                {% set _v = row.volat %}
                {% if _v|abs <= 1 %}
                  {% set _v = _v * 100 %}
                {% endif %}
                {% if _v <= 0.5 %}
                  {% set _srri = 1 %}
                {% elif _v <= 2 %}
                  {% set _srri = 2 %}
                {% elif _v <= 5 %}
                  {% set _srri = 3 %}
                {% elif _v <= 10 %}
                  {% set _srri = 4 %}
                {% elif _v <= 15 %}
                  {% set _srri = 5 %}
                {% elif _v <= 25 %}
                  {% set _srri = 6 %}
                {% else %}
                  {% set _srri = 7 %}
                {% endif %}
              {% endif %}
              {{ _srri if _srri is not none else '—' }}
            </td>
            <td style="text-align:right; white-space:nowrap; width:1%;">
              <input type="text"
                     class="simu-weight"
                     inputmode="decimal"
                     pattern="^[0-9]+([\\.,][0-9]{0,2})?$"
                     value="{{ '%.2f'|format(row.poids_pct or 0) }}"
                     style="width:7ch; box-sizing:border-box; text-align:right; font-size:12px;" />
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div style="display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-top:6px;">
      <button id="simuAllocResetBtn" type="button" class="dim-btn" title="Remettre les répartitions calculées">Réinitialiser</button>
      <div class="muted" id="simuAllocSum" style="font-size:12px; text-align:right;"></div>
    </div>
    <div id="simuAllocSqlWrap" class="muted" style="margin-top:10px; font-size:12px; display:none;">
      Requête SQL (littérale) :
      <pre id="simuAllocSql" style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:10px; font-size:12px; white-space:pre-wrap; margin-top:4px;">(chargement…)</pre>
    </div>
    <div id="simuAllocSummary" class="muted" style="margin-top:8px; font-size:12px;"></div>
    <div id="simuAllocSrriChartWrap" style="margin-top:12px;">
      <canvas id="simuAllocSrriChart" height="110"></canvas>
    </div>
    <div class="muted" style="font-size:12px; margin-top:8px; display:flex; align-items:center; gap:8px; display:none;">
      <span>Données (JSON) utilisées pour le graphique :</span>
      <button id="simuAllocExportCsv" type="button" class="dim-btn" style="padding:4px 8px; font-size:12px;">Exporter CSV</button>
    </div>
    <pre id="simuAllocDataJson" style="background:#f8fafc; border:1px solid #e5e7eb; border-radius:8px; padding:10px; font-size:12px; white-space:pre-wrap; margin-top:4px; display:none;">[]</pre>
  </div>
</div>

  <div class="card" style="margin-bottom:10px;">
    <div class="accordion-toggle" data-target="graphPiePanel" style="margin:0; justify-content:flex-start;">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-chart-pie"></i> Répartition par catégorie / géographique</h3>
      <span class="chevron">▾</span>
    </div>
    <div id="graphPiePanel" class="accordion-panel" style="display:none; padding:10px 0 0 0;">
      <div class="pie-grid" style="margin-top:0;">
        <div class="pie-card">
          <h3 class="chart-title">Répartition par catégorie</h3>
          <div class="dim-buttons" style="display:flex; gap:6px; margin-bottom:6px; flex-wrap:wrap;">
            <button type="button" class="dim-btn active" data-field="cat_gene">Catégorie générale</button>
            <button type="button" class="dim-btn" data-field="cat_principale">Catégorie principale</button>
            <button type="button" class="dim-btn" data-field="cat_det">Catégorie détaillée</button>
          </div>
          <canvas id="clientCatChart" height="220"></canvas>
        </div>
        <div class="pie-card">
          <h3 class="chart-title">Répartition géographique du secteur</h3>
          <canvas id="clientGeoChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Cadre indépendant: Performances et volatilité annuelles -->

  <div id="reportSection" class="card" style="display:none;">
    {% if reporting_years %}
    <table style="font-size:12px;">
      <thead>
        <tr>
          <th>Année</th>
          <th style="text-align:right;">Versements</th>
          <th style="text-align:right;">Retraits</th>
          <th style="text-align:right;">Solde annuel</th>
          <th style="text-align:right;">Solde cumulé</th>
          <th style="text-align:right;">Valo fin d'année</th>
          <th style="text-align:right;">Perf fin d'année</th>
          <th style="text-align:right;">Cumul perf</th>
          <th style="text-align:right;">Perf annualisée</th>
          <th style="text-align:right;">Vol. 52s (fin)</th>
          <th style="text-align:right;">Vol. moyenne</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reporting_years %}
        <tr>
          <td style="text-align:center;">{{ r.year }}</td>
          <td style="text-align:right;">{{ r.versements_str }}</td>
          <td style="text-align:right;">{{ r.retraits_str }}</td>
          <td style="text-align:right;">{{ r.solde_str }}</td>
          <td style="text-align:right;">{{ r.solde_cum_str }}</td>
          <td style="text-align:right;">{{ r.last_valo_str }}</td>
          <td style="text-align:right;">{% if r.last_perf_pct is not none %}{{ '%.2f'|format(r.last_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.cum_perf_pct is not none %}{{ '%.2f'|format(r.cum_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.ann_perf_pct is not none %}{{ '%.2f'|format(r.ann_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.last_vol_pct is not none %}{{ '%.2f'|format(r.last_vol_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.avg_vol_pct is not none %}{{ '%.2f'|format(r.avg_vol_pct) }} %{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="muted" style="margin-top:6px; font-size:12px;">
      <div>Les pourcentages sont exprimés en % (valeurs décimales converties).</div>
      <div>La performance annualisée correspond à la performance cumulée observée à la date, ramenée en taux annuel fixe (CAGR).</div>
    </div>
    {% else %}
      <div class="muted">Aucune donnée annuelle disponible.</div>
    {% endif %}
  </div>

  <!-- (section Graphiques fusionnée ci-dessus) -->

  <div id="docsSection" class="card" data-tb-marker="CL_17" style="display:none;">
    <h3>Documents du client</h3>
    <form id="addDocForm" style="margin-bottom:12px; display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; align-items:end;">
      {% if cl_markers_param %}<input type="hidden" name="markers" value="1" />{% endif %}
      <div>
        <label>Type de document</label>
        <div>
          <select id="document_base_select" required>
            <option value="" disabled selected>Choisir…</option>
          </select>
        </div>
      </div>
      <div>
        <label>Nom document</label>
        <input type="text" id="nom_document" placeholder="ex: Pièce identité" />
      </div>
      <div>
        <label>Date création</label>
        <input type="date" id="date_creation" />
      </div>
      <div>
        <label>Date obsolescence</label>
        <input type="date" id="date_obsolescence" />
      </div>
      <div>
        <label>Statut</label>
        <input type="text" id="obsolescence" placeholder="valide / expiré" />
      </div>
      <div>
        <button type="submit">Ajouter</button>
      </div>
    </form>

    <table id="clientDocs" class="display nowrap" style="width:100%">
      <thead>
        <tr>
          <th>Type (base)</th><th>Nom (libellé)</th><th>Date création</th><th>Date obsolescence</th><th>Statut</th><th>Action</th>
        </tr>
        <tr>
          <th><input type="text" id="cd-type-filter" placeholder="Filtrer..."></th>
          <th><input type="text" id="cd-nom-filter" placeholder="Filtrer..."></th>
          <th><input type="text" id="cd-cr-filter" placeholder="AAAA-MM-JJ"></th>
          <th><input type="text" id="cd-obsdate-filter" placeholder="AAAA-MM-JJ"></th>
          <th><select id="cd-status-filter"><option value="">Tous</option></select></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
      {% for d in documents_client %}
        <tr>
          <td>{{ d.base_name or '-' }}</td>
          <td>{{ d.nom_document or '-' }}</td>
          <td>{{ (d.date_creation|string)[:10] if d.date_creation else '-' }}</td>
          <td>{{ (d.date_obsolescence|string)[:10] if d.date_obsolescence else '-' }}</td>
          <td>{{ d.obsolescence or '-' }}</td>
          <td><button class="delBtn" data-id="{{ d.id }}">Supprimer</button></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="card">Client introuvable.</div>
{% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js: couleur par défaut (axes/labels) = bleu CSS
try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
// Messages/tâches client (modale) — même logique que la page Affaires
const CLIENT_EVENTS_OPEN = {{ client_events_open | tojson }};
function _normCatCl(s){
  if(!s) return '';
  return (s+'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replaceAll('ç','c').replaceAll('Ç','c');
}
function closeClientMsgs(){
  var modal = document.getElementById('clientMsgsModal');
  if (modal) modal.style.display = 'none';
}
function openClientMsgs(kind){
  const modal = document.getElementById('clientMsgsModal');
  const tbody = modal ? modal.querySelector('tbody') : null;
  if (!modal || !tbody) return;
  tbody.innerHTML = '';
  const isReg = (kind === 'reg');
  const title = document.getElementById('clientMsgsTitle');
  title.innerHTML = (isReg ? '<i class="fa-solid fa-envelope"></i>Messages réglementaires' : '<i class="fa-solid fa-envelope"></i>Messages non réglementaires');
  const rows = (CLIENT_EVENTS_OPEN||[]).filter(ev => {
    const cat = _normCatCl(ev.type_categorie);
    const reg = (cat === 'reglementaire');
    return isReg ? reg : !reg;
  });
  function statusStyle(label){
    const s = (label||'').toLowerCase();
    if (s === 'en cours') return 'background:#16a34a; color:#fff; border-color:#16a34a;';
    if (s === 'en attente') return 'background:#f59e0b; color:#fff; border-color:#f59e0b;';
    if (s === 'terminé' || s === 'termine') return 'background:#4b5563; color:#fff; border-color:#4b5563;';
    if (s === 'annulé' || s === 'annule') return 'background:#b91c1c; color:#fff; border-color:#b91c1c;';
    return '';
  }
  function openTaskEditPopup(id){
    try {
      var w = 1100, h = 800;
      var left = Math.max(0, Math.floor(((screen.availWidth||screen.width||w) - w) / 2));
      var top = Math.max(0, Math.floor(((screen.availHeight||screen.height||h) - h) / 2));
      var feat = 'scrollbars=yes,resizable=yes' + ',width=' + w + ',height=' + h + ',left=' + left + ',top=' + top;
      var win = window.open(appendMarkers('/dashboard/taches/'+id), 'taskEdit'+id, feat);
      if (win && win.focus) { try { win.focus(); } catch(e){} }
    } catch(e){}
  }
  rows.forEach(ev => {
    const evId = ev.id_resolved ?? ev.id ?? ev.evenement_id ?? ev.event_id ?? ev.evenementId ?? ev.eventId;
    const tr = document.createElement('tr');
    function td(v){ const td = document.createElement('td'); td.textContent = v==null?'':v; return td; }
    tr.appendChild(td(ev.date_evenement||''));
    tr.appendChild(td(ev.type_libelle||''));
    tr.appendChild(td(ev.type_categorie||''));
    const statTd = document.createElement('td');
    const sb = document.createElement('a');
    sb.className = 'btn btn-choice';
    sb.textContent = ev.statut || 'à faire';
    sb.style.cssText = 'padding:2px 6px; font-size:11px; border-radius:4px; ' + statusStyle(ev.statut||'');
    if (ev.id){
      sb.href = appendMarkers('/dashboard/taches/' + ev.id);
      sb.target = '_blank';
      sb.rel = 'noopener noreferrer';
    } else {
      sb.href = '#';
      sb.title = 'Tâche sans identifiant';
      sb.style.opacity = '0.6';
      sb.style.pointerEvents = 'none';
    }
    statTd.appendChild(sb);
    if (ev.statut_reclamation_label){
      const rec = document.createElement('div');
      rec.className = 'muted';
      rec.style.fontSize = '0.75rem';
      rec.style.marginTop = '2px';
      rec.textContent = 'Réclamation : ' + ev.statut_reclamation_label;
      statTd.appendChild(rec);
    }
    tr.appendChild(statTd);
    tr.appendChild(td(ev.affaire_ref || ''));
    const ctd = document.createElement('td');
    const full = String(ev.commentaire||'');
    const short = full.slice(0, 180);
    const sid = 'ccl-short-' + (evId||Math.random());
    const fid = 'ccl-full-' + (evId||Math.random());
    const sdiv = document.createElement('div'); sdiv.id=sid; sdiv.style.whiteSpace='pre-wrap'; if (full.length <= 180) sdiv.style.display='none'; sdiv.textContent = short + (full.length>180 ? '…' : '');
    const fdiv = document.createElement('div'); fdiv.id=fid; fdiv.style.whiteSpace='pre-wrap'; if (full.length > 180) fdiv.style.display='none'; fdiv.textContent = full;
    ctd.appendChild(sdiv); ctd.appendChild(fdiv);
    if (full.length > 180){
      const a=document.createElement('a'); a.href='#'; a.style.fontSize='12px'; a.textContent='Voir plus';
      a.addEventListener('click', function(e){ e.preventDefault(); const sh=document.getElementById(sid); const fl=document.getElementById(fid); const isShort=sh.style.display!=='none'; sh.style.display=isShort?'none':''; fl.style.display=isShort?'':'none'; this.textContent=isShort?'Voir moins':'Voir plus'; });
      const wrap=document.createElement('div'); wrap.appendChild(a); ctd.appendChild(wrap);
    }
    tr.appendChild(ctd);
    const idRawTd = document.createElement('td');
    idRawTd.textContent = (ev && ev.id != null && ev.id !== '') ? ev.id : '—';
    const idAltTd = document.createElement('td');
    idAltTd.textContent = (ev && ev.evenement_id != null && ev.evenement_id !== '') ? ev.evenement_id : '—';
    tr.appendChild(idRawTd);
    tr.appendChild(idAltTd);

    const actionTd = document.createElement('td');
    if (evId){
      const editLink = document.createElement('a');
      editLink.className='btn btn-choice';
      editLink.style.cssText='padding:2px 6px; font-size:11px; border-radius:4px;';
      editLink.innerHTML = '<i class=\"fa-solid fa-eye\"></i>';
      editLink.href = appendMarkers('/dashboard/taches/' + evId);
      editLink.target = '_blank';
      editLink.rel = 'noopener noreferrer';
      editLink.addEventListener('click', function(e){ e.stopPropagation(); });
      actionTd.appendChild(editLink);
    } else {
      actionTd.textContent = '—';
      actionTd.style.textAlign = 'center';
    }
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  modal.style.display = 'flex';
}
</script>
<!-- jQuery + DataTables for client docs table and messages export -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script>
  // Accordéons internes du bloc Graphiques (indépendants, fermés par défaut)
  (function(){
    const toggles = document.querySelectorAll('#graphsSection .accordion-toggle[data-target]');
    toggles.forEach(function(t){
      const targetId = t.getAttribute('data-target');
      const panel = document.getElementById(targetId);
      if (!panel) return;
      t.classList.add('collapsed');
      panel.style.display = 'none';
      t.addEventListener('click', function(){
        const isOpen = panel.style.display !== 'none';
        panel.style.display = isOpen ? 'none' : '';
        t.classList.toggle('collapsed', isOpen);
      });
    });
  })();

  // Toggle consolidation panel
  (function(){
    const tg = document.getElementById('simuConsToggle');
    const panel = document.getElementById('simuConsPanel');
    if (!tg || !panel) return;
    tg.addEventListener('click', function(){
      const isHidden = panel.style.display === 'none' || panel.style.display === '';
      panel.style.display = isHidden ? 'block' : 'none';
      const chev = tg.querySelector('.chevron');
      if (chev) chev.textContent = isHidden ? '▾' : '▸';
    });
  })();
</script>
<script>
  // Accordéons mutualisés: un seul ouvert à la fois et possibilité de tout fermer
  (function(){
    var groups = [
      { key:'kyc', toggleId:'kycToggle', sectionId:'kycSection' },
      { key:'inv', toggleId:'invToggle', sectionId:'invSection' },
      { key:'esg', toggleId:'esgToggleClient', sectionId:'esgSectionClient' },
      { key:'graphs', toggleId:'graphsToggle', sectionId:'graphsSection' },
      { key:'report', toggleId:'reportToggle', sectionId:'reportSection' },
      { key:'docs', toggleId:'docsToggle', sectionId:'docsSection' },
      { key:'conf', toggleId:'confToggleDetail', sectionId:'confSection' },
      { key:'invest', toggleId:'investToggle', sectionId:'investSection' },
    ];
    function byId(id){ return document.getElementById(id); }
    var available = groups.filter(function(g){ return byId(g.toggleId) && byId(g.sectionId); });
    function firstAvailableKey(){ return available.length ? available[0].key : ''; }
    function setActive(id){
      try {
        document.querySelectorAll('.section-toggle-row .accordion-toggle').forEach(function(btn){
          btn.classList.toggle('active', btn.id === id);
        });
      } catch(e){}
    }
    var currentOpen = '';
    function setOpen(key){
      var targetKey = key;
      var exists = available.some(function(g){ return g.key === key; });
      if (key && !exists) { targetKey = firstAvailableKey(); }
      groups.forEach(function(g){
        var t = byId(g.toggleId), s = byId(g.sectionId);
        if (!t || !s) return;
        var isTarget = targetKey && g.key === targetKey;
        if (isTarget){
          s.style.display = '';
          t.classList.remove('collapsed');
          setActive(g.toggleId);
        } else {
          s.style.display = 'none';
          t.classList.add('collapsed');
        }
      });
      currentOpen = targetKey || '';
      try { localStorage.setItem('client_detail_open', currentOpen || ''); } catch(e) {}
    }
    // Restore last open
    var saved = '';
    try { saved = localStorage.getItem('client_detail_open') || ''; } catch(e) {}
    if (saved) { setOpen(saved); currentOpen = saved; }
    else if (!currentOpen) { setOpen(firstAvailableKey()); }
    // Wire clicks
    groups.forEach(function(g){
      var t = byId(g.toggleId), s = byId(g.sectionId);
      if (!t || !s) return;
      t.addEventListener('click', function(){
        var isOpen = s.style.display !== 'none';
        if (isOpen) { setOpen(''); setActive(''); }
        else { setOpen(g.key); }
      });
    });
    // Header synthèse clique également
    window.openSynthSection = function(){ return false; };
  })();

  // Auto-sélection du type selon catégorie (client)
  (function(){
    try {
      const CTYPES = [
        {% for t in types %}
          { id: {{ t.id }}, libelle: {{ t.libelle|tojson }}, categorie: {{ t.categorie|tojson }} },
        {% endfor %}
      ];
      const catSel = document.getElementById('client_cat_select');
      const typeSel = document.getElementById('client_type_select');
      if (!catSel || !typeSel) return;
      function syncTypes(){
        const cat = catSel.value;
        typeSel.innerHTML='';
        if(!cat){ const o=document.createElement('option'); o.value=''; o.textContent='-- choisir une catégorie --'; typeSel.appendChild(o); return; }
        const list = CTYPES.filter(t=>t.categorie===cat).map(t=>t.libelle);
        list.forEach(lib=>{ const o=document.createElement('option'); o.value=lib; o.textContent=lib; typeSel.appendChild(o); });
        if (list.length>0) typeSel.value = list[0];
      }
      catSel.addEventListener('change', syncTypes);
      if (catSel.value) syncTypes();
    } catch(e) {}
  })();

  // Changement de date effective -> recharge avec param ?as_of=YYYY-MM-DD
  (function(){
    var sel = document.getElementById('asOfSelect');
    if (!sel) return;
    sel.addEventListener('change', function(){
      var v = this.value;
      var url = new URL(window.location.href);
      url.searchParams.set('as_of', v);
      window.location.href = url.toString();
    });
  })();

  // Charts de répartition basés sur supports consolidés
  (function(){
    var supportsData = {{ client_supports | tojson }};
    var catCtx = document.getElementById('clientCatChart');
    var geoCtx = document.getElementById('clientGeoChart');
    if (!catCtx || !geoCtx) return;
    catCtx = catCtx.getContext('2d');
    geoCtx = geoCtx.getContext('2d');
    var catChart, geoChart;
    function buildCatBar(field){
      var map = new Map();
      (supportsData||[]).forEach(function(s){
        var key = (s[field] || 'Non renseigné');
        var v = parseFloat(s.valo) || 0;
        map.set(key, (map.get(key)||0) + v);
      });
      var entries = Array.from(map.entries()).sort(function(a,b){return b[1]-a[1];});
      var labels = entries.map(function(e){return e[0];});
      var values = entries.map(function(e){return e[1];});
      if (catChart) catChart.destroy();
      catChart = new Chart(catCtx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ data: values, backgroundColor: 'var(--primary)' }] },
        options: { indexAxis: 'y', responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          layout:{ padding:{ top:10, bottom:6, right:8, left:8 } },
          scales:{ x:{ display:false, beginAtZero:true }, y:{ ticks:{ font:{ size:10 }, autoSkip:false, maxTicksLimit:20 } } },
          datasets:{ bar:{ categoryPercentage:0.7, barPercentage:0.8, maxBarThickness:18 } },
          onHover: function(evt, els){ if (els && els.length){ var idx=els[0].index; var label=labels[idx]; buildGeoBar(field, label); } }
        }
      });
      buildGeoBar(field, null);
      catCtx.canvas.addEventListener('mouseleave', function(){ buildGeoBar(field, null); });
    }
    function buildGeoBar(field, catValue){
      var map = new Map();
      (supportsData||[]).forEach(function(s){
        var cat = (s[field] || 'Non renseigné');
        if (catValue !== null && catValue !== undefined && String(cat) !== String(catValue)) return;
        var key = (s['cat_geo'] || 'Non renseigné');
        var v = Number(s.valo) || 0;
        map.set(key, (map.get(key)||0) + v);
      });
      var entries = Array.from(map.entries()).sort(function(a,b){return b[1]-a[1];});
      var labels = entries.map(function(e){return e[0];});
      var values = entries.map(function(e){return e[1];});
      if (geoChart) geoChart.destroy();
      geoChart = new Chart(geoCtx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ data: values, backgroundColor:'#2a9d8f' }] },
        options: { indexAxis:'y', responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          layout:{ padding:{ top:10, bottom:6, right:8, left:8 } },
          scales:{ x:{ display:false, beginAtZero:true }, y:{ ticks:{ font:{ size:10 }, autoSkip:false, maxTicksLimit:20 } } },
          datasets:{ bar:{ categoryPercentage:0.7, barPercentage:0.8, maxBarThickness:18 } }
        }
      });
    }
    buildCatBar('cat_gene');
    // Scope les clicks aux boutons de la section Répartition (évite de capter les boutons ESG)
    var dimContainer = document.querySelector('#clientCatChart') ? document.getElementById('clientCatChart').closest('.pie-card') : null;
    if (dimContainer){
      dimContainer.querySelectorAll('.dim-buttons .dim-btn').forEach(function(btn){
        btn.addEventListener('click', function(ev){
          // Ne pas impacter d'autres groupes de boutons
          dimContainer.querySelectorAll('.dim-buttons .dim-btn').forEach(function(b){ b.classList.remove('active'); });
          this.classList.add('active');
          buildCatBar(this.dataset.field);
          ev.stopPropagation();
        });
      });
    }
  })();

  const labels = [{% for d in labels %}'{{ d }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const data = [{% for v in serie_valo %}{{ v|default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}];
  const movs = [{% for v in serie_mov_cum %}{{ v|default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}];
  const movsRaw = [{% for v in serie_mov_raw %}{{ v|default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}];
  const ctx = document.getElementById('valoChart').getContext('2d');
  const normLabels = labels.map(d => (d||'').toString().slice(0,10));
  const parsedDates = normLabels.map(d => new Date(d));
  const primaryColorValo = (getComputedStyle(document.documentElement).getPropertyValue('--primary')||'').trim() || '#1d4ed8';
  function euro(v){ try{ return (Number(v)||0).toLocaleString('fr-FR')+' \u20AC'; }catch(e){ return v; } }
  function yearAt(index){
    const d = parsedDates[index];
    return (d && !isNaN(d.getTime())) ? d.getFullYear() : null;
  }
  new Chart(ctx, {
    type: 'line',
    data: { labels: normLabels, datasets: [
      {
        label: 'Valorisation',
        data,
        borderColor: primaryColorValo,
        backgroundColor: 'transparent',
        fill: false,
        pointRadius: 0,
        pointHoverRadius: 0
      },
      {
        label: 'Cumul mouvements',
        data: movs,
        borderColor: '#ff6b6b',
        fill: false,
        pointRadius: 0,
        pointHoverRadius: 0
      },
      {
        label: 'Zone verte',
        data: data.map((v, i) => (v >= movs[i] ? v : null)),
        borderColor: 'transparent',
        backgroundColor: 'rgba(34, 197, 94, 0.16)',
        fill: { target: 1 },
        pointRadius: 0,
        pointHoverRadius: 0
      },
      {
        label: 'Zone rouge',
        data: data.map((v, i) => (v < movs[i] ? v : null)),
        borderColor: 'transparent',
        backgroundColor: 'rgba(239, 68, 68, 0.16)',
        fill: { target: 1 },
        pointRadius: 0,
        pointHoverRadius: 0
      },
    ] },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        x: {
          ticks: {
            autoSkip: false,
            maxRotation: 0,
            callback: (val, idx) => {
              const y = yearAt(idx);
              const prev = yearAt(idx - 1);
              return y && y !== prev ? String(y) : '';
            }
          },
          grid: {
            color: (ctx) => {
              const y = yearAt(ctx.index);
              const prev = yearAt(ctx.index - 1);
              return y && y !== prev ? 'rgba(0,0,0,0.35)' : 'rgba(0,0,0,0.08)';
            },
            lineWidth: (ctx) => {
              const y = yearAt(ctx.index);
              const prev = yearAt(ctx.index - 1);
              return y && y !== prev ? 2 : 0.5;
            }
          }
        },
        y: { beginAtZero: false, ticks: { callback: (v)=> euro(v) } }
      },
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: function(context){
              const y = context.parsed.y;
              const idx = context.dataIndex;
              if (context.dataset.label === 'Cumul mouvements'){
                const delta = movsRaw[idx] || 0;
                return context.dataset.label+': '+euro(y)+' (\u0394 '+euro(delta)+')';
              }
              const diff = (data[idx] || 0) - (movs[idx] || 0);
              const tag = diff >= 0 ? 'Gain' : 'Perte';
              return [context.dataset.label+': '+euro(y), tag+': '+euro(Math.abs(diff))];
            }
          }
        }
      }
    }
  });
  // Graphique SRRI + performance (double courbe)
  (function(){
    const yearsClient = {{ years_client | tojson }};
    const annVolClient = {{ ann_vol_client | tojson }};
    const annPerfClient = {{ ann_perf_client | tojson }};
    const el = document.getElementById('clientSrriChart');
    if (!el) return;
    const srriColor = '#ff6b6b';
    const srriBandColor = 'rgba(255, 107, 107, 0.12)';
    function normalizeVol(value){
      if (value === null || typeof value === 'undefined') return null;
      const str = typeof value === 'string' ? value.replace(',', '.') : value;
      let n = Number(str);
      if (!isFinite(n)) return null;
      if (Math.abs(n) > 1) n = n / 100;
      return n;
    }
    function srriFromVol(vol){
      if (vol === null) return null;
      const v = Math.abs(vol);
      const buckets = [
        { min: 0.0000, max: 0.0050, base: 1 },
        { min: 0.0050, max: 0.0200, base: 2 },
        { min: 0.0200, max: 0.0500, base: 3 },
        { min: 0.0500, max: 0.1000, base: 4 },
        { min: 0.1000, max: 0.1500, base: 5 },
        { min: 0.1500, max: 0.2500, base: 6 },
        { min: 0.2500, max: Infinity, base: 8 }
      ];
      for (const bucket of buckets){
        if (v < bucket.max || bucket.max === Infinity){
          if (bucket.max === Infinity || bucket.max <= bucket.min) return bucket.base;
          const span = bucket.max - bucket.min;
          if (span <= 0) return bucket.base;
          const ratio = Math.min(Math.max((v - bucket.min) / span, 0), 0.99);
          if (!isFinite(ratio)) return bucket.base;
          const value = bucket.base + ratio;
          if (!isFinite(value)) return bucket.base;
          return +Math.min(value, 8).toFixed(2);
        }
      }
      return null;
    }
    const srriSeries = (annVolClient||[]).map(v=> srriFromVol(normalizeVol(v)));
    const perfSeries = (annPerfClient||[]).map(v=>{
      let n = Number(v);
      if (!isFinite(n)) return null;
      if (Math.abs(n) <= 1) n *= 100;
      return +n.toFixed(2);
    });
    if (!srriSeries.some(v=> v !== null) && !perfSeries.some(v=> v !== null)) return;
    const ctx = el.getContext('2d');
    const srriBandsPlugin = {
      id: 'srriBands',
      beforeDraw(chart){
        const yAxis = chart.scales.y2;
        const chartArea = chart.chartArea;
        if (!yAxis || !chartArea) return;
        const ctxPlugin = chart.ctx;
        const ranges = [
          { from: 1, to: 2 },
          { from: 3, to: 4 },
          { from: 5, to: 6 },
          { from: 7, to: 8 }
        ];
        ctxPlugin.save();
        ctxPlugin.fillStyle = srriBandColor;
        ranges.forEach(range => {
          const yTop = yAxis.getPixelForValue(range.to);
          const yBottom = yAxis.getPixelForValue(range.from);
          if (Number.isFinite(yTop) && Number.isFinite(yBottom)) {
            ctxPlugin.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBottom - yTop);
          }
        });
        {% if client_srri is not none %}
        const clientSrri = {{ client_srri | int }};
        const srriLevels = [clientSrri, clientSrri + 1];
        srriLevels.forEach(level => {
          if (level < 1 || level > 8) return;
          const yLine = yAxis.getPixelForValue(level);
          if (Number.isFinite(yLine)) {
            ctxPlugin.strokeStyle = srriColor;
            ctxPlugin.lineWidth = 2;
            ctxPlugin.setLineDash(level === clientSrri ? [6,4] : [4,6]);
            ctxPlugin.beginPath();
            ctxPlugin.moveTo(chartArea.left, yLine);
            ctxPlugin.lineTo(chartArea.right, yLine);
            ctxPlugin.stroke();
          }
        });
        ctxPlugin.setLineDash([]);
        {% endif %}
        ctxPlugin.restore();
      }
    };
    const perfColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#1d4ed8';
    const labelPlugin = {
      id: 'perfLabels',
      afterDatasetsDraw(chart){
        const { ctx, data } = chart;
        const meta = chart.getDatasetMeta(1); // perf dataset index 1 below
        if (!meta || !meta.data) return;
        ctx.save();
        ctx.fillStyle = perfColor;
        ctx.font = '12px sans-serif';
        meta.data.forEach((bar, idx)=>{
          const value = data.datasets[1].data[idx];
          if (value === null || typeof value === 'undefined') return;
          const label = Number(value).toFixed(2)+' %';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.fillText(label, bar.x, bar.y - 4);
        });
        ctx.restore();
      }
    };
    const srriTicksMidPlugin = {
      id: 'srriTicksMid',
      afterDraw(chart){
        const yScale = chart.scales?.y2;
        const area = chart.chartArea;
        if (!yScale || !area) return;
        const ctx = chart.ctx;
        const mids = [1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5];
        ctx.save();
        ctx.fillStyle = srriColor;
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        // Place labels just inside the right axis to avoid clipping
        const x = Math.min(yScale.left - 6, area.right - 6);
        mids.forEach((v, idx)=>{
          const y = yScale.getPixelForValue(v);
          if (!Number.isFinite(y)) return;
          ctx.fillText(String(idx + 1), x, y);
        });
        ctx.restore();
      }
    };
    const chart = new Chart(ctx, {
      plugins: [srriBandsPlugin, srriTicksMidPlugin, labelPlugin],
      data: {
        labels: (yearsClient||[]).map(String),
        datasets: [
          { type:'line', label: 'SRRI moyen', data: srriSeries, borderColor: srriColor, backgroundColor: srriBandColor, fill: false, tension: 0.25, pointRadius: 4, pointHoverRadius: 5, spanGaps: true, yAxisID: 'y2', order: 1 },
          { type:'bar', label: 'Perf annuelle (%)', data: perfSeries, borderColor: perfColor, backgroundColor: 'rgba(37, 99, 235, 0.35)', borderWidth: 1, yAxisID: 'y', order: 2 }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            position: 'left',
            ticks: { callback: v => v + ' %' },
            grid: {
              color: (ctx) => ctx.tick?.value === 0 ? '#1f2937' : 'rgba(0,0,0,0)',
              lineWidth: (ctx) => ctx.tick?.value === 0 ? 2 : 0,
              drawTicks: false
            }
          },
          y2: {
            position: 'right',
            min: 1,
            max: 8,
            ticks: { display: false, stepSize: 1 },
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'SRRI', color: srriColor },
            border: { color: srriColor }
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: ctx => {
                const value = Number(ctx.parsed.y);
                if (ctx.dataset.yAxisID === 'y2') {
                  if (!isFinite(value)) return 'SRRI: n/a';
                  return 'SRRI: ' + value.toFixed(2);
                }
                if (!isFinite(value)) return 'Perf: n/a';
                return 'Perf: ' + value.toFixed(2) + ' %';
              }
            }
          }
        }
      }
    });
  })();

  // Graphique allocations (lignes) avec sélection et échelle ajustée
  (function(){
    // Couleur par défaut pour Chart.js (axes/labels) = bleu CSS
    try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
    const allocSeries = {{ alloc_series | tojson }};
    const clientSicav = {{ client_sicav | tojson }};
    const sel = document.getElementById('allocSelectClient');
    const defaultAllocRaw = {{ (
      (client_allocation_name if client_allocation_name else None)
      or allocation_reference_name
      or (risque_latest.allocation_nom if risque_latest and risque_latest.allocation_nom else (risque_snapshot.allocation_nom if risque_snapshot and risque_snapshot.allocation_nom else ''))
      or (client_allocation_id and (allocations_lookup.get(client_allocation_id) if allocations_lookup is defined else None))
    )|tojson }};
    let defaultAlloc = defaultAllocRaw ? String(defaultAllocRaw).trim() : '';
    // Si le select des allocations est absent, ne pas bloquer le reste du script
    if (!sel) return;
    // Remplir le sélecteur
    let hasDefault = false;
    Object.keys(allocSeries||{}).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
      if (defaultAlloc && name.trim().toLowerCase() === defaultAlloc.toLowerCase()){
        hasDefault = true;
        // normaliser sur la valeur présente dans la série
        defaultAlloc = name;
      }
    });
    if (defaultAlloc && !hasDefault){
      const opt = document.createElement('option');
      opt.value = defaultAlloc;
      opt.textContent = defaultAlloc + ' (sans données)';
      opt.dataset.missing = '1';
      sel.appendChild(opt);
    }
    function resetAllocToDefault(){
      if (!sel) return;
      let target = null;
      if (defaultAlloc){
        target = Array.from(sel.options).find(o => (o.value||'').toLowerCase() === defaultAlloc.toLowerCase());
      }
      if (target){
        sel.value = target.value;
      } else if (sel.options.length){
        sel.selectedIndex = 0;
      }
      drawAlloc(sel.value ? [sel.value] : []);
    }
    const resetBtn = document.getElementById('allocResetBtnClient');
    if (resetBtn){
      resetBtn.addEventListener('click', resetAllocToDefault);
    }
    function toMap(arr){ const m = new Map(); (arr||[]).forEach(p=>{ if(p&&p.date!=null){ m.set(String(p.date).slice(0,10), parseFloat(p.sicav)); } }); return m; }
    const clientMap = toMap(clientSicav);
    // Intersect dates across selected allocations and client
    function buildLabels(selected){
      function toSetDates(name){ const s=new Set(); (allocSeries[name]||[]).forEach(p=>{ if(p&&p.date) s.add(String(p.date).slice(0,10)); }); return s; }
      // start with client dates
      let allowed = new Set(Array.from(clientMap.keys()));
      (selected||[]).forEach(name=>{
        const s = toSetDates(name);
        const inter = new Set();
        allowed.forEach(d=>{ if (s.has(d)) inter.add(d); });
        allowed = inter;
      });
      return Array.from(allowed).sort();
    }
    // Filtre de période basé sur la dernière date disponible (fin de série), pas sur aujourd'hui
    function filterRangeByEnd(labels, range){
      if (range==='all') return labels;
      const n = parseInt(range, 10);
      if (!isFinite(n) || !labels.length) return labels;
      // Prendre la dernière date visible comme date de fin
      const end = new Date(labels[labels.length - 1]);
      const start = new Date(end);
      start.setDate(start.getDate() - n);
      return labels.filter(d => new Date(d) >= start && new Date(d) <= end);
    }
    function normalize(map, labels){
      if (!labels.length) return [];
      // base = première valeur non nulle/non NaN de la période
      let base = null;
      for (let i=0;i<labels.length;i++){ const v = map.get(labels[i]); if (isFinite(v) && v!==0){ base = v; break; } }
      if (base === null) base = 1; // fallback
      return labels.map(d => { const v = map.get(d); return isFinite(v) ? +(v/base*100).toFixed(2) : null; });
    }
    const allocColor = '#ff6b6b';
    const portfolioColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6';
    let chartAlloc;
    let currentRange = 'all';
    function drawAlloc(selected){
      if (chartAlloc) { chartAlloc.destroy(); chartAlloc = null; }
      if (!selected || !selected.length) return;
      let labels = buildLabels(selected);
      labels = filterRangeByEnd(labels, currentRange);
      if (!labels.length) return;
      const datasets = [];
      let allVals = [];
      const name = selected[0];
      const allocMap = toMap(allocSeries[name]);
    const allocData = normalize(allocMap, labels);
    const clientData = normalize(clientMap, labels);
      allVals = allVals.concat(allocData.filter(v=> v!=null && isFinite(v)), clientData.filter(v=> v!=null && isFinite(v)));
      datasets.push({ label: name+' (base 100)', data: allocData, borderColor: allocColor, fill:false, pointRadius:0, pointHoverRadius:0 });
      datasets.push({
        label: 'Portefeuille (base 100)',
        data: clientData,
        borderColor: portfolioColor,
        backgroundColor: 'transparent',
        fill: false,
        pointRadius:0,
        pointHoverRadius:0
      });
      if (!allVals.length) return;
      const min = Math.min.apply(null, allVals);
      const max = Math.max.apply(null, allVals);
      const pad = ((max - min) || 1) * 0.1;
      const ctxA = document.getElementById('clientAllocChart').getContext('2d');
      const areaFillPlugin = {
        id: 'allocFill',
        beforeDatasetsDraw(chart){
          const metaAlloc = chart.getDatasetMeta(0);
          const metaPort = chart.getDatasetMeta(1);
          if (!metaAlloc || !metaPort || !metaAlloc.data || !metaPort.data) return;
          const len = Math.min(metaAlloc.data.length, metaPort.data.length);
          const ctx = chart.ctx;
          ctx.save();
          for (let i=0; i < len - 1; i++){
            const a0 = metaAlloc.data[i], a1 = metaAlloc.data[i+1];
            const p0 = metaPort.data[i], p1 = metaPort.data[i+1];
            if (!a0 || !a1 || !p0 || !p1) continue;
            const v0 = p0.$context.raw, v1 = p1.$context.raw;
            const b0 = a0.$context.raw, b1 = a1.$context.raw;
            if (!isFinite(v0) || !isFinite(v1) || !isFinite(b0) || !isFinite(b1)) continue;
            const sign = ((v0 + v1) / 2) - ((b0 + b1) / 2);
            ctx.fillStyle = sign >= 0 ? 'rgba(34, 197, 94, 0.18)' : 'rgba(239, 68, 68, 0.28)';
            ctx.beginPath();
            ctx.moveTo(a0.x, a0.y);
            ctx.lineTo(a1.x, a1.y);
            ctx.lineTo(p1.x, p1.y);
            ctx.lineTo(p0.x, p0.y);
            ctx.closePath();
            ctx.fill();
          }
          ctx.restore();
        }
      };
    const years = labels.map(d => d.slice(0,4));
    const xIndexes = labels.map((_, i) => i);
    const yearBlocks = [];
    let startIdx = 0;
    for (let i = 1; i <= years.length; i++) {
      if (i === years.length || years[i] !== years[i-1]) {
        const endIdx = i - 1;
        const centerIdx = Math.floor((startIdx + endIdx) / 2);
        yearBlocks.push({ year: years[i-1], start: startIdx, end: endIdx, center: centerIdx });
        startIdx = i;
      }
    }
    const yearLines = new Set(yearBlocks.map(b => b.start));
    const yearCenters = new Map(yearBlocks.map(b => [b.center, b.year]));

    chartAlloc = new Chart(ctxA, {
      type: 'line',
      plugins: [areaFillPlugin],
      data: { labels: xIndexes, datasets },
      options: {
        responsive:true,
        interaction:{ mode:'index', intersect:false },
        scales:{
          y:{ suggestedMin: min - pad, suggestedMax: max + pad },
          x:{
            type:'category',
            labels: xIndexes,
            ticks:{
              autoSkip: false,
              callback: function(val){ return yearCenters.has(val) ? yearCenters.get(val) : ''; },
              maxRotation:0, minRotation:0, align:'center'
            },
            grid:{
              drawOnChartArea:true,
              color: function(ctx){ return yearLines.has(ctx.index) ? '#000' : 'rgba(0,0,0,0.05)'; },
              lineWidth: function(ctx){ return yearLines.has(ctx.index) ? 2 : 1; }
            }
          }
        },
        plugins:{
          legend:{ display:true },
          tooltip:{ callbacks:{ label:function(ctx){ const y = ctx.parsed.y; const idx = ctx.dataIndex; const port = clientData[idx] || 0; const alloc = allocData[idx] || 0; const delta = port - alloc; if (ctx.datasetIndex === 0){ return ctx.dataset.label+': '+(isFinite(y)?y.toFixed(2):''); } const tag = delta >= 0 ? 'Gain' : 'Perte'; return [ctx.dataset.label+': '+(isFinite(y)?y.toFixed(2):''), tag+': '+(isFinite(delta)?delta.toFixed(2):'')]; } } }
        }
      }
    });
    }
    sel.addEventListener('change', function(){
      const selected = this.value ? [this.value] : [];
      drawAlloc(selected);
    });
    document.querySelectorAll('.rangeBtn').forEach(btn => btn.addEventListener('click', function(){ currentRange = this.dataset.range || 'all'; const selected = sel.value ? [sel.value] : []; drawAlloc(selected); }));
    // Sélection par défaut : allocation type du client si disponible, sinon première
    (function(){
      let target = defaultAlloc || '';
      if (target){
        for (let i=0; i<sel.options.length; i++){
          if (sel.options[i].value === target){ sel.selectedIndex = i; break; }
        }
      }
      if (!sel.value && sel.options.length){ sel.selectedIndex = 0; }
      if (sel.value){ drawAlloc([sel.value]); }
    })();
  })();

  // Simulation financière: somme des répartitions
  (function(){
    const table = document.getElementById('simuAllocTable');
    const sumEl = document.getElementById('simuAllocSum');
    const resetBtn = document.getElementById('simuAllocResetBtn');
    const sqlEl = document.getElementById('simuAllocSql');
    const srriChartCtx = document.getElementById('simuAllocSrriChart')?.getContext('2d');
    const summaryEl = document.getElementById('simuAllocSummary');
    const dataJsonEl = document.getElementById('simuAllocDataJson');
    const exportBtn = document.getElementById('simuAllocExportCsv');
    let srriChart = null;
    const allocSeriesData = {{ alloc_series | tojson }};
    const clientSeriesData = {{ client_sicav | tojson }};
    if (!table || !sumEl) return;
    function defaultValue(inp){
      const tr = inp.closest('tr');
      const alloc = tr ? (tr.getAttribute('data-alloc')||'') : '';
      const init = {{ allocation_simulation_rows|tojson }};
      const found = (init||[]).find(r => (r.nom||'').toLowerCase() === alloc.toLowerCase());
      return found ? (parseFloat(found.poids_pct)||0) : 0;
    }
    function parseWeight(inp){
      if (!inp) return NaN;
      const raw = (inp.value||'').replace(',', '.');
      const num = parseFloat(raw);
      return isFinite(num) ? num : NaN;
    }
    function normalizeName(n){ return (n||'').trim().toLowerCase(); }
    function findSeriesName(name){
      const target = normalizeName(name);
      if (!target) return null;
      const keys = Object.keys(allocSeriesData||{});
      return keys.find(k => normalizeName(k) === target) || null;
    }
    function parseSeriesMap(){
      const cache = {};
      return function(name){
        const key = findSeriesName(name);
        if (!key) return new Map();
        if (cache[key]) return cache[key];
        const arr = allocSeriesData && allocSeriesData[key] ? allocSeriesData[key] : [];
        const m = new Map();
        (arr||[]).forEach(p=>{
          if (!p) return;
          const d = (p.date || '').slice(0,10);
          const v = parseFloat(p.sicav);
          if (!d || !isFinite(v)) return;
          m.set(d, v);
        });
        cache[key] = m;
        return m;
      };
    }
    function buildClientMap(){
      const m = new Map();
      (clientSeriesData||[]).forEach(p=>{
        if (!p) return;
        const d = (p.date || '').slice(0,10);
        const v = parseFloat(p.sicav);
        if (!d || !isFinite(v)) return;
        m.set(d, v);
      });
      return m;
    }
    const clientMap = buildClientMap();
    const getSeriesMap = parseSeriesMap();
    function formatPct(v){
      if (!isFinite(v)) return '—';
      return v.toFixed(2).replace('.', ',') + ' %';
    }
    function formatNum(v){
      if (!isFinite(v)) return '—';
      try{
        return new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v);
      }catch(_e){
        return v.toFixed(2).replace('.', ',');
      }
    }
    function srriFromVol(vol){
      if (!isFinite(vol)) return null;
      if (vol <= 0.5) return 1;
      if (vol <= 2) return 2;
      if (vol <= 5) return 3;
      if (vol <= 10) return 4;
      if (vol <= 15) return 5;
      if (vol <= 25) return 6;
      return 7;
    }
    function sampleStd(values){
      if (!values || values.length < 2) return null;
      const n = values.length;
      const mean = values.reduce((s,v)=>s+v,0)/n;
      const variance = values.reduce((s,v)=>s + Math.pow(v-mean,2),0)/(n-1);
      const res = Math.sqrt(variance);
      return isFinite(res) ? res : null;
    }
    function allAllocNames(){
      const names = [];
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const nm = (tr.getAttribute('data-alloc')||'').trim() || (tr.cells[0]?.textContent||'').trim();
        if (nm){ names.push(nm); }
      });
      return names;
    }
    function selectedAllocNames(){
      const names = [];
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const inp = tr.querySelector('input.simu-weight');
        const val = parseWeight(inp);
        if (!isFinite(val) || val <= 0) return;
        const nm = (tr.getAttribute('data-alloc')||'').trim() || (tr.cells[0]?.textContent||'').trim();
        if (nm){ names.push(nm); }
      });
      return names;
    }
    function allocWeights(){
      const res = [];
      table.querySelectorAll('tbody tr').forEach(tr=>{
        const nm = (tr.getAttribute('data-alloc')||'').trim() || (tr.cells[0]?.textContent||'').trim();
        const w = parseWeight(tr.querySelector('input.simu-weight'));
        if (!nm) return;
        res.push({ name: nm, weight: isFinite(w) ? w : 0 });
      });
      return res;
    }
    function intersectDates(names){
      let allowed = null;
      names.forEach(n=>{
        const label = (typeof n === 'string') ? n : (n.display || n.key || '');
        const m = getSeriesMap(label);
        const dates = Array.from(m.keys());
        if (allowed === null){
          allowed = new Set(dates);
        } else {
          const inter = new Set();
          allowed.forEach(d=>{ if (m.has(d)) inter.add(d); });
          allowed = inter;
        }
      });
      if (clientMap.size){
        const clientDates = new Set(Array.from(clientMap.keys()));
        if (allowed === null){
          allowed = clientDates;
        } else {
          const inter = new Set();
          allowed.forEach(d=>{ if (clientDates.has(d)) inter.add(d); });
          allowed = inter;
        }
      }
      return allowed ? Array.from(allowed).sort() : [];
    }
    function computeResults(){
      const weights = allocWeights();
      const sel = selectedAllocNames();
      const baseNames = sel.length ? sel : allAllocNames();
      if (!baseNames.length) return [];
      const weightMap = new Map(weights.map(w => [w.name.toLowerCase(), w.weight]));
      const names = baseNames
        .map(n => ({ display: n, key: findSeriesName(n), norm: normalizeName(n) }))
        .filter(n => n.key);
      if (!names.length) return [];
      let dates = intersectDates(names);
      if (!dates.length) return [];
      // Prendre les 160 dernières dates communes (comme la requête), puis re-trier ascendant
      dates = dates.slice(-160);
      const rows = [];
      const weightLookup = {};
      names.forEach(n => { weightLookup[n.key] = weightMap.has(n.norm) ? weightMap.get(n.norm) : 0; });
      dates.forEach(d=>{
        let valo = 0;
        const clientValo = clientMap.has(d) ? clientMap.get(d) : null;
        for (const n of names){
          const v = getSeriesMap(n.display).get(d);
          if (!isFinite(v)) { valo = null; break; }
          const w = weightLookup[n.key] || 0;
          valo += v * (w/100);
        }
        if (valo === null || !isFinite(valo)) return;
        rows.push({ date: d, valo, clientValo: isFinite(clientValo) ? clientValo : null });
      });
      // Perf hebdo
      for (let i=0; i<rows.length; i++){
        const prev = rows[i-1] ? rows[i-1].valo : null;
        if (prev === null || prev === undefined || !isFinite(prev) || prev === 0){
          rows[i].perf = null;
        } else {
          rows[i].perf = ((rows[i].valo / prev) - 1) * 100;
        }
        const prevClient = rows[i-1] ? rows[i-1].clientValo : null;
        if (prevClient === null || prevClient === undefined || !isFinite(prevClient) || prevClient === 0){
          rows[i].clientPerf = null;
        } else {
          const cv = rows[i].clientValo;
          rows[i].clientPerf = (isFinite(cv) ? ((cv / prevClient) - 1) * 100 : null);
        }
      }
      // Vol glissante 52s (nécessite 52 perfs non null/finies)
      for (let i=0; i<rows.length; i++){
        const start = Math.max(0, i - 51);
        const slice = rows.slice(start, i+1).map(r => r.perf).filter(v => isFinite(v));
        if (slice.length < 52){
          rows[i].vol = null;
        } else {
          const std = sampleStd(slice);
          rows[i].vol = isFinite(std) ? std * Math.sqrt(52) : null; // annualisée
        }
        rows[i].srri = srriFromVol(rows[i].vol);
      }
      return rows;
    }
    function buildSqlLiteral(){
      const weights = allocWeights();
      const sel = selectedAllocNames();
      const baseNames = sel.length ? sel : allAllocNames();
      if (!baseNames.length){
        return '-- aucune allocation sélectionnée';
      }
      const weightMap = new Map(weights.map(w => [normalizeName(w.name), w.weight]));
      const base = baseNames.map(n => {
        const w = weightMap.has(normalizeName(n)) ? weightMap.get(normalizeName(n)) : 0;
        return { name: n, weight: w };
      });
      const quoted = base.map(n => "'" + String(n.name).replace(/'/g, "''") + "'").join(', ');
      const count = base.length;
      const weightCases = base.map(n => {
        const frac = isFinite(n.weight) ? (n.weight / 100) : 0;
        return `WHEN a.nom = '${String(n.name).replace(/'/g, "''")}' THEN ${frac.toFixed(8)}`;
      }).join("\n         ");
      return [
        "WITH dates AS (",
        "  SELECT DATE(date) AS d",
        "  FROM allocations",
        "  WHERE nom IN (" + quoted + ")",
        "  GROUP BY d",
        "  HAVING COUNT(DISTINCT nom) = " + count,
        "  ORDER BY d DESC",
        "  LIMIT 160",
        "),",
        "data AS (",
        "  SELECT DATE(a.date) AS d, a.nom, COALESCE(a.sicav, 0) AS vl",
        "  FROM allocations a",
        "  WHERE a.nom IN (" + quoted + ")",
        "),",
        "agg AS (",
        "  SELECT d,",
        "         SUM(vl * CASE",
        "         " + weightCases,
        "         ELSE 0 END) AS valo_ponderee",
        "  FROM data a",
        "  WHERE d IN (SELECT d FROM dates)",
        "  GROUP BY d",
        "),",
        "perf AS (",
        "  SELECT",
        "    d,",
        "    valo_ponderee,",
        "    CASE",
        "      WHEN LAG(valo_ponderee) OVER (ORDER BY d) IS NULL THEN NULL",
        "      WHEN LAG(valo_ponderee) OVER (ORDER BY d) = 0 THEN NULL",
        "      ELSE ((valo_ponderee / LAG(valo_ponderee) OVER (ORDER BY d)) - 1) * 100",
        "    END AS perf_hebdo_pct",
        "  FROM agg",
        "),",
        "final AS (",
        "  SELECT",
        "    d,",
        "    valo_ponderee,",
        "    perf_hebdo_pct,",
        "    CASE",
        "      WHEN COUNT(perf_hebdo_pct) OVER (ORDER BY d ROWS BETWEEN 51 PRECEDING AND CURRENT ROW) < 52 THEN NULL",
        "      ELSE STDDEV_SAMP(perf_hebdo_pct) OVER (ORDER BY d ROWS BETWEEN 51 PRECEDING AND CURRENT ROW) * SQRT(52)",
        "    END AS vol_52s_pct",
        "  FROM perf",
        ")",
        "SELECT",
        "  d,",
        "  valo_ponderee,",
        "  perf_hebdo_pct,",
        "  vol_52s_pct,",
        "  CASE",
        "    WHEN vol_52s_pct IS NULL THEN NULL",
        "    WHEN vol_52s_pct <= 0.5 THEN 1",
        "    WHEN vol_52s_pct <= 2 THEN 2",
        "    WHEN vol_52s_pct <= 5 THEN 3",
        "    WHEN vol_52s_pct <= 10 THEN 4",
        "    WHEN vol_52s_pct <= 15 THEN 5",
        "    WHEN vol_52s_pct <= 25 THEN 6",
        "    ELSE 7",
        "  END AS srri_niveau",
        "FROM final",
        "ORDER BY d;"
      ].join("\n");
    }
    function toCsv(rows){
      if (!rows || !rows.length) return '';
      const headers = ['date','valo','perf','vol','srri'];
      const lines = [headers.join(';')];
      rows.forEach(r=>{
        lines.push([r.date || '', r.valo ?? '', r.perf ?? '', r.vol ?? '', r.srri ?? ''].join(';'));
      });
      return lines.join('\n');
    }
    function renderResults(){
      const rows = computeResults();
      const firstIdx = rows.findIndex(r => isFinite(r.srri) && r.srri !== 1);
      const plotRows = firstIdx > 0 ? rows.slice(firstIdx) : rows;
      if (dataJsonEl){ dataJsonEl.textContent = JSON.stringify(rows, null, 2); }
      // Summary vol/srri over last 12 months (based on last date)
      if (summaryEl){
        let summaryTxt = '';
        if (rows.length){
          const lastDateStr = rows[rows.length - 1].date;
          const lastDate = lastDateStr ? new Date(lastDateStr) : null;
          if (lastDate && isFinite(lastDate.getTime())){
            const cutoff = new Date(lastDate);
            cutoff.setMonth(cutoff.getMonth() - 12);
            const vols = rows
              .filter(r => r.date && new Date(r.date) >= cutoff && isFinite(r.vol))
              .map(r => r.vol);
            if (vols.length){
              const avgVol = vols.reduce((s,v)=>s+v,0) / vols.length;
              const srriAvg = srriFromVol(avgVol);
              const volStr = avgVol.toFixed(2).replace('.', ',');
              summaryTxt = `Volatilité moyenne 12 mois : ${volStr} % – SRRI : ${srriAvg ?? '—'}`;
            }
          }
        }
        summaryEl.textContent = summaryTxt || 'Volatilité moyenne 12 mois : —';
      }
      if (exportBtn){
        exportBtn.onclick = function(){
          const csv = toCsv(rows);
          const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'simulation_srris.csv';
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); document.body.removeChild(a); }, 100);
        };
      }
      if (srriChartCtx){
        if (srriChart){ srriChart.destroy(); srriChart = null; }
        if (plotRows.length){
          const srriBandPlugin = {
            id: 'srriBand',
            beforeDatasetsDraw(chart){
              const ds = chart.data.datasets[0];
              if (!ds) return;
              const meta = chart.getDatasetMeta(0);
              const pts = meta?.data || [];
              const yScale = chart.scales?.y;
              const area = chart.chartArea;
              if (!yScale || !area) return;
              const ctx = chart.ctx;
              ctx.save();
              const fillColor = 'rgba(36,86,166,0.08)';
              for (let i=0; i<pts.length; i++){
                const p = pts[i];
                if (!p) continue;
                const raw = ds.data[i];
                const srri = parseFloat(raw);
                if (!isFinite(srri)) continue;
                const yTop = yScale.getPixelForValue(srri - 1);
                const yBottom = yScale.getPixelForValue(srri);
                const y1 = Math.min(yTop, yBottom);
                const y2 = Math.max(yTop, yBottom);
                const x1 = p.x;
                const x2 = (pts[i+1]?.x ?? area.right);
                ctx.fillStyle = fillColor;
                ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
              }
              ctx.restore();
            }
          };
          const srriLabelPlugin = {
            id: 'srriLabel',
            afterDraw(chart){
              const yScale = chart.scales?.y;
              const area = chart.chartArea;
              if (!yScale || !area) return;
              const ctx = chart.ctx;
              ctx.save();
              ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text') || '#111827';
              ctx.font = '12px sans-serif';
              ctx.textAlign = 'right';
              ctx.textBaseline = 'middle';
              for (let v = 1; v <= 7; v++){
                const yPos = yScale.getPixelForValue(v - 0.5);
                if (yPos < area.top || yPos > area.bottom) continue;
                ctx.fillText(String(v), area.left - 8, yPos);
              }
              ctx.restore();
            }
          };
          const clientPerfData = plotRows.map(r => isFinite(r.clientPerf) ? +r.clientPerf.toFixed(2) : null);
          const hasClientPerf = clientPerfData.some(v => v !== null && isFinite(v));
          const datasets = [
            {
              label: 'SRRI',
              data: plotRows.map(r => r.srri),
              borderColor: 'transparent',
              backgroundColor: 'transparent',
              fill: false,
              tension: 0,
              pointRadius: 0,
              stepped: true,
              yAxisID: 'y'
            },
            {
              label: 'Perf hebdo (%)',
              data: plotRows.map(r => isFinite(r.perf) ? +r.perf.toFixed(2) : null),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16,185,129,0.15)',
              fill: false,
              tension: 0.2,
              pointRadius: 0,
              spanGaps: true,
              yAxisID: 'y1'
            }
          ];
          if (hasClientPerf){
            datasets.push({
              label: 'Perf client (%)',
              data: clientPerfData,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249,115,22,0.15)',
              fill: false,
              tension: 0.2,
              pointRadius: 0,
              spanGaps: true,
              yAxisID: 'y1'
            });
          }
          srriChart = new Chart(srriChartCtx, {
            type: 'line',
            plugins: [srriBandPlugin, srriLabelPlugin],
            data: {
              labels: plotRows.map(r => r.date),
              datasets
            },
            options:{
              responsive:true,
              layout:{ padding:{ left:28 } },
              scales:{
                y:{
                  min: 0,
                  max: 7.5,
                  ticks:{
                    stepSize:1,
                    display:false
                  },
                  grid:{},
                  title:{ display:true, text:'SRRI' }
                },
                y1:{
                  position:'right',
                  grid:{ drawOnChartArea:false },
                  ticks:{
                    color:'#10b981',
                    callback:(v)=> (v?.toFixed ? v.toFixed(1) : v) + ''
                  },
                  title:{ display:true, text:'Perf hebdo (%)', color:'#10b981' },
                  border:{ color:'#10b981' }
                },
                x:{ ticks:{ maxRotation:0, minRotation:0, autoSkip:true, maxTicksLimit:6 } }
              },
              plugins:{ legend:{ display:true, position:'top', labels:{ boxWidth:12, usePointStyle:true } } }
            }
          });
        }
      }
      // Pas de second graphique SRRI client : on conserve uniquement la simulation SRRI/perf.
    }
    function updateSum(){
      let total = 0;
      table.querySelectorAll('input.simu-weight').forEach(inp=>{
        const v = parseWeight(inp);
        if (isFinite(v)) total += v;
      });
      sumEl.textContent = 'Somme des répartitions : ' + formatPct(total);
      sumEl.style.color = Math.abs(total - 100) < 0.01 ? 'var(--text-muted)' : '#dc2626';
      if (sqlEl){ sqlEl.textContent = buildSqlLiteral(); }
      renderResults();
    }
    // Afficher dès le chargement
    table.addEventListener('input', function(e){
      const inp = e.target.closest('input.simu-weight');
      if (!inp) return;
      updateSum();
    });
    if (resetBtn){
      resetBtn.addEventListener('click', function(){
        table.querySelectorAll('input.simu-weight').forEach(inp=>{
          const defVal = defaultValue(inp);
          inp.value = defVal.toFixed(2);
        });
        updateSum();
      });
    }
    updateSum();
  })();

  // --- ESG (client consolidé) Plotly horizontal bar: indice=100 vs client ---
  (function(){
    var allocSel = document.getElementById('esgAllocSelectClient');
    var allocDateSel = document.getElementById('esgAllocDateClient');
    var fieldsWrap = document.getElementById('esgFieldsClient');
    var refreshBtn = document.getElementById('esgRefreshBtnClient');
    var asOfSel = document.getElementById('asOfSelect');
    var unmatchedNotice = document.getElementById('esgUnmatchedNotice');
    var serverDefaultAlloc = {{ esg_comparison_alloc|tojson }};
    var graphDefaultAlloc = {{ (client_allocation_name or allocation_reference_name or (risque_latest.allocation_nom if risque_latest and risque_latest.allocation_nom else (risque_snapshot.allocation_nom if (risque_snapshot is defined and risque_snapshot and risque_snapshot.allocation_nom) else '')) or (client_allocation_id and (allocations_lookup.get(client_allocation_id) if allocations_lookup is defined else None)))|tojson }};
    var serverDefaultFields = {{ esg_default_fields|tojson }};
    var serverUnmatched = {{ esg_unmatched_fields|tojson }};
    var fieldLabels = {{ esg_field_labels|tojson }};
    var esgLastResults = [];
    var esgMatrixResults = [];
    var esgActiveGroup = 'exclusions';
    var esgSelectedExclusions = {{ esg_selected_exclusions|default([], true)|tojson }};
    var esgSelectedIndicators = {{ esg_selected_indicators|default([], true)|tojson }};
    var esgExclusionOptions = {{ esg_exclusion_options|default([], true)|tojson }};
    var esgIndicatorOptions = {{ esg_indicator_options|default([], true)|tojson }};
    var esgCurrent = {{ esg_current|default({}, true)|tojson }};
    var esgMatrixMappings = {
      exclusions: {
        "Fossiles / climat": ["exposure_to_fossil_fuels", "carbon_trend", "scope_1_and_2_carbon_intensity", "scope_3_carbon_intensity", "temperature_score"],
        "Climat / émissions": ["ghg_intensity_value", "temperature_score", "pollution__negative_revenue"],
        "Pollution / déchets": ["hazardous_waste", "pollution__negative_revenue", "pollution__positive_revenue", "waste_efficiency"],
        "Eau": ["avoiding_water_scarcity", "emissions_to_water", "water_efficiency"],
        "Social": ["social_harm", "social_good"],
        "Gouvernance / rémunération": ["executive_pay", "board_independence"],
        "Parité / diversité": ["board_gender_diversity", "pct_female_board", "pct_female_executives", "gender_pay_gap"]
      },
      indicateurs: {
        "Transition / énergie": ["renewable_energy", "carbon_trend", "temperature_score"],
        "Efficience carbone": ["scope_1_and_2_carbon_intensity", "scope_3_carbon_intensity", "ghg_intensity_value"],
        "Efficience matière": ["waste_efficiency", "hazardous_waste", "pollution__positive_revenue"],
        "Efficience eau": ["avoiding_water_scarcity", "water_efficiency", "emissions_to_water"],
        "Impact social": ["social_good", "social_harm"],
        "Gouvernance & diversité": ["board_independence", "board_gender_diversity", "pct_female_board", "pct_female_executives", "gender_pay_gap"],
        "RSE par tête": ["average_per_employee_spend"]
      }
    };
    var esgMatrixAllFields = (function(){
      var s = new Set();
      Object.values(esgMatrixMappings).forEach(function(group){
        Object.values(group).forEach(function(arr){ (arr||[]).forEach(function(f){ if(f) s.add(f); }); });
      });
      return Array.from(s);
    })();

    function renderEsgMatrix(group){
      esgActiveGroup = group || esgActiveGroup || 'exclusions';
      var container = esgActiveGroup === 'indicateurs' ? document.getElementById('esgMatrixIndicateurs') : document.getElementById('esgMatrixExclusions');
      var other = esgActiveGroup === 'indicateurs' ? document.getElementById('esgMatrixExclusions') : document.getElementById('esgMatrixIndicateurs');
      if (container) container.style.display = '';
      if (other) other.style.display = 'none';
      document.querySelectorAll('.esg-pill').forEach(function(btn){
        var g = btn.getAttribute('data-esg-group');
        btn.classList.toggle('active', g === esgActiveGroup);
      });
      var rows = Array.isArray(esgMatrixResults) && esgMatrixResults.length ? esgMatrixResults : (Array.isArray(esgLastResults) ? esgLastResults : []);
      var mapping = esgMatrixMappings[esgActiveGroup] || {};
      var htmlParts = [];
      Object.keys(mapping).forEach(function(theme){
        var fields = mapping[theme] || [];
        var matched = rows.filter(function(r){ return r && fields.indexOf(r.field) !== -1; });
        var block = '<div class="esg-matrix-item">';
        block += '<h5 style="margin:0 0 6px 0;">'+theme+'</h5>';
        if (!matched.length){
          block += '<div class="muted" style="font-size:0.9rem;">Aucune donnée pour ce thème</div>';
        } else {
          block += '<table class="esg-matrix-table"><thead><tr><th>Métriques</th><th class="esg-val">Delta</th></tr></thead><tbody>';
          matched.forEach(function(r){
            var label = (fieldLabels && fieldLabels[r.field]) || r.field_original || r.field;
            var deltaVal = (r.client != null && r.index != null) ? (Number(r.client) - Number(r.index)) : null;
            var deltaStr = deltaVal == null ? '—' : (deltaVal > 0 ? '+' : '') + deltaVal.toFixed(2);
            var deltaClass = 'esg-delta-neutral';
            if (deltaVal > 0.1) deltaClass = 'esg-delta-pos';
            else if (deltaVal < -0.1) deltaClass = 'esg-delta-neg';
            block += '<tr><td>'+label+'</td><td class="esg-val '+deltaClass+'">'+deltaStr+'</td></tr>';
          });
          block += '</tbody></table>';
        }
        block += '</div>';
        htmlParts.push(block);
      });
      if (container){
        container.innerHTML = htmlParts.length ? '<div class="esg-matrix-grid">'+htmlParts.join('')+'</div>' : '<div class="empty">Aucune métrique disponible.</div>';
      }
    }

    function renderEsgBlocks(){
      var data = Array.isArray(esgMatrixResults) && esgMatrixResults.length ? esgMatrixResults : esgLastResults;
      var dataByField = {};
      (data || []).forEach(function(r){
        if (r && r.field) dataByField[r.field] = r;
      });

      // Tags sélectionnés
      var sensTags = [];
      var selectedSensKeys = [];
      if (esgCurrent){
        Object.keys(esgSensibiliteLabels).forEach(function(k){
          var v = esgCurrent[k];
          if (v !== null && v !== undefined && String(v).trim() !== ''){
            selectedSensKeys.push(k);
            sensTags.push(esgSensibiliteLabels[k]);
          }
        });
      }
      document.getElementById('esgSensTags').innerHTML = sensTags.length ? sensTags.map(function(t){ return '<span class="tag">'+t+'</span>'; }).join('') : '<span class="empty">Aucune sensibilité renseignée</span>';

      var exclTags = [];
      var exclLookup = {};
      (esgExclusionOptions || []).forEach(function(o){ if (o && o.id !== undefined) exclLookup[o.id] = o; });
      (esgSelectedExclusions || []).forEach(function(id){
        var o = exclLookup[id];
        if (o){ exclTags.push(o.label || o.code || ('#'+id)); }
      });
      document.getElementById('esgExclTags').innerHTML = exclTags.length ? exclTags.map(function(t){ return '<span class="tag">'+t+'</span>'; }).join('') : '<span class="empty">Aucune exclusion sélectionnée</span>';

      var indicTags = [];
      var indicLookup = {};
      (esgIndicatorOptions || []).forEach(function(o){ if (o && o.id !== undefined) indicLookup[o.id] = o; });
      (esgSelectedIndicators || []).forEach(function(id){
        var o = indicLookup[id];
        if (o){ indicTags.push(o.label || o.code || ('#'+id)); }
      });
      document.getElementById('esgIndicTags').innerHTML = indicTags.length ? indicTags.map(function(t){ return '<span class="tag">'+t+'</span>'; }).join('') : '<span class="empty">Aucun indicateur sélectionné</span>';

      function buildTable(mapping, targetId, onlyIfTags){
        var container = document.getElementById(targetId);
        if (!container) return;
        if (onlyIfTags && onlyIfTags.length === 0){
          container.innerHTML = '<div class="empty">Aucune donnée</div>';
          return;
        }
        var htmlParts = [];
        Object.keys(mapping).forEach(function(theme){
          var fields = mapping[theme] || [];
          var matched = fields.map(function(f){ return dataByField[f]; }).filter(Boolean);
          if (!matched.length) return;
          var table = '<h5 style="margin:8px 0 4px;">'+theme+'</h5>';
          table += '<table class="esg-matrix-table"><thead><tr><th>Métrique</th><th class="esg-val">Indice</th><th class="esg-val">Client</th><th class="esg-val">Delta</th></tr></thead><tbody>';
          matched.forEach(function(r){
            var label = (fieldLabels && fieldLabels[r.field]) || r.field_original || r.field;
            var idx = r.index == null ? '—' : Number(r.index).toFixed(2);
            var cli = r.client == null ? '—' : Number(r.client).toFixed(2);
            var deltaVal = (r.client != null && r.index != null) ? (Number(r.client) - Number(r.index)) : null;
            var deltaStr = deltaVal == null ? '—' : (deltaVal > 0 ? '+' : '') + deltaVal.toFixed(2);
            var deltaClass = 'esg-delta-neutral';
            if (deltaVal > 0.1) deltaClass = 'esg-delta-pos';
            else if (deltaVal < -0.1) deltaClass = 'esg-delta-neg';
            table += '<tr><td>'+label+'</td><td class="esg-val">'+idx+'</td><td class="esg-val">'+cli+'</td><td class="esg-val '+deltaClass+'">'+deltaStr+'</td></tr>';
          });
          table += '</tbody></table>';
          htmlParts.push(table);
        });
        container.innerHTML = htmlParts.length ? htmlParts.join('') : '<div class="empty">Aucune métrique disponible.</div>';
      }

      buildTable(esgSensibiliteMap, 'esgSensTable', sensTags);
      buildTable(esgMatrixMappings.exclusions, 'esgExclTable', exclTags);
      buildTable(esgMatrixMappings.indicateurs, 'esgIndicTable', indicTags);
    }

    function setUnmatched(list){
      if (!unmatchedNotice) return;
      if (list && list.length){
        unmatchedNotice.textContent = 'Indicateurs introuvables : ' + list.join(', ');
        unmatchedNotice.style.display = '';
      } else {
        unmatchedNotice.textContent = '';
        unmatchedNotice.style.display = 'none';
      }
    }
    if (!allocSel || !fieldsWrap) return;

    setUnmatched(serverUnmatched);

    // Persist keys per client
    var keyAlloc = 'client_esg_alloc_{{ client.id }}';
    var keyFields = 'client_esg_fields_{{ client.id }}';
    var keyAllocDate = 'client_esg_alloc_date_{{ client.id }}';

    function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field-client.active')).map(b=> b.getAttribute('data-field')); }
    function updateSelection(btn){
      var sel = selectedFields();
      if (btn){
        if (btn.classList.contains('active')){ btn.classList.remove('active'); }
        else {
          if (sel.length >= 4) return; // max 4
          btn.classList.add('active');
        }
      }
    }
    fieldsWrap.addEventListener('click', function(e){
      var b=e.target.closest('.esg-field-client'); if(!b) return;
      updateSelection(b);
      try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
      drawESG();
    });

    function ensurePlotly(cb){ if (window.Plotly) { cb(); return; } var s=document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ cb(); }; document.head.appendChild(s); }
    function drawESG(){
      var fields = selectedFields();
      var alloc = allocSel.value || '';
      var allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
      var asOf = asOfSel && asOfSel.value ? asOfSel.value : '';
      if (!fields.length || !alloc){ return; }
      setUnmatched([]);
      ensurePlotly(function(){
        var url = `/dashboard/clients/{{ client.id }}/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'') + (asOf?`&as_of=${encodeURIComponent(asOf)}`:'') + (CL_MARKERS_SUFFIX || '');
        fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          var rows = (data && data.results) || [];
          setUnmatched((data && data.unmatched_fields) || []);
          var filtered = rows.filter(function(r){ return r && r.index != null && r.client != null; });
          var displayRows = filtered.length ? filtered : rows;
          var cats = displayRows.map(function(r){ return (fieldLabels && fieldLabels[r.field]) || r.field_original || r.field; });
          var idx = displayRows.map(r=> (r.index==null? null : Number(r.index)));
          var cli = displayRows.map(r=> (r.client==null? null : Number(r.client)));
          try {
            console.log('ESG client plot data', {
              url: url,
              alloc: alloc,
              allocDate: allocDate,
              asOf: asOf,
              fields: fields,
              categories: cats,
              indexValues: idx,
              clientValues: cli,
              rawResults: rows,
              filteredResults: displayRows
            });
          } catch(_){}
          var traces = [
            { x: idx, y: cats, type:'bar', orientation:'h', name:'Indice', marker:{ color:'#9ca3af' } },
            { x: cli, y: cats, type:'bar', orientation:'h', name:'Client', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
          ];
          var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
          var cfg = { displayModeBar: false, responsive: true };
          Plotly.react('esgChartClient', traces, layout, cfg);
          esgLastResults = rows || [];
          renderEsgMatrix(esgActiveGroup);
          renderEsgBlocks();
        }).catch(function(err){
          setUnmatched(serverUnmatched);
          try{ console.error('Client ESG fetch error', err); }catch(_){}
        });
      });
      // Charger toutes les métriques nécessaires à la matrice (indépendamment des 4 champs sélectionnés)
      var matrixUrl = `/dashboard/clients/{{ client.id }}/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(esgMatrixAllFields.join(','))}` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'') + (asOf?`&as_of=${encodeURIComponent(asOf)}`:'') + (CL_MARKERS_SUFFIX || '');
      fetch(matrixUrl).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
        esgMatrixResults = (data && data.results) || [];
        renderEsgMatrix(esgActiveGroup);
        renderEsgBlocks();
      }).catch(function(_err){
        // garder esgMatrixResults tel quel
      });
    }

    function loadAllocDates(preferred){
      if (!allocSel || !allocSel.value) { if (allocDateSel) allocDateSel.innerHTML=''; return; }
      fetch(`/dashboard/allocations/dates?name=${encodeURIComponent(allocSel.value)}`)
        .then(r=>r.json()).then(function(data){
          if (!allocDateSel) return;
          allocDateSel.innerHTML = '';
          var ds = (data && data.dates) || [];
          ds.forEach(function(d){ var o=document.createElement('option'); o.value=d; o.textContent=d; allocDateSel.appendChild(o); });
          var selected = false;
          if (preferred){
            for (var i=0;i<allocDateSel.options.length;i++){
              if (allocDateSel.options[i].value === preferred){ allocDateSel.selectedIndex = i; selected = true; break; }
            }
          }
          if (!selected && allocDateSel.options.length>0) allocDateSel.selectedIndex = 0;
          drawESG();
        }).catch(function(e){ try{ console.warn('alloc dates (client)', e);}catch(_){} });
    }

    // Persist selections
    allocSel.addEventListener('change', function(){
      try{ localStorage.setItem(keyAlloc, allocSel.value||''); }catch(_e){}
      try{ localStorage.removeItem(keyAllocDate); }catch(_e){}
      loadAllocDates();
    });
    if (allocDateSel) allocDateSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAllocDate, allocDateSel.value||''); }catch(_e){}; drawESG(); });
    if (asOfSel) asOfSel.addEventListener('change', drawESG);
    if (refreshBtn) refreshBtn.addEventListener('click', drawESG);
    document.querySelectorAll('.esg-pill').forEach(function(btn){
      btn.addEventListener('click', function(){
        var g = btn.getAttribute('data-esg-group');
        renderEsgMatrix(g || 'exclusions');
      });
    });
    // Initial render of blocks (empty state)
    renderEsgBlocks();

    // Init defaults
    (function init(){
      // Allocation
      try{
        var savedAlloc = '';
        try { savedAlloc = localStorage.getItem(keyAlloc) || ''; } catch(_e) {}
        var targetAlloc = graphDefaultAlloc || serverDefaultAlloc || '';
        var findIndexByValue = function(val){
          if (!val) return -1;
          for (var i=0;i<allocSel.options.length;i++){
            if (allocSel.options[i].value === val){ return i; }
          }
          return -1;
        };
        var targetIdx = findIndexByValue(targetAlloc);
        if (targetAlloc && targetIdx === -1){
          var opt = document.createElement('option');
          opt.value = targetAlloc;
          opt.textContent = targetAlloc;
          allocSel.insertBefore(opt, allocSel.firstChild);
          targetIdx = 0;
        }
        if (targetIdx === -1 && savedAlloc){
          targetAlloc = savedAlloc;
          targetIdx = findIndexByValue(targetAlloc);
        }
        if (targetIdx === -1 && targetAlloc){
          var optFallback = document.createElement('option');
          optFallback.value = targetAlloc;
          optFallback.textContent = targetAlloc;
          allocSel.appendChild(optFallback);
          targetIdx = allocSel.options.length - 1;
        }
        if (targetIdx === -1){
          for (var j=0;j<allocSel.options.length;j++){
            if (allocSel.options[j].value){
              targetIdx = j;
              targetAlloc = allocSel.options[j].value;
              break;
            }
          }
        }
        if (targetIdx >= 0){
          allocSel.selectedIndex = targetIdx;
          try{ localStorage.setItem(keyAlloc, targetAlloc); }catch(_e){}
        }
      }catch(_e){}
      // Fields
      try{
        var raw = localStorage.getItem(keyFields);
        var saved = [];
        if (raw){ try{ saved = JSON.parse(raw)||[]; }catch(_ee){ saved = []; } }
        var buttons = Array.from(fieldsWrap.querySelectorAll('.esg-field-client'));
        var buttonMap = new Map();
        buttons.forEach(b=> buttonMap.set(b.getAttribute('data-field'), b));
        buttons.forEach(b=> b.classList.remove('active'));
        var activeFields = (saved || []).filter(v=> buttonMap.has(v));
        if (!activeFields.length && Array.isArray(serverDefaultFields) && serverDefaultFields.length){
          activeFields = serverDefaultFields.filter(v=> buttonMap.has(v));
        }
        if (!activeFields.length){
          activeFields = buttons.slice(0,3).map(b=> b.getAttribute('data-field')).filter(Boolean);
        }
        activeFields = activeFields.slice(0,4);
        activeFields.forEach(f=> {
          var btn = buttonMap.get(f);
          if (btn) btn.classList.add('active');
        });
        try{ localStorage.setItem(keyFields, JSON.stringify(activeFields)); }catch(_e){}
      }catch(_e){}
      // Dates alloc: try restore
      var preferDate = ''; try{ preferDate = localStorage.getItem(keyAllocDate) || ''; }catch(_e){}
      if (allocSel && allocSel.value){ loadAllocDates(preferDate); } else { drawESG(); }
    })();
  })();
</script>

<!-- Modales Conformité (détail) -->
  <div class="modal-overlay" id="confConnaissanceDetailModal" onclick="if(event.target===this) closeConfConnaissanceDetail()">
    <div class="modal-card" style="width:960px; max-width:98vw; height:92vh; display:flex; flex-direction:column;">
      <div class="modal-header"><h3><i class="fa-solid fa-user-check" style="margin-right:8px;"></i>Connaissance client</h3><button class="modal-close" onclick="closeConfConnaissanceDetail()">✕</button></div>
      <div class="modal-body" style="padding:0; flex:1 1 auto;">
        <iframe src="/dashboard/clients/kyc/{{ client.id }}?open=knowledge&embed=1{{ cl_markers_suffix }}" style="width:100%; height:100%; border:0;"></iframe>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confEerDetailModal" onclick="if(event.target===this) this.style.display='none'">
  <div class="modal-card" style="width:760px; max-width:96vw;">
    <div class="modal-header">
      <h3><i class="fa-solid fa-file-signature" style="margin-right:8px;"></i>Entrée en relation</h3>
      <button type="button" class="btn btn-compact" style="margin-right:8px;" onclick="generateDerPdf()">
        <i class="fa-solid fa-file-pdf" style="margin-right:6px;"></i>Génération PDF
      </button>
      <button class="modal-close" onclick="document.getElementById('confEerDetailModal').style.display='none'">✕</button>
    </div>
    <div class="modal-body">
      <style>
        .der-section { margin-bottom: 14px; }
        .der-section h4 { margin: 0 0 6px; font-size: 1rem; }
        .der-list { margin: 0; padding-left: 18px; }
        .der-table { width: 100%; border-collapse: collapse; }
        .der-table th, .der-table td { border: 1px solid var(--border); padding: 6px 8px; font-size: .92rem; }
        .der-table th { background: var(--primary); color:#fff; text-align: left; }
        .muted-note { color: var(--muted); font-size: .9rem; }
      </style>
      <!-- DER (Document d’Entrée en Relation) panel -->
      <div id="eerDocPanelDetail">
        <div class="der-section">
          <h3 style="margin:0 0 8px;">DOCUMENT D’ENTRÉE EN RELATION (DER)</h3>
          <div class="muted-note">Conformément aux articles L.520-1 et suivants du Code des assurances et L.541-8-1 du Code monétaire et financier</div>
        </div>

        <div class="der-section">
          <h4>1. Identification du courtier</h4>
          {% set _cid = (DER_sql_params_activite[':cid'] if (DER_sql_params_activite is defined and DER_sql_params_activite and (':cid' in DER_sql_params_activite)) else (DER_courtier.id if DER_courtier else None)) %}
          <ul class="der-list">
            <li><strong>Dénomination sociale :</strong> {{ DER_courtier.nom_cabinet if DER_courtier else '' }}</li>
            <li><strong>Responsable :</strong> {{ DER_courtier.nom_responsable if DER_courtier else '' }}</li>
            <li><strong>Statut social :</strong> {{ DER_statut_social.lib if DER_statut_social else '' }}</li>
            <li><strong>Capital social :</strong> {% if DER_courtier and DER_courtier.capital_social is not none %}{{ '{:,.0f}'.format((DER_courtier.capital_social)|float).replace(',', ' ') }} €{% endif %}</li>
            <li><strong>SIREN :</strong> {{ DER_courtier.siren if DER_courtier else '' }}</li>
            <li><strong>RCS :</strong> {{ DER_courtier.rcs if DER_courtier else '' }}</li>
            <li><strong>Numéro ORIAS :</strong> {{ DER_courtier.numero_orias if DER_courtier else '' }}</li>
            <li><strong>Adresse :</strong> {{ DER_courtier.adresse_rue if DER_courtier else '' }}, {{ DER_courtier.adresse_cp if DER_courtier else '' }} {{ DER_courtier.adresse_ville if DER_courtier else '' }}</li>
            <li><strong>Courriel :</strong> {{ DER_courtier.courriel if DER_courtier else '' }}</li>
            <li><strong>Association professionnelle :</strong> {{ DER_courtier.association_prof if DER_courtier else '' }}{% if DER_courtier and DER_courtier.num_adh_assoc %} (adhérent n° {{ DER_courtier.num_adh_assoc }}){% endif %}</li>
            <li><strong>Catégorie de courtage :</strong> {{ DER_courtier.categorie_courtage if DER_courtier else '' }}</li>
          </ul>
        </div>

        <div class="der-section">
          <h4>2. Activités et domaines d’exercice</h4>
          {% if DER_activites and (DER_activites|length > 0) %}
            <table class="der-table">
              <thead>
                <tr>
                  <th>Domaine</th>
                  <th>Activité</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                {% for a in DER_activites %}
                <tr>
                  <td>{{ a.domaine or '' }}</td>
                  <td>{{ a.libelle or '' }}</td>
                  <td>{{ 'Exercée' if (a.statut or '')|lower == 'exercee' else 'Non exercée' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="muted-note">Aucune activité renseignée.</p>
          {% endif %}
        </div>

        <div class="der-section">
          <h4>3. Autorités de tutelle</h4>
          <ul class="der-list">
            <li><strong>AMF (Autorité des Marchés Financiers)</strong><br/>17, place de la Bourse – 75082 Paris Cedex 02</li>
            <li><strong>ACPR (Autorité de Contrôle Prudentiel et de Résolution)</strong><br/>61, rue Taitbout – 75436 Paris Cedex 09</li>
          </ul>
          <p class="muted-note">Ces autorités veillent au respect des obligations professionnelles du courtier.</p>
        </div>

        <div class="der-section">
          <h4>4. Nature et étendue du service</h4>
          <p>{{ DER_courtier.nom_cabinet if DER_courtier else '' }} agit en qualité de <strong>courtier indépendant</strong>.<br/>
          Son rôle est d’analyser <strong>vos besoins, vos objectifs et votre profil de risque</strong> afin de recommander les solutions adaptées.</p>
          <p>Le cabinet ne perçoit ni ne conserve de fonds destinés aux assureurs ou aux clients.</p>
        </div>

        <div class="der-section">
          <h4>5. Rémunération et frais</h4>
          <p>Le cabinet est rémunéré sous forme :</p>
          <ul class="der-list">
            <li>de <strong>commissions</strong> versées par les compagnies partenaires ;</li>
            <li>et/ou de <strong>frais</strong> ou <strong>honoraires</strong> prévus dans la lettre de mission.</li>
          </ul>
        </div>

        <div class="der-section">
          <h4>6. Garanties professionnelles</h4>
          <p>Le cabinet justifie d’une <strong>assurance responsabilité civile professionnelle</strong> et d’une <strong>garantie financière</strong>, conformément à la réglementation.</p>
          <table class="der-table">
            <thead>
              <tr>
                <th>Type de garantie</th>
              <th style="text-align:center;">IAS</th>
              <th style="text-align:center;">IOBSP</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (DER_courtier_garanties_normes or []) %}
              <tr>
                <td>{{ g.type_garantie }}</td>
                <td class="center">{% if g.IAS is not none %}{{ '{:,.0f}'.format((g.IAS)|float).replace(',', ' ') }} €{% endif %}</td>
                <td class="center">{% if g.IOBSP is not none %}{{ '{:,.0f}'.format((g.IOBSP)|float).replace(',', ' ') }} €{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="der-section">
          <h4>7. Données personnelles</h4>
          <div>
            <p><strong>A. Responsable du traitement</strong></p>
            <p>
              Responsable : {{ DER_courtier.nom_cabinet }}<br/>
              Adresse : {{ DER_courtier.adresse_rue }}, {{ DER_courtier.adresse_cp }} {{ DER_courtier.adresse_ville }}<br/>
              Courriel : {{ DER_courtier.courriel }}<br/>
              Délégué à la protection des données (DPO) : {{ DER_courtier.responsable_dpo }}
            </p>

            <p><strong>B. Finalités du traitement</strong></p>
            <p>Les données personnelles collectées sont utilisées pour :</p>
            <ul class="der-list">
              <li>Évaluer votre situation patrimoniale, financière et personnelle ;</li>
              <li>Établir un conseil adapté à vos besoins, objectifs et profil de risque ;</li>
              <li>Préparer, souscrire et gérer vos contrats d’assurance ou de placement ;</li>
              <li>Respecter les obligations légales du courtier (lutte contre le blanchiment, devoir de conseil, contrôles réglementaires) ;</li>
              <li>Communiquer des informations utiles à la relation de suivi et de conseil.</li>
            </ul>

            <p><strong>C. Base légale du traitement</strong></p>
            <p>Les traitements reposent sur :</p>
            <ul class="der-list">
              <li>L’exécution d’un contrat ou de mesures précontractuelles ;</li>
              <li>Le respect d’obligations légales et réglementaires ;</li>
              <li>L’intérêt légitime du cabinet pour assurer la qualité et la continuité du service ;</li>
              <li>Et, le cas échéant, votre consentement explicite.</li>
            </ul>

            <p><strong>D. Nature des données traitées</strong></p>
            <p>Les catégories de données collectées incluent :</p>
            <ul class="der-list">
              <li>Données d’identification : nom, prénom, date et lieu de naissance, nationalité, NIF, pièce d’identité ;</li>
              <li>Coordonnées : adresse, téléphone, courriel ;</li>
              <li>Situation personnelle : état civil, profession, situation familiale et patrimoniale ;</li>
              <li>Données financières : revenus, charges, actifs, passifs ;</li>
              <li>Objectifs d’investissement : horizon, tolérance au risque, sensibilité ESG.</li>
            </ul>

            <p><strong>E. Destinataires des données</strong></p>
            <p>Les données sont destinées exclusivement à :</p>
            <ul class="der-list">
              <li>{{ DER_courtier.nom_cabinet }} et ses collaborateurs soumis à une obligation de confidentialité ;</li>
              <li>Les compagnies d’assurance, sociétés de gestion ou plateformes partenaires nécessaires à la mise en œuvre des contrats ;</li>
              <li>Les autorités de contrôle (ACPR, AMF, administration fiscale) lorsque la loi l’exige.</li>
            </ul>
            <p>Aucune donnée n’est cédée ni utilisée à des fins commerciales sans votre accord.</p>

            <p><strong>F. Durée de conservation</strong></p>
            <ul class="der-list">
              <li>Pendant la durée de la relation contractuelle ;</li>
              <li>Puis pendant les délais légaux de prescription applicables :</li>
            </ul>
            <ul class="der-list" style="margin-left:18px;">
              <li>10 ans pour les obligations relatives à la lutte contre le blanchiment et le financement du terrorisme ;</li>
              <li>5 ans pour le devoir de conseil et la traçabilité des recommandations.</li>
            </ul>
            <p>Les données sont ensuite archivées ou supprimées conformément à la réglementation.</p>

            <p><strong>G. Sécurité et confidentialité</strong></p>
            <p>{{ DER_courtier.nom_cabinet }} met en œuvre des mesures techniques et organisationnelles destinées à garantir la confidentialité, l’intégrité et la sécurité de vos données :</p>
            <ul class="der-list">
              <li>Systèmes informatiques protégés et sauvegardes régulières ;</li>
              <li>Accès restreint aux seules personnes habilitées ;</li>
              <li>Chiffrement des communications et suivi des accès.</li>
            </ul>

            <p><strong>H. Vos droits</strong></p>
            <p>Vous disposez à tout moment des droits suivants :</p>
            <ul class="der-list">
              <li>Accès, rectification, mise à jour de vos données ;</li>
              <li>Effacement ou limitation du traitement dans les conditions légales ;</li>
              <li>Opposition au traitement pour motifs légitimes ;</li>
              <li>Portabilité de vos données vers un autre prestataire ;</li>
              <li>Retrait de votre consentement, sans effet rétroactif.</li>
            </ul>
            <p>
              Pour exercer vos droits :<br/>
              {{ DER_courtier.responsable_dpo }} – {{ DER_courtier.courriel }}<br/>
              Vous pouvez également saisir la CNIL (www.cnil.fr) en cas de difficulté non résolue.
            </p>

            <p><strong>I. Transferts de données hors de l’Union européenne</strong></p>
            <p>Aucun transfert de données hors de l’Union européenne n’est effectué sans garanties adéquates de protection et de confidentialité conformes au RGPD.</p>

            <p><strong>J. Mise à jour de la notice</strong></p>
            <p>La présente politique est susceptible d’évoluer afin de refléter les changements législatifs ou techniques. La version la plus récente est disponible sur simple demande ou sur le site internet de {{ DER_courtier.nom_cabinet }}.</p>
          </div>
        </div>

        <div class="der-section">
          <h4>8. Médiation et réclamations</h4>
          <p>Toute réclamation peut être adressée à :<br/>
          <strong>Courtage du Centre – Service Réclamations</strong><br/>
          23 rue du quai, 56150 Chatillon sur Saône<br/>
          Email : jc@cc.fr</p>
          <p>En cas d’absence de solution amiable, le Client peut saisir :<br/>
          <strong>{{ centre_mediation_lib or DER_courtier.centre_mediation }}</strong><br/>
          Contact : banqueroute@acpr.fr</p>
        </div>

        <div class="der-section">
          <h4>9. Acceptation</h4>
          <p>Je, soussigné(e) <strong>{{ client.prenom if client else '' }} {{ client.nom if client else '' }}</strong>, reconnais avoir reçu et pris connaissance du présent <strong>Document d’Entrée en Relation</strong> avant tout engagement.</p>
          <p><strong>Fait à :</strong> {{ DER_courtier.adresse_ville if DER_courtier else '' }}<br/>
          {% set _d = fatca_today|default('') %}
          <strong>Le :</strong> {% if _d and (_d|length >= 10) %}{{ _d[8:10] ~ '/' ~ _d[5:7] ~ '/' ~ _d[0:4] }}{% else %}{{ fatca_today }}{% endif %}</p>
          <p><strong>Signature du client :</strong> ________________________<br/>
          <strong>Signature du courtier :</strong> ________________________</p>
        </div>
      </div>

      
    </div>
  </div>
  <!-- Modale dédiée: Lettre d’adéquation -->
  <div class="modal-overlay" id="confAdequationDetailModal" style="z-index:10001;" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" style="width:760px; max-width:96vw;">
      <div class="modal-header"><h3><i class="fa-solid fa-file-circle-check" style="margin-right:8px;"></i>Lettre d’adéquation</h3><span style="flex:1"></span><span id="laToast" class="badge success" style="display:none; margin-right:8px;">Lettre mise à jour</span><button class="btn" type="button" id="laRefreshBtn" style="margin-right:8px;">Mettre à jour</button><button class="modal-close" onclick="document.getElementById('confAdequationDetailModal').style.display='none'">✕</button></div>
      <div class="modal-body">
        <style>
          .la h1 { font-size: 1.25rem; margin: 0 0 6px; }
          .la h2 { font-size: 1.05rem; margin: 12px 0 6px; }
          .la h3 { font-size: 1rem; margin: 10px 0 6px; }
          .la p { margin: 6px 0; }
          .la ul { margin: 6px 0 6px 18px; }
          .la table { width:100%; border-collapse: collapse; margin: 8px 0; }
          .la th, .la td { border:1px solid var(--border); padding:6px 8px; font-size:.92rem; }
          .la th { background: var(--primary); color:#fff; text-align:left; }
          .la .muted { color: var(--muted); }
          .la .meta { display:flex; gap:18px; flex-wrap:wrap; padding:8px 10px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; }
          .la .meta div { min-width:220px; }
          .la .sig-box { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:10px; }
          .la .sig { border:1px dashed var(--border); border-radius:8px; padding:10px; height:120px; }
        </style>
        <div class="la">
          <h1><strong>Lettre d’adéquation – Conseil en assurance vie</strong></h1>
          <h2><strong>Références réglementaires</strong></h2>
          <ul>
            <li><strong>Code des assurances</strong> : article L. 522-5</li>
            <li><strong>Code monétaire et financier</strong> : article L. 519-6</li>
            <li><strong>Directive (UE) 2016/97 (IDD)</strong> du 20 janvier 2016 sur la distribution d’assurances</li>
            <li><strong>Règlement délégué (UE) 2017/2359</strong> du 21 septembre 2017</li>
            <li><strong>Code des assurances</strong> : articles R. 521-1 à R. 521-14</li>
          </ul>

          

          <h2><strong>1. Objet</strong></h2>
          <p>Cette lettre formalise le <strong>conseil personnalisé</strong> délivré par <strong>Courtage du Centre</strong> dans le cadre de la souscription du contrat d’assurance vie.</p>
          <p>Elle expose les éléments pris en compte pour s’assurer que le produit proposé est <strong>adapté à votre situation, à vos besoins et à vos objectifs</strong>.</p>

          <h2><strong>2. Analyse de votre situation</strong></h2>
          {% set _qual = (etat_civil_latest.civilite if etat_civil_latest else (kyc_etat_civil.civilite if kyc_etat_civil else None)) %}
          {% set _sitfam = (etat_civil_latest.situation_familiale if etat_civil_latest else (kyc_etat_civil.situation_familiale if kyc_etat_civil else None)) %}
          {% set _nb = (nb_enfants_latest if (nb_enfants_latest is not none) else (kyc_situations_matrimoniales[0].nb_enfants if (kyc_situations_matrimoniales and (kyc_situations_matrimoniales|length>0)) else 0)) %}
          {% set _t_rev = (synthese_latest.total_revenus if synthese_latest else None) %}
          {% set _t_chg = (synthese_latest.total_charges if synthese_latest else None) %}
          {% set _t_act = (synthese_latest.total_actif if synthese_latest else None) %}
          {% set _t_pas = (synthese_latest.total_passif if synthese_latest else None) %}
          {% set _net_pat = (_t_act|float - _t_pas|float) if (_t_act is not none and _t_pas is not none) else None %}
          {% set _net_bud = (_t_rev|float - _t_chg|float) if (_t_rev is not none and _t_chg is not none) else None %}
          {% set _dur2 = (risque_latest.horizon_placement if risque_latest else (risque_snapshot.duree if risque_snapshot else (risque_current.duree if risque_current else None))) %}
          {% set _niv2 = (risque_latest.niveau_risque if risque_latest else _niv) %}
          {% set _exp2 = (risque_latest.experience if risque_latest else _exp) %}
          {% set _con2 = (risque_latest.connaissance if risque_latest else _con) %}
          <p>
            {{ _qual or '—' }}, vous êtes actuellement {{ _sitfam or '—' }}{% if (_nb or 0) > 0 %}, et vous avez {{ _nb }} enfant{% if (_nb|int) > 1 %}s{% endif %} à charge{% else %}, et vous n'avez pas d'enfant à charge{% endif %}. 
            Ces éléments familiaux ont été pris en considération dans l’évaluation globale de votre situation et dans la définition de vos besoins patrimoniaux.
          </p>
          {% if _t_rev is not none and _t_chg is not none and _t_act is not none and _t_pas is not none %}
            <p>
              Sur le plan financier, vos revenus annuels s’élèvent à {{ '{:,.0f}'.format((_t_rev or 0)|float).replace(',', ' ') }} €, pour un niveau de charges annuelles de {{ '{:,.0f}'.format((_t_chg or 0)|float).replace(',', ' ') }} €.
              Votre budget disponible annuel, après déduction des charges, est ainsi estimé à {{ '{:,.0f}'.format((_net_bud or 0)|float).replace(',', ' ') }} €, traduisant une situation financière saine et équilibrée. 
              Votre actif total est évalué à {{ '{:,.0f}'.format((_t_act or 0)|float).replace(',', ' ') }} €, tandis que votre passif représente {{ '{:,.0f}'.format((_t_pas or 0)|float).replace(',', ' ') }} €,
              soit un patrimoine net de {{ '{:,.0f}'.format((_net_pat or 0)|float).replace(',', ' ') }} €.
            </p>
          {% endif %}
          <p>
            Concernant votre profil d’investissement, vous indiquez viser un horizon de placement {{ _dur2 or '—' }}, compatible avec des objectifs patrimoniaux de long terme.
            Votre tolérance au risque est qualifiée de {% if _niv2 %}« {{ _niv2 }} »{% else %}—{% endif %}, ce qui signifie que vous acceptez les fluctuations inhérentes aux marchés financiers dans la recherche d’un rendement plus élevé.
          </p>
          {% set _k = (_con2 or '')|lower %}
          {% set _e = (_exp2 or '')|lower %}
          {% set _is_adeq = ('averti' in _k) or ('avert' in _k) or ('confirm' in _k) or ('élev' in _k) or ('eleve' in _k) or (_k == 'oui') or ('averti' in _e) or ('avert' in _e) or ('confirm' in _e) or ('élev' in _e) or ('eleve' in _e) or (_e == 'oui') %}
          {% if _is_adeq %}
            <p>Enfin, votre connaissance et votre expérience financières correspondent à un investisseur capable de comprendre les caractéristiques et les risques des instruments proposés.</p>
          {% else %}
            <p>Enfin, votre connaissance et votre expérience financières ne permettent pas d’appréhender pleinement certains instruments complexes; les recommandations privilégieront des supports simples, une diversification prudente et une information renforcée sur les risques.</p>
          {% endif %}
          {% if risque_latest and risque_latest.confirmation_client is not none %}
            {% set _conf = (risque_latest.confirmation_client|string).lower() %}
            {% if _conf == 'oui' %}
              <p>Un questionnaire de détermination du profil investisseur a été complété : Vous avez validé le profil de risque déterminé par le questionnaire.</p>
            {% else %}
              <p>Un questionnaire de détermination du profil investisseur a été complété : le risque choisi est différent de celui déterminé par le questionnaire. Vous reconnaissez avoir été informé de cet écart et assumez pleinement la responsabilité de ce choix.</p>
            {% endif %}
          {% endif %}

          <!-- Synthèse connaissance client (résumé) -->
          <style>
            .la-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin:10px 0; }
            .la-card {
              border:1px solid var(--border);
              border-radius:12px;
              padding:12px;
              background:#fff;
              box-shadow:0 2px 8px rgba(0,0,0,0.06);
              text-align:center;
              display:flex;
              flex-direction:column;
              align-items:center;
              justify-content:center;
              min-height:96px;
            }
            .la-card .label { color:#6b7280; font-size:.9rem; line-height:1.2; margin:0; }
            .la-card .value { color:#2456a6; font-weight:700; font-size:1.05rem; line-height:1.2; margin:4px 0 0 0; }
            /* indicateurs cohérence objectifs vs durée KYC */
            .dot { display:inline-block; width:1em; height:1em; border-radius:50%; vertical-align:middle; }
            .dot-ok { background:#16a34a; }
            .dot-ko { background:#ef4444; }
          </style>
          
          <div class="la-grid" id="laRiskGrid">
            <div class="la-card"><div class="label">Connaissance générale</div><div class="value" id="laConnaissance">{{ (risque_latest.connaissance if risque_latest else (risque_snapshot.connaissance if risque_snapshot else '—')) or '—' }}</div></div>
            <div class="la-card"><div class="label">Expérience</div><div class="value" id="laExperience">{{ (risque_latest.experience if risque_latest else (risque_snapshot.experience if risque_snapshot else '—')) or '—' }}</div></div>
            <div class="la-card"><div class="label">Perte acceptée</div><div class="value" id="laPerte">{{ (risque_latest.perte_label if risque_latest and risque_latest.perte_label else (risque_snapshot.contraintes if risque_snapshot else '—')) or '—' }}</div><div class="label" id="laPerteCode" style="margin-top:4px; font-size:.8rem; color:#94a3b8;">{{ risque_latest.perte_code if risque_latest and risque_latest.perte_code else '' }}</div></div>
            <div class="la-card"><div class="label">Durée envisagée</div><div class="value" id="laDuree">{{ (risque_latest.horizon_placement if risque_latest and risque_latest.horizon_placement else (risque_snapshot.duree if risque_snapshot else '—')) or '—' }}</div><div class="label" id="laDureeCode" style="margin-top:4px; font-size:.8rem; color:#94a3b8;">{{ risque_latest.duree_code if risque_latest and risque_latest.duree_code else '' }}</div></div>
            <div class="la-card"><div class="label">Part du patrimoine</div><div class="value" id="laPatrimoine">{{ (risque_latest.patrimoine_label if risque_latest and risque_latest.patrimoine_label else (risque_snapshot.patrimoine if risque_snapshot else '—')) or '—' }}</div><div class="label" id="laPatrimoineCode" style="margin-top:4px; font-size:.8rem; color:#94a3b8;">{{ risque_latest.patrimoine_code if risque_latest and risque_latest.patrimoine_code else '' }}</div></div>
            <div class="la-card"><div class="label">Niveau final</div><div class="value" id="laNiveau">{{ (risque_latest.niveau_risque if risque_latest else (risque_snapshot.niveau_label if risque_snapshot else '—')) or '—' }}</div></div>
            <div class="la-card"><div class="label">Allocation</div><div class="value" id="laAllocation">{{ (risque_latest.allocation_nom if risque_latest and risque_latest.allocation_nom else (risque_snapshot.allocation_nom if risque_snapshot else '—')) or '—' }}</div></div>
          </div>

          <h2><strong>3. Comparatif des offres étudiées</strong></h2>
          <table>
            <colgroup>
              <col style="width: 50%;" />
              <col style="width: 35%;" />
              <col style="width: 15%;" />
            </colgroup>
            <thead>
              <tr>
                <th>Nom du contrat</th>
                <th>Compagnie d’assurance</th>
                <th style="text-align:center; min-width: 120px;">Total de frais</th>
              </tr>
            </thead>
            <tbody>
              {% if adequation_contracts and (adequation_contracts|length>0) %}
                {% for c in adequation_contracts %}
                  <tr>
                    <td>{{ c.nom_contrat }}</td>
                    <td>{{ c.societe_nom }}</td>
                    <td style="text-align:center; min-width: 120px;">{{ '%.2f'|format((c.total_frais or 0)|float) }} %</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="muted">Aucune offre disponible.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <p class="muted">Les informations détaillées sur chaque contrat sont fournies en annexe du présent document.</p>

          <h2><strong>4. Recommandation du courtier</strong></h2>
          <p>Le contrat recommandé est <strong id="laContratNom">{{ contrat_choisi_nom or '—' }}</strong>, assuré par <strong id="laContratSociete">{{ contrat_choisi_societe or '—' }}</strong>. Ce produit répond aux <strong>objectifs</strong> et au <strong>profil d’investissement</strong> du client.</p>
          <ul>
            <li><strong>Supports proposés :</strong> fonds euros, unités de compte.</li>
            <li><strong>Offre financière choisie :</strong> <span id="laOffre">{{ (risque_latest.allocation_nom if risque_latest and risque_latest.allocation_nom else (risque_snapshot.allocation_nom if risque_snapshot else (risque_latest.commentaire if risque_latest else '—'))) }}</span></li>
            <li>
              <strong>Objectifs :</strong>
              <div style="margin-top:6px;">
          <table>
            <thead>
              <tr>
                <th style="width:1.8rem; text-align:center;">&nbsp;</th>
                <th>Objectif</th>
                <th>Horizon</th>
                <th>Commentaire</th>
              </tr>
            </thead>
            <tbody id="laObjTbody">
              {% if adequation_objectifs and (adequation_objectifs|length>0) %}
                {# calcul rang de la durée KYC #}
                {% set _d = (_dur2 or '')|lower %}
                {% set _kidx = 4 if 'plus de 8' in _d else (3 if '5 à 8' in _d or '5 a 8' in _d else (2 if '3 à 5' in _d or '3 a 5' in _d else (1 if '1 à 3' in _d or '1 a 3' in _d else 0))) %}
                {% for o in adequation_objectifs %}
                  {% set _h = (o.horizon_investissement or '')|lower %}
                  {% set _oidx = 4 if 'plus de 8' in _h else (3 if '5 à 8' in _h or '5 a 8' in _h else (2 if '3 à 5' in _h or '3 a 5' in _h else (1 if '1 à 3' in _h or '1 a 3' in _h else 0))) %}
                  {% set _ok = (_oidx >= _kidx) and (_kidx > 0) and (_oidx > 0) %}
                  <tr>
                    <td style="text-align:center;"><span class="dot {{ 'dot-ok' if _ok else 'dot-ko' }}" title="{{ 'Cohérent' if _ok else 'Incohérent' }}"></span></td>
                    <td>{{ o.objectif_libelle or '—' }}</td>
                    <td>{{ o.horizon_investissement or '—' }}</td>
                    <td>{{ o.commentaire or '—' }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="4" class="muted">Aucun objectif enregistré.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <p style="font-style: italic; margin:6px 0 0 0;">
            Les objectifs en cohérence avec votre durée d'investissement issue du questionnaire celient sont en vert, en rouge dans le cas contraire.
          </p>
              </div>
            </li>
          </ul>

          <h2><strong>5. Détail de l'offre</strong></h2>
          {% if adequation_allocation_html %}
            <div class="card" style="margin:6px 0; padding:8px 10px;">{{ adequation_allocation_html | safe }}</div>
          {% else %}
            <p class="muted">Détail d’offre indisponible.</p>
          {% endif %}

          <h2><strong>5. Mises en garde</strong></h2>
          <ul>
            <li>Le client reconnaît avoir été informé des <strong>caractéristiques, coûts et risques</strong> des contrats présentés ;</li>
            <li>que la <strong>valeur des supports</strong> peut fluctuer à la hausse comme à la baisse ;</li>
            <li>que les <strong>performances passées ne préjugent pas des performances futures</strong> ;</li>
            <li>que le conseil repose sur les informations communiquées et qu’une omission ou inexactitude peut en affecter la pertinence.</li>
          </ul>

          <h2><strong>6. Accord du client</strong></h2>
          <p>Je soussigné(e) <strong>{{ client.prenom if client else '' }} {{ client.nom if client else '' }}</strong>, déclare avoir reçu et pris connaissance de la présente lettre d’adéquation. Je confirme que le conseil fourni correspond à mes attentes et à mes objectifs patrimoniaux.</p>
          <div class="sig-box">
            <div class="sig"><strong>Signature du client</strong><br/><span class="muted">[Date et lieu]</span></div>
            <div class="sig"><strong>Signature du courtier</strong><br/><span class="muted">[Date et lieu]</span></div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" type="button" onclick="window.print()"><i class="fa-solid fa-print" style="margin-right:6px;"></i>Imprimer</button>
        </div>
      </div>
    </div>
  </div>


  </div>
</div>

<script>
    function setSectionToggleActive(id){
      try {
        const buttons = document.querySelectorAll('.section-toggle-row .accordion-toggle');
        buttons.forEach(btn => btn.classList.toggle('active', btn.id === id));
      } catch(e){}
    }
    // Toggle Conformité panel
    // Ouvrir/fermer la modale Conformité
    function openConfMain(){
      var m = document.getElementById('confMainModal');
      if (m) {
        m.style.display = 'flex';
      }
    }
    function closeConfMain(){ var m=document.getElementById('confMainModal'); if(m) m.style.display='none'; }
    // Open modals (exclusive)
    function __showOverlay(id){ try{ document.querySelectorAll('.modal-overlay').forEach(function(el){ el.style.display='none'; }); }catch(e){} var m=document.getElementById(id); if(m) m.style.display='flex'; }
    function openConfConnaissanceDetail(){ __showOverlay('confConnaissanceDetailModal'); }
    function closeConfConnaissanceDetail(){
      var m=document.getElementById('confConnaissanceDetailModal'); if(m) m.style.display='none';
      var la = document.getElementById('confAdequationDetailModal');
      if (la && la.style.display === 'flex'){
        var btn = document.getElementById('laRefreshBtn');
        if (btn){ btn.click(); }
      }
    }
    function openConfEerDetail(){ __showOverlay('confEerDetailModal'); }
    function openConfMissionDetail(){ __showOverlay('confMissionDetailModal'); }
    function openConfAdequationDetail(){
      try { document.querySelectorAll('.modal-overlay').forEach(function(el){ el.style.display='none'; }); } catch(e){}
      var m = document.getElementById('confAdequationDetailModal');
      if (m && m.parentElement !== document.body) {
        try { document.body.appendChild(m); } catch(e){}
      }
      if (m) m.style.display='flex';
      var main = document.getElementById('confMainModal');
      if (main) main.style.display='none';
    }
    function triggerPdfDownload(url){
      if(!url) return;
      var link = document.createElement('a');
      link.href = url;
      link.target = '_blank';
      link.rel = 'noopener';
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      setTimeout(function(){ try{ document.body.removeChild(link); }catch(e){} }, 1000);
    }

    function generateDerPdf(options){
      try{
        var opts = {};
        if(typeof options === 'string'){
          opts.sourceId = options;
        }else if(options){
          opts = options;
        }
        var clientId = opts.clientId || CLIENT_ID;
        if(!clientId){
          alert('Client introuvable.');
          return;
        }
        if (typeof window.showGlobalLoader === 'function'){
          window.showGlobalLoader('Génération du PDF…');
        }
        var url = '/dashboard/clients/' + encodeURIComponent(clientId) + '/der/pdf';
        url = appendMarkers(url);
        triggerPdfDownload(url);
        var clearLoader = function(){
          if (typeof window.hideGlobalLoader === 'function'){
            window.hideGlobalLoader();
          }
          window.removeEventListener('focus', clearLoader);
        };
        window.addEventListener('focus', clearLoader);
        setTimeout(clearLoader, 4000);
      }catch(err){
        console.warn('DER PDF generation failed', err);
        if (typeof window.hideGlobalLoader === 'function'){
          window.hideGlobalLoader();
        }
      }
    }
    window.generateDerPdf = generateDerPdf;
    function generateMissionPdf(options){
      try{
        var opts = {};
        if(options){
          opts = typeof options === 'object' ? options : {};
        }
        var clientId = opts.clientId || CLIENT_ID;
        if(!clientId){
          alert('Client introuvable.');
          return;
        }
        if (typeof window.showGlobalLoader === 'function'){
          window.showGlobalLoader('Génération du PDF…');
        }
        var url = '/dashboard/clients/' + encodeURIComponent(clientId) + '/mission/pdf';
        url = appendMarkers(url);
        triggerPdfDownload(url);
        var clearLoader = function(){
          if (typeof window.hideGlobalLoader === 'function'){
            window.hideGlobalLoader();
          }
          window.removeEventListener('focus', clearLoader);
        };
        window.addEventListener('focus', clearLoader);
        setTimeout(clearLoader, 4000);
      }catch(err){
        console.warn('Mission PDF generation failed', err);
        if (typeof window.hideGlobalLoader === 'function'){
          window.hideGlobalLoader();
        }
      }
    }
    window.generateMissionPdf = generateMissionPdf;
    function generateAdequationPdf(options){
      try{
        var opts = {};
        if(options){
          opts = typeof options === 'object' ? options : {};
        }
        var clientId = opts.clientId || CLIENT_ID;
        if(!clientId){
          alert('Client introuvable.');
          return;
        }
        if (typeof window.showGlobalLoader === 'function'){
          window.showGlobalLoader('Génération du PDF…');
        }
        var url = '/dashboard/clients/' + encodeURIComponent(clientId) + '/adequation/pdf';
        url = appendMarkers(url);
        triggerPdfDownload(url);
        var clearLoader = function(){
          if (typeof window.hideGlobalLoader === 'function'){
            window.hideGlobalLoader();
          }
          window.removeEventListener('focus', clearLoader);
        };
        window.addEventListener('focus', clearLoader);
        setTimeout(clearLoader, 4000);
      }catch(err){
        console.warn('Adequation PDF generation failed', err);
        if (typeof window.hideGlobalLoader === 'function'){
          window.hideGlobalLoader();
        }
      }
    }
    window.generateAdequationPdf = generateAdequationPdf;
    // removed: mission2, tempo
  </script>
<script>
  // Inject today date in Lettre d’adéquation
  (function(){ try{ var el=document.getElementById('laDate'); if(el){ var d=new Date(); var s=d.toLocaleDateString(); el.textContent=s; } }catch(e){} })();
</script>
<script>
  (function(){
    // Interception de l'envoi LCBFT pour rester dans la modale
    try{
      var lcbftForm = document.getElementById('lcbftForm');
      if (lcbftForm){
        lcbftForm.addEventListener('submit', function(ev){
          try{ ev.preventDefault(); }catch(e){}
          var fd = new FormData(lcbftForm);
          fetch(lcbftForm.getAttribute('action') || window.location.href, { method: 'POST', body: fd, credentials: 'same-origin' })
            .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
            .then(function(){
              var toast = document.getElementById('lcbftDetailToast');
              if (toast){ toast.style.display='inline-block'; setTimeout(function(){ toast.style.display='none'; }, 3000); }
              // Si la lettre d’adéquation est ouverte, rafraîchir son contenu
              if (typeof window.refreshAdequation === 'function'){ window.refreshAdequation(); }
            })
            .catch(function(err){ console.warn('LCBFT save failed', err); });
        });
      }
    }catch(e){}
    function doRefresh(){
      try{
        fetch('/dashboard/clients/{{ client.id }}/adequation.json').then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          try{ document.getElementById('laOffre').textContent = (data.offre_commentaire || '—'); }catch(e){}
          try{ document.getElementById('laContratNom').textContent = (data.contrat_nom || '—'); }catch(e){}
          try{ document.getElementById('laContratSociete').textContent = (data.contrat_societe || '—'); }catch(e){}
          try{
            var rs = data.risque_summary || {};
            var map = {
              laConnaissance: rs.connaissance,
              laExperience: rs.experience,
              laPerte: rs.contraintes,
              laDuree: rs.duree,
              laPatrimoine: rs.patrimoine,
              laNiveau: rs.niveau_label,
              laAllocation: rs.allocation_nom
            };
            Object.keys(map).forEach(function(id){ var el=document.getElementById(id); if(el){ el.textContent = (map[id] || '—'); }});
            // codes debug
            try{ var el=document.getElementById('laPerteCode'); if(el){ el.textContent = rs.perte_code || ''; } }catch(e){}
            try{ var el=document.getElementById('laDureeCode'); if(el){ el.textContent = rs.duree_code || ''; } }catch(e){}
            try{ var el=document.getElementById('laPatrimoineCode'); if(el){ el.textContent = rs.patrimoine_code || ''; } }catch(e){}
          }catch(e){}
          try{
            var tb = document.getElementById('laObjTbody');
            if (tb){
              tb.innerHTML = '';
              var rows = (data.objectifs || []);
              if (!rows.length){ tb.innerHTML = '<tr><td colspan="4" class="muted">Aucun objectif enregistré.</td></tr>'; }
              else {
                function rankDur(txt){
                  if(!txt) return 0;
                  var s = String(txt).toLowerCase();
                  if(s.indexOf('plus de 8') >= 0) return 4;
                  if(s.indexOf('5 à 8') >= 0 || s.indexOf('5 a 8') >= 0) return 3;
                  if(s.indexOf('3 à 5') >= 0 || s.indexOf('3 a 5') >= 0) return 2;
                  if(s.indexOf('1 à 3') >= 0 || s.indexOf('1 a 3') >= 0) return 1;
                  return 0;
                }
                // KYC duration from JSON or fallback to DOM value
                var kycDur = (data.risque_summary && data.risque_summary.duree) || (document.getElementById('laDuree') ? document.getElementById('laDuree').textContent : null);
                var kidx = rankDur(kycDur);
                rows.forEach(function(o){
                  var tr = document.createElement('tr');
                  var ok = false;
                  try{ ok = rankDur(o.horizon_investissement) >= kidx && kidx > 0 && rankDur(o.horizon_investissement) > 0; }catch(e){ ok = false; }
                  var td0 = document.createElement('td');
                  var dot = document.createElement('span'); dot.className = 'dot ' + (ok ? 'dot-ok':'dot-ko'); dot.title = ok ? 'Cohérent':'Incohérent';
                  td0.style.textAlign = 'center'; td0.appendChild(dot);
                  var td1 = document.createElement('td'); td1.textContent = o.objectif_libelle || '—';
                  var td2 = document.createElement('td'); td2.textContent = o.horizon_investissement || '—';
                  var td3 = document.createElement('td'); td3.textContent = o.commentaire || '—';
                  tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
                  tb.appendChild(tr);
                });
              }
            }
          }catch(e){}
          try{ var t=document.getElementById('laToast'); if(t){ t.style.display='inline-block'; setTimeout(function(){ t.style.display='none'; }, 1500); } }catch(e){}
        }).catch(function(err){ console.warn('Refresh adequation failed', err); });
      }catch(e){ /* noop */ }
    }
    var btn = document.getElementById('laRefreshBtn');
    if (btn){ btn.addEventListener('click', doRefresh); }
    window.refreshAdequation = doRefresh;
  })();
</script>
<script>
  // Charger la liste des documents de base pour le select
  (async function loadDocuments() {
    try {
      const res = await fetch('/documents/');
      if (!res.ok) return;
      const docs = await res.json();
      const sel = document.getElementById('document_base_select');
      sel._allOptions = [];
      docs.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id_document_base;
        opt.textContent = d.documents || `Document ${d.id_document_base}`;
        sel._allOptions.push(opt);
      });
      function renderOptions(filter) {
        sel.innerHTML = '<option value="" disabled selected>Choisir…</option>';
        (sel._allOptions || []).forEach(opt => {
          if (!filter) { sel.appendChild(opt.cloneNode(true)); return; }
          const t = (opt.textContent||'').toLowerCase();
          if (t.includes(filter.toLowerCase())) sel.appendChild(opt.cloneNode(true));
        });
      }
      renderOptions('');
      document.getElementById('doc_filter').addEventListener('input', function(){
        renderOptions(this.value);
      });
    } catch (e) { /* ignore */ }
  })();

  // Ajout document-client via API
  document.getElementById('addDocForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const payload = {
      id_client: {{ client.id }},
      id_document_base: parseInt(document.getElementById('document_base_select').value, 10),
      nom_document: document.getElementById('nom_document').value || null,
      date_creation: document.getElementById('date_creation').value || null,
      date_obsolescence: document.getElementById('date_obsolescence').value || null,
      obsolescence: document.getElementById('obsolescence').value || null,
    };

    const res = await fetch('/documents_clients/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      location.reload();
    } else {
      const err = await res.json().catch(() => ({}));
      alert('Erreur: ' + (err.detail || res.status));
    }
  });

  // Suppression document-client
  document.querySelectorAll('.delBtn').forEach(btn => {
    btn.addEventListener('click', async function () {
      const id = this.dataset.id;
      if (!confirm('Supprimer ce document ?')) return;
      const res = await fetch(`/document_client/${id}`, { method: 'DELETE' });
      if (res.ok) {
        location.reload();
      } else {
        alert('Suppression impossible');
      }
    });
  });

  // DataTable + filtres pour la table Documents client
  (function(){
    try {
      var table = $('#clientDocs').DataTable({ order:[[0,'asc']], pageLength:25, fixedHeader:true, lengthChange:false, searching:false, dom:'rtip' });
      // Remplir le select Statut (colonne 4)
      var sel = document.getElementById('cd-status-filter');
      table.column(4).data().unique().sort().each(function (d) { if (d) { var o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o);} });
      // Filtres texte
      $('#cd-type-filter').on('keyup change', function(){ table.column(0).search(this.value).draw(); });
      $('#cd-nom-filter').on('keyup change', function(){ table.column(1).search(this.value).draw(); });
      $('#cd-cr-filter').on('keyup change', function(){ table.column(2).search(this.value).draw(); });
      $('#cd-obsdate-filter').on('keyup change', function(){ table.column(3).search(this.value).draw(); });
      $('#cd-status-filter').on('change', function(){ var v=this.value; table.column(4).search(v? '^'+$.fn.dataTable.util.escapeRegex(v)+'$':'' , true, false).draw(); });
    } catch(e) { /* ignore */ }
  })();
</script>

{% endblock %}
    var esgSensibiliteMap = {
      "Environnement": ["carbon_trend", "temperature_score", "ghg_intensity_value", "renewable_energy", "avoiding_water_scarcity", "water_efficiency"],
      "Social": ["social_good", "social_harm", "executive_pay"],
      "Gouvernance / Diversité": ["board_independence", "board_gender_diversity", "pct_female_board", "pct_female_executives", "gender_pay_gap"]
    };
    var esgSensibiliteLabels = {
      "env_importance": "Importance environnement",
      "env_ges_reduc": "Réduction GES",
      "soc_droits_humains": "Droits humains",
      "soc_parite": "Parité",
      "gov_transparence": "Transparence",
      "gov_controle_ethique": "Contrôle éthique"
    };
