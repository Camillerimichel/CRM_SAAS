{% extends "base.html" %}

{% block title %}{% if client %}Suivi client – {{ client.prenom }} {{ client.nom }}{% else %}Suivi client{% endif %}{% endblock %}
{% block header_title %}
  {% if client %}
    <span style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <span><i class="fa-solid fa-users" style="margin-right:8px;"></i>Suivi client – {{ client.prenom }} {{ client.nom }}</span>
      <span style="display:inline-flex; gap:6px;">
        {% if msgs_nonreg_count and msgs_nonreg_count > 0 %}
          <button type="button" class="btn" style="background:#16a34a; color:#fff; border:1px solid #16a34a; padding:.25rem .5rem; font-size:.85rem;" onclick="openClientMsgs('nonreg')">{{ msgs_nonreg_count }} message{{ 's' if msgs_nonreg_count>1 }} en cours</button>
        {% endif %}
        {% if msgs_reg_count and msgs_reg_count > 0 %}
          <button type="button" class="btn" style="background:#c62828; color:#fff; border:1px solid #c62828; padding:.25rem .5rem; font-size:.85rem;" onclick="openClientMsgs('reg')">{{ msgs_reg_count }} réglementaire{{ 's' if msgs_reg_count>1 }}</button>
        {% endif %}
        <button type="button" class="btn" style="padding:.25rem .6rem; font-size:.85rem;" onclick="openClientAdminGroups()"><i class="fa-solid fa-gear" style="margin-right:6px;"></i>Administration</button>
      </span>
    </span>
  {% else %}
    <i class="fa-solid fa-users" style="margin-right:8px;"></i>Suivi client
  {% endif %}
{% endblock %}

{% block content %}
<style>
  .card { background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 14px; }
  .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .muted { color: #666; font-size: 0.9rem; }
  table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
  th, td { padding: 6px 8px; border-bottom: 1px solid #eee; }
  th { background: #f8f9fa; text-align: left; font-size: 0.8rem; }
  .valo { font-weight: 600; color: #28a745; font-family: monospace; font-size: 1.05rem; }
  .kpi { font-size: 0.95rem; font-weight: 700; }
  .kpi-small { font-size: 0.85rem; color:#333; }
  .srri-icon { font-size: 0.7rem; vertical-align: middle; margin-left: 6px; }
  /* Override base .card i selector that makes icons large */
  .card .srri-icon { font-size: 0.7rem !important; margin-bottom: 0 !important; }
  .valo-positive { color: #28a745; }
  .valo-negative { color: #c0392b; }
  table i.fa-solid { font-size: 0.9rem !important; }
  .center { text-align: center; }
  /* SRRI colored dots */
  .srri-dot { display:inline-block; width: 1em; height: 1em; border-radius: 50%; vertical-align: middle; }
  .srri-red { background:#ef4444; }
  .srri-green { background:#16a34a; }
  .srri-blue { background:#3b82f6; }
  /* Bouton Voir compact */
  .btn-view { display:inline-block; padding: 2px 6px; font-size: 0.65rem; border-radius: 4px; background: var(--primary); color: #fff; text-decoration: none; }
  /* Réduire la marge haute du bloc contrats */
  #invSection { padding-top: 8px; }
  #invSection h3 { margin: 4px 0 8px; }
  #invSection table { margin-top: 0; }
  /* Réduire la largeur du sélecteur de date à la taille d'une date */
  #asOfSelect { width: 12ch; min-width: 12ch; }
  .kpi-mini { font-size: 0.85rem; color: #333; line-height: 1.2; }
  .kpi-line { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:4px; }
  .kpi-line:first-of-type { margin-top:6px; }
  .kpi-line .kv { font-weight:600; text-align:right; }
  /* Neutralize big button style from base for table links */
  .card table a, #contractsTable a { 
    display: inline !important; 
    background: transparent !important; 
    padding: 0 !important; 
    margin: 0 !important; 
    color: var(--primary) !important; 
    font-weight: normal !important; 
    border-radius: 0 !important; 
    text-decoration: none;
  }
  .card table a:hover, #contractsTable a:hover { text-decoration: underline; }
  /* Supports consolidés table */
  #supportsClient { table-layout: fixed; margin-top: 10px; }
  #supportsClient th, #supportsClient td { padding: 6px 8px; }
  #supportsClient th:nth-child(1), #supportsClient td:nth-child(1) { width: 14%; }
  #supportsClient th:nth-child(2), #supportsClient td:nth-child(2) { width: 22%; overflow: hidden; text-overflow: ellipsis; }
  #supportsClient th:nth-child(3), #supportsClient td:nth-child(3) { width: 6%; text-align:center; }
  #supportsClient th:nth-child(4), #supportsClient td:nth-child(4) { width: 10%; text-align:right; }
  #supportsClient th:nth-child(5), #supportsClient td:nth-child(5) { width: 10%; text-align:right; }
  #supportsClient th:nth-child(6), #supportsClient td:nth-child(6) { width: 12%; text-align:right; }
  #supportsClient th:nth-child(7), #supportsClient td:nth-child(7) { width: 4%; text-align:center; }
  #supportsClient th:nth-child(8), #supportsClient td:nth-child(8) { width: 4%; text-align:center; }
  #supportsClient th:nth-child(9), #supportsClient td:nth-child(9) { width: 4%; text-align:center; }
  /* Charts block (embedded inside a card → keep it light) */
  .pie-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; align-items: stretch; }
  .pie-card { background: transparent; border-radius: 0; padding: 0; box-shadow: none; display:flex; flex-direction:column; }
  .pie-card canvas { flex:1 1 auto; height: 220px !important; }
  .pie-card .chart-title { margin: 0 0 6px 0; font-size: 0.95rem; }
  .dim-btn { padding:4px 8px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa; cursor:pointer; font-size:12px; }
  .dim-btn.active { background: var(--primary); color:#fff; border-color: var(--primary); }
  /* Boutons de période */
  .rangeBtn { padding:4px 8px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa; cursor:pointer; font-size:12px; margin-right:4px; }
  .rangeBtn:hover { background:#eef1ff; border-color:#bbb; }
  
  /* Contrats table tighter */
  #contractsTable { border-collapse: collapse; }
  #contractsTable th, #contractsTable td { padding: 2px 6px; line-height: 1.1; vertical-align: middle; margin: 0; }
  #contractsTable .badge-closed { padding: 1px 6px; font-size: 10px; }
  /* Alignements d'en-têtes */
  #contractsTable thead th:nth-child(2),
  #contractsTable thead th:nth-child(3) { text-align: center; }
  #contractsTable thead th:nth-child(4),
  #contractsTable thead th:nth-child(5),
  #contractsTable thead th:nth-child(6) { text-align: right; }
  /* Priorisation des largeurs: Contrat, Date, Montant */
  #contractsTable thead th:nth-child(1) { width: 28%; }
  #contractsTable thead th:nth-child(2) { width: 8%; }
  #contractsTable thead th:nth-child(3) { width: 15%; }
  #contractsTable thead th:nth-child(4) { width: 14%; }
  #contractsTable thead th:nth-child(5) { width: 14%; }
  #contractsTable thead th:nth-child(6) { width: 14%; }
  /* Accordions */
  .accordion-toggle { display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; border-left:4px solid var(--primary); cursor:pointer; }
  .accordion-toggle .chevron { display:inline-block; margin-left:8px; transition: transform .2s ease; font-size: 1rem; }
  .accordion-toggle.collapsed .chevron { transform: rotate(-90deg); }
  .badge-closed { display:inline-block; margin-left:8px; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:600; color:#b00020; background:#ffd6d6; border:1px solid #ffb3b3; vertical-align:middle; white-space:nowrap; }
  .highlight-cle { background: #ffe5e5 !important; }
  /* Boutons pilule type KYC */
  .kyc-main-btn { padding:10px 18px; border-radius:999px; border:1px solid var(--primary); background:var(--primary); color:#fff; font-weight:600; font-size:.95rem; display:inline-flex; align-items:center; justify-content:center; gap:8px; min-width:auto; text-align:center; white-space:nowrap; }
  .kyc-main-btn i { font-size:1rem; color:#fff; }
  /* Bouton Conformité identique aux autres (pilule primaire) */
  /* aucun style spécifique: utiliser l'apparence standard des autres accordéons */
</style>



{% if client %}
  <div class="grid">
    <div class="card">
      <div class="muted">Synthèse</div>
      <div class="kpi-small"><strong>Contrats ouverts:</strong> {{ nb_contrats_ouverts }}</div>
      <div class="kpi-small"><strong>Contrats fermés:</strong> {{ nb_contrats_fermes }}</div>
      <div class="kpi-small"><strong>Durée historique:</strong> {{ duree_historique_str }}</div>
      <div class="kpi-mini kpi-line">
        <span>Responsable</span>
        <span class="kv">
          <form method="post" action="/dashboard/clients/{{ client.id }}/commercial" id="commercialForm" style="display:inline;">
            <select name="commercial_id" onchange="this.form.submit()" style="min-width:220px;">
              <option value="">— Aucun —</option>
              {% for rh in rh_list %}
                <option value="{{ rh.id }}" {% if client and client.commercial_id is not none and (client.commercial_id|int) == (rh.id|int) %}selected{% endif %}>{{ rh.prenom }} {{ rh.nom }}</option>
              {% endfor %}
            </select>
          </form>
        </span>
      </div>
    </div>
    <div class="card">
      <div class="muted">Valorisation</div>
      <div class="kpi valo {{ 'valo-positive' if valo_gt_solde else 'valo-negative' }}">{{ last_valo_str }}</div>
      <div class="kpi-mini kpi-line"><span>Versements</span><span class="kv">{{ depots_str }}</span></div>
      <div class="kpi-mini kpi-line"><span>Retraits</span><span class="kv">{{ retraits_str }}</span></div>
      <div class="kpi-mini kpi-line"><span>Solde</span><span class="kv">{{ solde_str }}</span></div>
    </div>
    <div class="card">
      <div class="muted">Indicateurs</div>
      <div class="kpi-mini kpi-line"><span>Perf 52 semaines</span><span class="kv">{% if last_perf_pct is not none %}{{ '%.2f'|format(last_perf_pct) }} %{% else %}-{% endif %}</span></div>
      <div class="kpi-mini kpi-line"><span>Volatilité</span><span class="kv">{% if last_vol_pct is not none %}{{ '%.2f'|format(last_vol_pct) }} %{% else %}-{% endif %}</span></div>
      <div class="kpi-mini kpi-line"><span>SRRI client / actuel</span><span class="kv">{{ client_srri if client_srri is not none else '-' }} / {{ current_srri if current_srri is not none else '-' }}</span></div>
  <div class="kpi-mini kpi-line"><span>Perf annualisée (depuis début)</span><span class="kv">{% if overall_ann_perf_pct is not none %}{{ '%.2f'|format(overall_ann_perf_pct) }} %{% else %}-{% endif %}</span></div>
    </div>
  </div>

  

<!-- Modale Administration Groupes (Client) -->
<style>
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items: center; justify-content: center; z-index: 9999; }
  .modal-card { background: #fff; border-radius: 12px; width: 780px; max-width: 95vw; max-height: 92vh; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .modal-header h3 { margin: 0; font-size: 1.05rem; }
  .modal-body { padding: 12px 14px; }
  .modal-close { border:none; background: transparent; cursor: pointer; font-size: 18px; }
</style>
<div id="clientAdminGroupsModal" class="modal-overlay" onclick="if(event.target===this) document.getElementById('clientAdminGroupsModal').style.display='none'">
  <div class="modal-card">
    <div class="modal-header">
      <h3><i class="fa-solid fa-user-gear" style="margin-right:8px;"></i>Groupes du client</h3>
      <button class="modal-close" onclick="document.getElementById('clientAdminGroupsModal').style.display='none'">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="field">
          <label>Ajouter le client à un groupe</label>
          <select id="clientGroupsSelect"></select>
          <div id="clientGroupsNotice" class="muted" style="margin-top:6px; display:none;"></div>
        </div>
        <div class="field" style="align-self:end;">
          <button class="btn btn-primary" onclick="addClientGroup()"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>Ajouter</button>
        </div>
      </div>
      <table id="clientGroupsTable">
        <thead>
          <tr>
            <th>Groupe</th>
            <th>Actif</th>
            <th>Ajout</th>
            <th>Retrait</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
    const CLIENT_ID = {{ client.id if client else 'null' }};
    let clientGroupDetails = [];
    let clientGroupLinks = [];
    function openClientAdminGroups(){
      const el = document.getElementById('clientAdminGroupsModal');
      el.style.display = 'flex';
      console.log('[Admin][Client] open modal for client_id=', CLIENT_ID);
      loadClientGroups();
    }
    async function loadClientGroups(){
      const notice = document.getElementById('clientGroupsNotice');
      if (notice) { notice.style.display = 'none'; notice.textContent = ''; }
      try {
        let detailsRes = await fetch('/api/groupes/details?type=client&actifs_only=true');
        console.log('[Admin][Client] fetch details (active) → status', detailsRes.status);
        clientGroupDetails = detailsRes.ok ? await detailsRes.json() : [];
        console.log('[Admin][Client] details (active) payload:', clientGroupDetails);
        if (!Array.isArray(clientGroupDetails) || clientGroupDetails.length === 0){
          console.warn('[Admin][Client] no active groups, retry including inactive');
          const r2 = await fetch('/api/groupes/details?type=client&actifs_only=false');
          console.log('[Admin][Client] fetch details (all) → status', r2.status);
          if (r2.ok) clientGroupDetails = await r2.json();
          console.log('[Admin][Client] details (all) payload:', clientGroupDetails);
        }
        const linksRes = await fetch('/api/groupes/memberships?client_id=' + encodeURIComponent(CLIENT_ID));
        console.log('[Admin][Client] fetch memberships → status', linksRes.status);
        clientGroupLinks = linksRes.ok ? await linksRes.json() : [];
        console.log('[Admin][Client] memberships payload:', clientGroupLinks);
        renderClientGroupSelect();
        renderClientGroupsTable();
      } catch (e) {
        console.error('[Admin][Client] loadClientGroups error:', e);
        if (notice) { notice.style.display = 'block'; notice.textContent = 'Erreur de chargement des groupes.'; }
      }
    }
    function renderClientGroupSelect(){
      const sel = document.getElementById('clientGroupsSelect');
      sel.innerHTML = '';
      const notice = document.getElementById('clientGroupsNotice');
      if (!Array.isArray(clientGroupDetails) || clientGroupDetails.length === 0){
        const opt = document.createElement('option'); opt.value=''; opt.textContent='Aucun groupe Personnes'; sel.appendChild(opt);
        if (notice) { notice.style.display = 'block'; notice.textContent = 'Aucun groupe Personnes trouvé. Allez dans Paramètres > Groupes pour en créer.'; }
        return;
      }
      if (notice) { notice.style.display = 'none'; notice.textContent = ''; }
      clientGroupDetails.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id; opt.textContent = g.nom + (g.actif===0?' (inactif)':'');
        sel.appendChild(opt);
      });
    }
    function renderClientGroupsTable(){
      const body = document.querySelector('#clientGroupsTable tbody');
      body.innerHTML = '';
      const nameById = Object.fromEntries(clientGroupDetails.map(g => [g.id, g.nom]));
      (clientGroupLinks||[]).forEach(link => {
        const tr = document.createElement('tr');
        const tdNom = document.createElement('td'); tdNom.textContent = nameById[link.groupe_id] || ('#'+link.groupe_id);
        const tdActif = document.createElement('td'); tdActif.textContent = (link.actif===1 || link.actif===null)?'Oui':'Non';
        const tdAj = document.createElement('td'); tdAj.className='js-local-dt'; tdAj.setAttribute('data-iso', link.date_ajout || '');
        const tdRt = document.createElement('td'); tdRt.className='js-local-dt'; tdRt.setAttribute('data-iso', link.date_retrait || '');
        const tdAct = document.createElement('td');
        const btn = document.createElement('button'); btn.className = 'btn btn-danger'; btn.textContent = 'Retirer'; btn.onclick = () => removeClientGroup(link.id);
        tdAct.appendChild(btn);
        tr.appendChild(tdNom); tr.appendChild(tdActif); tr.appendChild(tdAj); tr.appendChild(tdRt); tr.appendChild(tdAct);
        body.appendChild(tr);
      });
      // trigger client-side date localization
      try { (function(){
        var nodes = document.querySelectorAll('#clientGroupsTable .js-local-dt');
        nodes.forEach(function (el) {
          var iso = el.getAttribute('data-iso') || (el.textContent || '').trim();
          if (!iso) { el.textContent=''; return; }
          var s = iso;
          if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}(?::\d{2})?)?$/.test(s)) {
            s = s.replace(' ', 'T') + 'Z';
          }
          var d = new Date(s);
          if (isNaN(d)) { el.textContent = iso; return; }
          try { el.textContent = d.toLocaleString('fr-FR', { timeZone: 'Europe/Paris' }); }
          catch(e){ el.textContent = d.toLocaleString(); }
        });
      })(); } catch(e){}
    }
    async function addClientGroup(){
      const sel = document.getElementById('clientGroupsSelect');
      const gid = parseInt(sel.value, 10);
      if (!gid || !CLIENT_ID) return;
      try {
        await fetch('/api/groupes/memberships', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ groupe_id: gid, client_id: CLIENT_ID })
        });
        await loadClientGroups();
      } catch (e) { console.error(e); }
    }
    async function removeClientGroup(linkId){
      if (!linkId) return;
      try {
        await fetch('/api/groupes/memberships/' + linkId, { method: 'DELETE' });
        await loadClientGroups();
      } catch (e) { console.error(e); }
    }
  </script>
</div>

<!-- Modale dédiée: Lettre de Mission -->
<div class="modal-overlay" id="confMissionDetailModal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" style="width:760px; max-width:96vw;">
      <div class="modal-header"><h3><i class="fa-solid fa-file-contract" style="margin-right:8px;"></i>Lettre de Mission</h3><button class="modal-close" onclick="document.getElementById('confMissionDetailModal').style.display='none'">✕</button></div>
      <div class="modal-body">
        <style>
          .lm h2 { font-size: 1.2rem; margin: 0 0 8px; }
          .lm h3 { font-size: 1.05rem; margin: 14px 0 6px; }
          .lm p { margin: 6px 0; }
          .lm ul { margin: 6px 0 6px 18px; }
          .lm hr { border: 0; border-top: 1px solid var(--border); margin: 10px 0; }
          .lm .muted { color: var(--muted); }
        </style>
        <div class="lm">
          <h2><strong>LETTRE DE MISSION ÉLECTRONIQUE – COURTAGE EN ASSURANCE-VIE</strong></h2>
          <hr />

          <h3><strong>Préambule</strong></h3>
          <p>Vous avez bien voulu nous consulter en qualité de <strong>courtier en assurance-vie</strong>, et nous vous remercions de votre confiance.</p>
          <p>Lors d’un précédent entretien, nous vous avons remis le <strong>Document d’Entrée en Relation (DER)</strong> conformément à l’article <strong>L.521-2 du Code des assurances</strong>.<br/>
          La présente lettre de mission a pour objet de <strong>définir et de formaliser les conditions et modalités</strong> de notre intervention dans le cadre de votre accompagnement patrimonial.</p>

          <hr />
          <h3><strong>A. Objectifs de la mission</strong></h3>
          <p>Lors de notre entretien du <strong>{{ dateEntretien }}</strong>, vous avez exprimé les axes de réflexion prioritaires au regard de vos objectifs patrimoniaux.</p>
          <p>Vous avez manifesté le souhait d’investir <strong>{{ montantInvesti }}</strong> euros, avec pour objectif(s) : <strong>{{ objectifsMission }}</strong>.</p>
          <p>Les objectifs patrimoniaux et financiers exprimés lors du <strong>recueil d’informations client</strong> constituent la base de notre mission de conseil.<br/>
          Toute modification ultérieure devra nous être communiquée afin d’ajuster nos recommandations.</p>

          <hr />
          <h3><strong>B. Missions confiées</strong></h3>
          <h4>1. Mise en relation avec les compagnies d’assurance</h4>
          <p class="muted">Intermédiation au sens de l’article <strong>L.511-1 du Code des assurances</strong>.</p>
          <h4>2. Présentation et explication des produits d’assurance-vie</h4>
          <p class="muted">Informations claires et exactes sur les produits, avant toute recommandation personnalisée.</p>
          <h4>3. Collecte d’informations</h4>
          <p class="muted">Recueil des données nécessaires à l’analyse de votre situation conformément à la <strong>Directive DDA (UE) 2016/97</strong> et au <strong>devoir de connaissance du client</strong> (articles L.541-8-1 et suivants du Code monétaire et financier).</p>
          <h4>4. Transmission de la documentation contractuelle</h4>
          <p class="muted">Conditions générales, DIC (PRIIPs), fiches IPID et tout document précontractuel requis.</p>
          <h4>5. Suivi administratif et contractuel</h4>
          <p class="muted">Gestion des opérations de souscription, rachats, arbitrages, avenants et conservation des documents.</p>
          <h4>6. Obligations de vigilance et conformité</h4>
          <p class="muted">Application des dispositifs <strong>LCB-FT</strong>, <strong>RGPD</strong> et <strong>DDA</strong>, incluant la vérification d’identité et la collecte de justificatifs.</p>

          <hr />
          <h3><strong>C. Références légales</strong></h3>
          <ul>
            <li><strong>Code des assurances</strong> : Articles <strong>L.511-1 à L.511-3</strong></li>
            <li><strong>Code monétaire et financier</strong> : Article <strong>L.541-1</strong></li>
            <li><strong>Directive (UE) 2016/97</strong> dite <strong>DDA</strong></li>
            <li><strong>Directive (UE) 2014/65</strong> dite <strong>MIF 2</strong></li>
          </ul>
          <p>Un questionnaire de détermination du profil investisseur a été complété.</p>
          {% if risque_latest and risque_latest.confirmation_client is not none %}
            {% set _conf = (risque_latest.confirmation_client|string).lower() %}
            {% if _conf == 'oui' %}
              <p>Vous avez validé le profil de risque déterminé par le questionnaire.</p>
            {% else %}
              <p>le risque choisi est différent de celui déterminé par le questionnaire, le client reconnaît avoir été informé de cet écart et assume pleinement la responsabilité de ce choix.</p>
            {% endif %}
          {% endif %}

          <hr />
          <h3><strong>D. Déroulement de la mission</strong></h3>
          <ol>
            <li>Remise du <strong>Document d’Entrée en Relation</strong>, signé le {{ lm_today }}.</li>
            <li>Signature du <strong>recueil d’informations patrimoniales</strong>, le {{ lm_today }}.</li>
            <li>Signature électronique de la <strong>présente lettre de mission</strong>.</li>
            <li>Élaboration et remise du <strong>rapport d’adéquation</strong> documentant la cohérence des solutions proposées avec vos objectifs.</li>
          </ol>
          <p>La mission débute dès réception des éléments nécessaires à l’analyse complète de votre situation.</p>

          <hr />
          <h3><strong>E. Suivi et révision</strong></h3>
          <p>Un suivi régulier est prévu, comprenant :</p>
          <ul>
            <li>Des <strong>rendez-vous périodiques</strong> selon vos besoins,</li>
            <li>Un <strong>bilan patrimonial</strong> actualisé tous les deux ans,</li>
            <li>Et, le cas échéant, un point intermédiaire sur demande.</li>
          </ul>
          <p>Toute évolution importante de votre situation (revenus, patrimoine, projets, profil de risque) doit être portée à notre connaissance pour mise à jour de votre dossier.</p>

          <hr />
          <h3><strong>F. Durée et dénonciation</strong></h3>
          <p>La mission est conclue pour une durée <strong>d’un an</strong>, renouvelable par tacite reconduction.<br/>
          Elle peut être résiliée à tout moment par simple notification écrite, sous réserve d’un <strong>préavis d’un mois</strong>.</p>

          <hr />
          <h3><strong>G. Communication et supports d’information</strong></h3>
          <p>Le Client accepte la communication d’informations sur <strong>support durable autre que le papier</strong>, via :</p>
          <ul>
            <li>Courriel sécurisé,</li>
            <li>Espace client en ligne,</li>
            <li>Ou courrier postal.</li>
          </ul>
          <p>Les documents resteront consultables et téléchargeables pendant la durée légale requise.</p>

          <hr />
          <h3><strong>H. Coûts et rémunérations</strong></h3>
          {% if lm_remunerations and (lm_remunerations|length > 0) %}
            <ul>
              {% for r in lm_remunerations %}
                <li>
                  <strong>{{ r.mode or r.type or 'Mode' }} :</strong>
                  {% set has_val = false %}
                  {% if r.montant is not none %}
                    {% set has_val = true %} {{ r.montant }} €
                  {% endif %}
                  {% if r.pourcentage is not none %}
                    {% if has_val %} — {% endif %}{{ r.pourcentage }} %
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">Rémunérations: non renseigné pour ce courtier.</p>
          {% endif %}
          <p>Ces rémunérations couvrent les prestations de conseil, de suivi et d’intermédiation.<br/>
          Un détail complet peut être fourni sur simple demande.</p>

          <hr />
          <h3><strong>I. Droits et obligations réciproques</strong></h3>
          <p>Le Courtier est tenu à une <strong>obligation de moyens</strong> et non de résultat.<br/>
          Le Client s’engage à fournir des informations exactes et à informer le cabinet de toute modification significative de sa situation.</p>
          <p>Le Client autorise le Courtier à obtenir auprès des compagnies d’assurance ou établissements financiers les données nécessaires au suivi de ses contrats.<br/>
          Le Courtier est tenu au <strong>secret professionnel</strong> (article L.519-6 du Code monétaire et financier).</p>

          <hr />
          <h3><strong>J. Protection des données personnelles (RGPD)</strong></h3>
          <p>Les données personnelles sont traitées conformément au <strong>Règlement (UE) 2016/679 (RGPD)</strong> et à la <strong>loi Informatique et Libertés</strong>.<br/>
          Elles sont utilisées pour l’analyse, la souscription et le suivi des contrats d’assurance-vie, et conservées pendant la durée de la relation contractuelle, puis <strong>5 ans</strong> après sa fin.</p>
          <p>Vous disposez des droits d’accès, de rectification, d’effacement, de limitation, de portabilité et d’opposition.<br/>
          Pour les exercer :<br/>
          <strong>{{ DER_courtier.responsable_dpo }} – {{ DER_courtier.courriel }}</strong><br/>
          Vous pouvez également saisir la <strong>CNIL</strong> (www.cnil.fr).</p>

          <hr />
          <h3><strong>K. Droit applicable et litiges</strong></h3>
          <p>La présente lettre de mission est régie par le <strong>droit français</strong>.<br/>
          En cas de désaccord, les parties privilégieront une solution amiable avant toute procédure judiciaire.<br/>
          À défaut, compétence exclusive est donnée aux <strong>juridictions françaises</strong>.</p>

          <hr />
          <h3><strong>L. Réclamations et médiation</strong></h3>
          <p>Toute réclamation peut être adressée à :<br/>
          <strong>Courtage du Centre – Service Réclamations</strong><br/>
          23 rue du quai, 56150 Chatillon sur Saône<br/>
          Email : jc@cc.fr</p>
          <p>En cas d’absence de solution amiable, le Client peut saisir :<br/>
          <strong>{{ centre_mediation_lib or DER_courtier.centre_mediation }}</strong><br/>
          Contact : banqueroute@acpr.fr</p>

          <hr />
          <h3><strong>M. Délai de rétractation (en cas de démarchage)</strong></h3>
          <p>Conformément à l’article <strong>L.341-16 du Code monétaire et financier</strong>,<br/>
          si cette mission résulte d’un <strong>acte de démarchage</strong>, vous disposez d’un <strong>délai de 14 jours calendaires révolus</strong> pour exercer votre droit de rétractation, sans avoir à justifier de motif ni supporter de pénalité.<br/>
          Le délai court à compter de la signature électronique de la présente lettre.</p>

          <hr />
          <h3><strong>Validation et consentement électronique</strong></h3>
          <p>En validant électroniquement cette lettre de mission sur la plateforme sécurisée,<br/>
          <strong>{{ client.prenom }} {{ client.nom }}</strong> reconnaît avoir :</p>
          <ul>
            <li>pris connaissance de l’intégralité du document,</li>
            <li>compris la portée des engagements réciproques,</li>
            <li>et accepté la mission dans les conditions exposées.</li>
          </ul>
          <p>La signature électronique apposée ci-dessous vaut <strong>consentement exprès</strong>, conformément à l’article <strong>1367 du Code civil</strong> et au <strong>Règlement eIDAS (UE) n°910/2014</strong> sur l’identification électronique et les services de confiance.</p>

          <hr />
          <p><strong>Date de signature électronique :</strong> {{ date_signature }}<br/>
          <strong>Identifiant de transaction :</strong> {{ signature_id }}</p>
          <p><strong>Signature électronique du client :</strong> ✍️<br/>
          <strong>Signature électronique du courtier :</strong> ✍️</p>

          <hr />
          <p><strong>{{ DER_courtier.nom_cabinet }}</strong> – Courtier en assurance-vie et produits financiers<br/>
          Immatriculé à l’ORIAS n° {{ DER_courtier.numero_orias }} – Adhérent {{ DER_courtier.association_prof }}</p>
</div>

      </div>
    </div>
  </div>
  <!-- Modale Conformité: 3 boutons pilule -->
  <div class="modal-overlay" id="confMainModal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" style="width:720px; max-width:95vw;">
      <div class="modal-header"><h3>Conformité</h3><button class="modal-close" onclick="document.getElementById('confMainModal').style.display='none'">✕</button></div>
      <div class="modal-body" style="display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap;">
        <button type="button" class="kyc-main-btn" onclick="closeConfMain(); openConfEerDetail()"><i class="fa-solid fa-file-signature"></i>DER</button>
        <button type="button" class="kyc-main-btn" onclick="closeConfMain(); openConfConnaissanceDetail()"><i class="fa-solid fa-user-check"></i>Connaissance client</button>
        <button type="button" class="kyc-main-btn" onclick="closeConfMain(); openConfMissionDetail()"><i class="fa-solid fa-file-contract"></i>Lettre de Mission</button>
        <button type="button" class="kyc-main-btn" onclick="closeConfMain(); openConfAdequationDetail()"><i class="fa-solid fa-file-circle-check"></i>Lettre d’adéquation</button>
        <button type="button" class="kyc-main-btn" onclick="closeConfMain(); openConfTacfinDetail()"><i class="fa-solid fa-shield-halved"></i>TRACFIN / FATCA</button>
      </div>
    </div>
  </div>
  <!-- Accordéon Conformité (détail client) -->
  <div id="confToggleDetail" class="card accordion-toggle" onclick="openConfMain()" style="margin-top:10px;">
      <h3 style="margin:0;">Conformité</h3>
      <span class="chevron">▸</span>
    </div>
  

  <!-- Modal: Messages/Tâches client (filtré par type réglementaire / non réglementaire) -->
  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-card { background: #fff; border-radius: 12px; width: 780px; max-width: 95vw; max-height: 92vh; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
    .modal-header h3 { margin: 0; font-size: 1.05rem; }
    .modal-body { padding: 12px 14px; }
    .modal-close { border:none; background: transparent; cursor: pointer; font-size: 18px; }
    /* Harmonisation colonnes pop-up Messages */
    #clientMsgsTable { table-layout: fixed; width: 100%; }
    #clientMsgsTable th:nth-child(1), #clientMsgsTable td:nth-child(1) { width: 12%; }
    #clientMsgsTable th:nth-child(2), #clientMsgsTable td:nth-child(2) { width: 16%; }
    #clientMsgsTable th:nth-child(3), #clientMsgsTable td:nth-child(3) { width: 14%; }
    #clientMsgsTable th:nth-child(4), #clientMsgsTable td:nth-child(4) { width: 12%; }
    #clientMsgsTable th:nth-child(5), #clientMsgsTable td:nth-child(5) { width: 12%; }
    #clientMsgsTable th:nth-child(6), #clientMsgsTable td:nth-child(6) { width: 26%; }
    #clientMsgsTable th:nth-child(7), #clientMsgsTable td:nth-child(7) { width: 8%; text-align:center; }
    #clientMsgsTable td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #clientMsgsTable td:nth-child(6) { white-space: normal; word-break: break-word; }
  </style>
  <div id="clientMsgsModal" class="modal-overlay" onclick="if(event.target===this) closeClientMsgs()">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="clientMsgsTitle"><i class="fa-solid fa-envelope" style="margin-right:8px;"></i>Messages</h3>
        <button class="modal-close" onclick="closeClientMsgs()">✕</button>
      </div>
      <div class="modal-body">
        <table id="clientMsgsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Catégorie</th>
              <th>Statut</th>
              <th>Contrat</th>
              <th>Commentaire</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Actions rapides -->
  
  <!-- Tâches: accordéon local -->
  <div id="clientTasksToggle" class="card accordion-toggle" onclick="openTaskPopup()"><h3 style="margin:0;">Définir une tâche</h3><span class="chevron">▾</span></div>
  
  <!-- Popup temporaire de création de tâche -->
  <style>
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-card { background: #fff; border-radius: 12px; width: 640px; max-width: 92vw; max-height: 92vh; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
    .modal-header h3 { margin: 0; font-size: 1.05rem; }
    .modal-body { padding: 12px 14px; }
    .modal-close { border:none; background: transparent; cursor: pointer; font-size: 18px; }
  </style>
  <div id="taskModal" class="modal-overlay" onclick="if(event.target===this) closeTaskPopup()">
    <div class="modal-card">
      <div class="modal-header">
        <h3><i class="fa-solid fa-list-check" style="margin-right:8px;"></i>Définir une tâche</h3>
        <button class="modal-close" onclick="closeTaskPopup()">✕</button>
      </div>
      <div class="modal-body task-block">
        <style>
          #taskCreateForm select.select-choice { height: 36px; }
        </style>
        <div id="taskToast" class="badge success" style="display:none; margin-bottom:8px;">Tâche enregistrée.</div>
        <form method="post" action="/dashboard/clients/{{ client.id }}/taches" id="taskCreateForm">
          <div class="form-row" style="margin-bottom:.6rem;">
            <div class="field">
              <label>Client (Nom Prénom)</label>
              <input type="text" name="client_fullname" list="clients_list_client_modal" placeholder="Nom Prénom" value="{{ client_fullname_default or '' }}" />
            </div>
            <div class="field">
              <label>Affaire (Référence)</label>
              <input type="text" name="affaire_ref" list="affaires_list_client_modal" placeholder="REF-0001" />
            </div>
            <div class="field">
              <label>Affecter à (RH)</label>
              <select class="select-choice" name="rh_id">
                <option value="">-- aucun --</option>
                {% for rh in rh_list %}
                  {% set rid = rh.id if rh.id is not none else rh[0] %}
                  {% set rnom = (rh.prenom if rh.prenom is defined else (rh[1] if rh|length>1 else '')) ~ ' ' ~ (rh.nom if rh.nom is defined else (rh[2] if rh|length>2 else '')) %}
                  <option value="{{ rid }}">{{ rnom.strip() }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-row" style="margin-bottom:.6rem;">
            <div class="field">
              <label>Catégorie</label>
              <select class="select-choice" name="categorie" id="client_cat_select_modal">
                <option value="">-- choisir --</option>
                {% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
              </select>
            </div>
            <div class="field">
              <label>Type</label>
              <select class="select-choice" name="type_libelle" id="client_type_select_modal">
                <option value="">-- choisir une catégorie --</option>
              </select>
            </div>
            <div class="field" style="align-self:center;">
              <label>&nbsp;</label>
              <button type="button" id="client_comm_btn_modal" class="btn btn-choice" onclick="toggleClientCommModal()">Préparer une communication</button>
              <input type="hidden" id="client_comm_toggle_modal" name="comm_toggle" value="0" />
            </div>
          </div>

          <div id="client_comm_block_modal" style="display:none; border:1px dashed var(--border); padding:.8rem; border-radius:10px; margin-bottom:.6rem;">
            <div class="form-row" style="margin-bottom:.6rem;">
              <div class="field">
                <label>Canal</label>
                <select class="select-choice" name="comm_canal">
                  <option value="email">email</option>
                  <option value="courrier">courrier</option>
                  <option value="sms">sms</option>
                </select>
              </div>
              <div class="field">
                <label>Destinataire</label>
                <input class="input-large" type="text" name="comm_destinataire" placeholder="email ou adresse" />
              </div>
              <div class="field">
                <label>Objet</label>
                <input class="input-large" type="text" name="comm_objet" placeholder="Objet du message" />
              </div>
            </div>
            <div>
              <label>Contenu</label>
              <textarea class="input-large" name="comm_contenu" rows="3" placeholder="Contenu du message..." style="width:100%;"></textarea>
            </div>
          </div>

          <div style="margin-bottom:.6rem;">
            <label>Commentaire</label>
            <textarea name="commentaire" rows="3" placeholder="Détails / notes…"></textarea>
          </div>

          <div style="display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
            <div style="flex:1 1 100%;">
              <label>Statut initial</label>
              <div id="client_initial_status_modal" style="display:flex; gap:.4rem; flex-wrap:wrap; align-items:center;">
                {% for s in status_ui %}
                  <button type="button" class="btn btn-choice" data-sid="{{ s.id }}" data-key="{{ s.key }}" onclick="clientSelectStatusModal(this)">{{ s.label }}</button>
                {% endfor %}
                {% if en_cours_id %}
                  <button type="button" id="client_en_cours_btn_modal" class="btn btn-choice" style="display:none; background:#16a34a; color:#fff; border-color:#16a34a; text-transform:none;" data-sid="{{ en_cours_id }}" onclick="clientSelectStatusModal(this)">en cours</button>
                {% endif %}
                <input type="hidden" name="statut_id" id="client_statut_id_modal" value="" />
              </div>
            </div>
          </div>
          <div class="create-btn-container">
            <button class="btn btn-primary btn-choice" style="min-width:160px;" type="submit"><i class="fa-solid fa-plus"></i>Créer</button>
          </div>

          <datalist id="clients_list_client_modal">
            {% for c in clients_suggest %}
              <option value="{{ ((c.nom or '') ~ ' ' ~ (c.prenom or '')) | trim }}"></option>
            {% endfor %}
          </datalist>
          <datalist id="affaires_list_client_modal"></datalist>
        </form>
      </div>
    </div>
  </div>
  

  <script>
    // --- Messages header buttons & modal ---
    const CLIENT_EVENTS_OPEN = {{ client_events_open | tojson }};
    function _normCat(s){ if(!s) return ''; return (s+'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replaceAll('ç','c').replaceAll('Ç','c'); }
    function openClientMsgs(kind){
      const modal = document.getElementById('clientMsgsModal');
      const tbody = modal.querySelector('tbody');
      tbody.innerHTML = '';
      const isReg = (kind === 'reg');
      const title = document.getElementById('clientMsgsTitle');
      title.innerHTML = (isReg ? '<i class="fa-solid fa-envelope"></i>Messages réglementaires' : '<i class="fa-solid fa-envelope"></i>Messages non réglementaires');
      const rows = (CLIENT_EVENTS_OPEN||[]).filter(ev => {
        const cat = _normCat(ev.type_categorie);
        const reg = (cat === 'reglementaire');
        return isReg ? reg : !reg;
      });
      function statusStyle(label){
        const s = (label||'').toLowerCase();
        if (s === 'en cours') return 'background:#16a34a; color:#fff; border-color:#16a34a;';
        if (s === 'en attente') return 'background:#f59e0b; color:#fff; border-color:#f59e0b;';
        if (s === 'terminé' || s === 'termine') return 'background:#4b5563; color:#fff; border-color:#4b5563;';
        if (s === 'annulé' || s === 'annule') return 'background:#b91c1c; color:#fff; border-color:#b91c1c;';
        return '';
      }
      function openTaskEditPopup(id){
        try {
          var w = 1100, h = 800;
          var left = Math.max(0, Math.floor(((screen.availWidth||screen.width||w) - w) / 2));
          var top = Math.max(0, Math.floor(((screen.availHeight||screen.height||h) - h) / 2));
          var feat = 'scrollbars=yes,resizable=yes' + ',width=' + w + ',height=' + h + ',left=' + left + ',top=' + top;
          var win = window.open('/dashboard/taches/'+id, 'taskEdit'+id, feat);
          if (win && win.focus) { try { win.focus(); } catch(e){} }
        } catch(e){}
      }
      rows.forEach(ev => {
        const tr = document.createElement('tr');
        // helpers
        function td(v){ const td = document.createElement('td'); td.textContent = v==null?'':v; return td; }
        function tdEl(el){ const td = document.createElement('td'); td.appendChild(el); return td; }
        // date, type, catégorie
        tr.appendChild(td(ev.date_evenement||''));
        tr.appendChild(td(ev.type_libelle||''));
        tr.appendChild(td(ev.type_categorie||''));
        // statut cliquable -> nouvelle fenêtre d'édition
        const sb = document.createElement('a');
        sb.className = 'btn btn-choice';
        sb.textContent = ev.statut || 'à faire';
        sb.style.cssText = 'padding:2px 6px; font-size:11px; border-radius:4px; ' + statusStyle(ev.statut||'');
        sb.href = '/dashboard/taches/' + (ev.id||'');
        sb.target = '_blank';
        sb.rel = 'noopener noreferrer';
        const statTd = document.createElement('td'); statTd.appendChild(sb);
        var rh = ev.rh_nom || ev.rh || ev.rhnom;
        if (rh){ const b=document.createElement('span'); b.className='badge'; b.textContent='RH: '+rh; b.style.marginLeft='6px'; statTd.appendChild(b); }
        tr.appendChild(statTd);
        // contrat (ref)
        tr.appendChild(td(ev.affaire_ref||''));
        // commentaire avec voir plus/moins
        const ctd = document.createElement('td');
        const full = String(ev.commentaire||'');
        const short = full.slice(0, 180);
        const sid = 'ccli-short-' + (ev.id||Math.random());
        const fid = 'ccli-full-' + (ev.id||Math.random());
        const sdiv = document.createElement('div');
        sdiv.id = sid; sdiv.style.whiteSpace='pre-wrap';
        if (full.length <= 180) sdiv.style.display='none';
        sdiv.textContent = short + (full.length>180 ? '…' : '');
        const fdiv = document.createElement('div');
        fdiv.id = fid; fdiv.style.whiteSpace='pre-wrap';
        if (full.length > 180) fdiv.style.display='none';
        fdiv.textContent = full;
        ctd.appendChild(sdiv); ctd.appendChild(fdiv);
        if (full.length > 180){
          const a = document.createElement('a'); a.href='#'; a.style.fontSize='12px'; a.textContent='Voir plus';
          a.addEventListener('click', function(e){ e.preventDefault(); const sh=document.getElementById(sid); const fl=document.getElementById(fid); const isShort = sh.style.display !== 'none'; sh.style.display = isShort? 'none':''; fl.style.display = isShort? '':'none'; this.textContent = isShort? 'Voir moins':'Voir plus'; });
          const wrap = document.createElement('div'); wrap.appendChild(a); ctd.appendChild(wrap);
        }
        tr.appendChild(ctd);
        // action Modifier
        const actionTd = document.createElement('td');
        const editBtn = document.createElement('button');
        editBtn.type='button'; editBtn.className='btn btn-choice'; editBtn.style.cssText='padding:2px 6px; font-size:11px; border-radius:4px;';
        editBtn.textContent = 'Modifier';
        editBtn.addEventListener('click', function(){ openTaskEditPopup(ev.id); });
        actionTd.appendChild(editBtn);
        tr.appendChild(actionTd);
        // dblclick ligne
        tr.addEventListener('dblclick', function(){ openTaskEditPopup(ev.id); });
        tbody.appendChild(tr);
      });
      // DataTable avec export CSV
      try {
        if (window.clientMsgsDT) { window.clientMsgsDT.destroy(); }
      } catch(e) {}
      try {
        window.clientMsgsDT = $('#clientMsgsTable').DataTable({
          destroy: true,
          paging: true,
          pageLength: 25,
          fixedHeader: false,
          dom: 'Bfrtip',
          buttons: [ { extend: 'csvHtml5', text: 'Exporter CSV', title: 'messages_client_{{ client.id }}', bom: true, charset: 'utf-8', fieldSeparator: ';' } ],
          order: [[0,'desc']],
          columnDefs: [ { targets: [0,1,2,3,4], className: 'nowrap' } ]
        });
      } catch(e) {}
      modal.style.display = 'flex';
    }
    function closeClientMsgs(){ document.getElementById('clientMsgsModal').style.display = 'none'; }

    function openTaskPopup(){ document.getElementById('taskModal').style.display='flex'; }
    function closeTaskPopup(){ document.getElementById('taskModal').style.display='none'; }
    function toggleClientCommModal(){ const h=document.getElementById('client_comm_toggle_modal'); const on=h.value==='1'?false:true; h.value=on?'1':'0'; document.getElementById('client_comm_block_modal').style.display=on?'block':'none'; document.getElementById('client_comm_btn_modal').classList.toggle('btn-choice-active', on); }
    function normName(s){ return (s||'').trim().replace(/\s+/g,' ').toLowerCase(); }
    function updateClientAffairesModal(){ const inp=document.querySelector('#taskModal input[name="client_fullname"]'); const val=normName(inp?inp.value:''); const dl=document.getElementById('affaires_list_client_modal'); if(!dl) return; dl.innerHTML=''; const data = [
      {% for a in affaires_suggest %}
        { ref: {{ a.ref|tojson }}, client: {{ a.client|tojson }} },
      {% endfor %}
    ]; (val? data.filter(a=>normName(a.client)===val): data).forEach(a=>{ const o=document.createElement('option'); o.value=a.ref; o.textContent=`${a.ref} — ${a.client}`; dl.appendChild(o); }); }
    (function initTaskModal(){
      const inp=document.querySelector('#taskModal input[name="client_fullname"]'); if(inp){ inp.addEventListener('input', updateClientAffairesModal); inp.addEventListener('change', updateClientAffairesModal); }
      updateClientAffairesModal();
      const types = [
        {% for t in types %}
          { libelle: {{ t.libelle|tojson }}, categorie: {{ t.categorie|tojson }} },
        {% endfor %}
      ];
      const cat=document.getElementById('client_cat_select_modal'); const typ=document.getElementById('client_type_select_modal');
      function sync(){ typ.innerHTML=''; if(!cat.value){ const o=document.createElement('option'); o.value=''; o.textContent='-- choisir une catégorie --'; typ.appendChild(o); return; } const list=types.filter(t=>t.categorie===cat.value).map(t=>t.libelle); list.forEach(l=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; typ.appendChild(o); }); if(list.length>0) typ.value=list[0]; }
      if (cat){ cat.addEventListener('change', sync); if(cat.value) sync(); }
    })();
    // Interception envoi tâche pour rester dans la modale
    (function(){
      try{
        var tf = document.getElementById('taskCreateForm');
        if (tf){
          tf.addEventListener('submit', function(ev){
            try{ ev.preventDefault(); }catch(e){}
            var fd = new FormData(tf);
            fetch(tf.getAttribute('action') || window.location.href, { method: 'POST', body: fd, credentials: 'same-origin' })
              .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
              .then(function(){ var t=document.getElementById('taskToast'); if(t){ t.style.display='inline-block'; setTimeout(function(){ t.style.display='none'; closeTaskPopup(); }, 1200); } })
              .catch(function(err){ console.warn('Task save failed', err); });
          });
        }
      }catch(e){}
    })();
    function clientSelectStatusModal(btn){ const sid=btn.getAttribute('data-sid'); const key=btn.getAttribute('data-key'); document.getElementById('client_statut_id_modal').value=sid; const peers=document.getElementById('client_initial_status_modal').querySelectorAll('button'); peers.forEach(b=>{ b.classList.remove('btn-primary'); b.classList.remove('btn-choice-active');}); btn.classList.add('btn-primary'); btn.classList.add('btn-choice-active'); const ec=document.getElementById('client_en_cours_btn_modal'); if(ec){ ec.style.display=(key==='a faire'||key==='en attente')?'inline-block':'none'; } }

  </script>

  <style>
    /* Sélection visuelle des lignes dans la pop-up Messages */
    #clientMsgsTable tbody tr:hover { background: #f3f6ff; }
    #clientMsgsTable tbody tr.row-selected { background: #e9f0ff; border-left: 3px solid var(--primary); }
  </style>
  <!-- Accordéons vides pour structurer la page (à compléter comme pour Affaires) -->
  <div id="invToggle" class="card accordion-toggle"><h3 style="margin:0;">Investissements</h3><span class="chevron">▾</span></div>
  <div id="invSection" class="card" style="display:none;">
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <h3 style="margin:4px 8px 8px 0;">Contrats du client</h3>
      {% if available_dates %}
        <label for="asOfSelect" class="muted" style="font-size:0.85rem;">Date effective:</label>
        <select id="asOfSelect" style="padding:4px 8px; font-size:0.9rem; width:12ch; min-width:12ch;">
          {% for d in available_dates %}
            <option value="{{ d }}" {% if d == as_of_effective %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      {% endif %}
    </div>
    <table id="contractsTable">
      <thead>
        <tr>
          <th>Contrat</th>
          <th>SRRI</th>
          <th>Date début</th>
          <th>Montant</th>
          <th>Perf. 52s</th>
          <th>Volat. 52s</th>
        </tr>
      </thead>
      <tbody>
        {% for a in client_affaires %}
        <tr class="{% if a.date_cle %}highlight-cle{% endif %}">
          <td>
            <a href="/dashboard/affaires/{{ a.id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ a.ref }}</a>
            {% if a.date_cle %}<span class="badge-closed">Le contrat est clôturé ({{ (a.date_cle|string)[:10] }})</span>{% endif %}
          </td>
          <td style="text-align:center;">
            {{ a.SRRI }}
            {% if a.srri_icon %}
              {% if a.srri_icon == 'fire' %}
                <span class="srri-dot srri-blue" title="Au‑dessus" aria-hidden="true"></span>
              {% elif a.srri_icon == 'hands-praying' %}
                <span class="srri-dot srri-green" title="Identique" aria-hidden="true"></span>
              {% elif a.srri_icon == 'snowflake' %}
                <span class="srri-dot srri-red" title="En‑dessous" aria-hidden="true"></span>
              {% else %}{% endif %}
              <span class="srri-calc" style="margin-left:6px; font-size:11px; color:#666;">{{ a.srri_calc }}</span>
            {% endif %}
          </td>
          <td class="center">{{ (a.date_debut|string)[:10] if a.date_debut else '' }}</td>
          <td style="text-align:right;">{{ a.last_valo_str }}</td>
          <td style="text-align:right;">{% if a.last_perf_pct is not none %}{{ '%.2f'|format(a.last_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if a.last_vol_pct is not none %}{{ '%.2f'|format(a.last_vol_pct) }} %{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3 style="margin-top:14px;">Supports consolidés (tous contrats)</h3>
    <table id="supportsClient">
      <thead>
        <tr>
          <th>ISIN</th>
          <th>Support</th>
          <th>SRRI</th>
          <th>Nb UC</th>
          <th>PRMP</th>
          <th>Valorisation</th>
          <th>E</th>
          <th>S</th>
          <th>G</th>
        </tr>
      </thead>
      <tbody>
        {% for s in client_supports %}
        <tr>
          <td>{{ s.code_isin or '' }}</td>
          <td>{{ s.nom or '' }}</td>
          <td class="center">{{ s.srri_support or '' }}</td>
          <td style="text-align:right;">{{ s.nbuc_str }}</td>
          <td style="text-align:right;">{{ s.prmp_str }}</td>
          <td style="text-align:right;">{{ s.valo_str }}</td>
          <td class="center">{{ s.noteE or '' }}</td>
          <td class="center">{{ s.noteS or '' }}</td>
          <td class="center">{{ s.noteG or '' }}</td>
        </tr>
        {% endfor %}
        {% if not client_supports %}
        <tr><td colspan="9" class="muted">Aucun support consolidé trouvé.</td></tr>
        {% endif %}
      </tbody>
    </table>

    <div class="pie-grid" style="margin-top:8px;">
      <div class="pie-card">
        <h3 class="chart-title">Répartition par catégorie</h3>
        <div class="dim-buttons" style="display:flex; gap:6px; margin-bottom:6px; flex-wrap:wrap;">
          <button type="button" class="dim-btn active" data-field="cat_gene">Catégorie générale</button>
          <button type="button" class="dim-btn" data-field="cat_principale">Catégorie principale</button>
          <button type="button" class="dim-btn" data-field="cat_det">Catégorie détaillée</button>
        </div>
        <canvas id="clientCatChart" height="220"></canvas>
      </div>
      <div class="pie-card">
        <h3 class="chart-title">Répartition géographique du secteur</h3>
        <canvas id="clientGeoChart" height="220"></canvas>
      </div>
    </div>
  </div>

  <!-- Accordéon ESG (client), placé sous Investissements -->
  <div id="esgToggleClient" class="card accordion-toggle"><h3 style="margin:0;">ESG</h3><span class="chevron">▾</span></div>
  <div id="esgSectionClient" style="display:none;">
    <div class="card" style="margin-top:8px; width:100%; box-sizing:border-box;">
      <h3 class="chart-title">Comparaison ESG Client vs Indice</h3>
      <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px 0;">
        <div>
          <label class="muted" style="font-size:0.85rem;">Allocation de référence</label><br>
          <select id="esgAllocSelectClient" style="min-width:220px; max-width:280px; width:auto;">
            <option value="">— choisir —</option>
            {% for nm in alloc_names %}<option value="{{ nm }}">{{ nm }}</option>{% endfor %}
          </select>
        </div>
        <div style="display:none;">
          <label class="muted" style="font-size:0.85rem;">Date</label><br>
          <select id="esgAllocDateClient" style="width: 14ch; min-width: 14ch;"></select>
        </div>
        <div style="flex:1 1 auto; min-width:260px;">
          <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
          <div id="esgFieldsClient" style="display:flex; gap:6px; flex-wrap:wrap;">
            {% if esg_field_labels %}
              {% for col, label in esg_field_labels.items() %}
                <button type="button" class="dim-btn esg-field-client" data-field="{{ col }}" title="{{ label or col }}">{{ label or col }}</button>
              {% endfor %}
            {% elif esg_fields %}
              {% for it in esg_fields %}
                {% set col = it.col if it is mapping else it %}
                {% set label = (it.label if it is mapping else it) %}
                <button type="button" class="dim-btn esg-field-client" data-field="{{ col }}" title="{{ label or col }}">{{ label or col }}</button>
              {% endfor %}
            {% else %}
              <span class="muted">Aucun champ ESG détecté</span>
            {% endif %}
          </div>
        </div>
        <div>
          <button id="esgRefreshBtnClient" class="rangeBtn" type="button" title="Actualiser">Actualiser</button>
        </div>
      </div>
      <div id="esgChartClient" style="height:320px; width:100%;"></div>
      <div class="muted" style="margin-top:6px; font-size:12px;">Indice normalisé à 100. Client = valeur relative (Client / Indice × 100).</div>
    </div>
  </div>

  <div id="graphsToggle" class="card accordion-toggle"><h3 style="margin:0;">Graphiques</h3><span class="chevron">▾</span></div>
  <div id="graphsSection" style="display:none;">
    <div class="card">
      <h3>Historique de valorisation et cumul des mouvements</h3>
      <canvas id="valoChart" height="120"></canvas>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>Performances et volatilité annuelles</h3>
      <canvas id="clientAnnuelChart" height="120"></canvas>
    </div>
    <div class="card" style="margin-top:12px;">
      <h3>Évolution des allocations (SICAV)</h3>
      <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; margin:6px 0 8px 0;">
        <div>
          <label class="muted" style="font-size:0.85rem;">Sélection d'allocations</label><br>
          <select id="allocSelectClient"></select>
        </div>
        <div>
          <label class="muted" style="font-size:0.85rem;">Période</label><br>
          <button class="rangeBtn" data-range="all">Tout</button>
          <button class="rangeBtn" data-range="365">1 an</button>
          <button class="rangeBtn" data-range="180">6 mois</button>
          <button class="rangeBtn" data-range="90">3 mois</button>
          <button class="rangeBtn" data-range="30">1 mois</button>
        </div>
      </div>
      <canvas id="clientAllocChart" height="120"></canvas>
    </div>
    
    
  </div>

  <!-- Cadre indépendant: Performances et volatilité annuelles -->

  <div id="reportToggle" class="card accordion-toggle" style="border-left-color: var(--primary);"><h3 style="margin:0;">Reportings pluriannuels</h3><span class="chevron">▾</span></div>
  <div id="reportSection" class="card" style="display:none;">
    {% if reporting_years %}
    <table style="font-size:12px;">
      <thead>
        <tr>
          <th>Année</th>
          <th style="text-align:right;">Versements</th>
          <th style="text-align:right;">Retraits</th>
          <th style="text-align:right;">Solde annuel</th>
          <th style="text-align:right;">Solde cumulé</th>
          <th style="text-align:right;">Valo fin d'année</th>
          <th style="text-align:right;">Perf fin d'année</th>
          <th style="text-align:right;">Cumul perf</th>
          <th style="text-align:right;">Perf annualisée</th>
          <th style="text-align:right;">Vol. 52s (fin)</th>
          <th style="text-align:right;">Vol. moyenne</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reporting_years %}
        <tr>
          <td style="text-align:center;">{{ r.year }}</td>
          <td style="text-align:right;">{{ r.versements_str }}</td>
          <td style="text-align:right;">{{ r.retraits_str }}</td>
          <td style="text-align:right;">{{ r.solde_str }}</td>
          <td style="text-align:right;">{{ r.solde_cum_str }}</td>
          <td style="text-align:right;">{{ r.last_valo_str }}</td>
          <td style="text-align:right;">{% if r.last_perf_pct is not none %}{{ '%.2f'|format(r.last_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.cum_perf_pct is not none %}{{ '%.2f'|format(r.cum_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.ann_perf_pct is not none %}{{ '%.2f'|format(r.ann_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.last_vol_pct is not none %}{{ '%.2f'|format(r.last_vol_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.avg_vol_pct is not none %}{{ '%.2f'|format(r.avg_vol_pct) }} %{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="muted" style="margin-top:6px; font-size:12px;">
      <div>Les pourcentages sont exprimés en % (valeurs décimales converties).</div>
      <div>La performance annualisée correspond à la performance cumulée observée à la date, ramenée en taux annuel fixe (CAGR).</div>
    </div>
    {% else %}
      <div class="muted">Aucune donnée annuelle disponible.</div>
    {% endif %}
  </div>

  <!-- (section Graphiques fusionnée ci-dessus) -->

  <!-- Documents accordion -->
  <div id="docsToggle" class="card accordion-toggle"><h3 style="margin:0;">Documents</h3><span class="chevron">▾</span></div>
  <div id="docsSection" class="card" style="display:none;">
    <h3>Documents du client</h3>
    <form id="addDocForm" style="margin-bottom:12px; display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; align-items:end;">
      <div>
        <label>Type de document</label>
        <div>
          <select id="document_base_select" required>
            <option value="" disabled selected>Choisir…</option>
          </select>
        </div>
      </div>
      <div>
        <label>Nom document</label>
        <input type="text" id="nom_document" placeholder="ex: Pièce identité" />
      </div>
      <div>
        <label>Date création</label>
        <input type="date" id="date_creation" />
      </div>
      <div>
        <label>Date obsolescence</label>
        <input type="date" id="date_obsolescence" />
      </div>
      <div>
        <label>Statut</label>
        <input type="text" id="obsolescence" placeholder="valide / expiré" />
      </div>
      <div>
        <button type="submit">Ajouter</button>
      </div>
    </form>

    <table id="clientDocs" class="display nowrap" style="width:100%">
      <thead>
        <tr>
          <th>Type (base)</th><th>Nom (libellé)</th><th>Date création</th><th>Date obsolescence</th><th>Statut</th><th>Action</th>
        </tr>
        <tr>
          <th><input type="text" id="cd-type-filter" placeholder="Filtrer..."></th>
          <th><input type="text" id="cd-nom-filter" placeholder="Filtrer..."></th>
          <th><input type="text" id="cd-cr-filter" placeholder="AAAA-MM-JJ"></th>
          <th><input type="text" id="cd-obsdate-filter" placeholder="AAAA-MM-JJ"></th>
          <th><select id="cd-status-filter"><option value="">Tous</option></select></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
      {% for d in documents_client %}
        <tr>
          <td>{{ d.base_name or '-' }}</td>
          <td>{{ d.nom_document or '-' }}</td>
          <td>{{ (d.date_creation|string)[:10] if d.date_creation else '-' }}</td>
          <td>{{ (d.date_obsolescence|string)[:10] if d.date_obsolescence else '-' }}</td>
          <td>{{ d.obsolescence or '-' }}</td>
          <td><button class="delBtn" data-id="{{ d.id }}">Supprimer</button></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <div class="card">Client introuvable.</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js: couleur par défaut (axes/labels) = bleu CSS
try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
</script>
<!-- jQuery + DataTables for client docs table and messages export -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script>
  // Accordéons mutualisés: un seul ouvert à la fois et possibilité de tout fermer
  (function(){
    var groups = [
      { key:'kyc', toggleId:'kycToggle', sectionId:'kycSection' },
      { key:'inv', toggleId:'invToggle', sectionId:'invSection' },
      { key:'esg', toggleId:'esgToggleClient', sectionId:'esgSectionClient' },
      { key:'graphs', toggleId:'graphsToggle', sectionId:'graphsSection' },
      { key:'report', toggleId:'reportToggle', sectionId:'reportSection' },
      { key:'docs', toggleId:'docsToggle', sectionId:'docsSection' },
    ];
    function byId(id){ return document.getElementById(id); }
    function setOpen(key){
      groups.forEach(function(g){
        var t = byId(g.toggleId), s = byId(g.sectionId);
        if (!t || !s) return;
        if (key && g.key === key){ s.style.display = ''; t.classList.remove('collapsed'); }
        else { s.style.display = 'none'; t.classList.add('collapsed'); }
      });
      try { localStorage.setItem('client_detail_open', key || ''); } catch(e) {}
    }
    // Restore last open
    var saved = '';
    try { saved = localStorage.getItem('client_detail_open') || ''; } catch(e) {}
    if (saved) setOpen(saved);
    // Wire clicks
    groups.forEach(function(g){
      var t = byId(g.toggleId), s = byId(g.sectionId);
      if (!t || !s) return;
      t.addEventListener('click', function(){
        var isOpen = s.style.display !== 'none';
        if (isOpen) { setOpen(''); }
        else { setOpen(g.key); try { t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {} }
      });
    });
  })();

  // Auto-sélection du type selon catégorie (client)
  (function(){
    try {
      const CTYPES = [
        {% for t in types %}
          { id: {{ t.id }}, libelle: {{ t.libelle|tojson }}, categorie: {{ t.categorie|tojson }} },
        {% endfor %}
      ];
      const catSel = document.getElementById('client_cat_select');
      const typeSel = document.getElementById('client_type_select');
      if (!catSel || !typeSel) return;
      function syncTypes(){
        const cat = catSel.value;
        typeSel.innerHTML='';
        if(!cat){ const o=document.createElement('option'); o.value=''; o.textContent='-- choisir une catégorie --'; typeSel.appendChild(o); return; }
        const list = CTYPES.filter(t=>t.categorie===cat).map(t=>t.libelle);
        list.forEach(lib=>{ const o=document.createElement('option'); o.value=lib; o.textContent=lib; typeSel.appendChild(o); });
        if (list.length>0) typeSel.value = list[0];
      }
      catSel.addEventListener('change', syncTypes);
      if (catSel.value) syncTypes();
    } catch(e) {}
  })();

  // Changement de date effective -> recharge avec param ?as_of=YYYY-MM-DD
  (function(){
    var sel = document.getElementById('asOfSelect');
    if (!sel) return;
    sel.addEventListener('change', function(){
      var v = this.value;
      var url = new URL(window.location.href);
      url.searchParams.set('as_of', v);
      window.location.href = url.toString();
    });
  })();

  // Charts de répartition basés sur supports consolidés
  (function(){
    var supportsData = {{ client_supports | tojson }};
    var catCtx = document.getElementById('clientCatChart');
    var geoCtx = document.getElementById('clientGeoChart');
    if (!catCtx || !geoCtx) return;
    catCtx = catCtx.getContext('2d');
    geoCtx = geoCtx.getContext('2d');
    var catChart, geoChart;
    function buildCatBar(field){
      var map = new Map();
      (supportsData||[]).forEach(function(s){
        var key = (s[field] || 'Non renseigné');
        var v = parseFloat(s.valo) || 0;
        map.set(key, (map.get(key)||0) + v);
      });
      var entries = Array.from(map.entries()).sort(function(a,b){return b[1]-a[1];});
      var labels = entries.map(function(e){return e[0];});
      var values = entries.map(function(e){return e[1];});
      if (catChart) catChart.destroy();
      catChart = new Chart(catCtx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ data: values, backgroundColor: 'var(--primary)' }] },
        options: { indexAxis: 'y', responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          layout:{ padding:{ top:10, bottom:6, right:8, left:8 } },
          scales:{ x:{ display:false, beginAtZero:true }, y:{ ticks:{ font:{ size:10 }, autoSkip:false, maxTicksLimit:20 } } },
          datasets:{ bar:{ categoryPercentage:0.7, barPercentage:0.8, maxBarThickness:18 } },
          onHover: function(evt, els){ if (els && els.length){ var idx=els[0].index; var label=labels[idx]; buildGeoBar(field, label); } }
        }
      });
      buildGeoBar(field, null);
      catCtx.canvas.addEventListener('mouseleave', function(){ buildGeoBar(field, null); });
    }
    function buildGeoBar(field, catValue){
      var map = new Map();
      (supportsData||[]).forEach(function(s){
        var cat = (s[field] || 'Non renseigné');
        if (catValue !== null && catValue !== undefined && String(cat) !== String(catValue)) return;
        var key = (s['cat_geo'] || 'Non renseigné');
        var v = Number(s.valo) || 0;
        map.set(key, (map.get(key)||0) + v);
      });
      var entries = Array.from(map.entries()).sort(function(a,b){return b[1]-a[1];});
      var labels = entries.map(function(e){return e[0];});
      var values = entries.map(function(e){return e[1];});
      if (geoChart) geoChart.destroy();
      geoChart = new Chart(geoCtx, {
        type: 'bar',
        data: { labels: labels, datasets: [{ data: values, backgroundColor:'#2a9d8f' }] },
        options: { indexAxis:'y', responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          layout:{ padding:{ top:10, bottom:6, right:8, left:8 } },
          scales:{ x:{ display:false, beginAtZero:true }, y:{ ticks:{ font:{ size:10 }, autoSkip:false, maxTicksLimit:20 } } },
          datasets:{ bar:{ categoryPercentage:0.7, barPercentage:0.8, maxBarThickness:18 } }
        }
      });
    }
    buildCatBar('cat_gene');
    // Scope les clicks aux boutons de la section Répartition (évite de capter les boutons ESG)
    var dimContainer = document.querySelector('#clientCatChart') ? document.getElementById('clientCatChart').closest('.pie-card') : null;
    if (dimContainer){
      dimContainer.querySelectorAll('.dim-buttons .dim-btn').forEach(function(btn){
        btn.addEventListener('click', function(ev){
          // Ne pas impacter d'autres groupes de boutons
          dimContainer.querySelectorAll('.dim-buttons .dim-btn').forEach(function(b){ b.classList.remove('active'); });
          this.classList.add('active');
          buildCatBar(this.dataset.field);
          ev.stopPropagation();
        });
      });
    }
  })();

  const labels = [{% for d in labels %}'{{ d }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  const data = [{% for v in serie_valo %}{{ v|default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}];
  const movs = [{% for v in serie_mov_cum %}{{ v|default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}];
  const movsRaw = [{% for v in serie_mov_raw %}{{ v|default(0) }}{% if not loop.last %}, {% endif %}{% endfor %}];
  const ctx = document.getElementById('valoChart').getContext('2d');
  const normLabels = labels.map(d => (d||'').toString().slice(0,10));
  function euro(v){ try{ return (Number(v)||0).toLocaleString('fr-FR')+' \u20AC'; }catch(e){ return v; } }
  // Echelle unique simple comme version d'origine
  new Chart(ctx, {
    type: 'line',
    data: { labels: normLabels, datasets: [
      { label: 'Valorisation', data, borderColor: 'var(--primary)', fill: false, pointRadius: 0, pointHoverRadius: 0 },
      { label: 'Cumul mouvements', data: movs, borderColor: '#ff6b6b', fill: false, pointRadius: 0, pointHoverRadius: 0 },
    ] },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: { y: { beginAtZero: false, ticks: { callback: (v)=> euro(v) } } },
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: function(ctx){
              const y = ctx.parsed.y;
              if (ctx.dataset.label === 'Cumul mouvements'){
                const idx = ctx.dataIndex;
                const delta = movsRaw[idx] || 0;
                return ctx.dataset.label+': '+euro(y)+' (\u0394 '+euro(delta)+')';
              }
              return ctx.dataset.label+': '+euro(y);
            }
          }
        }
      }
    }
  });

  // Graphique annuel: performances et volatilité (barres)
  (function(){
    const yearsClient = {{ years_client | tojson }};
    const annPerfClient = {{ ann_perf_client | tojson }};
    const annVolClient = {{ ann_vol_client | tojson }};
    const el = document.getElementById('clientAnnuelChart');
    if (!el) return;
    const ctxA = el.getContext('2d');
    const perfPct = (annPerfClient||[]).map(v=>{ let n=parseFloat(v); if (!isFinite(n)) n=0; if (Math.abs(n)<=1) n*=100; return +n.toFixed(2); });
    const volPct = (annVolClient||[]).map(v=>{ let n=parseFloat(v); if (!isFinite(n)) n=0; if (Math.abs(n)<=1) n*=100; return +n.toFixed(2); });
    new Chart(ctxA, {
      type: 'bar',
      data: { labels: (yearsClient||[]).map(String), datasets: [
        { label: 'Perf 52s (%)', data: perfPct, backgroundColor: 'var(--primary)' },
        { label: 'Volatilité (%)', data: volPct, backgroundColor: '#ff6b6b' },
      ]},
      options: { responsive:true, scales:{ y:{ ticks:{ callback:v=> v+' %' } } }, plugins:{ legend:{ display:true } } }
    });
  })();

  // Graphique allocations (lignes) avec sélection et échelle ajustée
  (function(){
    // Couleur par défaut pour Chart.js (axes/labels) = bleu CSS
    try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
    const allocSeries = {{ alloc_series | tojson }};
    const clientSicav = {{ client_sicav | tojson }};
    const sel = document.getElementById('allocSelectClient');
    if (!sel) return;
    // Remplir le sélecteur
    Object.keys(allocSeries||{}).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });
    function toMap(arr){ const m = new Map(); (arr||[]).forEach(p=>{ if(p&&p.date!=null){ m.set(String(p.date).slice(0,10), parseFloat(p.sicav)); } }); return m; }
    const clientMap = toMap(clientSicav);
    // Intersect dates across selected allocations and client
    function buildLabels(selected){
      function toSetDates(name){ const s=new Set(); (allocSeries[name]||[]).forEach(p=>{ if(p&&p.date) s.add(String(p.date).slice(0,10)); }); return s; }
      // start with client dates
      let allowed = new Set(Array.from(clientMap.keys()));
      (selected||[]).forEach(name=>{
        const s = toSetDates(name);
        const inter = new Set();
        allowed.forEach(d=>{ if (s.has(d)) inter.add(d); });
        allowed = inter;
      });
      return Array.from(allowed).sort();
    }
    // Filtre de période basé sur la dernière date disponible (fin de série), pas sur aujourd'hui
    function filterRangeByEnd(labels, range){
      if (range==='all') return labels;
      const n = parseInt(range, 10);
      if (!isFinite(n) || !labels.length) return labels;
      // Prendre la dernière date visible comme date de fin
      const end = new Date(labels[labels.length - 1]);
      const start = new Date(end);
      start.setDate(start.getDate() - n);
      return labels.filter(d => new Date(d) >= start && new Date(d) <= end);
    }
    function normalize(map, labels){
      if (!labels.length) return [];
      // base = première valeur non nulle/non NaN de la période
      let base = null;
      for (let i=0;i<labels.length;i++){ const v = map.get(labels[i]); if (isFinite(v) && v!==0){ base = v; break; } }
      if (base === null) base = 1; // fallback
      return labels.map(d => { const v = map.get(d); return isFinite(v) ? +(v/base*100).toFixed(2) : null; });
    }
    const colors = ['#1d4ed8','#e76f51','#2a9d8f','#f4a261','#264653','#43aa8b','#e9c46a','#577590','#f94144','#277da1'];
    let chartAlloc;
    let currentRange = 'all';
    function drawAlloc(selected){
      if (chartAlloc) { chartAlloc.destroy(); chartAlloc = null; }
      if (!selected || !selected.length) return;
      let labels = buildLabels(selected);
      labels = filterRangeByEnd(labels, currentRange);
      if (!labels.length) return;
      const datasets = [];
      let allVals = [];
      // Client series first, normalized to base 100
      const clientData = normalize(clientMap, labels);
      datasets.push({ label: 'Client (base 100)', data: clientData, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6', fill:false, pointRadius:0, pointHoverRadius:0 });
      allVals = allVals.concat(clientData.filter(v=> v!=null && isFinite(v)));
      selected.forEach((name, idx)=>{
        const map = toMap(allocSeries[name]);
        const data = normalize(map, labels);
        datasets.push({ label: name+' (base 100)', data, borderColor: colors[idx%colors.length], fill:false, pointRadius:0, pointHoverRadius:0 });
        allVals = allVals.concat(data.filter(v=> v!=null && isFinite(v)));
      });
      if (!allVals.length) return;
      const min = Math.min.apply(null, allVals);
      const max = Math.max.apply(null, allVals);
      const pad = ((max - min) || 1) * 0.1;
      const ctxA = document.getElementById('clientAllocChart').getContext('2d');
      chartAlloc = new Chart(ctxA, {
        type: 'line',
        data: { labels, datasets },
        options: { responsive:true, interaction:{ mode:'index', intersect:false }, scales:{ y:{ suggestedMin: min - pad, suggestedMax: max + pad } }, plugins:{ legend:{ display:true } } }
      });
    }
    sel.addEventListener('change', function(){
      const selected = this.value ? [this.value] : [];
      drawAlloc(selected);
    });
    document.querySelectorAll('.rangeBtn').forEach(btn => btn.addEventListener('click', function(){ currentRange = this.dataset.range || 'all'; const selected = sel.value ? [sel.value] : []; drawAlloc(selected); }));
  })();

  // --- ESG (client consolidé) Plotly horizontal bar: indice=100 vs client ---
  (function(){
    var allocSel = document.getElementById('esgAllocSelectClient');
    var allocDateSel = document.getElementById('esgAllocDateClient');
    var fieldsWrap = document.getElementById('esgFieldsClient');
    var refreshBtn = document.getElementById('esgRefreshBtnClient');
    var asOfSel = document.getElementById('asOfSelect');
    if (!allocSel || !fieldsWrap) return;

    // Persist keys per client
    var keyAlloc = 'client_esg_alloc_{{ client.id }}';
    var keyFields = 'client_esg_fields_{{ client.id }}';
    var keyAllocDate = 'client_esg_alloc_date_{{ client.id }}';

    function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field-client.active')).map(b=> b.getAttribute('data-field')); }
    function updateSelection(btn){
      var sel = selectedFields();
      if (btn){
        if (btn.classList.contains('active')){ btn.classList.remove('active'); }
        else {
          if (sel.length >= 4) return; // max 4
          btn.classList.add('active');
        }
      }
    }
    fieldsWrap.addEventListener('click', function(e){
      var b=e.target.closest('.esg-field-client'); if(!b) return;
      updateSelection(b);
      try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
      drawESG();
    });

    function ensurePlotly(cb){ if (window.Plotly) { cb(); return; } var s=document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ cb(); }; document.head.appendChild(s); }
    function drawESG(){
      var fields = selectedFields();
      var alloc = allocSel.value || '';
      var allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
      var asOf = asOfSel && asOfSel.value ? asOfSel.value : '';
      if (!fields.length || !alloc){ return; }
      ensurePlotly(function(){
        var url = `/dashboard/clients/{{ client.id }}/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}` + (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'') + (asOf?`&as_of=${encodeURIComponent(asOf)}`:'');
        fetch(url).then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          var rows = (data && data.results) || [];
          var cats = rows.map(r=> r.field);
          var idx = rows.map(r=> (r.index==null? null : Number(r.index)));
          var cli = rows.map(r=> (r.client==null? null : Number(r.client)));
          var traces = [
            { x: idx, y: cats, type:'bar', orientation:'h', name:'Indice', marker:{ color:'#9ca3af' } },
            { x: cli, y: cats, type:'bar', orientation:'h', name:'Client', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
          ];
          var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
          var cfg = { displayModeBar: false, responsive: true };
          Plotly.react('esgChartClient', traces, layout, cfg);
        }).catch(function(err){ try{ console.error('Client ESG fetch error', err); }catch(_){} });
      });
    }

    function loadAllocDates(preferred){
      if (!allocSel || !allocSel.value) { if (allocDateSel) allocDateSel.innerHTML=''; return; }
      fetch(`/dashboard/allocations/dates?name=${encodeURIComponent(allocSel.value)}`)
        .then(r=>r.json()).then(function(data){
          if (!allocDateSel) return;
          allocDateSel.innerHTML = '';
          var ds = (data && data.dates) || [];
          ds.forEach(function(d){ var o=document.createElement('option'); o.value=d; o.textContent=d; allocDateSel.appendChild(o); });
          var selected = false;
          if (preferred){
            for (var i=0;i<allocDateSel.options.length;i++){
              if (allocDateSel.options[i].value === preferred){ allocDateSel.selectedIndex = i; selected = true; break; }
            }
          }
          if (!selected && allocDateSel.options.length>0) allocDateSel.selectedIndex = 0;
          drawESG();
        }).catch(function(e){ try{ console.warn('alloc dates (client)', e);}catch(_){} });
    }

    // Persist selections
    allocSel.addEventListener('change', function(){
      try{ localStorage.setItem(keyAlloc, allocSel.value||''); }catch(_e){}
      try{ localStorage.removeItem(keyAllocDate); }catch(_e){}
      loadAllocDates();
    });
    if (allocDateSel) allocDateSel.addEventListener('change', function(){ try{ localStorage.setItem(keyAllocDate, allocDateSel.value||''); }catch(_e){}; drawESG(); });
    if (asOfSel) asOfSel.addEventListener('change', drawESG);
    if (refreshBtn) refreshBtn.addEventListener('click', drawESG);

    // Init defaults
    (function init(){
      // Allocation
      try{
        var savedAlloc = localStorage.getItem(keyAlloc) || '';
        if (savedAlloc){
          var found = false; for (var i=0;i<allocSel.options.length;i++){ if (allocSel.options[i].value===savedAlloc){ allocSel.selectedIndex=i; found=true; break; } }
          if (!found) savedAlloc = '';
        }
        if (!savedAlloc){ for (var j=0;j<allocSel.options.length;j++){ if (allocSel.options[j].value){ allocSel.selectedIndex=j; savedAlloc=allocSel.options[j].value; break; } } if(savedAlloc){ try{ localStorage.setItem(keyAlloc, savedAlloc); }catch(_e){} }
        }
      }catch(_e){}
      // Fields
      try{
        var raw = localStorage.getItem(keyFields); var saved = []; if (raw){ try{ saved=JSON.parse(raw)||[]; }catch(_ee){ saved=[]; } }
        var buttons = Array.from(fieldsWrap.querySelectorAll('.esg-field-client'));
        buttons.forEach(b=> b.classList.remove('active'));
        if (saved && saved.length){ buttons.forEach(b=> { var v=b.getAttribute('data-field'); if (saved.indexOf(v)>=0) b.classList.add('active'); }); }
        else { buttons.slice(0,3).forEach(b=> b.classList.add('active')); try{ localStorage.setItem(keyFields, JSON.stringify(buttons.slice(0,3).map(b=> b.getAttribute('data-field')))); }catch(_e){} }
      }catch(_e){}
      // Dates alloc: try restore
      var preferDate = ''; try{ preferDate = localStorage.getItem(keyAllocDate) || ''; }catch(_e){}
      if (allocSel && allocSel.value){ loadAllocDates(preferDate); } else { drawESG(); }
    })();
  })();
</script>

<!-- Modales Conformité (détail) -->
  <div class="modal-overlay" id="confConnaissanceDetailModal" onclick="if(event.target===this) closeConfConnaissanceDetail()">
    <div class="modal-card" style="width:960px; max-width:98vw; height:92vh; display:flex; flex-direction:column;">
      <div class="modal-header"><h3><i class="fa-solid fa-user-check" style="margin-right:8px;"></i>Connaissance client</h3><button class="modal-close" onclick="closeConfConnaissanceDetail()">✕</button></div>
      <div class="modal-body" style="padding:0; flex:1 1 auto;">
        <iframe src="/dashboard/clients/kyc/{{ client.id }}?open=knowledge&embed=1" style="width:100%; height:100%; border:0;"></iframe>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confTacfinDetailModal" onclick="if(event.target===this) closeConfTacfinDetail()">
    <div class="modal-card" style="width:980px; max-width:98vw; height:92vh; display:flex; flex-direction:column;">
      <div class="modal-header"><h3><i class="fa-solid fa-shield-halved" style="margin-right:8px;"></i>TRACFIN / FATCA</h3><button class="modal-close" onclick="closeConfTacfinDetail()">✕</button></div>
      <div class="modal-body" style="flex:1 1 auto; overflow:auto;">
        <div id="lcbftDetailToast" class="badge success" style="display:none; margin-bottom:8px;">Questionnaire LCB-FT enregistré.</div>
        <style>
          .risk-grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
          .risk-block { border:1px solid var(--border); border-radius:8px; padding:10px; }
          .btn-group .btn-choice { margin-right:6px; }
          .btn-choice-active { background: var(--primary); color:#fff; }
          .step-hidden { display:none; }
        </style>
        <form method="post" action="/dashboard/clients/kyc/{{ client.id }}" id="lcbftFormDetail" style="display:flex; flex-direction:column; gap:12px;">
          <input type="hidden" name="form_action" value="lcbft_save" />
          <div class="risk-grid">
            <div class="risk-block">
              <h5>FATCA</h5>
              <div class="row two-cols" style="display:grid; grid-template-columns: 2fr 1fr; gap:12px;">
                <div class="field" style="min-width:0;">
                  <label>Nom du produit</label>
                  <select name="fatca_contrat_id" id="fatcaContractSelectDetail" style="width:100%; height:36px; min-height:36px;">
                    <option value="">Sélectionner…</option>
                    {% for c in fatca_contracts %}
                      <option value="{{ c.id }}" data-societe="{{ c.societe_nom }}" {% if fatca_saved and fatca_saved.contrat_id and c.id == fatca_saved.contrat_id %}selected{% endif %}>{{ c.nom_contrat }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="field" style="min-width:0;">
                  <label>Compagnie d’assurance</label>
                  <input type="text" id="fatcaSocieteDetail" name="fatca_societe" value="{{ fatca_saved.societe_nom if fatca_saved else '' }}" />
                </div>
              </div>
              <div class="row two-cols" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
                <div class="field" style="min-width:0;">
                  <label>Date de l’opération</label>
                  <input type="date" name="fatca_date_operation" value="{{ (fatca_saved.date_operation if fatca_saved and fatca_saved.date_operation else fatca_today) }}" readonly />
                </div>
                <div class="field" style="min-width:0;">
                  <label>Pays de résidence fiscale</label>
                  <input type="text" name="fatca_pays_residence" value="{{ (fatca_saved.pays_residence if fatca_saved and fatca_saved.pays_residence else fatca_client_country) }}" />
                </div>
                <div class="field" style="min-width:0;">
                  <label>NIF</label>
                  <input type="text" name="fatca_nif" value="{{ (fatca_saved.nif if fatca_saved and fatca_saved.nif else fatca_client_nif) }}" />
                </div>
              </div>
            </div>
            <div class="risk-block">
              <h5>Cartographie client</h5>
              <div class="row two-cols" style="display:grid; grid-template-columns: 1fr 2fr; gap:12px;">
                <div class="field" style="min-width:0;">
                  <label>Depuis quand connaissez-vous le client</label>
                  <input type="date" name="relation_since" value="{{ lcbft_current.relation_since if lcbft_current and lcbft_current.relation_since else '' }}"/>
                </div>
                <div class="field" style="min-width:0;">
                  <label>Entrée en relation</label>
                  <textarea name="relation_mode" rows="2" placeholder="Comment êtes-vous rentré en relation ?" style="width:100%;">{{ lcbft_current.relation_mode if lcbft_current else '' }}</textarea>
                </div>
              </div>
              <div class="field"><label>Contrats similaires déjà souscrits ?</label>
                <div class="btn-group" data-name="has_existing_contracts">
                  <button type="button" class="btn btn-choice" data-value="1">Oui</button>
                  <button type="button" class="btn btn-choice" data-value="0">Non</button>
                </div>
                <input type="hidden" name="has_existing_contracts" value="{{ lcbft_current.has_existing_contracts if lcbft_current and lcbft_current.has_existing_contracts is not none else '0' }}" />
              </div>
              <div id="lcbftExistingBlockDetail" class="step-hidden">
                <div class="field"><label>Auprès de notre société d'assurance ?</label>
                  <div class="btn-group" data-name="existing_with_our_insurer">
                    <button type="button" class="btn btn-choice" data-value="1">Oui</button>
                    <button type="button" class="btn btn-choice" data-value="0">Non</button>
                  </div>
                  <input type="hidden" name="existing_with_our_insurer" value="{{ lcbft_current.existing_with_our_insurer if lcbft_current and lcbft_current.existing_with_our_insurer is not none else '0' }}" />
                </div>
                <div class="field"><label>Référence du contrat</label><input type="text" name="existing_contract_ref" placeholder="REF-..." value="{{ lcbft_current.existing_contract_ref if lcbft_current else '' }}"/></div>
                <div class="field"><label>Raison de l’ouverture d’un nouveau contrat</label><textarea name="reason_new_contract" rows="3">{{ lcbft_current.reason_new_contract if lcbft_current else '' }}</textarea></div>
              </div>
            </div>
            {# Bloc Synthèse financière retiré (revenu/charges/patrimoine/montant) — rebasculé à l'état antérieur #}
            <div class="risk-block">
              <h5>PPE</h5>
              <div class="muted-small" style="margin-bottom:6px;">Reportez-vous aux fonctions PPE (chef d’État, parlement, haute juridiction, ambassadeur, etc.).</div>
              <div class="field"><label>Client PPE ?</label>
                <div class="btn-group" data-name="ppe_self">
                  <button type="button" class="btn btn-choice" data-value="1">Oui</button>
                  <button type="button" class="btn btn-choice" data-value="0">Non</button>
                </div>
                <input type="hidden" name="ppe_self" value="{{ lcbft_current.ppe_self if lcbft_current and lcbft_current.ppe_self is not none else '0' }}" />
              </div>
              <div id="ppeSelfBlockDetail" class="step-hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <div class="field"><label>Fonction exercée</label>
                  {% set _cur_self_fn_raw = (lcbft_current.ppe_self_fonction if lcbft_current else none) %}
                  {% set _cur_self_fn_l = (_cur_self_fn_raw if _cur_self_fn_raw is not none else '') | string | trim %}
                  {% set _libs = lcbft_ppe_options | map(attribute='lib') | list %}
                  {% set _illegal = ['non','oui','0','1','false','true','—','-','none'] %}
                  <select name="ppe_self_fonction">
                    <option value="">—</option>
                    {% if (_cur_self_fn_raw is not none) and _cur_self_fn_l and (_cur_self_fn_l|lower not in _illegal) and (_cur_self_fn_l not in _libs) %}
                      <option value="{{ _cur_self_fn_l }}" selected>{{ _cur_self_fn_l }}</option>
                    {% endif %}
                    {% for opt in lcbft_ppe_options %}
                      <option value="{{ opt.lib }}" {% if _cur_self_fn_l and (_cur_self_fn_l == opt.lib) %}selected{% endif %}>{{ opt.lib }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="field"><label>Pays d’exercice</label><input type="text" name="ppe_self_pays" value="{{ lcbft_current.ppe_self_pays if lcbft_current else '' }}"/></div>
              </div>
              <div class="field"><label>Membre de la famille PPE ?</label>
                <div class="btn-group" data-name="ppe_family">
                  <button type="button" class="btn btn-choice" data-value="1">Oui</button>
                  <button type="button" class="btn btn-choice" data-value="0">Non</button>
                </div>
                <input type="hidden" name="ppe_family" value="{{ lcbft_current.ppe_family if lcbft_current and lcbft_current.ppe_family is not none else '0' }}" />
              </div>
              <div id="ppeFamilyBlockDetail" class="step-hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <div class="field"><label>Fonction du membre</label>
                  {% set _cur_fam_fn_raw = (lcbft_current.ppe_family_fonction if lcbft_current else none) %}
                  {% set _cur_fam_fn_l = (_cur_fam_fn_raw if _cur_fam_fn_raw is not none else '') | string | trim %}
                  {% set _libs2 = lcbft_ppe_options | map(attribute='lib') | list %}
                  {% set _illegal2 = ['non','oui','0','1','false','true','—','-','none'] %}
                  <select name="ppe_family_fonction">
                    <option value="">—</option>
                    {% if (_cur_fam_fn_raw is not none) and _cur_fam_fn_l and (_cur_fam_fn_l|lower not in _illegal2) and (_cur_fam_fn_l not in _libs2) %}
                      <option value="{{ _cur_fam_fn_l }}" selected>{{ _cur_fam_fn_l }}</option>
                    {% endif %}
                    {% for opt in lcbft_ppe_options %}
                      <option value="{{ opt.lib }}" {% if _cur_fam_fn_l and (_cur_fam_fn_l == opt.lib) %}selected{% endif %}>{{ opt.lib }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="field"><label>Pays d’exercice</label><input type="text" name="ppe_family_pays" value="{{ lcbft_current.ppe_family_pays if lcbft_current else '' }}"/></div>
              </div>
            </div>
            <div class="risk-block">
              <h5>US Person</h5>
              <div class="field"><label>US Person ?</label>
                <div class="btn-group" data-name="us_person">
                  <button type="button" class="btn btn-choice" data-value="1">Oui</button>
                  <button type="button" class="btn btn-choice" data-value="0">Non</button>
                </div>
                <input type="hidden" name="us_person" value="{{ lcbft_current.us_person if lcbft_current and lcbft_current.us_person is not none else '0' }}" />
              </div>
            </div>
            <div class="risk-block">
              <h5>Vigilance</h5>
              <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-bottom:8px;">
                <div class="field">
                  <label>Montant total à investir</label>
                  <div class="value-display">{% set _inv = lcbft_invest_total if lcbft_invest_total is not none else 0 %}{{ '{:,.0f}'.format(_inv|float).replace(',', ' ') }} €</div>
                </div>
                <div class="field">
                  <label>Patrimoine net</label>
                  <div class="value-display">{% if lcbft_patrimoine_net is not none %}{{ '{:,.0f}'.format(lcbft_patrimoine_net|float).replace(',', ' ') }} €{% else %}—{% endif %}</div>
                </div>
                <div class="field">
                  <label>Part du patrimoine à investir</label>
                  <div class="value-display">{% if lcbft_part_pct is not none %}{{ '%.2f'|format(lcbft_part_pct|float) }} %{% else %}—{% endif %}</div>
                </div>
              </div>
              <div class="btn-multi-group" data-name="vigilance_ids">
                {% for v in lcbft_vigilance_options %}
                  <button type="button" class="btn btn-choice" data-id="{{ v.id }}" {% if lcbft_vigilance_ids and v.id in lcbft_vigilance_ids %}data-active="1"{% endif %}>{{ v.label }}</button>
                {% endfor %}
              </div>
              <div class="multi-hidden" data-name="vigilance_ids"></div>
            </div>
            <div class="risk-block">
              <h5>Justificatifs</h5>
              <div class="field"><label>Origine des fonds / Opération</label><textarea name="just_fonds" rows="3">{{ lcbft_current.just_fonds if lcbft_current else '' }}</textarea></div>
              <div class="field"><label>Destination des fonds</label><textarea name="just_destination" rows="2">{{ lcbft_current.just_destination if lcbft_current else '' }}</textarea></div>
              <div class="field"><label>Finalité</label><textarea name="just_finalite" rows="2">{{ lcbft_current.just_finalite if lcbft_current else '' }}</textarea></div>
              <div class="field"><label>Justificatifs produits</label><textarea name="just_produits" rows="2">{{ lcbft_current.just_produits if lcbft_current else '' }}</textarea></div>
            </div>
          </div>
          <div class="card" style="display:flex; justify-content:flex-end; border:none;">
            <button type="submit" class="btn-primary">Enregistrer</button>
          </div>
        </form>
        <script>
          (function(){
            const sel = document.getElementById('fatcaContractSelectDetail');
            const soc = document.getElementById('fatcaSocieteDetail');
            if (sel && soc){
              function updateSoc(){ const opt = sel.options[sel.selectedIndex]; soc.value = opt ? (opt.getAttribute('data-societe') || '') : ''; }
              sel.addEventListener('change', updateSoc); updateSoc();
            }
            const form = document.getElementById('lcbftFormDetail');
            if (!form) return;
            function updatePPERequired(){
              try {
                const selfVal = String((form.querySelector('input[name="ppe_self"]').value||'')).trim();
                const famVal = String((form.querySelector('input[name="ppe_family"]').value||'')).trim();
                const selfSel = form.querySelector('select[name="ppe_self_fonction"]');
                const famSel = form.querySelector('select[name="ppe_family_fonction"]');
                if (selfSel) selfSel.required = (selfVal === '1');
                if (famSel) famSel.required = (famVal === '1');
              } catch(e) {}
            }
            function initSingle(group){
              const name = group.getAttribute('data-name'); const input = form.querySelector('input[name="'+name+'"]'); const current = input? String(input.value||'') : '';
              group.querySelectorAll('button[data-value]').forEach(function(btn){ const v=String(btn.getAttribute('data-value')||''); if(current===v&&v!==''){ btn.classList.add('btn-choice-active'); }
                btn.addEventListener('click', function(ev){ ev.preventDefault(); ev.stopPropagation(); if(input){ input.value=v; } group.querySelectorAll('button[data-value]').forEach(b=>b.classList.remove('btn-choice-active')); btn.classList.add('btn-choice-active');
                  if (name==='has_existing_contracts'){ const blk=document.getElementById('lcbftExistingBlockDetail'); if(blk){ blk.classList.toggle('step-hidden', v!=='1'); } }
                  if (name==='ppe_self'){ const blk=document.getElementById('ppeSelfBlockDetail'); if(blk){ blk.classList.toggle('step-hidden', v!=='1'); } }
                  if (name==='ppe_family'){ const blk=document.getElementById('ppeFamilyBlockDetail'); if(blk){ blk.classList.toggle('step-hidden', v!=='1'); } }
                  updatePPERequired();
                });
              });
            }
            function ensureHiddenContainer(name){ let c=form.querySelector('.multi-hidden[data-name="'+name+'"]'); if(!c){ c=document.createElement('div'); c.className='multi-hidden'; c.setAttribute('data-name', name); form.appendChild(c);} return c; }
            function initMulti(group){ const name=group.getAttribute('data-name'); const container=ensureHiddenContainer(name); const selected=new Set(); group.querySelectorAll('button.btn-choice[data-id]').forEach(function(btn){ const id=btn.getAttribute('data-id'); if(btn.getAttribute('data-active')==='1'){ btn.classList.add('btn-choice-active'); selected.add(id);} btn.addEventListener('click', function(ev){ ev.preventDefault(); ev.stopPropagation(); if(btn.classList.contains('btn-choice-active')){ btn.classList.remove('btn-choice-active'); selected.delete(id);} else { btn.classList.add('btn-choice-active'); selected.add(id);} container.innerHTML=''; Array.from(selected).forEach(function(val){ const i=document.createElement('input'); i.type='hidden'; i.name=name; i.value=val; container.appendChild(i); }); }); }); }
            Array.from(form.querySelectorAll('.btn-group')).forEach(function(g){ if(g.querySelector('[data-value]')) initSingle(g); });
            Array.from(form.querySelectorAll('.btn-multi-group')).forEach(function(g){ initMulti(g); });
            // initial visibility
            (function(){
              function val(n){ const i=form.querySelector('[name="'+n+'"]'); return i? i.value:''; }
              document.getElementById('lcbftExistingBlockDetail')?.classList.toggle('step-hidden', val('has_existing_contracts')!=='1');
              document.getElementById('ppeSelfBlockDetail')?.classList.toggle('step-hidden', val('ppe_self')!=='1');
              document.getElementById('ppeFamilyBlockDetail')?.classList.toggle('step-hidden', val('ppe_family')!=='1');
              updatePPERequired();
            })();
            // Simple client-side validation: if PPE=Oui, fonction must be selected
            form.addEventListener('submit', function(e){
              try {
                const selfVal = String((form.querySelector('input[name="ppe_self"]').value||'')).trim();
                const famVal = String((form.querySelector('input[name="ppe_family"]').value||'')).trim();
                if (selfVal === '1'){
                  const selfSel = form.querySelector('select[name="ppe_self_fonction"]');
                  if (selfSel && !selfSel.value){ e.preventDefault(); alert('Veuillez sélectionner la fonction PPE exercée par le client.'); selfSel.focus(); return false; }
                }
                if (famVal === '1'){
                  const famSel = form.querySelector('select[name="ppe_family_fonction"]');
                  if (famSel && !famSel.value){ e.preventDefault(); alert('Veuillez sélectionner la fonction PPE exercée par le membre de la famille.'); famSel.focus(); return false; }
                }
              } catch(err) {}
            });
          })();
        </script>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="confEerDetailModal" onclick="if(event.target===this) this.style.display='none'">
  <div class="modal-card" style="width:760px; max-width:96vw;">
    <div class="modal-header"><h3><i class="fa-solid fa-file-signature" style="margin-right:8px;"></i>Entrée en relation</h3><button class="modal-close" onclick="document.getElementById('confEerDetailModal').style.display='none'">✕</button></div>
    <div class="modal-body">
      <style>
        .der-section { margin-bottom: 14px; }
        .der-section h4 { margin: 0 0 6px; font-size: 1rem; }
        .der-list { margin: 0; padding-left: 18px; }
        .der-table { width: 100%; border-collapse: collapse; }
        .der-table th, .der-table td { border: 1px solid var(--border); padding: 6px 8px; font-size: .92rem; }
        .der-table th { background: var(--primary); color:#fff; text-align: left; }
        .muted-note { color: var(--muted); font-size: .9rem; }
      </style>
      <!-- DER (Document d’Entrée en Relation) panel -->
      <div id="eerDocPanelDetail">
        <div class="der-section">
          <h3 style="margin:0 0 8px;">DOCUMENT D’ENTRÉE EN RELATION (DER)</h3>
          <div class="muted-note">Conformément aux articles L.520-1 et suivants du Code des assurances et L.541-8-1 du Code monétaire et financier</div>
        </div>

        <div class="der-section">
          <h4>1. Identification du courtier</h4>
          {% set _cid = (DER_sql_params_activite[':cid'] if (DER_sql_params_activite is defined and DER_sql_params_activite and (':cid' in DER_sql_params_activite)) else (DER_courtier.id if DER_courtier else None)) %}
          <ul class="der-list">
            <li><strong>Dénomination sociale :</strong> {{ DER_courtier.nom_cabinet if DER_courtier else '' }}</li>
            <li><strong>Responsable :</strong> {{ DER_courtier.nom_responsable if DER_courtier else '' }}</li>
            <li><strong>Statut social :</strong> {{ DER_statut_social.lib if DER_statut_social else '' }}</li>
            <li><strong>Capital social :</strong> {% if DER_courtier and DER_courtier.capital_social is not none %}{{ '{:,.0f}'.format((DER_courtier.capital_social)|float).replace(',', ' ') }} €{% endif %}</li>
            <li><strong>SIREN :</strong> {{ DER_courtier.siren if DER_courtier else '' }}</li>
            <li><strong>RCS :</strong> {{ DER_courtier.rcs if DER_courtier else '' }}</li>
            <li><strong>Numéro ORIAS :</strong> {{ DER_courtier.numero_orias if DER_courtier else '' }}</li>
            <li><strong>Adresse :</strong> {{ DER_courtier.adresse_rue if DER_courtier else '' }}, {{ DER_courtier.adresse_cp if DER_courtier else '' }} {{ DER_courtier.adresse_ville if DER_courtier else '' }}</li>
            <li><strong>Courriel :</strong> {{ DER_courtier.courriel if DER_courtier else '' }}</li>
            <li><strong>Association professionnelle :</strong> {{ DER_courtier.association_prof if DER_courtier else '' }}{% if DER_courtier and DER_courtier.num_adh_assoc %} (adhérent n° {{ DER_courtier.num_adh_assoc }}){% endif %}</li>
            <li><strong>Catégorie de courtage :</strong> {{ DER_courtier.categorie_courtage if DER_courtier else '' }}</li>
          </ul>
        </div>

        <div class="der-section">
          <h4>2. Activités et domaines d’exercice</h4>
          {% if DER_activites and (DER_activites|length > 0) %}
            <table class="der-table">
              <thead>
                <tr>
                  <th>Domaine</th>
                  <th>Activité</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody>
                {% for a in DER_activites %}
                <tr>
                  <td>{{ a.domaine or '' }}</td>
                  <td>{{ a.libelle or '' }}</td>
                  <td>{{ 'Exercée' if (a.statut or '')|lower == 'exercee' else 'Non exercée' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="muted-note">Aucune activité renseignée.</p>
          {% endif %}
        </div>

        <div class="der-section">
          <h4>3. Autorités de tutelle</h4>
          <ul class="der-list">
            <li><strong>AMF (Autorité des Marchés Financiers)</strong><br/>17, place de la Bourse – 75082 Paris Cedex 02</li>
            <li><strong>ACPR (Autorité de Contrôle Prudentiel et de Résolution)</strong><br/>61, rue Taitbout – 75436 Paris Cedex 09</li>
          </ul>
          <p class="muted-note">Ces autorités veillent au respect des obligations professionnelles du courtier.</p>
        </div>

        <div class="der-section">
          <h4>4. Nature et étendue du service</h4>
          <p>{{ DER_courtier.nom_cabinet if DER_courtier else '' }} agit en qualité de <strong>courtier indépendant</strong>.<br/>
          Son rôle est d’analyser <strong>vos besoins, vos objectifs et votre profil de risque</strong> afin de recommander les solutions adaptées.</p>
          <p>Le cabinet ne perçoit ni ne conserve de fonds destinés aux assureurs ou aux clients.</p>
        </div>

        <div class="der-section">
          <h4>5. Rémunération et frais</h4>
          <p>Le cabinet est rémunéré sous forme :</p>
          <ul class="der-list">
            <li>de <strong>commissions</strong> versées par les compagnies partenaires ;</li>
            <li>et/ou de <strong>frais</strong> ou <strong>honoraires</strong> prévus dans la lettre de mission.</li>
          </ul>
        </div>

        <div class="der-section">
          <h4>6. Garanties professionnelles</h4>
          <p>Le cabinet justifie d’une <strong>assurance responsabilité civile professionnelle</strong> et d’une <strong>garantie financière</strong>, conformément à la réglementation.</p>
          <table class="der-table">
            <thead>
              <tr>
                <th>Type de garantie</th>
              <th style="text-align:center;">IAS</th>
              <th style="text-align:center;">IOBSP</th>
              </tr>
            </thead>
            <tbody>
              {% for g in (DER_courtier_garanties_normes or []) %}
              <tr>
                <td>{{ g.type_garantie }}</td>
                <td class="center">{% if g.IAS is not none %}{{ '{:,.0f}'.format((g.IAS)|float).replace(',', ' ') }} €{% endif %}</td>
                <td class="center">{% if g.IOBSP is not none %}{{ '{:,.0f}'.format((g.IOBSP)|float).replace(',', ' ') }} €{% endif %}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="der-section">
          <h4>7. Données personnelles</h4>
          <div>
            <p><strong>A. Responsable du traitement</strong></p>
            <p>
              Responsable : {{ DER_courtier.nom_cabinet }}<br/>
              Adresse : {{ DER_courtier.adresse_rue }}, {{ DER_courtier.adresse_cp }} {{ DER_courtier.adresse_ville }}<br/>
              Courriel : {{ DER_courtier.courriel }}<br/>
              Délégué à la protection des données (DPO) : {{ DER_courtier.responsable_dpo }}
            </p>

            <p><strong>B. Finalités du traitement</strong></p>
            <p>Les données personnelles collectées sont utilisées pour :</p>
            <ul class="der-list">
              <li>Évaluer votre situation patrimoniale, financière et personnelle ;</li>
              <li>Établir un conseil adapté à vos besoins, objectifs et profil de risque ;</li>
              <li>Préparer, souscrire et gérer vos contrats d’assurance ou de placement ;</li>
              <li>Respecter les obligations légales du courtier (lutte contre le blanchiment, devoir de conseil, contrôles réglementaires) ;</li>
              <li>Communiquer des informations utiles à la relation de suivi et de conseil.</li>
            </ul>

            <p><strong>C. Base légale du traitement</strong></p>
            <p>Les traitements reposent sur :</p>
            <ul class="der-list">
              <li>L’exécution d’un contrat ou de mesures précontractuelles ;</li>
              <li>Le respect d’obligations légales et réglementaires ;</li>
              <li>L’intérêt légitime du cabinet pour assurer la qualité et la continuité du service ;</li>
              <li>Et, le cas échéant, votre consentement explicite.</li>
            </ul>

            <p><strong>D. Nature des données traitées</strong></p>
            <p>Les catégories de données collectées incluent :</p>
            <ul class="der-list">
              <li>Données d’identification : nom, prénom, date et lieu de naissance, nationalité, NIF, pièce d’identité ;</li>
              <li>Coordonnées : adresse, téléphone, courriel ;</li>
              <li>Situation personnelle : état civil, profession, situation familiale et patrimoniale ;</li>
              <li>Données financières : revenus, charges, actifs, passifs ;</li>
              <li>Objectifs d’investissement : horizon, tolérance au risque, sensibilité ESG.</li>
            </ul>

            <p><strong>E. Destinataires des données</strong></p>
            <p>Les données sont destinées exclusivement à :</p>
            <ul class="der-list">
              <li>{{ DER_courtier.nom_cabinet }} et ses collaborateurs soumis à une obligation de confidentialité ;</li>
              <li>Les compagnies d’assurance, sociétés de gestion ou plateformes partenaires nécessaires à la mise en œuvre des contrats ;</li>
              <li>Les autorités de contrôle (ACPR, AMF, administration fiscale) lorsque la loi l’exige.</li>
            </ul>
            <p>Aucune donnée n’est cédée ni utilisée à des fins commerciales sans votre accord.</p>

            <p><strong>F. Durée de conservation</strong></p>
            <ul class="der-list">
              <li>Pendant la durée de la relation contractuelle ;</li>
              <li>Puis pendant les délais légaux de prescription applicables :</li>
            </ul>
            <ul class="der-list" style="margin-left:18px;">
              <li>10 ans pour les obligations relatives à la lutte contre le blanchiment et le financement du terrorisme ;</li>
              <li>5 ans pour le devoir de conseil et la traçabilité des recommandations.</li>
            </ul>
            <p>Les données sont ensuite archivées ou supprimées conformément à la réglementation.</p>

            <p><strong>G. Sécurité et confidentialité</strong></p>
            <p>{{ DER_courtier.nom_cabinet }} met en œuvre des mesures techniques et organisationnelles destinées à garantir la confidentialité, l’intégrité et la sécurité de vos données :</p>
            <ul class="der-list">
              <li>Systèmes informatiques protégés et sauvegardes régulières ;</li>
              <li>Accès restreint aux seules personnes habilitées ;</li>
              <li>Chiffrement des communications et suivi des accès.</li>
            </ul>

            <p><strong>H. Vos droits</strong></p>
            <p>Vous disposez à tout moment des droits suivants :</p>
            <ul class="der-list">
              <li>Accès, rectification, mise à jour de vos données ;</li>
              <li>Effacement ou limitation du traitement dans les conditions légales ;</li>
              <li>Opposition au traitement pour motifs légitimes ;</li>
              <li>Portabilité de vos données vers un autre prestataire ;</li>
              <li>Retrait de votre consentement, sans effet rétroactif.</li>
            </ul>
            <p>
              Pour exercer vos droits :<br/>
              {{ DER_courtier.responsable_dpo }} – {{ DER_courtier.courriel }}<br/>
              Vous pouvez également saisir la CNIL (www.cnil.fr) en cas de difficulté non résolue.
            </p>

            <p><strong>I. Transferts de données hors de l’Union européenne</strong></p>
            <p>Aucun transfert de données hors de l’Union européenne n’est effectué sans garanties adéquates de protection et de confidentialité conformes au RGPD.</p>

            <p><strong>J. Mise à jour de la notice</strong></p>
            <p>La présente politique est susceptible d’évoluer afin de refléter les changements législatifs ou techniques. La version la plus récente est disponible sur simple demande ou sur le site internet de {{ DER_courtier.nom_cabinet }}.</p>
          </div>
        </div>

        <div class="der-section">
          <h4>8. Médiation et réclamations</h4>
          <p>Toute réclamation peut être adressée à :<br/>
          <strong>Courtage du Centre – Service Réclamations</strong><br/>
          23 rue du quai, 56150 Chatillon sur Saône<br/>
          Email : jc@cc.fr</p>
          <p>En cas d’absence de solution amiable, le Client peut saisir :<br/>
          <strong>{{ centre_mediation_lib or DER_courtier.centre_mediation }}</strong><br/>
          Contact : banqueroute@acpr.fr</p>
        </div>

        <div class="der-section">
          <h4>9. Acceptation</h4>
          <p>Je, soussigné(e) <strong>{{ client.prenom if client else '' }} {{ client.nom if client else '' }}</strong>, reconnais avoir reçu et pris connaissance du présent <strong>Document d’Entrée en Relation</strong> avant tout engagement.</p>
          <p><strong>Fait à :</strong> {{ DER_courtier.adresse_ville if DER_courtier else '' }}<br/>
          {% set _d = fatca_today|default('') %}
          <strong>Le :</strong> {% if _d and (_d|length >= 10) %}{{ _d[8:10] ~ '/' ~ _d[5:7] ~ '/' ~ _d[0:4] }}{% else %}{{ fatca_today }}{% endif %}</p>
          <p><strong>Signature du client :</strong> ________________________<br/>
          <strong>Signature du courtier :</strong> ________________________</p>
        </div>
      </div>

      
    </div>
  </div>
  <!-- Modale dédiée: Lettre d’adéquation -->
  <div class="modal-overlay" id="confAdequationDetailModal" style="z-index:10001;" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal-card" style="width:760px; max-width:96vw;">
      <div class="modal-header"><h3><i class="fa-solid fa-file-circle-check" style="margin-right:8px;"></i>Lettre d’adéquation</h3><span style="flex:1"></span><span id="laToast" class="badge success" style="display:none; margin-right:8px;">Lettre mise à jour</span><button class="btn" type="button" id="laRefreshBtn" style="margin-right:8px;">Mettre à jour</button><button class="modal-close" onclick="document.getElementById('confAdequationDetailModal').style.display='none'">✕</button></div>
      <div class="modal-body">
        <style>
          .la h1 { font-size: 1.25rem; margin: 0 0 6px; }
          .la h2 { font-size: 1.05rem; margin: 12px 0 6px; }
          .la h3 { font-size: 1rem; margin: 10px 0 6px; }
          .la p { margin: 6px 0; }
          .la ul { margin: 6px 0 6px 18px; }
          .la table { width:100%; border-collapse: collapse; margin: 8px 0; }
          .la th, .la td { border:1px solid var(--border); padding:6px 8px; font-size:.92rem; }
          .la th { background: var(--primary); color:#fff; text-align:left; }
          .la .muted { color: var(--muted); }
          .la .meta { display:flex; gap:18px; flex-wrap:wrap; padding:8px 10px; background:#f8fafc; border:1px solid var(--border); border-radius:8px; }
          .la .meta div { min-width:220px; }
          .la .sig-box { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:10px; }
          .la .sig { border:1px dashed var(--border); border-radius:8px; padding:10px; height:120px; }
        </style>
        <div class="la">
          <h1><strong>Lettre d’adéquation – Conseil en assurance vie</strong></h1>
          <h2><strong>Références réglementaires</strong></h2>
          <ul>
            <li><strong>Code des assurances</strong> : article L. 522-5</li>
            <li><strong>Code monétaire et financier</strong> : article L. 519-6</li>
            <li><strong>Directive (UE) 2016/97 (IDD)</strong> du 20 janvier 2016 sur la distribution d’assurances</li>
            <li><strong>Règlement délégué (UE) 2017/2359</strong> du 21 septembre 2017</li>
            <li><strong>Code des assurances</strong> : articles R. 521-1 à R. 521-14</li>
          </ul>

          

          <h2><strong>1. Objet</strong></h2>
          <p>Cette lettre formalise le <strong>conseil personnalisé</strong> délivré par <strong>Courtage du Centre</strong> dans le cadre de la souscription du contrat d’assurance vie.</p>
          <p>Elle expose les éléments pris en compte pour s’assurer que le produit proposé est <strong>adapté à votre situation, à vos besoins et à vos objectifs</strong>.</p>

          <h2><strong>2. Analyse de votre situation</strong></h2>
          {% set _qual = (etat_civil_latest.civilite if etat_civil_latest else (kyc_etat_civil.civilite if kyc_etat_civil else None)) %}
          {% set _sitfam = (etat_civil_latest.situation_familiale if etat_civil_latest else (kyc_etat_civil.situation_familiale if kyc_etat_civil else None)) %}
          {% set _nb = (nb_enfants_latest if (nb_enfants_latest is not none) else (kyc_situations_matrimoniales[0].nb_enfants if (kyc_situations_matrimoniales and (kyc_situations_matrimoniales|length>0)) else 0)) %}
          {% set _t_rev = (synthese_latest.total_revenus if synthese_latest else None) %}
          {% set _t_chg = (synthese_latest.total_charges if synthese_latest else None) %}
          {% set _t_act = (synthese_latest.total_actif if synthese_latest else None) %}
          {% set _t_pas = (synthese_latest.total_passif if synthese_latest else None) %}
          {% set _net_pat = (_t_act|float - _t_pas|float) if (_t_act is not none and _t_pas is not none) else None %}
          {% set _net_bud = (_t_rev|float - _t_chg|float) if (_t_rev is not none and _t_chg is not none) else None %}
          {% set _dur2 = (risque_latest.horizon_placement if risque_latest else (risque_snapshot.duree if risque_snapshot else (risque_current.duree if risque_current else None))) %}
          {% set _niv2 = (risque_latest.niveau_risque if risque_latest else _niv) %}
          {% set _exp2 = (risque_latest.experience if risque_latest else _exp) %}
          {% set _con2 = (risque_latest.connaissance if risque_latest else _con) %}
          <p>
            {{ _qual or '—' }}, vous êtes actuellement {{ _sitfam or '—' }}{% if (_nb or 0) > 0 %}, et vous avez {{ _nb }} enfant{% if (_nb|int) > 1 %}s{% endif %} à charge{% else %}, et vous n'avez pas d'enfant à charge{% endif %}. 
            Ces éléments familiaux ont été pris en considération dans l’évaluation globale de votre situation et dans la définition de vos besoins patrimoniaux.
          </p>
          {% if _t_rev is not none and _t_chg is not none and _t_act is not none and _t_pas is not none %}
            <p>
              Sur le plan financier, vos revenus annuels s’élèvent à {{ '{:,.0f}'.format((_t_rev or 0)|float).replace(',', ' ') }} €, pour un niveau de charges annuelles de {{ '{:,.0f}'.format((_t_chg or 0)|float).replace(',', ' ') }} €.
              Votre budget disponible annuel, après déduction des charges, est ainsi estimé à {{ '{:,.0f}'.format((_net_bud or 0)|float).replace(',', ' ') }} €, traduisant une situation financière saine et équilibrée. 
              Votre actif total est évalué à {{ '{:,.0f}'.format((_t_act or 0)|float).replace(',', ' ') }} €, tandis que votre passif représente {{ '{:,.0f}'.format((_t_pas or 0)|float).replace(',', ' ') }} €,
              soit un patrimoine net de {{ '{:,.0f}'.format((_net_pat or 0)|float).replace(',', ' ') }} €.
            </p>
          {% endif %}
          <p>
            Concernant votre profil d’investissement, vous indiquez viser un horizon de placement {{ _dur2 or '—' }}, compatible avec des objectifs patrimoniaux de long terme.
            Votre tolérance au risque est qualifiée de {% if _niv2 %}« {{ _niv2 }} »{% else %}—{% endif %}, ce qui signifie que vous acceptez les fluctuations inhérentes aux marchés financiers dans la recherche d’un rendement plus élevé.
          </p>
          {% set _k = (_con2 or '')|lower %}
          {% set _e = (_exp2 or '')|lower %}
          {% set _is_adeq = ('averti' in _k) or ('avert' in _k) or ('confirm' in _k) or ('élev' in _k) or ('eleve' in _k) or (_k == 'oui') or ('averti' in _e) or ('avert' in _e) or ('confirm' in _e) or ('élev' in _e) or ('eleve' in _e) or (_e == 'oui') %}
          {% if _is_adeq %}
            <p>Enfin, votre connaissance et votre expérience financières correspondent à un investisseur capable de comprendre les caractéristiques et les risques des instruments proposés.</p>
          {% else %}
            <p>Enfin, votre connaissance et votre expérience financières ne permettent pas d’appréhender pleinement certains instruments complexes; les recommandations privilégieront des supports simples, une diversification prudente et une information renforcée sur les risques.</p>
          {% endif %}
          {% if risque_latest and risque_latest.confirmation_client is not none %}
            {% set _conf = (risque_latest.confirmation_client|string).lower() %}
            {% if _conf == 'oui' %}
              <p>Un questionnaire de détermination du profil investisseur a été complété : Vous avez validé le profil de risque déterminé par le questionnaire.</p>
            {% else %}
              <p>Un questionnaire de détermination du profil investisseur a été complété : le risque choisi est différent de celui déterminé par le questionnaire. Vous reconnaissez avoir été informé de cet écart et assumez pleinement la responsabilité de ce choix.</p>
            {% endif %}
          {% endif %}

          <!-- Synthèse connaissance client (résumé) -->
          <style>
            .la-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin:10px 0; }
            .la-card {
              border:1px solid var(--border);
              border-radius:12px;
              padding:12px;
              background:#fff;
              box-shadow:0 2px 8px rgba(0,0,0,0.06);
              text-align:center;
              display:flex;
              flex-direction:column;
              align-items:center;
              justify-content:center;
              min-height:96px;
            }
            .la-card .label { color:#6b7280; font-size:.9rem; line-height:1.2; margin:0; }
            .la-card .value { color:#1d4ed8; font-weight:700; font-size:1.05rem; line-height:1.2; margin:4px 0 0 0; }
            /* indicateurs cohérence objectifs vs durée KYC */
            .dot { display:inline-block; width:1em; height:1em; border-radius:50%; vertical-align:middle; }
            .dot-ok { background:#16a34a; }
            .dot-ko { background:#ef4444; }
          </style>
          
          <div class="la-grid" id="laRiskGrid">
            <div class="la-card"><div class="label">Connaissance générale</div><div class="value" id="laConnaissance">{{ (risque_latest.connaissance if risque_latest else (risque_snapshot.connaissance if risque_snapshot else '—')) or '—' }}</div></div>
            <div class="la-card"><div class="label">Expérience</div><div class="value" id="laExperience">{{ (risque_latest.experience if risque_latest else (risque_snapshot.experience if risque_snapshot else '—')) or '—' }}</div></div>
            <div class="la-card"><div class="label">Perte acceptée</div><div class="value" id="laPerte">{{ (risque_latest.perte_label if risque_latest and risque_latest.perte_label else (risque_snapshot.contraintes if risque_snapshot else '—')) or '—' }}</div><div class="label" id="laPerteCode" style="margin-top:4px; font-size:.8rem; color:#94a3b8;">{{ risque_latest.perte_code if risque_latest and risque_latest.perte_code else '' }}</div></div>
            <div class="la-card"><div class="label">Durée envisagée</div><div class="value" id="laDuree">{{ (risque_latest.horizon_placement if risque_latest and risque_latest.horizon_placement else (risque_snapshot.duree if risque_snapshot else '—')) or '—' }}</div><div class="label" id="laDureeCode" style="margin-top:4px; font-size:.8rem; color:#94a3b8;">{{ risque_latest.duree_code if risque_latest and risque_latest.duree_code else '' }}</div></div>
            <div class="la-card"><div class="label">Part du patrimoine</div><div class="value" id="laPatrimoine">{{ (risque_latest.patrimoine_label if risque_latest and risque_latest.patrimoine_label else (risque_snapshot.patrimoine if risque_snapshot else '—')) or '—' }}</div><div class="label" id="laPatrimoineCode" style="margin-top:4px; font-size:.8rem; color:#94a3b8;">{{ risque_latest.patrimoine_code if risque_latest and risque_latest.patrimoine_code else '' }}</div></div>
            <div class="la-card"><div class="label">Niveau final</div><div class="value" id="laNiveau">{{ (risque_latest.niveau_risque if risque_latest else (risque_snapshot.niveau_label if risque_snapshot else '—')) or '—' }}</div></div>
            <div class="la-card"><div class="label">Allocation</div><div class="value" id="laAllocation">{{ (risque_latest.allocation_nom if risque_latest and risque_latest.allocation_nom else (risque_snapshot.allocation_nom if risque_snapshot else '—')) or '—' }}</div></div>
          </div>

          <h2><strong>3. Comparatif des offres étudiées</strong></h2>
          <table>
            <colgroup>
              <col style="width: 50%;" />
              <col style="width: 35%;" />
              <col style="width: 15%;" />
            </colgroup>
            <thead>
              <tr>
                <th>Nom du contrat</th>
                <th>Compagnie d’assurance</th>
                <th style="text-align:center; min-width: 120px;">Total de frais</th>
              </tr>
            </thead>
            <tbody>
              {% if adequation_contracts and (adequation_contracts|length>0) %}
                {% for c in adequation_contracts %}
                  <tr>
                    <td>{{ c.nom_contrat }}</td>
                    <td>{{ c.societe_nom }}</td>
                    <td style="text-align:center; min-width: 120px;">{{ '%.2f'|format((c.total_frais or 0)|float) }} %</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="3" class="muted">Aucune offre disponible.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <p class="muted">Les informations détaillées sur chaque contrat sont fournies en annexe du présent document.</p>

          <h2><strong>4. Recommandation du courtier</strong></h2>
          <p>Le contrat recommandé est <strong id="laContratNom">{{ contrat_choisi_nom or '—' }}</strong>, assuré par <strong id="laContratSociete">{{ contrat_choisi_societe or '—' }}</strong>. Ce produit répond aux <strong>objectifs</strong> et au <strong>profil d’investissement</strong> du client.</p>
          <ul>
            <li><strong>Supports proposés :</strong> fonds euros, unités de compte.</li>
            <li><strong>Offre financière choisie :</strong> <span id="laOffre">{{ (risque_latest.allocation_nom if risque_latest and risque_latest.allocation_nom else (risque_snapshot.allocation_nom if risque_snapshot else (risque_latest.commentaire if risque_latest else '—'))) }}</span></li>
            <li>
              <strong>Objectifs :</strong>
              <div style="margin-top:6px;">
          <table>
            <thead>
              <tr>
                <th style="width:1.8rem; text-align:center;">&nbsp;</th>
                <th>Objectif</th>
                <th>Horizon</th>
                <th>Commentaire</th>
              </tr>
            </thead>
            <tbody id="laObjTbody">
              {% if adequation_objectifs and (adequation_objectifs|length>0) %}
                {# calcul rang de la durée KYC #}
                {% set _d = (_dur2 or '')|lower %}
                {% set _kidx = 4 if 'plus de 8' in _d else (3 if '5 à 8' in _d or '5 a 8' in _d else (2 if '3 à 5' in _d or '3 a 5' in _d else (1 if '1 à 3' in _d or '1 a 3' in _d else 0))) %}
                {% for o in adequation_objectifs %}
                  {% set _h = (o.horizon_investissement or '')|lower %}
                  {% set _oidx = 4 if 'plus de 8' in _h else (3 if '5 à 8' in _h or '5 a 8' in _h else (2 if '3 à 5' in _h or '3 a 5' in _h else (1 if '1 à 3' in _h or '1 a 3' in _h else 0))) %}
                  {% set _ok = (_oidx >= _kidx) and (_kidx > 0) and (_oidx > 0) %}
                  <tr>
                    <td style="text-align:center;"><span class="dot {{ 'dot-ok' if _ok else 'dot-ko' }}" title="{{ 'Cohérent' if _ok else 'Incohérent' }}"></span></td>
                    <td>{{ o.objectif_libelle or '—' }}</td>
                    <td>{{ o.horizon_investissement or '—' }}</td>
                    <td>{{ o.commentaire or '—' }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="4" class="muted">Aucun objectif enregistré.</td></tr>
              {% endif %}
            </tbody>
          </table>
          <p style="font-style: italic; margin:6px 0 0 0;">
            Les objectifs en cohérence avec votre durée d'investissement issue du questionnaire celient sont en vert, en rouge dans le cas contraire.
          </p>
              </div>
            </li>
          </ul>

          <h2><strong>5. Détail de l'offre</strong></h2>
          {% if adequation_allocation_html %}
            <div class="card" style="margin:6px 0; padding:8px 10px;">{{ adequation_allocation_html | safe }}</div>
          {% else %}
            <p class="muted">Détail d’offre indisponible.</p>
          {% endif %}

          <h2><strong>5. Mises en garde</strong></h2>
          <ul>
            <li>Le client reconnaît avoir été informé des <strong>caractéristiques, coûts et risques</strong> des contrats présentés ;</li>
            <li>que la <strong>valeur des supports</strong> peut fluctuer à la hausse comme à la baisse ;</li>
            <li>que les <strong>performances passées ne préjugent pas des performances futures</strong> ;</li>
            <li>que le conseil repose sur les informations communiquées et qu’une omission ou inexactitude peut en affecter la pertinence.</li>
          </ul>

          <h2><strong>6. Accord du client</strong></h2>
          <p>Je soussigné(e) <strong>{{ client.prenom if client else '' }} {{ client.nom if client else '' }}</strong>, déclare avoir reçu et pris connaissance de la présente lettre d’adéquation. Je confirme que le conseil fourni correspond à mes attentes et à mes objectifs patrimoniaux.</p>
          <div class="sig-box">
            <div class="sig"><strong>Signature du client</strong><br/><span class="muted">[Date et lieu]</span></div>
            <div class="sig"><strong>Signature du courtier</strong><br/><span class="muted">[Date et lieu]</span></div>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" type="button" onclick="window.print()"><i class="fa-solid fa-print" style="margin-right:6px;"></i>Imprimer</button>
        </div>
      </div>
    </div>
  </div>


  </div>

<script>
  // Toggle Conformité panel
    // Ouvrir/fermer la modale Conformité
    function openConfMain(){ var m=document.getElementById('confMainModal'); if(m) m.style.display='flex'; }
    function closeConfMain(){ var m=document.getElementById('confMainModal'); if(m) m.style.display='none'; }
    // Open modals (exclusive)
    function __showOverlay(id){ try{ document.querySelectorAll('.modal-overlay').forEach(function(el){ el.style.display='none'; }); }catch(e){} var m=document.getElementById(id); if(m) m.style.display='flex'; }
    function openConfConnaissanceDetail(){ __showOverlay('confConnaissanceDetailModal'); }
    function closeConfConnaissanceDetail(){
      var m=document.getElementById('confConnaissanceDetailModal'); if(m) m.style.display='none';
      var la = document.getElementById('confAdequationDetailModal');
      if (la && la.style.display === 'flex'){
        var btn = document.getElementById('laRefreshBtn');
        if (btn){ btn.click(); }
      }
    }
    function openConfTacfinDetail(){ __showOverlay('confTacfinDetailModal'); }
    function closeConfTacfinDetail(){
      var m=document.getElementById('confTacfinDetailModal'); if(m) m.style.display='none';
      var la = document.getElementById('confAdequationDetailModal');
      if (la && la.style.display === 'flex'){
        var btn = document.getElementById('laRefreshBtn');
        if (btn){ btn.click(); }
      }
    }
    function openConfEerDetail(){ __showOverlay('confEerDetailModal'); }
    function openConfMissionDetail(){ __showOverlay('confMissionDetailModal'); }
    function openConfAdequationDetail(){
      try { document.querySelectorAll('.modal-overlay').forEach(function(el){ el.style.display='none'; }); } catch(e){}
      var m = document.getElementById('confAdequationDetailModal');
      if (m && m.parentElement !== document.body) {
        try { document.body.appendChild(m); } catch(e){}
      }
      if (m) m.style.display='flex';
      var main = document.getElementById('confMainModal');
      if (main) main.style.display='none';
    }
    // removed: mission2, tempo
  </script>
<script>
  // Inject today date in Lettre d’adéquation
  (function(){ try{ var el=document.getElementById('laDate'); if(el){ var d=new Date(); var s=d.toLocaleDateString(); el.textContent=s; } }catch(e){} })();
</script>
<script>
  (function(){
    // Interception de l'envoi LCBFT pour rester dans la modale
    try{
      var lcbftForm = document.getElementById('lcbftFormDetail');
      if (lcbftForm){
        lcbftForm.addEventListener('submit', function(ev){
          try{ ev.preventDefault(); }catch(e){}
          var fd = new FormData(lcbftForm);
          fetch(lcbftForm.getAttribute('action') || window.location.href, { method: 'POST', body: fd, credentials: 'same-origin' })
            .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
            .then(function(){
              var toast = document.getElementById('lcbftDetailToast');
              if (toast){ toast.style.display='inline-block'; setTimeout(function(){ toast.style.display='none'; }, 3000); }
              // Si la lettre d’adéquation est ouverte, rafraîchir son contenu
              if (typeof window.refreshAdequation === 'function'){ window.refreshAdequation(); }
            })
            .catch(function(err){ console.warn('LCBFT save failed', err); });
        });
      }
    }catch(e){}
    function doRefresh(){
      try{
        fetch('/dashboard/clients/{{ client.id }}/adequation.json').then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }).then(function(data){
          try{ document.getElementById('laOffre').textContent = (data.offre_commentaire || '—'); }catch(e){}
          try{ document.getElementById('laContratNom').textContent = (data.contrat_nom || '—'); }catch(e){}
          try{ document.getElementById('laContratSociete').textContent = (data.contrat_societe || '—'); }catch(e){}
          try{
            var rs = data.risque_summary || {};
            var map = {
              laConnaissance: rs.connaissance,
              laExperience: rs.experience,
              laPerte: rs.contraintes,
              laDuree: rs.duree,
              laPatrimoine: rs.patrimoine,
              laNiveau: rs.niveau_label,
              laAllocation: rs.allocation_nom
            };
            Object.keys(map).forEach(function(id){ var el=document.getElementById(id); if(el){ el.textContent = (map[id] || '—'); }});
            // codes debug
            try{ var el=document.getElementById('laPerteCode'); if(el){ el.textContent = rs.perte_code || ''; } }catch(e){}
            try{ var el=document.getElementById('laDureeCode'); if(el){ el.textContent = rs.duree_code || ''; } }catch(e){}
            try{ var el=document.getElementById('laPatrimoineCode'); if(el){ el.textContent = rs.patrimoine_code || ''; } }catch(e){}
          }catch(e){}
          try{
            var tb = document.getElementById('laObjTbody');
            if (tb){
              tb.innerHTML = '';
              var rows = (data.objectifs || []);
              if (!rows.length){ tb.innerHTML = '<tr><td colspan="4" class="muted">Aucun objectif enregistré.</td></tr>'; }
              else {
                function rankDur(txt){
                  if(!txt) return 0;
                  var s = String(txt).toLowerCase();
                  if(s.indexOf('plus de 8') >= 0) return 4;
                  if(s.indexOf('5 à 8') >= 0 || s.indexOf('5 a 8') >= 0) return 3;
                  if(s.indexOf('3 à 5') >= 0 || s.indexOf('3 a 5') >= 0) return 2;
                  if(s.indexOf('1 à 3') >= 0 || s.indexOf('1 a 3') >= 0) return 1;
                  return 0;
                }
                // KYC duration from JSON or fallback to DOM value
                var kycDur = (data.risque_summary && data.risque_summary.duree) || (document.getElementById('laDuree') ? document.getElementById('laDuree').textContent : null);
                var kidx = rankDur(kycDur);
                rows.forEach(function(o){
                  var tr = document.createElement('tr');
                  var ok = false;
                  try{ ok = rankDur(o.horizon_investissement) >= kidx && kidx > 0 && rankDur(o.horizon_investissement) > 0; }catch(e){ ok = false; }
                  var td0 = document.createElement('td');
                  var dot = document.createElement('span'); dot.className = 'dot ' + (ok ? 'dot-ok':'dot-ko'); dot.title = ok ? 'Cohérent':'Incohérent';
                  td0.style.textAlign = 'center'; td0.appendChild(dot);
                  var td1 = document.createElement('td'); td1.textContent = o.objectif_libelle || '—';
                  var td2 = document.createElement('td'); td2.textContent = o.horizon_investissement || '—';
                  var td3 = document.createElement('td'); td3.textContent = o.commentaire || '—';
                  tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
                  tb.appendChild(tr);
                });
              }
            }
          }catch(e){}
          try{ var t=document.getElementById('laToast'); if(t){ t.style.display='inline-block'; setTimeout(function(){ t.style.display='none'; }, 1500); } }catch(e){}
        }).catch(function(err){ console.warn('Refresh adequation failed', err); });
      }catch(e){ /* noop */ }
    }
    var btn = document.getElementById('laRefreshBtn');
    if (btn){ btn.addEventListener('click', doRefresh); }
    window.refreshAdequation = doRefresh;
  })();
</script>
<script>
  // Charger la liste des documents de base pour le select
  (async function loadDocuments() {
    try {
      const res = await fetch('/documents/');
      if (!res.ok) return;
      const docs = await res.json();
      const sel = document.getElementById('document_base_select');
      sel._allOptions = [];
      docs.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id_document_base;
        opt.textContent = d.documents || `Document ${d.id_document_base}`;
        sel._allOptions.push(opt);
      });
      function renderOptions(filter) {
        sel.innerHTML = '<option value="" disabled selected>Choisir…</option>';
        (sel._allOptions || []).forEach(opt => {
          if (!filter) { sel.appendChild(opt.cloneNode(true)); return; }
          const t = (opt.textContent||'').toLowerCase();
          if (t.includes(filter.toLowerCase())) sel.appendChild(opt.cloneNode(true));
        });
      }
      renderOptions('');
      document.getElementById('doc_filter').addEventListener('input', function(){
        renderOptions(this.value);
      });
    } catch (e) { /* ignore */ }
  })();

  // Ajout document-client via API
  document.getElementById('addDocForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const payload = {
      id_client: {{ client.id }},
      id_document_base: parseInt(document.getElementById('document_base_select').value, 10),
      nom_document: document.getElementById('nom_document').value || null,
      date_creation: document.getElementById('date_creation').value || null,
      date_obsolescence: document.getElementById('date_obsolescence').value || null,
      obsolescence: document.getElementById('obsolescence').value || null,
    };

    const res = await fetch('/documents_clients/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      location.reload();
    } else {
      const err = await res.json().catch(() => ({}));
      alert('Erreur: ' + (err.detail || res.status));
    }
  });

  // Suppression document-client
  document.querySelectorAll('.delBtn').forEach(btn => {
    btn.addEventListener('click', async function () {
      const id = this.dataset.id;
      if (!confirm('Supprimer ce document ?')) return;
      const res = await fetch(`/document_client/${id}`, { method: 'DELETE' });
      if (res.ok) {
        location.reload();
      } else {
        alert('Suppression impossible');
      }
    });
  });

  // DataTable + filtres pour la table Documents client
  (function(){
    try {
      var table = $('#clientDocs').DataTable({ order:[[0,'asc']], pageLength:25, fixedHeader:true, lengthChange:false, searching:false, dom:'rtip' });
      // Remplir le select Statut (colonne 4)
      var sel = document.getElementById('cd-status-filter');
      table.column(4).data().unique().sort().each(function (d) { if (d) { var o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o);} });
      // Filtres texte
      $('#cd-type-filter').on('keyup change', function(){ table.column(0).search(this.value).draw(); });
      $('#cd-nom-filter').on('keyup change', function(){ table.column(1).search(this.value).draw(); });
      $('#cd-cr-filter').on('keyup change', function(){ table.column(2).search(this.value).draw(); });
      $('#cd-obsdate-filter').on('keyup change', function(){ table.column(3).search(this.value).draw(); });
      $('#cd-status-filter').on('change', function(){ var v=this.value; table.column(4).search(v? '^'+$.fn.dataTable.util.escapeRegex(v)+'$':'' , true, false).draw(); });
    } catch(e) { /* ignore */ }
  })();
</script>

{% endblock %}
