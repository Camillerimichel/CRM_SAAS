{% extends "base.html" %}

{% block title %}{% if affaire %}{{ affaire.ref }}{% else %}Détail Affaire{% endif %}{% endblock %}
{% block header_title %}
  <span style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
    <span><i class="fa-solid fa-briefcase" style="margin-right:8px;"></i>Suivi de l'affaire{% if affaire %} – {{ affaire.ref }}{% endif %}</span>
    {% if client_responsable %}
      <span class="badge" style="background:#eef2ff; border:1px solid #c7d2fe; color:#1e3a8a; padding:2px 8px; border-radius:999px; font-size:.85rem;">Responsable: {{ client_responsable }}</span>
    {% endif %}
  </span>
{% endblock %}

{% block content %}
<style>
  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
  /* Bandeau KPI: grille réactive stricte (évite tout dépassement) */
  .kpi-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; width:100%; }
  .kpi-grid .card { min-width:0; box-sizing:border-box; }
  /* suppr. les ruptures pour garder 3 colonnes et éviter le passage sur 2 lignes */
  .card { background:#fff; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
  .kpi { font-size:0.95rem; font-weight:700; }
  .kpi-mini { font-size:0.85rem; color:#333; line-height:1.2; }
  .kpi-line { display:flex; align-items:center; justify-content:space-between; gap: 8px; }
  .kpi-line .kv { font-weight:600; text-align:right; }
  .muted { color:#666; font-size:0.9rem; }
  table { width:100%; border-collapse: collapse; }
  th, td { padding:8px 10px; border-bottom:1px solid #eee; }
  th { background:#f8f9fa; text-align:left; }
  .right { text-align:right; }
  .row-good { background: #e8f7ee; }
  .row-bad { background: #fdeaea; }
  /* table supports: compact and widths */
  #supportsTableContract { table-layout: fixed; }
  #supportsTableContract th, #supportsTableContract td { padding: 6px 8px; }
  #supportsTableContract th:nth-child(1), #supportsTableContract td:nth-child(1) { width: 20%; }
  #supportsTableContract th:nth-child(2), #supportsTableContract td:nth-child(2) { width: 18%; overflow:hidden; text-overflow: ellipsis; }
  #supportsTableContract th:nth-child(3), #supportsTableContract td:nth-child(3) { width: 5%; text-align: center; }
  /* Numeric columns (Nb UC, VL, PRMP, Valorisation) widths */
  #supportsTableContract th:nth-child(4), #supportsTableContract td:nth-child(4) { width: 8%; }
  #supportsTableContract th:nth-child(5), #supportsTableContract td:nth-child(5) { width: 5%; }
  #supportsTableContract th:nth-child(6), #supportsTableContract td:nth-child(6) { width: 5%; }
  #supportsTableContract th:nth-child(7), #supportsTableContract td:nth-child(7) { width: 10%; }
  /* ESG columns ultra-compact */
  #supportsTableContract th:nth-child(8), #supportsTableContract td:nth-child(8),
  #supportsTableContract th:nth-child(9), #supportsTableContract td:nth-child(9),
  #supportsTableContract th:nth-child(10), #supportsTableContract td:nth-child(10) { width: 2%; text-align: center; padding: 2px; }
  /* Right-align headers for Nb UC, PRMP, Valorisation */
  #supportsTableContract th:nth-child(4), #supportsTableContract th:nth-child(6), #supportsTableContract th:nth-child(7) { text-align: right; }
  /* DataTables center alignment helper */
  .dt-center { text-align: center; }
  .gain { color: #2e7d32; }
  .loss { color: #c62828; }
  .kpi-heading {
    display:inline-block;
    background: var(--primary);
    color:#fff;
    font-weight:600;
    border-radius:8px;
    padding:6px 10px;
    margin-bottom:6px;
  }
  .section-toggle-row .accordion-toggle.active {
    color: var(--primary-600) !important;
  }
  .section-toggle-row .accordion-toggle.active i {
    color: var(--primary-600) !important;
  }
  /* Equal-size pie charts */
  .pie-grid { grid-template-columns: 1fr 1fr; align-items: stretch; }
  /* Cadres fixes, assez hauts pour afficher les abscisses */
  .pie-card { display: flex; flex-direction: column; height: 300px; overflow: hidden; }
  .pie-card canvas { flex: 1 1 auto; display:block; }
  .chart-title { font-size: 0.95rem; margin: 0 0 4px 0; }
  .accordion-toggle h3 { font-size: 1.05rem !important; margin: 0; font-weight: 600; }
  .accordion-toggle .chevron { display:inline-block; margin-left:8px; transition: transform .2s ease, color .2s ease; font-size: 1rem; }
  .accordion-toggle.collapsed .chevron { transform: rotate(-90deg); }
  /* Small SRRI icon override */
  .card .srri-icon { font-size: 0.9rem !important; margin-left: 6px; margin-bottom: 0 !important; vertical-align: middle; }
  /* Harmoniser boutons avec Détail Client */
  .dim-btn { padding:3px 7px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa; cursor:pointer; font-size:11px; }
  .dim-btn.active { background: var(--primary); color:#fff; border-color: var(--primary); }
  .rangeBtn { padding:3px 7px; border:1px solid #ccc; border-radius:8px; background:#f8f9fa; cursor:pointer; font-size:11px; margin-right:4px; }
  .rangeBtn:hover { background:#eef1ff; border-color:#bbb; }
  .aff-support-link { color:#111827; text-decoration:underline; }
  .aff-support-link:hover { text-decoration:none; }
  #affSupportMovementsTable th, #affSupportMovementsTable td { padding:10px 12px; border-bottom:1px solid #e2e8f0; }
  #affSupportMovementsTable th { background:#1d4ed8; color:#fff; text-transform:none; font-size:0.87rem; }
  #affSupportMovementsTable tr:nth-child(even) td { background:#f8fafc; }
  /* ESG block full width enforcement */
  #esgToggle, #esgSection, #esgSection > .card { width:100%; box-sizing:border-box; grid-column: 1 / -1; }
  /* Toggle chevron styles (reuse for inv+graphs) */
  #invToggle, #esgToggle, #avisToggle, #graphsToggle, #affTasksToggle, #riskToggle {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    text-align:center;
    width:auto;
    box-sizing:border-box;
    grid-column: auto;
    clear: none;
    background: transparent !important;
    border: 1px solid transparent !important;
    box-shadow: none !important;
  }
  #invToggle .chevron, #esgToggle .chevron, #avisToggle .chevron, #graphsToggle .chevron { display:inline-block; margin-left:8px; transition: transform .2s ease, color .2s ease; font-size: 1rem; }
  #invToggle.collapsed .chevron, #esgToggle.collapsed .chevron, #avisToggle.collapsed .chevron, #graphsToggle.collapsed .chevron { transform: rotate(-90deg); }
  #invToggle:not(.collapsed), #esgToggle:not(.collapsed), #graphsToggle:not(.collapsed), #reportToggle:not(.collapsed), #affTasksToggle:not(.collapsed), #riskToggle:not(.collapsed) {
    background: transparent !important;
    color: var(--primary-600);
    border-color: transparent !important;
    box-shadow:none !important;
  }
  #invToggle:not(.collapsed) *, #esgToggle:not(.collapsed) *, #graphsToggle:not(.collapsed) *, #reportToggle:not(.collapsed) *, #affTasksToggle:not(.collapsed) *, #riskToggle:not(.collapsed) * {
    color: var(--primary-600) !important;
  }
  #invToggle:not(.collapsed) .badge, #esgToggle:not(.collapsed) .badge, #graphsToggle:not(.collapsed) .badge, #reportToggle:not(.collapsed) .badge {
    background:transparent !important;
    border-color:transparent !important;
  }
  /* RBAC UI hides */
  body[data-user-role="client"] .client-hide { display: none !important; }
  body[data-user-role="client"] .client-readonly { pointer-events: none !important; opacity: 0.5; }
  body[data-user-role="back_office"] .backoffice-hide { display: none !important; }
  /* Ensure accordion sections take full row under any grid */
  #invSection, #graphsSection { width:100%; grid-column: 1 / -1; }
  /* Reportings pluriannuels toggle full width */
  #reportToggle {
    width:auto;
    box-sizing:border-box;
    grid-column: auto;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    text-align:center;
    background: transparent !important;
    border: 1px solid transparent !important;
    box-shadow: none !important;
  }
  #reportToggle .chevron { display:inline-block; margin-left:8px; transition: transform .2s ease; font-size: 1rem; }
  #reportToggle.collapsed .chevron { transform: rotate(-90deg); }
  #reportSection { width:100%; grid-column: 1 / -1; }
  /* Toggle chevron */
  #graphsToggle { display:flex; align-items:center; justify-content:center; gap:8px; text-align:center; }
  #graphsToggle .chevron { display:inline-block; margin-left:8px; transition: transform .2s ease; font-size: 1rem; }
  #graphsToggle.collapsed .chevron { transform: rotate(-90deg); }
  /* Barre horizontale des boutons d'accordéon */
  .section-toggle-row {
    display:flex;
    flex-direction:row;
    justify-content:flex-start;
    column-gap:12px;
    row-gap:8px;
    align-items:center;
    flex-wrap:wrap;
    overflow-x:auto;
    padding:8px 0 10px;
    margin:12px 0 10px;
    width:100%;
    max-width:100%;
    grid-column: 1 / -1;
    box-sizing:border-box;
  }
  .section-toggle-row .accordion-toggle {
    flex:0 0 auto;
    min-width:0;
    white-space:normal;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    background: transparent !important;
    border: 1px solid transparent !important;
    box-shadow: none !important;
    color: var(--text) !important;
    padding: 6px 8px;
  }
  .section-toggle-row .accordion-toggle h3 {
    font-size:0.95rem;
    line-height:1.2;
    margin:0;
    display:flex;
    align-items:center;
    gap:6px;
    color: inherit;
  }
  .section-toggle-row .accordion-toggle i,
  .section-toggle-row .accordion-toggle span { color: inherit !important; }
  .section-toggle-row .accordion-toggle,
  .section-toggle-row .accordion-toggle.collapsed,
  .section-toggle-row .accordion-toggle.collapsed * {
    color: var(--text) !important;
  }
  .section-toggle-row .chevron { display:none; }
  #affTasksToggle {
    background:#fff;
    color:var(--text);
    border:1px solid var(--border);
    box-shadow:var(--shadow-sm);
  }
  #affTasksToggle .chevron {
    color:var(--muted);
  }
  #affTasksToggle:not(.collapsed) {
    background:#fff;
    color:var(--text);
    border:1px solid var(--border);
    box-shadow:var(--shadow-sm);
  }
  #affTasksToggle:not(.collapsed) * { color:inherit !important; }
  #avisToggle {
    background:#fff;
    color:var(--text);
    border:1px solid var(--border);
    box-shadow:var(--shadow-sm);
  }
  #avisToggle .chevron,
  #avisToggle .badge,
  #avisToggle i { color:var(--muted); }
  #avisToggle:not(.collapsed) {
    background:#fff;
    color:var(--text);
    border:1px solid var(--border);
    box-shadow:var(--shadow-sm);
  }
  #avisToggle:not(.collapsed) * {
    color:inherit !important;
  }
</style>
<style>
  .tb-markers-enabled [data-tb-marker] {
    position: relative;
    outline: 2px dashed rgba(5,121,180,0.35);
  }
.tb-markers-enabled [data-tb-marker]::before {
    content: attr(data-tb-marker);
    position: absolute;
    top: -12px;
    left: 0;
    background: rgba(5,121,180,0.9);
    color: #fff;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 30;
    pointer-events: none;
    box-shadow: 0 2px 6px rgba(15,23,42,0.2);
  }
</style>

{% set af_markers_param = tb_markers_param if tb_markers_param is defined else '' %}
<div class="tb-page{% if tb_markers_visible %} tb-markers-enabled{% endif %}" data-tb-marker="AF_01">

<h1>
  {% if client_id %}
    <a href="/dashboard/clients/{{ client_id }}" style="text-decoration:underline; color: inherit;">{{ client_prenom }} {{ client_nom }}</a>
  {% else %}
    {% if affaire %}{{ affaire.ref }}{% else %}Détail du contrat{% endif %}
  {% endif %}
</h1>
{% if error %}
  <div class="card">{{ error }}</div>
{% else %}

<!-- Modal: Messages/Tâches affaire (filtré par type réglementaire / non réglementaire) -->
<style>
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items: center; justify-content: center; z-index: 9999; }
  .modal-card { background: #fff; border-radius: 12px; width: 780px; max-width: 95vw; max-height: 92vh; overflow: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--border); }
  .modal-header h3 { margin: 0; font-size: 1.05rem; }
  .modal-body { padding: 12px 14px; }
  .modal-close { border:none; background: transparent; cursor: pointer; font-size: 18px; }
  /* Harmonisation colonnes pop-up Messages (affaire) */
  #affMsgsTable { table-layout: fixed; width: 100%; }
  #affMsgsTable th:nth-child(1), #affMsgsTable td:nth-child(1) { width: 13%; }
  #affMsgsTable th:nth-child(2), #affMsgsTable td:nth-child(2) { width: 15%; }
  #affMsgsTable th:nth-child(3), #affMsgsTable td:nth-child(3) { width: 13%; }
  #affMsgsTable th:nth-child(4), #affMsgsTable td:nth-child(4) { width: 10%; }
  #affMsgsTable th:nth-child(5), #affMsgsTable td:nth-child(5) { width: 26%; }
  #affMsgsTable th:nth-child(6), #affMsgsTable td:nth-child(6) { width: 7%; text-align:center; }
  #affMsgsTable th:nth-child(7), #affMsgsTable td:nth-child(7) { width: 7%; text-align:center; }
  #affMsgsTable th:nth-child(8), #affMsgsTable td:nth-child(8) { width: 9%; text-align:center; }
  #affMsgsTable td { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #affMsgsTable td:nth-child(5) { white-space: normal; word-break: break-word; }
</style>
<div id="affMsgsModal" class="modal-overlay" data-tb-marker="AF_09" onclick="if(event.target===this) closeAffMsgs()">
    <div class="modal-card" data-tb-marker="AF_10">
    <div class="modal-header">
      <h3 id="affMsgsTitle"><i class="fa-solid fa-envelope" style="margin-right:8px;"></i>Messages</h3>
      <button class="modal-close" onclick="closeAffMsgs()">✕</button>
    </div>
    <div class="modal-body">
      <table id="affMsgsTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Catégorie</th>
            <th>Statut</th>
            <th>Commentaire</th>
            <th>ID (row.id)</th>
            <th>ID (evenement_id)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pop-up SRRI / Risque -->
<div id="affRiskModal" class="modal-overlay" onclick="if(event.target===this) closeAffRiskModal()">
  <div class="modal-card" style="width:420px; max-width:95vw;">
    <div class="modal-header">
      <h3 style="display:flex; align-items:center; gap:8px; margin:0;"><i class="fa-solid fa-triangle-exclamation"></i>SRRI de l'affaire</h3>
      <button class="modal-close" onclick="closeAffRiskModal()">✕</button>
    </div>
    <div class="modal-body">
      <p class="muted" style="margin-bottom:10px;">Modifier le SRRI impacte le profil de risque. Veillez à obtenir la validation du client avant de confirmer.</p>
      <form class="client-hide" method="post" action="/dashboard/affaires/{{ affaire.id }}/srri" onsubmit="return confirm('Changer le niveau de risque (SRRI) impacte le profil de l\'affaire. Confirmer la modification ?');">
        {% if af_markers_param %}<input type="hidden" name="markers" value="1"/>{% endif %}
        <label for="srriSelect">SRRI (1 à 7)</label>
        <select id="srriSelect" name="srri" style="margin:6px 0 12px 0; width:100%;">
          <option value="">-- Sélectionner --</option>
          {% for n in range(1,8) %}
            <option value="{{ n }}" {% if srri_client is not none and (srri_client|int)==n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
        <div class="muted" style="font-size:0.9rem; margin-bottom:12px;">SRRI actuel: {{ srri_client if srri_client is not none else '-' }} | SRRI calculé: {{ srri_calc if srri_calc is not none else '-' }}</div>
        <div style="display:flex; justify-content:flex-end; gap:8px;">
          <button type="button" class="btn" onclick="closeAffRiskModal()">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- KPIs en tête -->
  <!-- Tâches désactivées (maintenance) -->
  <div class="section-toggle-row" style="margin-top:12px;">
    <div id="invToggle" class="card accordion-toggle" title="Investissements" aria-label="Investissements">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px; justify-content:flex-start;">
        <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
        <span>Investissements</span>
      </h3>
    </div>
    <div id="esgToggle" class="card accordion-toggle" title="ESG" aria-label="ESG">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px; justify-content:flex-start;">
        <i class="fa-solid fa-leaf" aria-hidden="true"></i>
        <span>ESG</span>
      </h3>
    </div>
    <div id="avisToggle" class="card accordion-toggle" data-tb-marker="AF_12" title="Avis d'opération" aria-label="Avis d'opération" onclick="markAffToggleActive('avisToggle'); openAvisModal()">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px; justify-content:flex-start;">
        <i class="fa-solid fa-file-contract" aria-hidden="true"></i>
        <span>Avis d'opération</span>
      </h3>
    </div>
    <div id="riskToggle" class="card accordion-toggle client-hide" title="SRRI / Risque" aria-label="SRRI / Risque" onclick="markAffToggleActive('riskToggle'); openAffRiskModal()">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px; justify-content:flex-start;">
        <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
        <span>SRRI / Risque</span>
      </h3>
    </div>
    <div id="graphsToggle" class="card accordion-toggle" data-tb-marker="AF_17" title="Graphiques" aria-label="Graphiques">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px; justify-content:flex-start;">
        <i class="fa-solid fa-chart-pie" aria-hidden="true"></i>
        <span>Graphiques</span>
      </h3>
    </div>
    <div id="reportToggle" class="card accordion-toggle" data-tb-marker="AF_22" title="Reportings annuels" aria-label="Reportings annuels">
      <h3 style="margin:0; display:flex; align-items:center; gap:8px; justify-content:flex-start;">
        <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
        <span>Reportings annuels</span>
      </h3>
    </div>
  </div>
<div class="card" style="margin-top:10px; margin-bottom:0.5rem; padding:0;">
  <div id="affSynthToggle" class="accordion-toggle" data-target="affSynthPanel" style="margin:0; cursor:pointer; justify-content:center; text-align:center;">
    <h3 style="margin:0; display:flex; align-items:center; justify-content:center; gap:8px; width:100%; text-align:center;">
      <i class="fa-solid fa-rectangle-list" aria-hidden="true"></i>
      <span style="flex:0 0 auto;">Synthèse</span>
      <span class="chevron" style="margin-left:4px;">▾</span>
    </h3>
  </div>
  <div id="affSynthPanel" class="accordion-panel" style="display:none; padding:1rem 1.25rem; border-top:1px solid var(--border);">
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px;">
      {% if msgs_nonreg_count and msgs_nonreg_count > 0 %}
        <button type="button" class="btn" style="background:transparent; color:#16a34a; border:1px solid transparent; padding:.25rem .5rem; font-size:.85rem;" onclick="openAffMsgs('nonreg')" title="Messages en cours">
          <i class="fa-solid fa-triangle-exclamation"></i> {{ msgs_nonreg_count }}
        </button>
      {% endif %}
      {% if msgs_reg_count and msgs_reg_count > 0 %}
        <button type="button" class="btn" style="background:#fff; color:#c62828; border:1px solid transparent; padding:.25rem .5rem; font-size:.85rem;" onclick="openAffMsgs('reg')" title="Messages réglementaires">
          <i class="fa-solid fa-triangle-exclamation"></i> {{ msgs_reg_count }}
        </button>
      {% endif %}
      {% if affaire %}
        <button type="button" class="btn client-hide" style="background:#fff; color:var(--text); border:1px solid transparent; padding:.25rem .6rem; font-size:.85rem;" onclick="openAffTaskPage()" title="Créer une tâche pour ce contrat">
          <i class="fa-solid fa-plus"></i> Créer une tâche
        </button>
      {% endif %}
      {% if affaire %}
        <button type="button" class="btn" style="background:#fff; color:var(--text); border:1px solid transparent; padding:.25rem .6rem; font-size:.85rem;" onclick="generateAffaireSynthese()" title="Synthèse PDF">
          <i class="fa-solid fa-file-pdf"></i>
        </button>
      {% endif %}
      <button type="button" class="btn" style="background:#fff; color:var(--text); border:1px solid transparent; padding:.25rem .6rem; font-size:.85rem;" onclick="openAffAdminGroups()" title="Administration">
        <i class="fa-solid fa-gear"></i>
      </button>
    </div>
    <div class="kpi-grid" data-tb-marker="AF_02" style="margin-top:0;">
      <div class="card" data-tb-marker="AF_03">
        <div class="kpi-heading">Synthèse</div>
        <div class="kpi-mini"><strong>Statut:</strong>
          {% if affaire and affaire.date_cle %}
            Clôturé (<span class="js-local-dt" data-iso="{{ affaire.date_cle }}">{{ affaire.date_cle }}</span>)
          {% else %}
            Ouvert
          {% endif %}
        </div>
        <div class="kpi-mini"><strong>Durée historique:</strong> {{ duree_historique_aff_str }}</div>
        <div class="kpi-mini"><strong>Société (gestion/courtage):</strong>
          {% if societe_gestion_nom %}
            {{ societe_gestion_nom }}{% if societe_gestion_role %} — {{ societe_gestion_role }}{% endif %}
          {% else %}
            —
          {% endif %}
        </div>
      </div>
      <div class="card" data-tb-marker="AF_04">
        <div class="kpi-heading">Investissement</div>
        <div class="kpi-mini kpi-line" style="margin-top:6px;">
          <span>Valorisation</span>
          <span class="kv" style="font-size:1.35rem;">{{ '{:,.0f}'.format(last_valo or 0).replace(',', ' ') }} €</span>
        </div>
        <div class="kpi-mini kpi-line" style="margin-top:4px;">
          <span>Variation</span>
          <span class="kv {% if (last_valo or 0) >= (solde or 0) %}gain{% else %}loss{% endif %}">{% if (last_valo or 0) >= (solde or 0) %}En plus-value{% else %}En moins-value{% endif %}</span>
        </div>
        <div class="kpi-mini kpi-line" style="margin-top:6px;"><span>Versements</span><span class="kv">{{ '{:,.0f}'.format(depots or 0).replace(',', ' ') }} €</span></div>
        <div class="kpi-mini kpi-line"><span>Retraits</span><span class="kv">{{ '{:,.0f}'.format(retraits or 0).replace(',', ' ') }} €</span></div>
        <div class="kpi-mini kpi-line"><span>Solde mouvements</span><span class="kv">{{ '{:,.0f}'.format(solde or 0).replace(',', ' ') }} €</span></div>
      </div>
      <div class="card" data-tb-marker="AF_05">
        <div class="kpi-heading">Indicateurs</div>
        <div class="kpi-mini kpi-line"><span>Perf 52 semaines</span><span class="kv">{% if last_perf_pct_aff is not none %}{{ '%.2f'|format(last_perf_pct_aff) }} %{% else %}-{% endif %}</span></div>
        <div class="kpi-mini kpi-line"><span>Volatilité</span><span class="kv">{% if last_vol_pct_aff is not none %}{{ '%.2f'|format(last_vol_pct_aff) }} %{% else %}-{% endif %}</span></div>
        <div class="kpi-mini kpi-line"><span>SRRI contrat / calculé</span><span class="kv">{{ srri_client if srri_client is not none else '-' }} / {{ srri_calc if srri_calc is not none else '-' }}</span></div>
        <div class="kpi-mini kpi-line"><span>Perf annualisée (depuis début)</span><span class="kv">{% if overall_ann_perf_pct_aff is not none %}{{ '%.2f'|format(overall_ann_perf_pct_aff) }} %{% else %}-{% endif %}</span></div>
      </div>
    </div>
  </div>
</div>

  {# Popup de création de tâche supprimé (maintenance) #}

  <!-- bloc tâches supprimé -->
<script>
    // Tâches désactivées (maintenance) : aucun script
</script>

<!-- Accordéon Investissements -->
<div id="invSection" style="display:none;">
<div class="card" style="margin-top:12px;">
  <h3 class="chart-title">Supports financiers</h3>
  <form method="get" action="" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
    {% if af_markers_param %}<input type="hidden" name="markers" value="1" />{% endif %}
    <label class="muted">Date d'analyse :</label>
    <input type="date" name="as_of" value="{{ as_of_effective }}" style="padding:4px 8px; border:1px solid #ccc; border-radius:6px; width:auto; max-width:180px; flex:0 0 auto;" />
    <button type="submit" style="padding:4px 10px; border-radius:6px; border:1px solid var(--primary); background: var(--primary); color:#fff;">Mettre à jour</button>
    <span class="muted" style="margin-left:8px;">Vendredi suivant appliqué</span>
  </form>
  <table id="supportsTableContract" class="display nowrap" style="width:100%">
    <thead>
      <tr>
        <th>ISIN</th><th>Nom</th><th>SRRI</th>
        <th>Nb UC</th><th>VL</th><th>PRMP</th><th>Valorisation</th>
        <th>E</th><th>S</th><th>G</th>
      </tr>
    </thead>
    <tbody>
    {% for s in supports %}
    <tr class="{% if (s.prmp|float) < (s.vl|float) %}row-good{% else %}row-bad{% endif %}">
      <td>
        {% if s.code_isin %}
          <a href="#" class="aff-support-link" data-support-code="{{ s.code_isin }}" data-support-name="{{ s.nom }}" data-contract="{{ affaire.ref if affaire else '' }}" data-movements='{{ s.movements | tojson | safe }}'>{{ s.code_isin }}</a>
        {% else %}
          {{ s.code_isin }}
        {% endif %}
      </td>
      <td>{{ s.nom }}</td>
      <td style="text-align:center;">{{ s.srri_support }}</td>
      <td class="right">{{ s.nbuc }}</td>
      <td class="right">{{ s.vl }}</td>
      <td class="right">{{ s.prmp }}</td>
      <td class="right">{{ s.valo }}</td>
      <td>{{ s.noteE or '' }}</td>
      <td>{{ s.noteS or '' }}</td>
      <td>{{ s.noteG or '' }}</td>
    </tr>
    {% endfor %}
    {% if not supports %}
    <tr><td colspan="10" class="muted">Aucun support trouvé pour ce contrat.</td></tr>
    {% endif %}
    </tbody>
  </table>
  <small class="muted">Source: mariadb_historique_support_w + mariadb_support + donnees_esg_etendu</small>
  <div id="affSupportMovementsModal" class="modal-overlay" onclick="if(event.target===this) closeAffSupportMovementsModal()">
    <div class="modal-card" style="width:820px; max-width:97vw;">
      <div class="modal-header">
        <h3><i class="fa-solid fa-right-left" style="margin-right:8px;"></i><span id="affSupportMovementsLabel">Mouvements du support</span></h3>
        <button class="modal-close" onclick="closeAffSupportMovementsModal()">✕</button>
      </div>
      <div class="modal-body">
        <table id="affSupportMovementsTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left;">Date</th>
              <th style="text-align:left;">Règle</th>
              <th style="text-align:right;">Montant</th>
              <th style="text-align:right;">VL</th>
              <th style="text-align:right;">Nb parts</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="grid pie-grid" style="margin-top:12px; gap:12px;">
  <div class="card pie-card">
    <h3 class="chart-title">Répartition par catégorie</h3>
    <div class="dim-buttons" style="display:flex; gap:6px; margin-bottom:6px; flex-wrap: wrap;">
      <button type="button" class="dim-btn active" data-field="cat_gene">Catégorie générale</button>
      <button type="button" class="dim-btn" data-field="cat_principale">Catégorie principale</button>
      <button type="button" class="dim-btn" data-field="cat_det">Catégorie détaillée</button>
    </div>
    <canvas id="supportsCatChart" height="260"></canvas>
  </div>

  <div class="card pie-card">
    <h3 class="chart-title">Répartition géographique du secteur</h3>
    <canvas id="supportsGeoChart" height="260"></canvas>
  </div>
 </div>
</div>
<!-- Séparateur visuel -->
<!-- Accordéon ESG -->
<div id="esgSection" style="display:none;">
  <div class="card" style="margin-top:8px; width:100%; box-sizing:border-box; grid-column: 1 / -1;">
    <h3 class="chart-title">Comparaison ESG Affaire vs Indice</h3>
    <div style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px 0;">
      <div>
        <label class="muted" style="font-size:0.85rem;">Allocation de référence</label><br>
        <select id="esgAllocSelect" style="min-width:220px; max-width:280px; width:auto;">
          <option value="">— choisir —</option>
          {% for nm in alloc_names %}<option value="{{ nm }}">{{ nm }}</option>{% endfor %}
        </select>
      </div>
      <div style="display:none;">
        <label class="muted" style="font-size:0.85rem;">Date</label><br>
        <select id="esgAllocDate" style="width: 14ch; min-width: 14ch;"></select>
      </div>
      <div style="flex:1 1 auto; min-width:260px;">
        <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
        <div id="esgFields" style="display:flex; gap:6px; flex-wrap:wrap;">
          {% for it in esg_fields %}
            {% set col = it.col if it is mapping else it %}
            {% set label = it.label if it is mapping else it %}
            <button type="button" class="dim-btn esg-field" data-field="{{ col }}" title="{{ label }}">{{ label }}</button>
          {% endfor %}
        </div>
      </div>
      <div>
        <button id="esgRefreshBtn" class="rangeBtn" type="button" title="Actualiser">Actualiser</button>
      </div>
    </div>
    <div id="esgChart" style="height:320px; width:100%;"></div>
    <div class="muted" style="margin-top:6px; font-size:12px;">Indice normalisé à 100. Affaire = valeur relative (Affaire / Indice × 100).</div>
  </div>
</div>

<!-- Accordéon Avis d'opération (en dehors de la section Investissements) -->
<div id="avisSection" data-tb-marker="AF_13" style="display:none;">
  <div class="card" data-tb-marker="AF_14">
    <h3 class="chart-title">Avis d'opération</h3>
    <style>
      /* Largeurs et non-retour à la ligne pour tenir sur une ligne */
      #avisTable { table-layout: fixed; width: 100%; }
      #avisTable th:nth-child(1), #avisTable td:nth-child(1) { width: 12ch; white-space: nowrap; }
      #avisTable th:nth-child(2), #avisTable td:nth-child(2) { width: 40ch; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #avisTable th:nth-child(3), #avisTable td:nth-child(3) { width: 10ch; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #avisTable th:nth-child(4), #avisTable td:nth-child(4) { width: 14ch; white-space: nowrap; text-align: right; }
      #avisTable th:nth-child(5), #avisTable td:nth-child(5) { width: 14ch; white-space: nowrap; text-align: right; }
      #avisTable th:nth-child(6), #avisTable td:nth-child(6) { width: 14ch; white-space: nowrap; text-align: center; }
    </style>
    <table id="avisTable" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Date</th>
          <th>Référence</th>
          <th>Étape</th>
          <th style="text-align:right;">Entrée</th>
          <th style="text-align:right;">Sortie</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for a in avis_affaire %}
        <tr>
          <td><span class="js-local-dt" data-iso="{{ a.date }}">{{ a.date }}</span></td>
          <td>{{ a.reference or '' }}</td>
          <td>{{ a.etape or '' }}</td>
          <td style="text-align:right;">{{ a.entree_str or '' }}</td>
          <td style="text-align:right;">{{ a.sortie_str or '' }}</td>
          <td>
            <button type="button" class="btn btn-choice" title="Voir mouvement" aria-label="Voir mouvement" style="padding:2px 6px; font-size:11px; border-radius:4px;" onclick="openMovementPopup({{ affaire.id }}, {{ a.avis_id }})"><i class="fa-solid fa-eye"></i></button>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="muted">Aucun avis trouvé.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div id="graphsSection" data-tb-marker="AF_18" style="display:none;">

<div class="card" data-tb-marker="AF_19" style="margin-top:12px; padding:0;">
  <div id="graphValoToggle" class="accordion-toggle" data-target="graphValoPanel" style="margin:0; cursor:pointer; justify-content:flex-start;">
    <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
      <i class="fa-solid fa-chart-line"></i>
      <span>Evolution valorisation et cumul des mouvements</span>
      <span class="chevron" style="margin-left:4px;">▾</span>
    </h3>
  </div>
  <div id="graphValoPanel" class="accordion-panel" style="padding:12px 14px; border-top:1px solid var(--border);">
    <canvas id="chartValo" height="120"></canvas>
    <small class="muted">Courbes sans points; axes ajustés automatiquement.</small>
    <div style="margin-top:8px;">
      <button class="rangeBtn" data-range="90">3M</button>
      <button class="rangeBtn" data-range="180">6M</button>
      <button class="rangeBtn" data-range="365">1A</button>
      <button class="rangeBtn" data-range="all">Tout</button>
    </div>
  </div>
</div>

<div class="card" data-tb-marker="AF_20" style="margin-top:12px; padding:0;">
  <div id="graphPerfToggle" class="accordion-toggle" data-target="graphPerfPanel" style="margin:0; cursor:pointer; justify-content:flex-start;">
    <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
      <i class="fa-solid fa-chart-area"></i>
      <span>Performances et SRRI</span>
      <span class="chevron" style="margin-left:4px;">▾</span>
    </h3>
  </div>
  <div id="graphPerfPanel" class="accordion-panel" style="padding:12px 14px; border-top:1px solid var(--border);">
    <canvas id="chartAnnuel" height="120"></canvas>
  </div>
</div>

<div class="card" data-tb-marker="AF_21" style="margin-top:12px; padding:0;">
  <div id="graphCmpToggle" class="accordion-toggle" data-target="graphCmpPanel" style="margin:0; cursor:pointer; justify-content:flex-start;">
    <h3 style="margin:0; display:flex; align-items:center; gap:8px;">
      <i class="fa-solid fa-chart-pie"></i>
      <span>Comparatif investissements vs Offre produit</span>
      <span class="chevron" style="margin-left:4px;">▾</span>
    </h3>
  </div>
  <div id="graphCmpPanel" class="accordion-panel" style="padding:12px 14px; border-top:1px solid var(--border);">
    <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; margin:6px 0 8px 0;">
      <div>
        <label>Offres financières à comparer</label><br>
        <select id="allocSelect" style="min-width:200px; max-width:260px; width:auto;"></select>
      </div>
      <div>
        <label class="muted" style="font-size:0.85rem;">Période</label><br>
        <button class="rangeBtnCmp" data-range="all">Tout</button>
        <button class="rangeBtnCmp" data-range="365">1 an</button>
        <button class="rangeBtnCmp" data-range="180">6 mois</button>
        <button class="rangeBtnCmp" data-range="90">3 mois</button>
        <button class="rangeBtnCmp" data-range="30">1 mois</button>
      </div>
    </div>
    <canvas id="chartSicav" height="120" style="margin-top:8px;"></canvas>
  </div>
</div>

<!-- (sections supports & répartitions remontées plus haut) -->
</div>

<!-- Reportings pluriannuels (accordéon pleine largeur) -->
<div id="reportSection" data-tb-marker="AF_23" style="width:100%; grid-column: 1 / -1;">
  <div class="card" data-tb-marker="AF_24" style="margin-top:8px;">
    {% if reporting_years %}
    <table style="font-size:12px;">
      <thead>
        <tr>
          <th>Année</th>
          <th style="text-align:right;">Versements</th>
          <th style="text-align:right;">Retraits</th>
          <th style="text-align:right;">Solde annuel</th>
          <th style="text-align:right;">Solde cumulé</th>
          <th style="text-align:right;">Valo fin d'année</th>
          <th style="text-align:right;">Perf fin d'année</th>
          <th style="text-align:right;">Cumul perf</th>
          <th style="text-align:right;">Perf annualisée</th>
          <th style="text-align:right;">Vol. 52s (fin)</th>
          <th style="text-align:right;">Vol. moyenne</th>
        </tr>
      </thead>
      <tbody>
        {% for r in reporting_years %}
        <tr>
          <td style="text-align:center;">{{ r.year }}</td>
          <td style="text-align:right;">{{ r.versements_str }}</td>
          <td style="text-align:right;">{{ r.retraits_str }}</td>
          <td style="text-align:right;">{{ r.solde_str }}</td>
          <td style="text-align:right;">{{ r.solde_cum_str }}</td>
          <td style="text-align:right;">{{ r.last_valo_str }}</td>
          <td style="text-align:right;">{% if r.last_perf_pct is not none %}{{ '%.2f'|format(r.last_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.cum_perf_pct is not none %}{{ '%.2f'|format(r.cum_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.ann_perf_pct is not none %}{{ '%.2f'|format(r.ann_perf_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.last_vol_pct is not none %}{{ '%.2f'|format(r.last_vol_pct) }} %{% endif %}</td>
          <td style="text-align:right;">{% if r.avg_vol_pct is not none %}{{ '%.2f'|format(r.avg_vol_pct) }} %{% endif %}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="muted" style="margin-top:6px; font-size:12px;">
      <div>Les pourcentages sont exprimés en % (valeurs décimales converties).</div>
      <div>La performance annualisée correspond à la performance cumulée observée à la date, ramenée en taux annuel fixe (CAGR).</div>
    </div>
    {% else %}
      <div class="muted">Aucune donnée annuelle disponible.</div>
    {% endif %}
  </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js: couleur par défaut (axes/labels) = bleu CSS
try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
const AF_MARKERS_PARAM = "{{ af_markers_param }}";
function appendMarkers(url){
  if (!AF_MARKERS_PARAM) return url;
  if (url.indexOf('markers=') !== -1) return url;
  return url + (url.indexOf('?') >= 0 ? '&' : '?') + AF_MARKERS_PARAM;
}
function openAffTaskPage(){
  var params = new URLSearchParams();
  var fullname = '{{ (client_nom or "") ~ " " ~ (client_prenom or "") }}'.trim();
  if (fullname) params.set('client_fullname', fullname);
  var aref = '{{ affaire.ref if affaire and affaire.ref else "" }}';
  if (aref) params.set('affaire_ref', aref);
  var rhId = '{{ client_rh_id if client_rh_id is not none else "" }}';
  if (rhId) params.set('rh_id', rhId);
  if (AF_MARKERS_PARAM){ params.set('markers', '1'); }
  var url = '/dashboard/taches' + (params.toString() ? ('?' + params.toString()) : '');
  window.open(url, '_blank', 'noopener');
}
// Messages header buttons & modal (Affaire)
const AFF_EVENTS_OPEN = {{ affaire_events_open | tojson }};
function _normCatAff(s){ if(!s) return ''; return (s+'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replaceAll('ç','c').replaceAll('Ç','c'); }
function openAffMsgs(kind){
  const modal = document.getElementById('affMsgsModal');
  const tbody = modal.querySelector('tbody');
  tbody.innerHTML = '';
  const isReg = (kind === 'reg');
  const title = document.getElementById('affMsgsTitle');
  title.innerHTML = (isReg ? '<i class="fa-solid fa-envelope"></i>Messages réglementaires' : '<i class="fa-solid fa-envelope"></i>Messages non réglementaires');
  const rows = (AFF_EVENTS_OPEN||[]).filter(ev => {
    const cat = _normCatAff(ev.type_categorie);
    const reg = (cat === 'reglementaire');
    return isReg ? reg : !reg;
  });
  function statusStyle(label){
    const s = (label||'').toLowerCase();
    if (s === 'en cours') return 'background:#16a34a; color:#fff; border-color:#16a34a;';
    if (s === 'en attente') return 'background:#f59e0b; color:#fff; border-color:#f59e0b;';
    if (s === 'terminé' || s === 'termine') return 'background:#4b5563; color:#fff; border-color:#4b5563;';
    if (s === 'annulé' || s === 'annule') return 'background:#b91c1c; color:#fff; border-color:#b91c1c;';
    return '';
  }
  function openTaskEditPopup(id){
    try {
      var w = 1100, h = 800;
      var left = Math.max(0, Math.floor(((screen.availWidth||screen.width||w) - w) / 2));
      var top = Math.max(0, Math.floor(((screen.availHeight||screen.height||h) - h) / 2));
      var feat = 'scrollbars=yes,resizable=yes' + ',width=' + w + ',height=' + h + ',left=' + left + ',top=' + top;
      var win = window.open(appendMarkers('/dashboard/taches/'+id), 'taskEdit'+id, feat);
      if (win && win.focus) { try { win.focus(); } catch(e){} }
    } catch(e){}
  }
  rows.forEach(ev => {
    const evId = ev.id_resolved ?? ev.id ?? ev.evenement_id ?? ev.event_id ?? ev.evenementId ?? ev.eventId;
    const tr = document.createElement('tr');
    function td(v){ const td = document.createElement('td'); td.textContent = v==null?'':v; return td; }
    function tdEl(el){ const td = document.createElement('td'); td.appendChild(el); return td; }
    tr.appendChild(td(ev.date_evenement||''));
    tr.appendChild(td(ev.type_libelle||''));
    tr.appendChild(td(ev.type_categorie||''));
    // Statut cliquable vers la page d'édition (nouvel onglet)
    const sb = document.createElement('a');
    sb.className = 'btn btn-choice';
    sb.textContent = ev.statut || 'à faire';
    sb.style.cssText = 'padding:2px 6px; font-size:11px; border-radius:4px; ' + statusStyle(ev.statut||'');
    if (evId){
      sb.href = appendMarkers('/dashboard/taches/' + ev.id);
      sb.target = '_blank';
      sb.rel = 'noopener noreferrer';
    } else {
      sb.href = '#';
      sb.title = 'Tâche sans identifiant';
      sb.style.opacity = '0.6';
      sb.style.pointerEvents = 'none';
    }
    const statTd = document.createElement('td'); statTd.appendChild(sb);
    // RH badge si présent
    var rh = ev.rh_nom || ev.rh || ev.rhnom;
    if (rh){ const b = document.createElement('span'); b.className='badge'; b.textContent = 'RH: ' + rh; b.style.marginLeft='6px'; statTd.appendChild(b); }
    if (ev.statut_reclamation_label){
      const rec = document.createElement('div');
      rec.className = 'muted';
      rec.style.fontSize = '0.75rem';
      rec.style.marginTop = '2px';
      rec.textContent = 'Réclamation : ' + ev.statut_reclamation_label;
      statTd.appendChild(rec);
    }
    tr.appendChild(statTd);
    // Commentaire tronqué avec Voir plus/moins
    const ctd = document.createElement('td');
    const full = String(ev.commentaire||'');
    const short = full.slice(0, 180);
    const sid = 'caff-short-' + (evId||Math.random());
    const fid = 'caff-full-' + (evId||Math.random());
    const sdiv = document.createElement('div'); sdiv.id=sid; sdiv.style.whiteSpace='pre-wrap'; if (full.length <= 180) sdiv.style.display='none'; sdiv.textContent = short + (full.length>180 ? '…' : '');
    const fdiv = document.createElement('div'); fdiv.id=fid; fdiv.style.whiteSpace='pre-wrap'; if (full.length > 180) fdiv.style.display='none'; fdiv.textContent = full;
    ctd.appendChild(sdiv); ctd.appendChild(fdiv);
    if (full.length > 180){ const a=document.createElement('a'); a.href='#'; a.style.fontSize='12px'; a.textContent='Voir plus'; a.addEventListener('click', function(e){ e.preventDefault(); const sh=document.getElementById(sid); const fl=document.getElementById(fid); const isShort=sh.style.display!=='none'; sh.style.display=isShort?'none':''; fl.style.display=isShort?'':'none'; this.textContent=isShort?'Voir moins':'Voir plus'; }); const wrap=document.createElement('div'); wrap.appendChild(a); ctd.appendChild(wrap);}    
    tr.appendChild(ctd);
    // Action
    const actionTd = document.createElement('td');
    const idRawTd = document.createElement('td');
    idRawTd.textContent = (ev && ev.id != null && ev.id !== '') ? ev.id : '—';
    const idAltTd = document.createElement('td');
    idAltTd.textContent = (ev && ev.evenement_id != null && ev.evenement_id !== '') ? ev.evenement_id : '—';
    tr.appendChild(idRawTd);
    tr.appendChild(idAltTd);
    if (evId){
      const editLink = document.createElement('a');
      editLink.className='btn btn-choice';
      editLink.style.cssText='padding:2px 6px; font-size:11px; border-radius:4px;';
      editLink.textContent = 'Modifier';
      editLink.href = appendMarkers('/dashboard/taches/' + evId);
      editLink.target = '_blank';
      editLink.rel = 'noopener noreferrer';
      editLink.addEventListener('click', function(e){ e.stopPropagation(); });
      actionTd.appendChild(editLink);
    } else {
      actionTd.textContent = '—';
      actionTd.style.textAlign = 'center';
    }
    tr.appendChild(actionTd);
    tr.addEventListener('dblclick', function(){ if(evId){ openTaskEditPopup(evId); } });
    tbody.appendChild(tr);
  });
  // DataTable + export CSV (Buttons déjà chargés sur cette page)
  try { if (window.affMsgsDT) { window.affMsgsDT.destroy(); } } catch(e) {}
  try {
    window.affMsgsDT = $('#affMsgsTable').DataTable({
      destroy: true,
      paging: true,
      pageLength: 25,
      dom: 'Bfrtip',
      buttons: [ { extend: 'csvHtml5', text: 'Exporter CSV', title: 'messages_affaire_{{ affaire.id }}', bom: true, charset: 'utf-8', fieldSeparator: ';' } ],
      order: [[0,'desc']],
      columnDefs: [ { targets: [0,1,2,4], className: 'nowrap' } ]
    });
  } catch(e) {}
  // Avis d'opération: activer DataTable + export CSV (UTF-8 BOM)
  try {
    $('#avisTable').DataTable({
      destroy: true,
      paging: true,
      pageLength: 25,
      dom: 'Bfrtip',
      buttons: [ { extend: 'csvHtml5', text: 'Exporter CSV', title: 'avis_affaire_{{ affaire.id }}', bom: true, charset: 'utf-8', fieldSeparator: ';' } ],
      order: [[0,'desc']],
      columnDefs: [ { targets: [3,4], className: 'right' } ]
    });
  } catch(e) {}
  modal.style.display = 'flex';
}
function closeAffMsgs(){ document.getElementById('affMsgsModal').style.display = 'none'; }
</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
  function openAffSupportMovementsModal(code, name, contractLabel, movements){
    const modal = document.getElementById('affSupportMovementsModal');
    if (!modal) return;
    const tbody = modal.querySelector('#affSupportMovementsTable tbody');
    const labelEl = document.getElementById('affSupportMovementsLabel');
    if (labelEl){
      const parts = ['Mouvements du support'];
      const detail = [contractLabel, name, code].filter(Boolean).join(' • ');
      if (detail) parts.push(detail);
      labelEl.textContent = parts.join(' — ');
    }
    if (tbody){
      tbody.innerHTML = '';
      const rows = Array.isArray(movements) ? movements : [];
      rows.forEach(function(mv){
        const tr = document.createElement('tr');
        [
          { value: mv.date || '-' },
          { value: mv.regle || '-' },
          { value: mv.montant || '-', align: 'right' },
          { value: mv.vl || '-', align: 'right' },
          { value: mv.nb_uc || '-', align: 'right' },
        ].forEach(function(col){
          const td = document.createElement('td');
          td.textContent = col.value;
          if (col.align === 'right') td.style.textAlign = 'right';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      if (!rows.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.className = 'muted';
        td.textContent = 'Aucun mouvement trouvé pour ce support.';
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }
    modal.style.display = 'flex';
  }
  function closeAffSupportMovementsModal(){ const modal = document.getElementById('affSupportMovementsModal'); if (modal) modal.style.display = 'none'; }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.aff-support-link').forEach(function(link){
      link.addEventListener('click', function(ev){
        ev.preventDefault();
        let movements = [];
        try {
          movements = this.dataset.movements ? JSON.parse(this.dataset.movements) : [];
        } catch (e) {
          console.warn('aff-support movements parse error', e);
        }
        openAffSupportMovementsModal(
          this.dataset.supportCode || '',
          this.dataset.supportName || '',
          this.dataset.contract || '',
          movements
        );
      });
    });
  });

  // SRRI modal
  function openAffRiskModal(){
    const m = document.getElementById('affRiskModal');
    if (!m) return;
    m.style.display = 'flex';
    markAffToggleActive('riskToggle');
  }
  function closeAffRiskModal(){
    const m = document.getElementById('affRiskModal');
    if (!m) return;
    m.style.display = 'none';
  }
  window.openAffRiskModal = openAffRiskModal;
  window.closeAffRiskModal = closeAffRiskModal;

  function markAffToggleActive(id){
    try{
      document.querySelectorAll('.section-toggle-row .accordion-toggle').forEach(function(btn){
        btn.classList.toggle('active', btn.id === id);
      });
    }catch(e){}
  }

  // Accordéon Synthèse (affaire) pour les 3 blocs KPI
  (function(){
    var t = document.getElementById('affSynthToggle');
    var p = document.getElementById('affSynthPanel');
    if (!t || !p) return;
    function set(open){
      p.style.display = open ? '' : 'none';
      if (!open) t.classList.add('collapsed'); else t.classList.remove('collapsed');
    }
    set(false);
    t.addEventListener('click', function(){
      var isOpen = p.style.display !== 'none';
      set(!isOpen);
    });
  })();

  // Accordéons pour les graphiques (valorisation, perf, comparatif)
  (function(){
    const accs = [
      {t:'graphValoToggle', p:'graphValoPanel'},
      {t:'graphPerfToggle', p:'graphPerfPanel'},
      {t:'graphCmpToggle', p:'graphCmpPanel'},
    ];
    accs.forEach(({t,p})=>{
      const toggle = document.getElementById(t);
      const panel = document.getElementById(p);
      if (!toggle || !panel) return;
      function set(open){
        panel.style.display = open ? '' : 'none';
        toggle.classList.toggle('collapsed', !open);
      }
      // ouverture par défaut
      set(true);
      toggle.addEventListener('click', ()=> set(panel.style.display === 'none'));
    });
  })();

  // Accordéons mutualisés: un seul ouvert, possibilité de tout fermer; scroll en haut à l'ouverture
  (function(){
    var groups = [
      { key:'inv', toggleId:'invToggle', sectionId:'invSection' },
      { key:'esg', toggleId:'esgToggle', sectionId:'esgSection' },
      { key:'graphs', toggleId:'graphsToggle', sectionId:'graphsSection' },
      { key:'report', toggleId:'reportToggle', sectionId:'reportSection' },
    ];
    function byId(id){ return document.getElementById(id); }
    var available = groups.filter(function(g){ return byId(g.toggleId) && byId(g.sectionId); });
    function firstAvailableKey(){ return available.length ? available[0].key : ''; }
    function setOpen(targetKey){
      var exists = available.some(function(g){ return g.key === targetKey; });
      if (targetKey && !exists) { targetKey = firstAvailableKey(); }
      groups.forEach(function(g){
        var t = byId(g.toggleId), s = byId(g.sectionId);
        if (!t || !s) return;
        if (targetKey && g.key === targetKey){ s.style.display = ''; t.classList.remove('collapsed'); markAffToggleActive(g.toggleId); }
        else { s.style.display = 'none'; t.classList.add('collapsed'); if (targetKey) {} }
      });
      try { localStorage.setItem('aff_detail_open', targetKey || ''); } catch(e) {}
    }
    // Init: restaurer la dernière ouverte si possible
    var saved = ''; try { saved = localStorage.getItem('aff_detail_open') || ''; } catch(e) {}
    if (saved) { setOpen(saved); }
    else { setOpen(firstAvailableKey()); markAffToggleActive(firstAvailableKey()); }
    // Bind clicks
    groups.forEach(function(g){
      var t = byId(g.toggleId), s = byId(g.sectionId);
      if (!t || !s) return;
      t.addEventListener('click', function(){
        var isOpen = s.style.display !== 'none';
        if (isOpen) { setOpen(''); }
        else { setOpen(g.key); try { t.scrollIntoView({ behavior:'smooth', block:'start' }); } catch(e) {} }
      });
    });
  })();

  // Persist preferred as_of in localStorage and preselect
  (function(){
    var sel = document.querySelector('select[name="as_of"]');
    if (!sel) return;
    var asOfInput = {{ as_of_input | tojson }};
    try {
      var stored = localStorage.getItem('as_of_selected');
      if (!asOfInput && stored) {
        for (var i=0;i<sel.options.length;i++){ if (sel.options[i].value === stored){ sel.selectedIndex = i; break; } }
      }
      sel.form && sel.form.addEventListener('submit', function(){
        try { localStorage.setItem('as_of_selected', sel.value); } catch(e) {}
      });
    } catch(e) {}
  })();

  const labels = {{ labels | tojson }};
  const valo = {{ serie_valo | tojson }};
  const cum = {{ serie_cum_mouv | tojson }};
  const years = {{ years | tojson }};
  const annPerf = {{ ann_perf | tojson }};
  const annVol = {{ ann_vol | tojson }};
  const allocSeries = {{ alloc_series | tojson }};
  const defaultAlloc = {{ default_alloc_name | tojson }};
  const affaireSicav = {{ affaire_sicav | tojson }};
  const supportsData = {{ supports | tojson }};
  const esgFieldLabels = {{ esg_field_labels | tojson }};
  // --- ESG (Plotly horizontal bar, indice=100 vs affaire) ---
  (function(){
    // Load Plotly
    var plotlyLoaded = !!window.Plotly;
    function ensurePlotly(cb){
      if (plotlyLoaded) { cb(); return; }
      var s = document.createElement('script'); s.src='https://cdn.plot.ly/plotly-2.32.0.min.js'; s.onload=function(){ plotlyLoaded=true; cb(); }; document.head.appendChild(s);
    }
    var allocSel = document.getElementById('esgAllocSelect');
    var allocDateSel = document.getElementById('esgAllocDate');
    var allocIsinInput = document.getElementById('esgAllocIsin');
    var asOfInput = document.querySelector('input[name="as_of"]');
    var fieldsWrap = document.getElementById('esgFields');
    var refreshBtn = document.getElementById('esgRefreshBtn');

    // Persist preferences (allocation + champs ESG) par affaire
    var keyAlloc = 'esg_alloc_{{ affaire.id }}';
    var keyFields = 'esg_fields_{{ affaire.id }}';
    var keyAllocDate = 'esg_alloc_date_{{ affaire.id }}';
    if (!allocSel || !fieldsWrap) return;
    function selectedFields(){ return Array.from(fieldsWrap.querySelectorAll('.esg-field.active')).map(b=> b.getAttribute('data-field')); }
    function updateSelection(btn){
      var sel = selectedFields();
      if (btn){
        if (btn.classList.contains('active')){ btn.classList.remove('active'); }
        else {
          if (sel.length >= 4) return; // max 4
          btn.classList.add('active');
        }
      }
    }
    fieldsWrap.addEventListener('click', function(e){
      var b=e.target.closest('.esg-field'); if(!b) return;
      updateSelection(b);
      try{ localStorage.setItem(keyFields, JSON.stringify(selectedFields())); }catch(_e){}
      drawESG();
    });
    function drawESG(){
      var fields = selectedFields();
      var alloc = allocSel.value || '';
      var allocDate = allocDateSel && allocDateSel.value ? allocDateSel.value : '';
      var allocIsin = (allocIsinInput && allocIsinInput.value) ? allocIsinInput.value.trim() : '';
      var asOf = (asOfInput && asOfInput.value) ? asOfInput.value : '';
      if (!fields.length || !alloc){ return; }
      ensurePlotly(function(){
        var url = `/dashboard/affaires/{{ affaire.id }}/esg?alloc=${encodeURIComponent(alloc)}&fields=${encodeURIComponent(fields.join(','))}` +
                  (allocDate?`&alloc_date=${encodeURIComponent(allocDate)}`:'') + (asOf?`&as_of=${encodeURIComponent(asOf)}`:'') + (allocIsin?`&alloc_isin=${encodeURIComponent(allocIsin)}`:'');
        url = appendMarkers(url);
        fetch(url).then(function(r){
          if (!r.ok){ throw new Error('HTTP ' + r.status + ' for ' + url); }
          return r.json();
        }).then(function(data){
          var rows = (data && data.results) || [];
          var cats = rows.map(r=> r.field);
          var idx = rows.map(r=> (r.index==null? null : Number(r.index)));
          var aff = rows.map(r=> (r.affaire==null? null : Number(r.affaire)));
          try {
            console.log('ESG affaire plot data', {
              url: url,
              alloc: alloc,
              allocDate: allocDate,
              allocIsin: allocIsin,
              asOf: asOf,
              fields: fields,
              categories: cats,
              indexValues: idx,
              affaireValues: aff
            });
          } catch(_){}
          var traces = [
            { x: idx, y: cats, type:'bar', orientation:'h', name:'Indice', marker:{ color:'#9ca3af' } },
            { x: aff, y: cats, type:'bar', orientation:'h', name:'Affaire', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
          ];
          var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
          var cfg = { displayModeBar: false, responsive: true };
          Plotly.react('esgChart', traces, layout, cfg);
        }).catch(function(err){ try { console.error('ESG fetch error', err); } catch(_) {} });
      });
    }
    function loadAllocDates(preferred){
      if (!allocSel || !allocSel.value) { if (allocDateSel) allocDateSel.innerHTML=''; return; }
      fetch(`/dashboard/allocations/dates?name=${encodeURIComponent(allocSel.value)}`)
        .then(r=>r.json()).then(function(data){
          if (!allocDateSel) return;
          allocDateSel.innerHTML = '';
          var ds = (data && data.dates) || [];
          ds.forEach(function(d,i){ var o=document.createElement('option'); o.value=d; o.textContent=d; allocDateSel.appendChild(o); });
          // présélectionner la date mémorisée si disponible, sinon la plus récente
          var selected = false;
          if (preferred){
            for (var i=0;i<allocDateSel.options.length;i++){
              if (allocDateSel.options[i].value === preferred){ allocDateSel.selectedIndex = i; selected = true; break; }
            }
          }
          if (!selected && allocDateSel.options.length>0) allocDateSel.selectedIndex = 0;
          drawESG();
        }).catch(function(e){ try{ console.error('alloc dates', e);}catch(_){} });
    }
    // Sauvegarde des préférences sur changements
    allocSel.addEventListener('change', function(){
      try{ localStorage.setItem(keyAlloc, allocSel.value||''); }catch(_e){}
      // reset stored date when allocation changes
      try{ localStorage.removeItem(keyAllocDate); }catch(_e){}
      loadAllocDates();
    });
    if (allocDateSel) allocDateSel.addEventListener('change', function(){
      try{ localStorage.setItem(keyAllocDate, allocDateSel.value||''); }catch(_e){}
      drawESG();
    });
    if (refreshBtn) refreshBtn.addEventListener('click', drawESG);

    // Initialisation: restaurer préférences pour éviter une page vide
    (function initESGDefaults(){
      if (!allocSel || !fieldsWrap) return;
      // Allocation: restaurer ou choisir la première valeur réelle
      try{
        var savedAlloc = localStorage.getItem(keyAlloc) || '';
        if (savedAlloc){
          // si l'option existe encore
          var found = false;
          for (var i=0;i<allocSel.options.length;i++){
            if (allocSel.options[i].value === savedAlloc){ allocSel.selectedIndex = i; found = true; break; }
          }
          if (!found){ savedAlloc = ''; }
        }
        if (!savedAlloc){
          // sélectionner la première option non vide si disponible
          for (var j=0;j<allocSel.options.length;j++){
            if (allocSel.options[j].value){ allocSel.selectedIndex = j; savedAlloc = allocSel.options[j].value; break; }
          }
          if (savedAlloc){ try{ localStorage.setItem(keyAlloc, savedAlloc); }catch(_e){} }
        }
      }catch(_e){}

      // Champs ESG: restaurer ou activer des valeurs par défaut (jusqu'à 3)
      try{
        var raw = localStorage.getItem(keyFields);
        var savedFields = [];
        if (raw){ try{ savedFields = JSON.parse(raw) || []; }catch(_ee){ savedFields=[]; } }
        var buttons = Array.from(fieldsWrap.querySelectorAll('.esg-field'));
        // reset all
        buttons.forEach(function(b){ b.classList.remove('active'); });
        if (savedFields && savedFields.length){
          buttons.forEach(function(b){ var v=b.getAttribute('data-field'); if (savedFields.indexOf(v)>=0) b.classList.add('active'); });
        } else {
          // activer les 3 premiers par défaut si existants
          buttons.slice(0,3).forEach(function(b){ b.classList.add('active'); });
          try{ localStorage.setItem(keyFields, JSON.stringify(buttons.slice(0,3).map(function(b){return b.getAttribute('data-field');}))); }catch(_e){}
        }
      }catch(_e){}

      // Charger dates pour l'allocation sélectionnée et restaurer la date si possible
      var preferDate = '';
      try{ preferDate = localStorage.getItem(keyAllocDate) || ''; }catch(_e){}
      if (allocSel && allocSel.value){ loadAllocDates(preferDate); }
      else { drawESG(); }
    })();
  })();
  const primaryColor = (getComputedStyle(document.documentElement).getPropertyValue('--primary')||'').trim() || '#2456a6';

  // Chart 1: valo vs cumul mouvements (remplissage vert/rouge, axe X annuel)
  const ctx1 = document.getElementById('chartValo').getContext('2d');
  let chart1;
  function drawChart1(L, V, C) {
    if (chart1) chart1.destroy();
    const parsedDates = L.map(d => new Date(d));
    const yearAt = (idx) => {
      const d = parsedDates[idx];
      return (d && !isNaN(d.getTime())) ? d.getFullYear() : null;
    };
    const allMin = Math.min(...V, ...C);
    const allMax = Math.max(...V, ...C);
    const margin = (allMax - allMin) * 0.1 || 1;
    chart1 = new Chart(ctx1, {
      type: 'line',
      data: { labels: L, datasets: [
        {
          label: 'Valorisation',
          data: V,
          borderColor: primaryColor,
          backgroundColor: (ctx) => {
            const i = ctx.dataIndex || 0;
            const v = V[i] || 0;
            const m = C[i] || 0;
            return v >= m ? 'rgba(34, 197, 94, 0.16)' : 'rgba(239, 68, 68, 0.16)';
          },
          fill: { target: 1 },
          pointRadius: 0,
          pointHoverRadius: 0
        },
        {
          label: 'Cumul mouvements',
          data: C,
          borderColor: '#ff6b6b',
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 0
        },
      ]},
      options: {
        responsive:true,
        interaction:{mode:'index', intersect:false},
        stacked:false,
        scales: {
          x: {
            ticks: {
              autoSkip: false,
              maxRotation: 0,
              callback: (val, idx) => {
                const y = yearAt(idx);
                const prev = yearAt(idx - 1);
                return y && y !== prev ? String(y) : '';
              }
            },
            grid: {
              color: (ctx) => {
                const y = yearAt(ctx.index);
                const prev = yearAt(ctx.index - 1);
                return y && y !== prev ? 'rgba(0,0,0,0.35)' : 'rgba(0,0,0,0.08)';
              },
              lineWidth: (ctx) => {
                const y = yearAt(ctx.index);
                const prev = yearAt(ctx.index - 1);
                return y && y !== prev ? 2 : 0.5;
              }
            }
          },
          y: {
            type:'linear',
            position:'left',
            suggestedMin: allMin - margin,
            suggestedMax: allMax + margin,
            ticks:{ callback:v=> v.toLocaleString('fr-FR')+' €' },
            border:{ color: primaryColor },
            title:{ display:true, text:'Valorisation / Cumul mouvements', color: primaryColor }
          }
        },
        plugins:{
          legend:{ display:true },
          tooltip:{
            callbacks:{
              label: function(ctx){
                const y = ctx.parsed.y;
                const idx = ctx.dataIndex;
                if (ctx.dataset.label === 'Cumul mouvements'){
                  return ctx.dataset.label+': '+y.toLocaleString('fr-FR')+' €';
                }
                const diff = (V[idx] || 0) - (C[idx] || 0);
                const tag = diff >= 0 ? 'Gain' : 'Perte';
                return [ctx.dataset.label+': '+y.toLocaleString('fr-FR')+' €', tag+': '+Math.abs(diff).toLocaleString('fr-FR')+' €'];
              }
            }
          }
        }
      }
    });
  }
  function applyRange1(r){
    if (r==='all') { drawChart1(labels, valo, cum); return; }
    const n = parseInt(r,10); const end = labels.length; const start = Math.max(0, end - n);
    drawChart1(labels.slice(start), valo.slice(start), cum.slice(start));
  }
  drawChart1(labels, valo, cum);
  document.querySelectorAll('.rangeBtn').forEach(b=> b.addEventListener('click', ()=> applyRange1(b.dataset.range)));

  // Chart 2: annual performance (bars) vs SRRI (line) with dual axes
  const ctx2 = document.getElementById('chartAnnuel').getContext('2d');
  const annPerfPct = (annPerf||[]).map(v=> { let n=parseFloat(v); if (!isFinite(n)) n=0; if (Math.abs(n)<=1) n*=100; return +n.toFixed(2); });
  function normalizeVolDecimal(v){
    if (typeof v === 'string') {
      v = v.replace(',', '.');
    }
    let n = parseFloat(v);
    if (!isFinite(n)) return null;
    if (Math.abs(n) > 1) n = n / 100;
    return n;
  }
  function srriFromVol(volDecimal){
    if (volDecimal === null) return null;
    const vol = Math.abs(volDecimal);
    const buckets = [
      { min: 0, max: 0.005, base: 1 },
      { min: 0.005, max: 0.02, base: 2 },
      { min: 0.02, max: 0.05, base: 3 },
      { min: 0.05, max: 0.10, base: 4 },
      { min: 0.10, max: 0.15, base: 5 },
      { min: 0.15, max: 0.25, base: 6 },
      { min: 0.25, max: Infinity, base: 8 }
    ];
    for (let i = 0; i < buckets.length; i++){
      const bucket = buckets[i];
      if (vol < bucket.max || bucket.max === Infinity){
        if (bucket.max === Infinity || bucket.max <= bucket.min){
          return bucket.base;
        }
        const span = bucket.max - bucket.min;
        if (span <= 0) return bucket.base;
        const ratio = Math.min(Math.max((vol - bucket.min) / span, 0), 0.99);
        if (!isFinite(ratio)) return bucket.base;
        const value = bucket.base + ratio;
        if (!isFinite(value)) return bucket.base;
        return +Math.min(value, 8).toFixed(2);
      }
    }
    return null;
  }
  const annSrri = (annVol||[]).map(v=> srriFromVol(normalizeVolDecimal(v)));
  const srriHighlightPlugin = {
    id: 'srriHighlight',
    beforeDraw(chart){
      const yAxis = chart.scales.y2;
      const area = chart.chartArea;
      if (!yAxis || !area) return;
      const ctx = chart.ctx;
      const clientSrri = {{ srri_client if srri_client is not none else 'null' }};
      if (clientSrri === null) return;
      const ranges = [];
      const srriFloat = Number(clientSrri);
      if (Number.isFinite(srriFloat)) {
        const upper = Math.min(srriFloat + 1, 8);
        ranges.push({ from: srriFloat, to: srriFloat });
        if (upper > srriFloat) {
          ranges.push({ from: srriFloat, to: upper });
        }
      }
      const fillColor = 'rgba(255, 107, 107, 0.15)';
      ctx.save();
      ctx.fillStyle = fillColor;
      ranges.forEach(range => {
        const yTop = yAxis.getPixelForValue(range.to);
        const yBottom = yAxis.getPixelForValue(range.from);
        if (!Number.isFinite(yTop) || !Number.isFinite(yBottom)) return;
        const top = Math.min(yTop, yBottom);
        const height = Math.abs(yBottom - yTop) || 2;
        ctx.fillRect(area.left, top, area.right - area.left, height);
      });
      ctx.restore();
    }
  };
  let ann = null;
  try{
    ann = new Chart(ctx2, {
      type: 'bar',
      plugins: [srriHighlightPlugin, {
        id: 'perfLabels',
        afterDatasetsDraw(chart){
          const { ctx, data } = chart;
          const meta = chart.getDatasetMeta(0); // perf dataset index 0
          if (!meta || !meta.data) return;
          ctx.save();
          ctx.fillStyle = primaryColor;
          ctx.font = '12px sans-serif';
          meta.data.forEach((bar, idx)=>{
            const value = data.datasets[0].data[idx];
            if (value === null || typeof value === 'undefined') return;
            const label = Number(value).toFixed(2)+' %';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(label, bar.x, bar.y - 4);
          });
          ctx.restore();
        }
      }],
      data: { labels: (years||[]).map(String), datasets: [
        { type: 'bar', label: 'Perf annuelle (%)', data: annPerfPct, borderColor: primaryColor, backgroundColor: 'rgba(37, 99, 235, 0.35)', borderWidth: 1, yAxisID: 'y' },
        { type: 'line', label: 'SRRI', data: annSrri, borderColor: '#ff6b6b', backgroundColor: '#ff6b6b', fill: false, tension: 0.25, pointRadius: 4, pointHoverRadius: 5, yAxisID: 'y2' },
      ]},
      options: { responsive:true, interaction:{ mode:'index', intersect:false }, scales:{
          y:{ position:'left', ticks:{ callback:v=> v+' %' } },
          y2:{ position:'right', min:1, max:8, ticks:{ stepSize:1, callback:v=> v, color:'#ff6b6b' }, grid:{ drawOnChartArea:false }, border:{ color:'#ff6b6b' }, title:{ display:true, text:'SRRI', color:'#ff6b6b' } }
        }, plugins:{ legend:{ display:true }, datalabels:{ anchor:'end', align:'end', color:(ctx)=> ctx.dataset && ctx.dataset.yAxisID==='y2' ? '#ff6b6b' : primaryColor, formatter:(value, ctx)=> {
            if (value === null || typeof value === 'undefined') return '';
            if (ctx.dataset && ctx.dataset.yAxisID === 'y2') {
              const num = Number(value);
              if (!isFinite(num)) return '';
              return num.toFixed(2);
            }
            const numVal = Number(value);
            if (!isFinite(numVal)) return '';
            return numVal.toFixed(2)+' %';
          }, font:{ size:10 } } } }
    });
  } catch(err){
    console.error('Affaire SRRI chart error', err);
  }

  // Chart 3: SICAV comparatif (aligné sur dates de l'affaire)
  const ctx3 = document.getElementById('chartSicav').getContext('2d');
  const colors = ['#ff6b6b']; // allocations en rouge
  let chart3;
  let currentRange3 = 'all';
  function filterRangeByDays(list, range){
    if (range === 'all') return list;
    const n = parseInt(range, 10);
    if (!isFinite(n) || !list.length) return list;
    const last = list[list.length - 1];
    const lastDate = new Date(last);
    if (isNaN(lastDate)) return list;
    const cutoff = new Date(lastDate.getTime() - n * 24 * 3600 * 1000);
    return list.filter(d => {
      const dt = new Date(d);
      if (isNaN(dt)) return false;
      return dt >= cutoff;
    });
  }
  function drawChart3(selected){
    if (chart3) chart3.destroy();
    const affMap = new Map((affaireSicav||[]).map(p=> [p.date, parseFloat(p.sicav)]));
    const affKeys = new Set(Array.from(affMap.keys()));
    // Dates présentes dans toutes les allocations (union)
    const allAllocDates = new Set();
    Object.values(allocSeries||{}).forEach(arr => (arr||[]).forEach(p => { if (p && p.date) allAllocDates.add(p.date); }));
    function intersect(a,b){ const res=new Set(); a.forEach(v=>{ if(b.has(v)) res.add(v); }); return res; }
    let allowed;
    const sel = selected||[];
    if (sel.length > 0) {
      // Intersection des dates de l'affaire avec les dates de chaque allocation sélectionnée
      allowed = new Set(affKeys);
      sel.forEach(name => {
        const s = new Set(((allocSeries&&allocSeries[name])||[]).map(p=> p.date));
        allowed = intersect(allowed, s);
      });
    } else {
      // Pas de sélection → restreindre aux dates présentes dans au moins une allocation
      allowed = intersect(affKeys, allAllocDates);
    }
    const allLabels = Array.from(allowed).sort();
    const labels = filterRangeByDays(allLabels, currentRange3);
    if (!labels.length) {
      chart3 = new Chart(ctx3, { type:'line', data:{ labels: [], datasets: [] }, options:{ responsive:true } });
      return;
    }
    function normalizeSeries(map, labelsArr){
      const vals = labelsArr.map(d => map.get(d));
      let base = vals.find(v => isFinite(v) && Math.abs(v) > 0);
      if (!isFinite(base)) base = vals.find(v => isFinite(v));
      if (!isFinite(base)) return labelsArr.map(_=> null);
      if (base === 0) return vals.map(_ => 100);
      return vals.map(v => isFinite(v) ? (v / base) * 100 : null);
    }
    const datasets = [];
    datasets.push({ label:'{{ affaire.ref if affaire else "Affaire" }} (base 100)', data: normalizeSeries(affMap, labels), borderColor:(getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#2456a6').trim(), fill:false, pointRadius:0, pointHoverRadius:0 });
    (selected||[]).forEach((name, idx)=>{
      const arr = allocSeries[name] || [];
      const map = new Map(arr.map(p=> [p.date, parseFloat(p.sicav)]));
      datasets.push({ label:name+' (base 100)', data: normalizeSeries(map, labels), borderColor: '#ff6b6b', fill:false, pointRadius:0, pointHoverRadius:0 });
    });
    const areaFillPluginCmp = {
      id: 'allocFillCmp',
      beforeDatasetsDraw(chart){
        const metaPort = chart.getDatasetMeta(0);
        const metaAlloc = chart.getDatasetMeta(1);
        if (!metaPort || !metaAlloc || !metaPort.data || !metaAlloc.data) return;
        const len = Math.min(metaPort.data.length, metaAlloc.data.length);
        const ctx = chart.ctx;
        ctx.save();
        for (let i=0; i < len - 1; i++){
          const p0 = metaPort.data[i], p1 = metaPort.data[i+1];
          const a0 = metaAlloc.data[i], a1 = metaAlloc.data[i+1];
          if (!p0 || !p1 || !a0 || !a1) continue;
          const pv0 = p0.$context.raw, pv1 = p1.$context.raw;
          const av0 = a0.$context.raw, av1 = a1.$context.raw;
          if (!isFinite(pv0) || !isFinite(pv1) || !isFinite(av0) || !isFinite(av1)) continue;
          const sign = ((pv0 + pv1)/2) - ((av0 + av1)/2);
          ctx.fillStyle = sign >= 0 ? 'rgba(34, 197, 94, 0.18)' : 'rgba(239, 68, 68, 0.28)';
          ctx.beginPath();
          ctx.moveTo(p0.x, p0.y);
          ctx.lineTo(p1.x, p1.y);
          ctx.lineTo(a1.x, a1.y);
          ctx.lineTo(a0.x, a0.y);
          ctx.closePath();
          ctx.fill();
        }
        ctx.restore();
      }
    };
    // Construire les ticks par année
    const years = labels.map(d => d.slice(0,4));
    const xIndexes = labels.map((_, i) => i);
    const yearBlocks = [];
    let startIdx = 0;
    for (let i = 1; i <= years.length; i++) {
      if (i === years.length || years[i] !== years[i-1]) {
        const endIdx = i - 1;
        const centerIdx = Math.floor((startIdx + endIdx) / 2);
        yearBlocks.push({ year: years[i-1], start: startIdx, end: endIdx, center: centerIdx });
        startIdx = i;
      }
    }
    const yearLines = new Set(yearBlocks.map(b => b.start));
    const yearCenters = new Map(yearBlocks.map(b => [b.center, b.year]));
    chart3 = new Chart(ctx3, {
      type:'line',
      plugins: datasets.length>=2 ? [areaFillPluginCmp] : [],
      data:{ labels: xIndexes, datasets },
      options:{
        responsive:true,
        scales:{
          y:{ ticks:{ callback:v=> v.toFixed(0) } },
          x:{
            type:'category',
            labels: xIndexes,
            ticks:{
              autoSkip: false,
              callback: function(val){
                return yearCenters.has(val) ? yearCenters.get(val) : '';
              },
              maxRotation: 0, minRotation: 0, align: 'center'
            },
            grid:{
              drawOnChartArea: true,
              color: function(ctx){ return yearLines.has(ctx.index) ? '#000' : 'rgba(0,0,0,0.05)'; },
              lineWidth: function(ctx){ return yearLines.has(ctx.index) ? 2 : 1; }
            }
          }
        },
        plugins:{
          legend:{ display:true },
          tooltip:{
            displayColors:false,
            callbacks:{
              label:function(){ return ''; },
              beforeBody:function(ctx){
                if (!ctx || !ctx.length) return [];
                const idx = ctx[0].dataIndex;
                const ds = ctx[0].chart.data.datasets || [];
                const port = ds[0] && isFinite(ds[0].data[idx]) ? Number(ds[0].data[idx]) : null;
                const alloc = ds[1] && isFinite(ds[1].data[idx]) ? Number(ds[1].data[idx]) : null;
                const lines = [];
                if (port !== null) lines.push('Affaire (base 100): ' + port.toFixed(2));
                if (alloc !== null) lines.push('Offre (base 100): ' + alloc.toFixed(2));
                if (port !== null && alloc !== null) lines.push('Écart: ' + (port - alloc).toFixed(2));
                return lines;
              }
            }
          }
        }
      }
    });
  }
  // Remplir le select d'allocations
  const sel = document.getElementById('allocSelect');
  Object.keys(allocSeries).forEach(name=>{ const opt=document.createElement('option'); opt.value=name; opt.textContent=name; if(defaultAlloc && name===defaultAlloc){ opt.selected=true; } sel.appendChild(opt); });
  sel.addEventListener('change', function(){ drawChart3(this.value ? [this.value] : []); });
  const rangeBtns = Array.from(document.querySelectorAll('.rangeBtnCmp'));
  function setActiveRangeBtn(val){
    rangeBtns.forEach(b => b.classList.toggle('active', (b.dataset.range||'') === val));
  }
  rangeBtns.forEach(btn => btn.addEventListener('click', function(){
    currentRange3 = this.dataset.range || 'all';
    setActiveRangeBtn(currentRange3);
    drawChart3(sel.value ? [sel.value] : []);
  }));
  currentRange3 = 'all';
  setActiveRangeBtn('all');
  // Sélection par défaut : première allocation si disponible
  if (sel.options.length > 0) {
    if (!sel.value && sel.options.length > 0) sel.selectedIndex = 0;
    drawChart3(sel.value ? [sel.value] : []);
  } else {
    drawChart3([]);
  }

{% endif %}
</script>

<!-- jQuery + DataTables for supports table + Buttons -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script>
  $(function(){
    var table = $('#supportsTableContract').DataTable({
        searching: false,
      dom: 'Bfrtip',
      buttons: [ { extend: 'csvHtml5', text: 'Exporter CSV', title: 'supports_affaire_{{ affaire.ref }}' } ],
      order: [[6, 'desc']],
      pageLength: 25,
      fixedHeader: true,
      columnDefs: [
        { targets: [3], className: 'right', render: $.fn.dataTable.render.number(' ', ',', 2, '') },
        { targets: [4,5], className: 'right', render: $.fn.dataTable.render.number(' ', ',', 2, '') },
        { targets: [6], className: 'right', render: $.fn.dataTable.render.number(' ', ',', 0, '') },
        { targets: [2], className: 'dt-center' }
      ]
    });
    // Aggregation bar chart by category
    var supportsData = {{ supports | tojson }};
    var catCtx = document.getElementById('supportsCatChart').getContext('2d');
    var geoCtx = document.getElementById('supportsGeoChart').getContext('2d');
    var catChart, geoChart;
    function buildCatBar(field){
      var map = new Map();
      (supportsData||[]).forEach(function(s){
        var key = (s[field] || 'Non renseigné');
        var v = parseFloat(s.valo) || 0;
        map.set(key, (map.get(key)||0) + v);
      });
      var entries = Array.from(map.entries()).sort(function(a,b){return b[1]-a[1];});
      var catLabels = entries.map(function(e){return e[0];});
      var catValuesAbs = entries.map(function(e){return e[1];});
      var totalCat = catValuesAbs.reduce(function(a,b){return a + (isFinite(b)? b:0);}, 0) || 0;
      var catValues = catValuesAbs.map(function(v){ return totalCat>0 ? +(v/totalCat*100).toFixed(1) : 0; });
      // hauteur contrôlée par l'attribut height du canvas (pas de redimension dynamique)
      if (catChart) catChart.destroy();
      var primaryColor = (getComputedStyle(document.documentElement).getPropertyValue('--primary') || '').trim() || '#2456a6';
      catChart = new Chart(catCtx, {
        type: 'bar',
        data: { labels: catLabels, datasets: [{ data: catValues, backgroundColor: primaryColor, borderColor: primaryColor, borderWidth: 1 }] },
        options: {
          responsive:true,
          maintainAspectRatio: false,
          plugins:{ legend:{ display:false } },
          layout: { padding: { top: 10, bottom: 36, right: 12, left: 12 } },
          scales:{
            x:{ ticks:{ font:{ size: 10 }, autoSkip: false, maxTicksLimit: 20, padding: 6, maxRotation: 0, minRotation: 0 } },
            y:{ beginAtZero:true, suggestedMax: 100, ticks:{ callback: function(v){ return v + ' %'; } } }
          },
          datasets: { bar: { categoryPercentage: 0.7, barPercentage: 0.8, maxBarThickness: 24 } },
          onHover: function(evt, elements){ if (elements && elements.length){ var idx = elements[0].index; var label = catLabels[idx]; buildGeoBar(field, label); } }
        }
      });
      // initial geo: consolidated if nothing is hovered
      buildGeoBar(field, null);
      // reset to consolidated when leaving the pie
      catCtx.canvas.addEventListener('mouseleave', function(){ buildGeoBar(field, null); });
    }
    function buildGeoBar(field, catValue){
      var map = new Map();
      (supportsData||[]).forEach(function(s){
        var cat = (s[field] || 'Non renseigné');
        if (catValue !== null && catValue !== undefined && String(cat) !== String(catValue)) return;
        var key = (s['cat_geo'] || 'Non renseigné');
        var v = Number(s.valo) || 0;
        map.set(key, (map.get(key)||0) + v);
      });
      var entries = Array.from(map.entries()).sort(function(a,b){return b[1]-a[1];});
      var geoLabels = entries.map(function(e){return e[0];});
      var geoValuesAbs = entries.map(function(e){return e[1];});
      var totalGeo = geoValuesAbs.reduce(function(a,b){return a + (isFinite(b)? b:0);}, 0) || 0;
      var geoValues = geoValuesAbs.map(function(v){ return totalGeo>0 ? +(v/totalGeo*100).toFixed(1) : 0; });
      // hauteur fixée par attribut height du canvas
      if (geoChart) geoChart.destroy();
      var teal = '#2a9d8f';
      geoChart = new Chart(geoCtx, {
        type:'bar',
        data:{ labels: geoLabels, datasets:[{ data: geoValues, backgroundColor: teal, borderColor: teal, borderWidth: 1 }] },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          layout: { padding: { top: 10, bottom: 36, right: 12, left: 12 } },
          scales:{ x:{ ticks:{ font:{ size:10 }, autoSkip: false, maxTicksLimit: 20, padding: 6, maxRotation: 0, minRotation: 0 } }, y:{ beginAtZero:true, suggestedMax: 100, ticks:{ callback: function(v){ return v + ' %'; } } } },
          datasets: { bar: { categoryPercentage: 0.7, barPercentage: 0.8, maxBarThickness: 24 } }
        }
      });
    }
    buildCatBar('cat_gene');
    document.querySelectorAll('.dim-buttons .dim-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        document.querySelectorAll('.dim-buttons .dim-btn').forEach(b=> b.classList.remove('active'));
        this.classList.add('active');
        buildCatBar(this.dataset.field);
      });
    });
  });
  </script>

  <script>
    function openMovementPopup(affId, avisId){
      try {
        var baseW = 1100, baseH = 800;
        var w = Math.floor(baseW * 1.15), h = Math.floor(baseH * 1.15);
        var maxW = (screen.availWidth || screen.width || w);
        var maxH = (screen.availHeight || screen.height || h);
        if (w > maxW) w = Math.floor(maxW);
        if (h > maxH) h = Math.floor(maxH);
        var left = Math.max(0, Math.floor((maxW - w) / 2));
        var top = Math.max(0, Math.floor((maxH - h) / 2));
        var feat = 'scrollbars=yes,resizable=yes' + ',width=' + w + ',height=' + h + ',left=' + left + ',top=' + top;
        var url = '/dashboard/mouvements?affaire_id=' + encodeURIComponent(affId||'') + '&avis_id=' + encodeURIComponent(avisId||'');
        url = appendMarkers(url);
        var win = window.open(url, 'mouvements_'+(affId||'')+'_'+(avisId||''), feat);
        if (win && win.focus) { try { win.focus(); } catch(e){} }
      } catch(e){}
    }
  </script>

  <!-- Modal Avis d'opération -->
  <style>
    #avisModal { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 9999; }
    #avisModal .modal-card { background:#fff; border-radius:12px; width: 1000px; max-width: 96vw; max-height: 92vh; overflow:auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    #avisModal .modal-header { display:flex; align-items:center; justify-content: space-between; padding: 10px 14px; border-bottom:1px solid var(--border); }
    #avisModal .modal-body { padding: 12px 14px; }
    #avisModal table th, #avisModal table td { white-space: nowrap; }
    #avisModal table td:nth-child(2) { max-width: 60ch; white-space: normal; }
  </style>
  <div id="avisModal" onclick="if(event.target===this) closeAvisModal()">
    <div class="modal-card">
      <div class="modal-header">
        <h3 style="margin:0;"><i class="fa-solid fa-clipboard-list" style="margin-right:8px;"></i>Avis d'opération</h3>
        <button type="button" class="btn" onclick="closeAvisModal()">Fermer</button>
      </div>
      <div class="modal-body">
        <table id="avisModalTable" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Date</th>
              <th>Référence</th>
              <th>Étape</th>
              <th style="text-align:right;">Entrée</th>
              <th style="text-align:right;">Sortie</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for a in avis_affaire %}
            <tr>
              <td><span class="js-local-dt" data-iso="{{ a.date }}">{{ a.date }}</span></td>
              <td>{{ a.reference or '' }}</td>
              <td>{{ a.etape or '' }}</td>
              <td style="text-align:right;">{{ a.entree_str or '' }}</td>
              <td style="text-align:right;">{{ a.sortie_str or '' }}</td>
              <td><button type="button" class="btn btn-choice" title="Voir mouvement" onclick="openMovementPopup({{ affaire.id }}, {{ a.avis_id }})"><i class="fa-solid fa-eye"></i></button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function openAvisModal(){ var el=document.getElementById('avisModal'); if(el){ el.style.display='flex'; } }
    function closeAvisModal(){ var el=document.getElementById('avisModal'); if(el){ el.style.display='none'; } }
  </script>

  <!-- Modale Administration Groupes (Affaire) -->
  <div id="affAdminGroupsModal" class="modal-overlay" data-tb-marker="AF_15" onclick="if(event.target===this) document.getElementById('affAdminGroupsModal').style.display='none'">
    <div class="modal-card" data-tb-marker="AF_16">
      <div class="modal-header">
        <h3><i class="fa-solid fa-briefcase" style="margin-right:8px;"></i>Groupes de l'affaire</h3>
        <button class="modal-close" onclick="document.getElementById('affAdminGroupsModal').style.display='none'">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
        <div class="field">
          <label>Ajouter l'affaire à un groupe</label>
          <select id="affGroupsSelect"></select>
          <div id="affGroupsNotice" class="muted" style="margin-top:6px; display:none;"></div>
        </div>
          <div class="field" style="align-self:end;">
            <button class="btn btn-primary" onclick="addAffGroup()"><i class="fa-solid fa-plus" style="margin-right:6px;"></i>Ajouter</button>
          </div>
        </div>
        <table id="affGroupsTable">
          <thead>
            <tr>
              <th>Groupe</th>
              <th>Actif</th>
              <th>Ajout</th>
              <th>Retrait</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <script>
      const AFFAIRE_ID = {{ affaire.id if affaire else 'null' }};
      let affGroupDetails = [];
      let affGroupLinks = [];
    function generateAffaireSynthese(){
      try{
        if (!AFFAIRE_ID){
          alert('Affaire introuvable.');
          return;
        }
        if (typeof window.showGlobalLoader === 'function'){
          window.showGlobalLoader('Génération du PDF…');
        }
        const url = '/dashboard/affaires/' + encodeURIComponent(AFFAIRE_ID) + '/synthese/pdf';
        window.open(url, '_blank', 'noopener');
        const clearLoader = function(){
          if (typeof window.hideGlobalLoader === 'function'){
            window.hideGlobalLoader();
          }
          window.removeEventListener('focus', clearLoader);
        };
        window.addEventListener('focus', clearLoader);
        setTimeout(clearLoader, 4000);
      }catch(err){
        console.warn('Affaire synthèse PDF generation failed', err);
      }
    }
    function openAffAdminGroups(){
      const el = document.getElementById('affAdminGroupsModal');
      el.style.display = 'flex';
      console.log('[Admin][Affaire] open modal for affaire_id=', AFFAIRE_ID);
      loadAffGroups();
    }
    async function loadAffGroups(){
      const notice = document.getElementById('affGroupsNotice');
      if (notice) { notice.style.display = 'none'; notice.textContent = ''; }
      try {
        let detailsRes = await fetch('/api/groupes/details?type=affaire&actifs_only=true');
        console.log('[Admin][Affaire] fetch details (active) → status', detailsRes.status);
        affGroupDetails = detailsRes.ok ? await detailsRes.json() : [];
        console.log('[Admin][Affaire] details (active) payload:', affGroupDetails);
        if (!Array.isArray(affGroupDetails) || affGroupDetails.length === 0){
          console.warn('[Admin][Affaire] no active groups, retry including inactive');
          const r2 = await fetch('/api/groupes/details?type=affaire&actifs_only=false');
          console.log('[Admin][Affaire] fetch details (all) → status', r2.status);
          if (r2.ok) affGroupDetails = await r2.json();
          console.log('[Admin][Affaire] details (all) payload:', affGroupDetails);
        }
        const linksRes = await fetch('/api/groupes/memberships?affaire_id=' + encodeURIComponent(AFFAIRE_ID));
        console.log('[Admin][Affaire] fetch memberships → status', linksRes.status);
        affGroupLinks = linksRes.ok ? await linksRes.json() : [];
        console.log('[Admin][Affaire] memberships payload:', affGroupLinks);
        renderAffGroupSelect();
        renderAffGroupsTable();
      } catch (e) {
        console.error('[Admin][Affaire] loadAffGroups error:', e);
        if (notice) { notice.style.display = 'block'; notice.textContent = 'Erreur de chargement des groupes.'; }
      }
    }
      function renderAffGroupSelect(){
        const sel = document.getElementById('affGroupsSelect');
        sel.innerHTML = '';
      const notice = document.getElementById('affGroupsNotice');
      if (!Array.isArray(affGroupDetails) || affGroupDetails.length === 0){
        const opt = document.createElement('option'); opt.value=''; opt.textContent='Aucun groupe Affaires'; sel.appendChild(opt);
        if (notice) { notice.style.display = 'block'; notice.textContent = 'Aucun groupe Affaires trouvé. Allez dans Administration > Groupes pour en créer.'; }
        return;
      }
      if (notice) { notice.style.display = 'none'; notice.textContent = ''; }
      affGroupDetails.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id; opt.textContent = g.nom + (g.actif===0?' (inactif)':'');
        sel.appendChild(opt);
      });
    }
      function renderAffGroupsTable(){
        const body = document.querySelector('#affGroupsTable tbody');
        body.innerHTML = '';
        const nameById = Object.fromEntries(affGroupDetails.map(g => [g.id, g.nom]));
        (affGroupLinks||[]).forEach(link => {
          const tr = document.createElement('tr');
          const tdNom = document.createElement('td'); tdNom.textContent = nameById[link.groupe_id] || ('#'+link.groupe_id);
          const tdActif = document.createElement('td'); tdActif.textContent = (link.actif===1 || link.actif===null)?'Oui':'Non';
          const tdAj = document.createElement('td'); tdAj.className='js-local-dt'; tdAj.setAttribute('data-iso', link.date_ajout || '');
          const tdRt = document.createElement('td'); tdRt.className='js-local-dt'; tdRt.setAttribute('data-iso', link.date_retrait || '');
          const tdAct = document.createElement('td');
          const btn = document.createElement('button'); btn.className = 'btn btn-danger'; btn.textContent = 'Retirer'; btn.onclick = () => removeAffGroup(link.id);
          tdAct.appendChild(btn);
          tr.appendChild(tdNom); tr.appendChild(tdActif); tr.appendChild(tdAj); tr.appendChild(tdRt); tr.appendChild(tdAct);
          body.appendChild(tr);
        });
        // trigger client-side date localization
        try { (function(){
          var nodes = document.querySelectorAll('#affGroupsTable .js-local-dt');
          nodes.forEach(function (el) {
            var iso = el.getAttribute('data-iso') || (el.textContent || '').trim();
            if (!iso) { el.textContent=''; return; }
            var s = iso;
            if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}(?::\d{2})?)?$/.test(s)) {
              s = s.replace(' ', 'T') + 'Z';
            }
            var d = new Date(s);
            if (isNaN(d)) { el.textContent = iso; return; }
            try { el.textContent = d.toLocaleString('fr-FR', { timeZone: 'Europe/Paris' }); }
            catch(e){ el.textContent = d.toLocaleString(); }
          });
        })(); } catch(e){}
      }
      async function addAffGroup(){
        const sel = document.getElementById('affGroupsSelect');
        const gid = parseInt(sel.value, 10);
        if (!gid || !AFFAIRE_ID) return;
        try {
          await fetch('/api/groupes/memberships', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groupe_id: gid, affaire_id: AFFAIRE_ID })
          });
          await loadAffGroups();
        } catch (e) { console.error(e); }
      }
      async function removeAffGroup(linkId){
        if (!linkId) return;
        try {
          await fetch('/api/groupes/memberships/' + linkId, { method: 'DELETE' });
          await loadAffGroups();
        } catch (e) { console.error(e); }
      }
    </script>
  </div>

{% endblock %}
