{% extends "base.html" %}
{% block title %}Supports{% endblock %}
{% block header_title %}<i class="fa-solid fa-chart-pie" style="margin-right:8px;"></i>Supports{% endblock %}
{% block content %}

<style>
    .main-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 2rem;
        margin: 2rem auto;
    }
    .header-section {
        background: var(--primary);
        color: #fff;
        padding: 1.2rem;
        border-radius: 10px;
        margin-bottom: 1.2rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        table-layout: fixed; /* respecter les largeurs de colonnes */
    }
    /* En-t√™tes de tableau h√©ritent du style global (base.html) */
    thead input, thead select {
        width: 100%;
        padding: 4px 6px; /* champs plus compacts */
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 12px; /* police r√©duite */
    }
    tbody td {
        padding: 6px 6px; /* cellules plus compactes */
        line-height: 1.2;
        font-size: 12px;
        white-space: nowrap; /* √©vite les retours √† la ligne */
    }

    /* Ajustement des largeurs de colonnes pour mieux r√©partir l'espace */
    /* Colonnes: 1=ISIN, 2=Nom, 3=Cat√©gorie, 4=Zone, 5=SRRI, 6=Valo */
    #supportsTable th:nth-child(1),
    #supportsTable td:nth-child(1) { /* Code ISIN */
        width: 14%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #supportsTable th:nth-child(2),
    #supportsTable td:nth-child(2) { /* Nom */
        width: 26%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #supportsTable th:nth-child(4),
    #supportsTable td:nth-child(4) { /* Zone g√©o */
        width: 20%;
    }
    #supportsTable th:nth-child(5),
    #supportsTable td:nth-child(5) { /* SRRI */
        width: 10%;
        text-align: center;
    }
    .valo-amount {
        font-weight: 600;
        color: #28a745;
        text-align: right;
        font-family: monospace;
    }
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .restore-note { display:none; font-size:12px; color:#666; margin: 2px 0 6px 0; }
    .restore-note .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2f7; border:1px solid #dde3ea; color:#445; font-weight:600; }
    .restore-note .badge a.close { margin-left:6px; text-decoration:none; color:#445; font-weight:700; cursor:pointer; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin: .5rem 0 8px 0; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: var(--surface); cursor:pointer; font-size:12px; color: var(--text); text-decoration:none; }
    .chip:hover { background: var(--primary-100); color: var(--primary-600); }
    .clear-btn {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    /* Badges actifs */
    .badge-filter { display:inline-flex; align-items:center; gap:6px; background:#eef2ff; color:#1d4ed8; border:1px solid #c7d2fe; border-radius:999px; padding:4px 10px; font-size:.85rem; }
    .badge-filter .x { color:#1d4ed8; text-decoration:none; opacity:.85; }
    .badge-filter .x:hover { opacity:1; }
    .badge-row { display:flex; gap:6px; flex-wrap:wrap; margin:.25rem 0 .5rem 0; }
    .support-modal { position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center; background:rgba(15,23,42,0.55); z-index:1000; padding:4rem 1rem 2rem; overflow-y:auto; }
    .support-modal.open { display:flex; }
    .support-modal__panel { background:#fff; border-radius:12px; box-shadow:0 20px 40px rgba(15,23,42,0.25); max-width:720px; width:100%; padding:1.5rem; position:relative; }
    .support-modal__close { position:absolute; top:12px; right:12px; border:none; background:transparent; font-size:1.5rem; cursor:pointer; color:#334155; }
    .support-modal__title { margin-top:0; margin-bottom:0.5rem; }
    .support-modal__meta { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.5rem 1rem; font-size:0.9rem; margin-bottom:1rem; }
    .support-modal__meta div { background:#f8fafc; border-radius:8px; padding:0.6rem 0.75rem; }
    .support-modal__meta span { display:block; }
    .support-modal__meta .label { color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.06em; }
    .support-modal__meta .value { font-weight:600; color:#1f2937; }
    .support-meta-btn { background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.6rem 0.75rem; font-weight:600; color:#1f2937; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.5rem; transition:background .2s ease, color .2s ease, border-color .2s ease; font-size:0.9rem; }
    .support-meta-btn i { color:inherit; }
    .support-meta-btn:hover { background:#e2e8f0; border-color:#cbd5f5; }
    .support-meta-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 6px 14px rgba(37,99,235,0.25); }
    .support-meta-btn.active i { color:#fff; }
    .support-modal__clients { margin-top:1rem; }
    .support-modal__clients table { width:100%; border-collapse:collapse; }
    .support-modal__clients th, .support-modal__clients td { padding:0.5rem 0.6rem; border-bottom:1px solid #e2e8f0; text-align:left; font-size:0.9rem; }
    .support-modal__clients td:last-child, .support-modal__clients th:last-child { text-align:right; font-variant-numeric:tabular-nums; }
    .support-modal__empty { margin-top:1rem; color:#64748b; font-style:italic; }
    .support-modal__actions { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:0.5rem; }
    .support-modal__actions button { background:var(--primary); color:#fff; border:none; border-radius:8px; padding:0.45rem 0.9rem; cursor:pointer; font-weight:600; transition:filter .2s ease; }
    .support-modal__actions button:hover { filter:brightness(0.9); }
    .support-modal__filters { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.75rem; margin-top:1.2rem; align-items:flex-end; }
    .support-modal__filters label { display:block; font-size:0.75rem; font-weight:600; color:#475569; text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.25rem; }
    .support-modal__filters input { width:100%; border:1px solid #cbd5f5; border-radius:6px; padding:0.45rem 0.5rem; font-size:0.88rem; }
    .support-modal__filters button { margin-top:1.65rem; background:#e2e8f0; border:none; border-radius:6px; padding:0.45rem 0.75rem; font-weight:600; color:#334155; cursor:pointer; transition:background .2s ease; }
    .support-modal__filters button:hover { background:#cbd5f5; }
    .support-modal__actions-group { display:flex; gap:0.5rem; align-items:center; }
    .support-modal__actions-group button:nth-child(2) { background:#6366f1; }
    .support-modal__actions-group button:nth-child(2):hover { filter:brightness(0.9); }
    .support-modal__actions-group button:disabled { opacity:0.45; cursor:not-allowed; filter:none; }
    .support-modal__chart { display:none; margin-top:1rem; background:#f8fafc; border-radius:12px; padding:1rem; box-shadow:0 12px 32px rgba(15,23,42,0.12); }
    .support-modal__chart canvas { width:100%; height:260px; }
    .support-modal__series { display:none; margin-top:1rem; background:#fff; border-radius:12px; box-shadow:0 12px 32px rgba(15,23,42,0.08); padding:1rem; }
    .support-series-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:0.6rem; }
    .support-series-header h4 { margin:0; font-size:0.95rem; color:#1f2937; }
    .support-series-toggle { background:transparent; border:1px solid #cbd5f5; border-radius:6px; padding:0.2rem 0.6rem; font-size:0.82rem; font-weight:600; color:#2563eb; cursor:pointer; transition:background .2s ease, color .2s ease; }
    .support-series-toggle:hover { background:#dbeafe; color:#1d4ed8; }
    .support-modal__series table { width:100%; border-collapse:collapse; font-size:0.85rem; }
    .support-modal__series th,
    .support-modal__series td { border:1px solid #e2e8f0; padding:0.45rem 0.5rem; text-align:left; }
    .support-modal__series th { background:#f1f5f9; font-weight:600; color:#334155; }
    .support-modal__series .series-table { margin-bottom:1rem; }
    .support-modal__series .series-empty { font-style:italic; color:#64748b; font-size:0.85rem; }
    .support-task-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,0.55); z-index:1200; padding:2rem 1rem; }
    .support-task-modal.open { display:flex; }
    .support-task-modal__panel { background:#fff; border-radius:12px; box-shadow:0 24px 48px rgba(15,23,42,0.35); max-width:460px; width:100%; padding:1.5rem; position:relative; }
    .support-task-modal__close { position:absolute; top:12px; right:12px; border:none; background:transparent; font-size:1.4rem; cursor:pointer; color:#475569; }
    .support-task-modal__title { margin-top:0; margin-bottom:0.75rem; }
    .support-task-modal__form label { display:block; font-size:0.8rem; font-weight:600; color:#475569; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.3rem; }
    .support-task-modal__form select,
    .support-task-modal__form textarea { width:100%; border:1px solid #cbd5f5; border-radius:8px; padding:0.55rem 0.6rem; font-size:0.95rem; }
    .support-task-modal__form textarea { resize:vertical; min-height:96px; }
    .support-task-modal__footer { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:1.2rem; }
    .support-task-modal__footer button { border:none; border-radius:8px; padding:0.55rem 1rem; font-weight:600; cursor:pointer; transition:filter .2s ease; }
    #supportTaskSubmit { background:#16a34a; color:#fff; }
    #supportTaskSubmit:hover { filter:brightness(0.9); }
    #supportTaskCancel { background:#e2e8f0; color:#334155; }
    #supportTaskCancel:hover { filter:brightness(0.9); }
    #supportTaskStatus { font-size:0.85rem; color:#475569; margin-top:0.75rem; min-height:1.2rem; }
</style>

<div class="main-container">
    <div class="header-section">
        <p><strong>Date:</strong> <span class="js-local-dt" data-iso="{{ last_date }}">{{ last_date }}</span> | <strong>Total:</strong> {{ total_supports }} supports</p>
    </div>

    <div id="sup_active_badges" class="badge-row"></div>

    <div class="table-container">
        <div id="restoreSupports" class="restore-note"><span class="badge">Filtres restaur√©s <a href="#" class="close" onclick="return resetRestoredSupports()">√ó</a></span></div>
        <div id="quickToggleSup" class="card accordion-toggle" style="margin-bottom:.5rem; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;">
            <h3 style="margin:0; font-size:1.05rem;">Filtres rapides</h3>
            <span class="chevron">‚ñæ</span>
        </div>
        <div id="quickSectionSup" style="display:none;">
        <div class="toolbar">
            <div class="chips" id="supportChips">
                <span style="color:#666; font-size:12px; margin-right:4px;">Raccourcis:</span>
                <a class="chip" href="#" onclick="return chipSrri('')">SRRI: Tous</a>
                <a class="chip" href="#" onclick="return chipSrri('1')">SRRI: 1</a>
                <a class="chip" href="#" onclick="return chipSrri('2')">SRRI: 2</a>
                <a class="chip" href="#" onclick="return chipSrri('3')">SRRI: 3</a>
                <a class="chip" href="#" onclick="return chipSrri('4')">SRRI: 4</a>
                <a class="chip" href="#" onclick="return chipSrri('5')">SRRI: 5</a>
                <a class="chip" href="#" onclick="return chipSrri('6')">SRRI: 6</a>
                <a class="chip" href="#" onclick="return chipSrri('7')">SRRI: 7</a>
            </div>
        </div>
        </div>
        <table id="supportsTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>Code ISIN</th>
                    <th>Nom</th>
                    <th>Cat√©gorie</th>
                    <th>Zone G√©o</th>
                    <th>SRRI</th>
                    <th style="text-align:right;">Valo Total</th>
                </tr>
                <tr>
                    <th><input type="text" id="isin-filter" placeholder="Filtrer..."></th>
                    <th><input type="text" id="nom-filter" placeholder="Filtrer..."></th>
                    <th><select id="categorie-filter" multiple size="6"><option value="">Aucun</option></select></th>
                    <th><select id="zone-filter" multiple size="6"><option value="">Aucun</option></select></th>
                    <th><select id="srri-filter" multiple size="6"><option value="">Aucun</option></select></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for s in supports %}
                <tr>
                    <td><a href="#" class="support-link" data-isin="{{ s.code_isin }}">{{ s.code_isin }}</a></td>
                    <td>{{ s.nom }}</td>
                    <td>{{ s.categorie }}</td>
                    <td>{{ s.zone_geo }}</td>
                    <td>{{ s.SRRI }}</td>
                    <td class="valo-amount">{{ s.total_valo }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div id="results-info">Astuce: maintenez Ctrl/Cmd pour une s√©lection multiple dans les listes.</div>
        <button class="clear-btn" onclick="clearFilters()">üóëÔ∏è Effacer</button>
    </div>
</div>

<div id="supportModal" class="support-modal" aria-hidden="true">
  <div class="support-modal__panel" role="dialog" aria-modal="true" aria-labelledby="supportModalTitle">
    <button type="button" class="support-modal__close" id="supportModalClose" aria-label="Fermer">√ó</button>
    <h2 class="support-modal__title" id="supportModalTitle">Support</h2>
    <div class="support-modal__meta" id="supportModalMeta"></div>
    <div class="support-modal__actions">
      <div>
        <span id="supportModalDate" style="color:#475569; font-size:0.85rem;"></span><br>
        <strong id="supportModalTotal" style="font-size:1rem; color:#111827;"></strong>
      </div>
    </div>
    <div class="support-modal__chart" id="supportModalChartContainer">
      <canvas id="supportModalChart"></canvas>
    </div>
    <div class="support-modal__series" id="supportModalSeries"></div>
    <div class="support-modal__filters">
      <div>
        <label for="supportModalClientFilter">Client</label>
        <input type="text" id="supportModalClientFilter" placeholder="Rechercher client" />
      </div>
      <div>
        <label for="supportModalResponsableFilter">Responsable</label>
        <input type="text" id="supportModalResponsableFilter" placeholder="Rechercher responsable" />
      </div>
      <div>
        <label for="supportModalAmountFilter">Valorisation</label>
        <input type="text" id="supportModalAmountFilter" placeholder=">100k, 100k-500k" />
      </div>
      <button type="button" id="supportModalFiltersReset">R√©initialiser</button>
    </div>
    <div class="support-modal__clients" id="supportModalClients"></div>
  </div>
</div>

<div id="supportTaskModal" class="support-task-modal" aria-hidden="true">
  <div class="support-task-modal__panel" role="dialog" aria-modal="true" aria-labelledby="supportTaskModalTitle">
    <button type="button" class="support-task-modal__close" id="supportTaskModalClose" aria-label="Fermer">√ó</button>
    <h3 class="support-task-modal__title" id="supportTaskModalTitle">Cr√©er des t√¢ches</h3>
    <div class="support-task-modal__form">
      <div style="margin-bottom:0.9rem;">
        <label for="supportTaskTypeSelect">Type de t√¢che</label>
        <select id="supportTaskTypeSelect"></select>
      </div>
      <div>
        <label for="supportTaskComment">Commentaire</label>
        <textarea id="supportTaskComment" placeholder="Commentaire (optionnel)"></textarea>
      </div>
    </div>
    <div id="supportTaskStatus"></div>
    <div class="support-task-modal__footer">
      <button type="button" id="supportTaskCancel">Annuler</button>
      <button type="button" id="supportTaskSubmit">Cr√©er les t√¢ches</button>
    </div>
  </div>
</div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- FixedHeader -->
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
$(document).ready(function () {
    var table = $('#supportsTable').DataTable({
        order: [[5, "desc"]],
        pageLength: 25,
        fixedHeader: true,
        columnDefs: [
            {
                targets: 5, // colonne Valo Total
                render: $.fn.dataTable.render.number(' ', ',', 0, '')
            }
        ],
        initComplete: function () {
            var api = this.api();

            // remplir selects avec valeurs uniques et filtrage multi
            api.columns([2,3,4]).every(function () {
                var column = this;
                var idx = column.index();
                var select = $('#supportsTable thead tr:eq(1) th').eq(idx).find('select');

                // option 'Aucun'
                if (select.find('option[value=""]').length === 0) {
                    select.append('<option value="">Aucun</option>');
                }
                column.data().unique().sort().each(function (d) {
                    if (d) select.append('<option value="'+d+'">'+d+'</option>');
                });

                // Permet de s√©lectionner/d√©s√©lectionner plusieurs options par simple clic (sans Ctrl/Cmd)
                select.on('mousedown', 'option', function(e){
                    e.preventDefault();
                    var $opt = $(this);
                    var $sel = $opt.parent();
                    var wasSelected = $opt.prop('selected');
                    if ($opt.val() === '') {
                        // Si 'Aucun' est cliqu√©: on vide tout et on ne garde que 'Aucun'
                        $sel.find('option').prop('selected', false);
                        $opt.prop('selected', true);
                    } else {
                        // Si une vraie valeur est cliqu√©e: on enl√®ve 'Aucun' et on toggle cette valeur
                        $sel.find('option[value=""]').prop('selected', false);
                        $opt.prop('selected', !wasSelected);
                    }
                    $sel.trigger('change');
                    return false;
                });

                select.on('change', function () {
                    var vals = $(this).val() || [];
                    // Si 'Aucun' est s√©lectionn√©, on nettoie le filtre
                    if (vals.length === 0 || (vals.length === 1 && vals[0] === '')) {
                        column.search('').draw();
                    } else {
                        var pattern = vals.map($.fn.dataTable.util.escapeRegex).join('|');
                        column.search(pattern, true, false).draw();
                    }
                    // Mettre √† jour l'URL
                    try {
                        var params = new URLSearchParams(window.location.search);
                        var key = (idx===2?'categorie':(idx===3?'zone':'srri'));
                        var filtered = (vals||[]).filter(v=>v && v!=='');
                        if (filtered.length) params.set(key, filtered.join(',')); else params.delete(key);
                        var newUrl = window.location.pathname + (params.toString()?('?'+params.toString()):'');
                        window.history.replaceState({}, '', newUrl);
                    } catch(e) {}
                    // Sauver √©tat
                    try { saveSupportsState(); } catch(e) {}
                    // Badges actifs
                    try { renderBadges(); } catch(e) {}
                });
            });

            // Injecter chips dynamiques pour Cat√©gorie/Zone apr√®s remplissage
            try {
                var chips = document.getElementById('supportChips');
                function addChip(label, handler){ var a=document.createElement('a'); a.className='chip'; a.href='#'; a.textContent=label; a.onclick=function(){ return handler(); }; chips.appendChild(a); }
                addChip('Cat√©gorie: Tous', function(){ $('#categorie-filter').val(['']).trigger('change'); return false; });
                $('#categorie-filter option').each(function(){ var v=$(this).val(); if(v){ addChip('Cat√©gorie: '+v, function(){ $('#categorie-filter').val([v]).trigger('change'); return false; }); }});
                addChip('Zone: Tous', function(){ $('#zone-filter').val(['']).trigger('change'); return false; });
                $('#zone-filter option').each(function(){ var v=$(this).val(); if(v){ addChip('Zone: '+v, function(){ $('#zone-filter').val([v]).trigger('change'); return false; }); }});
            } catch(e) {}

            // Pr√©filtres via URL ?srri=1,2&categorie=...&zone=...; sinon restaurer depuis localStorage
            (function(){
              try {
                var params = new URLSearchParams(window.location.search);
                function applyMulti(param, sel){ var val=params.get(param); if(!val) return false; var list=val.split(',').map(s=>s.trim()).filter(Boolean); if(!list.length) return false; var found=[]; $(sel+' option').each(function(){ var v=$(this).val(); if(v && list.indexOf(v)!==-1){ found.push(v);} }); if(found.length){ $(sel).val(found).trigger('change'); return true; } return false; }
                var used=false; used = applyMulti('srri', '#srri-filter') || used; used = applyMulti('categorie', '#categorie-filter') || used; used = applyMulti('zone', '#zone-filter') || used;
                if (!used){
                  var raw = localStorage.getItem('supports_filters');
                  if (raw){
                    var st = JSON.parse(raw);
                    if (st){
                      var restored=false;
                      if (st.isin) { $('#isin-filter').val(st.isin).trigger('change'); restored=true; }
                      if (st.nom) { $('#nom-filter').val(st.nom).trigger('change'); restored=true; }
                      if (Array.isArray(st.categorie) && st.categorie.length) { $('#categorie-filter').val(st.categorie).trigger('change'); restored=true; }
                      if (Array.isArray(st.zone) && st.zone.length) { $('#zone-filter').val(st.zone).trigger('change'); restored=true; }
                      if (Array.isArray(st.srri) && st.srri.length) { $('#srri-filter').val(st.srri).trigger('change'); restored=true; }
                      if (restored) { try{ document.getElementById('restoreSupports').style.display='block'; }catch(e){} }
                    }
                  }
                }
              } catch(e) {}
            })();
            // Rendu initial des badges
            try { renderBadges(); } catch(e) {}
        }
    });

    // filtres texte multiples (s√©par√©s par virgule ou espace)
    function multiTextSearch(value, columnIdx) {
        var terms = (value || '').split(/[ ,]+/).filter(Boolean);
        if (terms.length === 0) {
            table.column(columnIdx).search('').draw();
        } else {
            var pattern = terms.map($.fn.dataTable.util.escapeRegex).join('|');
            table.column(columnIdx).search(pattern, true, false).draw();
        }
    }

    function updateSansNomButtonState(){
        var btn = document.getElementById('supportSansNomBtn');
        if (!btn) return;
        var visible = $supportModalChartContainer && $supportModalChartContainer.is(':visible');
        if (visible){
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
        } else {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
        }
    }

    function toggleSupportChart(){
        var hasGraph = (supportModalValuations && supportModalValuations.length) || (supportModalValuationsWeekly && supportModalValuationsWeekly.length);
        if (!hasGraph){
            alert('Aucune valeur liquidative disponible.');
            return;
        }
        if ($supportModalChartContainer && $supportModalChartContainer.is(':visible')){
            if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
            $supportModalChartContainer.hide();
        } else {
            ensureChartJs(function(){ renderSupportModalChart(); });
        }
        updateSansNomButtonState();
    }
    function saveSupportsState(){
      try {
        var st = {
          isin: $('#isin-filter').val() || '',
          nom: $('#nom-filter').val() || '',
          categorie: ($('#categorie-filter').val()||[]).filter(v=>v&&v!==''),
          zone: ($('#zone-filter').val()||[]).filter(v=>v&&v!==''),
          srri: ($('#srri-filter').val()||[]).filter(v=>v&&v!==''),
        };
        localStorage.setItem('supports_filters', JSON.stringify(st));
      } catch(e) {}
    }
    $('#isin-filter').on('keyup change', function () { multiTextSearch(this.value, 0); saveSupportsState(); });
    $('#nom-filter').on('keyup change', function () { multiTextSearch(this.value, 1); saveSupportsState(); try { renderBadges(); } catch(e) {} });

    // chips SRRI (raccourcis)
    window.chipSrri = function(val){ if(val===''){ $('#srri-filter').val(['']).trigger('change'); } else { $('#srri-filter').val([val]).trigger('change'); } return false; };

    // bouton effacer
    window.clearFilters = function() {
        $('#isin-filter, #nom-filter').val('');
        // R√©initialise les s√©lecteurs sur 'Aucun'
        $('#categorie-filter, #zone-filter, #srri-filter').each(function(){
            $(this).find('option').prop('selected', false);
            $(this).find('option[value=""]').prop('selected', true);
            $(this).trigger('change');
        });
        table.search('').columns().search('').draw();
        try { var params=new URLSearchParams(window.location.search); ['categorie','zone','srri'].forEach(k=>params.delete(k)); var newUrl=window.location.pathname + (params.toString()?('?'+params.toString()):''); window.history.replaceState({}, '', newUrl); } catch(e) {}
        try { localStorage.removeItem('supports_filters'); } catch(e) {}
        };
    (function(){
      try{
        var t=document.getElementById('quickToggleSup'),s=document.getElementById('quickSectionSup');
        if(!t||!s)return;
        function setOpen(o){
          s.style.display=o?'':'none';
          t.classList.toggle('collapsed',!o);
          localStorage.setItem('sup_quick_open',o?'1':'');
        }
        var stored = localStorage.getItem('sup_quick_open');
        var initial = stored === null ? true : (stored === '1');
        setOpen(initial);
        t.addEventListener('click',function(){setOpen(s.style.display==='none');});
      }catch(e){}
    })();

    // reset depuis le badge restaur√©
    window.resetRestoredSupports = function(){ try{ document.getElementById('restoreSupports').style.display='none'; }catch(e){}; try{ window.clearFilters(); }catch(e){}; return false; };

    // Badges actifs (Cat√©gorie / Zone / SRRI et ISIN/Nom)
    window.renderBadges = function(){
      var host = document.getElementById('sup_active_badges');
      if (!host) return; host.innerHTML = '';
      function makeBadge(label, onClear){
        var span = document.createElement('span'); span.className='badge-filter';
        span.appendChild(document.createTextNode(label+' '));
        var a = document.createElement('a'); a.href='#'; a.className='x'; a.title='Effacer le filtre'; a.textContent='‚úï';
        a.addEventListener('click', function(e){ e.preventDefault(); try{ onClear(); }catch(_){} });
        span.appendChild(a); host.appendChild(span);
      }
      // Cat√©gorie
      try {
        var catVals = ($('#categorie-filter').val()||[]).filter(function(v){ return v && v!==''; });
        if (catVals.length){ makeBadge('Cat√©gorie: '+catVals.join(', '), function(){ $('#categorie-filter').val(['']).trigger('change'); }); }
      } catch(e) {}
      // Zone
      try {
        var zoneVals = ($('#zone-filter').val()||[]).filter(function(v){ return v && v!==''; });
        if (zoneVals.length){ makeBadge('Zone g√©o: '+zoneVals.join(', '), function(){ $('#zone-filter').val(['']).trigger('change'); }); }
      } catch(e) {}
      // SRRI
      try {
        var srriVals = ($('#srri-filter').val()||[]).filter(function(v){ return v && v!==''; });
        if (srriVals.length){ makeBadge('SRRI: '+srriVals.join(', '), function(){ $('#srri-filter').val(['']).trigger('change'); }); }
      } catch(e) {}
      // Optionnel: ISIN / Nom si non vides
      try { var isin = $('#isin-filter').val()||''; if (isin){ makeBadge('ISIN: '+isin, function(){ $('#isin-filter').val('').trigger('change'); }); } } catch(e) {}
      try { var nom = $('#nom-filter').val()||''; if (nom){ makeBadge('Nom: '+nom, function(){ $('#nom-filter').val('').trigger('change'); }); } } catch(e) {}
    };
    // Premier rendu badges au chargement
    try { renderBadges(); } catch(e) {}

    var $supportModal = $('#supportModal');
    var $supportModalMeta = $('#supportModalMeta');
    var $supportModalClients = $('#supportModalClients');
    var $supportModalSeries = $('#supportModalSeries');
    var $supportModalDate = $('#supportModalDate');
    var $supportModalTotal = $('#supportModalTotal');
    var $supportModalExport = $('#supportModalExport');
    var $supportModalClientFilter = $('#supportModalClientFilter');
    var $supportModalResponsableFilter = $('#supportModalResponsableFilter');
    var $supportModalAmountFilter = $('#supportModalAmountFilter');
    var $supportModalFiltersReset = $('#supportModalFiltersReset');
    var $supportModalCreateTasks = $('#supportModalCreateTasks');
    var $supportModalChartContainer = $('#supportModalChartContainer');
    var supportModalChartCanvas = document.getElementById('supportModalChart');
    var supportModalClientsData = [];
    var supportModalFilteredData = [];
    var supportModalTaskTypes = [];
    var supportModalCodeIsin = '';
    var $supportTaskModal = $('#supportTaskModal');
    var $supportTaskModalClose = $('#supportTaskModalClose');
    var $supportTaskTypeSelect = $('#supportTaskTypeSelect');
    var $supportTaskComment = $('#supportTaskComment');
    var $supportTaskSubmit = $('#supportTaskSubmit');
    var $supportTaskCancel = $('#supportTaskCancel');
    var $supportTaskStatus = $('#supportTaskStatus');
    var supportModalValuations = [];
    var supportModalChartInstance = null;
    var chartJsLoaded = false;

    function escHtml(str){
        if (str === null || str === undefined) return '';
        return String(str).replace(/[&<>"']/g, function(ch){
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]);
        });
    }

    function ensureChartJs(callback){
        if (chartJsLoaded) { callback(); return; }
        var existing = document.querySelector('script[data-loader="chartjs"]');
        if (existing) {
            existing.addEventListener('load', function(){ chartJsLoaded = true; callback(); });
            existing.addEventListener('error', function(){ console.warn('Chart.js load error'); });
            return;
        }
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js';
        script.async = true;
        script.setAttribute('data-loader', 'chartjs');
        script.onload = function(){ chartJsLoaded = true; callback(); };
        script.onerror = function(){ console.warn('Chart.js load error'); };
        document.head.appendChild(script);
    }

    function formatEuro(value){
        if (value === null || value === undefined || !isFinite(value)) return '‚Äî';
        try {
            return Number(value).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch(e){
            return String(value);
        }
    }

    function formatDateLabel(iso){
        if (!iso) return '‚Äî';
        try {
            var d = new Date(iso);
            if (!isNaN(d)) return d.toLocaleDateString('fr-FR');
        } catch(e){}
        return iso;
    }

    function bindSupportSeriesToggles(){
        if (!$supportModalSeries.length) return;
        $supportModalSeries
            .off('click.supportToggle')
            .on('click.supportToggle', '.support-series-toggle', function(){
                var $btn = $(this);
                var targetId = $btn.data('target');
                if (!targetId) return;
                var $panel = $('#' + targetId);
                if (!$panel.length) return;
                var isVisible = $panel.is(':visible');
                if (isVisible){
                    $panel.slideUp(150);
                    $btn.attr('aria-expanded', 'false');
                    $btn.attr('aria-label', 'Afficher la s√©rie');
                    $btn.find('i').attr('class', 'fa-solid fa-chevron-down');
                } else {
                    $panel.slideDown(150);
                    $btn.attr('aria-expanded', 'true');
                    $btn.attr('aria-label', 'Masquer la s√©rie');
                    $btn.find('i').attr('class', 'fa-solid fa-chevron-up');
                }
            });
    }

    function renderSupportSeriesTables(){
        if (!$supportModalSeries.length){
            return;
        }
        var html = '';
        if (supportModalValuations && supportModalValuations.length){
            var rows = supportModalValuations
                .filter(function(r){ return r && r.date; })
                .slice()
                .sort(function(a, b){ return a.date < b.date ? 1 : -1; })
                .slice(0, 20);
            if (rows.length){
                html += '<div class="series-table">';
                html += '<div class="support-series-header">';
                html += '<h4>Valeur liquidative ‚Äì 20 derni√®res observations</h4>';
                html += '<button type="button" class="support-series-toggle" data-target="seriesDaily" aria-expanded="false" aria-label="Afficher la s√©rie"><i class="fa-solid fa-chevron-down" aria-hidden="true"></i></button>';
                html += '</div>';
                html += '<div id="seriesDaily" class="series-table-body" style="display:none;">';
                html += '<table><thead><tr><th>Date</th><th>Valeur</th></tr></thead><tbody>';
                rows.forEach(function(row){
                    html += '<tr><td>' + formatDateLabel(row.date) + '</td><td>' + formatEuro(parseFloat(row.valeur)) + '</td></tr>';
                });
                html += '</tbody></table></div></div>';
            }
        }
        if (supportModalValuationsWeekly && supportModalValuationsWeekly.length){
            var wrows = supportModalValuationsWeekly
                .filter(function(r){ return r && r.week_start; })
                .slice()
                .sort(function(a, b){ return a.week_start < b.week_start ? 1 : -1; })
                .slice(0, 20);
            if (wrows.length){
                html += '<div class="series-table">';
                html += '<div class="support-series-header">';
                html += '<h4>AUM hebdomadaire ‚Äì 20 derni√®res semaines</h4>';
                html += '<button type="button" class="support-series-toggle" data-target="seriesWeekly" aria-expanded="false" aria-label="Afficher la s√©rie"><i class="fa-solid fa-chevron-down" aria-hidden="true"></i></button>';
                html += '</div>';
                html += '<div id="seriesWeekly" class="series-table-body" style="display:none;">';
                html += '<table><thead><tr><th>Semaine d√©but</th><th>Montant (‚Ç¨)</th></tr></thead><tbody>';
                wrows.forEach(function(row){
                    html += '<tr><td>' + formatDateLabel(row.week_start) + '</td><td>' + formatEuro(parseFloat(row.total_valo)) + '</td></tr>';
                });
                html += '</tbody></table></div></div>';
            }
        }
        if (!html){
            html = '<div class="series-empty">Aucune s√©rie historique disponible.</div>';
            $supportModalSeries.html(html).hide();
            return;
        }
        $supportModalSeries.html(html).show();
        bindSupportSeriesToggles();
    }

    function renderSupportModalChart(){
        var hasDaily = supportModalValuations && supportModalValuations.length;
        var hasWeekly = supportModalValuationsWeekly && supportModalValuationsWeekly.length;
        if (!hasDaily && !hasWeekly){
            alert('Aucune valeur liquidative disponible.');
            return;
        }
        if (!$supportModalChartContainer.length || !supportModalChartCanvas){
            return;
        }

        var labelsIso = [];
        var dailyValues = [];
        var rawDaily = supportModalValuations || [];
        rawDaily.forEach(function(row){
            if (!row || !row.date) return;
            var iso = String(row.date).slice(0, 10);
            labelsIso.push(iso);
            var val = parseFloat(row.valeur);
            dailyValues.push(isFinite(val) ? val : null);
        });
        if (!labelsIso.length && hasWeekly){
            (supportModalValuationsWeekly || []).forEach(function(row){
                if (!row || !row.week_start) return;
                var iso = String(row.week_start).slice(0, 10);
                labelsIso.push(iso);
                dailyValues.push(null);
            });
        }
        if (!labelsIso.length){
            alert('Aucune valeur liquidative disponible.');
            return;
        }

        var weeklyMap = {};
        (supportModalValuationsWeekly || []).forEach(function(row){
            if (!row || !row.week_start) return;
            var val = parseFloat(row.total_valo);
            weeklyMap[row.week_start] = isFinite(val) ? val : null;
        });
        function weekStartFromIso(iso){
            try {
                var d = new Date(iso);
                if (isNaN(d)) return null;
                var day = d.getDay();
                var offset = (day === 0 ? -6 : 1 - day);
                var monday = new Date(d);
                monday.setDate(d.getDate() + offset);
                return monday.toISOString().slice(0, 10);
            } catch(e){ return null; }
        }
        var weeklyValues = labelsIso.map(function(iso){
            var mondayIso = weekStartFromIso(iso);
            if (!mondayIso) return null;
            return weeklyMap.hasOwnProperty(mondayIso) ? weeklyMap[mondayIso] : null;
        });
        var weeklyValuesFiltered = weeklyValues.filter(function(val){
            return val !== null && isFinite(val);
        });
        var weeklySuggestedMax = null;
        var weeklyHardMax = null;
        var weeklyTrimmedMin = 0;
        if (weeklyValuesFiltered.length){
            var sortedWeekly = weeklyValuesFiltered.slice().sort(function(a, b){ return b - a; });
            var topCount = Math.max(1, Math.floor(sortedWeekly.length * 0.9));
            var sumTop = 0;
            for (var i = 0; i < topCount; i++){
                sumTop += sortedWeekly[i];
            }
            weeklySuggestedMax = sumTop / topCount;
            weeklyHardMax = sortedWeekly[0];
            var bottomCount = Math.max(1, Math.floor(sortedWeekly.length * 0.9));
            var bottomSlice = sortedWeekly.slice(-bottomCount);
            if (bottomSlice.length){
                weeklyTrimmedMin = bottomSlice.reduce(function(acc, val){ return acc + val; }, 0) / bottomSlice.length;
            }
        }
        var weeklyAxisMax = null;
        if (weeklyHardMax){
            weeklyAxisMax = weeklyHardMax * 1.05;
        }
        console.debug('[Support Chart] daily sample:', dailyValues.slice(0,5), 'weekly sample:', weeklyValuesFiltered.slice(0,5), 'axisMax:', weeklyAxisMax);
        if (supportModalChartInstance){
            supportModalChartInstance.destroy();
        }
        $supportModalChartContainer.show();
        var ctx = supportModalChartCanvas.getContext('2d');
        supportModalChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelsIso,
                datasets: [
                    {
                        label: 'Valeur liquidative',
                        data: dailyValues,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37,99,235,0.18)',
                        pointRadius: 0,
                        fill: true,
                        tension: 0.25,
                        yAxisID: 'y'
                    },
                    {
                        label: 'AUM',
                        type: 'bar',
                        data: weeklyValues,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249,115,22,0.35)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(ctx){
                                var val = ctx.parsed.y;
                                if (!isFinite(val)) return 'Valeur indisponible';
                                if (ctx.dataset.yAxisID === 'y1') {
                                    return (ctx.dataset.label || 'Total hebdomadaire') + ' : ' + val.toLocaleString('fr-FR') + ' ‚Ç¨';
                                }
                                return (ctx.dataset.label || 'Valeur') + ' : ' + val.toLocaleString('fr-FR');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: function(value, index){
                                var iso = labelsIso[index];
                                try {
                                    var d = new Date(iso);
                                    if (!isNaN(d)) return d.toLocaleDateString('fr-FR');
                                } catch(e){}
                                return iso;
                            }
                        }
                    },
                    y: {
                        position: 'left',
                        ticks: {
                            callback: function(value){
                                return value.toLocaleString('fr-FR');
                            }
                        }
                    },
                    y1: {
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: {
                            callback: function(value){
                                return value.toLocaleString('fr-FR') + ' ‚Ç¨';
                            }
                        },
                        min: (weeklyTrimmedMin && isFinite(weeklyTrimmedMin)) ? Math.max(0, weeklyTrimmedMin * 0.95) : 0,
                        max: (weeklyAxisMax && isFinite(weeklyAxisMax)) ? weeklyAxisMax : undefined
                    }
                }
            }
        });
        updateSansNomButtonState();
    }

    function openSupportModal(){
        $supportModal.addClass('open').attr('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    function closeSupportModal(){
        closeSupportTaskModal();
        if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
        if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
        if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
        $supportModal.removeClass('open').attr('aria-hidden', 'true');
        document.body.style.overflow = '';
        updateSansNomButtonState();
    }

    function renderSupportModalLoading(code){
        $('#supportModalTitle').text('Support ' + (code || ''));
        supportModalCodeIsin = code || '';
        $supportModalMeta.html('<div><span class="label">Chargement‚Ä¶</span><span class="value">Patientez</span></div>');
        $supportModalClients.empty();
        $supportModalDate.text('');
        $supportModalTotal.text('');
        $supportModalExport.data('export', '').prop('disabled', true).text('Exporter CSV');
        supportModalValuations = [];
        supportModalValuationsWeekly = [];
        if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
        if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
        if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
        updateSansNomButtonState();
    }

    function renderSupportModal(data){
        if (!data || !data.support){
            $supportModalMeta.html('<div><span class="label">Erreur</span><span class="value">Donn√©es introuvables</span></div>');
            $supportModalClients.empty();
            $supportModalDate.text('');
            $supportModalTotal.text('');
            $supportModalExport.prop('disabled', true);
            supportModalValuations = [];
            supportModalValuationsWeekly = [];
            if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
            if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
            return;
        }
        var s = data.support;
        var metaHtml = '';
        var fields = [
            {label: 'Code ISIN', value: s.code_isin},
            {label: 'Nom', value: s.nom},
            {label: 'Cat√©gorie principale', value: s.cat_principale || '‚Äî'},
            {label: 'Cat√©gorie d√©taill√©e', value: s.cat_det || '‚Äî'},
            {label: 'Cat√©gorie g√©n√©rique', value: s.cat_gene || '‚Äî'},
            {label: 'Zone g√©o', value: s.cat_geo || '‚Äî'},
            {label: 'Promoteur', value: s.promoteur || '‚Äî'},
            {label: 'SRRI', value: (s.SRRI !== null && s.SRRI !== undefined) ? s.SRRI : '‚Äî'}
        ];
        fields.forEach(function(item){
            metaHtml += '<div><span class="label">' + item.label + '</span><span class="value">' + item.value + '</span></div>';
        });
        metaHtml += '<button type="button" class="support-meta-btn" id="supportSansNomBtn" aria-pressed="false"><i class="fa-solid fa-chart-line" aria-hidden="true"></i><span>Graphiques</span></button>';
        $supportModalMeta.html(metaHtml);
        var sansNomBtn = document.getElementById('supportSansNomBtn');
        if (sansNomBtn){
            sansNomBtn.addEventListener('click', function(){
                toggleSupportChart();
            });
        }
        $supportModalMeta.closest('.support-modal__panel').find('.support-modal__graph-row').remove();
        $supportModalMeta.closest('.support-modal__panel').find('.support-modal__actions').before(
            '<div class="support-modal__graph-row" style="display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-bottom:1rem;"></div>'
        );
        supportModalValuations = Array.isArray(data.valuations) ? data.valuations.filter(function(v){ return v && v.date; }) : [];
        if (supportModalValuations.length){
            supportModalValuations = supportModalValuations.slice().sort(function(a,b){
                var da = a.date || '';
                var db = b.date || '';
                if (da < db) return -1;
                if (da > db) return 1;
                return 0;
            });
        }
        supportModalValuationsWeekly = Array.isArray(data.valuations_weekly) ? data.valuations_weekly.filter(function(v){ return v && v.week_start; }) : [];
        if (supportModalValuationsWeekly.length){
            supportModalValuationsWeekly = supportModalValuationsWeekly.slice().sort(function(a,b){
                var da = a.week_start || '';
                var db = b.week_start || '';
                if (da < db) return -1;
                if (da > db) return 1;
                return 0;
            });
        }
        if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
        if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
        if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
        var hasGraphData = (supportModalValuations && supportModalValuations.length) || (supportModalValuationsWeekly && supportModalValuationsWeekly.length);
        if (sansNomBtn){
            sansNomBtn.disabled = !hasGraphData;
        }
        updateSansNomButtonState();
        renderSupportSeriesTables();
        $('#supportModalTitle').text('Support ' + (s.code_isin || ''));
        $supportModalDate.text(data.last_date ? ('Date : ' + data.last_date) : '');
        var totalText = data.total_valo_str ? (data.total_valo_str + ' ‚Ç¨') : '0 ‚Ç¨';
        $supportModalTotal.text('Total valorisation : ' + totalText);
        $supportModalExport.data('export', data.csv_url || '').prop('disabled', !data.csv_url);
        supportModalTaskTypes = Array.isArray(data.task_types) ? data.task_types : [];
        supportModalCodeIsin = s.code_isin || '';
        populateSupportTaskTypeSelect(data.default_type_id);
        supportModalClientsData = Array.isArray(data.clients) ? data.clients.slice() : [];
        supportModalFilteredData = supportModalClientsData.slice();
        var hasTaskTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
        $supportModalCreateTasks.prop('disabled', !hasTaskTypes);
        $supportModalClientFilter.val('');
        $supportModalResponsableFilter.val('');
        $supportModalAmountFilter.val('');
        renderSupportModalTable();
    }

    function renderSupportModalTable(){
        if (!supportModalClientsData.length){
            supportModalFilteredData = [];
            $supportModalClients.html('<div class="support-modal__empty">Aucun client ne d√©tient ce support √† la date s√©lectionn√©e.</div>');
            var hasTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
            $supportModalCreateTasks.prop('disabled', !hasTypes);
            return;
        }
        var filters = getSupportModalFilters();
        var filtered = supportModalClientsData.filter(function(row){
            return matchesClientFilters(row, filters);
        });
        supportModalFilteredData = filtered;
        var hasEligible = filtered.some(function(client){ return client && client.client_id; });
        var hasTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
        $supportModalCreateTasks.prop('disabled', !(hasEligible && hasTypes));
        var rowsHtml = filtered.map(function(client){
            var label = ((client.nom || '') + ' ' + (client.prenom || '')).trim();
            if (!label) label = client.nom || client.prenom || 'Client';
            var href = client.client_id ? ('/dashboard/clients/' + client.client_id) : '#';
            var cell = client.client_id ? '<a href="' + href + '" target="_blank" rel="noopener noreferrer">' + label + '</a>' : label;
            return '<tr>' +
                '<td>' + cell + '</td>' +
                '<td>' + (client.responsable || '‚Äî') + '</td>' +
                '<td>' + (client.total_valo_str || '0') + ' ‚Ç¨</td>' +
            '</tr>';
        }).join('');
        if (!rowsHtml){
            supportModalFilteredData = filtered;
            $supportModalClients.html('<div class="support-modal__empty">Aucun r√©sultat ne correspond aux filtres.</div>');
            return;
        }
        var tableHtml = '<table>' +
            '<thead><tr><th>Client</th><th>Responsable</th><th>Valorisation</th></tr></thead>' +
            '<tbody>' + rowsHtml + '</tbody></table>';
        $supportModalClients.html(tableHtml);
    }

    function getSupportModalFilters(){
        return {
            client: ($supportModalClientFilter.val() || '').trim().toLowerCase(),
            responsable: ($supportModalResponsableFilter.val() || '').trim().toLowerCase(),
            amount: ($supportModalAmountFilter.val() || '').trim().toLowerCase()
        };
    }

    function parseAmount(value){
        if (value == null) return NaN;
        var str = String(value).trim().toLowerCase();
        if (!str) return NaN;
        str = str.replace(/\s+/g, '').replace(',', '.');
        var multiplier = 1;
        if (str.endsWith('k')) { multiplier = 1e3; str = str.slice(0,-1); }
        if (str.endsWith('m')) { multiplier = 1e6; str = str.slice(0,-1); }
        var num = parseFloat(str);
        if (!isFinite(num)) return NaN;
        return num * multiplier;
    }

    function matchesAmount(amount, filter){
        if (!filter) return true;
        var val = parseAmount(amount);
        if (!isFinite(val)) return false;
        var expressions = filter.split(/[,;]+/).map(function(exp){ return exp.trim(); }).filter(Boolean);
        if (!expressions.length) expressions = [filter];
        return expressions.every(function(expr){
            if (!expr) return true;
            var range = expr.match(/^([<>]=?|=)?\s*([^<>=]+)$/);
            var between = expr.match(/^([^\-]+)\s*-\s*([^\-]+)$/);
            if (between){
                var a = parseAmount(between[1]);
                var b = parseAmount(between[2]);
                if (!isFinite(a) || !isFinite(b)) return true;
                var min = Math.min(a,b), max = Math.max(a,b);
                return val >= min && val <= max;
            }
            if (range){
                var op = range[1] || '=';
                var num = parseAmount(range[2]);
                if (!isFinite(num)) return true;
                switch(op){
                    case '>': return val > num;
                    case '>=': return val >= num;
                    case '<': return val < num;
                    case '<=': return val <= num;
                    case '=': default: return val === num;
                }
            }
            var num = parseAmount(expr);
            if (isFinite(num)) return val === num;
            return true;
        });
    }

    function matchesClientFilters(client, filters){
        if (filters.client){
            var label = ((client.nom || '') + ' ' + (client.prenom || '')).trim().toLowerCase();
            if (label.indexOf(filters.client) === -1) return false;
        }
        if (filters.responsable){
            var resp = (client.responsable || '').toLowerCase();
            if (resp.indexOf(filters.responsable) === -1) return false;
        }
        if (filters.amount){
            if (!matchesAmount(client.total_valo, filters.amount)) return false;
        }
        return true;
    }

    function populateSupportTaskTypeSelect(defaultId){
        var groups = Array.isArray(supportModalTaskTypes) ? supportModalTaskTypes : [];
        var html = '';
        if (!groups.length){
            html = '<option value="">-- Aucun type disponible --</option>';
        } else {
            var multipleGroups = groups.length > 1;
            groups.forEach(function(group){
                var types = Array.isArray(group.types) ? group.types : [];
                if (!types.length) return;
                if (multipleGroups){
                    html += '<optgroup label="' + escHtml(group.label || group.categorie || 'T√¢che') + '">';
                }
                types.forEach(function(entry){
                    if (entry.id == null) return;
                    html += '<option value="' + escHtml(entry.id) + '">' + escHtml(entry.libelle || ('Type #' + entry.id)) + '</option>';
                });
                if (multipleGroups){
                    html += '</optgroup>';
                }
            });
            if (!html){
                html = '<option value="">-- Aucun type disponible --</option>';
            }
        }
        $supportTaskTypeSelect.html(html);
        if (defaultId != null && $supportTaskTypeSelect.find('option[value="' + defaultId + '"]').length){
            $supportTaskTypeSelect.val(String(defaultId));
        }
        if (!$supportTaskTypeSelect.val()){
            var first = $supportTaskTypeSelect.find('option[value!=""]').first();
            if (first.length){
                $supportTaskTypeSelect.val(first.val());
            }
        }
        var hasTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
        var hasEligible = (supportModalFilteredData || []).some(function(client){ return client && client.client_id; });
        $supportModalCreateTasks.prop('disabled', !(hasTypes && hasEligible));
    }

    function openSupportTaskModal(){
        var eligible = (supportModalFilteredData || []).filter(function(client){ return client && client.client_id; });
        if (!eligible.length){
            alert('Aucun client s√©lectionn√© pour cr√©er des t√¢ches.');
            return;
        }
        populateSupportTaskTypeSelect($supportTaskTypeSelect.val());
        $supportTaskComment.val('');
        $supportTaskStatus.text(eligible.length + ' client(s) s√©lectionn√©(s).');
        $supportTaskSubmit.prop('disabled', false).text('Cr√©er les t√¢ches');
        $supportTaskModal.addClass('open').attr('aria-hidden', 'false');
    }

    function closeSupportTaskModal(){
        $supportTaskModal.removeClass('open').attr('aria-hidden', 'true');
        $supportTaskStatus.text('');
    }

    function submitSupportTasks(){
        var eligible = (supportModalFilteredData || []).filter(function(client){ return client && client.client_id; });
        if (!eligible.length){
            $supportTaskStatus.text('Aucun client s√©lectionn√©.');
            return;
        }
        var typeId = $supportTaskTypeSelect.val();
        if (!typeId){
            $supportTaskStatus.text('S√©lectionnez un type de t√¢che.');
            return;
        }
        var uniqueIds = [];
        eligible.forEach(function(client){
            if (uniqueIds.indexOf(client.client_id) === -1){
                uniqueIds.push(client.client_id);
            }
        });
        var payload = {
            code_isin: supportModalCodeIsin,
            client_ids: uniqueIds,
            type_id: typeId,
            commentaire: $supportTaskComment.val() || ''
        };
        $supportTaskSubmit.prop('disabled', true).text('Cr√©ation...');
        $supportTaskStatus.text('Cr√©ation des t√¢ches en cours...');
        fetch('/dashboard/supports/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(function(resp){
            if (!resp.ok){
                return resp.json().catch(function(){ return {detail: 'Erreur ' + resp.status}; }).then(function(err){ throw err; });
            }
            return resp.json();
        }).then(function(result){
            $supportTaskStatus.text(result.message || 'T√¢ches cr√©√©es.');
            setTimeout(function(){
                closeSupportTaskModal();
            }, 1200);
        }).catch(function(err){
            var msg = err && (err.detail || err.message) ? (err.detail || err.message) : 'Erreur lors de la cr√©ation.';
            $supportTaskStatus.text(msg);
        }).finally(function(){
            $supportTaskSubmit.prop('disabled', false).text('Cr√©er les t√¢ches');
        });
    }

    $('#supportsTable tbody').on('click', 'a.support-link', function(e){
        e.preventDefault();
        var code = $(this).data('isin');
        if (!code) return;
        openSupportModal();
        renderSupportModalLoading(code);
        fetch('/dashboard/supports/details?code_isin=' + encodeURIComponent(code))
            .then(function(resp){
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                return resp.json();
            })
            .then(function(data){
                console.debug('Support details total_valo:', data?.total_valo, 'clients_total_valo:', data?.clients_total_valo);
                renderSupportModal(data);
            })
            .catch(function(err){
                $supportModalMeta.html('<div><span class="label">Erreur</span><span class="value">' + (err.message || 'Impossible de r√©cup√©rer les donn√©es') + '</span></div>');
                $supportModalClients.empty();
                $supportModalExport.prop('disabled', true);
                supportModalValuations = [];
                if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
                if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
                if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
            });
    });

    $('#supportModalClose').on('click', function(){ closeSupportModal(); });
    $supportModal.on('click', function(e){ if (e.target === this) { closeSupportModal(); } });
    $(document).on('keyup', function(e){
        if (e.key === 'Escape'){
            if ($supportTaskModal.hasClass('open')) { closeSupportTaskModal(); return; }
            closeSupportModal();
        }
    });
    $supportModalExport.on('click', function(){
        var url = $(this).data('export');
        if (!url) return;
        window.location.href = url;
    });

    function scheduleModalReRender(){
        clearTimeout(scheduleModalReRender._id);
        scheduleModalReRender._id = setTimeout(renderSupportModalTable, 120);
    }
    $supportModalClientFilter.on('input', scheduleModalReRender);
    $supportModalResponsableFilter.on('input', scheduleModalReRender);
    $supportModalAmountFilter.on('input', scheduleModalReRender);
    $supportModalFiltersReset.on('click', function(){
        $supportModalClientFilter.val('');
        $supportModalResponsableFilter.val('');
        $supportModalAmountFilter.val('');
        renderSupportModalTable();
    });
    $supportModalCreateTasks.on('click', function(){ if ($(this).prop('disabled')) return; openSupportTaskModal(); });
    $supportTaskCancel.on('click', function(){ closeSupportTaskModal(); });
    $supportTaskModalClose.on('click', function(){ closeSupportTaskModal(); });
    $supportTaskModal.on('click', function(e){ if (e.target === this) { closeSupportTaskModal(); } });
    $supportTaskSubmit.on('click', function(){ submitSupportTasks(); });
});
</script>

{% endblock %}
