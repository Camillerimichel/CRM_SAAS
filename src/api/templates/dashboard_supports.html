{% extends "base.html" %}
{% block title %}Supports{% endblock %}
{% block header_title %}
<span class="header-title-line">
  <span class="header-title-text"><i class="fa-solid fa-chart-pie" style="margin-right:8px;"></i>Supports</span>
  <span class="header-title-meta">
    <span class="meta-item">Total : {{ total_supports }}</span>
    <span class="meta-sep">‚Ä¢</span>
    <span class="meta-item">Date : <span class="js-local-dt" data-iso="{{ last_date }}">{{ last_date }}</span></span>
  </span>
</span>
{% endblock %}
{% block content %}

<style>
    .header-title-line { display: inline-flex; align-items: center; gap: 10px; color: #0f172a; }
    .header-title-text { font-weight: 800; font-size: 1.1rem; display:inline-flex; align-items:center; gap:8px; }
    .header-title-meta { display:inline-flex; align-items:center; gap:8px; font-weight:600; font-size:0.95rem; color:#0f172a; }
    .header-title-meta .meta-sep { color:#94a3b8; }
    .main-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 2rem;
        margin: 2rem auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        table-layout: fixed; /* respecter les largeurs de colonnes */
    }
    /* En-t√™tes de tableau h√©ritent du style global (base.html) */
    thead input, thead select {
        width: 100%;
        padding: 4px 6px; /* champs plus compacts */
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 12px; /* police r√©duite */
    }
    tbody td {
        padding: 6px 6px; /* cellules plus compactes */
        line-height: 1.2;
        font-size: 12px;
        white-space: nowrap; /* √©vite les retours √† la ligne */
    }

    /* Ajustement des largeurs de colonnes pour mieux r√©partir l'espace */
    /* Colonnes: 1=ISIN, 2=Nom, 3=Cat√©gorie, 4=Zone, 5=SRRI, 6=Valo */
    #supportsTable th:nth-child(1),
    #supportsTable td:nth-child(1) { /* Code ISIN */
        width: 14%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #supportsTable th:nth-child(2),
    #supportsTable td:nth-child(2) { /* Nom */
        width: 26%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #supportsTable th:nth-child(4),
    #supportsTable td:nth-child(4) { /* Zone g√©o */
        width: 20%;
    }
    #supportsTable th:nth-child(5),
    #supportsTable td:nth-child(5) { /* SRRI */
        width: 10%;
        text-align: center;
    }
    .valo-amount {
        font-weight: 600;
        color: #28a745;
        text-align: right;
        font-family: monospace;
    }
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .restore-note { display:none; font-size:12px; color:#666; margin: 2px 0 6px 0; }
    .restore-note .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2f7; border:1px solid #dde3ea; color:#445; font-weight:600; }
    .restore-note .badge a.close { margin-left:6px; text-decoration:none; color:#445; font-weight:700; cursor:pointer; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin: .5rem 0 8px 0; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: var(--surface); cursor:pointer; font-size:12px; color: var(--text); text-decoration:none; }
    .chip:hover { background: var(--primary-100); color: var(--primary-600); }
    .clear-btn {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    /* Badges actifs */
    .badge-filter { display:inline-flex; align-items:center; gap:6px; background:#eef2ff; color:#1d4ed8; border:1px solid #c7d2fe; border-radius:999px; padding:4px 10px; font-size:.85rem; }
    .badge-filter .x { color:#1d4ed8; text-decoration:none; opacity:.85; }
    .badge-filter .x:hover { opacity:1; }
    .badge-row { display:flex; gap:6px; flex-wrap:wrap; margin:.25rem 0 .5rem 0; }
    .support-modal { position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center; background:rgba(15,23,42,0.55); z-index:1000; padding:4rem 1rem 2rem; overflow-y:auto; }
    .support-modal.open { display:flex; }
    .support-modal__panel { background:#fff; border-radius:12px; box-shadow:0 20px 40px rgba(15,23,42,0.25); max-width:720px; width:100%; padding:1.5rem; position:relative; }
    .support-modal__close { position:absolute; top:12px; right:12px; border:none; background:transparent; font-size:1.5rem; cursor:pointer; color:#334155; }
    .support-modal__title { margin-top:0; margin-bottom:0.5rem; }
    .support-modal__meta { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.5rem 1rem; font-size:0.9rem; margin-bottom:1rem; }
    .support-modal__meta div { background:#f8fafc; border-radius:8px; padding:0.6rem 0.75rem; }
    .support-modal__meta span { display:block; }
    .support-modal__meta .label { color:#64748b; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.06em; }
    .support-modal__meta .value { font-weight:600; color:#1f2937; }
    .support-meta-srri { display:flex; align-items:center; gap:10px; }
    .support-meta-srri .label { display:inline; margin:0; }
    .support-meta-btn { background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.6rem 0.75rem; font-weight:600; color:#1f2937; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:0.5rem; transition:background .2s ease, color .2s ease, border-color .2s ease, transform .12s ease; font-size:0.9rem; min-width:180px; white-space:nowrap; transform: scale(1); will-change: transform; }
    .support-meta-btn i { color:inherit; }
    .support-meta-btn:hover,
    .support-meta-btn:focus-visible { background:#e2e8f0; border-color:#cbd5f5; transform: scale(1.04); }
    .support-meta-btn.active,
    .support-meta-btn:active { background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 6px 14px rgba(37,99,235,0.25); transform: scale(1.04); }
    .support-meta-btn.active i { color:#fff; }
    .support-modal__clients { margin-top:1rem; }
    .support-modal__clients table { width:100%; border-collapse:collapse; }
    .support-modal__clients th, .support-modal__clients td { padding:0.5rem 0.6rem; border-bottom:1px solid #e2e8f0; text-align:left; font-size:0.9rem; }
    .support-modal__clients td:last-child, .support-modal__clients th:last-child { text-align:right; font-variant-numeric:tabular-nums; }
    .support-modal__empty { margin-top:1rem; color:#64748b; font-style:italic; }
    .support-modal__pager { display:flex; align-items:center; gap:8px; justify-content:flex-end; margin-top:6px; font-size:0.9rem; }
    .support-modal__pager button { padding:4px 8px; border:1px solid #cbd5f5; border-radius:6px; background:#f8fafc; cursor:pointer; }
    .support-modal__pager button:disabled { opacity:0.5; cursor:not-allowed; }
    .support-modal__actions { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:0.5rem; }
    .support-modal__actions button { background:var(--primary); color:#fff; border:none; border-radius:8px; padding:0.45rem 0.9rem; cursor:pointer; font-weight:600; transition:filter .2s ease; }
    .support-modal__actions button:hover { filter:brightness(0.9); }
    .support-modal__filters { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.75rem; margin-top:1.2rem; align-items:flex-end; }
    .support-modal__filters label { display:block; font-size:0.75rem; font-weight:600; color:#475569; text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.25rem; }
    .support-modal__filters input { width:100%; border:1px solid #cbd5f5; border-radius:6px; padding:0.45rem 0.5rem; font-size:0.88rem; }
    .support-modal__filters button { margin-top:1.65rem; background:#e2e8f0; border:none; border-radius:6px; padding:0.45rem 0.75rem; font-weight:600; color:#334155; cursor:pointer; transition:background .2s ease; }
    .support-modal__filters button:hover { background:#cbd5f5; }
    .support-modal__actions-group { display:flex; gap:0.5rem; align-items:center; }
    .support-modal__actions-group button:nth-child(2) { background:#6366f1; }
    .support-modal__actions-group button:nth-child(2):hover { filter:brightness(0.9); }
    .support-modal__actions-group button:disabled { opacity:0.45; cursor:not-allowed; filter:none; }
    .support-modal__chart { display:none; margin-top:1rem; background:#f8fafc; border-radius:12px; padding:1rem; box-shadow:0 12px 32px rgba(15,23,42,0.12); }
    .support-modal__chart canvas { width:100%; height:260px; }
    .support-modal__series { display:none; margin-top:1rem; background:#fff; border-radius:12px; box-shadow:0 12px 32px rgba(15,23,42,0.08); padding:1rem; }
    .support-series-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:0.6rem; }
    .support-series-header h4 { margin:0; font-size:0.95rem; color:#1f2937; }
    .support-series-toggle { background:transparent; border:1px solid #cbd5f5; border-radius:6px; padding:0.2rem 0.6rem; font-size:0.82rem; font-weight:600; color:#2563eb; cursor:pointer; transition:background .2s ease, color .2s ease; }
    .support-series-toggle:hover { background:#dbeafe; color:#1d4ed8; }
    .support-modal__series table { width:100%; border-collapse:collapse; font-size:0.85rem; }
    .support-modal__series th,
    .support-modal__series td { border:1px solid #e2e8f0; padding:0.45rem 0.5rem; text-align:left; }
    .support-modal__compare-toggle { display:flex; align-items:center; gap:8px; justify-content:flex-start; flex-wrap:nowrap; padding:8px 0 10px; margin:8px 0 10px; width:100%; box-sizing:border-box; }
    .support-modal__compare-toggle .support-meta-btn { flex:1 1 0; min-width:0; justify-content:center; }
    .support-modal__series th { background:#f1f5f9; font-weight:600; color:#334155; }
.support-modal__series .series-table { margin-bottom:1rem; }
.support-modal__series .series-empty { font-style:italic; color:#64748b; font-size:0.85rem; }
.support-srri-status { font-size:0.85rem; color:#475569; margin-left:6px; }
    .support-task-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,23,42,0.55); z-index:1200; padding:2rem 1rem; }
    .support-task-modal.open { display:flex; }
    .support-task-modal__panel { background:#fff; border-radius:12px; box-shadow:0 24px 48px rgba(15,23,42,0.35); max-width:460px; width:100%; padding:1.5rem; position:relative; }
    .support-task-modal__close { position:absolute; top:12px; right:12px; border:none; background:transparent; font-size:1.4rem; cursor:pointer; color:#475569; }
    .support-task-modal__title { margin-top:0; margin-bottom:0.75rem; }
    .support-task-modal__form label { display:block; font-size:0.8rem; font-weight:600; color:#475569; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.3rem; }
    .support-task-modal__form select,
    .support-task-modal__form textarea { width:100%; border:1px solid #cbd5f5; border-radius:8px; padding:0.55rem 0.6rem; font-size:0.95rem; }
    .support-task-modal__form textarea { resize:vertical; min-height:96px; }
    .support-task-modal__footer { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:1.2rem; }
    .support-task-modal__footer button { border:none; border-radius:8px; padding:0.55rem 1rem; font-weight:600; cursor:pointer; transition:filter .2s ease; }
    #supportTaskSubmit { background:#16a34a; color:#fff; }
    #supportTaskSubmit:hover { filter:brightness(0.9); }
    #supportTaskCancel { background:#e2e8f0; color:#334155; }
    #supportTaskCancel:hover { filter:brightness(0.9); }
    #supportTaskStatus { font-size:0.85rem; color:#475569; margin-top:0.75rem; min-height:1.2rem; }
    .dim-btn { padding:4px 8px; border:1px solid #cbd5f5; border-radius:8px; background:#f8fafc; cursor:pointer; font-size:12px; transition:background .15s ease, color .15s ease, border-color .15s ease; }
    .dim-btn.active { background: var(--primary); color:#fff; border-color: var(--primary); }
</style>

<div class="main-container">
    <div id="sup_active_badges" class="badge-row"></div>

    <div class="table-container">
        <div id="restoreSupports" class="restore-note"><span class="badge">Filtres restaur√©s <a href="#" class="close" onclick="return resetRestoredSupports()">√ó</a></span></div>
        <div id="quickToggleSup" class="card accordion-toggle" style="margin-bottom:.5rem; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;">
            <h3 style="margin:0; font-size:1.05rem;">Filtres rapides</h3>
            <span class="chevron">‚ñæ</span>
        </div>
        <div id="quickSectionSup" style="display:none;">
        <div class="toolbar">
            <div class="chips" id="supportChips">
                <span style="color:#666; font-size:12px; margin-right:4px;">Raccourcis:</span>
                <a class="chip" href="#" onclick="return chipSrri('')">SRRI: Tous</a>
                <a class="chip" href="#" onclick="return chipSrri('1')">SRRI: 1</a>
                <a class="chip" href="#" onclick="return chipSrri('2')">SRRI: 2</a>
                <a class="chip" href="#" onclick="return chipSrri('3')">SRRI: 3</a>
                <a class="chip" href="#" onclick="return chipSrri('4')">SRRI: 4</a>
                <a class="chip" href="#" onclick="return chipSrri('5')">SRRI: 5</a>
                <a class="chip" href="#" onclick="return chipSrri('6')">SRRI: 6</a>
                <a class="chip" href="#" onclick="return chipSrri('7')">SRRI: 7</a>
            </div>
        </div>
        </div>
        <table id="supportsTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>Code ISIN</th>
                    <th>Nom</th>
                    <th>Cat√©gorie</th>
                    <th>Zone G√©o</th>
                    <th>SRRI</th>
                    <th style="text-align:right;">Valo Total</th>
                </tr>
                <tr>
                    <th><input type="text" id="isin-filter" placeholder="Filtrer..."></th>
                    <th><input type="text" id="nom-filter" placeholder="Filtrer..."></th>
                    <th><select id="categorie-filter" multiple size="6"><option value="">Aucun</option></select></th>
                    <th><select id="zone-filter" multiple size="6"><option value="">Aucun</option></select></th>
                    <th><select id="srri-filter" multiple size="6"><option value="">Aucun</option></select></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for s in supports %}
                <tr>
                    <td><a href="#" class="support-link" data-isin="{{ s.code_isin }}">{{ s.code_isin }}</a></td>
                    <td>{{ s.nom }}</td>
                    <td>{{ s.categorie }}</td>
                    <td>{{ s.zone_geo }}</td>
                    <td>{{ s.SRRI }}</td>
                    <td class="valo-amount">{{ s.total_valo }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div id="results-info">Astuce: maintenez Ctrl/Cmd pour une s√©lection multiple dans les listes.</div>
        <button class="clear-btn" onclick="clearFilters()">üóëÔ∏è Effacer</button>
    </div>
</div>

<div id="supportModal" class="support-modal" aria-hidden="true">
  <div class="support-modal__panel" role="dialog" aria-modal="true" aria-labelledby="supportModalTitle">
    <button type="button" class="support-modal__close" id="supportModalClose" aria-label="Fermer">√ó</button>
    <h2 class="support-modal__title" id="supportModalTitle">Support</h2>
    <div class="support-modal__actions" style="margin:4px 0 10px 0;">
      <div>
        <span id="supportModalDate" style="color:#475569; font-size:0.85rem;"></span><br>
        <strong id="supportModalTotal" style="font-size:1rem; color:#111827;"></strong>
      </div>
    </div>
    <div class="support-modal__meta" id="supportModalMeta"></div>
    <div class="support-modal__compare-toggle">
      <button type="button" id="supportCompareToggle" class="support-meta-btn">
        <i class="fa-solid fa-code-branch" aria-hidden="true"></i>
        <span>Comparaisons (VL base 100)</span>
      </button>
      <button type="button" id="supportEsgToggle" class="support-meta-btn">
        <i class="fa-solid fa-leaf" aria-hidden="true"></i>
        <span>ESG (base 100)</span>
      </button>
      <button type="button" id="supportClientsToggle" class="support-meta-btn">
        <i class="fa-solid fa-users" aria-hidden="true"></i>
        <span>Clients</span>
      </button>
      <span id="supportCompareStatus" class="muted" style="font-size:0.85rem;"></span>
    </div>
    <div id="supportCompareSection" style="display:none; margin-top:6px; border:1px solid #e2e8f0; border-radius:10px; padding:10px; background:#f8fafc;">
      <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;">
        <label for="supportCompareInput" style="font-size:0.85rem; color:#475569;">Comparer avec</label>
        <input type="text" id="supportCompareInput" list="supportCompareOptions" placeholder="ISIN ou nom partiel" style="flex:1 1 260px; min-width:220px; border:1px solid #cbd5f5; border-radius:8px; padding:0.45rem 0.6rem; font-size:0.95rem;" />
        <datalist id="supportCompareOptions"></datalist>
        <button type="button" id="supportCompareBtn" class="support-meta-btn" style="height:40px;"><i class="fa-solid fa-chart-line" aria-hidden="true"></i><span>Lancer</span></button>
      </div>
      <div class="support-modal__chart" id="supportCompareChartContainer" style="display:none;">
        <canvas id="supportCompareChart"></canvas>
      </div>
    </div>
    <div id="supportEsgSection" style="display:none; margin-top:6px; border:1px solid #e2e8f0; border-radius:10px; padding:10px; background:#f8fafc;">
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-bottom:8px;">
        <div style="flex:1 1 240px; min-width:220px;">
          <label class="muted" style="font-size:0.85rem;">Allocation de r√©f√©rence</label><br>
          <select id="supportEsgAlloc" style="width:100%; border:1px solid #cbd5f5; border-radius:8px; padding:0.45rem 0.6rem; font-size:0.95rem;">
            <option value="">‚Äî choisir ‚Äî</option>
          </select>
        </div>
        <div>
          <button id="supportEsgRefresh" class="support-meta-btn" type="button" style="height:40px;"><span>Actualiser</span></button>
        </div>
      </div>
      <div style="margin-bottom:8px;">
        <label class="muted" style="font-size:0.85rem;">Champs ESG (max 4)</label>
        <div id="supportEsgFields" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:4px;"></div>
      </div>
      <div id="supportEsgChart" style="height:320px; width:100%; display:none;"></div>
      <div id="supportEsgUnmatched" class="muted" style="margin-top:6px; font-size:12px; display:none;"></div>
      <div class="muted" style="margin-top:4px; font-size:12px;">Indice de r√©f√©rence normalis√© √† 100. Support = (Support / Indice) √ó 100.</div>
    </div>
    <div id="supportSrriSection" style="display:none; margin-top:6px; border:1px solid #e2e8f0; border-radius:10px; padding:10px; background:#f8fafc;">
      <div class="support-modal__chart" id="supportSrriChartContainer" style="display:none; margin-bottom:8px;">
        <canvas id="supportSrriChart"></canvas>
      </div>
      <div class="support-modal__series" id="supportSrriTable" style="display:none;"></div>
    </div>
    <div class="support-modal__chart" id="supportModalChartContainer">
      <canvas id="supportModalChart"></canvas>
    </div>
    <div class="support-modal__series" id="supportModalSeries"></div>
    <div id="supportClientsSection">
      <div class="support-modal__filters">
        <div>
          <label for="supportModalClientFilter">Client</label>
          <input type="text" id="supportModalClientFilter" placeholder="Rechercher client" />
        </div>
        <div>
          <label for="supportModalResponsableFilter">Responsable</label>
          <input type="text" id="supportModalResponsableFilter" placeholder="Rechercher responsable" />
        </div>
        <div>
          <label for="supportModalAmountFilter">Valorisation</label>
          <input type="text" id="supportModalAmountFilter" placeholder=">100k, 100k-500k" />
        </div>
        <button type="button" id="supportModalFiltersReset">R√©initialiser</button>
      </div>
      <div class="support-modal__pager" id="supportClientsPager" style="display:none;">
        <button type="button" id="supportClientsPrev">Pr√©c√©dent</button>
        <span id="supportClientsPageInfo">Page 1/1</span>
        <button type="button" id="supportClientsNext">Suivant</button>
      </div>
      <div class="support-modal__clients" id="supportModalClients"></div>
    </div>
  </div>
</div>

<div id="supportTaskModal" class="support-task-modal" aria-hidden="true">
  <div class="support-task-modal__panel" role="dialog" aria-modal="true" aria-labelledby="supportTaskModalTitle">
    <button type="button" class="support-task-modal__close" id="supportTaskModalClose" aria-label="Fermer">√ó</button>
    <h3 class="support-task-modal__title" id="supportTaskModalTitle">Cr√©er des t√¢ches</h3>
    <div class="support-task-modal__form">
      <div style="margin-bottom:0.9rem;">
        <label for="supportTaskTypeSelect">Type de t√¢che</label>
        <select id="supportTaskTypeSelect"></select>
      </div>
      <div>
        <label for="supportTaskComment">Commentaire</label>
        <textarea id="supportTaskComment" placeholder="Commentaire (optionnel)"></textarea>
      </div>
    </div>
    <div id="supportTaskStatus"></div>
    <div class="support-task-modal__footer">
      <button type="button" id="supportTaskCancel">Annuler</button>
      <button type="button" id="supportTaskSubmit">Cr√©er les t√¢ches</button>
    </div>
  </div>
</div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- FixedHeader -->
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
$(document).ready(function () {
    var table = $('#supportsTable').DataTable({
        order: [[5, "desc"]],
        pageLength: 25,
        fixedHeader: true,
        columnDefs: [
            {
                targets: 5, // colonne Valo Total
                render: $.fn.dataTable.render.number(' ', ',', 0, '')
            }
        ],
        initComplete: function () {
            var api = this.api();

            // remplir selects avec valeurs uniques et filtrage multi
            api.columns([2,3,4]).every(function () {
                var column = this;
                var idx = column.index();
                var select = $('#supportsTable thead tr:eq(1) th').eq(idx).find('select');

                // option 'Aucun'
                if (select.find('option[value=""]').length === 0) {
                    select.append('<option value="">Aucun</option>');
                }
                column.data().unique().sort().each(function (d) {
                    if (d) select.append('<option value="'+d+'">'+d+'</option>');
                });

                // Permet de s√©lectionner/d√©s√©lectionner plusieurs options par simple clic (sans Ctrl/Cmd)
                select.on('mousedown', 'option', function(e){
                    e.preventDefault();
                    var $opt = $(this);
                    var $sel = $opt.parent();
                    var wasSelected = $opt.prop('selected');
                    if ($opt.val() === '') {
                        // Si 'Aucun' est cliqu√©: on vide tout et on ne garde que 'Aucun'
                        $sel.find('option').prop('selected', false);
                        $opt.prop('selected', true);
                    } else {
                        // Si une vraie valeur est cliqu√©e: on enl√®ve 'Aucun' et on toggle cette valeur
                        $sel.find('option[value=""]').prop('selected', false);
                        $opt.prop('selected', !wasSelected);
                    }
                    $sel.trigger('change');
                    return false;
                });

                select.on('change', function () {
                    var vals = $(this).val() || [];
                    // Si 'Aucun' est s√©lectionn√©, on nettoie le filtre
                    if (vals.length === 0 || (vals.length === 1 && vals[0] === '')) {
                        column.search('').draw();
                    } else {
                        var pattern = vals.map($.fn.dataTable.util.escapeRegex).join('|');
                        column.search(pattern, true, false).draw();
                    }
                    // Mettre √† jour l'URL
                    try {
                        var params = new URLSearchParams(window.location.search);
                        var key = (idx===2?'categorie':(idx===3?'zone':'srri'));
                        var filtered = (vals||[]).filter(v=>v && v!=='');
                        if (filtered.length) params.set(key, filtered.join(',')); else params.delete(key);
                        var newUrl = window.location.pathname + (params.toString()?('?'+params.toString()):'');
                        window.history.replaceState({}, '', newUrl);
                    } catch(e) {}
                    // Sauver √©tat
                    try { saveSupportsState(); } catch(e) {}
                    // Badges actifs
                    try { renderBadges(); } catch(e) {}
                });
            });

            // Injecter chips dynamiques pour Cat√©gorie/Zone apr√®s remplissage
            try {
                var chips = document.getElementById('supportChips');
                function addChip(label, handler){ var a=document.createElement('a'); a.className='chip'; a.href='#'; a.textContent=label; a.onclick=function(){ return handler(); }; chips.appendChild(a); }
                addChip('Cat√©gorie: Tous', function(){ $('#categorie-filter').val(['']).trigger('change'); return false; });
                $('#categorie-filter option').each(function(){ var v=$(this).val(); if(v){ addChip('Cat√©gorie: '+v, function(){ $('#categorie-filter').val([v]).trigger('change'); return false; }); }});
                addChip('Zone: Tous', function(){ $('#zone-filter').val(['']).trigger('change'); return false; });
                $('#zone-filter option').each(function(){ var v=$(this).val(); if(v){ addChip('Zone: '+v, function(){ $('#zone-filter').val([v]).trigger('change'); return false; }); }});
            } catch(e) {}

            // Pr√©filtres via URL ?srri=1,2&categorie=...&zone=...; sinon restaurer depuis localStorage
            (function(){
              try {
                var params = new URLSearchParams(window.location.search);
                function applyMulti(param, sel){ var val=params.get(param); if(!val) return false; var list=val.split(',').map(s=>s.trim()).filter(Boolean); if(!list.length) return false; var found=[]; $(sel+' option').each(function(){ var v=$(this).val(); if(v && list.indexOf(v)!==-1){ found.push(v);} }); if(found.length){ $(sel).val(found).trigger('change'); return true; } return false; }
                var used=false; used = applyMulti('srri', '#srri-filter') || used; used = applyMulti('categorie', '#categorie-filter') || used; used = applyMulti('zone', '#zone-filter') || used;
                if (!used){
                  var raw = localStorage.getItem('supports_filters');
                  if (raw){
                    var st = JSON.parse(raw);
                    if (st){
                      var restored=false;
                      if (st.isin) { $('#isin-filter').val(st.isin).trigger('change'); restored=true; }
                      if (st.nom) { $('#nom-filter').val(st.nom).trigger('change'); restored=true; }
                      if (Array.isArray(st.categorie) && st.categorie.length) { $('#categorie-filter').val(st.categorie).trigger('change'); restored=true; }
                      if (Array.isArray(st.zone) && st.zone.length) { $('#zone-filter').val(st.zone).trigger('change'); restored=true; }
                      if (Array.isArray(st.srri) && st.srri.length) { $('#srri-filter').val(st.srri).trigger('change'); restored=true; }
                      if (restored) { try{ document.getElementById('restoreSupports').style.display='block'; }catch(e){} }
                    }
                  }
                }
              } catch(e) {}
            })();
            // Rendu initial des badges
            try { renderBadges(); } catch(e) {}

            // Index supports pour autocompl√©tion comparaison
            try {
                supportIndex = [];
                api.rows().every(function(){
                    var row = this.data();
                    var tmp = document.createElement('div');
                    tmp.innerHTML = row[0] || '';
                    var isin = (tmp.textContent || '').trim();
                    tmp.innerHTML = row[1] || '';
                    var nom = (tmp.textContent || '').trim();
                    if (isin) supportIndex.push({ isin: isin, nom: nom });
                });
                var opts = supportIndex.map(function(s){ return '<option value="'+s.isin+'">'+ (s.nom || '') +'</option>'; }).join('');
                $('#supportCompareOptions').html(opts);
            } catch(e){}
        }
    });

    // filtres texte multiples (s√©par√©s par virgule ou espace)
    function multiTextSearch(value, columnIdx) {
        var terms = (value || '').split(/[ ,]+/).filter(Boolean);
        if (terms.length === 0) {
            table.column(columnIdx).search('').draw();
        } else {
            var pattern = terms.map($.fn.dataTable.util.escapeRegex).join('|');
            table.column(columnIdx).search(pattern, true, false).draw();
        }
    }

    function updateSansNomButtonState(){
        var btn = document.getElementById('supportSansNomBtn');
        if (!btn) return;
        var visible = $supportModalChartContainer && $supportModalChartContainer.is(':visible');
        if (visible){
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
        } else {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
        }
    }

    function toggleSupportChart(){
        var hasGraph = (supportModalValuations && supportModalValuations.length) || (supportModalValuationsWeekly && supportModalValuationsWeekly.length);
        if (!hasGraph){
            alert('Aucune valeur liquidative disponible.');
            return;
        }
        if ($supportModalChartContainer && $supportModalChartContainer.is(':visible')){
            if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
            $supportModalChartContainer.hide();
            if ($supportModalSeries.length){ $supportModalSeries.hide(); }
        } else {
            ensureChartJs(function(){
                renderSupportModalChart();
                if ($supportModalSeries.length && $supportModalSeries.html().trim()){
                    $supportModalSeries.show();
                }
            });
        }
        updateSansNomButtonState();
    }
    function toggleSupportCompare(){
        if ($supportCompareSection && $supportCompareSection.is(':visible')){
            if (supportCompareChartInstance){ supportCompareChartInstance.destroy(); supportCompareChartInstance = null; }
            $supportCompareChartContainer.hide();
            $supportCompareSection.hide();
            setCompareButtonActive(false);
            return;
        }
        $supportCompareSection.show();
        setCompareButtonActive(true);
        var term = ($('#supportCompareInput').val() || '').trim();
        if (term){
            fetchComparison(term);
        }
    }

    function toggleSupportSrri(){
        $('#supportSrriSection').find('.series-empty').remove();
        if ($supportSrriSection && $supportSrriSection.is(':visible')){
            if (supportSrriChartInstance){ supportSrriChartInstance.destroy(); supportSrriChartInstance = null; }
            $supportSrriChartContainer.hide();
            $supportSrriTable.hide().empty();
            $supportSrriSection.hide();
            setSrriButtonActive(false);
            return;
        }
        var series = computeSrriSeries();
        if (!series || !series.labels.length){
            $supportSrriChartContainer.hide();
            $supportSrriTable.hide().empty();
            $supportSrriSection.show().append('<div class="series-empty">Donn√©es insuffisantes pour calculer la trajectoire SRRI.</div>');
            setSrriButtonActive(false);
            return;
        }
        ensureChartJs(function(){
            renderSupportSrriChart(series);
            renderSupportSrriTable(series);
            $supportSrriSection.show();
            setSrriButtonActive(true);
        });
    }
    function saveSupportsState(){
      try {
        var st = {
          isin: $('#isin-filter').val() || '',
          nom: $('#nom-filter').val() || '',
          categorie: ($('#categorie-filter').val()||[]).filter(v=>v&&v!==''),
          zone: ($('#zone-filter').val()||[]).filter(v=>v&&v!==''),
          srri: ($('#srri-filter').val()||[]).filter(v=>v&&v!==''),
        };
        localStorage.setItem('supports_filters', JSON.stringify(st));
      } catch(e) {}
    }
    $('#isin-filter').on('keyup change', function () { multiTextSearch(this.value, 0); saveSupportsState(); });
    $('#nom-filter').on('keyup change', function () { multiTextSearch(this.value, 1); saveSupportsState(); try { renderBadges(); } catch(e) {} });

    // chips SRRI (raccourcis)
    window.chipSrri = function(val){ if(val===''){ $('#srri-filter').val(['']).trigger('change'); } else { $('#srri-filter').val([val]).trigger('change'); } return false; };

    // bouton effacer
    window.clearFilters = function() {
        $('#isin-filter, #nom-filter').val('');
        // R√©initialise les s√©lecteurs sur 'Aucun'
        $('#categorie-filter, #zone-filter, #srri-filter').each(function(){
            $(this).find('option').prop('selected', false);
            $(this).find('option[value=""]').prop('selected', true);
            $(this).trigger('change');
        });
        table.search('').columns().search('').draw();
        try { var params=new URLSearchParams(window.location.search); ['categorie','zone','srri'].forEach(k=>params.delete(k)); var newUrl=window.location.pathname + (params.toString()?('?'+params.toString()):''); window.history.replaceState({}, '', newUrl); } catch(e) {}
        try { localStorage.removeItem('supports_filters'); } catch(e) {}
        };
    (function(){
      try{
        var t=document.getElementById('quickToggleSup'),s=document.getElementById('quickSectionSup');
        if(!t||!s)return;
        function setOpen(o){
          s.style.display=o?'':'none';
          t.classList.toggle('collapsed',!o);
          localStorage.setItem('sup_quick_open',o?'1':'');
        }
        var stored = localStorage.getItem('sup_quick_open');
        var initial = stored === null ? false : (stored === '1');
        setOpen(initial);
        t.addEventListener('click',function(){setOpen(s.style.display==='none');});
      }catch(e){}
    })();

    // reset depuis le badge restaur√©
    window.resetRestoredSupports = function(){ try{ document.getElementById('restoreSupports').style.display='none'; }catch(e){}; try{ window.clearFilters(); }catch(e){}; return false; };

    // Badges actifs (Cat√©gorie / Zone / SRRI et ISIN/Nom)
    window.renderBadges = function(){
      var host = document.getElementById('sup_active_badges');
      if (!host) return; host.innerHTML = '';
      function makeBadge(label, onClear){
        var span = document.createElement('span'); span.className='badge-filter';
        span.appendChild(document.createTextNode(label+' '));
        var a = document.createElement('a'); a.href='#'; a.className='x'; a.title='Effacer le filtre'; a.textContent='‚úï';
        a.addEventListener('click', function(e){ e.preventDefault(); try{ onClear(); }catch(_){} });
        span.appendChild(a); host.appendChild(span);
      }
      // Cat√©gorie
      try {
        var catVals = ($('#categorie-filter').val()||[]).filter(function(v){ return v && v!==''; });
        if (catVals.length){ makeBadge('Cat√©gorie: '+catVals.join(', '), function(){ $('#categorie-filter').val(['']).trigger('change'); }); }
      } catch(e) {}
      // Zone
      try {
        var zoneVals = ($('#zone-filter').val()||[]).filter(function(v){ return v && v!==''; });
        if (zoneVals.length){ makeBadge('Zone g√©o: '+zoneVals.join(', '), function(){ $('#zone-filter').val(['']).trigger('change'); }); }
      } catch(e) {}
      // SRRI
      try {
        var srriVals = ($('#srri-filter').val()||[]).filter(function(v){ return v && v!==''; });
        if (srriVals.length){ makeBadge('SRRI: '+srriVals.join(', '), function(){ $('#srri-filter').val(['']).trigger('change'); }); }
      } catch(e) {}
      // Optionnel: ISIN / Nom si non vides
      try { var isin = $('#isin-filter').val()||''; if (isin){ makeBadge('ISIN: '+isin, function(){ $('#isin-filter').val('').trigger('change'); }); } } catch(e) {}
      try { var nom = $('#nom-filter').val()||''; if (nom){ makeBadge('Nom: '+nom, function(){ $('#nom-filter').val('').trigger('change'); }); } } catch(e) {}
    };
    // Premier rendu badges au chargement
    try { renderBadges(); } catch(e) {}

    var $supportModal = $('#supportModal');
    var $supportModalMeta = $('#supportModalMeta');
    var $supportModalClients = $('#supportModalClients');
    var $supportModalSeries = $('#supportModalSeries');
    var $supportModalDate = $('#supportModalDate');
    var $supportModalTotal = $('#supportModalTotal');
    var $supportModalExport = $('#supportModalExport');
    var $supportCompareToggle = $('#supportCompareToggle');
    var $supportCompareSection = $('#supportCompareSection');
    var $supportModalClientFilter = $('#supportModalClientFilter');
    var $supportModalResponsableFilter = $('#supportModalResponsableFilter');
    var $supportModalAmountFilter = $('#supportModalAmountFilter');
    var $supportModalFiltersReset = $('#supportModalFiltersReset');
    var $supportClientsSection = $('#supportClientsSection');
    var $supportClientsPager = $('#supportClientsPager');
    var $supportClientsPrev = $('#supportClientsPrev');
    var $supportClientsNext = $('#supportClientsNext');
    var $supportClientsPageInfo = $('#supportClientsPageInfo');
    var $supportModalCreateTasks = $('#supportModalCreateTasks');
    var $supportModalChartContainer = $('#supportModalChartContainer');
    var supportModalChartCanvas = document.getElementById('supportModalChart');
    var $supportCompareChartContainer = $('#supportCompareChartContainer');
    var supportCompareChartCanvas = document.getElementById('supportCompareChart');
    var $supportSrriSection = $('#supportSrriSection');
    var $supportSrriChartContainer = $('#supportSrriChartContainer');
    var supportSrriChartCanvas = document.getElementById('supportSrriChart');
    var $supportSrriTable = $('#supportSrriTable');
    var supportModalValuationsWeekly = [];
    var supportModalValuations = [];
    var supportCompareValuations = [];
    var supportCompareLabel = '';
    var supportEsgFields = [];
    var supportEsgAllocNames = [];
    var supportEsgMetaLoaded = false;
    var $supportEsgAlloc = $('#supportEsgAlloc');
    var $supportEsgUnmatched = $('#supportEsgUnmatched');
    var supportEsgLabelMap = {};
    var supportIndex = [];
    var supportModalClientsData = [];
    var supportModalFilteredData = [];
    var supportClientsPage = 1;
    var supportClientsPageSize = 20;
    var supportModalTaskTypes = [];
    var supportModalCodeIsin = '';
    var supportModalLastDate = null;
    var $supportTaskModal = $('#supportTaskModal');
    var $supportTaskModalClose = $('#supportTaskModalClose');
    var $supportTaskTypeSelect = $('#supportTaskTypeSelect');
    var $supportTaskComment = $('#supportTaskComment');
    var $supportTaskSubmit = $('#supportTaskSubmit');
    var $supportTaskCancel = $('#supportTaskCancel');
    var $supportTaskStatus = $('#supportTaskStatus');
    var supportModalChartInstance = null;
    var supportCompareChartInstance = null;
    var supportEsgChartInstance = null;
    var supportSrriChartInstance = null;
    var chartJsLoaded = false;

    function setCompareButtonActive(active){
        if ($supportCompareToggle && $supportCompareToggle.length){
            $supportCompareToggle.toggleClass('active', !!active);
        }
    }

    function setSrriButtonActive(active){
        var btn = document.getElementById('supportSrriBtn');
        if (btn){
            if (active){ btn.classList.add('active'); btn.setAttribute('aria-pressed', 'true'); }
            else { btn.classList.remove('active'); btn.setAttribute('aria-pressed', 'false'); }
        }
    }

    function setEsgButtonActive(active){
        var btn = document.getElementById('supportEsgToggle');
        if (btn){
            btn.classList.toggle('active', !!active);
        }
    }

    function setClientsButtonActive(active){
        var btn = document.getElementById('supportClientsToggle');
        if (btn){
            btn.classList.toggle('active', !!active);
            btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        }
    }

    function escHtml(str){
        if (str === null || str === undefined) return '';
        return String(str).replace(/[&<>"']/g, function(ch){
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]);
        });
    }

    function ensureChartJs(callback){
        if (chartJsLoaded) { callback(); return; }
        var existing = document.querySelector('script[data-loader="chartjs"]');
        if (existing) {
            existing.addEventListener('load', function(){ chartJsLoaded = true; callback(); });
            existing.addEventListener('error', function(){ console.warn('Chart.js load error'); });
            return;
        }
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js';
        script.async = true;
        script.setAttribute('data-loader', 'chartjs');
        script.onload = function(){ chartJsLoaded = true; callback(); };
        script.onerror = function(){ console.warn('Chart.js load error'); };
        document.head.appendChild(script);
    }

    function ensurePlotlySupportEsg(callback){
        if (window.Plotly){ callback(); return; }
        var existing = document.querySelector('script[data-loader=\"plotly\"]');
        if (existing){
            existing.addEventListener('load', function(){ callback(); });
            return;
        }
        var s=document.createElement('script');
        s.src='https://cdn.plot.ly/plotly-2.32.0.min.js';
        s.async=true;
        s.setAttribute('data-loader','plotly');
        s.onload=function(){ callback(); };
        document.head.appendChild(s);
    }

    function loadSupportEsgMeta(cb){
        if (supportEsgMetaLoaded){
            cb && cb();
            return;
        }
        fetch('/dashboard/esg/fields')
            .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(function(data){
                supportEsgFields = Array.isArray(data.esg_fields) ? data.esg_fields : [];
                supportEsgAllocNames = Array.isArray(data.alloc_names) ? data.alloc_names : [];
                supportEsgMetaLoaded = true;
                renderSupportEsgFields();
                renderSupportEsgAllocOptions();
                cb && cb();
            })
            .catch(function(err){
                console.warn('ESG meta load error', err);
                supportEsgFields = [];
                supportEsgAllocNames = [];
                supportEsgMetaLoaded = true;
                renderSupportEsgFields();
                renderSupportEsgAllocOptions();
                cb && cb();
            });
    }

    function renderSupportEsgAllocOptions(){
        if (!$supportEsgAlloc || !$supportEsgAlloc.length) return;
        var opts = ['<option value=\"\">‚Äî choisir ‚Äî</option>'];
        supportEsgAllocNames.forEach(function(n){
            opts.push('<option value=\"'+escHtml(n)+'\">'+escHtml(n)+'</option>');
        });
        $supportEsgAlloc.html(opts.join(''));
    }

    function renderSupportEsgFields(){
        var wrap = document.getElementById('supportEsgFields');
        if (!wrap) return;
        wrap.innerHTML = '';
        supportEsgLabelMap = {};
        if (!supportEsgFields.length){
            wrap.innerHTML = '<span class=\"muted\">Aucun champ ESG d√©tect√©</span>';
            return;
        }
        supportEsgFields.forEach(function(f){
            var btn = document.createElement('button');
            btn.type='button';
            btn.className='dim-btn support-esg-field';
            btn.setAttribute('data-field', f.col || f.field || f.label || '');
            btn.title = f.label || f.col || '';
            btn.textContent = f.label || f.col || '';
            if (f.col || f.field){
                var key = f.col || f.field;
                supportEsgLabelMap[key] = f.label || key;
            }
            btn.addEventListener('click', function(){
                if (btn.classList.contains('active')){
                    btn.classList.remove('active');
                } else {
                    var actives = wrap.querySelectorAll('.support-esg-field.active');
                    if (actives.length >= 4) return;
                    btn.classList.add('active');
                }
                runSupportEsg();
            });
            wrap.appendChild(btn);
        });
        ensureSupportEsgDefaultSelection();
    }

    function ensureSupportEsgDefaultSelection(){
        var wrap = document.getElementById('supportEsgFields');
        if (!wrap) return;
        var actives = wrap.querySelectorAll('.support-esg-field.active');
        if (actives.length) return;
        var btns = wrap.querySelectorAll('.support-esg-field');
        for (var i = 0; i < btns.length && i < 4; i++){
            btns[i].classList.add('active');
        }
    }

    function selectedSupportEsgFields(){
        var wrap = document.getElementById('supportEsgFields');
        if (!wrap) return [];
        return Array.from(wrap.querySelectorAll('.support-esg-field.active')).map(function(b){
            return b.getAttribute('data-field');
        }).filter(Boolean);
    }

    function runSupportEsg(){
        if (!supportEsgMetaLoaded){
            loadSupportEsgMeta(function(){ runSupportEsg(); });
            return;
        }
        if (!supportEsgFields.length){
            renderSupportEsgFields();
            return;
        }
        var alloc = ($supportEsgAlloc && $supportEsgAlloc.val()) || '';
        ensureSupportEsgDefaultSelection();
        var fields = selectedSupportEsgFields();
        if (!supportModalCodeIsin){ return; }
        if (!alloc){ return; }
        if (!fields.length){ return; }
        var unmatchedEl = document.getElementById('supportEsgUnmatched');
        if (unmatchedEl){ unmatchedEl.style.display='none'; unmatchedEl.textContent=''; }
        ensurePlotlySupportEsg(function(){
            var url = '/dashboard/supports/' + encodeURIComponent(supportModalCodeIsin) + '/esg?alloc=' + encodeURIComponent(alloc) + '&fields=' + encodeURIComponent(fields.join(','));
            fetch(url).then(function(resp){ if(!resp.ok) throw new Error('HTTP '+resp.status); return resp.json(); }).then(function(data){
                var rows = (data && data.results) || [];
                var unmatched = (data && data.unmatched_fields) || [];
                if (unmatchedEl){
                    if (unmatched.length){
                        unmatchedEl.textContent = 'Indicateurs introuvables : ' + unmatched.join(', ');
                        unmatchedEl.style.display = '';
                    } else {
                        unmatchedEl.textContent = '';
                        unmatchedEl.style.display = 'none';
                    }
                }
                var displayRows = rows.filter(function(r){ return r && r.index != null && r.client != null; });
                if (!displayRows.length){ displayRows = rows; }
                if (!displayRows.length){
                    $('#supportEsgChart').hide().empty();
                    return;
                }
                var cats = displayRows.map(function(r){
                    return supportEsgLabelMap[r.field] || supportEsgLabelMap[r.resolved_field] || r.field_original || r.field;
                });
                var idx = displayRows.map(function(r){ return r.index == null ? null : Number(r.index); });
                var cli = displayRows.map(function(r){ return r.client == null ? null : Number(r.client); });
                var traces = [
                    { x: idx, y: cats, type:'bar', orientation:'h', name:'Indice', marker:{ color:'#9ca3af' } },
                    { x: cli, y: cats, type:'bar', orientation:'h', name:'Support', marker:{ color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6' } }
                ];
                var layout = { barmode:'group', margin:{ l: 200, r: 20, t: 10, b: 40 }, xaxis:{ title:'Base 100', rangemode:'tozero' }, height: Math.max(320, 80 + Math.max(4, cats.length)*32) };
                var cfg = { displayModeBar: false, responsive: true };
                Plotly.react('supportEsgChart', traces, layout, cfg);
                $('#supportEsgChart').show();
            }).catch(function(err){
                if (unmatchedEl){
                    unmatchedEl.textContent = 'Erreur de chargement ESG.';
                    unmatchedEl.style.display = '';
                }
                try{ console.warn('Support ESG fetch error', err); }catch(_){}
                $('#supportEsgChart').hide().empty();
            });
        });
    }

    function formatEuro(value){
        if (value === null || value === undefined || !isFinite(value)) return '‚Äî';
        try {
            return Number(value).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch(e){
            return String(value);
        }
    }

    function formatDateLabel(iso){
        if (!iso) return '‚Äî';
        try {
            var d = new Date(iso);
            if (!isNaN(d)) return d.toLocaleDateString('fr-FR');
        } catch(e){}
        return iso;
    }

    function toFridayISO(iso){
        if (!iso) return null;
        try {
            var d = new Date(iso);
            if (isNaN(d)) return null;
            var day = d.getDay(); // 0=dim, 5=ven
            var delta = (5 - day + 7) % 7; // avancer jusqu'au vendredi de la m√™me semaine (ou suivant)
            d.setDate(d.getDate() + delta);
            return d.toISOString().slice(0, 10);
        } catch(e){ return null; }
    }

    function srriFromVol(volPct){
        if (volPct == null || !isFinite(volPct)) return null;
        if (volPct < 0.5) return 1;
        if (volPct < 2) return 2;
        if (volPct < 5) return 3;
        if (volPct < 10) return 4;
        if (volPct < 15) return 5;
        if (volPct < 25) return 6;
        return 7;
    }

    function stddev(arr){
        if (!arr || arr.length === 0) return NaN;
        var mean = arr.reduce(function(s,v){ return s+v; },0)/arr.length;
        var variance = arr.reduce(function(s,v){ var d=v-mean; return s + d*d; },0)/arr.length;
        return Math.sqrt(variance);
    }

    function computeSrriSeries(){
        if (!supportModalValuations || !supportModalValuations.length) return null;
        var refIso = supportModalLastDate || (supportModalValuations[supportModalValuations.length-1]?.date);
        if (!refIso) return null;
        var refDate = new Date(refIso);
        if (isNaN(refDate)) return null;
        var cutoff4y = new Date(refDate); cutoff4y.setFullYear(refDate.getFullYear() - 4);
        var cutoff3y = new Date(refDate); cutoff3y.setFullYear(refDate.getFullYear() - 3);

        var weekMap = {};
        supportModalValuations.forEach(function(row){
            if (!row || !row.date) return;
            var d = new Date(row.date);
            if (isNaN(d) || d < cutoff4y) return;
            var friday = toFridayISO(row.date);
            if (!friday) return;
            weekMap[friday] = parseFloat(row.valeur); // on garde la derni√®re valeur de la semaine
        });
        var weeks = Object.keys(weekMap).sort();
        if (weeks.length < 60) return null; // besoin d'un minimum pour 52 semaines

        var weeklySeries = weeks.map(function(w){ return {date: w, value: weekMap[w]}; });
        var returns = [];
        for (var i=1; i<weeklySeries.length; i++){
            var prev = weeklySeries[i-1].value;
            var cur = weeklySeries[i].value;
            if (prev && cur){
                returns.push(cur/prev - 1);
            } else {
                returns.push(null);
            }
        }
        var points = [];
        for (var j=51; j<returns.length; j++){
            var window = returns.slice(j-51, j+1).filter(function(r){ return r !== null && isFinite(r); });
            if (window.length < 26) { points.push(null); continue; } // trop peu de donn√©es propres
            var vol = stddev(window) * Math.sqrt(52); // annualisation
            var volPct = vol * 100;
            var srri = srriFromVol(volPct);
            points.push({date: weeklySeries[j+1].date, volPct: volPct, srri: srri});
        }
        points = points.filter(Boolean).filter(function(p){
            var d = new Date(p.date);
            return !isNaN(d) && d >= cutoff3y;
        });
        if (!points.length) return null;
        var labels = points.map(function(p){ return p.date; });
        var volData = points.map(function(p){ return Number(p.volPct.toFixed(2)); });
        var srriData = points.map(function(p){ return p.srri; });
        var tableRows = points.slice(-20).reverse();
        return { labels: labels, volData: volData, srriData: srriData, tableRows: tableRows };
    }

    function renderSupportSrriChart(series){
        if (!supportSrriChartCanvas || !series) return;
        if (supportSrriChartInstance){ supportSrriChartInstance.destroy(); supportSrriChartInstance = null; }
        var maxVol = 0;
        try { maxVol = Math.max.apply(null, series.volData.filter(function(v){ return isFinite(v); })); } catch(e){}
        var suggestedMax = isFinite(maxVol) ? (maxVol + Math.max(1, maxVol * 0.05)) : undefined;
        supportSrriChartInstance = new Chart(supportSrriChartCanvas.getContext('2d'), {
            type: 'line',
            data: {
                labels: series.labels,
                datasets: [
                    {
                        label: 'Volatilit√© annualis√©e (%)',
                        data: series.volData,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37,99,235,0.15)',
                        tension: 0.2,
                        yAxisID: 'y',
                        pointRadius: 0
                    },
                    {
                        label: 'SRRI',
                        data: series.srriData,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249,115,22,0.15)',
                        stepped: true,
                        tension: 0,
                        yAxisID: 'y1',
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { maxTicksLimit: 8 },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'Volatilit√© (%)' },
                        suggestedMin: 0,
                        suggestedMax: suggestedMax
                    },
                    y1: {
                        position: 'right',
                        title: { display: true, text: 'SRRI' },
                        min: 1,
                        max: 7,
                        grid: { drawOnChartArea: false },
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
        $('#supportSrriChartContainer').show();
    }

    function renderSupportSrriTable(series){
        if (!$supportSrriTable.length || !series) return;
        if (!series.tableRows || !series.tableRows.length){
            $supportSrriTable.hide().empty();
            return;
        }
        var rowsHtml = series.tableRows.map(function(r){
            return '<tr><td>' + formatDateLabel(r.date) + '</td><td>' + r.volPct.toFixed(2) + ' %</td><td>SRRI ' + r.srri + '</td></tr>';
        }).join('');
        var html = '<div class="series-table"><div class="support-series-header"><h4>Evolution SRRI (3 derni√®res ann√©es)</h4></div><table><thead><tr><th>Date</th><th>Volatilit√© annualis√©e</th><th>SRRI</th></tr></thead><tbody>' + rowsHtml + '</tbody></table></div>';
        $supportSrriTable.html(html).show();
    }

    function bindSupportSeriesToggles(){
        if (!$supportModalSeries.length) return;
        $supportModalSeries
            .off('click.supportToggle')
            .on('click.supportToggle', '.support-series-toggle', function(){
                var $btn = $(this);
                var targetId = $btn.data('target');
                if (!targetId) return;
                var $panel = $('#' + targetId);
                if (!$panel.length) return;
                var isVisible = $panel.is(':visible');
                if (isVisible){
                    $panel.slideUp(150);
                    $btn.attr('aria-expanded', 'false');
                    $btn.attr('aria-label', 'Afficher la s√©rie');
                    $btn.find('i').attr('class', 'fa-solid fa-chevron-down');
                } else {
                    $panel.slideDown(150);
                    $btn.attr('aria-expanded', 'true');
                    $btn.attr('aria-label', 'Masquer la s√©rie');
                    $btn.find('i').attr('class', 'fa-solid fa-chevron-up');
                }
            });
    }

    function renderSupportSeriesTables(showNow){
        if (!$supportModalSeries.length){
            return;
        }
        var displaySeries = !!showNow;
        var html = '';
        if (supportModalValuations && supportModalValuations.length){
            var rows = supportModalValuations
                .filter(function(r){ return r && r.date; })
                .slice()
                .sort(function(a, b){ return a.date < b.date ? 1 : -1; })
                .slice(0, 20);
            if (rows.length){
                html += '<div class="series-table">';
                html += '<div class="support-series-header">';
                html += '<h4>Valeur liquidative ‚Äì 20 derni√®res observations</h4>';
                html += '<button type="button" class="support-series-toggle" data-target="seriesDaily" aria-expanded="false" aria-label="Afficher la s√©rie"><i class="fa-solid fa-chevron-down" aria-hidden="true"></i></button>';
                html += '</div>';
                html += '<div id="seriesDaily" class="series-table-body" style="display:none;">';
                html += '<table><thead><tr><th>Date</th><th>Valeur</th></tr></thead><tbody>';
                rows.forEach(function(row){
                    var iso = toFridayISO(row.date) || row.date;
                    html += '<tr><td>' + formatDateLabel(iso) + '</td><td>' + formatEuro(parseFloat(row.valeur)) + '</td></tr>';
                });
                html += '</tbody></table></div></div>';
            }
        }
        if (supportModalValuationsWeekly && supportModalValuationsWeekly.length){
            var wrows = supportModalValuationsWeekly
                .filter(function(r){ return r && r.week_start; })
                .slice()
                .sort(function(a, b){ return a.week_start < b.week_start ? 1 : -1; })
                .slice(0, 20);
            if (wrows.length){
                html += '<div class="series-table">';
                html += '<div class="support-series-header">';
                html += '<h4>AUM hebdomadaire ‚Äì 20 derni√®res semaines</h4>';
                html += '<button type="button" class="support-series-toggle" data-target="seriesWeekly" aria-expanded="false" aria-label="Afficher la s√©rie"><i class="fa-solid fa-chevron-down" aria-hidden="true"></i></button>';
                html += '</div>';
                html += '<div id="seriesWeekly" class="series-table-body" style="display:none;">';
                html += '<table><thead><tr><th>Semaine d√©but</th><th>Montant (‚Ç¨)</th></tr></thead><tbody>';
                wrows.forEach(function(row){
                    var iso = toFridayISO(row.week_start) || row.week_start;
                    html += '<tr><td>' + formatDateLabel(iso) + '</td><td>' + formatEuro(parseFloat(row.total_valo)) + '</td></tr>';
                });
                html += '</tbody></table></div></div>';
            }
        }
        if (!html){
            html = '<div class="series-empty">Aucune s√©rie historique disponible.</div>';
            $supportModalSeries.html(html).hide();
            return;
        }
        $supportModalSeries.html(html);
        if (displaySeries){
            $supportModalSeries.show();
        } else {
            $supportModalSeries.hide();
        }
        bindSupportSeriesToggles();
    }

    function renderSupportModalChart(){
        var hasDaily = supportModalValuations && supportModalValuations.length;
        var hasWeekly = supportModalValuationsWeekly && supportModalValuationsWeekly.length;
        if (!hasDaily && !hasWeekly){
            alert('Aucune valeur liquidative disponible.');
            return;
        }
        if (!$supportModalChartContainer.length || !supportModalChartCanvas){
            return;
        }

        var dailyMap = {};
        var rawDaily = supportModalValuations || [];
        rawDaily.forEach(function(row){
            if (!row || !row.date) return;
            var iso = toFridayISO(String(row.date).slice(0, 10)) || String(row.date).slice(0, 10);
            var val = parseFloat(row.valeur);
            dailyMap[iso] = isFinite(val) ? val : null;
        });

        var weeklyMap = {};
        (supportModalValuationsWeekly || []).forEach(function(row){
            if (!row || !row.week_start) return;
            var iso = toFridayISO(String(row.week_start).slice(0, 10)) || String(row.week_start).slice(0, 10);
            var val = parseFloat(row.total_valo);
            weeklyMap[iso] = isFinite(val) ? val : null;
        });

        var labelsIso = Array.from(new Set([].concat(Object.keys(dailyMap), Object.keys(weeklyMap)))).sort();
        if (!labelsIso.length){
            alert('Aucune valeur liquidative disponible.');
            return;
        }
        var dailyValues = labelsIso.map(function(iso){ return dailyMap.hasOwnProperty(iso) ? dailyMap[iso] : null; });
        var weeklyValues = labelsIso.map(function(iso){ return weeklyMap.hasOwnProperty(iso) ? weeklyMap[iso] : null; });
        var weeklyValuesFiltered = weeklyValues.filter(function(val){
            return val !== null && isFinite(val);
        });
        var weeklySuggestedMax = null;
        var weeklyHardMax = null;
        var weeklyTrimmedMin = 0;
        if (weeklyValuesFiltered.length){
            var sortedWeekly = weeklyValuesFiltered.slice().sort(function(a, b){ return b - a; });
            var topCount = Math.max(1, Math.floor(sortedWeekly.length * 0.9));
            var sumTop = 0;
            for (var i = 0; i < topCount; i++){
                sumTop += sortedWeekly[i];
            }
            weeklySuggestedMax = sumTop / topCount;
            weeklyHardMax = sortedWeekly[0];
            var bottomCount = Math.max(1, Math.floor(sortedWeekly.length * 0.9));
            var bottomSlice = sortedWeekly.slice(-bottomCount);
            if (bottomSlice.length){
                weeklyTrimmedMin = bottomSlice.reduce(function(acc, val){ return acc + val; }, 0) / bottomSlice.length;
            }
        }
        var weeklyAxisMax = null;
        if (weeklyHardMax){
            weeklyAxisMax = weeklyHardMax * 1.05;
        }
        console.debug('[Support Chart] daily sample:', dailyValues.slice(0,5), 'weekly sample:', weeklyValuesFiltered.slice(0,5), 'axisMax:', weeklyAxisMax);
        if (supportModalChartInstance){
            supportModalChartInstance.destroy();
        }
        $supportModalChartContainer.show();
        var ctx = supportModalChartCanvas.getContext('2d');
        supportModalChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelsIso,
                datasets: [
                    {
                        label: 'Valeur liquidative',
                        data: dailyValues,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37,99,235,0.18)',
                        pointRadius: 0,
                        fill: true,
                        tension: 0.25,
                        yAxisID: 'y'
                    },
                    {
                        label: 'AUM',
                        type: 'bar',
                        data: weeklyValues,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249,115,22,0.35)',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(ctx){
                                var val = ctx.parsed.y;
                                if (!isFinite(val)) return 'Valeur indisponible';
                                if (ctx.dataset.yAxisID === 'y1') {
                                    return (ctx.dataset.label || 'Total hebdomadaire') + ' : ' + val.toLocaleString('fr-FR') + ' ‚Ç¨';
                                }
                                return (ctx.dataset.label || 'Valeur') + ' : ' + val.toLocaleString('fr-FR');
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: function(value, index){
                                var iso = labelsIso[index];
                                try {
                                    var d = new Date(iso);
                                    if (!isNaN(d)) return d.toLocaleDateString('fr-FR');
                                } catch(e){}
                                return iso;
                            }
                        }
                    },
                    y: {
                        position: 'left',
                        ticks: {
                            callback: function(value){
                                return value.toLocaleString('fr-FR');
                            }
                        }
                    },
                    y1: {
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        ticks: {
                            callback: function(value){
                                return value.toLocaleString('fr-FR') + ' ‚Ç¨';
                            }
                        },
                        min: (weeklyTrimmedMin && isFinite(weeklyTrimmedMin)) ? Math.max(0, weeklyTrimmedMin * 0.95) : 0,
                        max: (weeklyAxisMax && isFinite(weeklyAxisMax)) ? weeklyAxisMax : undefined
                    }
                }
            }
        });
        updateSansNomButtonState();
    }

    function prepareNormalizedSeries(list){
        if (!list || !list.length) return { labels: [], values: [], base: null, latest: null };
        var map = {};
        var latest = null;
        list.forEach(function(row){
            if (!row || !row.date) return;
            var iso = toFridayISO(String(row.date).slice(0, 10)) || String(row.date).slice(0, 10);
            var d = new Date(iso);
            if (isNaN(d)) return;
            if (!latest || d > latest) latest = d;
            var val = parseFloat(row.valeur);
            map[iso] = isFinite(val) ? val : null;
        });
        if (!latest) return { labels: [], values: [], base: null, latest: null };
        var threshold = new Date(latest);
        threshold.setFullYear(threshold.getFullYear() - 3);
        var labels = Object.keys(map).filter(function(iso){
            var d = new Date(iso);
            return !isNaN(d) && d >= threshold;
        }).sort();
        var baseIso = labels.find(function(l){ return map[l] != null; }) || null;
        var baseVal = baseIso ? map[baseIso] : null;
        var values = labels.map(function(l){
            if (map[l] == null || baseVal == null || baseVal === 0) return null;
            return (map[l] / baseVal) * 100.0;
        });
        return { labels: labels, values: values, base: baseVal, latest: latest };
    }

    function renderSupportCompareChart(){
        var primary = prepareNormalizedSeries(supportModalValuations);
        var secondary = prepareNormalizedSeries(supportCompareValuations);
        var allLabels = Array.from(new Set([].concat(primary.labels, secondary.labels))).sort();
        if (!allLabels.length){
            $('#supportCompareStatus').text('Aucune donn√©e comparable.');
            return;
        }
        var primMap = {};
        primary.labels.forEach(function(l, idx){ primMap[l] = primary.values[idx]; });
        var secMap = {};
        secondary.labels.forEach(function(l, idx){ secMap[l] = secondary.values[idx]; });
        var primSeries = allLabels.map(function(l){ return primMap.hasOwnProperty(l) ? primMap[l] : null; });
        var secSeries = allLabels.map(function(l){ return secMap.hasOwnProperty(l) ? secMap[l] : null; });

        ensureChartJs(function(){
            if (supportCompareChartInstance){ supportCompareChartInstance.destroy(); supportCompareChartInstance = null; }
            if (!$supportCompareChartContainer.length || !supportCompareChartCanvas){ return; }
            $supportCompareChartContainer.show();
            var ctx = supportCompareChartCanvas.getContext('2d');
            supportCompareChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'Support s√©lectionn√© (base 100)',
                            data: primSeries,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37,99,235,0.18)',
                            pointRadius: 0,
                            fill: false,
                            tension: 0.25
                        },
                        {
                            label: (supportCompareLabel || 'Comparaison') + ' (base 100)',
                            data: secSeries,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239,68,68,0.15)',
                            pointRadius: 0,
                            fill: false,
                            tension: 0.25
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(ctx){
                                    var val = ctx.parsed.y;
                                    if (val == null || isNaN(val)) return (ctx.dataset.label || '') + ' : -';
                                    return (ctx.dataset.label || '') + ' : ' + val.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            position: 'left',
                            ticks: { callback: function(value){ return value.toFixed ? value.toFixed(0) : value; } }
                        },
                        x: {
                            ticks: {
                                callback: function(value, index){ var iso = allLabels[index]; try{ var d=new Date(iso); if(!isNaN(d)) return d.toLocaleDateString('fr-FR'); }catch(e){} return iso; }
                            }
                        }
                    }
                }
            });
            $('#supportCompareStatus').text('');
        });
    }

    function fetchComparison(term){
        var statusEl = $('#supportCompareStatus');
        var needle = term.trim().toLowerCase();
        if (!needle){ statusEl.text('Choisissez un support √† comparer.'); return; }
        var match = supportIndex.find(function(s){
            return (s.isin && s.isin.toLowerCase().indexOf(needle) !== -1) ||
                   (s.nom && s.nom.toLowerCase().indexOf(needle) !== -1);
        });
        var targetIsin = match ? match.isin : term.toUpperCase();
        statusEl.text('Chargement...');
    fetch('/dashboard/supports/details?code_isin=' + encodeURIComponent(targetIsin))
        .then(function(resp){ if(!resp.ok) throw new Error('Erreur ' + resp.status); return resp.json(); })
        .then(function(data){
            supportCompareValuations = Array.isArray(data.valuations) ? data.valuations.slice() : [];
            supportCompareLabel = (data.support && (data.support.nom || data.support.code_isin)) || targetIsin;
            renderSupportCompareChart();
        })
        .catch(function(err){
            statusEl.text(err.message || 'Erreur de chargement.');
        });
    }

    function openSupportModal(){
        $supportModal.addClass('open').attr('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    function closeSupportModal(){
        closeSupportTaskModal();
        if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
        if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
        if (supportCompareChartInstance){ supportCompareChartInstance.destroy(); supportCompareChartInstance = null; }
        if ($supportCompareChartContainer.length){ $supportCompareChartContainer.hide(); }
        if (supportEsgChartInstance){ supportEsgChartInstance.destroy(); supportEsgChartInstance = null; }
        $('#supportEsgChart').hide().empty();
        $('#supportEsgUnmatched').hide().text('');
        $('#supportEsgSection').hide();
        setEsgButtonActive(false);
        if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
        $('#supportCompareStatus').text('');
        if ($supportCompareSection.length){ $supportCompareSection.hide(); }
        if ($supportClientsSection && $supportClientsSection.length){ $supportClientsSection.hide(); setClientsButtonActive(false); }
        $supportModal.removeClass('open').attr('aria-hidden', 'true');
        document.body.style.overflow = '';
        updateSansNomButtonState();
        setCompareButtonActive(false);
        supportClientsPage = 1;
    }

    function renderSupportModalLoading(code){
        $('#supportModalTitle').text('Support ' + (code || ''));
        supportModalCodeIsin = code || '';
        $supportModalMeta.html('<div><span class="label">Chargement‚Ä¶</span><span class="value">Patientez</span></div>');
        $supportModalClients.empty();
        $supportModalDate.text('');
        $supportModalTotal.text('');
        $supportModalExport.data('export', '').prop('disabled', true).text('Exporter CSV');
        supportModalValuations = [];
        supportModalValuationsWeekly = [];
        supportCompareValuations = [];
        supportCompareLabel = '';
        supportEsgFields = [];
        supportModalLastDate = null;
        if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
        if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
        if (supportCompareChartInstance){ supportCompareChartInstance.destroy(); supportCompareChartInstance = null; }
        if ($supportCompareChartContainer.length){ $supportCompareChartContainer.hide(); }
        if (supportEsgChartInstance){ supportEsgChartInstance.destroy(); supportEsgChartInstance = null; }
        if (supportEsgChartInstance){ supportEsgChartInstance.destroy(); supportEsgChartInstance = null; }
        $('#supportEsgChart').hide().empty();
        $('#supportEsgUnmatched').hide().text('');
        $('#supportEsgSection').hide();
        if ($supportEsgAlloc && $supportEsgAlloc.length){ $supportEsgAlloc.val(''); }
        $('#supportEsgFields').empty();
        if (supportSrriChartInstance){ supportSrriChartInstance.destroy(); supportSrriChartInstance = null; }
        $('#supportSrriTable').hide().empty();
        $('#supportSrriChartContainer').hide();
        $('#supportSrriSection').hide();
        if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
        $('#supportCompareStatus').text('');
        if ($supportCompareSection.length){ $supportCompareSection.hide(); }
        setCompareButtonActive(false);
        setSrriButtonActive(false);
        setEsgButtonActive(false);
        if ($supportClientsSection && $supportClientsSection.length){ $supportClientsSection.hide(); }
        setClientsButtonActive(false);
        updateSansNomButtonState();
        supportClientsPage = 1;
    }

    function renderSupportModal(data){
        if (!data || !data.support){
            $supportModalMeta.html('<div><span class="label">Erreur</span><span class="value">Donn√©es introuvables</span></div>');
            $supportModalClients.empty();
            $supportModalDate.text('');
            $supportModalTotal.text('');
            $supportModalExport.prop('disabled', true);
            supportModalValuations = [];
            supportModalValuationsWeekly = [];
            if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
            if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
            return;
        }
        var s = data.support;
        var metaHtml = '';
        var fields = [
            {label: 'Code ISIN', value: s.code_isin},
            {label: 'Nom', value: s.nom},
            {label: 'Cat√©gorie principale', value: s.cat_principale || '‚Äî'},
            {label: 'Cat√©gorie d√©taill√©e', value: s.cat_det || '‚Äî'},
            {label: 'Cat√©gorie g√©n√©rique', value: s.cat_gene || '‚Äî'},
            {label: 'Zone g√©o', value: s.cat_geo || '‚Äî'},
            {label: 'Promoteur', value: s.promoteur || '‚Äî'},
            {label: 'SRRI', value: (s.SRRI !== null && s.SRRI !== undefined) ? s.SRRI : '‚Äî'}
        ];
        fields.forEach(function(item){
            if (item.label === 'SRRI'){
                metaHtml += '<div class="support-meta-srri"><span class="label">' + item.label + '</span><button type="button" class="support-meta-btn" id="supportSrriBtn" aria-pressed="false"><span>' + (item.value || '‚Äî') + '</span></button></div>';
            } else {
                metaHtml += '<div><span class="label">' + item.label + '</span><span class="value">' + item.value + '</span></div>';
            }
        });
        metaHtml += '<button type="button" class="support-meta-btn" id="supportSansNomBtn" aria-pressed="false"><i class="fa-solid fa-chart-line" aria-hidden="true"></i><span>Graphiques VL & AUM</span></button>';
        $supportModalMeta.html(metaHtml);
        var sansNomBtn = document.getElementById('supportSansNomBtn');
        if (sansNomBtn){
            sansNomBtn.addEventListener('click', function(){
                toggleSupportChart();
            });
        }
        var srriBtn = document.getElementById('supportSrriBtn');
        if (srriBtn){
            srriBtn.addEventListener('click', function(){
                toggleSupportSrri();
            });
        }
        $supportModalMeta.closest('.support-modal__panel').find('.support-modal__graph-row').remove();
        $supportModalMeta.closest('.support-modal__panel').find('.support-modal__actions').before(
            '<div class="support-modal__graph-row" style="display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-bottom:1rem;"></div>'
        );
        supportModalValuations = Array.isArray(data.valuations) ? data.valuations.filter(function(v){ return v && v.date; }) : [];
        if (supportModalValuations.length){
            supportModalValuations = supportModalValuations.slice().sort(function(a,b){
                var da = a.date || '';
                var db = b.date || '';
                if (da < db) return -1;
                if (da > db) return 1;
                return 0;
            });
        }
        supportModalValuationsWeekly = Array.isArray(data.valuations_weekly) ? data.valuations_weekly.filter(function(v){ return v && v.week_start; }) : [];
        if (supportModalValuationsWeekly.length){
            supportModalValuationsWeekly = supportModalValuationsWeekly.slice().sort(function(a,b){
                var da = a.week_start || '';
                var db = b.week_start || '';
                if (da < db) return -1;
                if (da > db) return 1;
                return 0;
            });
        }
        if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
        if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
        if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
        var hasGraphData = (supportModalValuations && supportModalValuations.length) || (supportModalValuationsWeekly && supportModalValuationsWeekly.length);
        if (sansNomBtn){
            sansNomBtn.disabled = !hasGraphData;
        }
        updateSansNomButtonState();
        $('#supportCompareStatus').text('');
        if (supportCompareChartInstance){ supportCompareChartInstance.destroy(); supportCompareChartInstance = null; }
        if ($supportCompareChartContainer.length){ $supportCompareChartContainer.hide(); }
        supportCompareValuations = [];
        supportCompareLabel = '';
        renderSupportSeriesTables(false);
        $('#supportModalTitle').text('Support ' + (s.code_isin || ''));
        $supportModalDate.text(data.last_date ? ('Date : ' + data.last_date) : '');
        supportModalLastDate = data.last_date || null;
        var totalText = data.total_valo_str ? (data.total_valo_str + ' ‚Ç¨') : '0 ‚Ç¨';
        $supportModalTotal.text('Total valorisation : ' + totalText);
        $supportModalExport.data('export', data.csv_url || '').prop('disabled', !data.csv_url);
        supportModalTaskTypes = Array.isArray(data.task_types) ? data.task_types : [];
        supportModalCodeIsin = s.code_isin || '';
        populateSupportTaskTypeSelect(data.default_type_id);
        supportModalClientsData = Array.isArray(data.clients) ? data.clients.slice() : [];
        supportModalFilteredData = supportModalClientsData.slice();
        supportClientsPage = 1;
        var hasTaskTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
        $supportModalCreateTasks.prop('disabled', !hasTaskTypes);
        $supportModalClientFilter.val('');
        $supportModalResponsableFilter.val('');
        $supportModalAmountFilter.val('');
        renderSupportModalTable();
        if ($supportClientsSection && $supportClientsSection.length){ $supportClientsSection.hide(); setClientsButtonActive(false); }
    }

    function renderSupportModalTable(){
        if (!supportModalClientsData.length){
            supportModalFilteredData = [];
            $supportModalClients.html('<div class="support-modal__empty">Aucun client ne d√©tient ce support √† la date s√©lectionn√©e.</div>');
            var hasTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
            $supportModalCreateTasks.prop('disabled', !hasTypes);
            return;
        }
        var filters = getSupportModalFilters();
        var filtered = supportModalClientsData.filter(function(row){
            return matchesClientFilters(row, filters);
        });
        supportModalFilteredData = filtered;
        var totalPages = Math.max(1, Math.ceil(filtered.length / supportClientsPageSize));
        if (supportClientsPage > totalPages) supportClientsPage = totalPages;
        if (supportClientsPage < 1) supportClientsPage = 1;
        var hasEligible = filtered.some(function(client){ return client && client.client_id; });
        var hasTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
        $supportModalCreateTasks.prop('disabled', !(hasEligible && hasTypes));
        var startIdx = (supportClientsPage - 1) * supportClientsPageSize;
        var endIdx = startIdx + supportClientsPageSize;
        var rowsHtml = filtered.map(function(client){
            var label = ((client.nom || '') + ' ' + (client.prenom || '')).trim();
            if (!label) label = client.nom || client.prenom || 'Client';
            var href = client.client_id ? ('/dashboard/clients/' + client.client_id) : '#';
            var cell = client.client_id ? '<a href="' + href + '" target="_blank" rel="noopener noreferrer">' + label + '</a>' : label;
            return '<tr>' +
                '<td>' + cell + '</td>' +
                '<td>' + (client.responsable || '‚Äî') + '</td>' +
                '<td>' + (client.total_valo_str || '0') + ' ‚Ç¨</td>' +
            '</tr>';
        });
        var rowsHtmlPage = rowsHtml.slice(startIdx, endIdx).join('');
        if (!rowsHtml){
            supportModalFilteredData = filtered;
            $supportModalClients.html('<div class="support-modal__empty">Aucun r√©sultat ne correspond aux filtres.</div>');
            if ($supportClientsPager.length){
                $supportClientsPager.hide();
            }
            return;
        }
        var tableHtml = '<table>' +
            '<thead><tr><th>Client</th><th>Responsable</th><th>Valorisation</th></tr></thead>' +
            '<tbody>' + rowsHtmlPage + '</tbody></table>';
        $supportModalClients.html(tableHtml);
        if ($supportClientsPager.length){
            $supportClientsPager.show();
            if ($supportClientsPageInfo.length){
                $supportClientsPageInfo.text('Page ' + supportClientsPage + '/' + totalPages);
            }
            if ($supportClientsPrev.length){ $supportClientsPrev.prop('disabled', supportClientsPage <= 1); }
            if ($supportClientsNext.length){ $supportClientsNext.prop('disabled', supportClientsPage >= totalPages); }
        }
    }

    function getSupportModalFilters(){
        return {
            client: ($supportModalClientFilter.val() || '').trim().toLowerCase(),
            responsable: ($supportModalResponsableFilter.val() || '').trim().toLowerCase(),
            amount: ($supportModalAmountFilter.val() || '').trim().toLowerCase()
        };
    }

    function parseAmount(value){
        if (value == null) return NaN;
        var str = String(value).trim().toLowerCase();
        if (!str) return NaN;
        str = str.replace(/\s+/g, '').replace(',', '.');
        var multiplier = 1;
        if (str.endsWith('k')) { multiplier = 1e3; str = str.slice(0,-1); }
        if (str.endsWith('m')) { multiplier = 1e6; str = str.slice(0,-1); }
        var num = parseFloat(str);
        if (!isFinite(num)) return NaN;
        return num * multiplier;
    }

    function matchesAmount(amount, filter){
        if (!filter) return true;
        var val = parseAmount(amount);
        if (!isFinite(val)) return false;
        var expressions = filter.split(/[,;]+/).map(function(exp){ return exp.trim(); }).filter(Boolean);
        if (!expressions.length) expressions = [filter];
        return expressions.every(function(expr){
            if (!expr) return true;
            var range = expr.match(/^([<>]=?|=)?\s*([^<>=]+)$/);
            var between = expr.match(/^([^\-]+)\s*-\s*([^\-]+)$/);
            if (between){
                var a = parseAmount(between[1]);
                var b = parseAmount(between[2]);
                if (!isFinite(a) || !isFinite(b)) return true;
                var min = Math.min(a,b), max = Math.max(a,b);
                return val >= min && val <= max;
            }
            if (range){
                var op = range[1] || '=';
                var num = parseAmount(range[2]);
                if (!isFinite(num)) return true;
                switch(op){
                    case '>': return val > num;
                    case '>=': return val >= num;
                    case '<': return val < num;
                    case '<=': return val <= num;
                    case '=': default: return val === num;
                }
            }
            var num = parseAmount(expr);
            if (isFinite(num)) return val === num;
            return true;
        });
    }

    function matchesClientFilters(client, filters){
        if (filters.client){
            var label = ((client.nom || '') + ' ' + (client.prenom || '')).trim().toLowerCase();
            if (label.indexOf(filters.client) === -1) return false;
        }
        if (filters.responsable){
            var resp = (client.responsable || '').toLowerCase();
            if (resp.indexOf(filters.responsable) === -1) return false;
        }
        if (filters.amount){
            if (!matchesAmount(client.total_valo, filters.amount)) return false;
        }
        return true;
    }

    function populateSupportTaskTypeSelect(defaultId){
        var groups = Array.isArray(supportModalTaskTypes) ? supportModalTaskTypes : [];
        var html = '';
        if (!groups.length){
            html = '<option value="">-- Aucun type disponible --</option>';
        } else {
            var multipleGroups = groups.length > 1;
            groups.forEach(function(group){
                var types = Array.isArray(group.types) ? group.types : [];
                if (!types.length) return;
                if (multipleGroups){
                    html += '<optgroup label="' + escHtml(group.label || group.categorie || 'T√¢che') + '">';
                }
                types.forEach(function(entry){
                    if (entry.id == null) return;
                    html += '<option value="' + escHtml(entry.id) + '">' + escHtml(entry.libelle || ('Type #' + entry.id)) + '</option>';
                });
                if (multipleGroups){
                    html += '</optgroup>';
                }
            });
            if (!html){
                html = '<option value="">-- Aucun type disponible --</option>';
            }
        }
        $supportTaskTypeSelect.html(html);
        if (defaultId != null && $supportTaskTypeSelect.find('option[value="' + defaultId + '"]').length){
            $supportTaskTypeSelect.val(String(defaultId));
        }
        if (!$supportTaskTypeSelect.val()){
            var first = $supportTaskTypeSelect.find('option[value!=""]').first();
            if (first.length){
                $supportTaskTypeSelect.val(first.val());
            }
        }
        var hasTypes = $supportTaskTypeSelect.find('option[value!=""]').length > 0;
        var hasEligible = (supportModalFilteredData || []).some(function(client){ return client && client.client_id; });
        $supportModalCreateTasks.prop('disabled', !(hasTypes && hasEligible));
    }

    function openSupportTaskModal(){
        var eligible = (supportModalFilteredData || []).filter(function(client){ return client && client.client_id; });
        if (!eligible.length){
            alert('Aucun client s√©lectionn√© pour cr√©er des t√¢ches.');
            return;
        }
        populateSupportTaskTypeSelect($supportTaskTypeSelect.val());
        $supportTaskComment.val('');
        $supportTaskStatus.text(eligible.length + ' client(s) s√©lectionn√©(s).');
        $supportTaskSubmit.prop('disabled', false).text('Cr√©er les t√¢ches');
        $supportTaskModal.addClass('open').attr('aria-hidden', 'false');
    }

    function closeSupportTaskModal(){
        $supportTaskModal.removeClass('open').attr('aria-hidden', 'true');
        $supportTaskStatus.text('');
    }

    function submitSupportTasks(){
        var eligible = (supportModalFilteredData || []).filter(function(client){ return client && client.client_id; });
        if (!eligible.length){
            $supportTaskStatus.text('Aucun client s√©lectionn√©.');
            return;
        }
        var typeId = $supportTaskTypeSelect.val();
        if (!typeId){
            $supportTaskStatus.text('S√©lectionnez un type de t√¢che.');
            return;
        }
        var uniqueIds = [];
        eligible.forEach(function(client){
            if (uniqueIds.indexOf(client.client_id) === -1){
                uniqueIds.push(client.client_id);
            }
        });
        var payload = {
            code_isin: supportModalCodeIsin,
            client_ids: uniqueIds,
            type_id: typeId,
            commentaire: $supportTaskComment.val() || ''
        };
        $supportTaskSubmit.prop('disabled', true).text('Cr√©ation...');
        $supportTaskStatus.text('Cr√©ation des t√¢ches en cours...');
        fetch('/dashboard/supports/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(function(resp){
            if (!resp.ok){
                return resp.json().catch(function(){ return {detail: 'Erreur ' + resp.status}; }).then(function(err){ throw err; });
            }
            return resp.json();
        }).then(function(result){
            $supportTaskStatus.text(result.message || 'T√¢ches cr√©√©es.');
            setTimeout(function(){
                closeSupportTaskModal();
            }, 1200);
        }).catch(function(err){
            var msg = err && (err.detail || err.message) ? (err.detail || err.message) : 'Erreur lors de la cr√©ation.';
            $supportTaskStatus.text(msg);
        }).finally(function(){
            $supportTaskSubmit.prop('disabled', false).text('Cr√©er les t√¢ches');
        });
    }

    $('#supportsTable tbody').on('click', 'a.support-link', function(e){
        e.preventDefault();
        var code = $(this).data('isin');
        if (!code) return;
        openSupportModal();
        renderSupportModalLoading(code);
        fetch('/dashboard/supports/details?code_isin=' + encodeURIComponent(code))
            .then(function(resp){
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                return resp.json();
            })
            .then(function(data){
                console.debug('Support details total_valo:', data?.total_valo, 'clients_total_valo:', data?.clients_total_valo);
                renderSupportModal(data);
            })
            .catch(function(err){
                $supportModalMeta.html('<div><span class="label">Erreur</span><span class="value">' + (err.message || 'Impossible de r√©cup√©rer les donn√©es') + '</span></div>');
                $supportModalClients.empty();
                $supportModalExport.prop('disabled', true);
                supportModalValuations = [];
                if (supportModalChartInstance){ supportModalChartInstance.destroy(); supportModalChartInstance = null; }
                if ($supportModalChartContainer.length){ $supportModalChartContainer.hide(); }
                if ($supportModalSeries.length){ $supportModalSeries.hide().empty(); }
            });
    });

    $('#supportModalClose').on('click', function(){ closeSupportModal(); });
    $supportModal.on('click', function(e){ if (e.target === this) { closeSupportModal(); } });
    $(document).on('keyup', function(e){
        if (e.key === 'Escape'){
            if ($supportTaskModal.hasClass('open')) { closeSupportTaskModal(); return; }
            closeSupportModal();
        }
    });
    $supportModalExport.on('click', function(){
        var url = $(this).data('export');
        if (!url) return;
        window.location.href = url;
    });
    $('#supportCompareToggle').on('click', function(){ toggleSupportCompare(); });
    $('#supportCompareBtn').on('click', function(){ 
        var term = ($('#supportCompareInput').val() || '').trim();
        if (term){ fetchComparison(term); }
    });
    $('#supportCompareInput').on('keydown', function(e){ 
        if (e.key === 'Enter'){ 
            e.preventDefault(); 
            var term = ($('#supportCompareInput').val() || '').trim();
            if (term){ fetchComparison(term); }
        } 
    });
    $('#supportEsgToggle').on('click', function(){
        if ($('#supportEsgSection').is(':visible')){
            if (supportEsgChartInstance){ supportEsgChartInstance.destroy(); supportEsgChartInstance = null; }
            $('#supportEsgChart').hide().empty();
            $('#supportEsgUnmatched').hide().text('');
            $('#supportEsgSection').hide();
            setEsgButtonActive(false);
        } else {
            $('#supportEsgSection').show();
            setEsgButtonActive(true);
            loadSupportEsgMeta(function(){
                ensurePlotlySupportEsg(function(){
                    renderSupportEsgFields();
                    renderSupportEsgAllocOptions();
                    runSupportEsg();
                });
            });
        }
    });
    $('#supportEsgRefresh').on('click', function(){ runSupportEsg(); });
    $('#supportClientsToggle').on('click', function(){
        if (!$supportClientsSection || !$supportClientsSection.length) return;
        var isVisible = $supportClientsSection.is(':visible');
        if (isVisible){
            $supportClientsSection.slideUp(120);
            setClientsButtonActive(false);
        } else {
            $supportClientsSection.slideDown(120);
            setClientsButtonActive(true);
        }
    });
    if ($supportClientsPager.length){
        $supportClientsPrev.on('click', function(){
            if (supportClientsPage > 1){ supportClientsPage -= 1; renderSupportModalTable(); }
        });
        $supportClientsNext.on('click', function(){
            supportClientsPage += 1;
            renderSupportModalTable();
        });
    }

    function scheduleModalReRender(){
        clearTimeout(scheduleModalReRender._id);
        supportClientsPage = 1;
        scheduleModalReRender._id = setTimeout(renderSupportModalTable, 120);
    }
    $supportModalClientFilter.on('input', scheduleModalReRender);
    $supportModalResponsableFilter.on('input', scheduleModalReRender);
    $supportModalAmountFilter.on('input', scheduleModalReRender);
    $supportModalFiltersReset.on('click', function(){
        $supportModalClientFilter.val('');
        $supportModalResponsableFilter.val('');
        $supportModalAmountFilter.val('');
        supportClientsPage = 1;
        renderSupportModalTable();
    });
    $supportModalCreateTasks.on('click', function(){ if ($(this).prop('disabled')) return; openSupportTaskModal(); });
    $supportTaskCancel.on('click', function(){ closeSupportTaskModal(); });
    $supportTaskModalClose.on('click', function(){ closeSupportTaskModal(); });
    $supportTaskModal.on('click', function(e){ if (e.target === this) { closeSupportTaskModal(); } });
    $supportTaskSubmit.on('click', function(){ submitSupportTasks(); });
});
</script>

{% endblock %}
