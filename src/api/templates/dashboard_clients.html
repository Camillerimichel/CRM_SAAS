{% extends "base.html" %}

{% block title %}Clients{% endblock %}
{% block header_title %}<i class="fa-solid fa-users" style="margin-right:8px;"></i>Clients{% endblock %}

{% block content %}
<style>
    .main-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 2rem;
        margin: 2rem auto;
    }
    .header-section {
        background: var(--primary);
        color: #fff;
        padding: 1.2rem;
        border-radius: 10px;
        margin-bottom: 1.2rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
    }
    .top-row {
        display: flex;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .srri-info {
        flex: 1;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
    }
    .srri-chart {
        flex: 1;
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    /* En-t√™tes de tableau h√©ritent du style global (base.html) */
    thead input, thead select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 13px;
    }
    tbody td {
        padding: 10px 8px;
        font-size: 0.95rem; /* harmonise police avec valorisation */
    }
    .srri-calc {
        margin-left: 6px;
        font-size: 11px;
        color: #666;
        vertical-align: middle;
    }
    .valo-amount {
        font-weight: 600;
        color: #28a745;
        text-align: right;
        font-family: monospace;
        font-size: 0.95rem; /* m√™me taille que le reste */
    }
    /* Alignements demand√©s */
    #clientsTable thead th:nth-child(3),
    #clientsTable tbody td:nth-child(3),
    #clientsTable thead th:nth-child(4),
    #clientsTable tbody td:nth-child(4) { text-align: center; } /* SRRI & ic√¥ne centr√©s */
    #clientsTable thead th:nth-child(6),
    #clientsTable tbody td:nth-child(6),
    #clientsTable thead th:nth-child(7),
    #clientsTable tbody td:nth-child(7) { text-align: right; } /* Perf 52s & Volatilit√© √† droite */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .clear-btn {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    .restore-note { display:none; font-size:12px; color:#666; margin: 2px 0 6px 0; }
    .restore-note .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2f7; border:1px solid #dde3ea; color:#445; font-weight:600; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin: .5rem 0 8px 0; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: var(--surface); cursor:pointer; font-size:12px; color: var(--text); text-decoration:none; }
    .chip:hover { background: var(--primary-100); color: var(--primary-600); }
</style>

<div class="main-container">
    <div class="header-section">
        <p><strong>Total clients :</strong> {{ total_clients }}</p>
    </div>

    

    <h2>Liste des clients</h2>
    <div class="table-container">
        <div id="restoreClients" class="restore-note"><span class="badge">Filtres restaur√©s <a href="#" class="close" onclick="return resetRestoredClients()">√ó</a></span></div>
        <div id="quickToggleCli" class="card accordion-toggle" style="margin-bottom:.5rem; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;">
            <h3 style="margin:0; font-size:1.05rem;">Filtres rapides</h3>
            <span class="chevron">‚ñæ</span>
        </div>
        <div id="quickSectionCli" style="display:none;">
        <div class="toolbar">
            <div class="chips">
                <span style="color:#666; font-size:12px; margin-right:4px;">Raccourcis:</span>
                <a class="chip" href="#" onclick="return chipRisk('all')">Risque: Tous</a>
                <a class="chip" href="#" onclick="return chipRisk('üî•')">üî• Au‚Äëdessus</a>
                <a class="chip" href="#" onclick="return chipRisk('üôè')">üôè Identique</a>
                <a class="chip" href="#" onclick="return chipRisk('‚ùÑÔ∏è')">‚ùÑÔ∏è En‚Äëdessous</a>
                <a class="chip" href="#" onclick="return chipSrri('')">SRRI: Tous</a>
                <a class="chip" href="#" onclick="return chipSrri('1')">SRRI: 1</a>
                <a class="chip" href="#" onclick="return chipSrri('2')">SRRI: 2</a>
                <a class="chip" href="#" onclick="return chipSrri('3')">SRRI: 3</a>
                <a class="chip" href="#" onclick="return chipSrri('4')">SRRI: 4</a>
                <a class="chip" href="#" onclick="return chipSrri('5')">SRRI: 5</a>
                <a class="chip" href="#" onclick="return chipSrri('6')">SRRI: 6</a>
                <a class="chip" href="#" onclick="return chipSrri('7')">SRRI: 7</a>
            </div>
            <div class="toolbar-actions">
                <button class="btn btn-primary" onclick="exportClientsCSV()">‚¨áÔ∏è Export CSV</button>
                <button class="btn btn-danger" onclick="clearFilters()">üóëÔ∏è Effacer</button>
            </div>
        </div>
        </div>
        <table id="clientsTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Pr√©nom</th>
                    <th>SRRI</th>
                    <th>Risque</th>
                    <th>Valorisation</th>
                    <th>Perf 52 sem.</th>
                    <th>Volatilit√©</th>
                </tr>
                <tr>
                    <th><input type="text" id="nom-filter" placeholder="Filtrer..."></th>
                    <th><input type="text" id="prenom-filter" placeholder="Filtrer..."></th>
                    <th><select id="srri-filter"><option value="">Tous</option></select></th>
                    <th>
                        <select id="srri-icon-filter">
                            <option value=""></option>
                            <option value="‚ùÑÔ∏è">‚ùÑÔ∏è</option>
                            <option value="üôè">üôè</option>
                            <option value="üî•">üî•</option>
                        </select>
                    </th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for c in clients %}
                <tr>
                    <td><a href="/dashboard/clients/{{ c.id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ c.nom }}</a></td>
                    <td>{{ c.prenom }}</td>
                    <td>{{ c.SRRI }}</td>
                    <td style="text-align:center;">
                        {% if c.srri_icon == 'fire' %}üî•{% elif c.srri_icon == 'hands-praying' %}üôè{% elif c.srri_icon == 'snowflake' %}‚ùÑÔ∏è{% else %}{% endif %}
                        {% if c.srri_hist is not none %}<span class="srri-calc">{{ c.srri_hist }}</span>{% endif %}
                    </td>
                    <td class="valo-amount">{{ c.total_valo }}</td>
                    <td>{{ c.perf_52_sem }}</td>
                    <td>{{ c.volatilite }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    

    <div class="pagination-container">
        <div id="results-info"></div>
        <button class="clear-btn" onclick="clearFilters()">üóëÔ∏è Effacer</button>
    </div>
</div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- FixedHeader -->
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<!-- Chart.js (plus utilis√© sur cette page) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function () {
    // (bucket prefilter removed)
    var table = $('#clientsTable').DataTable({
        order: [[4, "desc"]], // trier par valorisation (colonne 5 apr√®s Nom)
        pageLength: 25,
        fixedHeader: true,
        columnDefs: [
            {
                targets: 4, // Valorisation
                render: $.fn.dataTable.render.number(' ', ',', 0, '', ' ‚Ç¨')
            },
            {
                targets: 5, // Perf 52 sem.
                render: function (data) {
                    if (data === null || data === undefined || data === '') return '';
                    var num = parseFloat(data);
                    if (isNaN(num)) return data;
                    return num.toFixed(2) + ' %';
                }
            },
            {
                targets: 6, // Volatilit√©
                render: function (data) {
                    if (data === null || data === undefined || data === '') return '';
                    var num = parseFloat(data);
                    if (isNaN(num)) return data;
                    return num.toFixed(2) + ' %';
                }
            }
        ],
        initComplete: function () {
            var api = this.api();

            // remplir SRRI unique
            var srriSelect = $('#srri-filter');
            api.column(2).data().unique().sort().each(function (d) {
                if (d) srriSelect.append('<option value="'+d+'">'+d+'</option>');
            });

            srriSelect.on('change', function () {
                var val = $(this).val();
                api.column(2).search(val ? '^'+$.fn.dataTable.util.escapeRegex(val)+'$' : '', true, false).draw();
                try { var params=new URLSearchParams(window.location.search); if(val) params.set('srri', val); else params.delete('srri'); var u=window.location.pathname + (params.toString()?('?'+params.toString()):''); window.history.replaceState({}, '', u); } catch(e) {}
                try { saveClientsState(); } catch(e) {}
            });

        }
    });

    // filtres texte
    function saveClientsState(){
      try {
        var st = {
          nom: $('#nom-filter').val() || '',
          prenom: $('#prenom-filter').val() || '',
          srri: $('#srri-filter').val() || '',
          risk: $('#srri-icon-filter').val() || ''
        };
        localStorage.setItem('clients_filters', JSON.stringify(st));
      } catch(e) {}
    }
    $('#nom-filter').on('keyup change', function () { table.column(0).search(this.value).draw(); saveClientsState(); });
    $('#prenom-filter').on('keyup change', function () { table.column(1).search(this.value).draw(); saveClientsState(); });

    // filtre par ic√¥ne SRRI (colonne 4)
    $('#srri-icon-filter').on('change', function(){
        var val = $(this).val();
        table.column(3).search(val).draw();
        try { var params=new URLSearchParams(window.location.search); if(val) params.set('risk', val); else params.delete('risk'); var u=window.location.pathname + (params.toString()?('?'+params.toString()):''); window.history.replaceState({}, '', u); } catch(e) {}
        try { saveClientsState(); } catch(e) {}
    });

    // bouton effacer
    window.clearFilters = function() {
        $('#nom-filter, #prenom-filter').val('');
        $('#srri-filter').val('').trigger('change');
        $('#srri-icon-filter').val('');
        table.search('');
        table.columns().every(function(){ this.search(''); });
        table.draw();
        try { var params=new URLSearchParams(window.location.search); ['risk','srri'].forEach(k=>params.delete(k)); var u=window.location.pathname + (params.toString()?('?'+params.toString()):''); window.history.replaceState({}, '', u);} catch(e) {}
        try { localStorage.removeItem('clients_filters'); } catch(e) {}
    };

    // S√©curit√©: au chargement, s'assurer qu'aucun filtre n'est appliqu√©
    (function(){
        try {
            $('#srri-filter').val('');
            $('#srri-icon-filter').val('');
            table.search('');
            table.columns().every(function(){ this.search(''); });
            table.draw();
        } catch(e) {}
    })();

    // Pr√©filtres via URL: risk= (above/equal/below/emoji) et srri= ; sinon restaurer depuis localStorage
    (function(){
      try {
        const params = new URLSearchParams(window.location.search);
        let used = false;
        let risk = params.get('risk');
        if (risk){
          const map = { 'above':'üî•', 'equal':'üôè', 'below':'‚ùÑÔ∏è', 'fire':'üî•', 'hands-praying':'üôè', 'snowflake':'‚ùÑÔ∏è', 'üî•':'üî•', 'üôè':'üôè', '‚ùÑÔ∏è':'‚ùÑÔ∏è' };
          const icon = map[String(risk).toLowerCase ? String(risk).toLowerCase() : risk] || map[risk];
          const sel = document.getElementById('srri-icon-filter'); if (sel && icon){ sel.value = icon; sel.dispatchEvent(new Event('change')); used = true; }
        }
        const srri = params.get('srri');
        if (srri){ const s = document.getElementById('srri-filter'); if(s){ s.value = srri; s.dispatchEvent(new Event('change')); used = true; } }
        if (!used){
          const raw = localStorage.getItem('clients_filters');
          if (raw){
            const st = JSON.parse(raw);
            if (st){
              let restored=false;
              if (st.nom){ $('#nom-filter').val(st.nom).trigger('change'); restored=true; }
              if (st.prenom){ $('#prenom-filter').val(st.prenom).trigger('change'); restored=true; }
              if (st.srri){ $('#srri-filter').val(st.srri).trigger('change'); restored=true; }
              if (st.risk){ $('#srri-icon-filter').val(st.risk).trigger('change'); restored=true; }
              if (restored){ try{ document.getElementById('restoreClients').style.display='block'; }catch(e){} }
            }
          }
        }
      } catch(e) { /* ignore */ }
    })();
    (function(){try{var t=document.getElementById('quickToggleCli'),s=document.getElementById('quickSectionCli');if(!t||!s)return;function setOpen(o){s.style.display=o?'':'none';t.classList.toggle('collapsed',!o);localStorage.setItem('cli_quick_open',o?'1':'');}var saved=localStorage.getItem('cli_quick_open')==='1';setOpen(saved);t.addEventListener('click',function(){setOpen(s.style.display==='none');});}catch(e){}})();

    // Chips actions
    window.chipRisk = function(val){ var sel=document.getElementById('srri-icon-filter'); if(val==='all'){ sel.value=''; } else { sel.value=val; } sel.dispatchEvent(new Event('change')); return false; };
    window.chipSrri = function(val){ var s=document.getElementById('srri-filter'); s.value=(val||''); s.dispatchEvent(new Event('change')); return false; };

    // Export CSV (lignes filtr√©es)
    window.exportClientsCSV = function(){ try{ var headers=[]; $('#clientsTable thead tr').first().find('th').each(function(){ headers.push($(this).text().trim()); }); var rows=[]; table.rows({search:'applied'}).every(function(){ var d=this.data(); rows.push(d.map(function(cell){ var t=$('<div>').html(cell).text(); if (t.indexOf(',')!==-1||t.indexOf('"')!==-1||t.indexOf('\n')!==-1){ t='"'+t.replace(/"/g,'""')+'"'; } return t; }).join(',')); }); var csv=headers.join(',')+'\n'+rows.join('\n'); var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='clients_export.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);}catch(e){} };

    // (Graphiques SRRI retir√©s de cette page ‚Äî pr√©sents sur le tableau de bord)

    // reset depuis le badge restaur√©
    window.resetRestoredClients = function(){ try{ document.getElementById('restoreClients').style.display='none'; }catch(e){}; try{ window.clearFilters(); }catch(e){}; return false; };

    
});
</script>

{% endblock %}
