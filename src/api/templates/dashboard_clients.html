{% extends "base.html" %}

{% block title %}Clients{% endblock %}
{% block header_title %}<i class="fa-solid fa-users" style="margin-right:8px;"></i>Clients{% endblock %}

{% block content %}
<style>
  .main-container { background: white; border-radius: 12px; box-shadow: var(--shadow-sm); padding: 1rem; }
  .filters { display: grid; grid-template-columns: repeat(4, 1fr); gap: .6rem; margin: .5rem 0 1rem; }
  .filters input, .filters select { height: 36px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; background:#fff; }
  table { width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: var(--shadow-sm); }
  thead th { background: var(--primary); color: #fff; font-weight: 600; text-transform: uppercase; font-size: .8rem; letter-spacing: .02em; padding: .65rem .6rem; }
  tbody td { border-top: 1px solid var(--border); padding: .6rem .6rem; font-size: .92rem; }
  tbody tr:nth-child(odd) td { background: #fcfdff; }
  tbody tr:hover td { background: #f8fbff; }
  .right { text-align: right; font-family: var(--font-mono, ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace); }
  .muted { color: var(--muted); }
  .toolbar { display:flex; justify-content: space-between; align-items:center; margin:.4rem 0 .6rem; }
  .btn { border:1px solid var(--border); border-radius:8px; padding:.4rem .7rem; background:#fff; cursor:pointer; }
  /* en-tête supprimé */
  .center { text-align:center; }
  /* Centrer SRRI (col 3) et SRRI calculé (col 4) */
  #clientsTbl thead th:nth-child(3),
  #clientsTbl tbody td:nth-child(3),
  #clientsTbl thead th:nth-child(4),
  #clientsTbl tbody td:nth-child(4) { text-align: center; }
  /* Pastilles SRRI */
  .srri-dot { display:inline-block; width: 1em; height: 1em; border-radius: 50%; vertical-align: middle; }
  .srri-red { background:#ef4444; }
  .srri-green { background:#16a34a; }
  .srri-blue { background:#3b82f6; }
</style>

<div class="main-container">
  <h2>Liste des clients</h2>

  <div class="filters">
    <input type="text" id="fNom" placeholder="Filtrer Nom…" />
    <input type="text" id="fPrenom" placeholder="Filtrer Prénom…" />
    <select id="fSrri"><option value="">SRRI: Tous</option></select>
    <select id="fSrriCalc"><option value="">SRRI calculé: Tous</option></select>
  </div>

  <div class="toolbar">
    <div class="muted" id="resultsInfo"></div>
    <button class="btn" id="btnClear">Effacer les filtres</button>
  </div>

  <table id="clientsTbl">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>SRRI</th>
        <th>SRRI calculé</th>
        <th class="right">Valorisation</th>
        <th class="right">Perf 52 sem.</th>
        <th class="right">Volatilité</th>
      </tr>
    </thead>
    <tbody>
      {% for c in clients %}
      <tr>
        <td><a href="/dashboard/clients/{{ c.id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ c.nom }}</a></td>
        <td>{{ c.prenom }}</td>
        <td>{{ c.SRRI }}</td>
        <td>{{ c.srri_hist if c.srri_hist is not none else '' }}</td>
        <td class="right">{{ c.total_valo }}</td>
        <td class="right">{{ c.perf_52_sem }}</td>
        <td class="right">{{ c.volatilite }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
(function(){
  function fmtMoney(val){
    var n = Number(val);
    if (!isFinite(n)) return '';
    var s = n.toFixed(2);
    var parts = s.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    return parts.join('.');
  }
  function fmtPct(frac){
    var n = Number(frac);
    if (!isFinite(n)) return '';
    return (n*100).toFixed(2) + ' %';
  }
  function text(el){ return (el?.textContent || '').trim(); }
  function setText(el, v){ if (el) el.textContent = v; }

  var tbl = document.getElementById('clientsTbl');
  var rows = Array.prototype.slice.call(tbl.querySelectorAll('tbody tr'));

  // Format numeric columns once
  rows.forEach(function(tr){
    var tds = tr.querySelectorAll('td');
    // Valorisation (index 4)
    var v = text(tds[4]);
    setText(tds[4], fmtMoney(v));
    // Perf (index 5)
    var p = text(tds[5]);
    setText(tds[5], fmtPct(p));
    // Volatilité (index 6)
    var vol = text(tds[6]);
    setText(tds[6], fmtPct(vol));
  });

  // Build filter options (SRRI + Risque)
  var srriSet = new Set();
  var srriCalcSet = new Set();
  rows.forEach(function(tr){
    var tds = tr.querySelectorAll('td');
    var srri = text(tds[2]);
    var srriCalc = text(tds[3]);
    if (srri) srriSet.add(srri);
    if (srriCalc) srriCalcSet.add(srriCalc);
  });
  var fSrri = document.getElementById('fSrri');
  Array.from(srriSet).sort(function(a,b){ return Number(a)-Number(b); }).forEach(function(v){
    var opt = document.createElement('option'); opt.value = v; opt.textContent = v; fSrri.appendChild(opt);
  });
  var fSrriCalc = document.getElementById('fSrriCalc');
  Array.from(srriCalcSet).sort(function(a,b){ return Number(a)-Number(b); }).forEach(function(v){
    var opt = document.createElement('option'); opt.value = v; opt.textContent = v; fSrriCalc.appendChild(opt);
  });

  var fNom = document.getElementById('fNom');
  var fPrenom = document.getElementById('fPrenom');
  var resultsInfo = document.getElementById('resultsInfo');

  // Coloration conditionnelle du SRRI calculé vs SRRI
  rows.forEach(function(tr){
    var tds = tr.querySelectorAll('td');
    var srri = Number(text(tds[2]));
    var calc = Number(text(tds[3]));
    if (!isNaN(srri) && !isNaN(calc)){
      if (calc > srri) tds[3].style.color = '#dc2626'; /* rouge */
      else if (calc === srri) tds[3].style.color = '#16a34a'; /* vert */
      else tds[3].style.color = getComputedStyle(document.documentElement).getPropertyValue('--primary-600') || '#1e3a8a'; /* bleu foncé */
      // Ajouter une pastille colorée pour indiquer le rapport (Au‑dessus=bleu / Identique=vert / En‑dessous=rouge)
      var dot = document.createElement('span');
      dot.className = 'srri-dot ' + (calc>srri ? 'srri-blue' : (calc===srri ? 'srri-green' : 'srri-red'));
      dot.title = (calc>srri ? 'Au‑dessus' : (calc===srri ? 'Identique' : 'En‑dessous'));
      dot.style.marginLeft = '6px';
      tds[3].appendChild(dot);
    }
  });

  function applyFilters(){
    var qNom = (fNom.value||'').toLowerCase();
    var qPre = (fPrenom.value||'').toLowerCase();
    var qSrri = fSrri.value||'';
    var qSrriCalc = fSrriCalc.value||'';
    // Risk mode from URL (?risk=above|equal|below)
    var params = new URLSearchParams(window.location.search);
    var riskMode = (params.get('risk')||'').toLowerCase();
    var visible = 0;
    rows.forEach(function(tr){
      var tds = tr.querySelectorAll('td');
      var nom = text(tds[0]).toLowerCase();
      var prenom = text(tds[1]).toLowerCase();
      var srri = text(tds[2]);
      var srriCalc = text(tds[3]);
      var ok = true;
      if (qNom && nom.indexOf(qNom) === -1) ok = false;
      if (ok && qPre && prenom.indexOf(qPre) === -1) ok = false;
      if (ok && qSrri && srri !== qSrri) ok = false;
      if (ok && qSrriCalc && srriCalc !== qSrriCalc) ok = false;
      if (ok && riskMode){
        var s = Number(srri), c = Number(srriCalc);
        if (isFinite(s) && isFinite(c)){
          if (riskMode === 'above' && !(c > s)) ok = false;
          else if (riskMode === 'equal' && !(c === s)) ok = false;
          else if (riskMode === 'below' && !(c < s)) ok = false;
        }
      }
      tr.style.display = ok ? '' : 'none';
      if (ok) visible++;
    });
    resultsInfo.textContent = visible + ' / ' + rows.length + ' affichés';
  }

  ['input','change'].forEach(function(ev){ fNom.addEventListener(ev, applyFilters); fPrenom.addEventListener(ev, applyFilters); });
  fSrri.addEventListener('change', applyFilters);
  fSrriCalc.addEventListener('change', applyFilters);
  document.getElementById('btnClear').addEventListener('click', function(){
    fNom.value = ''; fPrenom.value = ''; fSrri.value = ''; fSrriCalc.value = ''; applyFilters();
  });

  // Initial state
  applyFilters();
})();
</script>

{% endblock %}
