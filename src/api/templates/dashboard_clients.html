{% extends "base.html" %}

{% block title %}Clients{% endblock %}
{% block header_title %}<i class="fa-solid fa-users" style="margin-right:8px;"></i>Clients{% endblock %}

{% block content %}
<style>
    .main-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        padding: 1.5rem;
        margin: 1.2rem auto;
    }
    .badge-filter { display:inline-flex; align-items:center; gap:6px; background:#eef2ff; color:#1d4ed8; border:1px solid #c7d2fe; border-radius:999px; padding:4px 10px; font-size:.85rem; }
    .badge-filter .x { color:#1d4ed8; text-decoration:none; opacity:.8; }
    .badge-filter .x:hover { opacity:1; }
    .badge-row { display:flex; gap:6px; flex-wrap:wrap; margin:.25rem 0 .5rem 0; }
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin: .5rem 0 8px 0; }
    table { width: 100%; border-collapse: collapse; background: white; }
    thead input, thead select { width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 13px; box-sizing:border-box; }
    tbody td { padding: 10px 8px; }
    .pagination-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    .btn-danger { background: #ef4444; color:#fff; border-color:#ef4444; }
    .btn-danger:hover { background:#dc2626; }
</style>

{% set tb_markers_param = tb_markers_param or '' %}
{% set tb_markers_visible = tb_markers_visible or false %}

<div class="tb-page{% if tb_markers_visible %} tb-markers-enabled{% endif %}" data-tb-marker="TB_201">
  <div class="main-container" data-tb-marker="TB_202">
    <h2 data-tb-marker="TB_203">Liste des clients</h2>
    <div id="cf_active_badges" class="badge-row" data-tb-marker="TB_205">
      {% if group_filter_label %}
        <div class="badge-filter">
          Groupe : {{ group_filter_label }}
          {% if tb_markers_visible %}
            <a class="x" href="/dashboard/clients?{{ tb_markers_param }}">√ó</a>
          {% else %}
            <a class="x" href="/dashboard/clients">√ó</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
    <div class="toolbar" id="clientsGroupActions" style="display:none; margin-bottom:8px;">
      <div class="muted">Cr√©er des t√¢ches group√©es sur la s√©lection filtr√©e.</div>
      <button class="btn btn-primary" type="button" id="btnGroupedTasksClients">Cr√©er des t√¢ches group√©es</button>
    </div>

    <div class="table-container">
      <table id="clientsTable" class="display nowrap" style="width:100%">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Pr√©nom</th>
            <th>Responsable</th>
            <th>SRRI calcul√©</th>
            <th>Valorisation</th>
            <th>Perf 52 sem. (%)</th>
            <th>Volatilit√© (%)</th>
          </tr>
          <tr>
            <th><input type="text" id="client-nom-filter" placeholder="Filtrer..."></th>
            <th><input type="text" id="client-prenom-filter" placeholder="Filtrer..."></th>
            <th><input type="text" id="client-resp-filter" placeholder="Filtrer..."></th>
            <th>
              <select id="client-srri-filter">
                <option value=""></option>
                {% for s in srri_options %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
              </select>
            </th>
            <th><input type="text" id="client-valo-filter" placeholder="Ex: >100k, 100k-500k"></th>
            <th><input type="text" id="client-perf-filter" placeholder="Ex: >5, 3-7"></th>
            <th><input type="text" id="client-vol-filter" placeholder="Ex: <10, 2-6"></th>
          </tr>
        </thead>
        <tbody>
          {% for c in clients %}
          <tr data-client-id="{{ c.id }}">
            <td>
              <a href="/dashboard/clients/{{ c.id }}" target="_blank" style="text-decoration:underline; color: inherit;">
                {{ c.nom }}
              </a>
            </td>
            <td>{{ c.prenom }}</td>
            <td>{{ c.responsable or '‚Äî' }}</td>
            <td style="text-align:center;">{{ c.srri_hist if c.srri_hist is not none else '' }}</td>
            <td data-valo="{{ c.total_valo if c.total_valo is not none else '' }}" style="text-align:right;">{{ c.total_valo_str }}</td>
            <td data-perf="{{ c.perf_52_sem if c.perf_52_sem is not none else '' }}" style="text-align:right;">{{ c.perf_52_sem_str }}</td>
            <td data-vol="{{ c.volatilite if c.volatilite is not none else '' }}" style="text-align:right;">{{ c.volatilite_str }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% set cur_page = page|default(1) %}
    {% set max_pages = total_pages|default(1) %}
    {% set total_cli = total_clients|default(0) %}
    {% set total_cli_filtered = total_clients_filtered|default(total_cli) %}
    <div class="pagination-container">
      <div id="clients-results-info">Page {{ cur_page }}/{{ max_pages }} ‚Äî {{ total_cli_filtered }} clients affich√©s ({{ total_cli }} au total)</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" type="button" onclick="changeClientPage(-1)" {% if cur_page <= 1 %}disabled{% endif %}>Pr√©c√©dent</button>
        <button class="btn" type="button" onclick="changeClientPage(1)" {% if cur_page >= max_pages %}disabled{% endif %}>Suivant</button>
        <button class="btn btn-danger" onclick="clearClientFilters()">üóëÔ∏è Effacer</button>
      </div>
    </div>
  </div>
</div>

{% include "fragments/grouped_tasks_modal.html" %}

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<script>
$(document).ready(function () {
    const groupedTasksCfgClients = {
        scope: 'clients',
        taskTypes: {{ grouped_task_types | tojson }},
        responsables: {{ responsables | tojson }},
        hasServerFilter: {{ 'true' if (total_clients_filtered|default(0)) < (total_clients|default(0)) else 'false' }},
        groupFilterActive: {{ 'true' if group_filter_label else 'false' }}
    };
    const actionsBar = document.getElementById('clientsGroupActions');
    const btnGrouped = document.getElementById('btnGroupedTasksClients');
    var table = $('#clientsTable').DataTable({
        dom: 'rt', // filtrage/tri uniquement, pagination c√¥t√© serveur
        paging: false,
        info: false,
        order: [[4, "desc"]],
        columnDefs: [
          { targets: 0, width: '200px' },
          { targets: 1, width: '160px' },
          { targets: 2, width: '180px' },
          { targets: 3, width: '110px', className: 'dt-center' },
          { targets: 4, width: '140px' },
          { targets: 5, width: '120px' },
          { targets: 6, width: '120px' }
        ]
    });

    // Filtres texte
    $('#client-nom-filter').on('keyup change', function(){ table.column(0).search(this.value).draw(); });
    $('#client-prenom-filter').on('keyup change', function(){ table.column(1).search(this.value).draw(); });
    $('#client-resp-filter').on('keyup change', function(){ table.column(2).search(this.value).draw(); });
    $('#client-srri-filter').on('change', function(){ table.column(3).search(this.value).draw(); });

    // Filtres num√©riques avanc√©s (valo/perf/vol)
    function parseNumToken(raw){
      var s = String(raw||'').trim().toLowerCase().replace(/\s+/g,'');
      s = s.replace(',', '.');
      var m = s.match(/^([-+]?\d*\.?\d+)([km]?)$/);
      if (!m) return NaN;
      var n = parseFloat(m[1]);
      if (m[2] === 'k') n *= 1e3; else if (m[2] === 'm') n *= 1e6;
      return n;
    }
    function toNum(raw){
      if (raw === undefined || raw === null) return null;
      var s = String(raw).replace(/[^0-9,.\-]/g, '').replace(',', '.');
      if (!s) return null;
      var n = parseFloat(s);
      return Number.isFinite(n) ? n : null;
    }
    function normalizePct(n){
      if (!Number.isFinite(n)) return null;
      return Math.abs(n) <= 1 ? n * 100 : n;
    }
    function buildNumPredicate(expr, isPercent){
      var q = String(expr||'').trim();
      if (!q) return function(){ return true; };
      var range = q.match(/^\s*([^\-]+)\s*-\s*([^\-]+)\s*$/);
      if (range){
        var a = isPercent ? parseFloat(String(range[1]).replace('%','').replace(',','.')) : parseNumToken(range[1]);
        var b = isPercent ? parseFloat(String(range[2]).replace('%','').replace(',','.')) : parseNumToken(range[2]);
        if (isFinite(a) && isFinite(b)){
          var lo = Math.min(a,b), hi = Math.max(a,b);
          return function(x){ return isFinite(x) && x >= lo && x <= hi; };
        }
      }
      var tokens = [];
      q.replace(/(<=|>=|==|=|!=|<|>)\s*([-+]?\d*[\.,]?\d+)\s*%?/gi, function(_,op,num){
        var n = parseFloat(String(num).replace(',','.'));
        if (isFinite(n)) tokens.push({op: op, n: n});
        return '';
      });
      if (tokens.length){
        return function(x){
          if (!isFinite(x)) return false;
          for (var i=0;i<tokens.length;i++){
            var t = tokens[i];
            if (t.op === '>' && !(x > t.n)) return false;
            if (t.op === '>=' && !(x >= t.n)) return false;
            if (t.op === '<' && !(x < t.n)) return false;
            if (t.op === '<=' && !(x <= t.n)) return false;
            if ((t.op === '=' || t.op === '==') && !(x === t.n)) return false;
            if (t.op === '!=' && !(x !== t.n)) return false;
          }
          return true;
        };
      }
      var single = isPercent ? parseFloat(q.replace('%','').replace(',','.')) : parseNumToken(q);
      if (isFinite(single)){
        return function(x){ return isFinite(x) && String(x).indexOf(String(single)) !== -1; };
      }
      return function(){ return true; };
    }

    function applyAdvancedFilters(){
      var qValo = $('#client-valo-filter').val() || '';
      var qPerf = $('#client-perf-filter').val() || '';
      var qVol = $('#client-vol-filter').val() || '';
      var predValo = buildNumPredicate(qValo, false);
      var predPerf = buildNumPredicate(qPerf, true);
      var predVol = buildNumPredicate(qVol, true);
      $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(f){ return !f.__cli_advanced; });
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex){
        if (settings.nTable !== document.getElementById('clientsTable')) return true;
        var rowNode = table.row(dataIndex).node();
        var valoRaw = null, perfRaw = null, volRaw = null;
        if (rowNode){
          var elValo = rowNode.querySelector ? rowNode.querySelector('[data-valo]') : null;
          var elPerf = rowNode.querySelector ? rowNode.querySelector('[data-perf]') : null;
          var elVol = rowNode.querySelector ? rowNode.querySelector('[data-vol]') : null;
          valoRaw = elValo && elValo.dataset ? elValo.dataset.valo : null;
          perfRaw = elPerf && elPerf.dataset ? elPerf.dataset.perf : null;
          volRaw = elVol && elVol.dataset ? elVol.dataset.vol : null;
        }
        var valoNum = toNum(valoRaw !== null && valoRaw !== undefined ? valoRaw : data[4]);
        var perfNum = normalizePct(toNum(perfRaw !== null && perfRaw !== undefined ? perfRaw : data[5]));
        var volNum = normalizePct(toNum(volRaw !== null && volRaw !== undefined ? volRaw : data[6]));
        var ok = true;
        if (qValo){
          if (!Number.isFinite(valoNum)) return false;
          if (!predValo(valoNum)) ok = false;
        }
        if (ok && qPerf){
          if (!Number.isFinite(perfNum)) return false;
          if (!predPerf(perfNum)) ok = false;
        }
        if (ok && qVol){
          if (!Number.isFinite(volNum)) return false;
          if (!predVol(volNum)) ok = false;
        }
        return ok;
      });
      var last = $.fn.dataTable.ext.search[$.fn.dataTable.ext.search.length-1];
      if (last) last.__cli_advanced = true;
      table.draw();
    }

    function gatherFiltersSummary(){
      var parts = [];
      var vNom = $('#client-nom-filter').val();
      var vPrenom = $('#client-prenom-filter').val();
      var vResp = $('#client-resp-filter').val();
      var vSrri = $('#client-srri-filter').val();
      var vValo = $('#client-valo-filter').val();
      var vPerf = $('#client-perf-filter').val();
      var vVol = $('#client-vol-filter').val();
      if (vNom) parts.push('Nom: ' + vNom);
      if (vPrenom) parts.push('Pr√©nom: ' + vPrenom);
      if (vResp) parts.push('Resp: ' + vResp);
      if (vSrri) parts.push('SRRI: ' + vSrri);
      if (vValo) parts.push('Valo: ' + vValo);
      if (vPerf) parts.push('Perf: ' + vPerf);
      if (vVol) parts.push('Vol: ' + vVol);
      if (groupedTasksCfgClients.groupFilterActive) parts.push('Groupe filtr√©');
      if (groupedTasksCfgClients.hasServerFilter && !parts.length) parts.push('Filtre serveur');
      return parts.join(' ¬∑ ');
    }

    function hasActiveFiltersLocal(){
      return ['#client-nom-filter','#client-prenom-filter','#client-resp-filter','#client-srri-filter','#client-valo-filter','#client-perf-filter','#client-vol-filter'].some(function(sel){ return $(sel).val(); });
    }

    function updateGroupedButtonVisibility(){
      var hasDtFilter = false;
      try {
        var filtered = table.rows({ search: 'applied' }).count();
        var total = table.rows({ search: 'none' }).count();
        hasDtFilter = filtered < total;
      } catch(e){}
      var active = hasActiveFiltersLocal() || hasDtFilter || groupedTasksCfgClients.hasServerFilter || groupedTasksCfgClients.groupFilterActive;
      if (actionsBar) actionsBar.style.display = active ? 'flex' : 'none';
      if (actionsBar) actionsBar.style.alignItems = 'center';
    }
    $('#client-valo-filter, #client-perf-filter, #client-vol-filter').on('keyup change', applyAdvancedFilters);

    ['#client-nom-filter','#client-prenom-filter','#client-resp-filter','#client-srri-filter','#client-valo-filter','#client-perf-filter','#client-vol-filter'].forEach(function(sel){
      var el = document.querySelector(sel);
      if (!el) return;
      el.addEventListener('input', updateGroupedButtonVisibility);
      el.addEventListener('change', updateGroupedButtonVisibility);
    });
    table.on('draw', updateGroupedButtonVisibility);
    updateGroupedButtonVisibility();

    if (btnGrouped){
      btnGrouped.addEventListener('click', function(){
        try { console.info('[GroupedTasks][clients] click open'); } catch(e){}
        var ids = [];
        table.rows({ filter: 'applied' }).every(function(){
          var node = this.node();
          if (!node) return;
          var cid = node.getAttribute('data-client-id');
          if (cid) { var n = Number(cid); if (Number.isFinite(n)) ids.push(n); }
        });
        if (!ids.length){
          alert('Aucune ligne filtr√©e (tableau).');
          return;
        }
        if (!window.GroupedTasksModal){
          alert('Module de t√¢ches group√©es indisponible.');
          return;
        }
        window.GroupedTasksModal.open({
          scope: 'clients',
          ids: ids,
          taskTypes: groupedTasksCfgClients.taskTypes,
          responsables: groupedTasksCfgClients.responsables,
          filtersSummary: gatherFiltersSummary() || 'Filtres appliqu√©s',
          title: 'Cr√©er des t√¢ches group√©es (clients)'
        });
      });
    }

    window.clearClientFilters = function(){
      $('#client-nom-filter, #client-prenom-filter, #client-resp-filter, #client-srri-filter, #client-valo-filter, #client-perf-filter, #client-vol-filter').val('');
      // D√©clenche les handlers existants pour nettoyer les recherches colonne
      $('#client-nom-filter').trigger('change');
      $('#client-prenom-filter').trigger('change');
      $('#client-resp-filter').trigger('change');
      $('#client-srri-filter').trigger('change');
      $('#client-valo-filter').trigger('change');
      $('#client-perf-filter').trigger('change');
      $('#client-vol-filter').trigger('change');
      table.search('');
      table.columns().search('');
      $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(f){ return !f.__cli_advanced; });
      table.draw();
      updateGroupedButtonVisibility();
    };

    // Pagination c√¥t√© serveur (pr√©serve les autres param√®tres)
    window.changeClientPage = function(delta){
      var current = {{ cur_page }};
      var target = current + delta;
      if (target < 1 || target > {{ max_pages }}) return;
      var params = new URLSearchParams(window.location.search);
      params.set('page', target);
      window.location.search = params.toString();
    };
});
</script>
{% endblock %}
