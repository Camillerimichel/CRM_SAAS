{% extends "base.html" %}

{% block title %}Clients{% endblock %}
{% block header_title %}<i class="fa-solid fa-users" style="margin-right:8px;"></i>Clients{% endblock %}

{% block content %}
<style>
  .main-container { background: white; border-radius: 12px; box-shadow: var(--shadow-sm); padding: 1rem; }
  .filters { display: grid; grid-template-columns: repeat(4, minmax(200px, 1fr)); gap: .6rem; margin: .5rem 0 1rem; }
  .filters input, .filters select { height: 36px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; background:#fff; width: 100%; }
  table { width: 100%; border-collapse: separate; border-spacing: 0; background: #fff; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; box-shadow: var(--shadow-sm); }
  thead th { background: var(--primary); color: #fff; font-weight: 600; text-transform: uppercase; font-size: .8rem; letter-spacing: .02em; padding: .65rem .6rem; }
  tbody td { border-top: 1px solid var(--border); padding: .6rem .6rem; font-size: .92rem; }
  tbody tr:nth-child(odd) td { background: #fcfdff; }
  tbody tr:hover td { background: #f8fbff; }
  .right { text-align: right; }
  .muted { color: var(--muted); }
  .badge-filter { display:inline-flex; align-items:center; gap:6px; background:#eef2ff; color:#1d4ed8; border:1px solid #c7d2fe; border-radius:999px; padding:4px 10px; font-size:.85rem; }
  .badge-filter .x { color:#1d4ed8; text-decoration:none; opacity:.8; }
  .badge-filter .x:hover { opacity:1; }
  .badge-row { display:flex; gap:6px; flex-wrap:wrap; margin:.25rem 0 .5rem 0; }
  .pager { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
  .pager button { border:1px solid var(--border); border-radius:8px; padding:6px 10px; background:#fff; cursor:pointer; box-shadow: 0 6px 14px rgba(15,23,42,0.06); }
  .pager button.active { background: linear-gradient(135deg, #2563eb, #1d4ed8); color:#fff; border-color: transparent; box-shadow: 0 12px 26px rgba(37,99,235,0.22); }
  .pager button:disabled { opacity:0.45; cursor: default; }
</style>

{% set tb_markers_param = tb_markers_param or '' %}
{% set tb_markers_visible = tb_markers_visible or false %}

<div class="tb-page{% if tb_markers_visible %} tb-markers-enabled{% endif %}" data-tb-marker="TB_201">
<div class="main-container" data-tb-marker="TB_202">
  <h2 data-tb-marker="TB_203">Liste des clients</h2>
  <div data-tb-marker="TB_204"></div>
  <div id="cf_active_badges" class="badge-row" data-tb-marker="TB_205">
    {% if group_filter_label %}
      <div class="badge-filter">
        Groupe : {{ group_filter_label }}
        {% if tb_markers_visible %}
          <a class="x" href="/dashboard/clients?{{ tb_markers_param }}">×</a>
        {% else %}
          <a class="x" href="/dashboard/clients">×</a>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <form method="get" class="filters">
    <div>
      <label class="muted" style="font-size:0.85rem;">Nom</label>
      <input name="nom" type="text" value="{{ filters.nom }}" placeholder="Nom" />
    </div>
    <div>
      <label class="muted" style="font-size:0.85rem;">Prénom</label>
      <input name="prenom" type="text" value="{{ filters.prenom }}" placeholder="Prénom" />
    </div>
    <div>
      <label class="muted" style="font-size:0.85rem;">Responsable</label>
      <select name="resp_id">
        <option value="">Tous</option>
        {% for rh in responsables or [] %}
          <option value="{{ rh.id }}" {% if filters.resp_id and filters.resp_id|int == rh.id %}selected{% endif %}>{{ rh.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted" style="font-size:0.85rem;">SRRI calculé</label>
      <select name="srri_calc">
        <option value="">Tous</option>
        {% for s in srri_options %}
          <option value="{{ s }}" {% if filters.srri_calc and filters.srri_calc|int == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted" style="font-size:0.85rem;">Valorisation</label>
      <input name="valo" type="text" value="{{ filters.valo }}" placeholder="Ex: >100k, 100k-500k" />
    </div>
    <div>
      <label class="muted" style="font-size:0.85rem;">Perf 52 sem.</label>
      <input name="perf" type="text" value="{{ filters.perf }}" placeholder="Ex: >5, 3-7" />
    </div>
    <div>
      <label class="muted" style="font-size:0.85rem;">Volatilité</label>
      <input name="vol" type="text" value="{{ filters.vol }}" placeholder="Ex: <10, 2-6" />
    </div>
    <div style="display:flex; gap:8px; align-items:flex-end;">
      {% if tb_markers_visible %}<input type="hidden" name="markers" value="1" />{% endif %}
      <button class="btn" type="submit">Filtrer</button>
      <a class="btn" href="/dashboard/clients{% if tb_markers_visible %}?markers=1{% endif %}">Réinitialiser</a>
    </div>
  </form>

  <table id="clientsTbl" data-tb-marker="TB_208">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>Responsable</th>
        <th>SRRI calculé</th>
        <th class="right" style="width:120px;">Valorisation</th>
        <th class="right" style="width:100px;">Perf 52 sem.</th>
        <th class="right" style="width:100px;">Volatilité</th>
      </tr>
    </thead>
    <tbody>
      {% for c in clients %}
      <tr data-client-id="{{ c.id }}" data-srri="{{ c.SRRI if c.SRRI is not none else '' }}">
        <td><a href="/dashboard/clients/{{ c.id }}" target="_blank" style="text-decoration:underline; color: inherit;">{{ c.nom }}</a></td>
        <td>{{ c.prenom }}</td>
        <td>{{ c.responsable or '—' }}</td>
        <td>{{ c.srri_hist if c.srri_hist is not none else '' }}</td>
        <td class="right">{{ c.total_valo_str }}</td>
        <td class="right">{{ c.perf_52_sem_str }}</td>
        <td class="right">{{ c.volatilite_str }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if total_pages > 1 %}
    <div id="clientsPager" class="pager" aria-label="Pagination clients">
      {% set base_params = filters.copy() %}
      {% if tb_markers_visible %}{% set _ = base_params.update({'markers':'1'}) %}{% endif %}
      {% set prev_page = page - 1 %}
      {% set next_page = page + 1 %}
      <form method="get" style="display:inline;">
        {% for k,v in base_params.items() if v %}
          <input type="hidden" name="{{ k }}" value="{{ v }}">
        {% endfor %}
        <button type="submit" name="page" value="{{ prev_page }}" {% if page == 1 %}disabled{% endif %}>‹</button>
      </form>
      {% for p in range(1, total_pages + 1) %}
        <form method="get" style="display:inline;">
          {% for k,v in base_params.items() if v %}
            <input type="hidden" name="{{ k }}" value="{{ v }}">
          {% endfor %}
          <button type="submit" name="page" value="{{ p }}" class="{% if p == page %}active{% endif %}">{{ p }}</button>
        </form>
      {% endfor %}
      <form method="get" style="display:inline;">
        {% for k,v in base_params.items() if v %}
          <input type="hidden" name="{{ k }}" value="{{ v }}">
        {% endfor %}
        <button type="submit" name="page" value="{{ next_page }}" {% if page == total_pages %}disabled{% endif %}>›</button>
      </form>
    </div>
  {% endif %}
  </div>
</div>
{% endblock %}
