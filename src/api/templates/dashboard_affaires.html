{% extends "base.html" %}

{% block title %}Affaires{% endblock %}
{% block header_title %}<i class="fa-solid fa-briefcase" style="margin-right:8px;"></i>Affaires{% endblock %}

{% block content %}
<style>
    .main-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        padding: 2rem;
        margin: 2rem auto;
    }
    .header-section {
        background: var(--primary);
        color: #fff;
        padding: 1.2rem;
        border-radius: 10px;
        margin-bottom: 1.2rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
    }
    .top-row {
        display: flex;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .srri-info {
        flex: 1;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
    }
    .srri-chart {
        flex: 1;
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    /* En-t√™tes de tableau h√©ritent du style global (base.html) */
    thead input, thead select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 13px;
    }
    tbody td {
        padding: 10px 8px;
    }
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .clear-btn {
        background: #ff6b6b;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    /* Mise en √©vidence des lignes avec date cl√© pr√©sente */
    .highlight-cle {
        background: #ffe5e5 !important; /* rouge tr√®s clair */
    }
    .srri-calc {
        margin-left: 6px;
        font-size: 11px;
        color: #666;
        vertical-align: middle;
    }
    .badge-closed {
        display: inline-block;
        margin-left: 8px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        color: #b00020;
        background: #ffd6d6;
        border: 1px solid #ffb3b3;
        vertical-align: middle;
        white-space: nowrap;
    }
    /* Barre outils + chips (harmonis√©) */
    .toolbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin: .5rem 0 8px 0; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background: var(--surface); cursor:pointer; font-size:12px; color: var(--text); text-decoration:none; }
    .chip:hover { background: var(--primary-100); color: var(--primary-600); }
    /* SRRI dots (remplacement des emojis) */
    .srri-dot { display:inline-block; width: 1em; height: 1em; border-radius: 50%; vertical-align: middle; }
    .srri-red { background:#ef4444; }
    .srri-green { background:#16a34a; }
    .srri-blue { background:#3b82f6; }
    .srri-hidden { display:none; }
    .badge-filter { display:inline-flex; align-items:center; gap:6px; background:#eef2ff; color:#1d4ed8; border:1px solid #c7d2fe; border-radius:999px; padding:4px 10px; font-size:.85rem; }
    .badge-filter .x { color:#1d4ed8; text-decoration:none; opacity:.8; }
    .badge-filter .x:hover { opacity:1; }
    .badge-row { display:flex; gap:6px; flex-wrap:wrap; margin:.25rem 0 .5rem 0; }
</style>

<div class="main-container">
    <!-- Bandeau total retir√© -->

    {% if risk_label %}
    <div class="badge-row">
      <span class="badge-filter">Filtre: {{ risk_label }} <a class="x" href="/dashboard/affaires" title="Effacer le filtre">‚úï</a></span>
    </div>
    {% endif %}

    <!-- Accord√©on: Risque rapide -->
    <div id="quickToggleAff" class="card accordion-toggle" style="cursor:pointer; margin-bottom:10px; display:flex; align-items:center; justify-content:center; gap:8px;">
      <h3 style="margin:0;">Risque rapide</h3>
      <span class="chevron">‚ñæ</span>
    </div>
    <div id="quickSectionAff" style="display:none;">
      <div class="top-row">
          <div class="srri-info">
              <h3>R√©partition SRRI (barres)</h3>
              <canvas id="srriBarChart"></canvas>
          </div>
          <div class="srri-chart">
              <h3>Contrats vs risque (barres)</h3>
              <canvas id="compareBarChart"></canvas>
              <div style="margin-top:8px; font-size: 13px;">
                  Au-dessus: <strong>{{ srri_compare_counts.above }}</strong> |
                  Identique: <strong>{{ srri_compare_counts.equal }}</strong> |
                  En‚Äëdessous: <strong>{{ srri_compare_counts.below }}</strong>
              </div>
          </div>
      </div>
    </div>

    
    <div class="table-container">
        <div class="toolbar">
          <div class="muted" id="aff_info" style="font-size:.9rem;"></div>
          <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
            <select id="aff_group_select" style="min-width:240px; height:36px; padding:6px 8px; border:1px solid var(--border); border-radius:8px;">
              <option value="">Choisir un groupe (Affaires)</option>
            </select>
            <button class="btn" id="aff_add_to_group_btn" title="Ajouter toutes les affaires filtr√©es au groupe s√©lectionn√©">Ajouter au groupe</button>
          </div>
        </div>
        <table id="affairesTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>Contrat / Client</th>
                    <th>SRRI</th>
                    <th>Date d√©but</th>
                    <th>Montant</th>
                    <th>Perf 52 sem. (%)</th>
                    <th>Vol. 52s (%)</th>
                </tr>
                <tr>
                    <th><input type="text" id="contrat-filter" placeholder="Filtrer..."></th>
                    <th>
                        <select id="srri-icon-filter">
                            <option value=""></option>
                            <!-- Afficher des gros points color√©s tout en conservant les valeurs d'origine pour le filtrage -->
                            <option value="‚ùÑÔ∏è">üî¥</option>
                            <option value="üôè">üü¢</option>
                            <option value="üî•">üîµ</option>
                        </select>
                    </th>
                    <th><input type="text" id="date-debut-filter" placeholder="AAAA-MM-JJ"></th>
                    <th><input type="text" id="montant-filter" placeholder="Ex: >100k, 100k-500k"></th>
                    <th><input type="text" id="perf-filter" placeholder="Ex: >5, 3-7"></th>
                    <th><input type="text" id="volat-filter" placeholder="Ex: <10, 2-6"></th>
                </tr>
            </thead>
            <tbody>
                {% for a in affaires %}
                <tr class="{% if a.date_cle %}highlight-cle{% endif %}" data-affaire-id="{{ a.id }}">
                    <td>
                        <a href="/dashboard/affaires/{{ a.id }}" target="_blank" style="text-decoration:underline; color: inherit;">
                          {{ a.ref }} - {{ a.client_nom }} {{ a.client_prenom }}
                        </a>
                        {% if a.date_cle %}<span class="badge-closed">Le contrat est cl√¥tur√© ({{ (a.date_cle|string)[:10] }})</span>{% endif %}
                    </td>
                    <td style="text-align:center;">
                        {% if a.srri_icon == 'fire' %}
                          <span class="srri-dot srri-blue" title="Au‚Äëdessus" aria-hidden="true"></span><span class="srri-hidden">üî•</span>
                        {% elif a.srri_icon == 'hands-praying' %}
                          <span class="srri-dot srri-green" title="Identique" aria-hidden="true"></span><span class="srri-hidden">üôè</span>
                        {% elif a.srri_icon == 'snowflake' %}
                          <span class="srri-dot srri-red" title="En‚Äëdessous" aria-hidden="true"></span><span class="srri-hidden">‚ùÑÔ∏è</span>
                        {% else %}
                        {% endif %}
                    </td>
                    <td>{{ (a.date_debut|string)[:10] if a.date_debut else '' }}</td>
                    <td style="text-align:right;">{{ a.last_valo }}</td>
                    <td style="text-align:right;">{{ a.last_perf }}</td>
                    <td style="text-align:right;">{{ a.last_volat }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div id="results-info"></div>
        <button class="btn btn-danger" onclick="clearFilters()">üóëÔ∏è Effacer</button>
    </div>
</div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- FixedHeader -->
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

<script>
// Chart.js: couleur par d√©faut (axes/labels) = bleu CSS
try { Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#2456a6'; } catch(e) {}
$(document).ready(function () {
    var table = $('#affairesTable').DataTable({
        dom: 'rtip', // retire la barre de recherche et le s√©lecteur "show"
        order: [[3, "desc"]], // trier sur le montant (col 3)
        pageLength: 25,
        fixedHeader: true,
        columnDefs: [
          // R√©duire Contrat/Client, √©largir SRRI et Montant
          { targets: 0, width: '260px' },
          { targets: 1, width: '120px', className: 'dt-center' },
          { targets: 3, width: '200px' },
          // R√©duire la derni√®re colonne Vol.
          { targets: 5, width: '90px' },
          // Montant (col 3)
          { targets: 3, render: $.fn.dataTable.render.number(' ', ',', 0, '') },
          // Perf/Vol (cols 4 et 5) ‚Üí afficher en % si fourni sous forme fraction
          { targets: 4, render: function (data) { if (data==null||data==='') return ''; var n=parseFloat(String(data).replace(',', '.')); if (isNaN(n)) return data; if (Math.abs(n)<=1) n=n*100; return n.toFixed(2)+' %'; } },
          { targets: 5, render: function (data) { if (data==null||data==='') return ''; var n=parseFloat(String(data).replace(',', '.')); if (isNaN(n)) return data; if (Math.abs(n)<=1) n=n*100; return n.toFixed(2)+' %'; } }
        ]
    });

    // Filtres texte simples
    $('#contrat-filter').on('keyup change', function () { table.column(0).search(this.value).draw(); });
    $('#date-debut-filter').on('keyup change', function () { table.column(2).search(this.value).draw(); });

    // filtre par ic√¥ne SRRI (colonne 1) ‚Äî recherche par emoji
    $('#srri-icon-filter').on('change', function(){
        var val = $(this).val();
        table.column(1).search(val).draw();
        try { var params=new URLSearchParams(window.location.search); if(val) params.set('risk', val); else params.delete('risk'); var u=window.location.pathname + (params.toString()?('?'+params.toString()):''); window.history.replaceState({}, '', u);} catch(e) {}
    });

    // bouton effacer (r√©initialise aussi le filtre SRRI)
    window.clearFilters = function() {
        $('#contrat-filter, #date-debut-filter, #montant-filter, #perf-filter, #volat-filter').val('');
        $('#srri-icon-filter').val('');
        table.search('');
        for (var i=0;i<table.columns().count();i++){ table.column(i).search(''); }
        table.draw();
    };

    // Pr√©filtre via ?risk= (above/equal/below) ou emoji/icon
    (function(){
      try {
        const params = new URLSearchParams(window.location.search);
        let risk = params.get('risk');
        if (!risk) return;
        // Revenir au mapping pr√©c√©dent: Au‚Äëdessus = üî•, En‚Äëdessous = ‚ùÑÔ∏è, √âquivalent = üôè
        const map = { 'above':'üî•', 'equal':'üôè', 'below':'‚ùÑÔ∏è', 'fire':'üî•', 'hands-praying':'üôè', 'snowflake':'‚ùÑÔ∏è', 'üî•':'üî•', 'üôè':'üôè', '‚ùÑÔ∏è':'‚ùÑÔ∏è' };
        const icon = map[String(risk).toLowerCase ? String(risk).toLowerCase() : risk] || map[risk];
        if (!icon) return;
        const sel = document.getElementById('srri-icon-filter');
        if (sel) { sel.value = icon; sel.dispatchEvent(new Event('change')); }
      } catch(e) { /* ignore */ }
    })();

    // Chips Risque (√©motic√¥nes)
    window.chipRiskAff = function(val){ var sel=document.getElementById('srri-icon-filter'); if(val==='all'){ sel.value=''; } else { sel.value=val; } sel.dispatchEvent(new Event('change')); return false; };

    // Accord√©on Risque rapide (persistant, ferm√© par d√©faut)
    (function(){
      try {
        var t = document.getElementById('quickToggleAff'), s = document.getElementById('quickSectionAff');
        if (!t || !s) return;
        function setOpen(o){ s.style.display = o ? '' : 'none'; t.classList.toggle('collapsed', !o); localStorage.setItem('aff_quick_open', o ? '1' : ''); }
        var saved = localStorage.getItem('aff_quick_open') === '1';
        setOpen(saved); // par d√©faut ferm√© (saved false)
        t.addEventListener('click', function(){ setOpen(s.style.display === 'none'); });
      } catch(e) {}
    })();

    // Chart.js donn√©es depuis Jinja
    var ctx = document.getElementById('srriBarChart').getContext('2d');
    var srriData = {
        labels: [{% for item in srri_chart %}"SRRI {{ item.srri }}",{% endfor %}],
        datasets: [{
            label: 'Nombre',
            data: [{% for item in srri_chart %}{{ item.nb }},{% endfor %}],
            backgroundColor: '#667eea'
        }]
    };
    new Chart(ctx, {
        type: 'bar',
        data: srriData,
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { precision:0 } }
            }
        }
    });

    // Bar chart compare (au-dessus / identique / en-dessous)
    var ctx2 = document.getElementById('compareBarChart').getContext('2d');
    var cmp = {{ srri_compare_counts | tojson }};
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: ['Au-dessus', 'Identique', 'En-dessous'],
            datasets: [{
                data: [cmp.above || 0, cmp.equal || 0, cmp.below || 0],
                backgroundColor: ['#e63946', '#2a9d8f', '#457b9d']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
    });

    // -------- Filtres num√©riques avanc√©s (Montant/Perf/Vol) --------
    function parseNumToken(raw){
      var s = String(raw||'').trim().toLowerCase().replace(/\s+/g,'');
      s = s.replace(',', '.');
      var m = s.match(/^([-+]?\d*\.?\d+)([km]?)$/);
      if (!m) return NaN;
      var n = parseFloat(m[1]);
      if (m[2] === 'k') n *= 1e3; else if (m[2] === 'm') n *= 1e6;
      return n;
    }
    function numFromCell(txt){
      var s = String(txt||'').replace(/\s+/g,'').replace(',', '.');
      var m = s.match(/-?\d*\.?\d+/);
      return m ? parseFloat(m[0]) : NaN;
    }
    function buildNumPredicate(expr, isPercent){
      var q = String(expr||'').trim();
      if (!q) return function(){ return true; };
      var range = q.match(/^\s*([^\-]+)\s*-\s*([^\-]+)\s*$/);
      if (range){
        var a = isPercent ? parseFloat(String(range[1]).replace('%','').replace(',','.')) : parseNumToken(range[1]);
        var b = isPercent ? parseFloat(String(range[2]).replace('%','').replace(',','.')) : parseNumToken(range[2]);
        if (isFinite(a) && isFinite(b)){
          var lo = Math.min(a,b), hi = Math.max(a,b);
          return function(x){ return isFinite(x) && x >= lo && x <= hi; };
        }
      }
      var tokens = [];
      q.replace(/(<=|>=|==|=|!=|<|>)\s*([-+]?\d*[\.,]?\d+)\s*%?/gi, function(_,op,num){
        var n = parseFloat(String(num).replace(',','.'));
        if (isFinite(n)) tokens.push({op: op, n: n});
        return '';
      });
      if (tokens.length){
        return function(x){
          if (!isFinite(x)) return false;
          for (var i=0;i<tokens.length;i++){
            var t = tokens[i];
            if (t.op === '>' && !(x > t.n)) return false;
            if (t.op === '>=' && !(x >= t.n)) return false;
            if (t.op === '<' && !(x < t.n)) return false;
            if (t.op === '<=' && !(x <= t.n)) return false;
            if ((t.op === '=' || t.op === '==') && !(x === t.n)) return false;
            if (t.op === '!=' && !(x !== t.n)) return false;
          }
          return true;
        };
      }
      var single = isPercent ? parseFloat(q.replace('%','').replace(',','.')) : parseNumToken(q);
      if (isFinite(single)){
        return function(x){ return isFinite(x) && String(x).indexOf(String(single)) !== -1; };
      }
      return function(){ return true; };
    }

    function applyAdvancedFilters(){
      var qMontant = $('#montant-filter').val() || '';
      var qPerf = $('#perf-filter').val() || '';
      var qVol = $('#volat-filter').val() || '';
      var predMontant = buildNumPredicate(qMontant, false);
      var predPerf = buildNumPredicate(qPerf, true);
      var predVol = buildNumPredicate(qVol, true);
      $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(function(f){ return !f.__aff_advanced; });
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex){
        if (settings.nTable !== document.getElementById('affairesTable')) return true;
        // Montant (col 3), Perf (col 4), Vol (col 5)
        var montantTxt = data[3];
        var perfTxt = data[4];
        var volTxt = data[5];
        var montantNum = numFromCell(montantTxt);
        var perfNum = numFromCell(perfTxt);
        var volNum = numFromCell(volTxt);
        var ok = true;
        if (qMontant && !predMontant(montantNum)) ok = false;
        if (ok && qPerf && !predPerf(perfNum)) ok = false;
        if (ok && qVol && !predVol(volNum)) ok = false;
        return ok;
      });
      var last = $.fn.dataTable.ext.search[$.fn.dataTable.ext.search.length-1];
      if (last) last.__aff_advanced = true;
      table.draw();
    }
    $('#montant-filter, #perf-filter, #volat-filter').on('keyup change', applyAdvancedFilters);

    // -------- Ajout en masse au groupe (Affaires) --------
    async function loadAffGroupsForBulk(){
      try {
        const sel = document.getElementById('aff_group_select');
        if (!sel) return;
        const r = await fetch('/api/groupes/details?type=affaire&actifs_only=true');
        const arr = r.ok ? await r.json() : [];
        (arr||[]).forEach(function(g){
          const opt = document.createElement('option');
          opt.value = g.id; opt.textContent = g.nom + ((String(g.actif)==='0')?' (inactif)':'');
          sel.appendChild(opt);
        });
      } catch(e){ console.warn('load aff groups failed', e); }
    }
    loadAffGroupsForBulk();

    function visibleAffaireIds(){
      var out = [];
      table.rows({ filter: 'applied' }).nodes().to$().each(function(){
        var id = $(this).attr('data-affaire-id');
        if (id) out.push(parseInt(id,10));
      });
      return out;
    }

    async function addVisibleAffToGroup(){
      const sel = document.getElementById('aff_group_select');
      const info = document.getElementById('aff_info');
      const gid = sel && sel.value ? parseInt(sel.value,10) : null;
      if (!gid){ alert('S√©lectionnez un groupe cible.'); return; }
      const ids = visibleAffaireIds();
      if (!ids.length){ alert('Aucune affaire filtr√©e √† ajouter.'); return; }
      const btn = document.getElementById('aff_add_to_group_btn');
      if (btn){ btn.disabled = true; btn.textContent = 'Ajout‚Ä¶'; }
      let ok = 0, ko = 0;
      for (const aid of ids){
        try {
          const r = await fetch('/api/groupes/memberships', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ groupe_id: gid, affaire_id: aid }) });
          if (r.ok) ok++; else ko++;
        } catch(e){ ko++; }
      }
      if (btn){ btn.disabled = false; btn.textContent = 'Ajouter au groupe'; }
      if (info){ info.textContent = ok + ' ajout(s), ' + ko + ' √©chec(s).'; }
      alert('Ajout au groupe termin√©: ' + ok + ' / ' + ids.length + '');
    }
    var bulkBtn = document.getElementById('aff_add_to_group_btn');
    if (bulkBtn){ bulkBtn.addEventListener('click', addVisibleAffToGroup); }
});
</script>

{% endblock %}
